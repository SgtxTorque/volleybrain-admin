import {
  Activity,
  AlertCircle,
  AlertTriangle,
  ArrowLeft, ArrowRight,
  Award,
  Banknote,
  BarChart3,
  Bell,
  BellRing,
  Bookmark,
  Building2,
  Calculator,
  Calendar,
  CalendarCheck, CalendarPlus,
  Camera,
  Check,
  CheckCircle2,
  CheckSquare,
  ChevronDown,
  ChevronLeft,
  ChevronRight,
  ChevronUp,
  Circle,
  ClipboardList,
  Clock,
  Coins,
  Contact,
  Copy,
  CreditCard,
  DollarSign,
  Download,
  Edit,
  ExternalLink,
  Eye, EyeOff,
  File, FileCheck, FilePlus,
  FileText,
  Filter,
  Flag,
  FolderOpen,
  Fullscreen,
  Gauge,
  Gem,
  Gift,
  Globe,
  Grid,
  Grip,
  Hash,
  Heart,
  HelpCircle,
  Home,
  Image,
  Info,
  Key,
  Layers,
  LayoutDashboard,
  Lightbulb,
  LineChart,
  Link,
  List,
  Loader2,
  Lock,
  LogOut,
  Mail,
  MapPin,
  Maximize2,
  Medal,
  Megaphone,
  Menu,
  MessageCircle,
  MessageSquare,
  Minimize2,
  Moon,
  MoreHorizontal,
  MoreVertical,
  Package, Palette,
  Paperclip,
  Percent,
  Phone,
  PieChart,
  Plus,
  Receipt,
  RefreshCw,
  Rocket,
  Save,
  Search,
  Send,
  Settings,
  Share2,
  Shield,
  ShieldCheck,
  Shirt,
  SortAsc,
  Sparkles,
  Star,
  Sun,
  Table,
  Tag,
  Target,
  Timer,
  Trash2,
  TrendingDown,
  TrendingUp,
  Trophy,
  Unlock,
  Upload,
  User,
  UserCheck,
  UserCog,
  UserMinus,
  UserPlus,
  Users,
  UserX,
  Video,
  Wallet, Wrench,
  X,
  XCircle,
  Zap
} from 'lucide-react'
import { createContext, useContext, useEffect, useRef, useState } from 'react'
import { supabase } from './lib/supabase'

// Use Circle as volleyball icon since Volleyball doesn't exist in lucide-react
const VolleyballIcon = Circle

// Icon component for consistent rendering
const Icon = ({ name, className = "w-5 h-5", ...props }) => {
  const iconMap = {
    // Navigation & Layout
    dashboard: LayoutDashboard,
    home: Home,
    menu: Menu,
    close: X,
    settings: Settings,
    
    // Users & People
    users: Users,
    user: User,
    'user-cog': UserCog,
    'user-plus': UserPlus,
    'user-minus': UserMinus,
    'user-check': UserCheck,
    'user-x': UserX,
    'users-round': Users, // Fallback to Users
    contact: Contact,
    
    // Content & Files
    clipboard: ClipboardList,
    file: File,
    'file-text': FileText,
    'file-check': FileCheck,
    'file-plus': FilePlus,
    folder: FolderOpen,
    document: FileText,
    
    // Actions
    plus: Plus,
    edit: Edit,
    trash: Trash2,
    save: Save,
    copy: Copy,
    download: Download,
    upload: Upload,
    share: Share2,
    send: Send,
    refresh: RefreshCw,
    search: Search,
    filter: Filter,
    sort: SortAsc,
    
    // Status & Feedback
    check: Check,
    'check-circle': CheckCircle2,
    'check-square': CheckSquare,
    x: X,
    'x-circle': XCircle,
    alert: AlertTriangle,
    'alert-circle': AlertCircle,
    info: Info,
    'help-circle': HelpCircle,
    loader: Loader2,
    
    // Communication
    message: MessageCircle,
    messages: MessageCircle, // Fallback to MessageCircle
    'message-square': MessageSquare,
    megaphone: Megaphone,
    bell: Bell,
    'bell-ring': BellRing,
    mail: Mail,
    phone: Phone,
    
    // Finance
    dollar: DollarSign,
    wallet: Wallet,
    'credit-card': CreditCard,
    banknote: Banknote,
    coins: Coins,
    receipt: Receipt,
    
    // Charts & Analytics
    'bar-chart': BarChart3,
    'line-chart': LineChart,
    'pie-chart': PieChart,
    'trending-up': TrendingUp,
    'trending-down': TrendingDown,
    activity: Activity,
    gauge: Gauge,
    
    // Time & Calendar
    calendar: Calendar,
    'calendar-days': Calendar, // Fallback to Calendar
    'calendar-check': CalendarCheck,
    'calendar-plus': CalendarPlus,
    clock: Clock,
    timer: Timer,
    
    // Sports & Games
    volleyball: VolleyballIcon,
    target: Target,
    trophy: Trophy,
    medal: Medal,
    award: Award,
    star: Star,
    flag: Flag,
    
    // UI Elements
    'chevron-down': ChevronDown,
    'chevron-up': ChevronUp,
    'chevron-left': ChevronLeft,
    'chevron-right': ChevronRight,
    'arrow-left': ArrowLeft,
    'arrow-right': ArrowRight,
    'more-vertical': MoreVertical,
    'more-horizontal': MoreHorizontal,
    grip: Grip,
    
    // View & Visibility
    eye: Eye,
    'eye-off': EyeOff,
    maximize: Maximize2,
    minimize: Minimize2,
    fullscreen: Fullscreen,
    
    // Media
    image: Image,
    camera: Camera,
    video: Video,
    paperclip: Paperclip,
    
    // Security
    shield: Shield,
    'shield-check': ShieldCheck,
    lock: Lock,
    unlock: Unlock,
    key: Key,
    
    // Misc
    sparkles: Star, // Fallback to Star
    rocket: Rocket,
    lightbulb: Lightbulb,
    gift: Gift,
    gem: Gem,
    package: Package,
    palette: Palette,
    wrench: Wrench,
    zap: Zap,
    shirt: Shirt,
    building: Building2,
    map: MapPin,
    globe: Globe,
    link: Link,
    'external-link': ExternalLink,
    hash: Hash,
    tag: Tag,
    bookmark: Bookmark,
    heart: Heart,
    sun: Sun,
    moon: Moon,
    logout: LogOut,
    layers: Layers,
    grid: Grid,
    list: List,
    table: Table,
    percent: Percent,
    calculator: Calculator,
  }
  
  const IconComponent = iconMap[name] || Circle
  return <IconComponent className={className} {...props} />
}

// Legacy NavIcon for sidebar (keeping for compatibility)
const NavIcon = ({ name, className = "w-5 h-5" }) => {
  return <Icon name={name} className={className} />
}

// ============================================
// EMAIL NOTIFICATION SERVICE
// ============================================
// Queues emails to Supabase for sending via Edge Functions
// Supports: registration confirmation, approval, waitlist, payment reminders

const EmailService = {
  // Queue an email notification
  async queueEmail(type, recipientEmail, recipientName, data, organizationId) {
    try {
      const { error } = await supabase.from('email_notifications').insert({
        type,
        recipient_email: recipientEmail,
        recipient_name: recipientName,
        data,
        organization_id: organizationId,
        status: 'pending',
        created_at: new Date().toISOString()
      })
      if (error) throw error
      console.log(`Email queued: ${type} to ${recipientEmail}`)
      return { success: true }
    } catch (err) {
      console.error('Failed to queue email:', err)
      return { success: false, error: err.message }
    }
  },

  // Send registration confirmation email
  async sendRegistrationConfirmation(player, season, organization) {
    const email = player.parent_email
    if (!email) return { success: false, error: 'No parent email' }
    
    return this.queueEmail('registration_confirmation', email, player.parent_name, {
      player_name: `${player.first_name} ${player.last_name}`,
      season_name: season.name,
      organization_name: organization.name,
      organization_email: organization.settings?.contact_email,
      registration_date: new Date().toLocaleDateString(),
      fees: {
        registration: season.fee_registration || 0,
        uniform: season.fee_uniform || 0,
        monthly: season.fee_monthly || 0,
      }
    }, organization.id)
  },

  // Send approval notification
  async sendApprovalNotification(player, season, organization, fees = []) {
    const email = player.parent_email
    if (!email) return { success: false, error: 'No parent email' }
    
    const totalDue = fees.reduce((sum, f) => sum + (f.amount || 0), 0)
    
    return this.queueEmail('registration_approved', email, player.parent_name, {
      player_name: `${player.first_name} ${player.last_name}`,
      season_name: season.name,
      organization_name: organization.name,
      organization_email: organization.settings?.contact_email,
      total_due: totalDue,
      payment_methods: organization.settings?.payment_methods || {},
      fees: fees.map(f => ({ description: f.description, amount: f.amount }))
    }, organization.id)
  },

  // Send waitlist notification (spot available)
  async sendWaitlistSpotAvailable(player, season, organization) {
    const email = player.parent_email
    if (!email) return { success: false, error: 'No parent email' }
    
    const registrationUrl = organization.settings?.registration_url 
      || `https://sgtxtorque.github.io/volleyball-registration?org=${organization.slug}&season=${season.id}`
    
    return this.queueEmail('waitlist_spot_available', email, player.parent_name, {
      player_name: `${player.first_name} ${player.last_name}`,
      season_name: season.name,
      organization_name: organization.name,
      registration_url: registrationUrl,
      expires_in: '48 hours'
    }, organization.id)
  },

  // Send payment reminder
  async sendPaymentReminder(player, season, organization, amountDue, dueDate = null) {
    const email = player.parent_email
    if (!email) return { success: false, error: 'No parent email' }
    
    return this.queueEmail('payment_reminder', email, player.parent_name, {
      player_name: `${player.first_name} ${player.last_name}`,
      season_name: season.name,
      organization_name: organization.name,
      organization_email: organization.settings?.contact_email,
      amount_due: amountDue,
      due_date: dueDate,
      payment_methods: organization.settings?.payment_methods || {}
    }, organization.id)
  },

  // Send team assignment notification
  async sendTeamAssignment(player, team, season, organization) {
    const email = player.parent_email
    if (!email) return { success: false, error: 'No parent email' }
    
    return this.queueEmail('team_assignment', email, player.parent_name, {
      player_name: `${player.first_name} ${player.last_name}`,
      team_name: team.name,
      season_name: season.name,
      organization_name: organization.name,
      coach_name: team.coach_name || null,
      practice_info: team.practice_schedule || null
    }, organization.id)
  },

  // Get email templates for preview/customization
  getEmailTemplate(type, data) {
    const templates = {
      registration_confirmation: {
        subject: `Registration Received - ${data.organization_name}`,
        preview: `Thank you for registering ${data.player_name} for ${data.season_name}!`,
        body: `
          <h2>Registration Received!</h2>
          <p>Thank you for registering <strong>${data.player_name}</strong> for <strong>${data.season_name}</strong>.</p>
          <p>Your registration is being reviewed. You'll receive another email once it's approved.</p>
          <h3>Registration Details</h3>
          <ul>
            <li>Player: ${data.player_name}</li>
            <li>Season: ${data.season_name}</li>
            <li>Submitted: ${data.registration_date}</li>
          </ul>
          <p>If you have questions, please contact us at ${data.organization_email || 'the organization'}.</p>
          <p>Thank you,<br>${data.organization_name}</p>
        `
      },
      registration_approved: {
        subject: `Registration Approved - ${data.organization_name}`,
        preview: `Great news! ${data.player_name} is approved for ${data.season_name}!`,
        body: `
          <h2>üéâ Registration Approved!</h2>
          <p>Great news! <strong>${data.player_name}</strong> has been approved for <strong>${data.season_name}</strong>.</p>
          ${data.total_due > 0 ? `
            <h3>Payment Due: $${data.total_due.toFixed(2)}</h3>
            <p>Please submit payment to complete your registration.</p>
          ` : ''}
          <p>We look forward to seeing ${data.player_name} on the court!</p>
          <p>Thank you,<br>${data.organization_name}</p>
        `
      },
      waitlist_spot_available: {
        subject: `Spot Available! - ${data.organization_name}`,
        preview: `A spot has opened up for ${data.player_name}!`,
        body: `
          <h2>‚è∞ A Spot Has Opened Up!</h2>
          <p>Great news! A spot is now available for <strong>${data.player_name}</strong> in <strong>${data.season_name}</strong>.</p>
          <p><strong>This spot will expire in ${data.expires_in}.</strong></p>
          <p><a href="${data.registration_url}" style="background-color: #FFD700; color: #000; padding: 12px 24px; text-decoration: none; border-radius: 8px; display: inline-block; margin: 16px 0;">Confirm Your Spot ‚Üí</a></p>
          <p>If you no longer wish to join, simply ignore this email and the spot will go to the next person on the waitlist.</p>
          <p>Thank you,<br>${data.organization_name}</p>
        `
      },
      payment_reminder: {
        subject: `Payment Reminder - ${data.organization_name}`,
        preview: `Reminder: $${data.amount_due} due for ${data.player_name}`,
        body: `
          <h2>üí∞ Payment Reminder</h2>
          <p>This is a friendly reminder that payment is due for <strong>${data.player_name}</strong>'s registration in <strong>${data.season_name}</strong>.</p>
          <h3>Amount Due: $${data.amount_due.toFixed(2)}</h3>
          ${data.due_date ? `<p>Due Date: ${data.due_date}</p>` : ''}
          <p>If you have any questions or need to set up a payment plan, please contact us.</p>
          <p>Thank you,<br>${data.organization_name}</p>
        `
      },
      team_assignment: {
        subject: `Team Assignment - ${data.organization_name}`,
        preview: `${data.player_name} has been assigned to ${data.team_name}!`,
        body: `
          <h2>üèê Team Assignment</h2>
          <p><strong>${data.player_name}</strong> has been assigned to <strong>${data.team_name}</strong> for ${data.season_name}!</p>
          ${data.coach_name ? `<p>Coach: ${data.coach_name}</p>` : ''}
          ${data.practice_info ? `<p>Practice Schedule: ${data.practice_info}</p>` : ''}
          <p>More details will be shared soon. We're excited to have ${data.player_name} on the team!</p>
          <p>Thank you,<br>${data.organization_name}</p>
        `
      }
    }
    return templates[type] || null
  }
}

// Helper to check if email notifications are enabled for an organization
function isEmailEnabled(organization, notificationType = null) {
  // Check if email is globally enabled
  if (organization?.settings?.email_notifications_enabled === false) return false
  
  // If no specific type requested, return global status
  if (!notificationType) return true
  
  // Check specific notification type
  const typeSettings = {
    'registration_confirmation': organization?.settings?.email_on_registration,
    'registration_approved': organization?.settings?.email_on_approval,
    'waitlist_spot_available': organization?.settings?.email_on_waitlist,
    'team_assignment': organization?.settings?.email_on_team_assignment,
    'payment_reminder': organization?.settings?.email_on_payment_due,
  }
  
  // Default to true if setting not explicitly set
  return typeSettings[notificationType] !== false
}

// ============================================
// THEME CONTEXT - Enhanced with Accent Colors
// ============================================
const ThemeContext = createContext(null)
export function useTheme() { return useContext(ThemeContext) }

// Accent color options for user customization
const accentColors = {
  orange: { primary: '#F97316', light: '#FFEDD5', lighter: '#FFF7ED', dark: '#C2410C' },
  blue: { primary: '#0EA5E9', light: '#E0F2FE', lighter: '#F0F9FF', dark: '#0369A1' },
  purple: { primary: '#8B5CF6', light: '#EDE9FE', lighter: '#F5F3FF', dark: '#6D28D9' },
  green: { primary: '#10B981', light: '#D1FAE5', lighter: '#ECFDF5', dark: '#047857' },
  rose: { primary: '#F43F5E', light: '#FFE4E6', lighter: '#FFF1F2', dark: '#BE123C' },
  slate: { primary: '#64748B', light: '#F1F5F9', lighter: '#F8FAFC', dark: '#475569' },
}

// Theme color definitions - Enhanced slate palette
const themes = {
  dark: {
    name: 'dark',
    bg: 'bg-slate-900',
    bgSecondary: 'bg-slate-800',
    bgTertiary: 'bg-slate-900',
    bgHover: 'hover:bg-slate-700',
    border: 'border-slate-700',
    text: 'text-white',
    textSecondary: 'text-slate-300',
    textMuted: 'text-slate-400',
    colors: {
      bg: '#0F172A',
      bgSecondary: '#1E293B',
      bgTertiary: '#0F172A',
      border: '#334155',
      text: '#ffffff',
      textSecondary: '#CBD5E1',
      textMuted: '#94A3B8',
    }
  },
  light: {
    name: 'light',
    bg: 'bg-slate-50',
    bgSecondary: 'bg-white',
    bgTertiary: 'bg-slate-100',
    bgHover: 'hover:bg-slate-100',
    border: 'border-slate-200',
    text: 'text-slate-900',
    textSecondary: 'text-slate-600',
    textMuted: 'text-slate-500',
    colors: {
      bg: '#F8FAFC',
      bgSecondary: '#FFFFFF',
      bgTertiary: '#F1F5F9',
      border: '#E2E8F0',
      text: '#0F172A',
      textSecondary: '#475569',
      textMuted: '#64748B',
    }
  }
}

function ThemeProvider({ children }) {
  const [theme, setTheme] = useState(() => localStorage.getItem('vb_theme') || 'dark')
  const [accentColor, setAccentColor] = useState(() => localStorage.getItem('vb_accent') || 'orange')

  const toggleTheme = () => {
    const newTheme = theme === 'dark' ? 'light' : 'dark'
    setTheme(newTheme)
    localStorage.setItem('vb_theme', newTheme)
  }

  const changeAccent = (color) => {
    if (accentColors[color]) {
      setAccentColor(color)
      localStorage.setItem('vb_accent', color)
    }
  }

  const currentTheme = themes[theme]
  const currentAccent = accentColors[accentColor]
  const isDark = theme === 'dark'

  useEffect(() => {
    const root = document.documentElement
    const colors = currentTheme.colors
    root.style.setProperty('--bg-primary', colors.bg)
    root.style.setProperty('--bg-secondary', colors.bgSecondary)
    root.style.setProperty('--bg-tertiary', colors.bgTertiary)
    root.style.setProperty('--border-color', colors.border)
    root.style.setProperty('--text-primary', colors.text)
    root.style.setProperty('--text-secondary', colors.textSecondary)
    root.style.setProperty('--text-muted', colors.textMuted)
    root.style.setProperty('--accent-primary', currentAccent.primary)
    root.style.setProperty('--accent-light', currentAccent.light)
    root.style.setProperty('--accent-dark', currentAccent.dark)
    document.body.setAttribute('data-theme', theme)
  }, [theme, currentTheme, accentColor, currentAccent])

  return (
    <ThemeContext.Provider value={{ 
      theme, toggleTheme, isDark, 
      accentColor, changeAccent, accent: currentAccent, accentColors,
      ...currentTheme 
    }}>
      {children}
    </ThemeContext.Provider>
  )
}

function useThemeClasses() {
  const { isDark, accent } = useTheme()
  return {
    pageBg: isDark ? 'bg-slate-900' : 'bg-slate-50',
    cardBg: isDark ? 'bg-slate-800' : 'bg-white',
    cardBgAlt: isDark ? 'bg-slate-900' : 'bg-slate-50',
    inputBg: isDark ? 'bg-slate-900' : 'bg-white',
    modalBg: isDark ? 'bg-slate-800' : 'bg-white',
    border: isDark ? 'border-slate-700' : 'border-slate-200',
    text: isDark ? 'text-white' : 'text-slate-900',
    textSecondary: isDark ? 'text-slate-300' : 'text-slate-600',
    textMuted: isDark ? 'text-slate-400' : 'text-slate-500',
    hoverBg: isDark ? 'hover:bg-slate-700' : 'hover:bg-slate-100',
    hoverBgAlt: isDark ? 'hover:bg-slate-600' : 'hover:bg-slate-200',
    card: isDark ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200',
    input: isDark ? 'bg-slate-900 border-slate-700 text-white placeholder-slate-500' : 'bg-white border-slate-300 text-slate-900 placeholder-slate-400',
    modal: isDark ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200',
    colors: isDark ? themes.dark.colors : themes.light.colors,
    accent: accent
  }
}

// ============================================
// ENHANCED UI COMPONENTS (DESIGN SYSTEM)
// ============================================

// Accent Color Picker - Add to header for customization
function AccentColorPicker({ compact = true }) {
  const { accentColor, changeAccent, isDark } = useTheme()
  const tc = useThemeClasses()
  const [isOpen, setIsOpen] = useState(false)
  
  const colors = [
    { id: 'orange', color: '#F97316', label: 'Orange' },
    { id: 'blue', color: '#0EA5E9', label: 'Blue' },
    { id: 'purple', color: '#8B5CF6', label: 'Purple' },
    { id: 'green', color: '#10B981', label: 'Green' },
    { id: 'rose', color: '#F43F5E', label: 'Rose' },
    { id: 'slate', color: '#64748B', label: 'Slate' },
  ]
  
  return (
    <div className="relative">
      <button
        onClick={() => setIsOpen(!isOpen)}
        className={`p-2.5 rounded-xl transition ${tc.hoverBg} ${tc.textMuted}`}
        title="Customize accent color"
      >
        üé®
      </button>
      {isOpen && (
        <>
          <div className="fixed inset-0 z-40" onClick={() => setIsOpen(false)} />
          <div className={`absolute right-0 top-full mt-2 p-4 rounded-xl z-50 shadow-xl border ${tc.modal} ${tc.border}`}>
            <p className={`text-sm font-semibold mb-3 ${tc.text}`}>Accent Color</p>
            <div className="flex gap-2">
              {colors.map(c => (
                <button
                  key={c.id}
                  onClick={() => { changeAccent(c.id); setIsOpen(false) }}
                  className={`w-8 h-8 rounded-lg transition-transform hover:scale-110 ${
                    accentColor === c.id ? 'ring-2 ring-offset-2 ring-white/50' : ''
                  }`}
                  style={{ backgroundColor: c.color }}
                  title={c.label}
                />
              ))}
            </div>
          </div>
        </>
      )}
    </div>
  )
}

// Enhanced Metric Card with status indicators
function MetricCard({ label, value, sublabel, icon, status = 'neutral', onClick }) {
  const { isDark, accent } = useTheme()
  const tc = useThemeClasses()
  
  const statusConfig = {
    success: { indicator: 'bg-emerald-500', iconBg: isDark ? 'bg-emerald-500/20' : 'bg-emerald-50', iconColor: isDark ? 'text-emerald-400' : 'text-emerald-600', sublabelColor: isDark ? 'text-emerald-400' : 'text-emerald-600' },
    warning: { indicator: 'bg-amber-500', iconBg: isDark ? 'bg-amber-500/20' : 'bg-amber-50', iconColor: isDark ? 'text-amber-400' : 'text-amber-600', sublabelColor: isDark ? 'text-amber-400' : 'text-amber-600' },
    neutral: { indicator: 'bg-transparent', iconBg: isDark ? 'bg-slate-700' : 'bg-slate-100', iconColor: tc.textMuted, sublabelColor: tc.textMuted },
    accent: { indicator: '', iconBg: '', iconColor: '', sublabelColor: '' },
  }
  
  const config = statusConfig[status]

  return (
    <div
      onClick={onClick}
      className={`relative overflow-hidden rounded-2xl border p-6 transition-all duration-200 ${tc.card} ${onClick ? 'cursor-pointer hover:shadow-lg hover:-translate-y-0.5' : ''}`}
    >
      <div className={`absolute top-0 left-0 right-0 h-1 ${config.indicator}`} style={{ backgroundColor: status === 'accent' ? accent?.primary : undefined }} />
      <div className="flex justify-between items-start pt-2">
        <div>
          <p className={`text-xs font-semibold uppercase tracking-wider mb-2 ${tc.textMuted}`}>{label}</p>
          <p className={`text-4xl font-bold ${tc.text} tracking-tight`}>{value}</p>
          {sublabel && <p className={`text-sm font-medium mt-1 ${config.sublabelColor}`} style={{ color: status === 'accent' ? accent?.primary : undefined }}>{sublabel}</p>}
        </div>
        <div className={`w-12 h-12 rounded-xl flex items-center justify-center ${config.iconBg}`} style={{ backgroundColor: status === 'accent' ? `${accent?.primary}20` : undefined }}>
          <span className={`text-xl ${config.iconColor}`} style={{ color: status === 'accent' ? accent?.primary : undefined }}>{icon}</span>
        </div>
      </div>
      {onClick && (
        <div className={`mt-4 pt-4 border-t ${tc.border} flex items-center gap-1 text-sm font-medium`} style={{ color: accent?.primary }}>
          View details <span className="text-xs">‚Üí</span>
        </div>
      )}
    </div>
  )
}

// Quick Action Card - Large touch targets
function QuickActionCard({ icon, title, description, onClick, variant = 'default' }) {
  const { isDark, accent } = useTheme()
  const tc = useThemeClasses()
  
  const variants = {
    default: { iconBg: isDark ? 'bg-slate-700' : 'bg-slate-100', iconColor: tc.textSecondary },
    accent: { iconBg: '', iconColor: '' },
    warning: { iconBg: isDark ? 'bg-amber-500/20' : 'bg-amber-50', iconColor: isDark ? 'text-amber-400' : 'text-amber-600' },
    success: { iconBg: isDark ? 'bg-emerald-500/20' : 'bg-emerald-50', iconColor: isDark ? 'text-emerald-400' : 'text-emerald-600' },
  }
  const v = variants[variant]

  return (
    <div onClick={onClick} className={`${tc.cardBg} border ${tc.border} rounded-2xl p-5 cursor-pointer transition-all duration-200 min-h-[140px] hover:shadow-lg hover:-translate-y-0.5 hover:border-slate-600`}>
      <div className={`w-11 h-11 rounded-xl flex items-center justify-center mb-4 ${v.iconBg}`} style={{ backgroundColor: variant === 'accent' ? `${accent?.primary}20` : undefined }}>
        <span className={`text-xl ${v.iconColor}`} style={{ color: variant === 'accent' ? accent?.primary : undefined }}>{icon}</span>
      </div>
      <p className={`font-semibold ${tc.text} mb-1`}>{title}</p>
      <p className={`text-sm ${tc.textMuted} leading-relaxed`}>{description}</p>
    </div>
  )
}

// Attention Item for "Needs Attention" section
function AttentionItem({ title, description, priority = 'medium', time, onClick }) {
  const tc = useThemeClasses()
  const priorityDot = { high: 'bg-amber-500', medium: 'bg-sky-500', low: 'bg-slate-400' }
  
  return (
    <div onClick={onClick} className={`flex items-center gap-4 py-4 cursor-pointer transition-colors border-b ${tc.border} last:border-0 ${tc.hoverBg} -mx-6 px-6`}>
      <div className={`w-2 h-2 rounded-full ${priorityDot[priority]} flex-shrink-0`} />
      <div className="flex-1 min-w-0">
        <p className={`font-medium ${tc.text}`}>{title}</p>
        <p className={`text-sm ${tc.textMuted} truncate`}>{description}</p>
      </div>
      {time && <div className={`flex items-center gap-1 text-xs ${tc.textMuted}`}><span>üïê</span><span>{time}</span></div>}
      <span className={`text-sm ${tc.textMuted}`}>‚Üí</span>
    </div>
  )
}

// Progress Ring for season progress
function ProgressRing({ progress, size = 64, color }) {
  const { accent } = useTheme()
  const tc = useThemeClasses()
  const radius = (size - 6) / 2
  const circumference = radius * 2 * Math.PI
  const offset = circumference - (progress / 100) * circumference
  
  return (
    <div className="relative" style={{ width: size, height: size }}>
      <svg className="w-full h-full -rotate-90">
        <circle cx={size/2} cy={size/2} r={radius} stroke={tc.colors.border} strokeWidth="6" fill="none" />
        <circle cx={size/2} cy={size/2} r={radius} stroke={color || accent?.primary} strokeWidth="6" fill="none" strokeLinecap="round" strokeDasharray={circumference} strokeDashoffset={offset} className="transition-all duration-500" />
      </svg>
      <span className={`absolute inset-0 flex items-center justify-center text-sm font-bold ${tc.text}`}>{progress}%</span>
    </div>
  )
}

// Badge Component
function Badge({ children, variant = 'default' }) {
  const { isDark, accent } = useTheme()
  const variants = {
    default: isDark ? 'bg-slate-700 text-slate-300' : 'bg-slate-100 text-slate-600',
    accent: '',
    success: isDark ? 'bg-emerald-500/20 text-emerald-400' : 'bg-emerald-50 text-emerald-600',
    warning: isDark ? 'bg-amber-500/20 text-amber-400' : 'bg-amber-50 text-amber-600',
    error: isDark ? 'bg-red-500/20 text-red-400' : 'bg-red-50 text-red-600',
  }
  
  return (
    <span className={`inline-flex items-center px-2.5 py-1 text-xs font-semibold rounded-full ${variants[variant]}`}
      style={{ backgroundColor: variant === 'accent' ? `${accent?.primary}20` : undefined, color: variant === 'accent' ? accent?.primary : undefined }}>
      {children}
    </span>
  )
}

// Season Progress Card
function SeasonProgressCard({ season, stats }) {
  const { isDark } = useTheme()
  const tc = useThemeClasses()
  if (!season) return null
  const progress = stats?.progress || 85
  
  return (
    <div className={`${tc.cardBg} border ${tc.border} rounded-2xl p-6`}>
      <div className="flex items-center justify-between mb-5">
        <h3 className={`font-semibold ${tc.text}`}>Season Progress</h3>
        <Badge variant="success">Active</Badge>
      </div>
      <div className={`flex items-center gap-5 p-5 rounded-xl ${tc.cardBgAlt}`}>
        <ProgressRing progress={progress} />
        <div>
          <p className={`font-semibold ${tc.text}`}>{season.name}</p>
          <p className={`text-sm ${tc.textMuted}`}>Week {stats?.weeksElapsed || 11} of {stats?.totalWeeks || 14}</p>
        </div>
      </div>
      <div className="mt-5 space-y-3">
        <div className={`flex justify-between py-2 border-b ${tc.border}`}>
          <span className={`text-sm ${tc.textMuted}`}>Registration Fee</span>
          <span className={`text-sm font-semibold ${tc.text}`}>${season.registration_fee || season.fee_registration || 150}</span>
        </div>
        <div className={`flex justify-between py-2`}>
          <span className={`text-sm ${tc.textMuted}`}>Status</span>
          <span className={`text-sm font-semibold ${tc.text}`}>{season.status === 'active' ? 'Active' : season.status}</span>
        </div>
      </div>
    </div>
  )
}

// ============================================
// AUTH CONTEXT
// ============================================
const AuthContext = createContext(null)
export function useAuth() { return useContext(AuthContext) }

function AuthProvider({ children }) {
  const [user, setUser] = useState(null)
  const [profile, setProfile] = useState(null)
  const [organization, setOrganization] = useState(null)
  const [isAdmin, setIsAdmin] = useState(false)
  const [loading, setLoading] = useState(true)
  const [needsOnboarding, setNeedsOnboarding] = useState(false)

  useEffect(() => { 
    init()
    
    // Listen for auth changes (for sign up)
    const { data: { subscription } } = supabase.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_IN' && session?.user) {
        init()
      }
    })
    
    return () => subscription.unsubscribe()
  }, [])

  async function init() {
    try {
      const { data: { session } } = await supabase.auth.getSession()
      if (session?.user) {
        setUser(session.user)
        const { data: prof } = await supabase.from('profiles').select('*').eq('id', session.user.id).maybeSingle()
        setProfile(prof)
        
        // Check if user needs onboarding
        if (!prof?.onboarding_completed) {
          setNeedsOnboarding(true)
          setLoading(false)
          return
        }
        
        const { data: roles } = await supabase.from('user_roles').select('role, organization_id').eq('user_id', session.user.id).eq('is_active', true)
        if (roles && roles.length > 0) {
          setIsAdmin(roles.some(r => r.role === 'league_admin'))
          const { data: org } = await supabase.from('organizations').select('*').eq('id', roles[0].organization_id).maybeSingle()
          setOrganization(org)
        }
        setNeedsOnboarding(false)
      }
    } catch (err) { console.error('Init error:', err) }
    setLoading(false)
  }

  async function signIn(email, password) {
    const { error } = await supabase.auth.signInWithPassword({ email, password })
    if (error) throw error
    await init()
  }

  async function signUp(email, password, firstName, lastName) {
    const { data, error } = await supabase.auth.signUp({ 
      email, 
      password,
      options: {
        data: { first_name: firstName, last_name: lastName }
      }
    })
    if (error) throw error
    
    // Create profile if it doesn't exist
    if (data.user) {
      await supabase.from('profiles').upsert({
        id: data.user.id,
        email: email,
        first_name: firstName,
        last_name: lastName,
        onboarding_completed: false,
      }, { onConflict: 'id' })
    }
    
    await init()
  }

  async function signOut() {
    await supabase.auth.signOut()
    setUser(null)
    setProfile(null)
    setOrganization(null)
    setIsAdmin(false)
    setNeedsOnboarding(false)
  }

  async function completeOnboarding() {
    setNeedsOnboarding(false)
    await init()
  }

  return (
    <AuthContext.Provider value={{ 
      user, 
      profile, 
      organization, 
      isAdmin, 
      loading, 
      needsOnboarding,
      signIn, 
      signUp,
      signOut, 
      setOrganization,
      setProfile,
      completeOnboarding,
      refreshAuth: init 
    }}>
      {children}
    </AuthContext.Provider>
  )
}

const WIZARD_STEPS = {
  ROLE_SELECTION: 'role_selection',
  ORG_INFO: 'org_info',
  ORG_COMPLETE: 'org_complete',
  TEAM_CONTEXT: 'team_context',
  INDEPENDENT_TEAM_INFO: 'independent_team_info',
  INDEPENDENT_TEAM_COMPLETE: 'independent_team_complete',
  JOIN_ORG: 'join_org',
  JOIN_PENDING: 'join_pending',
  AWAITING_ASSIGNMENT: 'awaiting_assignment',
  PARENT_PLAYER_TYPE: 'parent_player_type',
}
function WizardContainer({ children, showBack, onBack, progress, error, colors, accent, tc }) {
  return (
    <div className={`min-h-screen ${tc.pageBg}`} style={{ backgroundColor: colors.bg }}>
      <div className="max-w-lg mx-auto px-6 py-8">
        <div className="flex items-center justify-between mb-8">
          {showBack ? (
            <button onClick={onBack} className={`p-3 rounded-xl ${tc.cardBg} border ${tc.border} ${tc.textSecondary}`}>
              ‚Üê
            </button>
          ) : (
            <div className="w-12" />
          )}
          <div className="flex items-center gap-3">
            <VolleyballIcon className="w-8 h-8" />
            <span className={`font-bold text-xl ${tc.text}`}>VolleyBrain</span>
          </div>
          <div className="w-12" />
        </div>

        <div className={`h-1.5 rounded-full mb-8 ${tc.cardBg}`}>
          <div className="h-full rounded-full transition-all duration-300" style={{ width: `${progress}%`, backgroundColor: accent.primary }} />
        </div>

        {error && (
          <div className="mb-6 p-4 bg-red-500/10 border border-red-500/30 rounded-xl text-red-400 text-sm">
            {error}
          </div>
        )}

        {children}
      </div>
    </div>
  )
}

function WizardRoleCard({ icon, title, description, selected, onToggle, showCheckbox = true, tc }) {
  return (
    <div
      onClick={onToggle}
      className={`p-5 rounded-xl border-2 cursor-pointer transition-all ${
        selected
          ? 'border-[var(--accent-primary)] bg-[var(--accent-primary)]/10'
          : `${tc.cardBg} ${tc.border} hover:border-slate-500`
      }`}
    >
      <div className="flex items-start gap-4">
        <div className={`w-12 h-12 rounded-xl flex items-center justify-center text-xl ${selected ? 'bg-[var(--accent-primary)] text-white' : tc.cardBgAlt}`}>
          {icon}
        </div>
        <div className="flex-1">
          <p className={`font-semibold ${tc.text}`}>{title}</p>
          <p className={`text-sm ${tc.textMuted} mt-1`}>{description}</p>
        </div>
        {showCheckbox && (
          <div className={`w-6 h-6 rounded-md border-2 flex items-center justify-center ${selected ? 'bg-[var(--accent-primary)] border-[var(--accent-primary)] text-white' : tc.border}`}>
            {selected && '‚úì'}
          </div>
        )}
      </div>
    </div>
  )
}

function WizardOptionCard({ icon, title, description, onClick, tc }) {
  // Map icon names to Lucide components
  const iconMap = {
    volleyball: VolleyballIcon,
    link: Link,
    clock: Clock,
    users: Users,
    user: User,
    shield: Shield,
  }
  const IconComponent = iconMap[icon]
  
  return (
    <div onClick={onClick} className={`p-5 rounded-xl border ${tc.cardBg} ${tc.border} cursor-pointer transition-all hover:border-slate-500`}>
      <div className="flex items-center gap-4">
        <div className={`w-12 h-12 rounded-xl flex items-center justify-center ${tc.cardBgAlt}`}>
          {IconComponent ? <IconComponent className="w-6 h-6" /> : <span className="text-xl">{icon}</span>}
        </div>
        <div className="flex-1">
          <p className={`font-semibold ${tc.text}`}>{title}</p>
          <p className={`text-sm ${tc.textMuted} mt-1`}>{description}</p>
        </div>
        <ChevronRight className={`w-5 h-5 ${tc.textMuted}`} />
      </div>
    </div>
  )
}

function WizardPrimaryButton({ children, onClick, disabled, saving, accent }) {
  return (
    <button
      onClick={onClick}
      disabled={disabled || saving}
      className="w-full py-4 rounded-xl font-semibold transition-all disabled:opacity-50 disabled:cursor-not-allowed"
      style={{ backgroundColor: accent.primary, color: '#fff' }}
    >
      {saving ? 'Saving...' : children}
    </button>
  )
}

function WizardInputField({ label, value, onChange, placeholder, type = 'text', tc }) {
  return (
    <div className="mb-5">
      <label className={`block text-sm ${tc.textMuted} mb-2`}>{label}</label>
      <input
        type={type}
        value={value}
        onChange={onChange}
        placeholder={placeholder}
        className={`w-full px-4 py-3 rounded-xl border ${tc.input}`}
      />
    </div>
  )
}

function WizardSummaryCard({ title, items, accent, tc }) {
  return (
    <div className="p-5 rounded-xl border" style={{ borderColor: accent.primary + '50', backgroundColor: accent.primary + '10' }}>
      <p className="text-sm font-semibold uppercase tracking-wider mb-4" style={{ color: accent.primary }}>{title}</p>
      {items.map((item, i) => (
        <div key={i} className={`flex justify-between py-2 ${i < items.length - 1 ? `border-b ${tc.border}` : ''}`}>
          <span className={tc.textMuted}>{item.label}</span>
          <span className={`font-medium ${tc.text}`}>{item.value}</span>
        </div>
      ))}
    </div>
  )
}

// ============================================
// SETUP WIZARD - SIMPLIFIED VERSION
// ============================================

function SetupWizard({ onComplete }) {
  const { user, profile } = useAuth()
  const journey = useJourney()
  const tc = useThemeClasses()
  const { accent, colors } = useTheme()
  
  // Navigation state
  const [currentStep, setCurrentStep] = useState(WIZARD_STEPS.ROLE_SELECTION)
  const [history, setHistory] = useState([])
  
  // Form state
  const [selectedRoles, setSelectedRoles] = useState([])
  const [orgName, setOrgName] = useState('')
  const [teamName, setTeamName] = useState('')
  const [inviteCode, setInviteCode] = useState('')
  
  // UI state
  const [saving, setSaving] = useState(false)
  const [error, setError] = useState(null)

  const navigateTo = (step) => {
    setHistory(prev => [...prev, currentStep])
    setCurrentStep(step)
    setError(null)
  }

  const goBack = () => {
    if (history.length === 0) return
    const newHistory = [...history]
    const prevStep = newHistory.pop()
    setHistory(newHistory)
    setCurrentStep(prevStep)
    setError(null)
  }

  const toggleRole = (role) => {
    setSelectedRoles(prev => 
      prev.includes(role) ? prev.filter(r => r !== role) : [...prev, role]
    )
  }

  const getProgress = () => {
    const progressMap = {
      [WIZARD_STEPS.ROLE_SELECTION]: 20,
      [WIZARD_STEPS.ORG_INFO]: 60,
      [WIZARD_STEPS.ORG_COMPLETE]: 100,
      [WIZARD_STEPS.TEAM_CONTEXT]: 40,
      [WIZARD_STEPS.INDEPENDENT_TEAM_INFO]: 60,
      [WIZARD_STEPS.INDEPENDENT_TEAM_COMPLETE]: 100,
      [WIZARD_STEPS.JOIN_ORG]: 60,
      [WIZARD_STEPS.JOIN_PENDING]: 100,
      [WIZARD_STEPS.PARENT_PLAYER_TYPE]: 40,
      [WIZARD_STEPS.AWAITING_ASSIGNMENT]: 100,
    }
    return progressMap[currentStep] || 0
  }

  // Common props for WizardContainer
  const containerProps = {
    showBack: history.length > 0,
    onBack: goBack,
    progress: getProgress(),
    error,
    colors,
    accent,
    tc,
  }

  // ============================================
  // DATABASE ACTIONS
  // ============================================

  const createOrganization = async () => {
    setSaving(true)
    setError(null)
    try {
      const slug = orgName.toLowerCase()
        .replace(/[^a-z0-9\s]/g, '')
        .replace(/\s+/g, '-')
        .substring(0, 50) + '-' + Date.now().toString(36)

      const { data: org, error: orgError } = await supabase
        .from('organizations')
        .insert({
          name: orgName,
          slug: slug,
          type: 'club',
          settings: { sports: ['volleyball'] },
        })
        .select()
        .single()

      if (orgError) throw orgError

      await supabase.from('user_roles').insert({
        user_id: user.id,
        organization_id: org.id,
        role: 'league_admin',
        is_active: true,
      })

      await supabase.from('profiles').update({
        onboarding_completed: true,
        onboarding_data: {
          role: 'org_director',
          organization_id: org.id,
          completed_at: new Date().toISOString(),
          completed_steps: ['create_org'], // Initialize with first step complete
          earned_badges: ['founder'], // Award the founder badge
        },
      }).eq('id', user.id)

      // Complete journey step (will be picked up after reload)
      if (journey?.completeStep) {
        journey.completeStep('create_org')
      }

      setSaving(false)
      navigateTo(WIZARD_STEPS.ORG_COMPLETE)
    } catch (err) {
      console.error('Error creating organization:', err)
      setSaving(false)
      setError(err.message)
    }
  }

  const createIndependentTeam = async () => {
  setSaving(true)
  setError(null)
  try {
    const slug = teamName.toLowerCase()
      .replace(/[^a-z0-9\s]/g, '')
      .replace(/\s+/g, '-')
      .substring(0, 50) + '-' + Date.now().toString(36)

    // Just create org - they'll add team from dashboard
    const { data: org, error: orgError } = await supabase
      .from('organizations')
      .insert({
        name: teamName,
        slug: slug,
        type: 'independent_team',
        settings: { sports: ['volleyball'] },
      })
      .select()
      .single()

    if (orgError) throw orgError

    await supabase.from('user_roles').insert({
      user_id: user.id,
      organization_id: org.id,
      role: 'league_admin',
      is_active: true,
    })

    await supabase.from('profiles').update({
      onboarding_completed: true,
      onboarding_data: {
        role: 'team_manager',
        organization_id: org.id,
        completed_at: new Date().toISOString(),
        completed_steps: ['join_create_team'], // Initialize with first step complete
        earned_badges: ['team_builder'], // Award the team builder badge
      },
    }).eq('id', user.id)

    // Complete journey step
    if (journey?.completeStep) {
      journey.completeStep('join_create_team')
    }

    setSaving(false)
    navigateTo(WIZARD_STEPS.INDEPENDENT_TEAM_COMPLETE)
  } catch (err) {
    console.error('Error creating team:', err)
    setSaving(false)
    setError(err.message)
  }
}

  const useInviteCode = async () => {
    setSaving(true)
    setError(null)
    try {
      // Try team_invite_codes first
      const { data: invite } = await supabase
        .from('team_invite_codes')
        .select('*, teams(id, name, organization_id)')
        .eq('code', inviteCode.toUpperCase())
        .eq('is_active', true)
        .maybeSingle()

      if (!invite) {
        // Try account_invites
        const { data: accountInvite } = await supabase
          .from('account_invites')
          .select('*')
          .eq('invite_code', inviteCode.toUpperCase())
          .eq('status', 'pending')
          .maybeSingle()

        if (!accountInvite) {
          throw new Error('Invalid or expired invite code')
        }

        await supabase.from('account_invites')
          .update({ status: 'accepted', accepted_at: new Date().toISOString() })
          .eq('id', accountInvite.id)

        await supabase.from('user_roles').insert({
          user_id: user.id,
          organization_id: accountInvite.organization_id,
          role: accountInvite.role || 'parent',
          is_active: true,
        })

        await supabase.from('profiles').update({
          onboarding_completed: true,
          onboarding_data: {
            role: accountInvite.role || 'parent',
            organization_id: accountInvite.organization_id,
            completed_at: new Date().toISOString(),
          },
        }).eq('id', user.id)

        setSaving(false)
        navigateTo(WIZARD_STEPS.JOIN_PENDING)
        return
      }

      // Team invite found
      const orgId = invite.teams?.organization_id

      await supabase.from('user_roles').insert({
        user_id: user.id,
        organization_id: orgId,
        role: 'parent',
        is_active: true,
      })

      await supabase.from('profiles').update({
        onboarding_completed: true,
        onboarding_data: {
          role: 'parent',
          organization_id: orgId,
          team_id: invite.team_id,
          completed_at: new Date().toISOString(),
        },
      }).eq('id', user.id)

      setSaving(false)
      navigateTo(WIZARD_STEPS.JOIN_PENDING)
    } catch (err) {
      console.error('Error using invite code:', err)
      setSaving(false)
      setError(err.message)
    }
  }

  const skipOnboarding = async () => {
    await supabase.from('profiles').update({
      onboarding_completed: true,
      onboarding_data: { skipped: true, completed_at: new Date().toISOString() },
    }).eq('id', user.id)
    onComplete()
  }

  const finishOnboarding = () => onComplete()

  // ============================================
  // RENDER SCREENS
  // ============================================

  // STEP 1: Role Selection
  if (currentStep === WIZARD_STEPS.ROLE_SELECTION) {
    const roles = [
      { id: 'org_director', icon: 'building', title: 'Organization Director', description: 'I run a club with multiple teams' },
      { id: 'team_manager', icon: 'clipboard', title: 'Team Manager / Coach', description: 'I manage or coach a team' },
      { id: 'parent', icon: '‚ù§Ô∏è', title: 'Parent / Guardian', description: 'I have a child who plays' },
      { id: 'player', icon: 'volleyball', title: 'Player', description: "I'm a player" },
    ]

    const handleContinue = () => {
      if (selectedRoles.includes('org_director')) {
        navigateTo(WIZARD_STEPS.ORG_INFO)
      } else if (selectedRoles.includes('team_manager')) {
        navigateTo(WIZARD_STEPS.TEAM_CONTEXT)
      } else {
        navigateTo(WIZARD_STEPS.PARENT_PLAYER_TYPE)
      }
    }

    return (
      <WizardContainer {...containerProps} showBack={false}>
        <h1 className={`text-2xl font-bold ${tc.text} mb-2`}>
          Welcome{profile?.first_name ? `, ${profile.first_name}` : ''}!
        </h1>
        <p className={`${tc.textMuted} mb-8`}>What brings you to VolleyBrain?</p>

        <div className="space-y-3 mb-8">
          {roles.map(role => (
            <WizardRoleCard
              key={role.id}
              icon={role.icon}
              title={role.title}
              description={role.description}
              selected={selectedRoles.includes(role.id)}
              onToggle={() => toggleRole(role.id)}
              tc={tc}
            />
          ))}
        </div>

        <WizardPrimaryButton onClick={handleContinue} disabled={selectedRoles.length === 0} saving={saving} accent={accent}>
          Continue ‚Üí
        </WizardPrimaryButton>
      </WizardContainer>
    )
  }

  // ORG DIRECTOR: Create Organization
  if (currentStep === WIZARD_STEPS.ORG_INFO) {
    return (
      <WizardContainer {...containerProps}>
        <h1 className={`text-2xl font-bold ${tc.text} mb-2`}>Create your organization</h1>
        <p className={`${tc.textMuted} mb-8`}>You can add teams and configure settings after setup.</p>

        <WizardInputField 
          label="Organization Name" 
          value={orgName} 
          onChange={(e) => setOrgName(e.target.value)} 
          placeholder="e.g., Black Hornets Volleyball" 
          tc={tc} 
        />

        <WizardPrimaryButton onClick={createOrganization} disabled={!orgName.trim()} saving={saving} accent={accent}>
          Create Organization ‚Üí
        </WizardPrimaryButton>
      </WizardContainer>
    )
  }

  // ORG DIRECTOR: Complete
  if (currentStep === WIZARD_STEPS.ORG_COMPLETE) {
    return (
      <WizardContainer {...containerProps} showBack={false}>
        <div className="text-center mb-8">
          <div className="w-20 h-20 rounded-full mx-auto mb-6 flex items-center justify-center text-4xl" style={{ backgroundColor: accent.primary }}>‚úì</div>
          <h1 className={`text-2xl font-bold ${tc.text} mb-2`}>You're all set!</h1>
          <p className={`${tc.textMuted}`}>Your organization has been created.</p>
        </div>

        <WizardSummaryCard title="Organization" items={[
          { label: 'Name', value: orgName },
          { label: 'Your Role', value: 'Organization Director' },
        ]} accent={accent} tc={tc} />

        <div className="mt-8">
          <WizardPrimaryButton onClick={finishOnboarding} saving={saving} accent={accent}>
            Go to Dashboard ‚Üí
          </WizardPrimaryButton>
        </div>
      </WizardContainer>
    )
  }

  // TEAM MANAGER: Choose Path
  if (currentStep === WIZARD_STEPS.TEAM_CONTEXT) {
    return (
      <WizardContainer {...containerProps}>
        <h1 className={`text-2xl font-bold ${tc.text} mb-2`}>Your team</h1>
        <p className={`${tc.textMuted} mb-8`}>How is your team organized?</p>

        <div className="space-y-3">
          <WizardOptionCard icon="volleyball" title="Create a new team" description="I'm starting fresh or run my own team" onClick={() => navigateTo(WIZARD_STEPS.INDEPENDENT_TEAM_INFO)} tc={tc} />
          <WizardOptionCard icon="link" title="Join an existing organization" description="I have an invite code" onClick={() => navigateTo(WIZARD_STEPS.JOIN_ORG)} tc={tc} />
          <WizardOptionCard icon="clock" title="I'll be assigned later" description="Someone will add me to a team" onClick={() => navigateTo(WIZARD_STEPS.AWAITING_ASSIGNMENT)} tc={tc} />
        </div>
      </WizardContainer>
    )
  }

  // TEAM MANAGER: Create Team
  if (currentStep === WIZARD_STEPS.INDEPENDENT_TEAM_INFO) {
    return (
      <WizardContainer {...containerProps}>
        <h1 className={`text-2xl font-bold ${tc.text} mb-2`}>Create your team</h1>
        <p className={`${tc.textMuted} mb-8`}>You can add players and configure settings after setup.</p>

        <WizardInputField 
          label="Team Name" 
          value={teamName} 
          onChange={(e) => setTeamName(e.target.value)} 
          placeholder="e.g., Dallas Elite 14U" 
          tc={tc} 
        />

        <WizardPrimaryButton onClick={createIndependentTeam} disabled={!teamName.trim()} saving={saving} accent={accent}>
          Create Team ‚Üí
        </WizardPrimaryButton>
      </WizardContainer>
    )
  }

  // TEAM MANAGER: Complete
  if (currentStep === WIZARD_STEPS.INDEPENDENT_TEAM_COMPLETE) {
    return (
      <WizardContainer {...containerProps} showBack={false}>
        <div className="text-center mb-8">
          <div className="w-20 h-20 rounded-full mx-auto mb-6 flex items-center justify-center text-4xl" style={{ backgroundColor: accent.primary }}>‚úì</div>
          <h1 className={`text-2xl font-bold ${tc.text} mb-2`}>Team created!</h1>
          <p className={`${tc.textMuted}`}>You can now add players and set up your season.</p>
        </div>

        <WizardSummaryCard title="Team" items={[
          { label: 'Name', value: teamName },
          { label: 'Your Role', value: 'Team Manager' },
        ]} accent={accent} tc={tc} />

        <div className="mt-8">
          <WizardPrimaryButton onClick={finishOnboarding} saving={saving} accent={accent}>
            Go to Dashboard ‚Üí
          </WizardPrimaryButton>
        </div>
      </WizardContainer>
    )
  }

  // JOIN: Enter Invite Code
  if (currentStep === WIZARD_STEPS.JOIN_ORG) {
    return (
      <WizardContainer {...containerProps}>
        <h1 className={`text-2xl font-bold ${tc.text} mb-2`}>Join your organization</h1>
        <p className={`${tc.textMuted} mb-8`}>Enter the invite code from your organization.</p>

        <WizardInputField 
          label="Invite Code" 
          value={inviteCode} 
          onChange={(e) => setInviteCode(e.target.value.toUpperCase())} 
          placeholder="e.g., BLACKHORNETS2026" 
          tc={tc} 
        />

        <div className={`p-4 rounded-xl mb-8 ${tc.cardBgAlt}`}>
          <p className={`text-sm ${tc.textMuted}`}>üí° Ask your team manager or organization director for the invite code.</p>
        </div>

        <WizardPrimaryButton onClick={useInviteCode} disabled={!inviteCode.trim()} saving={saving} accent={accent}>
          Join ‚Üí
        </WizardPrimaryButton>
      </WizardContainer>
    )
  }

  // JOIN: Success
  if (currentStep === WIZARD_STEPS.JOIN_PENDING) {
    return (
      <WizardContainer {...containerProps} showBack={false}>
        <div className="text-center mb-8">
          <div className="w-20 h-20 rounded-full mx-auto mb-6 flex items-center justify-center text-4xl" style={{ backgroundColor: accent.primary }}>‚úì</div>
          <h1 className={`text-2xl font-bold ${tc.text} mb-2`}>You're in!</h1>
          <p className={`${tc.textMuted}`}>Welcome to the organization.</p>
        </div>

        <div className="mt-8">
          <WizardPrimaryButton onClick={finishOnboarding} saving={saving} accent={accent}>
            Go to Dashboard ‚Üí
          </WizardPrimaryButton>
        </div>
      </WizardContainer>
    )
  }

  // AWAITING: Will be assigned later
  if (currentStep === WIZARD_STEPS.AWAITING_ASSIGNMENT) {
    return (
      <WizardContainer {...containerProps} showBack={false}>
        <div className="text-center mb-8">
          <div className="w-20 h-20 rounded-full mx-auto mb-6 flex items-center justify-center text-4xl" style={{ backgroundColor: accent.primary + '30' }}>‚è≥</div>
          <h1 className={`text-2xl font-bold ${tc.text} mb-2`}>All set!</h1>
          <p className={`${tc.textMuted}`}>You'll be notified when you're assigned to a team.</p>
        </div>

        <div className="mt-8">
          <WizardPrimaryButton onClick={skipOnboarding} saving={saving} accent={accent}>
            Got it ‚Üí
          </WizardPrimaryButton>
        </div>
      </WizardContainer>
    )
  }

  // PARENT/PLAYER: Choose Path
  if (currentStep === WIZARD_STEPS.PARENT_PLAYER_TYPE) {
    return (
      <WizardContainer {...containerProps}>
        <h1 className={`text-2xl font-bold ${tc.text} mb-2`}>Getting started</h1>
        <p className={`${tc.textMuted} mb-8`}>How would you like to proceed?</p>

        <div className="space-y-3">
          <WizardOptionCard icon="link" title="I have an invite code" description="Join my team or organization" onClick={() => navigateTo(WIZARD_STEPS.JOIN_ORG)} tc={tc} />
          <WizardOptionCard icon="clock" title="Skip for now" description="I'll join a team later" onClick={skipOnboarding} tc={tc} />
        </div>
      </WizardContainer>
    )
  }

  // Fallback
  return (
    <WizardContainer {...containerProps} showBack={false}>
      <div className="text-center">
        <h1 className={`text-2xl font-bold ${tc.text} mb-4`}>Welcome to VolleyBrain!</h1>
        <WizardPrimaryButton onClick={skipOnboarding} saving={saving} accent={accent}>
          Continue ‚Üí
        </WizardPrimaryButton>
      </div>
    </WizardContainer>
  )
}

// ============================================
// GLOBAL SPORT CONTEXT
// ============================================
const SportContext = createContext(null)
export function useSport() { return useContext(SportContext) }

function SportProvider({ children }) {
  const { organization } = useAuth()
  const [sports, setSports] = useState([])
  const [selectedSport, setSelectedSport] = useState(null) // null = "All Sports"
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    loadSports()
  }, [organization?.id])

  async function loadSports() {
    setLoading(true)
    try {
      const { data } = await supabase
        .from('sports')
        .select('*')
        .eq('is_active', true)
        .order('sort_order')
      
      setSports(data || [])
      
      // Try to restore from localStorage
      const savedSportId = localStorage.getItem('vb_selected_sport')
      if (savedSportId && savedSportId !== 'all') {
        const savedSport = data?.find(s => s.id === savedSportId)
        setSelectedSport(savedSport || null)
      }
    } catch (err) {
      console.error('Load sports error:', err)
    }
    setLoading(false)
  }

  function selectSport(sport) {
    setSelectedSport(sport)
    localStorage.setItem('vb_selected_sport', sport?.id || 'all')
  }

  return (
    <SportContext.Provider value={{ 
      sports, 
      selectedSport, 
      selectSport, 
      loading 
    }}>
      {children}
    </SportContext.Provider>
  )
}

// ============================================
// GLOBAL SEASON CONTEXT
// ============================================
const SeasonContext = createContext(null)
export function useSeason() { return useContext(SeasonContext) }

function SeasonProvider({ children }) {
  const { organization } = useAuth()
  const { selectedSport } = useSport()
  const [allSeasons, setAllSeasons] = useState([])
  const [selectedSeason, setSelectedSeason] = useState(null)
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    if (organization?.id) loadSeasons()
  }, [organization?.id])

  // Re-filter when sport changes
  useEffect(() => {
    if (allSeasons.length > 0) {
      const filtered = filteredSeasons()
      // If current season isn't in filtered list, switch to first available
      if (selectedSeason && !filtered.find(s => s.id === selectedSeason.id)) {
        const activeSeason = filtered.find(s => s.status === 'active')
        setSelectedSeason(activeSeason || filtered[0] || null)
      }
    }
  }, [selectedSport?.id, allSeasons])

  async function loadSeasons() {
    setLoading(true)
    try {
      const { data } = await supabase
        .from('seasons')
        .select('*, sports(id, name, icon, color_primary)')
        .eq('organization_id', organization.id)
        .order('created_at', { ascending: false })
      
      setAllSeasons(data || [])
      
      // Try to restore from localStorage, otherwise use active or first season
      const savedSeasonId = localStorage.getItem('vb_selected_season')
      const savedSeason = data?.find(s => s.id === savedSeasonId)
      const activeSeason = data?.find(s => s.status === 'active')
      
      setSelectedSeason(savedSeason || activeSeason || data?.[0] || null)
    } catch (err) {
      console.error('Load seasons error:', err)
    }
    setLoading(false)
  }

  // Filter seasons by selected sport (or show all if no sport selected)
  function filteredSeasons() {
    if (!selectedSport) return allSeasons
    // Filter by sport, but if nothing matches, show all (don't hide everything)
    const filtered = allSeasons.filter(s => s.sport_id === selectedSport.id)
    // If no seasons match the sport filter, show all seasons (with a note)
    // This prevents users from getting stuck with "no seasons" when they have seasons
    return filtered.length > 0 ? filtered : allSeasons
  }

  function selectSeason(season) {
    setSelectedSeason(season)
    if (season?.id) {
      localStorage.setItem('vb_selected_season', season.id)
    }
  }

  async function refreshSeasons(selectId = null) {
    setLoading(true)
    try {
      const { data } = await supabase
        .from('seasons')
        .select('*, sports(id, name, icon, color_primary)')
        .eq('organization_id', organization.id)
        .order('created_at', { ascending: false })
      
      setAllSeasons(data || [])
      
      // If a specific season ID was passed, select it
      if (selectId) {
        const targetSeason = data?.find(s => s.id === selectId)
        if (targetSeason) {
          setSelectedSeason(targetSeason)
          localStorage.setItem('vb_selected_season', targetSeason.id)
          setLoading(false)
          return
        }
      }
      
      // Otherwise, try to restore from localStorage, or use active/first season
      const savedSeasonId = localStorage.getItem('vb_selected_season')
      const savedSeason = data?.find(s => s.id === savedSeasonId)
      const activeSeason = data?.find(s => s.status === 'active')
      
      // If no season currently selected, auto-select the best option
      if (!selectedSeason) {
        const newSelection = savedSeason || activeSeason || data?.[0] || null
        setSelectedSeason(newSelection)
        if (newSelection?.id) {
          localStorage.setItem('vb_selected_season', newSelection.id)
        }
      }
    } catch (err) {
      console.error('Load seasons error:', err)
    }
    setLoading(false)
  }

  const seasons = filteredSeasons()

  return (
    <SeasonContext.Provider value={{ 
      seasons,
      allSeasons, 
      selectedSeason, 
      selectSeason, 
      loading,
      refreshSeasons 
    }}>
      {children}
    </SeasonContext.Provider>
  )
}

// ============================================
// URL PARAMETER UTILITIES FOR REGISTRATION PRE-FILL
// ============================================

/**
 * Parse URL parameters for registration pre-fill
 * Supports re-registration and sibling registration flows
 * 
 * URL formats:
 * - Re-registration: /register/{org}/{season}?prefill=reregister&first_name=...&parent_email=...
 * - Sibling: /register/{org}/{season}?prefill=sibling
 * 
 * @returns {Object} Parsed registration data
 */
function getRegistrationPrefillData() {
  const params = new URLSearchParams(window.location.search)
  const prefillType = params.get('prefill')
  
  if (!prefillType) return null
  
  const data = {
    prefillType, // 'reregister' or 'sibling'
    // Player info
    first_name: params.get('first_name') || '',
    last_name: params.get('last_name') || '',
    birth_date: params.get('birth_date') || '',
    grade: params.get('grade') || '',
    gender: params.get('gender') || '',
    school: params.get('school') || '',
    // Parent info
    parent_name: params.get('parent_name') || '',
    parent_email: params.get('parent_email') || '',
    parent_phone: params.get('parent_phone') || '',
    // Tracking
    source_player_id: params.get('source_player_id') || null
  }
  
  return data
}

/**
 * Hook for using registration pre-fill data in React components
 */
function useRegistrationPrefill() {
  const [prefillData, setPrefillData] = useState(null)
  
  useEffect(() => {
    const data = getRegistrationPrefillData()
    if (data) {
      setPrefillData(data)
      // Clear URL params to prevent confusion on refresh (optional)
      // window.history.replaceState({}, '', window.location.pathname)
    }
  }, [])
  
  return prefillData
}

/**
 * Apply pre-fill data to a registration form state
 * @param {Object} prefillData - Data from getRegistrationPrefillData()
 * @param {Object} formState - Current form state
 * @param {Function} setFormState - State setter function
 */
function applyRegistrationPrefill(prefillData, formState, setFormState) {
  if (!prefillData) return
  
  const updates = {}
  
  // For re-registration, we fill in player info
  if (prefillData.prefillType === 'reregister') {
    // Player details
    if (prefillData.first_name) updates.first_name = prefillData.first_name
    if (prefillData.last_name) updates.last_name = prefillData.last_name
    if (prefillData.birth_date) updates.birth_date = prefillData.birth_date
    if (prefillData.grade) updates.grade = prefillData.grade
    if (prefillData.gender) updates.gender = prefillData.gender
    if (prefillData.school) updates.school = prefillData.school
  }
  
  // For both re-registration and sibling, fill parent info
  if (prefillData.parent_name) updates.parent_name = prefillData.parent_name
  if (prefillData.parent_email) updates.parent_email = prefillData.parent_email
  if (prefillData.parent_phone) updates.parent_phone = prefillData.parent_phone
  
  // Track source player for analytics
  if (prefillData.source_player_id) updates.prefilled_from_player_id = prefillData.source_player_id
  
  if (Object.keys(updates).length > 0) {
    setFormState({ ...formState, ...updates })
  }
}

/**
 * Check if the current page is a registration page with pre-fill params
 */
function hasRegistrationPrefill() {
  const params = new URLSearchParams(window.location.search)
  return params.has('prefill')
}

// ============================================
// CSV EXPORT UTILITY
// ============================================
function exportToCSV(data, filename, columns) {
  if (!data || data.length === 0) {
    alert('No data to export')
    return
  }

  const headers = columns.map(c => c.label).join(',')
  const rows = data.map(row => 
    columns.map(c => {
      let value = c.accessor(row)
      if (value === null || value === undefined) value = ''
      // Escape commas and quotes
      value = String(value).replace(/"/g, '""')
      if (value.includes(',') || value.includes('"') || value.includes('\n')) {
        value = `"${value}"`
      }
      return value
    }).join(',')
  )

  const csv = [headers, ...rows].join('\n')
  const blob = new Blob([csv], { type: 'text/csv' })
  const url = URL.createObjectURL(blob)
  const a = document.createElement('a')
  a.href = url
  a.download = `${filename}_${new Date().toISOString().split('T')[0]}.csv`
  a.click()
  URL.revokeObjectURL(url)
}

// ============================================
// FEE GENERATION UTILITIES
// ============================================

/**
 * Calculate all fees for a player based on season settings
 * Returns array of fee objects ready to insert into payments table
 */
function calculateFeesForPlayer(player, season, options = {}) {
  const { 
    checkExistingFamilyFee = true, 
    existingFamilyEmails = [],
    siblingIndex = 0  // 0 = first child, 1 = second child, etc.
  } = options
  const fees = []
  const familyEmail = player.parent_email?.toLowerCase()
  const now = new Date()
  const registrationDate = player.registrations?.[0]?.created_at ? new Date(player.registrations[0].created_at) : now
  
  // Determine if early bird pricing applies
  const earlyBirdDeadline = season.early_bird_deadline ? new Date(season.early_bird_deadline) : null
  const isEarlyBird = earlyBirdDeadline && registrationDate <= earlyBirdDeadline
  const earlyBirdDiscount = isEarlyBird ? (parseFloat(season.early_bird_discount) || 0) : 0
  
  // Calculate sibling discount
  const siblingDiscountType = season.sibling_discount_type || 'none'
  const siblingDiscountAmount = parseFloat(season.sibling_discount_amount) || 0
  const siblingDiscountApplyTo = season.sibling_discount_apply_to || 'additional'
  
  // Determine if this player gets sibling discount
  const getsSiblingDiscount = siblingDiscountType !== 'none' && siblingDiscountAmount > 0 && (
    siblingDiscountApplyTo === 'all' ? siblingIndex >= 0 : siblingIndex > 0
  )
  
  // Base fee record template
  const baseFee = {
    season_id: season.id,
    player_id: player.id,
    family_email: familyEmail,
    registration_id: player.registrations?.[0]?.id,
    paid: false,
    auto_generated: true,
    created_at: new Date().toISOString()
  }
  
  // Helper to apply sibling discount to an amount
  function applySiblingDiscount(amount, feeName) {
    if (!getsSiblingDiscount || amount <= 0) return { amount, discountApplied: 0, description: '' }
    
    let discountApplied = 0
    if (siblingDiscountType === 'flat') {
      discountApplied = Math.min(siblingDiscountAmount, amount) // Don't discount more than the fee
    } else if (siblingDiscountType === 'percent') {
      discountApplied = amount * (siblingDiscountAmount / 100)
    }
    
    const newAmount = Math.max(0, amount - discountApplied)
    const description = discountApplied > 0 
      ? ` (Sibling discount: -$${discountApplied.toFixed(2)})`
      : ''
    
    return { amount: newAmount, discountApplied, description }
  }
  
  // 1. Registration Fee (per player) - sibling discount applies here
  const registrationFee = parseFloat(season.fee_registration) || 0
  if (registrationFee > 0) {
    let adjustedAmount = Math.max(0, registrationFee - earlyBirdDiscount)
    const siblingResult = applySiblingDiscount(adjustedAmount, 'Registration')
    adjustedAmount = siblingResult.amount
    
    let feeName = 'Registration'
    let description = 'Season registration fee'
    
    if (isEarlyBird && siblingResult.discountApplied > 0) {
      feeName = 'Registration (Early Bird + Sibling)'
      description = `Early bird -$${earlyBirdDiscount}, Sibling -$${siblingResult.discountApplied.toFixed(2)}`
    } else if (isEarlyBird) {
      feeName = 'Registration (Early Bird)'
      description = `Registration fee with $${earlyBirdDiscount} early bird discount`
    } else if (siblingResult.discountApplied > 0) {
      feeName = 'Registration (Sibling Discount)'
      description = `Registration fee with $${siblingResult.discountApplied.toFixed(2)} sibling discount`
    }
    
    fees.push({
      ...baseFee,
      fee_type: 'registration',
      fee_name: feeName,
      fee_category: 'per_player',
      amount: adjustedAmount,
      description
    })
  }
  
  // 2. Uniform Fee (per player) - no sibling discount typically
  const uniformFee = parseFloat(season.fee_uniform) || 0
  if (uniformFee > 0) {
    fees.push({
      ...baseFee,
      fee_type: 'uniform',
      fee_name: 'Uniform',
      fee_category: 'per_player',
      amount: uniformFee,
      description: 'Uniform/jersey fee'
    })
  }
  
  // 3. Monthly Fees (per player) - sibling discount can apply
  const monthlyFee = parseFloat(season.fee_monthly) || 0
  const monthsInSeason = parseInt(season.months_in_season) || 0
  if (monthlyFee > 0 && monthsInSeason > 0) {
    const totalMonthly = monthlyFee * monthsInSeason
    const siblingResult = applySiblingDiscount(totalMonthly, 'Monthly')
    
    let feeName = `Monthly Fees (${monthsInSeason} months)`
    let description = `$${monthlyFee}/month √ó ${monthsInSeason} months`
    
    if (siblingResult.discountApplied > 0) {
      feeName = `Monthly Fees (${monthsInSeason} months, Sibling)`
      description = `$${monthlyFee}/month √ó ${monthsInSeason} months, Sibling -$${siblingResult.discountApplied.toFixed(2)}`
    }
    
    fees.push({
      ...baseFee,
      fee_type: 'monthly',
      fee_name: feeName,
      fee_category: 'per_player',
      amount: siblingResult.amount,
      description
    })
  }
  
  // 4. Per-Family Fee (only if not already charged for this family in this season)
  const familyFee = parseFloat(season.fee_per_family) || 0
  if (familyFee > 0 && familyEmail) {
    const familyAlreadyCharged = checkExistingFamilyFee && 
      existingFamilyEmails.includes(familyEmail)
    
    if (!familyAlreadyCharged) {
      fees.push({
        ...baseFee,
        fee_type: 'family',
        fee_name: 'Family Registration',
        fee_category: 'per_family',
        amount: familyFee,
        description: 'One-time family registration fee per season'
      })
    }
  }
  
  return fees
}

/**
 * Generate and insert fees for a single player on approval
 */
async function generateFeesForPlayer(supabase, player, season, showToast) {
  try {
    // Check if fees already exist for this player in this season
    const { data: existingFees } = await supabase
      .from('payments')
      .select('id')
      .eq('player_id', player.id)
      .eq('season_id', season.id)
      .eq('auto_generated', true)
    
    if (existingFees && existingFees.length > 0) {
      console.log('Fees already exist for player:', player.id)
      return { success: true, skipped: true, message: 'Fees already generated' }
    }
    
    const familyEmail = player.parent_email?.toLowerCase()
    let existingFamilyEmails = []
    let siblingIndex = 0
    
    if (familyEmail) {
      // Check which family emails already have family fees for this season
      const { data: existingFamilyFees } = await supabase
        .from('payments')
        .select('family_email')
        .eq('season_id', season.id)
        .eq('fee_category', 'per_family')
      
      existingFamilyEmails = [...new Set((existingFamilyFees || []).map(f => f.family_email?.toLowerCase()))]
      
      // Count existing approved siblings in this season for sibling discount
      const { data: siblingPlayers } = await supabase
        .from('players')
        .select('id, registrations(status)')
        .eq('season_id', season.id)
        .ilike('parent_email', familyEmail)
        .neq('id', player.id)
      
      // Count siblings that are approved/rostered and have fees generated
      const approvedSiblings = (siblingPlayers || []).filter(s => 
        ['approved', 'rostered'].includes(s.registrations?.[0]?.status)
      )
      
      // Check which of those siblings already have fees
      if (approvedSiblings.length > 0) {
        const siblingIds = approvedSiblings.map(s => s.id)
        const { data: siblingsWithFees } = await supabase
          .from('payments')
          .select('player_id')
          .eq('season_id', season.id)
          .eq('auto_generated', true)
          .in('player_id', siblingIds)
        
        siblingIndex = [...new Set((siblingsWithFees || []).map(s => s.player_id))].length
      }
    }
    
    // Calculate fees with sibling index
    const fees = calculateFeesForPlayer(player, season, {
      checkExistingFamilyFee: true,
      existingFamilyEmails,
      siblingIndex
    })
    
    if (fees.length === 0) {
      return { success: true, skipped: true, message: 'No fees to generate' }
    }
    
    // Insert fees
    const { error } = await supabase.from('payments').insert(fees)
    
    if (error) throw error
    
    const totalAmount = fees.reduce((sum, f) => sum + f.amount, 0)
    const siblingNote = siblingIndex > 0 ? ` (sibling #${siblingIndex + 1})` : ''
    return { 
      success: true, 
      feesCreated: fees.length, 
      totalAmount,
      siblingIndex,
      message: `Generated ${fees.length} fees totaling $${totalAmount.toFixed(2)}${siblingNote}`
    }
  } catch (err) {
    console.error('Error generating fees:', err)
    if (showToast) showToast('Error generating fees: ' + err.message, 'error')
    return { success: false, error: err.message }
  }
}

/**
 * Retroactively generate fees for all approved players who don't have fees yet
 * Call this once after deploying the update
 */
async function generateFeesForExistingPlayers(supabase, seasonId, showToast) {
  try {
    // Get the season
    const { data: season, error: seasonError } = await supabase
      .from('seasons')
      .select('*')
      .eq('id', seasonId)
      .single()
    
    if (seasonError || !season) throw new Error('Season not found')
    
    // Get all approved/rostered players for this season who don't have auto-generated fees
    const { data: players, error: playersError } = await supabase
      .from('players')
      .select('*, registrations(*)')
      .eq('season_id', seasonId)
    
    if (playersError) throw playersError
    
    // Filter to only approved/rostered players
    const approvedPlayers = (players || []).filter(p => 
      ['approved', 'rostered'].includes(p.registrations?.[0]?.status)
    )
    
    if (approvedPlayers.length === 0) {
      return { success: true, message: 'No approved players found' }
    }
    
    // Get existing auto-generated payments
    const { data: existingPayments } = await supabase
      .from('payments')
      .select('player_id, family_email, fee_category')
      .eq('season_id', seasonId)
      .eq('auto_generated', true)
    
    const playersWithFees = new Set((existingPayments || []).map(p => p.player_id))
    const familiesWithFamilyFee = new Set(
      (existingPayments || [])
        .filter(p => p.fee_category === 'per_family')
        .map(p => p.family_email?.toLowerCase())
    )
    
    // Filter to players without fees
    const playersNeedingFees = approvedPlayers.filter(p => !playersWithFees.has(p.id))
    
    if (playersNeedingFees.length === 0) {
      return { success: true, message: 'All approved players already have fees' }
    }
    
    // Group players by family for sibling discount calculation
    const familyGroups = {}
    for (const player of playersNeedingFees) {
      const familyEmail = player.parent_email?.toLowerCase() || 'unknown'
      if (!familyGroups[familyEmail]) {
        familyGroups[familyEmail] = []
      }
      familyGroups[familyEmail].push(player)
    }
    
    // Count existing siblings with fees per family
    const familySiblingCounts = {}
    for (const payment of (existingPayments || [])) {
      const email = payment.family_email?.toLowerCase()
      if (email) {
        familySiblingCounts[email] = (familySiblingCounts[email] || 0) + 1
      }
    }
    // Deduplicate - we want unique players, not fee count
    for (const email of Object.keys(familySiblingCounts)) {
      const uniquePlayers = [...new Set((existingPayments || [])
        .filter(p => p.family_email?.toLowerCase() === email)
        .map(p => p.player_id))]
      familySiblingCounts[email] = uniquePlayers.length
    }
    
    // Generate fees for each player with proper sibling indexing
    let totalFeesCreated = 0
    let totalAmount = 0
    const allFees = []
    
    for (const familyEmail of Object.keys(familyGroups)) {
      const familyPlayers = familyGroups[familyEmail]
      let siblingIndex = familySiblingCounts[familyEmail] || 0
      
      for (const player of familyPlayers) {
        const fees = calculateFeesForPlayer(player, season, {
          checkExistingFamilyFee: true,
          existingFamilyEmails: [...familiesWithFamilyFee],
          siblingIndex
        })
        
        // Track this family as having family fee now
        if (familyEmail && fees.some(f => f.fee_category === 'per_family')) {
          familiesWithFamilyFee.add(familyEmail)
        }
        
        allFees.push(...fees)
        totalFeesCreated += fees.length
        totalAmount += fees.reduce((sum, f) => sum + f.amount, 0)
        
        // Increment sibling index for next player in this family
        siblingIndex++
      }
    }
    
    if (allFees.length > 0) {
      // Insert all fees in one batch
      const { error: insertError } = await supabase.from('payments').insert(allFees)
      if (insertError) throw insertError
    }
    
    const message = `Generated ${totalFeesCreated} fees for ${playersNeedingFees.length} players totaling $${totalAmount.toFixed(2)}`
    if (showToast) showToast(message, 'success')
    
    return { 
      success: true, 
      playersProcessed: playersNeedingFees.length,
      feesCreated: totalFeesCreated, 
      totalAmount,
      message 
    }
  } catch (err) {
    console.error('Error generating fees for existing players:', err)
    if (showToast) showToast('Error: ' + err.message, 'error')
    return { success: false, error: err.message }
  }
}

/**
 * Generate email content for various notification types
 */
function generateEmailContent(type, data) {
  const { player, season, organization, fees, totalDue } = data
  
  switch (type) {
    case 'registration_confirmation':
      return {
        subject: `Registration Confirmed - ${season?.name || 'Season'}`,
        body: `Hi ${player?.parent_name || 'Parent'},

Great news! ${player?.first_name}'s registration for ${organization?.name || 'our organization'} ${season?.name || ''} has been approved!

Player: ${player?.first_name} ${player?.last_name}
Season: ${season?.name}
${season?.start_date ? `Start Date: ${new Date(season.start_date).toLocaleDateString()}` : ''}

${totalDue > 0 ? `
PAYMENT DUE: $${totalDue.toFixed(2)}

Fee Breakdown:
${fees?.map(f => `‚Ä¢ ${f.fee_name}: $${f.amount.toFixed(2)}`).join('\n') || 'See admin for details'}

Payment Methods:
${organization?.payment_venmo ? `‚Ä¢ Venmo: ${organization.payment_venmo}` : ''}
${organization?.payment_zelle ? `‚Ä¢ Zelle: ${organization.payment_zelle}` : ''}
${organization?.payment_cashapp ? `‚Ä¢ Cash App: ${organization.payment_cashapp}` : ''}

Please include "${player?.first_name} ${player?.last_name} - ${season?.name}" in your payment note.
` : 'No payment due at this time.'}

Questions? Reply to this email.

See you on the court!
${organization?.name || 'The Team'}`
      }
    
    case 'payment_reminder':
      return {
        subject: `Payment Reminder - ${season?.name || 'Season'} - $${totalDue?.toFixed(2) || '0'} Due`,
        body: `Hi ${player?.parent_name || 'Parent'},

This is a friendly reminder that you have an outstanding balance for ${player?.first_name}'s registration.

AMOUNT DUE: $${totalDue?.toFixed(2) || '0'}

Outstanding Fees:
${fees?.filter(f => !f.paid).map(f => `‚Ä¢ ${f.fee_name}: $${f.amount.toFixed(2)}`).join('\n') || 'See admin for details'}

Payment Methods:
${organization?.payment_venmo ? `‚Ä¢ Venmo: ${organization.payment_venmo}` : ''}
${organization?.payment_zelle ? `‚Ä¢ Zelle: ${organization.payment_zelle}` : ''}
${organization?.payment_cashapp ? `‚Ä¢ Cash App: ${organization.payment_cashapp}` : ''}

Please include "${player?.first_name} ${player?.last_name} - ${season?.name}" in your payment note.

Questions? Reply to this email.

Thank you!
${organization?.name || 'The Team'}`
      }
    
    case 'waitlist_notification':
      return {
        subject: `You're on the Waitlist - ${season?.name || 'Season'}`,
        body: `Hi ${player?.parent_name || 'Parent'},

Thank you for registering ${player?.first_name} for ${organization?.name || 'our organization'} ${season?.name || ''}.

You are currently on the waitlist. We'll notify you as soon as a spot becomes available.

Waitlist Position: ${data.waitlistPosition || 'TBD'}

If you have any questions, please reply to this email.

Thank you for your patience!
${organization?.name || 'The Team'}`
      }
    
    default:
      return { subject: '', body: '' }
  }
}

// ============================================
// TOAST NOTIFICATION
// ============================================
function Toast({ message, type = 'success', onClose }) {
  useEffect(() => {
    const timer = setTimeout(onClose, 3000)
    return () => clearTimeout(timer)
  }, [onClose])

  return (
    <div className={`fixed bottom-4 right-4 px-6 py-3 rounded-xl shadow-lg z-50 flex items-center gap-3 ${
      type === 'success' ? 'bg-emerald-500 text-white' :
      type === 'error' ? 'bg-red-500 text-white' :
      'bg-yellow-500 text-black'
    }`}>
      <span>{type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : '‚Ñπ'}</span>
      <span>{message}</span>
      <button onClick={onClose} className="ml-2 opacity-70 hover:opacity-100">√ó</button>
    </div>
  )
}

// ============================================
// BLAST ALERT POPUP - Full screen overlay requiring acknowledgment
// ============================================
function BlastAlertPopup({ blast, onAcknowledge, remainingCount }) {
  const tc = useThemeClasses()
  const { isDark } = useTheme()
  
  const getTypeIcon = (type) => {
    switch(type) {
      case 'payment_reminder': return <DollarSign className="w-8 h-8" />
      case 'schedule_change': return <Calendar className="w-8 h-8" />
      case 'deadline': return <Clock className="w-8 h-8" />
      default: return <Megaphone className="w-8 h-8" />
    }
  }
  
  const getTypeColor = (type, priority) => {
    if (priority === 'urgent') return 'from-red-600 to-red-800'
    switch(type) {
      case 'payment_reminder': return 'from-emerald-600 to-emerald-800'
      case 'schedule_change': return 'from-blue-600 to-blue-800'
      case 'deadline': return 'from-amber-600 to-amber-800'
      default: return 'from-purple-600 to-purple-800'
    }
  }

  return (
    <div className="fixed inset-0 bg-black/90 flex items-center justify-center z-[100] p-4">
      <div className={`${tc.cardBg} rounded-3xl w-full max-w-lg overflow-hidden shadow-2xl animate-bounce-in`}>
        {/* Header with gradient */}
        <div className={`bg-gradient-to-r ${getTypeColor(blast.message_type, blast.priority)} p-6 text-center`}>
          <div className="text-6xl mb-3">
            {blast.priority === 'urgent' ? 'üö®' : getTypeIcon(blast.message_type)}
          </div>
          {blast.priority === 'urgent' && (
            <span className="inline-block px-4 py-1 rounded-full bg-white/20 text-white text-sm font-bold mb-3 animate-pulse">
              URGENT
            </span>
          )}
          <h2 className="text-2xl font-bold text-white">{blast.title}</h2>
          <p className="text-white/70 text-sm mt-2">
            From {blast.profiles?.full_name || 'League Admin'} ‚Ä¢ {new Date(blast.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' })}
          </p>
        </div>
        
        {/* Body */}
        <div className="p-6">
          <p className={`${tc.text} text-lg leading-relaxed whitespace-pre-wrap`}>
            {blast.body}
          </p>
        </div>
        
        {/* Footer */}
        <div className={`p-6 border-t ${tc.border} space-y-3`}>
          <button
            onClick={onAcknowledge}
            className="w-full py-4 rounded-xl bg-[var(--accent-primary)] text-white font-bold text-lg hover:brightness-110 transition"
          >
            ‚úì I've Read This
          </button>
          
          {remainingCount > 1 && (
            <p className={`text-center text-sm ${tc.textMuted}`}>
              {remainingCount - 1} more announcement{remainingCount > 2 ? 's' : ''} to read
            </p>
          )}
        </div>
      </div>
      
      {/* Animation styles */}
      <style>{`
        @keyframes bounce-in {
          0% { transform: scale(0.9); opacity: 0; }
          50% { transform: scale(1.02); }
          100% { transform: scale(1); opacity: 1; }
        }
        .animate-bounce-in {
          animation: bounce-in 0.3s ease-out forwards;
        }
      `}</style>
    </div>
  )
}

// ============================================
// BLAST ALERT CHECKER - Self-contained component for checking unread blasts
// ============================================
function BlastAlertChecker() {
  const { user } = useAuth()
  const { selectedSeason } = useSeason()
  const [pendingBlasts, setPendingBlasts] = useState([])
  const [currentBlastAlert, setCurrentBlastAlert] = useState(null)
  
  // Check for unacknowledged blasts
  useEffect(() => {
    if (user?.id && selectedSeason?.id) {
      checkForPendingBlasts()
    }
  }, [user?.id, selectedSeason?.id])
  
  async function checkForPendingBlasts() {
    try {
      // Get unacknowledged blasts for this user
      const { data: unacknowledged } = await supabase
        .from('message_recipients')
        .select(`
          id,
          message_id,
          acknowledged,
          profile_id,
          messages (
            id, title, body, message_type, priority, created_at,
            profiles:sender_id (full_name)
          )
        `)
        .eq('profile_id', user.id)
        .eq('acknowledged', false)
      
      // Filter to messages that exist
      const pending = (unacknowledged || [])
        .filter(r => r.messages)
        .map(r => ({ ...r.messages, recipient_id: r.id }))
      
      setPendingBlasts(pending)
      
      // Show first unacknowledged blast
      if (pending.length > 0) {
        setCurrentBlastAlert(pending[0])
      }
    } catch (err) {
      console.error('Error checking for blasts:', err)
    }
  }
  
  async function acknowledgeBlast(recipientId) {
    await supabase
      .from('message_recipients')
      .update({ acknowledged: true, acknowledged_at: new Date().toISOString() })
      .eq('id', recipientId)
    
    // Update pending blasts
    const remaining = pendingBlasts.filter(b => b.recipient_id !== recipientId)
    setPendingBlasts(remaining)
    
    // Show next blast or close
    if (remaining.length > 0) {
      setCurrentBlastAlert(remaining[0])
    } else {
      setCurrentBlastAlert(null)
    }
  }
  
  if (!currentBlastAlert) return null
  
  return (
    <BlastAlertPopup
      blast={currentBlastAlert}
      onAcknowledge={() => acknowledgeBlast(currentBlastAlert.recipient_id)}
      remainingCount={pendingBlasts.length}
    />
  )
}

// ============================================
// CLICKABLE NAME COMPONENTS
// ============================================

// Clickable Player Name - opens PlayerCardExpanded when clicked
function ClickablePlayerName({ player, className = '', children, onPlayerSelect }) {
  const { isDark } = useTheme()
  
  if (!player) return <span className={className}>{children || 'Unknown'}</span>
  
  const displayName = children || `${player.first_name || ''} ${player.last_name || ''}`.trim() || 'Unknown'
  
  return (
    <button
      onClick={(e) => {
        e.stopPropagation()
        onPlayerSelect?.(player)
      }}
      className={`${className} hover:text-[var(--accent-primary)] hover:underline cursor-pointer transition-colors text-left`}
    >
      {displayName}
    </button>
  )
}

// Clickable Coach Name - opens coach details when clicked
function ClickableCoachName({ coach, className = '', children, onCoachSelect }) {
  if (!coach) return <span className={className}>{children || 'Unknown'}</span>
  
  const displayName = children || `${coach.first_name || ''} ${coach.last_name || ''}`.trim() || 'Unknown'
  
  return (
    <button
      onClick={(e) => {
        e.stopPropagation()
        onCoachSelect?.(coach)
      }}
      className={`${className} hover:text-blue-400 hover:underline cursor-pointer transition-colors text-left`}
    >
      {displayName}
    </button>
  )
}

// Clickable Team Name - navigates to team or opens team details
function ClickableTeamName({ team, className = '', children, onTeamSelect, color }) {
  if (!team) return <span className={className}>{children || 'Unknown'}</span>
  
  const displayName = children || team.name || 'Unknown'
  const teamColor = color || team.color || '#EAB308'
  
  return (
    <button
      onClick={(e) => {
        e.stopPropagation()
        onTeamSelect?.(team)
      }}
      className={`${className} hover:underline cursor-pointer transition-colors text-left`}
      style={{ color: teamColor }}
    >
      {displayName}
    </button>
  )
}

// Coach Detail Modal
function CoachDetailModal({ coach, onClose }) {
  const tc = useThemeClasses()
  
  if (!coach) return null
  
  return (
    <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50" onClick={onClose}>
      <div 
        className={`${tc.cardBg} border ${tc.border} rounded-2xl w-full max-w-md overflow-hidden`}
        onClick={e => e.stopPropagation()}
      >
        {/* Header */}
        <div className="p-6 border-b border-blue-500/30 bg-blue-500/10">
          <div className="flex items-center gap-4">
            {coach.photo_url ? (
              <img src={coach.photo_url} alt="" className="w-20 h-20 rounded-full object-cover border-2 border-blue-500" />
            ) : (
              <div className="w-20 h-20 rounded-full bg-blue-500/20 flex items-center justify-center text-3xl border-2 border-blue-500/50">
                Coach
              </div>
            )}
            <div>
              <h2 className={`text-xl font-bold ${tc.text}`}>{coach.first_name} {coach.last_name}</h2>
              <p className="text-blue-400 text-sm">{coach.role || 'Coach'}</p>
            </div>
          </div>
        </div>

        {/* Content */}
        <div className="p-6 space-y-4">
          {coach.email && (
            <div className="flex items-center justify-between">
              <span className={tc.textSecondary}>Email</span>
              <a href={`mailto:${coach.email}`} className="text-[var(--accent-primary)] hover:underline">{coach.email}</a>
            </div>
          )}
          {coach.phone && (
            <div className="flex items-center justify-between">
              <span className={tc.textSecondary}><Phone className="w-4 h-4 inline mr-1" />Phone</span>
              <a href={`tel:${coach.phone}`} className="text-[var(--accent-primary)] hover:underline">{coach.phone}</a>
            </div>
          )}
          {coach.certification && (
            <div className="flex items-center justify-between">
              <span className={tc.textSecondary}>üìú Certification</span>
              <span className={tc.text}>{coach.certification}</span>
            </div>
          )}
          {coach.experience_years && (
            <div className="flex items-center justify-between">
              <span className={tc.textSecondary}>‚è±Ô∏è Experience</span>
              <span className={tc.text}>{coach.experience_years} years</span>
            </div>
          )}
          {coach.bio && (
            <div>
              <p className={`${tc.textSecondary} mb-2`}>üìù Bio</p>
              <p className={`${tc.text} text-sm`}>{coach.bio}</p>
            </div>
          )}
        </div>

        {/* Footer */}
        <div className={`p-4 border-t ${tc.border} flex justify-end`}>
          <button
            onClick={onClose}
            className={`px-6 py-2 rounded-xl ${tc.cardBgAlt} ${tc.text} ${tc.hoverBgAlt}`}
          >
            Close
          </button>
        </div>
      </div>
    </div>
  )
}

// ============================================
// PLAYER CARD SYSTEM
// ============================================
const positionColors = {
  'OH': '#FF6B6B', 'S': '#4ECDC4', 'MB': '#45B7D1', 'OPP': '#96CEB4',
  'L': '#FFEAA7', 'DS': '#DDA0DD', 'RS': '#FF9F43'
}

const positionNames = {
  'OH': 'Outside Hitter', 'S': 'Setter', 'MB': 'Middle Blocker',
  'OPP': 'Opposite', 'L': 'Libero', 'DS': 'Defensive Specialist', 'RS': 'Right Side'
}

// Context-aware PlayerCard component
function PlayerCard({ player, context = 'roster', teamColor, onClick, showPhoto = true, size = 'medium' }) {
  const posColor = player.position ? positionColors[player.position] || '#EAB308' : '#EAB308'
  const cardColor = teamColor || posColor

  // Context-specific data
  const getContextInfo = () => {
    switch (context) {
      case 'registration':
        return [
          { label: 'Status', value: player.registration_status || player.status, color: getStatusColor(player.registration_status || player.status) },
          { label: 'Waiver', value: player.waiver_signed ? '‚úì Signed' : '‚ö†Ô∏è Pending', color: player.waiver_signed ? '#4ECDC4' : '#FF6B6B' },
          { label: 'Jersey', value: player.jersey_number ? `#${player.jersey_number}` : 'Not Set' }
        ]
      case 'payment':
        return [
          { label: 'Balance', value: player.balance ? `$${player.balance}` : '$0', color: player.balance > 0 ? '#FF6B6B' : '#4ECDC4' },
          { label: 'Last Paid', value: player.last_paid_date || 'Never' },
          { label: 'Plan', value: player.payment_plan || 'N/A' }
        ]
      case 'attendance':
        return [
          { label: 'RSVP', value: player.rsvp_status || 'Pending', color: player.rsvp_status === 'yes' ? '#4ECDC4' : player.rsvp_status === 'no' ? '#FF6B6B' : '#FFB347' },
          { label: 'Rate', value: player.attendance_rate ? `${player.attendance_rate}%` : 'N/A' },
          { label: 'Last', value: player.last_attendance || 'N/A' }
        ]
      case 'jersey':
        return [
          { label: 'Number', value: player.jersey_number ? `#${player.jersey_number}` : 'None', color: cardColor },
          { label: 'Size', value: player.uniform_size_jersey || 'N/A' },
          { label: 'Prefs', value: [player.jersey_pref_1, player.jersey_pref_2, player.jersey_pref_3].filter(Boolean).join(', ') || 'None' }
        ]
      default: // roster
        return [
          { label: 'POS', value: player.position || '‚Äî', color: posColor },
          { label: 'GRD', value: player.grade || '‚Äî' },
          { label: 'JRS', value: player.jersey_number ? `#${player.jersey_number}` : '‚Äî', color: cardColor }
        ]
    }
  }

  const getStatusColor = (status) => {
    const colors = {
      'new': '#FFB347', 'pending': '#FFB347', 'submitted': '#FFB347',
      'approved': '#4ECDC4', 'rostered': '#4ECDC4', 'active': '#4ECDC4', 'assigned': '#4ECDC4',
      'denied': '#FF6B6B', 'withdrawn': '#FF6B6B', 'inactive': '#FF6B6B'
    }
    return colors[status?.toLowerCase()] || '#6B7280'
  }

  const contextInfo = getContextInfo()
  const sizeClasses = {
    small: 'w-32 h-40',
    medium: 'w-40 h-48',
    large: 'w-48 h-56'
  }

  return (
    <div
      onClick={onClick}
      className={`relative rounded-xl overflow-hidden cursor-pointer transition-all hover:scale-[1.02] hover:shadow-xl ${sizeClasses[size]}`}
      style={{ background: `linear-gradient(135deg, ${cardColor}30 0%, #0a0a0a 100%)` }}
    >
      {/* Position badge */}
      {player.position && (
        <div className="absolute top-2 left-2 px-2 py-0.5 rounded text-xs font-bold" style={{ backgroundColor: posColor, color: '#000' }}>
          {player.position}
        </div>
      )}

      {/* Jersey number */}
      {player.jersey_number && (
        <div className="absolute top-2 right-2 text-2xl font-black" style={{ color: cardColor, textShadow: '1px 1px 2px rgba(0,0,0,0.5)' }}>
          {player.jersey_number}
        </div>
      )}

      {/* Photo/Silhouette */}
      <div className="flex justify-center pt-8 pb-2">
        {showPhoto && player.photo_url ? (
          <img src={player.photo_url} alt="" className="w-16 h-16 rounded-full border-2 object-cover" style={{ borderColor: posColor + '60' }} />
        ) : (
          <div className="w-16 h-16 rounded-full bg-[#1a1a2e] border-2 flex items-center justify-center" style={{ borderColor: cardColor + '40' }}>
            <span className="flex items-center justify-center"><User className="w-6 h-6 text-slate-600" /></span>
          </div>
        )}
      </div>

      {/* Name bar */}
      <div className="absolute bottom-0 left-0 right-0 bg-black/80 px-3 py-2">
        <div className="text-white font-bold text-sm truncate">{player.first_name} {player.last_name?.charAt(0)}.</div>
        
        {/* Context info row */}
        <div className="flex justify-between mt-1">
          {contextInfo.map((info, i) => (
            <div key={i} className="text-center">
              <div className="text-[10px] text-slate-500">{info.label}</div>
              <div className="text-xs font-semibold" style={{ color: info.color || '#fff' }}>{info.value}</div>
            </div>
          ))}
        </div>
      </div>

      {/* Bottom accent */}
      <div className="absolute bottom-0 left-0 right-0 h-1" style={{ backgroundColor: posColor }} />
    </div>
  )
}

// Expanded Player Card Modal
function PlayerCardExpanded({ player, visible, onClose, onNavigate, context = 'roster' }) {
  const [activeTab, setActiveTab] = useState('overview')
  const [loading, setLoading] = useState(false)
  const [playerData, setPlayerData] = useState(null)
  const [registrations, setRegistrations] = useState([])
  const [payments, setPayments] = useState([])
  const [teamAssignments, setTeamAssignments] = useState([])

  useEffect(() => {
    if (visible && player?.id) {
      loadPlayerData()
    }
  }, [visible, player?.id])

  async function loadPlayerData() {
    setLoading(true)
    try {
      // Load full player data
      const { data: fullPlayer } = await supabase
        .from('players')
        .select('*')
        .eq('id', player.id)
        .single()
      setPlayerData(fullPlayer)

      // Load registrations
      const { data: regs } = await supabase
        .from('registrations')
        .select('*, seasons(name)')
        .eq('player_id', player.id)
        .order('created_at', { ascending: false })
      setRegistrations(regs || [])

      // Load payments
      const { data: pays } = await supabase
        .from('payments')
        .select('*')
        .eq('player_id', player.id)
        .order('created_at', { ascending: false })
      setPayments(pays || [])

      // Load team assignments
      const { data: teams } = await supabase
        .from('team_players')
        .select('*, teams(id, name, color, seasons(name))')
        .eq('player_id', player.id)
      setTeamAssignments(teams || [])

    } catch (err) {
      console.error('Error loading player data:', err)
    }
    setLoading(false)
  }

  if (!visible || !player) return null

  const p = playerData || player
  const posColor = p.position ? positionColors[p.position] || '#EAB308' : '#EAB308'

  const tabs = [
    { id: 'overview', label: 'Overview', icon: 'user' },
    { id: 'registration', label: 'Registration', icon: 'clipboard' },
    { id: 'payments', label: 'Payments', icon: 'dollar' },
    { id: 'contact', label: 'Contact', icon: 'üìû' },
    { id: 'medical', label: 'Medical', icon: 'üè•' },
  ]

  // Calculate payment stats
  const totalPaid = payments.filter(p => p.paid).reduce((sum, p) => sum + (p.amount || 0), 0)
  const totalOwed = payments.filter(p => !p.paid).reduce((sum, p) => sum + (p.amount || 0), 0)

  return (
    <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
      <div className="bg-slate-800 border border-slate-700 rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
        {/* Header */}
        <div className="relative p-6 text-center" style={{ background: `linear-gradient(180deg, ${posColor}30 0%, #141414 100%)` }}>
          <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-white text-2xl">√ó</button>
          
          {/* Photo */}
          <div className="flex justify-center mb-4">
            {p.photo_url ? (
              <img src={p.photo_url} alt="" className="w-24 h-24 rounded-full border-4 object-cover" style={{ borderColor: posColor + '60' }} />
            ) : (
              <div className="w-24 h-24 rounded-full bg-[#1a1a2e] border-4 flex items-center justify-center" style={{ borderColor: posColor + '40' }}>
                <span className="flex items-center justify-center"><User className="w-10 h-10 text-slate-600" /></span>
              </div>
            )}
          </div>

          {/* Name & Jersey */}
          {p.jersey_number && <div className="text-slate-400 text-sm">#{p.jersey_number}</div>}
          <h2 className="text-2xl font-bold text-white">{p.first_name} {p.last_name}</h2>
          
          {/* Position & Team */}
          <div className="flex items-center justify-center gap-3 mt-2">
            {p.position && (
              <span className="px-3 py-1 rounded-full text-sm font-semibold" style={{ backgroundColor: posColor, color: '#000' }}>
                {positionNames[p.position] || p.position}
              </span>
            )}
            {teamAssignments[0]?.teams?.name && (
              <span className="text-slate-400">{teamAssignments[0].teams.name}</span>
            )}
          </div>

          {/* Quick stats */}
          <div className="flex justify-center gap-6 mt-4">
            <div className="text-center">
              <div className="text-lg font-bold text-white">{p.grade || '‚Äî'}</div>
              <div className="text-xs text-slate-500">Grade</div>
            </div>
            <div className="text-center">
              <div className="text-lg font-bold" style={{ color: posColor }}>{p.position || '‚Äî'}</div>
              <div className="text-xs text-slate-500">Position</div>
            </div>
            <div className="text-center">
              <div className="text-lg font-bold text-white">{teamAssignments.length}</div>
              <div className="text-xs text-slate-500">Teams</div>
            </div>
            <div className="text-center">
              <div className="text-lg font-bold" style={{ color: totalOwed > 0 ? '#FF6B6B' : '#4ECDC4' }}>
                ${totalOwed > 0 ? totalOwed : totalPaid}
              </div>
              <div className="text-xs text-slate-500">{totalOwed > 0 ? 'Owed' : 'Paid'}</div>
            </div>
          </div>
        </div>

        {/* Tabs */}
        <div className="flex border-b border-slate-700">
          {tabs.map(tab => (
            <button
              key={tab.id}
              onClick={() => setActiveTab(tab.id)}
              className={`flex-1 py-3 text-sm font-medium transition ${
                activeTab === tab.id ? 'text-[var(--accent-primary)] border-b-2 border-[var(--accent-primary)]' : 'text-slate-500 hover:text-gray-300'
              }`}
            >
              <span className="mr-1">{tab.icon}</span> {tab.label}
            </button>
          ))}
        </div>

        {/* Tab Content */}
        <div className="flex-1 overflow-y-auto p-6">
          {loading ? (
            <div className="text-center py-8 text-slate-400">Loading...</div>
          ) : (
            <>
              {/* Overview Tab */}
              {activeTab === 'overview' && (
                <div className="space-y-4">
                  <div className="grid grid-cols-2 gap-4">
                    <InfoBox label="School" value={p.school} />
                    <InfoBox label="Experience" value={p.experience_level || p.experience} />
                    <InfoBox label="Jersey Size" value={p.uniform_size_jersey} />
                    <InfoBox label="Shorts Size" value={p.uniform_size_shorts} />
                    <InfoBox label="Jersey Prefs" value={[p.jersey_pref_1, p.jersey_pref_2, p.jersey_pref_3].filter(Boolean).join(', ')} />
                    <InfoBox label="Status" value={p.status} />
                  </div>

                  {/* Quick Actions */}
                  <div className="mt-6">
                    <h4 className="text-sm font-semibold text-slate-400 uppercase mb-3">Quick Actions</h4>
                    <div className="flex flex-wrap gap-2">
                      <ActionButton label="View Registrations" icon="clipboard" onClick={() => setActiveTab('registration')} />
                      <ActionButton label="View Payments" icon="dollar" onClick={() => setActiveTab('payments')} />
                      {onNavigate && <ActionButton label="Go to Team" icon="users" onClick={() => { onClose(); onNavigate('teams'); }} />}
                      {onNavigate && <ActionButton label="Edit Jersey" icon="shirt" onClick={() => { onClose(); onNavigate('jerseys'); }} />}
                    </div>
                  </div>

                  {/* Team Assignments */}
                  {teamAssignments.length > 0 && (
                    <div className="mt-6">
                      <h4 className="text-sm font-semibold text-slate-400 uppercase mb-3">Team Assignments</h4>
                      {teamAssignments.map(ta => (
                        <div key={ta.id} className="bg-slate-900 rounded-lg p-3 mb-2 flex items-center justify-between">
                          <div className="flex items-center gap-3">
                            <div className="w-3 h-3 rounded-full" style={{ backgroundColor: ta.teams?.color || '#EAB308' }} />
                            <span className="text-white">{ta.teams?.name}</span>
                          </div>
                          <span className="text-slate-500 text-sm">{ta.teams?.seasons?.name}</span>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              )}

              {/* Registration Tab */}
              {activeTab === 'registration' && (
                <div className="space-y-4">
                  {/* Waiver Status */}
                  <div className="bg-slate-900 rounded-xl p-4">
                    <h4 className="text-sm font-semibold text-slate-400 uppercase mb-3">Waiver Status</h4>
                    <div className="grid grid-cols-3 gap-4">
                      <PlayerWaiverBadge label="Liability" signed={p.waiver_liability} />
                      <PlayerWaiverBadge label="Photo Release" signed={p.waiver_photo} />
                      <PlayerWaiverBadge label="Code of Conduct" signed={p.waiver_conduct} />
                    </div>
                    {p.waiver_signed_by && (
                      <div className="mt-3 text-sm text-slate-500">
                        Signed by: {p.waiver_signed_by} on {p.waiver_signed_date ? new Date(p.waiver_signed_date).toLocaleDateString() : 'N/A'}
                      </div>
                    )}
                  </div>

                  {/* Registration History */}
                  <div>
                    <h4 className="text-sm font-semibold text-slate-400 uppercase mb-3">Registration History</h4>
                    {registrations.length === 0 ? (
                      <p className="text-slate-500 text-sm">No registrations found</p>
                    ) : (
                      registrations.map(reg => (
                        <div key={reg.id} className="bg-slate-900 rounded-lg p-3 mb-2 flex items-center justify-between">
                          <div>
                            <span className="text-white">{reg.seasons?.name || 'Unknown Season'}</span>
                            <span className={`ml-2 px-2 py-0.5 rounded text-xs font-medium ${
                              reg.status === 'rostered' ? 'bg-emerald-500/20 text-emerald-400' :
                              reg.status === 'approved' ? 'bg-blue-500/20 text-blue-400' :
                              reg.status === 'pending' ? 'bg-[var(--accent-primary)]/20 text-[var(--accent-primary)]' :
                              'bg-gray-500/20 text-slate-400'
                            }`}>
                              {reg.status}
                            </span>
                          </div>
                          <span className="text-slate-500 text-sm">
                            {reg.submitted_at ? new Date(reg.submitted_at).toLocaleDateString() : ''}
                          </span>
                        </div>
                      ))
                    )}
                  </div>
                </div>
              )}

              {/* Payments Tab */}
              {activeTab === 'payments' && (
                <div className="space-y-4">
                  {/* Summary */}
                  <div className="grid grid-cols-3 gap-4">
                    <div className="bg-emerald-500/10 border border-emerald-500/30 rounded-xl p-4 text-center">
                      <div className="text-2xl font-bold text-emerald-400">${totalPaid}</div>
                      <div className="text-xs text-emerald-400">Total Paid</div>
                    </div>
                    <div className="bg-red-500/10 border border-red-500/30 rounded-xl p-4 text-center">
                      <div className="text-2xl font-bold text-red-400">${totalOwed}</div>
                      <div className="text-xs text-red-400">Outstanding</div>
                    </div>
                    <div className="bg-slate-900 rounded-xl p-4 text-center">
                      <div className="text-2xl font-bold text-white">{payments.length}</div>
                      <div className="text-xs text-slate-400">Transactions</div>
                    </div>
                  </div>

                  {/* Payment History */}
                  <div>
                    <h4 className="text-sm font-semibold text-slate-400 uppercase mb-3">Payment History</h4>
                    {payments.length === 0 ? (
                      <p className="text-slate-500 text-sm">No payments found</p>
                    ) : (
                      payments.map(pay => (
                        <div key={pay.id} className="bg-slate-900 rounded-lg p-3 mb-2 flex items-center justify-between">
                          <div>
                            <span className="text-white">{pay.fee_name || pay.fee_type}</span>
                            <span className={`ml-2 px-2 py-0.5 rounded text-xs font-medium ${
                              pay.paid ? 'bg-emerald-500/20 text-emerald-400' : 'bg-red-500/20 text-red-400'
                            }`}>
                              {pay.paid ? 'Paid' : 'Unpaid'}
                            </span>
                          </div>
                          <div className="text-right">
                            <div className="text-white font-semibold">${pay.amount}</div>
                            <div className="text-slate-500 text-xs">{pay.paid_date || 'Pending'}</div>
                          </div>
                        </div>
                      ))
                    )}
                  </div>
                </div>
              )}

              {/* Contact Tab */}
              {activeTab === 'contact' && (
                <div className="space-y-4">
                  {/* Primary Parent */}
                  <div className="bg-slate-900 rounded-xl p-4">
                    <h4 className="text-sm font-semibold text-slate-400 uppercase mb-3">Primary Contact</h4>
                    <div className="space-y-2">
                      <ContactRow icon="user" label="Name" value={p.parent_name} />
                      <ContactRow icon="mail" label="Email" value={p.parent_email} link={`mailto:${p.parent_email}`} />
                      <ContactRow icon="phone" label="Phone" value={p.parent_phone} link={`tel:${p.parent_phone}`} />
                    </div>
                  </div>

                  {/* Secondary Parent */}
                  {p.parent_2_name && (
                    <div className="bg-slate-900 rounded-xl p-4">
                      <h4 className="text-sm font-semibold text-slate-400 uppercase mb-3">Secondary Contact</h4>
                      <div className="space-y-2">
                        <ContactRow icon="user" label="Name" value={p.parent_2_name} />
                        <ContactRow icon="mail" label="Email" value={p.parent_2_email} link={`mailto:${p.parent_2_email}`} />
                        <ContactRow icon="phone" label="Phone" value={p.parent_2_phone} link={`tel:${p.parent_2_phone}`} />
                      </div>
                    </div>
                  )}

                  {/* Emergency Contact */}
                  <div className="bg-red-500/10 border border-red-500/30 rounded-xl p-4">
                    <h4 className="text-sm font-semibold text-red-400 uppercase mb-3">üö® Emergency Contact</h4>
                    <div className="space-y-2">
                      <ContactRow icon="user" label="Name" value={p.emergency_contact_name || p.emergency_name} />
                      <ContactRow icon="phone" label="Phone" value={p.emergency_contact_phone || p.emergency_phone} link={`tel:${p.emergency_contact_phone || p.emergency_phone}`} />
                      <ContactRow icon="link" label="Relation" value={p.emergency_contact_relation || p.emergency_relation} />
                    </div>
                  </div>

                  {/* Address */}
                  {p.address && (
                    <div className="bg-slate-900 rounded-xl p-4">
                      <h4 className="text-sm font-semibold text-slate-400 uppercase mb-3">Address</h4>
                      <p className="text-white">{p.address}</p>
                    </div>
                  )}
                </div>
              )}

              {/* Medical Tab */}
              {activeTab === 'medical' && (
                <div className="space-y-4">
                  <div className="bg-red-500/10 border border-red-500/30 rounded-xl p-4">
                    <h4 className="text-sm font-semibold text-red-400 uppercase mb-3">‚ö†Ô∏è Medical Information</h4>
                    <div className="space-y-4">
                      <div>
                        <label className="text-xs text-slate-500">Medical Conditions</label>
                        <p className="text-white">{p.medical_conditions || p.medical_notes || 'None reported'}</p>
                      </div>
                      <div>
                        <label className="text-xs text-slate-500">Allergies</label>
                        <p className="text-white">{p.allergies || 'None reported'}</p>
                      </div>
                      <div>
                        <label className="text-xs text-slate-500">Medications</label>
                        <p className="text-white">{p.medications || 'None reported'}</p>
                      </div>
                    </div>
                  </div>

                  {/* Documents */}
                  <div className="bg-slate-900 rounded-xl p-4">
                    <h4 className="text-sm font-semibold text-slate-400 uppercase mb-3">Documents</h4>
                    <div className="space-y-2">
                      <DocumentRow label="Birth Certificate" url={p.birth_certificate_url} />
                      <DocumentRow label="Medical Form" url={p.medical_form_url} />
                    </div>
                  </div>
                </div>
              )}
            </>
          )}
        </div>
      </div>
    </div>
  )
}

// Helper components for PlayerCardExpanded
function InfoBox({ label, value }) {
  return (
    <div className="bg-slate-900 rounded-lg p-3">
      <div className="text-xs text-slate-500">{label}</div>
      <div className="text-white font-medium">{value || '‚Äî'}</div>
    </div>
  )
}

// Icon mapping for action buttons and contact rows
const getIconComponent = (iconName, size = "w-4 h-4") => {
  const iconMap = {
    user: User,
    users: Users,
    clipboard: ClipboardList,
    dollar: DollarSign,
    shirt: Shirt,
    mail: Mail,
    phone: Phone,
    smartphone: Phone,
    map: MapPin,
    home: Home,
    calendar: Calendar,
    message: MessageCircle,
    'alert-triangle': AlertTriangle,
    check: Check,
    x: X,
    edit: Edit,
    trash: Trash2,
    plus: Plus,
    eye: Eye,
    download: Download,
    upload: Upload,
    settings: Settings,
    'bar-chart': BarChart3,
    target: Target,
    bell: Bell,
    lock: Lock,
    unlock: Unlock,
    globe: Globe,
    clipboard: ClipboardList,
    'credit-card': CreditCard,
  }
  const IconComp = iconMap[iconName]
  return IconComp ? <IconComp className={size} /> : <span>{iconName}</span>
}

function ActionButton({ label, icon, onClick }) {
  return (
    <button onClick={onClick} className="px-3 py-2 bg-slate-900 rounded-lg text-sm text-gray-300 hover:bg-slate-700 hover:text-white transition flex items-center gap-2">
      {getIconComponent(icon, "w-4 h-4")} {label}
    </button>
  )
}

function PlayerWaiverBadge({ label, signed }) {
  return (
    <div className={`rounded-lg p-2 text-center ${signed ? 'bg-emerald-500/10' : 'bg-red-500/10'}`}>
      <div className={`flex items-center justify-center ${signed ? 'text-emerald-400' : 'text-red-400'}`}>
        {signed ? <Check className="w-5 h-5" /> : <X className="w-5 h-5" />}
      </div>
      <div className="text-xs text-slate-400">{label}</div>
    </div>
  )
}

function ContactRow({ icon, label, value, link }) {
  const content = (
    <div className="flex items-center justify-between py-1">
      <span className="text-slate-500 text-sm flex items-center gap-2">{getIconComponent(icon, "w-4 h-4")} {label}</span>
      <span className={`text-white ${link ? 'hover:text-[var(--accent-primary)]' : ''}`}>{value || '‚Äî'}</span>
    </div>
  )
  return link && value ? <a href={link}>{content}</a> : content
}

function DocumentRow({ label, url }) {
  return (
    <div className="flex items-center justify-between py-1">
      <span className="text-slate-400">{label}</span>
      {url ? (
        <a href={url} target="_blank" rel="noopener noreferrer" className="text-[var(--accent-primary)] hover:underline text-sm">View ‚Üí</a>
      ) : (
        <span className="text-slate-600 text-sm">Not uploaded</span>
      )}
    </div>
  )
}

// ============================================
// LOGIN PAGE
// ============================================
function LoginPage() {
  const { signIn, signUp } = useAuth()
  const tc = useThemeClasses()
  const { accent } = useTheme()
  const [mode, setMode] = useState('login') // 'login' or 'signup'
  const [email, setEmail] = useState('')
  const [password, setPassword] = useState('')
  const [firstName, setFirstName] = useState('')
  const [lastName, setLastName] = useState('')
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState('')
  const [message, setMessage] = useState('')

  async function handleSubmit(e) {
    e.preventDefault()
    setLoading(true)
    setError('')
    setMessage('')
    
    try {
      if (mode === 'login') {
        await signIn(email, password)
      } else {
        await signUp(email, password, firstName, lastName)
        setMessage('Account created! You can now continue.')
      }
    } catch (err) {
      setError(err.message)
    }
    setLoading(false)
  }

  return (
    <div className="min-h-screen flex items-center justify-center bg-slate-900 p-4">
      <div className="w-full max-w-md">
        <div className="text-center mb-8">
          <div className="text-5xl mb-4"><VolleyballIcon className="w-16 h-16" /></div>
          <h1 className="text-3xl font-bold text-white">VolleyBrain</h1>
          <p className="text-slate-400 mt-2">
            {mode === 'login' ? 'Sign in to continue' : 'Create your account'}
          </p>
        </div>
        
        {/* Toggle between Login and Sign Up */}
        <div className="flex mb-6 bg-slate-800 rounded-xl p-1">
          <button
            onClick={() => { setMode('login'); setError(''); setMessage('') }}
            className={`flex-1 py-2.5 rounded-lg font-medium transition ${
              mode === 'login' 
                ? 'bg-[var(--accent-primary)] text-white' 
                : 'text-slate-400 hover:text-white'
            }`}
          >
            Sign In
          </button>
          <button
            onClick={() => { setMode('signup'); setError(''); setMessage('') }}
            className={`flex-1 py-2.5 rounded-lg font-medium transition ${
              mode === 'signup' 
                ? 'bg-[var(--accent-primary)] text-white' 
                : 'text-slate-400 hover:text-white'
            }`}
          >
            Sign Up
          </button>
        </div>
        
        <div className="bg-slate-800 border border-slate-700 rounded-2xl p-6">
          {error && (
            <div className="bg-red-500/10 border border-red-500/30 rounded-xl p-4 mb-6 text-red-400 text-sm">
              {error}
            </div>
          )}
          {message && (
            <div className="bg-emerald-500/10 border border-emerald-500/30 rounded-xl p-4 mb-6 text-emerald-400 text-sm">
              {message}
            </div>
          )}
          
          <form onSubmit={handleSubmit} className="space-y-4">
            {mode === 'signup' && (
              <div className="flex gap-3">
                <div className="flex-1">
                  <label className="block text-sm text-slate-400 mb-2">First Name</label>
                  <input 
                    type="text" 
                    value={firstName} 
                    onChange={e => setFirstName(e.target.value)} 
                    required={mode === 'signup'}
                    className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white focus:border-[var(--accent-primary)]/50 focus:outline-none" 
                    placeholder="First" 
                  />
                </div>
                <div className="flex-1">
                  <label className="block text-sm text-slate-400 mb-2">Last Name</label>
                  <input 
                    type="text" 
                    value={lastName} 
                    onChange={e => setLastName(e.target.value)} 
                    required={mode === 'signup'}
                    className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white focus:border-[var(--accent-primary)]/50 focus:outline-none" 
                    placeholder="Last" 
                  />
                </div>
              </div>
            )}
            
            <div>
              <label className="block text-sm text-slate-400 mb-2">Email</label>
              <input 
                type="email" 
                value={email} 
                onChange={e => setEmail(e.target.value)} 
                required
                className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white focus:border-[var(--accent-primary)]/50 focus:outline-none" 
                placeholder="you@example.com" 
              />
            </div>
            
            <div>
              <label className="block text-sm text-slate-400 mb-2">Password</label>
              <input 
                type="password" 
                value={password} 
                onChange={e => setPassword(e.target.value)} 
                required
                minLength={mode === 'signup' ? 6 : undefined}
                className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white focus:border-[var(--accent-primary)]/50 focus:outline-none" 
                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
              />
              {mode === 'signup' && (
                <p className="text-xs text-slate-500 mt-1">Minimum 6 characters</p>
              )}
            </div>
            
            <button 
              type="submit" 
              disabled={loading}
              className="w-full bg-[var(--accent-primary)] text-white font-semibold py-3 rounded-xl hover:brightness-110 transition disabled:opacity-50"
            >
              {loading 
                ? (mode === 'login' ? 'Signing in...' : 'Creating account...') 
                : (mode === 'login' ? 'Sign In' : 'Create Account')
              }
            </button>
          </form>
        </div>
        
        <p className="text-center text-slate-500 text-sm mt-6">
          {mode === 'login' 
            ? "Don't have an account? " 
            : "Already have an account? "
          }
          <button 
            onClick={() => { setMode(mode === 'login' ? 'signup' : 'login'); setError(''); setMessage('') }}
            className="text-[var(--accent-primary)] hover:underline"
          >
            {mode === 'login' ? 'Sign up' : 'Sign in'}
          </button>
        </p>
      </div>
    </div>
  )
}

// ============================================
// GLOBAL SPORT SELECTOR COMPONENT
// ============================================
function GlobalSportSelector() {
  const { sports, selectedSport, selectSport, loading } = useSport()
  const { isDark, colors } = useTheme()

  if (loading || sports.length === 0) return null

  return (
    <div className="px-4 pt-4 pb-2">
      <p className="text-xs uppercase tracking-wider mb-2" style={{ color: colors.textMuted }}>Sport</p>
      <select 
        value={selectedSport?.id || 'all'} 
        onChange={e => {
          if (e.target.value === 'all') {
            selectSport(null)
          } else {
            const s = sports.find(s => s.id === e.target.value)
            selectSport(s)
          }
        }}
        className="w-full rounded-lg px-3 py-2 text-sm"
        style={{ 
          backgroundColor: isDark ? '#0a0a0a' : '#f3f4f6', 
          borderColor: colors.border,
          color: colors.text,
          borderWidth: 1
        }}
      >
        <option value="all">üåê All Sports</option>
        {sports.map(s => (
          <option key={s.id} value={s.id}>
            {s.icon} {s.name}
          </option>
        ))}
      </select>
    </div>
  )
}

// ============================================
// GLOBAL SEASON SELECTOR COMPONENT
// ============================================
function GlobalSeasonSelector() {
  const { seasons, selectedSeason, selectSeason, loading } = useSeason()
  const { selectedSport } = useSport()
  const { isDark, colors } = useTheme()

  if (loading || seasons.length === 0) return null

  return (
    <div className="px-4 pb-4 border-b" style={{ borderColor: colors.border }}>
      <p className="text-xs uppercase tracking-wider mb-2" style={{ color: colors.textMuted }}>Season</p>
      <select 
        value={selectedSeason?.id || ''} 
        onChange={e => {
          const s = seasons.find(s => s.id === e.target.value)
          selectSeason(s)
        }}
        className="w-full rounded-lg px-3 py-2 text-sm"
        style={{ 
          backgroundColor: isDark ? '#0a0a0a' : '#f3f4f6', 
          borderColor: colors.border,
          color: colors.text,
          borderWidth: 1
        }}
      >
        {seasons.map(s => (
          <option key={s.id} value={s.id}>
            {!selectedSport && s.sports?.icon ? `${s.sports.icon} ` : ''}{s.name} {s.status === 'active' ? '‚óè' : ''}
          </option>
        ))}
      </select>
    </div>
  )
}

// ============================================
// HEADER SPORT SELECTOR (Compact for top bar)
// ============================================
function HeaderSportSelector() {
  const { sports, selectedSport, selectSport, loading } = useSport()
  const { isDark, colors } = useTheme()
  const [open, setOpen] = useState(false)

  if (loading || sports.length === 0) return null

  return (
    <div className="relative">
      <button 
        onClick={() => setOpen(!open)}
        className="flex items-center gap-2 px-3 py-1.5 rounded-lg transition hover:bg-black/10 dark:hover:bg-white/10"
        style={{ color: colors.textSecondary }}
      >
        <Globe className="w-4 h-4" />
        <span className="text-sm font-medium" style={{ color: colors.text }}>
          {selectedSport?.name || 'All Sports'}
        </span>
        <ChevronDown className={`w-3 h-3 transition-transform ${open ? 'rotate-180' : ''}`} />
      </button>
      
      {open && (
        <>
          <div className="fixed inset-0 z-40" onClick={() => setOpen(false)} />
          <div 
            className="absolute top-full left-0 mt-1 w-48 rounded-lg shadow-xl border overflow-hidden z-50"
            style={{ backgroundColor: colors.cardBg, borderColor: colors.border }}
          >
            <button
              onClick={() => { selectSport(null); setOpen(false); }}
              className={`w-full flex items-center gap-2 px-3 py-2 text-sm transition ${
                !selectedSport ? 'bg-[var(--accent-primary)]/20 text-[var(--accent-primary)]' : ''
              }`}
              style={{ color: !selectedSport ? undefined : colors.text }}
              onMouseEnter={e => !selectedSport || (e.currentTarget.style.backgroundColor = isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)')}
              onMouseLeave={e => !selectedSport || (e.currentTarget.style.backgroundColor = '')}
            >
              <Globe className="w-4 h-4" />
              <span>All Sports</span>
              {!selectedSport && <Check className="w-4 h-4 ml-auto" />}
            </button>
            {sports.map(s => (
              <button
                key={s.id}
                onClick={() => { selectSport(s); setOpen(false); }}
                className={`w-full flex items-center gap-2 px-3 py-2 text-sm transition ${
                  selectedSport?.id === s.id ? 'bg-[var(--accent-primary)]/20 text-[var(--accent-primary)]' : ''
                }`}
                style={{ color: selectedSport?.id === s.id ? undefined : colors.text }}
                onMouseEnter={e => selectedSport?.id !== s.id && (e.currentTarget.style.backgroundColor = isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)')}
                onMouseLeave={e => selectedSport?.id !== s.id && (e.currentTarget.style.backgroundColor = '')}
              >
                <span>{s.icon}</span>
                <span>{s.name}</span>
                {selectedSport?.id === s.id && <Check className="w-4 h-4 ml-auto" />}
              </button>
            ))}
          </div>
        </>
      )}
    </div>
  )
}

// ============================================
// HEADER SEASON SELECTOR (Compact for top bar)
// ============================================
function HeaderSeasonSelector() {
  const { seasons, selectedSeason, selectSeason, loading } = useSeason()
  const { selectedSport } = useSport()
  const { isDark, colors } = useTheme()
  const [open, setOpen] = useState(false)

  if (loading || seasons.length === 0) return null

  return (
    <div className="relative">
      <button 
        onClick={() => setOpen(!open)}
        className="flex items-center gap-2 px-3 py-1.5 rounded-lg transition hover:bg-black/10 dark:hover:bg-white/10"
        style={{ color: colors.textSecondary }}
      >
        <Calendar className="w-4 h-4" />
        <span className="text-sm font-medium" style={{ color: colors.text }}>
          {selectedSeason?.name || 'Select Season'}
        </span>
        {selectedSeason?.status === 'active' && (
          <span className="w-2 h-2 rounded-full bg-emerald-500" />
        )}
        <ChevronDown className={`w-3 h-3 transition-transform ${open ? 'rotate-180' : ''}`} />
      </button>
      
      {open && (
        <>
          <div className="fixed inset-0 z-40" onClick={() => setOpen(false)} />
          <div 
            className="absolute top-full left-0 mt-1 w-56 rounded-lg shadow-xl border overflow-hidden z-50 max-h-80 overflow-y-auto"
            style={{ backgroundColor: colors.cardBg, borderColor: colors.border }}
          >
            {seasons.map(s => (
              <button
                key={s.id}
                onClick={() => { selectSeason(s); setOpen(false); }}
                className={`w-full flex items-center gap-2 px-3 py-2 text-sm transition ${
                  selectedSeason?.id === s.id ? 'bg-[var(--accent-primary)]/20 text-[var(--accent-primary)]' : ''
                }`}
                style={{ color: selectedSeason?.id === s.id ? undefined : colors.text }}
                onMouseEnter={e => selectedSeason?.id !== s.id && (e.currentTarget.style.backgroundColor = isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)')}
                onMouseLeave={e => selectedSeason?.id !== s.id && (e.currentTarget.style.backgroundColor = '')}
              >
                {!selectedSport && s.sports?.icon && <span>{s.sports.icon}</span>}
                <span className="flex-1 text-left">{s.name}</span>
                {s.status === 'active' && (
                  <span className="w-2 h-2 rounded-full bg-emerald-500" title="Active" />
                )}
                {selectedSeason?.id === s.id && <Check className="w-4 h-4" />}
              </button>
            ))}
          </div>
        </>
      )}
    </div>
  )
}

// ============================================
// HEADER COACH TEAM SELECTOR (For coaches with multiple teams)
// ============================================
function HeaderCoachTeamSelector({ teams, onSelectTeam }) {
  const { isDark, colors } = useTheme()
  const [open, setOpen] = useState(false)
  const [selectedTeam, setSelectedTeam] = useState(teams?.[0] || null)

  if (!teams || teams.length === 0) return null

  return (
    <div className="relative">
      <button 
        onClick={() => setOpen(!open)}
        className="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-[var(--accent-primary)]/10 border border-[var(--accent-primary)]/30 transition hover:bg-[var(--accent-primary)]/20"
      >
        <Users className="w-4 h-4 text-[var(--accent-primary)]" />
        <span className="text-sm font-medium text-[var(--accent-primary)]">
          {selectedTeam?.teams?.name || 'Select Team'}
        </span>
        {selectedTeam?.role === 'head' && (
          <span className="text-xs bg-[var(--accent-primary)]/20 px-1.5 py-0.5 rounded text-[var(--accent-primary)]">HC</span>
        )}
        <ChevronDown className={`w-3 h-3 text-[var(--accent-primary)] transition-transform ${open ? 'rotate-180' : ''}`} />
      </button>
      
      {open && (
        <>
          <div className="fixed inset-0 z-40" onClick={() => setOpen(false)} />
          <div 
            className="absolute top-full left-0 mt-1 w-56 rounded-lg shadow-xl border overflow-hidden z-50"
            style={{ backgroundColor: colors.cardBg, borderColor: colors.border }}
          >
            <div className="p-2 border-b" style={{ borderColor: colors.border }}>
              <p className="text-xs px-2" style={{ color: colors.textMuted }}>My Teams</p>
            </div>
            {teams.map(tc => (
              <button
                key={tc.team_id}
                onClick={() => { 
                  setSelectedTeam(tc)
                  onSelectTeam(tc.team_id)
                  setOpen(false)
                }}
                className={`w-full flex items-center gap-2 px-3 py-2.5 text-sm transition ${
                  selectedTeam?.team_id === tc.team_id ? 'bg-[var(--accent-primary)]/20' : ''
                }`}
                style={{ color: colors.text }}
                onMouseEnter={e => selectedTeam?.team_id !== tc.team_id && (e.currentTarget.style.backgroundColor = isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)')}
                onMouseLeave={e => selectedTeam?.team_id !== tc.team_id && (e.currentTarget.style.backgroundColor = '')}
              >
                <span 
                  className="w-3 h-3 rounded-full" 
                  style={{ background: tc.teams?.color || '#EAB308' }}
                />
                <span className="flex-1 text-left">{tc.teams?.name}</span>
                {tc.role === 'head' && (
                  <span className="text-xs bg-yellow-500/20 text-yellow-600 px-1.5 py-0.5 rounded">Head</span>
                )}
                {selectedTeam?.team_id === tc.team_id && <Check className="w-4 h-4 text-[var(--accent-primary)]" />}
              </button>
            ))}
          </div>
        </>
      )}
    </div>
  )
}

// ============================================
// HEADER CHILD SELECTOR (For parents with multiple children)
// ============================================
function HeaderChildSelector({ children, onSelectChild, navigateToTeamWall }) {
  const { isDark, colors } = useTheme()
  const tc = useThemeClasses()
  const [open, setOpen] = useState(false)
  const [selectedChild, setSelectedChild] = useState(children?.[0] || null)

  if (!children || children.length === 0) return null

  return (
    <div className="relative">
      <button 
        onClick={() => setOpen(!open)}
        className="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-[var(--accent-primary)]/10 border border-[var(--accent-primary)]/30 transition hover:bg-[var(--accent-primary)]/20"
      >
        {selectedChild?.photo_url ? (
          <img src={selectedChild.photo_url} alt="" className="w-5 h-5 rounded-full object-cover" />
        ) : (
          <User className="w-4 h-4 text-[var(--accent-primary)]" />
        )}
        <span className="text-sm font-medium text-[var(--accent-primary)]">
          {selectedChild?.first_name || 'Select Player'}
        </span>
        <ChevronDown className={`w-3 h-3 text-[var(--accent-primary)] transition-transform ${open ? 'rotate-180' : ''}`} />
      </button>
      
      {open && (
        <>
          <div className="fixed inset-0 z-40" onClick={() => setOpen(false)} />
          <div 
            className="absolute top-full left-0 mt-1 w-64 rounded-lg shadow-xl border overflow-hidden z-50"
            style={{ backgroundColor: colors.cardBg, borderColor: colors.border }}
          >
            <div className="p-2 border-b" style={{ borderColor: colors.border }}>
              <p className="text-xs px-2" style={{ color: colors.textMuted }}>My Players</p>
            </div>
            {children.map(child => (
              <div key={child.id}>
                <button
                  onClick={() => { 
                    setSelectedChild(child)
                    onSelectChild(child.id)
                    setOpen(false)
                  }}
                  className={`w-full flex items-center gap-2 px-3 py-2.5 text-sm transition ${
                    selectedChild?.id === child.id ? 'bg-[var(--accent-primary)]/20' : ''
                  }`}
                  style={{ color: colors.text }}
                  onMouseEnter={e => selectedChild?.id !== child.id && (e.currentTarget.style.backgroundColor = isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)')}
                  onMouseLeave={e => selectedChild?.id !== child.id && (e.currentTarget.style.backgroundColor = '')}
                >
                  {child.photo_url ? (
                    <img src={child.photo_url} alt="" className="w-6 h-6 rounded-full object-cover" />
                  ) : (
                    <div className="w-6 h-6 rounded-full bg-[var(--accent-primary)]/30 flex items-center justify-center text-xs font-bold text-[var(--accent-primary)]">
                      {child.first_name?.[0]}
                    </div>
                  )}
                  <span className="flex-1 text-left">{child.first_name} {child.last_name}</span>
                  {selectedChild?.id === child.id && <Check className="w-4 h-4 text-[var(--accent-primary)]" />}
                </button>
                {/* Show teams for this child */}
                {child.team_players?.map(tp => (
                  <button
                    key={tp.team_id}
                    onClick={() => {
                      navigateToTeamWall(tp.team_id)
                      setOpen(false)
                    }}
                    className={`w-full flex items-center gap-2 px-3 py-1.5 ml-4 text-xs transition ${tc.hoverBg}`}
                    style={{ color: colors.textSecondary }}
                  >
                    <span 
                      className="w-2 h-2 rounded-full" 
                      style={{ background: tp.teams?.color || '#EAB308' }}
                    />
                    <span>{tp.teams?.name}</span>
                    <ArrowRight className="w-3 h-3 ml-auto opacity-50" />
                  </button>
                ))}
              </div>
            ))}
          </div>
        </>
      )}
    </div>
  )
}

// Theme Toggle Button
// ============================================
// JERSEY NAV BADGE COMPONENT
// ============================================
function JerseyNavBadge({ collapsed }) {
  const { selectedSeason } = useSeason()
  const [count, setCount] = useState(0)

  useEffect(() => {
    async function loadCount() {
      if (!selectedSeason?.id) {
        setCount(0)
        return
      }
      try {
        // Count players needing jerseys
        const { count: needsJersey } = await supabase
          .from('team_players')
          .select('*, teams!inner(season_id)', { count: 'exact', head: true })
          .eq('teams.season_id', selectedSeason.id)
          .is('jersey_number', null)

        // Count jerseys needing to be ordered
        const { count: needsOrder } = await supabase
          .from('jersey_assignments')
          .select('*, teams!inner(season_id)', { count: 'exact', head: true })
          .eq('teams.season_id', selectedSeason.id)
          .eq('needs_jersey_order', true)

        setCount((needsJersey || 0) + (needsOrder || 0))
      } catch (err) {
        console.error('Error loading jersey badge count:', err)
      }
    }
    loadCount()
  }, [selectedSeason?.id])

  if (count === 0) return null

  if (collapsed) {
    return <span className="absolute -top-1 -right-1 w-2 h-2 bg-amber-500 rounded-full" />
  }

  return (
    <span className="px-1.5 py-0.5 rounded-full text-[10px] font-bold bg-amber-500/20 text-amber-500">
      {count > 99 ? '99+' : count}
    </span>
  )
}

function ThemeToggleButton({ collapsed }) {
  const { isDark, toggleTheme } = useTheme()
  
  return (
    <button 
      onClick={toggleTheme}
      className={`flex-1 flex items-center justify-center gap-2 px-3 py-2 rounded-lg transition text-sm ${
        isDark 
          ? 'text-slate-400 hover:text-[var(--accent-primary)] hover:bg-[var(--accent-primary)]/10' 
          : 'text-slate-600 hover:text-[var(--accent-primary)] hover:bg-[var(--accent-primary)]/10'
      }`}
      title={isDark ? 'Switch to Light Mode' : 'Switch to Dark Mode'}
    >
      {isDark ? <Sun className="w-4 h-4" /> : <Moon className="w-4 h-4" />}
      {!collapsed && <span>{isDark ? 'Light' : 'Dark'}</span>}
    </button>
  )
}


// ============================================
// VOLLEYBALL LINEUP BUILDER
// Modern game prep tool for coaches
// ============================================

// Rotation type configurations
const ROTATION_CONFIGS = {
  '5-1': {
    name: '5-1',
    description: '1 setter runs all rotations',
    hasLibero: true,
    liberoOptional: true,
    positions: ['OH', 'OH', 'MB', 'MB', 'S', 'OPP'],
    typical: 'Competitive teams, 12U+'
  },
  '6-2': {
    name: '6-2',
    description: '2 setters, setter always back row',
    hasLibero: true,
    liberoOptional: true,
    positions: ['OH', 'OH', 'MB', 'MB', 'S', 'S'],
    typical: 'Intermediate teams'
  },
  '4-2': {
    name: '4-2',
    description: '2 setters, simpler rotation',
    hasLibero: false,
    liberoOptional: true,
    positions: ['OH', 'OH', 'MB', 'MB', 'S', 'S'],
    typical: 'Younger/beginner teams'
  },
  '6-6': {
    name: '6-6',
    description: 'Rec style, everyone rotates all positions',
    hasLibero: false,
    liberoOptional: false,
    positions: ['P1', 'P2', 'P3', 'P4', 'P5', 'P6'],
    typical: 'Recreational leagues'
  }
}

// Position colors
const POSITION_COLORS = {
  'OH': '#EF4444',   // Red
  'MB': '#F59E0B',   // Amber
  'S': '#10B981',    // Emerald
  'OPP': '#6366F1',  // Indigo
  'RS': '#8B5CF6',   // Violet
  'L': '#EC4899',    // Pink
  'DS': '#14B8A6',   // Teal
  'UT': '#64748B',   // Slate
  'P1': '#3B82F6',   // Blue (for 6-6)
  'P2': '#10B981',
  'P3': '#F59E0B',
  'P4': '#EF4444',
  'P5': '#8B5CF6',
  'P6': '#EC4899',
}

// Court position coordinates (percentages) - HALF COURT ONLY
const COURT_POSITIONS = {
  // Front row (near net) - positions 4, 3, 2
  4: { x: 18, y: 22, label: 'P4', zone: 'front-left', defaultPos: 'OH' },
  3: { x: 50, y: 22, label: 'P3', zone: 'front-center', defaultPos: 'MB' },
  2: { x: 82, y: 22, label: 'P2', zone: 'front-right', defaultPos: 'OPP' },
  // Back row - positions 5, 6, 1
  5: { x: 18, y: 68, label: 'P5', zone: 'back-left', defaultPos: 'MB' },
  6: { x: 50, y: 68, label: 'P6', zone: 'back-center', defaultPos: 'S' },
  1: { x: 82, y: 68, label: 'P1', zone: 'back-right', defaultPos: 'OH' },
}

// ============================================
// VOLLEYBALL COURT SVG COMPONENT - HALF COURT
// Matches reference: orange court, net at top, our side only
// ============================================
function VolleyballCourt({ children, isDark, showServeIndicator, servingPosition, compact = false }) {
  // Orange volleyball court colors (like reference image)
  const courtOrange = '#F97316'
  const courtOrangeDark = '#EA580C'
  const lineColor = '#FFFFFF'
  const netColor = '#FEF3C7'
  const bgColor = isDark ? '#1E293B' : '#334155'
  
  const height = compact ? 180 : 220
  
  return (
    <div className="relative w-full mx-auto" style={{ maxWidth: compact ? '380px' : '480px' }}>
      <svg viewBox="0 0 400 240" className="w-full" style={{ height }}>
        {/* Background */}
        <rect x="0" y="0" width="400" height="240" fill={bgColor} />
        
        {/* Court glow effect */}
        <defs>
          <filter id="courtGlow" x="-20%" y="-20%" width="140%" height="140%">
            <feGaussianBlur stdDeviation="8" result="blur" />
            <feFlood floodColor={courtOrange} floodOpacity="0.4" />
            <feComposite in2="blur" operator="in" />
            <feMerge>
              <feMergeNode />
              <feMergeNode in="SourceGraphic" />
            </feMerge>
          </filter>
        </defs>
        
        {/* NET at top - with posts */}
        {/* Left post */}
        <rect x="35" y="15" width="8" height="55" fill="#1F2937" rx="2" />
        <rect x="33" y="12" width="12" height="6" fill="#374151" rx="1" />
        {/* Right post */}
        <rect x="357" y="15" width="8" height="55" fill="#1F2937" rx="2" />
        <rect x="355" y="12" width="12" height="6" fill="#374151" rx="1" />
        
        {/* Net cable top */}
        <line x1="39" y1="20" x2="361" y2="20" stroke="#F8FAFC" strokeWidth="2" />
        {/* Net mesh area */}
        <rect x="39" y="20" width="322" height="45" fill="url(#netPattern)" opacity="0.9" />
        {/* Net pattern */}
        <defs>
          <pattern id="netPattern" x="0" y="0" width="8" height="8" patternUnits="userSpaceOnUse">
            <rect width="8" height="8" fill={netColor} />
            <line x1="0" y1="0" x2="8" y2="8" stroke="#D4A574" strokeWidth="0.5" />
            <line x1="8" y1="0" x2="0" y2="8" stroke="#D4A574" strokeWidth="0.5" />
          </pattern>
        </defs>
        {/* Net bottom cable */}
        <line x1="39" y1="65" x2="361" y2="65" stroke="#E5E7EB" strokeWidth="2" />
        {/* Net tape at top */}
        <rect x="39" y="18" width="322" height="6" fill="#F8FAFC" opacity="0.9" />
        {/* Red antenna markers */}
        <rect x="39" y="10" width="2" height="55" fill="#EF4444" />
        <rect x="359" y="10" width="2" height="55" fill="#EF4444" />
        
        {/* Court surface with glow */}
        <rect x="45" y="75" width="310" height="155" rx="4" fill={courtOrange} filter="url(#courtGlow)" />
        
        {/* Court pink/magenta border glow */}
        <rect x="45" y="75" width="310" height="155" rx="4" fill="none" stroke="#EC4899" strokeWidth="3" opacity="0.6" />
        
        {/* Court outline */}
        <rect x="50" y="80" width="300" height="145" fill="none" stroke={lineColor} strokeWidth="2" />
        
        {/* Attack line (3m line) */}
        <line x1="50" y1="130" x2="350" y2="130" stroke={lineColor} strokeWidth="2" opacity="0.7" />
        
        {/* Position zone indicators - subtle */}
        <text x="78" y="110" fontSize="11" fill={lineColor} opacity="0.4" textAnchor="middle" fontWeight="500">P4</text>
        <text x="200" y="110" fontSize="11" fill={lineColor} opacity="0.4" textAnchor="middle" fontWeight="500">P3</text>
        <text x="322" y="110" fontSize="11" fill={lineColor} opacity="0.4" textAnchor="middle" fontWeight="500">P2</text>
        <text x="78" y="195" fontSize="11" fill={lineColor} opacity="0.4" textAnchor="middle" fontWeight="500">P5</text>
        <text x="200" y="195" fontSize="11" fill={lineColor} opacity="0.4" textAnchor="middle" fontWeight="500">P6</text>
        <text x="322" y="195" fontSize="11" fill={lineColor} opacity="0.4" textAnchor="middle" fontWeight="500">P1</text>
        
        {/* Serving position indicator */}
        {showServeIndicator && servingPosition === 1 && (
          <circle cx="340" cy="215" r="10" fill="#10B981" opacity="0.5" />
        )}
      </svg>
      
      {/* Player positions overlay */}
      <div className="absolute inset-0">
        {children}
      </div>
    </div>
  )
}

// ============================================
// PLAYER ICON COMPONENT (Draggable)
// ============================================
function PlayerIcon({ 
  player, 
  position, 
  isServing, 
  isLibero, 
  isCaptain,
  hasRsvp,
  rsvpStatus,
  isDark,
  onClick,
  onDragStart,
  onDragEnd,
  isOnCourt,
  size = 'normal' // 'normal' | 'small' | 'roster'
}) {
  const tc = isDark ? {
    bg: 'bg-slate-800',
    border: 'border-slate-600',
    text: 'text-white',
    muted: 'text-slate-400'
  } : {
    bg: 'bg-white',
    border: 'border-slate-200',
    text: 'text-slate-900',
    muted: 'text-slate-500'
  }

  const posColor = POSITION_COLORS[player?.primary_position] || '#6366F1'
  const sizeClasses = {
    normal: 'w-14 h-14',
    small: 'w-10 h-10',
    roster: 'w-12 h-12'
  }

  const noRsvp = !hasRsvp || rsvpStatus === 'pending' || rsvpStatus === 'no'
  const dimmed = noRsvp && isOnCourt

  return (
    <div
      draggable={!isOnCourt || true}
      onDragStart={(e) => onDragStart?.(e, player)}
      onDragEnd={onDragEnd}
      onClick={() => onClick?.(player)}
      className={`
        relative cursor-pointer transition-all duration-200
        ${dimmed ? 'opacity-50' : 'opacity-100'}
        hover:scale-110 hover:z-50
        ${isServing ? 'ring-2 ring-emerald-400 ring-offset-2' : ''}
      `}
      style={{ touchAction: 'none' }}
    >
      {/* Player photo/avatar */}
      <div 
        className={`
          ${sizeClasses[size]} rounded-xl overflow-hidden border-2 shadow-lg
          ${tc.bg} relative
        `}
        style={{ borderColor: posColor }}
      >
        {player?.photo_url ? (
          <img 
            src={player.photo_url} 
            alt={player.first_name}
            className="w-full h-full object-cover"
          />
        ) : (
          <div 
            className="w-full h-full flex items-center justify-center text-lg font-bold text-white"
            style={{ backgroundColor: posColor }}
          >
            {player?.first_name?.[0]}{player?.last_name?.[0]}
          </div>
        )}
        
        {/* No RSVP overlay */}
        {noRsvp && (
          <div className="absolute inset-0 bg-black/50 flex items-center justify-center">
            <X className="w-6 h-6 text-red-500" />
          </div>
        )}
        
        {/* Jersey number badge */}
        <div 
          className="absolute -bottom-1 -right-1 w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold text-white shadow"
          style={{ backgroundColor: posColor }}
        >
          {player?.jersey_number || '?'}
        </div>
        
        {/* Captain star */}
        {isCaptain && (
          <div className="absolute -top-1 -left-1 w-5 h-5 rounded-full bg-yellow-400 flex items-center justify-center text-xs shadow">
            <Star className="w-3 h-3 text-white fill-white" />
          </div>
        )}
        
        {/* Libero badge */}
        {isLibero && (
          <div className="absolute -top-1 -right-1 w-5 h-5 rounded-full bg-pink-500 flex items-center justify-center text-[10px] text-white shadow font-bold">
            L
          </div>
        )}
        
        {/* Serving indicator */}
        {isServing && (
          <div className="absolute -bottom-2 left-1/2 -translate-x-1/2 animate-bounce">
            <VolleyballIcon className="w-4 h-4" />
          </div>
        )}
      </div>
      
      {/* Player name (on roster view) */}
      {size === 'roster' && (
        <div className="mt-1 text-center">
          <p className={`text-xs font-medium ${tc.text} truncate max-w-[60px]`}>
            {player?.first_name}
          </p>
          <p className={`text-[10px] ${tc.muted}`}>
            {player?.primary_position || 'UT'}
          </p>
        </div>
      )}
    </div>
  )
}

// ============================================
// GAME PLAYER CARD MODAL (Not registration info)
// ============================================
function GamePlayerCard({ player, onClose, isDark }) {
  const tc = isDark ? {
    bg: 'bg-slate-900',
    cardBg: 'bg-slate-800',
    text: 'text-white',
    muted: 'text-slate-400',
    border: 'border-slate-700'
  } : {
    bg: 'bg-white',
    cardBg: 'bg-slate-50',
    text: 'text-slate-900',
    muted: 'text-slate-500',
    border: 'border-slate-200'
  }
  
  const posColor = POSITION_COLORS[player?.primary_position] || '#6366F1'

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={onClose}>
      <div 
        className={`${tc.bg} rounded-2xl shadow-2xl max-w-sm w-full overflow-hidden`}
        onClick={e => e.stopPropagation()}
      >
        {/* Header with photo */}
        <div 
          className="relative h-32 flex items-end p-4"
          style={{ background: `linear-gradient(135deg, ${posColor}40, ${posColor}20)` }}
        >
          <div className="absolute top-4 right-4">
            <button onClick={onClose} className={`w-8 h-8 rounded-full ${tc.cardBg} flex items-center justify-center`}>
              ‚úï
            </button>
          </div>
          <div className="flex items-end gap-4">
            {player?.photo_url ? (
              <img 
                src={player.photo_url} 
                alt={player.first_name}
                className="w-20 h-20 rounded-xl object-cover border-4 border-white shadow-lg"
              />
            ) : (
              <div 
                className="w-20 h-20 rounded-xl flex items-center justify-center text-3xl font-bold text-white border-4 border-white shadow-lg"
                style={{ backgroundColor: posColor }}
              >
                {player?.first_name?.[0]}{player?.last_name?.[0]}
              </div>
            )}
            <div className="mb-2">
              <h2 className={`text-2xl font-bold ${tc.text}`}>
                {player?.first_name} {player?.last_name}
              </h2>
              <div className="flex items-center gap-2">
                <span 
                  className="px-2 py-0.5 rounded-full text-xs font-bold text-white"
                  style={{ backgroundColor: posColor }}
                >
                  {player?.primary_position || 'UT'}
                </span>
                <span className={`text-lg font-bold ${tc.text}`}>#{player?.jersey_number || '?'}</span>
              </div>
            </div>
          </div>
        </div>
        
        {/* Game-relevant info only */}
        <div className="p-4 space-y-4">
          {/* Contact (Guardian) */}
          <div className={`${tc.cardBg} rounded-xl p-3`}>
            <h3 className={`text-xs uppercase ${tc.muted} mb-2 flex items-center gap-2`}><Phone className="w-4 h-4" />Emergency Contact</h3>
            <p className={tc.text}>{player?.parent_name || player?.guardian_name || 'Not provided'}</p>
            <p className={`text-sm ${tc.muted}`}>{player?.parent_phone || 'No phone'}</p>
          </div>
          
          {/* Medical */}
          {(player?.medical_conditions || player?.allergies) && (
            <div className="bg-red-500/10 border border-red-500/30 rounded-xl p-3">
              <h3 className="text-xs uppercase text-red-400 mb-2">‚ö†Ô∏è Medical Alert</h3>
              {player?.medical_conditions && (
                <p className={tc.text}>{player.medical_conditions}</p>
              )}
              {player?.allergies && (
                <p className={`text-sm ${tc.muted}`}>Allergies: {player.allergies}</p>
              )}
            </div>
          )}
          
          {/* Stats preview */}
          <div className={`${tc.cardBg} rounded-xl p-3`}>
            <h3 className={`text-xs uppercase ${tc.muted} mb-2 flex items-center gap-2`}><BarChart3 className="w-4 h-4" />Season Stats</h3>
            <div className="grid grid-cols-4 gap-2 text-center">
              <div>
                <p className="text-xl font-bold" style={{ color: posColor }}>{player?.stats?.kills || 0}</p>
                <p className={`text-[10px] ${tc.muted}`}>Kills</p>
              </div>
              <div>
                <p className="text-xl font-bold" style={{ color: posColor }}>{player?.stats?.aces || 0}</p>
                <p className={`text-[10px] ${tc.muted}`}>Aces</p>
              </div>
              <div>
                <p className="text-xl font-bold" style={{ color: posColor }}>{player?.stats?.digs || 0}</p>
                <p className={`text-[10px] ${tc.muted}`}>Digs</p>
              </div>
              <div>
                <p className="text-xl font-bold" style={{ color: posColor }}>{player?.stats?.blocks || 0}</p>
                <p className={`text-[10px] ${tc.muted}`}>Blocks</p>
              </div>
            </div>
          </div>
          
          {/* Ratings */}
          <div className={`${tc.cardBg} rounded-xl p-3`}>
            <h3 className={`text-xs uppercase ${tc.muted} mb-2`}>Skill Ratings</h3>
            <div className="space-y-2">
              {[
                { label: 'Overall', value: player?.skill_rating || 50 },
                { label: 'Serve', value: player?.serve_rating || 50 },
                { label: 'Attack', value: player?.attack_rating || 50 },
                { label: 'Defense', value: player?.defense_rating || 50 },
              ].map(stat => (
                <div key={stat.label} className="flex items-center gap-2">
                  <span className={`text-xs ${tc.muted} w-16`}>{stat.label}</span>
                  <div className="flex-1 h-2 bg-slate-600 rounded-full overflow-hidden">
                    <div 
                      className="h-full rounded-full transition-all"
                      style={{ width: `${stat.value}%`, backgroundColor: posColor }}
                    />
                  </div>
                  <span className={`text-xs ${tc.text} w-8`}>{stat.value}</span>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    </div>
  )
}

// ============================================
// ROTATION VISUALIZER (Animated)
// ============================================
function RotationVisualizer({ currentRotation, rotationType, players, isDark, onRotationChange }) {
  const [isAnimating, setIsAnimating] = useState(false)
  
  const rotationLabels = {
    1: 'Rotation 1 (Serve)',
    2: 'Rotation 2',
    3: 'Rotation 3',
    4: 'Rotation 4',
    5: 'Rotation 5',
    6: 'Rotation 6'
  }
  
  function animateRotation(direction) {
    setIsAnimating(true)
    setTimeout(() => {
      const newRot = direction === 'next' 
        ? (currentRotation % 6) + 1 
        : currentRotation === 1 ? 6 : currentRotation - 1
      onRotationChange(newRot)
      setIsAnimating(false)
    }, 300)
  }
  
  const tc = isDark ? {
    bg: 'bg-slate-800',
    text: 'text-white',
    muted: 'text-slate-400'
  } : {
    bg: 'bg-white',
    text: 'text-slate-900',
    muted: 'text-slate-500'
  }

  return (
    <div className={`${tc.bg} rounded-xl p-4`}>
      <div className="flex items-center justify-between mb-4">
        <button 
          onClick={() => animateRotation('prev')}
          className="w-10 h-10 rounded-full bg-slate-600 text-white flex items-center justify-center hover:bg-slate-500 transition"
        >
          ‚Üê
        </button>
        
        <div className="text-center">
          <h3 className={`font-bold ${tc.text}`}>{rotationLabels[currentRotation]}</h3>
          <p className={`text-xs ${tc.muted}`}>
            {currentRotation === 1 && ' Serving'}
            {rotationType} Rotation
          </p>
        </div>
        
        <button 
          onClick={() => animateRotation('next')}
          className="w-10 h-10 rounded-full bg-slate-600 text-white flex items-center justify-center hover:bg-slate-500 transition"
        >
          ‚Üí
        </button>
      </div>
      
      {/* Rotation indicator dots */}
      <div className="flex justify-center gap-2">
        {[1, 2, 3, 4, 5, 6].map(rot => (
          <button
            key={rot}
            onClick={() => onRotationChange(rot)}
            className={`w-3 h-3 rounded-full transition-all ${
              currentRotation === rot 
                ? 'bg-[var(--accent-primary)] scale-125' 
                : 'bg-slate-500 hover:bg-slate-400'
            }`}
          />
        ))}
      </div>
      
      {/* Animation overlay */}
      {isAnimating && (
        <div className="absolute inset-0 flex items-center justify-center bg-black/20 rounded-xl">
          <div className="flex items-center justify-center"><VolleyballIcon className="w-12 h-12 animate-spin" /></div>
        </div>
      )}
    </div>
  )
}

// ============================================
// MAIN LINEUP BUILDER COMPONENT
// ============================================
function LineupBuilder({ event, team, onClose, showToast }) {
  const { user } = useAuth()
  const tc = useThemeClasses()
  const { isDark } = useTheme()
  
  // State
  const [loading, setLoading] = useState(true)
  const [saving, setSaving] = useState(false)
  const [roster, setRoster] = useState([])
  const [rsvps, setRsvps] = useState({})
  const [positions, setPositions] = useState({}) // { courtPosition: player }
  const [rotationType, setRotationType] = useState('5-1')
  const [useLibero, setUseLibero] = useState(true)
  const [liberoPlayer, setLiberoPlayer] = useState(null)
  const [currentSet, setCurrentSet] = useState(1)
  const [totalSets, setTotalSets] = useState(3)
  const [currentRotation, setCurrentRotation] = useState(1)
  const [captain, setCaptain] = useState(null)
  const [coCaptain, setCoCaptain] = useState(null)
  const [selectedPlayer, setSelectedPlayer] = useState(null)
  const [draggedPlayer, setDraggedPlayer] = useState(null)
  const [lineupId, setLineupId] = useState(null)
  const [previousResults, setPreviousResults] = useState([])
  const [activeTab, setActiveTab] = useState('lineup') // 'lineup', 'sets', 'history'
  
  useEffect(() => {
    loadData()
  }, [event?.id, team?.id])
  
  async function loadData() {
    setLoading(true)
    try {
      // Load team roster with positions
      const { data: players } = await supabase
        .from('team_players')
        .select(`
          player_id,
          jersey_number,
          position,
          players (
            id, first_name, last_name, photo_url, jersey_number,
            parent_name, parent_phone, medical_conditions, allergies,
            player_positions (primary_position, secondary_position, skill_rating, serve_rating, attack_rating, defense_rating, is_captain, can_play_libero)
          )
        `)
        .eq('team_id', team.id)
      
      const enrichedRoster = (players || []).map(tp => ({
        ...tp.players,
        jersey_number: tp.jersey_number || tp.players?.jersey_number,
        primary_position: tp.players?.player_positions?.[0]?.primary_position || tp.position || 'UT',
        secondary_position: tp.players?.player_positions?.[0]?.secondary_position,
        skill_rating: tp.players?.player_positions?.[0]?.skill_rating || 50,
        serve_rating: tp.players?.player_positions?.[0]?.serve_rating || 50,
        attack_rating: tp.players?.player_positions?.[0]?.attack_rating || 50,
        defense_rating: tp.players?.player_positions?.[0]?.defense_rating || 50,
        is_captain: tp.players?.player_positions?.[0]?.is_captain,
        can_play_libero: tp.players?.player_positions?.[0]?.can_play_libero,
      }))
      
      setRoster(enrichedRoster)
      
      // Load RSVPs for this event
      const { data: rsvpData } = await supabase
        .from('event_rsvps')
        .select('player_id, status')
        .eq('event_id', event.id)
      
      const rsvpMap = {}
      rsvpData?.forEach(r => { rsvpMap[r.player_id] = r.status })
      setRsvps(rsvpMap)
      
      // Load existing lineup if any
      const { data: existingLineup } = await supabase
        .from('game_lineups')
        .select('*, lineup_positions(*)')
        .eq('event_id', event.id)
        .eq('team_id', team.id)
        .maybeSingle()
      
      if (existingLineup) {
        setLineupId(existingLineup.id)
        setRotationType(existingLineup.rotation_type || '5-1')
        setUseLibero(existingLineup.use_libero)
        setTotalSets(existingLineup.total_sets || 3)
        
        // Set captain
        if (existingLineup.captain_player_id) {
          setCaptain(enrichedRoster.find(p => p.id === existingLineup.captain_player_id))
        }
        
        // Load positions for current set/rotation
        const posMap = {}
        existingLineup.lineup_positions
          ?.filter(lp => lp.set_number === currentSet && lp.rotation_number === currentRotation)
          .forEach(lp => {
            const player = enrichedRoster.find(p => p.id === lp.player_id)
            if (player) posMap[lp.court_position] = player
          })
        setPositions(posMap)
      }
      
      // Load previous game results vs same opponent
      if (event.opponent_name) {
        const { data: history } = await supabase
          .from('game_results')
          .select('*')
          .eq('team_id', team.id)
          .ilike('opponent_name', `%${event.opponent_name}%`)
          .order('recorded_at', { ascending: false })
          .limit(5)
        
        setPreviousResults(history || [])
      }
      
    } catch (err) {
      console.error('Error loading lineup data:', err)
      showToast?.('Error loading lineup data', 'error')
    }
    setLoading(false)
  }
  
  // Drag handlers
  function handleDragStart(e, player) {
    setDraggedPlayer(player)
    e.dataTransfer.effectAllowed = 'move'
  }
  
  function handleDragOver(e) {
    e.preventDefault()
    e.dataTransfer.dropEffect = 'move'
  }
  
  function handleDrop(e, courtPosition) {
    e.preventDefault()
    if (!draggedPlayer) return
    
    // Check RSVP status
    const rsvpStatus = rsvps[draggedPlayer.id]
    if (!rsvpStatus || rsvpStatus === 'pending' || rsvpStatus === 'no') {
      const confirmPlace = window.confirm(
        `‚ö†Ô∏è ${draggedPlayer.first_name} has not confirmed attendance.\n\nRSVP Status: ${rsvpStatus || 'No response'}\n\nPlace anyway?`
      )
      if (!confirmPlace) {
        setDraggedPlayer(null)
        return
      }
    }
    
    // Remove from any existing position
    const newPositions = { ...positions }
    Object.keys(newPositions).forEach(pos => {
      if (newPositions[pos]?.id === draggedPlayer.id) {
        delete newPositions[pos]
      }
    })
    
    // Place in new position
    newPositions[courtPosition] = draggedPlayer
    setPositions(newPositions)
    setDraggedPlayer(null)
  }
  
  function removeFromCourt(courtPosition) {
    const newPositions = { ...positions }
    delete newPositions[courtPosition]
    setPositions(newPositions)
  }
  
  // Auto-fill lineup based on positions and ratings
  function autoFillLineup() {
    const config = ROTATION_CONFIGS[rotationType]
    const availablePlayers = roster.filter(p => {
      const rsvp = rsvps[p.id]
      return rsvp === 'attending' || rsvp === 'yes'
    })
    
    const newPositions = {}
    const usedPlayers = new Set()
    
    // For 6-6, just fill positions 1-6 with highest rated available
    if (rotationType === '6-6') {
      const sorted = [...availablePlayers].sort((a, b) => (b.skill_rating || 50) - (a.skill_rating || 50))
      sorted.slice(0, 6).forEach((player, idx) => {
        newPositions[idx + 1] = player
      })
    } else {
      // Try to match positions
      config.positions.forEach((posNeeded, idx) => {
        const courtPos = idx + 1
        
        // Find best available player for this position
        const candidates = availablePlayers
          .filter(p => !usedPlayers.has(p.id))
          .sort((a, b) => {
            const aMatch = a.primary_position === posNeeded ? 100 : (a.secondary_position === posNeeded ? 50 : 0)
            const bMatch = b.primary_position === posNeeded ? 100 : (b.secondary_position === posNeeded ? 50 : 0)
            return (bMatch + (b.skill_rating || 50)) - (aMatch + (a.skill_rating || 50))
          })
        
        if (candidates[0]) {
          newPositions[courtPos] = candidates[0]
          usedPlayers.add(candidates[0].id)
        }
      })
    }
    
    setPositions(newPositions)
    showToast?.('Lineup auto-filled!', 'success')
  }
  
  // Save lineup
  async function saveLineup(publish = false) {
    setSaving(true)
    try {
      // Create or update lineup record
      const lineupData = {
        event_id: event.id,
        team_id: team.id,
        rotation_type: rotationType,
        use_libero: useLibero,
        libero_player_id: liberoPlayer?.id,
        total_sets: totalSets,
        captain_player_id: captain?.id,
        co_captain_player_id: coCaptain?.id,
        is_published: publish,
        published_at: publish ? new Date().toISOString() : null,
        created_by: user?.id,
        updated_at: new Date().toISOString()
      }
      
      let savedLineupId = lineupId
      
      if (lineupId) {
        await supabase.from('game_lineups').update(lineupData).eq('id', lineupId)
      } else {
        const { data: newLineup } = await supabase
          .from('game_lineups')
          .insert(lineupData)
          .select()
          .single()
        savedLineupId = newLineup.id
        setLineupId(savedLineupId)
      }
      
      // Save positions
      // First delete existing positions for this set/rotation
      await supabase
        .from('lineup_positions')
        .delete()
        .eq('lineup_id', savedLineupId)
        .eq('set_number', currentSet)
        .eq('rotation_number', currentRotation)
      
      // Insert new positions
      const positionRecords = Object.entries(positions).map(([pos, player]) => ({
        lineup_id: savedLineupId,
        set_number: currentSet,
        rotation_number: currentRotation,
        court_position: parseInt(pos),
        player_id: player.id,
        is_serving: currentRotation === 1 && parseInt(pos) === 1,
        is_libero_in: player.id === liberoPlayer?.id
      }))
      
      if (positionRecords.length > 0) {
        await supabase.from('lineup_positions').insert(positionRecords)
      }
      
      showToast?.(publish ? 'Lineup published!' : 'Lineup saved!', 'success')
      
    } catch (err) {
      console.error('Error saving lineup:', err)
      showToast?.('Error saving lineup', 'error')
    }
    setSaving(false)
  }
  
  // Get players on bench (not on court)
  const benchPlayers = roster.filter(p => 
    !Object.values(positions).find(cp => cp?.id === p.id)
  )
  
  if (loading) {
    return (
      <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div className={`${tc.cardBg} rounded-2xl p-8 text-center`}>
          <div className="animate-spin w-12 h-12 border-4 border-[var(--accent-primary)] border-t-transparent rounded-full mx-auto mb-4" />
          <p className={tc.text}>Loading lineup builder...</p>
        </div>
      </div>
    )
  }

  return (
    <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-2">
      <div className={`${tc.cardBg} rounded-2xl shadow-2xl w-full max-w-5xl max-h-[92vh] overflow-hidden flex flex-col`}>
        {/* Header - Compact */}
        <div className={`p-3 border-b ${tc.border} flex items-center justify-between flex-shrink-0`}>
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 rounded-xl bg-[var(--accent-primary)]/20 flex items-center justify-center">
              <Target className="w-5 h-5 text-[var(--accent-primary)]" />
            </div>
            <div>
              <h2 className={`text-lg font-bold ${tc.text}`}>Game Prep: {event?.title || 'vs TBD'}</h2>
              <p className={`text-xs ${tc.textMuted}`}>
                {event?.event_date && new Date(event.event_date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}
                {event?.event_time && ` ‚Ä¢ ${event.event_time}`}
                {' ‚Ä¢ '}{team?.name}
              </p>
            </div>
          </div>
          <button onClick={onClose} className={`w-8 h-8 rounded-full ${tc.hoverBg} flex items-center justify-center text-lg`}>
            ‚úï
          </button>
        </div>
        
        {/* Tabs - Compact */}
        <div className={`flex border-b ${tc.border} flex-shrink-0`}>
          {[
            { id: 'lineup', label: 'Lineup', icon: 'volleyball' },
            { id: 'sets', label: 'Sets', icon: 'clipboard' },
            { id: 'history', label: 'History', icon: 'bar-chart' },
          ].map(tab => (
            <button
              key={tab.id}
              onClick={() => setActiveTab(tab.id)}
              className={`flex-1 px-3 py-2 text-sm font-medium transition ${
                activeTab === tab.id
                  ? 'border-b-2 border-[var(--accent-primary)] text-[var(--accent-primary)]'
                  : `${tc.textMuted} ${tc.hoverBg}`
              }`}
            >
              {tab.icon} {tab.label}
            </button>
          ))}
        </div>
        
        {/* Content - Fills remaining space */}
        <div className="flex-1 overflow-auto p-3">
          {activeTab === 'lineup' && (
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-4 h-full">
              {/* Court Section - takes up most space */}
              <div className="lg:col-span-2 flex flex-col gap-3">
                {/* Rotation Controls - Compact inline */}
                <div className={`${tc.cardBgAlt} rounded-xl p-3 flex flex-wrap items-center gap-3`}>
                  <div className="flex items-center gap-2">
                    <label className={`text-xs ${tc.textMuted}`}>Type:</label>
                    <select 
                      value={rotationType}
                      onChange={e => setRotationType(e.target.value)}
                      className={`px-2 py-1.5 rounded-lg text-sm ${tc.input}`}
                    >
                      {Object.entries(ROTATION_CONFIGS).map(([key, config]) => (
                        <option key={key} value={key}>{config.name}</option>
                      ))}
                    </select>
                  </div>
                  
                  {ROTATION_CONFIGS[rotationType].liberoOptional && (
                    <label className="flex items-center gap-1.5 cursor-pointer text-sm">
                      <input 
                        type="checkbox" 
                        checked={useLibero}
                        onChange={e => setUseLibero(e.target.checked)}
                        className="w-4 h-4 rounded"
                      />
                      <span className={tc.text}>Libero</span>
                    </label>
                  )}
                  
                  <div className="flex items-center gap-2">
                    <label className={`text-xs ${tc.textMuted}`}>Sets:</label>
                    <select 
                      value={totalSets}
                      onChange={e => setTotalSets(parseInt(e.target.value))}
                      className={`px-2 py-1.5 rounded-lg text-sm ${tc.input}`}
                    >
                      <option value={3}>Best of 3</option>
                      <option value={5}>Best of 5</option>
                    </select>
                  </div>
                  
                  <button
                    onClick={autoFillLineup}
                    className="px-3 py-1.5 rounded-lg bg-emerald-500 text-white text-sm font-medium hover:bg-emerald-600 transition ml-auto"
                  >
                    ‚ú® Auto-Fill
                  </button>
                </div>
                
                {/* Rotation Navigator - Compact */}
                <div className={`${tc.cardBgAlt} rounded-xl p-2 flex items-center justify-between`}>
                  <button 
                    onClick={() => setCurrentRotation(r => r === 1 ? 6 : r - 1)}
                    className="w-8 h-8 rounded-full bg-[var(--accent-primary)] text-white flex items-center justify-center hover:brightness-110 transition text-sm"
                  >
                    ‚Üê
                  </button>
                  
                  <div className="flex items-center gap-2">
                    {[1, 2, 3, 4, 5, 6].map(rot => (
                      <button
                        key={rot}
                        onClick={() => setCurrentRotation(rot)}
                        className={`w-7 h-7 rounded-full flex items-center justify-center text-xs font-bold transition ${
                          currentRotation === rot 
                            ? 'bg-[var(--accent-primary)] text-white scale-110' 
                            : `${tc.cardBg} ${tc.textMuted} hover:bg-[var(--accent-primary)]/20`
                        }`}
                      >
                        {rot === 1 ? 'practice' : rot}
                      </button>
                    ))}
                  </div>
                  
                  <button 
                    onClick={() => setCurrentRotation(r => r === 6 ? 1 : r + 1)}
                    className="w-8 h-8 rounded-full bg-[var(--accent-primary)] text-white flex items-center justify-center hover:brightness-110 transition text-sm"
                  >
                    ‚Üí
                  </button>
                </div>
                
                {/* The Court - Compact */}
                <div className={`${tc.cardBgAlt} rounded-xl p-3`}>
                  <VolleyballCourt isDark={isDark} showServeIndicator={true} servingPosition={currentRotation === 1 ? 1 : null} compact={true}>
                    {/* Render court positions */}
                    {Object.entries(COURT_POSITIONS).map(([pos, coords]) => {
                      const player = positions[pos]
                      const isServing = currentRotation === 1 && parseInt(pos) === 1
                      // Get the expected position abbreviation for this slot based on rotation type
                      const rotConfig = ROTATION_CONFIGS[rotationType]
                      const posIndex = parseInt(pos) - 1
                      const expectedPos = rotConfig.positions[posIndex] || coords.defaultPos || 'UT'
                      const posColor = POSITION_COLORS[expectedPos] || '#6366F1'
                      
                      return (
                        <div
                          key={pos}
                          className={`absolute transform -translate-x-1/2 -translate-y-1/2 transition-all duration-300 ${
                            draggedPlayer ? 'ring-2 ring-dashed ring-[var(--accent-primary)] rounded-xl' : ''
                          }`}
                          style={{ 
                            left: `${coords.x}%`, 
                            top: `${coords.y}%`,
                          }}
                          onDragOver={handleDragOver}
                          onDrop={(e) => handleDrop(e, parseInt(pos))}
                        >
                          {player ? (
                            <div className="relative">
                              <PlayerIcon
                                player={player}
                                position={pos}
                                isServing={isServing}
                                isLibero={player.id === liberoPlayer?.id}
                                isCaptain={player.id === captain?.id}
                                hasRsvp={!!rsvps[player.id]}
                                rsvpStatus={rsvps[player.id]}
                                isDark={isDark}
                                onClick={setSelectedPlayer}
                                onDragStart={handleDragStart}
                                isOnCourt={true}
                                size="small"
                              />
                              <button
                                onClick={() => removeFromCourt(pos)}
                                className="absolute -top-1 -right-1 w-4 h-4 rounded-full bg-red-500 text-white text-[10px] flex items-center justify-center hover:bg-red-600"
                              >
                                ‚úï
                              </button>
                            </div>
                          ) : (
                            /* Empty slot shows position abbreviation */
                            <div 
                              className="w-11 h-11 rounded-lg border-2 border-dashed flex flex-col items-center justify-center cursor-pointer hover:border-solid transition-all"
                              style={{ 
                                borderColor: posColor,
                                backgroundColor: isDark ? 'rgba(0,0,0,0.4)' : 'rgba(255,255,255,0.8)'
                              }}
                            >
                              <span className="text-xs font-bold" style={{ color: posColor }}>{expectedPos}</span>
                            </div>
                          )}
                        </div>
                      )
                    })}
                  </VolleyballCourt>
                </div>
                
                {/* Captains - Compact inline */}
                <div className={`${tc.cardBgAlt} rounded-xl p-3`}>
                  <div className="flex items-center gap-3">
                    <span className={`text-sm font-medium ${tc.text}`}>Captains:</span>
                    <select 
                      value={captain?.id || ''}
                      onChange={e => setCaptain(roster.find(p => p.id === e.target.value))}
                      className={`flex-1 px-2 py-1.5 rounded-lg text-sm ${tc.input}`}
                    >
                      <option value="">Captain...</option>
                      {roster.map(p => (
                        <option key={p.id} value={p.id}>#{p.jersey_number} {p.first_name}</option>
                      ))}
                    </select>
                    <select 
                      value={coCaptain?.id || ''}
                      onChange={e => setCoCaptain(roster.find(p => p.id === e.target.value))}
                      className={`flex-1 px-2 py-1.5 rounded-lg text-sm ${tc.input}`}
                    >
                      <option value="">Co-Captain...</option>
                      {roster.filter(p => p.id !== captain?.id).map(p => (
                        <option key={p.id} value={p.id}>#{p.jersey_number} {p.first_name}</option>
                      ))}
                    </select>
                  </div>
                </div>
              </div>
              
              {/* Roster Panel - Compact */}
              <div className="flex flex-col gap-3">
                <div className={`${tc.cardBgAlt} rounded-xl p-3 flex-1`}>
                  <div className="flex items-center justify-between mb-2">
                    <h3 className={`font-semibold ${tc.text} text-sm`}>Roster ({roster.length})</h3>
                    <span className={`text-xs ${tc.textMuted}`}>Drag to court</span>
                  </div>
                  
                  {/* Legend - Compact */}
                  <div className="flex gap-2 mb-2 text-[10px]">
                    <span className="px-1.5 py-0.5 rounded bg-emerald-500/20 text-emerald-500">‚úì</span>
                    <span className="px-1.5 py-0.5 rounded bg-amber-500/20 text-amber-500">?</span>
                    <span className="px-1.5 py-0.5 rounded bg-red-500/20 text-red-500"><X className="w-4 h-4" /></span>
                  </div>
                  
                  {/* Players grid - Compact */}
                  <div className="grid grid-cols-4 gap-2 max-h-[180px] overflow-y-auto">
                    {roster.length === 0 ? (
                      <div className={`col-span-4 text-center py-4 ${tc.textMuted} text-sm`}>
                        No players on roster
                      </div>
                    ) : benchPlayers.length === 0 ? (
                      <div className={`col-span-4 text-center py-4 ${tc.textMuted} text-sm`}>
                        All players on court
                      </div>
                    ) : (
                      benchPlayers.map(player => {
                        const rsvpStatus = rsvps[player.id]
                        const isGoing = rsvpStatus === 'attending' || rsvpStatus === 'yes'
                        const isPending = !rsvpStatus || rsvpStatus === 'pending'
                        const posColor = POSITION_COLORS[player.primary_position] || '#6366F1'
                        
                        return (
                          <div 
                            key={player.id}
                            draggable
                            onDragStart={(e) => handleDragStart(e, player)}
                            onClick={() => setSelectedPlayer(player)}
                            className={`relative cursor-grab active:cursor-grabbing ${!isGoing ? 'opacity-60' : ''}`}
                          >
                            <div 
                              className={`w-full aspect-square rounded-lg flex flex-col items-center justify-center border-2 transition hover:scale-105 ${tc.cardBg}`}
                              style={{ borderColor: posColor }}
                            >
                              {player.photo_url ? (
                                <img src={player.photo_url} alt="" className="w-8 h-8 rounded-full object-cover" />
                              ) : (
                                <div className="w-8 h-8 rounded-full flex items-center justify-center text-white text-xs font-bold" style={{ backgroundColor: posColor }}>
                                  {player.jersey_number || '?'}
                                </div>
                              )}
                              <span className={`text-[10px] font-medium ${tc.text} mt-0.5 truncate w-full text-center px-1`}>
                                {player.first_name?.slice(0, 6)}
                              </span>
                            </div>
                            {/* RSVP badge */}
                            <div className={`absolute -top-1 -right-1 w-4 h-4 rounded-full flex items-center justify-center text-[8px] ${
                              isGoing ? 'bg-emerald-500 text-white' : 
                              isPending ? 'bg-amber-500 text-white' : 
                              'bg-red-500 text-white'
                            }`}>
                              {isGoing ? '‚úì' : isPending ? '?' : '‚úï'}
                            </div>
                          </div>
                        )
                      })
                    )}
                  </div>
                </div>
                
                {/* On Court Summary - Compact */}
                <div className={`${tc.cardBgAlt} rounded-xl p-3`}>
                  <h3 className={`font-semibold ${tc.text} text-sm mb-2`}>On Court ({Object.keys(positions).length}/6)</h3>
                  <div className="grid grid-cols-2 gap-1.5">
                    {[1, 2, 3, 4, 5, 6].map(pos => {
                      const player = positions[pos]
                      const coords = COURT_POSITIONS[pos]
                      const rotConfig = ROTATION_CONFIGS[rotationType]
                      const expectedPos = rotConfig.positions[pos - 1] || coords?.defaultPos || 'UT'
                      
                      return (
                        <div key={pos} className={`flex items-center gap-1.5 p-1.5 rounded-lg ${tc.cardBg}`}>
                          <span className={`w-5 h-5 rounded flex items-center justify-center text-[10px] font-bold text-white`}
                            style={{ backgroundColor: POSITION_COLORS[player?.primary_position || expectedPos] || '#6366F1' }}
                          >
                            {pos}
                          </span>
                          <span className={`flex-1 text-xs truncate ${player ? tc.text : tc.textMuted}`}>
                            {player ? `#${player.jersey_number} ${player.first_name}` : expectedPos}
                          </span>
                        </div>
                      )
                    })}
                  </div>
                </div>
              </div>
            </div>
          )}
          
          {activeTab === 'sets' && (
            <div className="space-y-4">
              <div className={`${tc.cardBgAlt} rounded-xl p-4`}>
                <h3 className={`font-semibold ${tc.text} mb-4 flex items-center gap-2`}><ClipboardList className="w-5 h-5" />Set-by-Set Planning</h3>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  {Array.from({ length: totalSets }, (_, i) => i + 1).map(setNum => (
                    <div 
                      key={setNum}
                      className={`${tc.cardBg} rounded-xl p-4 cursor-pointer transition ${
                        currentSet === setNum ? 'ring-2 ring-[var(--accent-primary)]' : ''
                      }`}
                      onClick={() => setCurrentSet(setNum)}
                    >
                      <h4 className={`font-bold ${tc.text} mb-2`}>Set {setNum}</h4>
                      <p className={`text-xs ${tc.textMuted}`}>
                        {currentSet === setNum ? 'Currently editing' : 'Click to edit'}
                      </p>
                    </div>
                  ))}
                </div>
              </div>
              
              <div className={`${tc.cardBgAlt} rounded-xl p-4 text-center`}>
                <span className="text-4xl">üöß</span>
                <p className={`${tc.text} mt-2`}>Advanced set planning coming soon!</p>
                <p className={`text-sm ${tc.textMuted}`}>Plan different lineups for each set, manage substitutions</p>
              </div>
            </div>
          )}
          
          {activeTab === 'history' && (
            <div className="space-y-4">
              <div className={`${tc.cardBgAlt} rounded-xl p-4`}>
                <h3 className={`font-semibold ${tc.text} mb-4 flex items-center gap-2`}><BarChart3 className="w-5 h-5" />Previous Results vs {event?.opponent_name || 'Opponents'}</h3>
                {previousResults.length > 0 ? (
                  <div className="space-y-3">
                    {previousResults.map(result => (
                      <div key={result.id} className={`${tc.cardBg} rounded-xl p-4 flex items-center gap-4`}>
                        <div className={`w-12 h-12 rounded-xl flex items-center justify-center font-bold text-white ${
                          result.result === 'win' ? 'bg-emerald-500' : 'bg-red-500'
                        }`}>
                          {result.result === 'win' ? 'W' : 'L'}
                        </div>
                        <div className="flex-1">
                          <p className={tc.text}>vs {result.opponent_name}</p>
                          <p className={`text-sm ${tc.textMuted}`}>
                            {new Date(result.recorded_at).toLocaleDateString()}
                          </p>
                        </div>
                        <div className="text-right">
                          <p className={`text-xl font-bold ${tc.text}`}>
                            {result.sets_won}-{result.sets_lost}
                          </p>
                          <p className={`text-xs ${tc.textMuted}`}>Sets</p>
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="text-center py-8">
                    <BarChart3 className="w-12 h-12" />
                    <p className={`${tc.textMuted} mt-2`}>No previous games against this opponent</p>
                  </div>
                )}
              </div>
            </div>
          )}
        </div>
        
        {/* Footer Actions - Compact */}
        <div className={`p-3 border-t ${tc.border} flex items-center justify-between flex-shrink-0`}>
          <span className={`text-sm ${tc.textMuted}`}>Set {currentSet} ‚Ä¢ Rot {currentRotation}</span>
          <div className="flex gap-2">
            <button
              onClick={onClose}
              className={`px-4 py-1.5 rounded-lg ${tc.cardBg} border ${tc.border} ${tc.text} text-sm font-medium hover:opacity-80 transition`}
            >
              Close
            </button>
            <button
              onClick={() => saveLineup(false)}
              disabled={saving}
              className={`px-4 py-1.5 rounded-lg bg-slate-600 text-white text-sm font-medium hover:bg-slate-500 transition disabled:opacity-50`}
            >
              {saving ? '...' : 'üíæ Draft'}
            </button>
            <button
              onClick={() => saveLineup(true)}
              disabled={saving || Object.keys(positions).length < 6}
              className={`px-4 py-1.5 rounded-lg bg-[var(--accent-primary)] text-white text-sm font-medium hover:brightness-110 transition disabled:opacity-50`}
            >
              Publish
            </button>
          </div>
        </div>
      </div>
      
      {/* Player Card Modal */}
      {selectedPlayer && (
        <GamePlayerCard 
          player={selectedPlayer} 
          onClose={() => setSelectedPlayer(null)}
          isDark={isDark}
        />
      )}
    </div>
  )
}

// Export for use in main app
// Usage: <LineupBuilder event={event} team={team} onClose={() => {}} showToast={showToast} />

// ============================================
// GAME PREP PAGE
// Lists upcoming games with lineup status
// ============================================

function GamePrepPage({ showToast }) {
  const { organization } = useAuth()
  const { selectedSeason } = useSeason()
  const tc = useThemeClasses()
  const { isDark } = useTheme()
  
  const [loading, setLoading] = useState(true)
  const [games, setGames] = useState([])
  const [teams, setTeams] = useState([])
  const [selectedTeam, setSelectedTeam] = useState(null)
  const [selectedGame, setSelectedGame] = useState(null)
  const [lineupStatuses, setLineupStatuses] = useState({})

  useEffect(() => {
    loadTeams()
  }, [selectedSeason?.id])

  useEffect(() => {
    if (selectedTeam) loadGames()
  }, [selectedTeam])

  async function loadTeams() {
    if (!selectedSeason?.id) return
    
    try {
      const { data } = await supabase
        .from('teams')
        .select('id, name, color')
        .eq('season_id', selectedSeason.id)
        .order('name')
      
      setTeams(data || [])
      if (data?.length > 0) setSelectedTeam(data[0])
    } catch (err) {
      console.error('Error loading teams:', err)
    }
  }

  async function loadGames() {
    if (!selectedTeam?.id) return
    setLoading(true)
    
    try {
      const today = new Date().toISOString().split('T')[0]
      
      // Load upcoming games
      const { data: gamesData } = await supabase
        .from('schedule_events')
        .select('*')
        .eq('team_id', selectedTeam.id)
        .eq('event_type', 'game')
        .gte('event_date', today)
        .order('event_date', { ascending: true })
        .order('event_time', { ascending: true })
        .limit(20)
      
      setGames(gamesData || [])
      
      // Load lineup statuses for these games
      if (gamesData?.length > 0) {
        const eventIds = gamesData.map(g => g.id)
        const { data: lineups } = await supabase
          .from('game_lineups')
          .select('event_id, is_published, rotation_type')
          .in('event_id', eventIds)
        
        const statusMap = {}
        lineups?.forEach(l => {
          statusMap[l.event_id] = {
            hasLineup: true,
            isPublished: l.is_published,
            rotationType: l.rotation_type
          }
        })
        setLineupStatuses(statusMap)
      }
      
    } catch (err) {
      console.error('Error loading games:', err)
    }
    setLoading(false)
  }

  function getLineupStatus(gameId) {
    const status = lineupStatuses[gameId]
    if (!status) return { label: 'Not Started', color: 'text-slate-400', bg: 'bg-slate-500/20' }
    if (status.isPublished) return { label: 'Published', color: 'text-emerald-500', bg: 'bg-emerald-500/20' }
    return { label: 'Draft', color: 'text-amber-500', bg: 'bg-amber-500/20' }
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-start justify-between">
        <div>
          <h1 className={`text-3xl font-bold ${tc.text}`}><VolleyballIcon className="w-7 h-7 inline mr-2" />Game Prep</h1>
          <p className={tc.textSecondary}>Build lineups and prepare for upcoming games</p>
        </div>
      </div>

      {/* Team Selector */}
      <div className={`${tc.cardBg} border ${tc.border} rounded-2xl p-4`}>
        <div className="flex items-center gap-4 overflow-x-auto pb-2">
          {teams.map(team => (
            <button
              key={team.id}
              onClick={() => setSelectedTeam(team)}
              className={`px-4 py-2 rounded-xl whitespace-nowrap flex items-center gap-2 transition font-medium ${
                selectedTeam?.id === team.id
                  ? 'text-white shadow-lg'
                  : `${tc.cardBgAlt} ${tc.textSecondary} ${tc.hoverBg}`
              }`}
              style={selectedTeam?.id === team.id ? { backgroundColor: team.color } : {}}
            >
              <span className="w-3 h-3 rounded-full" style={{ backgroundColor: team.color }} />
              {team.name}
            </button>
          ))}
        </div>
      </div>

      {/* Games List */}
      {loading ? (
        <div className="flex items-center justify-center py-12">
          <div className="animate-spin w-8 h-8 border-2 border-[var(--accent-primary)] border-t-transparent rounded-full" />
        </div>
      ) : games.length > 0 ? (
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          {games.map(game => {
            const status = getLineupStatus(game.id)
            const gameDate = new Date(game.event_date)
            const isToday = gameDate.toDateString() === new Date().toDateString()
            const isTomorrow = gameDate.toDateString() === new Date(Date.now() + 86400000).toDateString()
            
            return (
              <div 
                key={game.id}
                className={`${tc.cardBg} border ${tc.border} rounded-2xl p-5 hover:border-[var(--accent-primary)]/50 transition cursor-pointer`}
                onClick={() => setSelectedGame(game)}
              >
                <div className="flex items-start gap-4">
                  {/* Date */}
                  <div 
                    className="w-16 h-16 rounded-xl flex flex-col items-center justify-center text-white"
                    style={{ backgroundColor: selectedTeam?.color || '#6366F1' }}
                  >
                    <span className="text-xs uppercase">{gameDate.toLocaleDateString('en-US', { weekday: 'short' })}</span>
                    <span className="text-2xl font-bold">{gameDate.getDate()}</span>
                  </div>
                  
                  {/* Game Info */}
                  <div className="flex-1">
                    <div className="flex items-center gap-2">
                      <h3 className={`font-bold ${tc.text}`}>
                        {game.title || `vs ${game.opponent_name || 'TBD'}`}
                      </h3>
                      {isToday && (
                        <span className="px-2 py-0.5 rounded-full text-xs font-bold bg-red-500/20 text-red-500">TODAY</span>
                      )}
                      {isTomorrow && (
                        <span className="px-2 py-0.5 rounded-full text-xs font-bold bg-amber-500/20 text-amber-500">TOMORROW</span>
                      )}
                    </div>
                    <p className={`text-sm ${tc.textMuted}`}>
                      {game.event_time && formatTime12(game.event_time)}
                      {game.venue_name && ` ‚Ä¢ ${game.venue_name}`}
                    </p>
                    <div className="flex items-center gap-2 mt-2">
                      <span className={`px-2 py-1 rounded-full text-xs font-medium ${status.bg} ${status.color}`}>
                        {status.label}
                      </span>
                      {lineupStatuses[game.id]?.rotationType && (
                        <span className={`text-xs ${tc.textMuted}`}>
                          {lineupStatuses[game.id].rotationType}
                        </span>
                      )}
                    </div>
                  </div>
                  
                  {/* Action */}
                  <button 
                    className="px-4 py-2 rounded-xl bg-[var(--accent-primary)] text-white font-medium hover:brightness-110 transition"
                    onClick={(e) => { e.stopPropagation(); setSelectedGame(game); }}
                  >
                    {lineupStatuses[game.id] ? 'Edit' : 'Prep'} ‚Üí
                  </button>
                </div>
              </div>
            )
          })}
        </div>
      ) : (
        <div className={`${tc.cardBg} border ${tc.border} rounded-2xl p-12 text-center`}>
          <span className="text-6xl"><VolleyballIcon className="w-16 h-16" /></span>
          <h2 className={`text-xl font-bold ${tc.text} mt-4`}>No Upcoming Games</h2>
          <p className={tc.textMuted}>Schedule some games to start prepping!</p>
        </div>
      )}

      {/* Past Games Section */}
      <div className={`${tc.cardBg} border ${tc.border} rounded-2xl p-5`}>
        <h2 className={`font-semibold ${tc.text} mb-4 flex items-center gap-2`}>
          <BarChart3 className="w-5 h-5" /> Recent Game Results
        </h2>
        <div className="text-center py-6">
          <span className="text-4xl">üöß</span>
          <p className={`${tc.textMuted} mt-2`}>Game results will appear here after you record scores</p>
        </div>
      </div>

      {/* Lineup Builder Modal */}
      {selectedGame && selectedTeam && (
        <LineupBuilder
          event={selectedGame}
          team={selectedTeam}
          onClose={() => { setSelectedGame(null); loadGames(); }}
          showToast={showToast}
        />
      )}
    </div>
  )
}

// ============================================
// MAIN DASHBOARD LAYOUT
// ============================================
function MainApp() {
  const { profile, organization, signOut, user } = useAuth()
  const tc = useThemeClasses()
  const { isDark, colors } = useTheme()
  const [page, setPage] = useState('dashboard')
  const [sidebarCollapsed, setSidebarCollapsed] = useState(false)
  const [toast, setToast] = useState(null)
  
  // Direct team wall access via URL hash
  const [directTeamWallId, setDirectTeamWallId] = useState(null)

  // Parse hash on load and hash changes
  useEffect(() => {
    function handleHashChange() {
      const hash = window.location.hash
      // Pattern: #/team/<team-id>
      const teamMatch = hash.match(/^#\/team\/(.+)$/)
      if (teamMatch) {
        setDirectTeamWallId(teamMatch[1])
      } else {
        setDirectTeamWallId(null)
      }
    }
    
    // Check on mount
    handleHashChange()
    
    // Listen for changes
    window.addEventListener('hashchange', handleHashChange)
    return () => window.removeEventListener('hashchange', handleHashChange)
  }, [])

  // Helper to navigate to team wall (updates URL)
  const navigateToTeamWall = (teamId) => {
    window.location.hash = `/team/${teamId}`
  }

  // Helper to exit team wall view
  const exitTeamWall = () => {
    window.location.hash = ''
    setDirectTeamWallId(null)
  }

  const showToast = (message, type = 'success') => {
    setToast({ message, type })
  }

  // Role switching state
  const [activeView, setActiveView] = useState('admin') // 'admin', 'coach', 'parent', 'player'
  const [userRoles, setUserRoles] = useState([])
  const [roleContext, setRoleContext] = useState(null)
  const [showRoleSwitcher, setShowRoleSwitcher] = useState(false)

  // Load user's role context
  useEffect(() => {
    if (profile?.id && organization?.id) {
      loadRoleContext()
    }
  }, [profile?.id, organization?.id])

  async function loadRoleContext() {
    try {
      // Get all active roles for this user in this org
      const { data: roles } = await supabase
        .from('user_roles')
        .select('*')
        .eq('user_id', profile.id)
        .eq('organization_id', organization.id)
        .eq('is_active', true)

      setUserRoles(roles || [])

      // Check if user is linked as a coach
      const { data: coachLink } = await supabase
        .from('coaches')
        .select('*, team_coaches(team_id, role, teams(id, name, color))')
        .eq('profile_id', profile.id)
        .maybeSingle()

      // Check if user has children (parent context)
      const { data: children } = await supabase
        .from('players')
        .select('id, first_name, last_name, photo_url, team_players(team_id, teams(id, name, color))')
        .eq('parent_account_id', profile.id)

      // Check if user is a player themselves
      const { data: playerSelf } = await supabase
        .from('players')
        .select('id, first_name, last_name, photo_url, team_players(team_id, teams(id, name, color))')
        .eq('player_account_id', profile.id)
        .maybeSingle()

      setRoleContext({
        roles: roles || [],
        isAdmin: roles?.some(r => r.role === 'league_admin' || r.role === 'admin'),
        isCoach: !!coachLink,
        coachInfo: coachLink,
        isParent: roles?.some(r => r.role === 'parent') && children?.length > 0,
        children: children || [],
        isPlayer: !!playerSelf,
        playerInfo: playerSelf
      })

      // Set default view based on available roles
      if (roles?.some(r => r.role === 'league_admin' || r.role === 'admin')) {
        setActiveView('admin')
      } else if (coachLink) {
        setActiveView('coach')
      } else if (children?.length > 0) {
        setActiveView('parent')
      } else if (playerSelf) {
        setActiveView('player')
      }

    } catch (err) {
      console.error('Error loading role context:', err)
    }
  }

  // Get available views based on role context
  const getAvailableViews = () => {
    const views = []
    if (roleContext?.isAdmin) {
      views.push({ id: 'admin', label: 'Admin', icon: 'shield', description: 'Full league management' })
    }
    if (roleContext?.isCoach) {
      const teamNames = roleContext.coachInfo?.team_coaches?.map(tc => tc.teams?.name).filter(Boolean).join(', ')
      views.push({ id: 'coach', label: 'Coach', icon: 'user-cog', description: teamNames || 'Team management' })
    }
    if (roleContext?.isParent && roleContext.children?.length > 0) {
      const childNames = roleContext.children.map(c => c.first_name).join(', ')
      views.push({ id: 'parent', label: 'Parent', icon: 'users', description: childNames })
    }
    if (roleContext?.isPlayer) {
      views.push({ id: 'player', label: 'Player', icon: 'volleyball', description: roleContext.playerInfo?.first_name })
    }
    return views
  }

  const [expandedGroups, setExpandedGroups] = useState({ people: false, operations: false, game: false, communication: false, insights: false, setup: false })

  const navGroups = [
    { id: 'dashboard', label: 'Dashboard', icon: 'dashboard', type: 'single' },
    { 
      id: 'people', 
      label: 'People', 
      icon: 'users',
      type: 'group',
      items: [
        { id: 'teams', label: 'Teams & Rosters', icon: 'users' },
        { id: 'coaches', label: 'Coaches', icon: 'user-cog' },
      ]
    },
    { 
      id: 'operations', 
      label: 'Operations', 
      icon: 'zap',
      type: 'group',
      items: [
        { id: 'registrations', label: 'Registrations', icon: 'clipboard' },
        { id: 'jerseys', label: 'Jerseys', icon: 'shirt', hasBadge: true },
        { id: 'schedule', label: 'Schedule', icon: 'calendar' },
        { id: 'attendance', label: 'Attendance & RSVP', icon: 'check-square' },
        { id: 'payments', label: 'Payments', icon: 'dollar' },
      ]
    },
    { 
      id: 'game', 
      label: 'Game Day', 
      icon: 'target',
      type: 'group',
      items: [
        { id: 'gameprep', label: 'Game Prep', icon: 'target' },
      ]
    },
    { 
      id: 'communication', 
      label: 'Communication', 
      icon: 'message',
      type: 'group',
      items: [
        { id: 'chats', label: 'Chats', icon: 'message' },
        { id: 'blasts', label: 'Announcements', icon: 'megaphone' },
      ]
    },
    { 
      id: 'insights', 
      label: 'Insights', 
      icon: 'bar-chart',
      type: 'group',
      items: [
        { id: 'reports', label: 'Reports & Analytics', icon: 'pie-chart' },
      ]
    },
    { 
      id: 'setup', 
      label: 'Setup', 
      icon: 'settings',
      type: 'group',
      items: [
        { id: 'seasons', label: 'Seasons', icon: 'calendar' },
        { id: 'waivers', label: 'Waivers', icon: 'file-text' },
        { id: 'paymentsetup', label: 'Payment Setup', icon: 'credit-card' },
        { id: 'organization', label: 'Organization', icon: 'building' },
      ]
    },
  ]

  // Accordion-style toggle - only one group open at a time
  const toggleGroup = (groupId) => {
    setExpandedGroups(prev => {
      const isCurrentlyOpen = prev[groupId]
      // Close all groups, then open clicked one if it was closed
      const allClosed = { people: false, operations: false, game: false, communication: false, insights: false, setup: false }
      return isCurrentlyOpen ? allClosed : { ...allClosed, [groupId]: true }
    })
  }

  return (
    <SportProvider>
    <SeasonProvider>
      <div className={`flex flex-col min-h-screen ${tc.pageBg}`}>
        <JourneyCelebrations />
        
        {/* Top Header Bar */}
        <header className={`h-14 ${tc.cardBg} border-b ${tc.border} flex items-center justify-between px-4 fixed top-0 left-0 right-0 z-50`}>
          {/* Left: Logo */}
          <div className="flex items-center gap-3">
            <VolleyballIcon className="w-7 h-7 text-[var(--accent-primary)]" />
            <span className={`font-bold text-lg ${tc.text}`}>VolleyBrain</span>
          </div>
          
          {/* Center: Context Breadcrumb (Admin only) */}
          {activeView === 'admin' && (
            <div className="flex items-center gap-2">
              {/* Organization Badge */}
              {organization && (
                <div className="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-[var(--accent-primary)]/10 border border-[var(--accent-primary)]/30">
                  <Building2 className="w-4 h-4 text-[var(--accent-primary)]" />
                  <span className="text-sm font-medium text-[var(--accent-primary)]">{organization.name}</span>
                </div>
              )}
              
              {/* Sport Selector */}
              <HeaderSportSelector />
              
              {/* Season Selector */}
              <HeaderSeasonSelector />
            </div>
          )}
          
          {/* Center: Context - Coach View */}
          {activeView === 'coach' && roleContext?.coachInfo && (
            <div className="flex items-center gap-2">
              {/* Team Selector (if coaching multiple teams) */}
              {roleContext.coachInfo.team_coaches?.length > 1 ? (
                <HeaderCoachTeamSelector 
                  teams={roleContext.coachInfo.team_coaches} 
                  onSelectTeam={navigateToTeamWall}
                />
              ) : roleContext.coachInfo.team_coaches?.length === 1 ? (
                <div className="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-[var(--accent-primary)]/10 border border-[var(--accent-primary)]/30">
                  <Users className="w-4 h-4 text-[var(--accent-primary)]" />
                  <span className="text-sm font-medium text-[var(--accent-primary)]">
                    {roleContext.coachInfo.team_coaches[0].teams?.name}
                  </span>
                  {roleContext.coachInfo.team_coaches[0].role === 'head' && (
                    <span className="text-xs bg-[var(--accent-primary)]/20 px-1.5 py-0.5 rounded text-[var(--accent-primary)]">Head Coach</span>
                  )}
                </div>
              ) : null}
              
              {/* Season indicator */}
              <HeaderSeasonSelector />
            </div>
          )}
          
          {/* Center: Context - Parent View */}
          {activeView === 'parent' && roleContext?.children && (
            <div className="flex items-center gap-2">
              {/* Child/Player Selector */}
              {roleContext.children.length > 1 ? (
                <HeaderChildSelector 
                  children={roleContext.children}
                  onSelectChild={(childId) => setPage(`player-${childId}`)}
                  navigateToTeamWall={navigateToTeamWall}
                />
              ) : roleContext.children.length === 1 ? (
                <div className="flex items-center gap-2">
                  <div className="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-[var(--accent-primary)]/10 border border-[var(--accent-primary)]/30">
                    {roleContext.children[0].photo_url ? (
                      <img src={roleContext.children[0].photo_url} alt="" className="w-5 h-5 rounded-full object-cover" />
                    ) : (
                      <User className="w-4 h-4 text-[var(--accent-primary)]" />
                    )}
                    <span className="text-sm font-medium text-[var(--accent-primary)]">
                      {roleContext.children[0].first_name} {roleContext.children[0].last_name}
                    </span>
                  </div>
                  {/* Show team if only one */}
                  {roleContext.children[0].team_players?.length === 1 && (
                    <button 
                      onClick={() => navigateToTeamWall(roleContext.children[0].team_players[0].team_id)}
                      className={`flex items-center gap-2 px-3 py-1.5 rounded-lg ${tc.hoverBg} transition`}
                    >
                      <span 
                        className="w-3 h-3 rounded-full" 
                        style={{ background: roleContext.children[0].team_players[0].teams?.color || '#EAB308' }}
                      />
                      <span className={`text-sm ${tc.text}`}>
                        {roleContext.children[0].team_players[0].teams?.name}
                      </span>
                    </button>
                  )}
                </div>
              ) : null}
            </div>
          )}
          
          {/* Center: Context - Player View */}
          {activeView === 'player' && roleContext?.playerInfo && (
            <div className="flex items-center gap-2">
              <div className="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-[var(--accent-primary)]/10 border border-[var(--accent-primary)]/30">
                <VolleyballIcon className="w-4 h-4 text-[var(--accent-primary)]" />
                <span className="text-sm font-medium text-[var(--accent-primary)]">
                  {roleContext.playerInfo.team_players?.[0]?.teams?.name || 'My Team'}
                </span>
                {roleContext.playerInfo.team_players?.[0]?.jersey_number && (
                  <span className="text-xs bg-[var(--accent-primary)] text-white px-2 py-0.5 rounded-full font-bold">
                    #{roleContext.playerInfo.team_players[0].jersey_number}
                  </span>
                )}
              </div>
            </div>
          )}
          
          {/* Right: User Profile & View Switcher */}
          <div className="relative">
            <button 
              className={`flex items-center gap-3 px-3 py-1.5 rounded-xl transition ${tc.hoverBgAlt}`}
              onClick={() => setShowRoleSwitcher(!showRoleSwitcher)}
            >
              <div className="w-8 h-8 rounded-full bg-yellow-400 flex items-center justify-center font-bold text-black text-sm">
                {profile?.full_name?.charAt(0) || '?'}
              </div>
              <div className="text-left hidden sm:block">
                <p className={`text-sm font-medium ${tc.text}`}>{profile?.full_name || 'User'}</p>
                <p className={`text-xs ${tc.textMuted} flex items-center gap-1`}>
                  {activeView === 'admin' && <Shield className="w-3 h-3" />}
                  {activeView === 'coach' && <UserCog className="w-3 h-3" />}
                  {activeView === 'parent' && <Users className="w-3 h-3" />}
                  {activeView === 'player' && <VolleyballIcon className="w-3 h-3" />}
                  {activeView.charAt(0).toUpperCase() + activeView.slice(1)}
                </p>
              </div>
              <ChevronDown className={`w-4 h-4 ${tc.textMuted} transition-transform ${showRoleSwitcher ? 'rotate-180' : ''}`} />
            </button>
            
            {/* Role Switcher Dropdown */}
            {showRoleSwitcher && (
              <div className={`absolute right-0 top-full mt-2 w-64 ${tc.cardBg} rounded-xl border ${tc.border} shadow-xl overflow-hidden z-50`}>
                <div className={`p-2 border-b ${tc.border}`}>
                  <p className={`text-xs ${tc.textMuted} px-2`}>Switch View</p>
                </div>
                {getAvailableViews().map(view => (
                  <button
                    key={view.id}
                    onClick={() => {
                      setActiveView(view.id)
                      setShowRoleSwitcher(false)
                      setPage('dashboard')
                    }}
                    className={`w-full flex items-center gap-3 px-4 py-3 text-left transition ${
                      activeView === view.id 
                        ? 'bg-[var(--accent-primary)]/20' 
                        : `${tc.hoverBg}`
                    }`}
                  >
                    <NavIcon name={view.icon} className="w-5 h-5" />
                    <div className="flex-1 min-w-0">
                      <p className={`font-medium text-sm ${activeView === view.id ? 'text-[var(--accent-primary)]' : tc.text}`}>
                        {view.label}
                      </p>
                      <p className={`text-xs ${tc.textMuted} truncate`}>{view.description}</p>
                    </div>
                    {activeView === view.id && <Check className="w-4 h-4 text-[var(--accent-primary)]" />}
                  </button>
                ))}
                <div className={`p-2 border-t ${tc.border} flex gap-2`}>
                  <ThemeToggleButton collapsed={false} />
                  <button 
                    onClick={signOut} 
                    className={`flex-1 flex items-center justify-center gap-2 px-3 py-2 rounded-lg ${tc.hoverBg} ${tc.textSecondary} text-sm`}
                  >
                    <LogOut className="w-4 h-4" />
                    <span>Sign Out</span>
                  </button>
                </div>
              </div>
            )}
          </div>
        </header>
        
        <div className="flex flex-1 pt-14">
          {/* Sidebar */}
          <div className={`${sidebarCollapsed ? 'w-16' : 'w-56'} fixed top-14 left-0 h-[calc(100vh-3.5rem)] ${tc.cardBg} border-r ${tc.border} flex flex-col transition-all duration-300 z-40`}>
            
            {/* Collapse Toggle */}
            <div className={`flex items-center ${sidebarCollapsed ? 'justify-center' : 'justify-end'} px-2 py-2 border-b ${tc.border}`}>
              <button 
                onClick={() => setSidebarCollapsed(!sidebarCollapsed)} 
                className={`p-2 rounded-lg ${tc.hoverBgAlt} ${tc.textSecondary}`}
                title={sidebarCollapsed ? 'Expand sidebar' : 'Collapse sidebar'}
              >
                {sidebarCollapsed ? <ChevronRight className="w-4 h-4" /> : <ChevronLeft className="w-4 h-4" />}
              </button>
            </div>

            {/* Navigation - varies by active view */}
            <nav className="flex-1 p-2 space-y-1 overflow-y-auto">
              {activeView === 'admin' && (
                // Full Admin Navigation
                <>
                  {navGroups.map(group => (
                    group.type === 'single' ? (
                      <button key={group.id} onClick={() => { exitTeamWall(); setPage(group.id); }}
                        className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-xl transition-all text-sm ${
                          page === group.id && !directTeamWallId ? 'bg-[var(--accent-primary)] text-white font-semibold' : `${tc.textSecondary} ${tc.hoverBg}`
                        }`}
                        title={sidebarCollapsed ? group.label : undefined}
                      >
                        <NavIcon name={group.icon} className="w-5 h-5" />
                        {!sidebarCollapsed && <span>{group.label}</span>}
                      </button>
                    ) : (
                      <div key={group.id} className="mb-1">
                        <button
                          onClick={() => !sidebarCollapsed && toggleGroup(group.id)}
                          className={`w-full flex items-center justify-between px-3 py-2 rounded-lg transition-all text-sm ${
                            group.items.some(item => item.id === page) && !directTeamWallId
                              ? 'text-[var(--accent-primary)] bg-[var(--accent-primary)]/10'
                              : `${tc.textMuted} ${tc.hoverBg}`
                          }`}
                          title={sidebarCollapsed ? group.label : undefined}
                        >
                          <div className="flex items-center gap-3">
                            <NavIcon name={group.icon} className="w-5 h-5" />
                            {!sidebarCollapsed && <span className="font-medium text-xs uppercase tracking-wider">{group.label}</span>}
                          </div>
                          {!sidebarCollapsed && (
                            <ChevronDown className={`w-4 h-4 transition-transform duration-200 ${expandedGroups[group.id] ? 'rotate-180' : ''}`} />
                          )}
                        </button>
                        {(expandedGroups[group.id] || sidebarCollapsed) && (
                          <div className={`${sidebarCollapsed ? '' : 'ml-3 mt-1 pl-3 border-l border-slate-700'} space-y-0.5`}>
                            {group.items.map(item => (
                              <button key={item.id} onClick={() => { exitTeamWall(); setPage(item.id); }}
                                className={`w-full flex items-center gap-3 px-3 py-2 rounded-lg transition-all text-sm ${
                                  page === item.id && !directTeamWallId ? 'bg-[var(--accent-primary)] text-white font-semibold' : `${tc.textSecondary} ${tc.hoverBg}`
                                }`}
                                title={sidebarCollapsed ? item.label : undefined}
                              >
                                <span className="relative">
                                  <NavIcon name={item.icon} className="w-4 h-4" />
                                  {item.hasBadge && sidebarCollapsed && <JerseyNavBadge collapsed={true} />}
                                </span>
                                {!sidebarCollapsed && (
                                  <>
                                    <span className="flex-1 text-left">{item.label}</span>
                                    {item.hasBadge && <JerseyNavBadge collapsed={false} />}
                                  </>
                                )}
                              </button>
                            ))}
                          </div>
                        )}
                      </div>
                    )
                  ))}
                </>
              )}

            {activeView === 'coach' && (
              // Coach Navigation
              <>
                <button onClick={() => { exitTeamWall(); setPage('dashboard'); }}
                  className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-xl transition-all text-sm ${
                    page === 'dashboard' && !directTeamWallId ? 'bg-[var(--accent-primary)] text-white font-semibold' : `${tc.textSecondary} ${tc.hoverBg}`
                  }`}>
                  <LayoutDashboard className="w-5 h-5" />
                  <span>Dashboard</span>
                </button>

                {/* My Teams */}
                <p className={`px-3 py-2 text-xs font-medium uppercase tracking-wider ${tc.textMuted}`}>My Teams</p>
                {roleContext?.coachInfo?.team_coaches?.map(tc_item => (
                  <button 
                    key={tc_item.team_id}
                    onClick={() => navigateToTeamWall(tc_item.team_id)}
                    className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-xl transition-all text-sm ${
                      directTeamWallId === tc_item.team_id ? 'bg-[var(--accent-primary)] text-white font-semibold' : `${tc.textSecondary} ${tc.hoverBg}`
                    }`}
                  >
                    <Users className="w-5 h-5" />
                    <span>{tc_item.teams?.name}</span>
                    {tc_item.role === 'head' && <Star className="w-4 h-4 text-[var(--accent-primary)]" />}
                  </button>
                ))}

                <div className={`my-3 border-t ${tc.border}`}></div>

                <button onClick={() => { exitTeamWall(); setPage('schedule'); }}
                  className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-xl transition-all text-sm ${
                    page === 'schedule' && !directTeamWallId ? 'bg-[var(--accent-primary)] text-white font-semibold' : `${tc.textSecondary} ${tc.hoverBg}`
                  }`}>
                  <Calendar className="w-5 h-5" />
                  <span>Schedule</span>
                </button>

                <button onClick={() => { exitTeamWall(); setPage('gameprep'); }}
                  className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-xl transition-all text-sm ${
                    page === 'gameprep' && !directTeamWallId ? 'bg-[var(--accent-primary)] text-white font-semibold' : `${tc.textSecondary} ${tc.hoverBg}`
                  }`}>
                  <Target className="w-5 h-5" />
                  <span>Game Prep</span>
                </button>

                <button onClick={() => { exitTeamWall(); setPage('attendance'); }}
                  className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-xl transition-all text-sm ${
                    page === 'attendance' && !directTeamWallId ? 'bg-[var(--accent-primary)] text-white font-semibold' : `${tc.textSecondary} ${tc.hoverBg}`
                  }`}>
                  <CheckSquare className="w-5 h-5" />
                  <span>Attendance</span>
                </button>

                <div className={`my-3 border-t ${tc.border}`}></div>
                <p className={`px-3 py-2 text-xs font-medium uppercase tracking-wider ${tc.textMuted}`}>Communication</p>

                <button onClick={() => { exitTeamWall(); setPage('chats'); }}
                  className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-xl transition-all text-sm ${
                    page === 'chats' && !directTeamWallId ? 'bg-[var(--accent-primary)] text-white font-semibold' : `${tc.textSecondary} ${tc.hoverBg}`
                  }`}>
                  <MessageCircle className="w-5 h-5" />
                  <span>Team Chats</span>
                </button>

                <button onClick={() => { exitTeamWall(); setPage('blasts'); }}
                  className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-xl transition-all text-sm ${
                    page === 'blasts' && !directTeamWallId ? 'bg-[var(--accent-primary)] text-white font-semibold' : `${tc.textSecondary} ${tc.hoverBg}`
                  }`}>
                  <Megaphone className="w-5 h-5" />
                  <span>Announcements</span>
                </button>
              </>
            )}

            {activeView === 'parent' && (
              // Enhanced Parent Navigation
              <>
                <button onClick={() => { exitTeamWall(); setPage('dashboard'); }}
                  className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-xl transition-all text-sm ${
                    page === 'dashboard' && !directTeamWallId ? 'bg-[var(--accent-primary)] text-white font-semibold' : `${tc.textSecondary} ${tc.hoverBg}`
                  }`}>
                  <Home className="w-5 h-5" />
                  {!sidebarCollapsed && <span>Home</span>}
                </button>

                {/* My Players - Clickable */}
                {!sidebarCollapsed && (
                  <p className={`px-3 py-2 text-xs font-medium uppercase tracking-wider ${tc.textMuted}`}>My Players</p>
                )}
                {roleContext?.children?.map(child => (
                  <div key={child.id} className="mb-2">
                    <button
                      onClick={() => { exitTeamWall(); setPage(`player-${child.id}`); }}
                      className={`w-full flex items-center gap-2 px-3 py-2 rounded-xl transition ${
                        page === `player-${child.id}` ? 'bg-[var(--accent-primary)]/20 text-[var(--accent-primary)]' : `${tc.textSecondary} ${tc.hoverBg}`
                      }`}
                    >
                      {child.photo_url ? (
                        <img src={child.photo_url} alt="" className="w-6 h-6 rounded-full object-cover" />
                      ) : (
                        <div className="w-6 h-6 rounded-full bg-[var(--accent-primary)]/30 flex items-center justify-center text-xs font-bold text-[var(--accent-primary)]">
                          {child.first_name?.[0]}
                        </div>
                      )}
                      {!sidebarCollapsed && <span className="text-sm font-medium flex-1">{child.first_name}</span>}
                      {!sidebarCollapsed && <span className="text-xs opacity-50">‚Üí</span>}
                    </button>
                    {!sidebarCollapsed && child.team_players?.map(tp => (
                      <button 
                        key={tp.team_id}
                        onClick={() => navigateToTeamWall(tp.team_id)}
                        className={`w-full flex items-center gap-2 px-3 py-1.5 ml-4 rounded-lg transition-all text-xs group ${
                          directTeamWallId === tp.team_id 
                            ? 'bg-[var(--accent-primary)]/20 text-[var(--accent-primary)]' 
                            : `${tc.textMuted} hover:text-[var(--accent-primary)] ${tc.hoverBg}`
                        }`}
                      >
                        <span className="w-2 h-2 rounded-full" style={{ background: tp.teams?.color || '#EAB308' }} />
                        <span className="flex-1">{tp.teams?.name}</span>
                        <span className="text-[10px] opacity-50 group-hover:opacity-100">Team ‚Üí</span>
                      </button>
                    ))}
                  </div>
                ))}

                <div className={`my-3 border-t ${tc.border}`}></div>

                <button onClick={() => { exitTeamWall(); setPage('schedule'); }}
                  className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-xl transition-all text-sm ${
                    page === 'schedule' ? 'bg-[var(--accent-primary)] text-white font-semibold' : `${tc.textSecondary} ${tc.hoverBg}`
                  }`}>
                  <Calendar className="w-5 h-5" />
                  {!sidebarCollapsed && <span>Schedule</span>}
                </button>

                <button onClick={() => { exitTeamWall(); setPage('chats'); }}
                  className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-xl transition-all text-sm ${
                    page === 'chats' || page === 'messages' ? 'bg-[var(--accent-primary)] text-white font-semibold' : `${tc.textSecondary} ${tc.hoverBg}`
                  }`}>
                  <MessageCircle className="w-5 h-5" />
                  {!sidebarCollapsed && <span>Chats</span>}
                </button>

                <button onClick={() => { exitTeamWall(); setPage('payments'); }}
                  className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-xl transition-all text-sm ${
                    page === 'payments' ? 'bg-[var(--accent-primary)] text-white font-semibold' : `${tc.textSecondary} ${tc.hoverBg}`
                  }`}>
                  <DollarSign className="w-5 h-5" />
                  {!sidebarCollapsed && <span>Payments</span>}
                </button>

                <button onClick={() => { exitTeamWall(); setPage('invite'); }}
                  className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-xl transition-all text-sm ${
                    page === 'invite' ? 'bg-[var(--accent-primary)] text-white font-semibold' : `${tc.textSecondary} ${tc.hoverBg}`
                  }`}>
                  <span className="text-lg">üîó</span>
                  {!sidebarCollapsed && <span>Invite Friends</span>}
                </button>
              </>
            )}

            {activeView === 'player' && (
              // Player Navigation
              <>
                <button onClick={() => { exitTeamWall(); setPage('dashboard'); }}
                  className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-xl transition-all text-sm ${
                    page === 'dashboard' && !directTeamWallId ? 'bg-[var(--accent-primary)] text-white font-semibold' : `${tc.textSecondary} ${tc.hoverBg}`
                  }`}>
                  <Home className="w-5 h-5" />
                  <span>Home</span>
                </button>

                {/* My Teams */}
                <p className={`px-3 py-2 text-xs font-medium uppercase tracking-wider ${tc.textMuted}`}>My Teams</p>
                {roleContext?.playerInfo?.team_players?.map(tp => (
                  <button 
                    key={tp.team_id}
                    onClick={() => navigateToTeamWall(tp.team_id)}
                    className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-xl transition-all text-sm ${
                      directTeamWallId === tp.team_id ? 'bg-[var(--accent-primary)] text-white font-semibold' : `${tc.textSecondary} ${tc.hoverBg}`
                    }`}
                  >
                    <span 
                      className="w-3 h-3 rounded-full" 
                      style={{ background: tp.teams?.color || '#EAB308' }}
                    ></span>
                    <span>{tp.teams?.name}</span>
                  </button>
                ))}

                <div className={`my-3 border-t ${tc.border}`}></div>

                <button onClick={() => { exitTeamWall(); setPage('schedule'); }}
                  className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-xl transition-all text-sm ${
                    page === 'schedule' && !directTeamWallId ? 'bg-[var(--accent-primary)] text-white font-semibold' : `${tc.textSecondary} ${tc.hoverBg}`
                  }`}>
                  <Calendar className="w-5 h-5" />
                  <span>Schedule</span>
                </button>
              </>
            )}
          </nav>

          {/* Theme Toggle & Sign Out - shrink-0 keeps it at bottom */}
          <div className={`p-4 border-t ${tc.border} shrink-0`}>
            <div className={`flex ${sidebarCollapsed ? 'flex-col' : 'flex-row'} gap-2`}>
              <AccentColorPicker />
              <ThemeToggleButton collapsed={sidebarCollapsed} />
              <button onClick={signOut}
                className={`flex-1 flex items-center justify-center gap-2 px-3 py-2 rounded-lg ${tc.textSecondary} hover:text-red-400 hover:bg-red-500/10 transition text-sm`}>
                <LogOut className="w-4 h-4" />
                {!sidebarCollapsed && <span>Sign Out</span>}
              </button>
            </div>
          </div>
        </div>

        {/* Main Content */}
        <div className={`flex-1 p-8 overflow-auto ${sidebarCollapsed ? 'ml-16' : 'ml-56'} transition-all duration-300`}>
          {/* Direct Team Wall Access via URL */}
          {directTeamWallId ? (
            <TeamWallPage 
              teamId={directTeamWallId}
              showToast={showToast}
              onBack={exitTeamWall}
            />
          ) : (
            <>
              {page === 'dashboard' && activeView === 'admin' && <DashboardPage onNavigate={setPage} />}
              {page === 'dashboard' && activeView === 'coach' && <CoachDashboard roleContext={roleContext} navigateToTeamWall={navigateToTeamWall} showToast={showToast} onNavigate={setPage} />}
              {page === 'dashboard' && activeView === 'parent' && <ParentDashboard roleContext={roleContext} navigateToTeamWall={navigateToTeamWall} showToast={showToast} onNavigate={setPage} />}
              {page === 'dashboard' && activeView === 'player' && <PlayerDashboard roleContext={roleContext} navigateToTeamWall={navigateToTeamWall} onNavigate={setPage} />}
              {/* Parent Portal - Player Profile Pages */}
              {page.startsWith('player-') && activeView === 'parent' && <PlayerProfilePage playerId={page.replace('player-', '')} roleContext={roleContext} showToast={showToast} />}
              {/* Parent Portal - Messages */}
              {page === 'messages' && activeView === 'parent' && <ParentMessagesPage roleContext={roleContext} showToast={showToast} />}
              {/* Parent Portal - Invite Friends */}
              {page === 'invite' && activeView === 'parent' && <InviteFriendsPage roleContext={roleContext} showToast={showToast} />}
              {/* Parent Portal - Payments (privacy-aware) */}
              {page === 'payments' && activeView === 'parent' && <ParentPaymentsPage roleContext={roleContext} showToast={showToast} />}
              {page === 'registrations' && <RegistrationsPage showToast={showToast} />}
              {page === 'payments' && activeView === 'admin' && <PaymentsPage showToast={showToast} />}
              {page === 'teams' && <TeamsPage showToast={showToast} navigateToTeamWall={navigateToTeamWall} onNavigate={setPage} />}
              {page === 'coaches' && <CoachesPage showToast={showToast} />}
              {page === 'jerseys' && <JerseysPage showToast={showToast} />}
              {page === 'schedule' && <SchedulePage showToast={showToast} activeView={activeView} />}
              {page === 'attendance' && <AttendancePage showToast={showToast} />}
              {page === 'gameprep' && <GamePrepPage showToast={showToast} />}
              {page === 'seasons' && <SeasonsPage showToast={showToast} />}
              {page === 'waivers' && <WaiversPage showToast={showToast} />}
              {page === 'paymentsetup' && <PaymentSetupPage showToast={showToast} />}
              {page === 'organization' && <OrganizationPage showToast={showToast} />}
              {page === 'chats' && <ChatsPage showToast={showToast} activeView={activeView} roleContext={roleContext} />}
              {page === 'blasts' && <BlastsPage showToast={showToast} activeView={activeView} roleContext={roleContext} />}
              {page === 'reports' && <ReportsPage showToast={showToast} />}
            </>
          )}
        </div>
        </div>

        {/* Toast */}
        {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
        
        {/* Blast Alert Checker - Handles its own state inside SeasonProvider */}
        <BlastAlertChecker />
      </div>
    </SeasonProvider>
    </SportProvider>
  )
}

// ============================================
// DASHBOARD PAGE
// ============================================
// ============================================
// REDESIGNED DASHBOARD PAGE - Matches Mockup
// ============================================
function GettingStartedGuide({ onNavigate }) {
  const { organization, profile } = useAuth()
  const { seasons } = useSeason()
  const tc = useThemeClasses()
  const { accent, colors } = useTheme()
  const [setupStatus, setSetupStatus] = useState({
    hasSeason: false,
    hasTeams: false,
    hasPlayers: false,
    hasSchedule: false,
  })
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    checkSetupStatus()
  }, [organization?.id])

  async function checkSetupStatus() {
    if (!organization?.id) {
      setLoading(false)
      return
    }

    try {
      // Check for seasons
      const { count: seasonCount } = await supabase
        .from('seasons')
        .select('*', { count: 'exact', head: true })
        .eq('organization_id', organization.id)

      // Check for teams
      const { count: teamCount } = await supabase
        .from('teams')
        .select('*', { count: 'exact', head: true })
        .eq('organization_id', organization.id)

      // Check for players (across all seasons)
      const { count: playerCount } = await supabase
        .from('players')
        .select('*, seasons!inner(organization_id)', { count: 'exact', head: true })
        .eq('seasons.organization_id', organization.id)

      // Check for schedule events
      const { count: eventCount } = await supabase
        .from('schedule_events')
        .select('*, seasons!inner(organization_id)', { count: 'exact', head: true })
        .eq('seasons.organization_id', organization.id)

      setSetupStatus({
        hasSeason: (seasonCount || 0) > 0,
        hasTeams: (teamCount || 0) > 0,
        hasPlayers: (playerCount || 0) > 0,
        hasSchedule: (eventCount || 0) > 0,
      })
    } catch (err) {
      console.error('Setup status check error:', err)
    }
    setLoading(false)
  }

  const steps = [
    {
      id: 'season',
      number: 1,
      title: 'Create Your First Season',
      description: 'Set up a season with start/end dates and registration fees.',
      icon: 'calendar',
      completed: setupStatus.hasSeason,
      action: () => onNavigate('seasons'),
      actionLabel: 'Go to Seasons',
    },
    {
      id: 'teams',
      number: 2,
      title: 'Add Teams',
      description: 'Create teams and assign age groups or divisions.',
      icon: 'users',
      completed: setupStatus.hasTeams,
      action: () => onNavigate('teams'),
      actionLabel: 'Manage Teams',
    },
    {
      id: 'players',
      number: 3,
      title: 'Register Players',
      description: 'Add players manually or share a registration link.',
      icon: 'volleyball',
      completed: setupStatus.hasPlayers,
      action: () => onNavigate('registrations'),
      actionLabel: 'Add Players',
    },
    {
      id: 'schedule',
      number: 4,
      title: 'Create Schedule',
      description: 'Add practices, games, and events to your calendar.',
      icon: 'calendar',
      completed: setupStatus.hasSchedule,
      action: () => onNavigate('schedule'),
      actionLabel: 'Build Schedule',
    },
  ]

  const completedCount = steps.filter(s => s.completed).length
  const progressPercent = (completedCount / steps.length) * 100

  if (loading) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="flex flex-col items-center gap-3">
          <div className="w-8 h-8 border-2 border-t-transparent rounded-full animate-spin" style={{ borderColor: accent.primary, borderTopColor: 'transparent' }}></div>
          <span className={tc.textSecondary}>Loading...</span>
        </div>
      </div>
    )
  }

  return (
    <div className="space-y-8">
    {/* Journey Progress */}
    <JourneyTimeline onNavigate={onNavigate} />
    
    {/* Header */}
      {/* Welcome Header */}
      <div className="text-center py-8">
        <div className="w-20 h-20 rounded-full mx-auto mb-6 flex items-center justify-center text-4xl" style={{ backgroundColor: accent.primary + '20' }}>
          üéâ
        </div>
        <h1 className={`text-3xl font-bold ${tc.text} mb-2`}>
          Welcome to {organization?.name || 'VolleyBrain'}!
        </h1>
        <p className={`${tc.textMuted} max-w-md mx-auto`}>
          Let's get your organization set up. Follow these steps to start managing your teams.
        </p>
      </div>

      {/* Progress Bar */}
      <div className={`max-w-2xl mx-auto p-6 rounded-2xl border ${tc.card}`}>
        <div className="flex items-center justify-between mb-3">
          <span className={`text-sm font-medium ${tc.text}`}>Setup Progress</span>
          <span className={`text-sm font-semibold`} style={{ color: accent.primary }}>
            {completedCount} of {steps.length} complete
          </span>
        </div>
        <div className={`h-3 rounded-full ${tc.cardBgAlt}`}>
          <div 
            className="h-full rounded-full transition-all duration-500" 
            style={{ width: `${progressPercent}%`, backgroundColor: accent.primary }}
          />
        </div>
      </div>

      {/* Setup Steps */}
      <div className="max-w-2xl mx-auto space-y-4">
        {steps.map((step, index) => (
          <div 
            key={step.id}
            className={`p-5 rounded-2xl border transition-all ${
              step.completed 
                ? `${tc.card} opacity-75` 
                : `${tc.card} hover:shadow-lg`
            }`}
          >
            <div className="flex items-start gap-4">
              {/* Step Number / Check */}
              <div 
                className={`w-12 h-12 rounded-xl flex items-center justify-center text-lg font-bold shrink-0 ${
                  step.completed ? 'text-white' : tc.text
                }`}
                style={{ 
                  backgroundColor: step.completed ? accent.primary : (tc.cardBgAlt || '#f1f5f9')
                }}
              >
                {step.completed ? '‚úì' : step.icon}
              </div>

              {/* Content */}
              <div className="flex-1 min-w-0">
                <div className="flex items-center gap-2 mb-1">
                  <h3 className={`font-semibold ${tc.text} ${step.completed ? 'line-through opacity-60' : ''}`}>
                    {step.title}
                  </h3>
                  {step.completed && (
                    <span className="text-xs px-2 py-0.5 rounded-full text-white" style={{ backgroundColor: accent.primary }}>
                      Done
                    </span>
                  )}
                </div>
                <p className={`text-sm ${tc.textMuted}`}>{step.description}</p>
              </div>

              {/* Action Button */}
              {!step.completed && (
                <button
                  onClick={step.action}
                  className="px-4 py-2 rounded-xl text-white font-medium text-sm shrink-0 transition hover:brightness-110"
                  style={{ backgroundColor: accent.primary }}
                >
                  {step.actionLabel}
                </button>
              )}
            </div>
          </div>
        ))}
      </div>

      {/* Quick Actions */}
      <div className="max-w-2xl mx-auto">
        <h2 className={`text-lg font-semibold ${tc.text} mb-4`}>Quick Actions</h2>
        <div className="grid grid-cols-2 sm:grid-cols-4 gap-3">
          <button 
            onClick={() => onNavigate('seasons')}
            className={`p-4 rounded-xl border ${tc.card} hover:shadow-md transition text-center`}
          >
            <Calendar className="w-8 h-8 mb-2" />
            <span className={`text-sm font-medium ${tc.text}`}>Seasons</span>
          </button>
          <button 
            onClick={() => onNavigate('coaches')}
            className={`p-4 rounded-xl border ${tc.card} hover:shadow-md transition text-center`}
          >
            <span className="text-2xl mb-2 block">üèÜ</span>
            <span className={`text-sm font-medium ${tc.text}`}>Add Coaches</span>
          </button>
          <button 
            onClick={() => onNavigate('registrations')}
            className={`p-4 rounded-xl border ${tc.card} hover:shadow-md transition text-center`}
          >
            <ClipboardList className="w-8 h-8 mb-2" />
            <span className={`text-sm font-medium ${tc.text}`}>Registrations</span>
          </button>
          <button 
            onClick={() => onNavigate('organization')}
            className={`p-4 rounded-xl border ${tc.card} hover:shadow-md transition text-center`}
          >
            <Settings className="w-8 h-8 mb-2" />
            <span className={`text-sm font-medium ${tc.text}`}>Settings</span>
          </button>
        </div>
      </div>

      {/* Tip Box */}
      <div className="max-w-2xl mx-auto p-5 rounded-2xl border" style={{ borderColor: accent.primary + '40', backgroundColor: accent.primary + '10' }}>
        <div className="flex gap-4">
          <span className="text-2xl">üí°</span>
          <div>
            <h3 className={`font-semibold ${tc.text} mb-1`}>Pro Tip</h3>
            <p className={`text-sm ${tc.textMuted}`}>
              Start by creating a season, then add teams. Once you have teams, you can register players 
              and they'll automatically be assigned to teams during registration or manually by you.
            </p>
          </div>
        </div>
      </div>
    </div>
  )
}

function DashboardPage({ onNavigate }) {
  const { organization, profile } = useAuth()
  const { selectedSeason, loading: seasonLoading } = useSeason()
  const { isDark, accent } = useTheme()
  const tc = useThemeClasses()
  const [stats, setStats] = useState({ 
    players: 0, 
    pendingRegs: 0, 
    unpaidCount: 0, 
    unpaidAmount: 0,
    teams: 0,
    missingJerseys: 0,
    missingEmergency: 0
  })
  const [todayEvents, setTodayEvents] = useState([])
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    if (selectedSeason?.id) {
      loadStats()
    } else if (!seasonLoading) {
      // No season selected and season context finished loading - set loading to false
      setLoading(false)
    }
  }, [selectedSeason?.id, seasonLoading])

  async function loadStats() {
    setLoading(true)
    try {
      // Basic counts
      const { count: players } = await supabase.from('players').select('*', { count: 'exact', head: true }).eq('season_id', selectedSeason.id)
      const { count: pendingRegs } = await supabase.from('registrations').select('*', { count: 'exact', head: true }).eq('season_id', selectedSeason.id).in('status', ['pending', 'submitted'])
      const { count: teams } = await supabase.from('teams').select('*', { count: 'exact', head: true }).eq('season_id', selectedSeason.id)
      
      // Unpaid balances with amount
      const { data: unpaidPayments } = await supabase.from('payments').select('amount').eq('season_id', selectedSeason.id).eq('paid', false)
      const unpaidCount = unpaidPayments?.length || 0
      const unpaidAmount = unpaidPayments?.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0) || 0
      
      // Missing jersey assignments
      const { count: missingJerseys } = await supabase.from('players').select('*', { count: 'exact', head: true }).eq('season_id', selectedSeason.id).is('jersey_number', null)
      
      // Missing emergency contacts
      const { count: missingEmergency } = await supabase.from('players').select('*', { count: 'exact', head: true }).eq('season_id', selectedSeason.id).is('emergency_contact_name', null)

      // Today's events
      const today = new Date().toISOString().split('T')[0]
      const { data: events } = await supabase
        .from('schedule_events')
        .select('*, teams(name, color)')
        .eq('event_date', today)
        .order('event_time', { ascending: true })
        .limit(5)
      
      setTodayEvents(events || [])
      setStats({ 
        players: players || 0, 
        pendingRegs: pendingRegs || 0, 
        unpaidCount: unpaidCount,
        unpaidAmount: unpaidAmount,
        teams: teams || 0,
        missingJerseys: missingJerseys || 0,
        missingEmergency: missingEmergency || 0
      })
    } catch (err) {
      console.error('Stats error:', err)
    }
    setLoading(false)
  }

  // Calculate season progress
  const getSeasonProgress = () => {
    if (!selectedSeason?.start_date || !selectedSeason?.end_date) return { progress: 85, weeksElapsed: 11, totalWeeks: 14 }
    const start = new Date(selectedSeason.start_date)
    const end = new Date(selectedSeason.end_date)
    const now = new Date()
    const totalDays = (end - start) / (1000 * 60 * 60 * 24)
    const elapsedDays = Math.max(0, (now - start) / (1000 * 60 * 60 * 24))
    const progress = Math.min(100, Math.round((elapsedDays / totalDays) * 100))
    const totalWeeks = Math.ceil(totalDays / 7)
    const weeksElapsed = Math.ceil(elapsedDays / 7)
    return { progress, weeksElapsed, totalWeeks }
  }

  const seasonProgress = getSeasonProgress()

  // Build attention items
  const attentionItems = []
  if (stats.unpaidCount > 0) {
    attentionItems.push({
      title: 'Outstanding balances',
      description: `${stats.unpaidCount} players have unpaid fees totaling $${stats.unpaidAmount.toLocaleString()}`,
      priority: 'high',
      time: '2 days',
      action: () => onNavigate('payments')
    })
  }
  if (stats.missingJerseys > 0) {
    attentionItems.push({
      title: 'Jersey assignments',
      description: `${stats.missingJerseys} players need jersey numbers assigned`,
      priority: 'medium',
      action: () => onNavigate('jerseys')
    })
  }
  if (stats.missingEmergency > 0) {
    attentionItems.push({
      title: 'Emergency contacts',
      description: `${stats.missingEmergency} players missing emergency contact info`,
      priority: 'medium',
      action: () => onNavigate('registrations')
    })
  }
  if (stats.pendingRegs > 0) {
    attentionItems.push({
      title: 'Pending registrations',
      description: `${stats.pendingRegs} registrations awaiting approval`,
      priority: 'high',
      action: () => onNavigate('registrations')
    })
  }

  // Show getting started guide if no season selected (and seasons have loaded)
  if (!seasonLoading && !selectedSeason) {
    return <GettingStartedGuide onNavigate={onNavigate} />
  }

  if (loading || seasonLoading) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="flex flex-col items-center gap-3">
          <div className="w-8 h-8 border-2 border-t-transparent rounded-full animate-spin" style={{ borderColor: accent.primary, borderTopColor: 'transparent' }}></div>
          <span className={tc.textSecondary}>Loading dashboard...</span>
        </div>
      </div>
    )
  }

  return (
    <div className="space-y-8">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className={`text-3xl font-bold ${tc.text}`}>Dashboard</h1>
          <p className={tc.textSecondary}>Welcome back, {profile?.full_name}! Here's what's happening with your league.</p>
        </div>
        <div className="flex items-center gap-3">
          <div className={`relative ${tc.cardBg} border ${tc.border} rounded-xl px-4 py-2 flex items-center gap-2`}>
            <span className={tc.textMuted}>üîç</span>
            <input 
              type="text" 
              placeholder="Search..." 
              className={`bg-transparent border-none outline-none ${tc.text} w-32`}
            />
            <span className={`text-xs px-2 py-0.5 rounded ${isDark ? 'bg-slate-700' : 'bg-slate-100'} ${tc.textMuted}`}>‚åòK</span>
          </div>
          <button className={`p-2.5 rounded-xl ${tc.hoverBg} ${tc.textMuted}`}><Settings className="w-5 h-5" /></button>
          <button className={`p-2.5 rounded-xl ${tc.hoverBg} ${tc.textMuted} relative`}>
            <Bell className="w-5 h-5" />
            {attentionItems.length > 0 && (
              <span className="absolute -top-1 -right-1 w-4 h-4 rounded-full text-[10px] flex items-center justify-center text-white" style={{ backgroundColor: accent.primary }}>
                {attentionItems.length}
              </span>
            )}
          </button>
          <button 
            onClick={() => onNavigate('registrations')}
            className="px-4 py-2.5 rounded-xl text-white font-semibold flex items-center gap-2 transition hover:brightness-110"
            style={{ backgroundColor: accent.primary }}
          >
            <span>+</span> Add Player
          </button>
        </div>
      </div>

      {/* Main Content Grid */}
      <div className="grid grid-cols-12 gap-6">
        {/* Left Column - 8 cols */}
        <div className="col-span-12 lg:col-span-8 space-y-6">
          {/* Metric Cards */}
          <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
            {/* Total Players */}
            <div 
              onClick={() => onNavigate('registrations')}
              className={`relative overflow-hidden rounded-2xl border p-5 cursor-pointer transition-all hover:shadow-lg hover:-translate-y-0.5 ${tc.card}`}
            >
              <div className="absolute top-0 left-0 right-0 h-1" style={{ backgroundColor: accent.primary }}></div>
              <div className="flex justify-between items-start pt-1">
                <div>
                  <p className={`text-xs font-semibold uppercase tracking-wider ${tc.textMuted}`}>Total Players</p>
                  <p className={`text-4xl font-bold ${tc.text} mt-1`}>{stats.players}</p>
                  <p className="text-sm mt-1" style={{ color: accent.primary }}>All registered</p>
                </div>
                <div className="w-10 h-10 rounded-xl flex items-center justify-center" style={{ backgroundColor: `${accent.primary}20` }}>
                  <Users className="w-5 h-5" style={{ color: accent.primary }} />
                </div>
              </div>
              <p className="text-xs mt-3 flex items-center gap-1" style={{ color: accent.primary }}>
                View details <span>‚Üó</span>
              </p>
            </div>

            {/* Pending */}
            <div 
              onClick={() => onNavigate('registrations')}
              className={`relative overflow-hidden rounded-2xl border p-5 cursor-pointer transition-all hover:shadow-lg hover:-translate-y-0.5 ${tc.card}`}
            >
              <div className={`absolute top-0 left-0 right-0 h-1 ${stats.pendingRegs > 0 ? 'bg-amber-500' : 'bg-transparent'}`}></div>
              <div className="flex justify-between items-start pt-1">
                <div>
                  <p className={`text-xs font-semibold uppercase tracking-wider ${tc.textMuted}`}>Pending</p>
                  <p className={`text-4xl font-bold ${tc.text} mt-1`}>{stats.pendingRegs}</p>
                  <p className={`text-sm mt-1 ${tc.textMuted}`}>Registrations</p>
                </div>
                <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${isDark ? 'bg-slate-700' : 'bg-slate-100'}`}>
                  <ClipboardList className={`w-6 h-6 ${tc.textMuted}`} />
                </div>
              </div>
              <p className="text-xs mt-3 flex items-center gap-1" style={{ color: accent.primary }}>
                View details <span>‚Üó</span>
              </p>
            </div>

            {/* Outstanding */}
            <div 
              onClick={() => onNavigate('payments')}
              className={`relative overflow-hidden rounded-2xl border p-5 cursor-pointer transition-all hover:shadow-lg hover:-translate-y-0.5 ${tc.card}`}
            >
              <div className={`absolute top-0 left-0 right-0 h-1 ${stats.unpaidCount > 0 ? 'bg-amber-500' : 'bg-emerald-500'}`}></div>
              <div className="flex justify-between items-start pt-1">
                <div>
                  <p className={`text-xs font-semibold uppercase tracking-wider ${tc.textMuted}`}>Outstanding</p>
                  <p className={`text-4xl font-bold ${tc.text} mt-1`}>${stats.unpaidAmount.toLocaleString()}</p>
                  <p className={`text-sm mt-1 ${stats.unpaidCount > 0 ? 'text-amber-500' : 'text-emerald-500'}`}>{stats.unpaidCount} players</p>
                </div>
                <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${stats.unpaidCount > 0 ? (isDark ? 'bg-amber-500/20' : 'bg-amber-50') : (isDark ? 'bg-emerald-500/20' : 'bg-emerald-50')}`}>
                  <DollarSign className={`w-6 h-6 ${stats.unpaidCount > 0 ? "text-amber-500" : "text-emerald-500"}`} />
                </div>
              </div>
              <p className="text-xs mt-3 flex items-center gap-1" style={{ color: accent.primary }}>
                View details <span>‚Üó</span>
              </p>
            </div>

            {/* Teams */}
            <div 
              onClick={() => onNavigate('teams')}
              className={`relative overflow-hidden rounded-2xl border p-5 cursor-pointer transition-all hover:shadow-lg hover:-translate-y-0.5 ${tc.card}`}
            >
              <div className="absolute top-0 left-0 right-0 h-1 bg-sky-500"></div>
              <div className="flex justify-between items-start pt-1">
                <div>
                  <p className={`text-xs font-semibold uppercase tracking-wider ${tc.textMuted}`}>Teams</p>
                  <p className={`text-4xl font-bold ${tc.text} mt-1`}>{stats.teams}</p>
                  <p className={`text-sm mt-1 ${tc.textMuted}`}>Active rosters</p>
                </div>
                <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${isDark ? 'bg-sky-500/20' : 'bg-sky-50'}`}>
                  <VolleyballIcon className="w-5 h-5 text-sky-500" />
                </div>
              </div>
              <p className="text-xs mt-3 flex items-center gap-1" style={{ color: accent.primary }}>
                View details <span>‚Üó</span>
              </p>
            </div>
          </div>

          {/* Needs Attention */}
          {attentionItems.length > 0 && (
            <div className={`${tc.cardBg} border ${tc.border} rounded-2xl`}>
              <div className={`px-6 py-4 border-b ${tc.border} flex items-center justify-between`}>
                <div className="flex items-center gap-3">
                  <h2 className={`font-semibold ${tc.text}`}>Needs Attention</h2>
                  <span className="px-2 py-0.5 rounded-full text-xs font-semibold bg-amber-500/20 text-amber-500">
                    {attentionItems.length} items
                  </span>
                </div>
                <button className="text-sm flex items-center gap-1" style={{ color: accent.primary }}>
                  View all <span>‚Ä∫</span>
                </button>
              </div>
              <div className="py-2">
                {attentionItems.map((item, i) => (
                  <div
                    key={i}
                    onClick={item.action}
                    className={`flex items-center gap-4 py-4 cursor-pointer transition-colors ${tc.hoverBg} px-6`}
                  >
                    <div className={`w-2 h-2 rounded-full flex-shrink-0 ${
                      item.priority === 'high' ? 'bg-amber-500' : 
                      item.priority === 'medium' ? 'bg-sky-500' : 'bg-slate-400'
                    }`} />
                    <div className="flex-1 min-w-0">
                      <p className={`font-medium ${tc.text}`}>{item.title}</p>
                      <p className={`text-sm ${tc.textMuted} truncate`}>{item.description}</p>
                    </div>
                    {item.time && (
                      <div className={`flex items-center gap-1 text-xs ${tc.textMuted}`}>
                        <span>üïê</span>
                        <span>{item.time}</span>
                      </div>
                    )}
                    <span className={`text-sm ${tc.textMuted}`}>‚Ä∫</span>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Quick Actions */}
          <div>
            <h2 className={`font-semibold ${tc.text} mb-4`}>Quick Actions</h2>
            <div className="grid grid-cols-3 gap-4">
              <div
                onClick={() => onNavigate('registrations')}
                className={`${tc.cardBg} border ${tc.border} rounded-2xl p-5 cursor-pointer transition-all hover:shadow-lg hover:-translate-y-0.5 min-h-[140px]`}
                onMouseEnter={(e) => e.currentTarget.style.borderColor = accent.primary}
                onMouseLeave={(e) => e.currentTarget.style.borderColor = ''}
              >
                <div className="w-11 h-11 rounded-xl flex items-center justify-center mb-4" style={{ backgroundColor: `${accent.primary}20` }}>
                  <ClipboardList className="w-6 h-6" style={{ color: accent.primary }} />
                </div>
                <p className={`font-semibold ${tc.text} mb-1`}>Registrations</p>
                <p className={`text-sm ${tc.textMuted}`}>View and manage all player registrations</p>
              </div>

              <div
                onClick={() => onNavigate('payments')}
                className={`${tc.cardBg} border ${tc.border} rounded-2xl p-5 cursor-pointer transition-all hover:shadow-lg hover:-translate-y-0.5 min-h-[140px]`}
                onMouseEnter={(e) => e.currentTarget.style.borderColor = '#F59E0B'}
                onMouseLeave={(e) => e.currentTarget.style.borderColor = ''}
              >
                <div className={`w-11 h-11 rounded-xl flex items-center justify-center mb-4 ${isDark ? 'bg-amber-500/20' : 'bg-amber-50'}`}>
                  <DollarSign className="w-6 h-6 text-amber-500" />
                </div>
                <p className={`font-semibold ${tc.text} mb-1`}>Payments</p>
                <p className={`text-sm ${tc.textMuted}`}>Track finances and collect fees</p>
              </div>

              <div
                onClick={() => onNavigate('teams')}
                className={`${tc.cardBg} border ${tc.border} rounded-2xl p-5 cursor-pointer transition-all hover:shadow-lg hover:-translate-y-0.5 min-h-[140px]`}
                onMouseEnter={(e) => e.currentTarget.style.borderColor = '#0EA5E9'}
                onMouseLeave={(e) => e.currentTarget.style.borderColor = ''}
              >
                <div className={`w-11 h-11 rounded-xl flex items-center justify-center mb-4 ${isDark ? 'bg-sky-500/20' : 'bg-sky-50'}`}>
                  <VolleyballIcon className="w-6 h-6 text-sky-500" />
                </div>
                <p className={`font-semibold ${tc.text} mb-1`}>Teams</p>
                <p className={`text-sm ${tc.textMuted}`}>Manage rosters and assignments</p>
              </div>
            </div>
          </div>
        </div>

        {/* Right Column - 4 cols */}
        <div className="col-span-12 lg:col-span-4 space-y-6">
          {/* Season Progress */}
          <div className={`${tc.cardBg} border ${tc.border} rounded-2xl p-6`}>
            <div className="flex items-center justify-between mb-5">
              <h3 className={`font-semibold ${tc.text}`}>Season Progress</h3>
              <span className="px-2.5 py-1 rounded-full text-xs font-semibold bg-emerald-500/20 text-emerald-500">Active</span>
            </div>
            
            <div className={`flex items-center gap-5 p-5 rounded-xl ${tc.cardBgAlt}`}>
              {/* Progress Ring */}
              <div className="relative" style={{ width: 64, height: 64 }}>
                <svg className="w-full h-full -rotate-90">
                  <circle 
                    cx="32" cy="32" r="29" 
                    stroke={isDark ? '#334155' : '#E2E8F0'} 
                    strokeWidth="6" 
                    fill="none" 
                  />
                  <circle 
                    cx="32" cy="32" r="29" 
                    stroke={accent.primary} 
                    strokeWidth="6" 
                    fill="none"
                    strokeLinecap="round"
                    strokeDasharray={182}
                    strokeDashoffset={182 - (182 * seasonProgress.progress / 100)}
                    className="transition-all duration-500"
                  />
                </svg>
                <span className={`absolute inset-0 flex items-center justify-center text-sm font-bold ${tc.text}`}>
                  {seasonProgress.progress}%
                </span>
              </div>
              <div>
                <p className={`font-semibold ${tc.text}`}>{selectedSeason?.name || 'Spring 2026'}</p>
                <p className={`text-sm ${tc.textMuted}`}>Week {seasonProgress.weeksElapsed} of {seasonProgress.totalWeeks}</p>
              </div>
            </div>
            
            <div className="mt-5 space-y-3">
              <div className={`flex justify-between py-2 border-b ${tc.border}`}>
                <span className={`text-sm ${tc.textMuted}`}>Registration Fee</span>
                <span className={`text-sm font-semibold ${tc.text}`}>${selectedSeason?.fee_registration || selectedSeason?.registration_fee || 150}</span>
              </div>
              <div className={`flex justify-between py-2 border-b ${tc.border}`}>
                <span className={`text-sm ${tc.textMuted}`}>Games Played</span>
                <span className={`text-sm font-semibold ${tc.text}`}>18 of 24</span>
              </div>
              <div className={`flex justify-between py-2`}>
                <span className={`text-sm ${tc.textMuted}`}>Season Ends</span>
                <span className={`text-sm font-semibold ${tc.text}`}>{selectedSeason?.end_date ? new Date(selectedSeason.end_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'Mar 28, 2026'}</span>
              </div>
            </div>
          </div>

          {/* Today's Schedule */}
          <div className={`${tc.cardBg} border ${tc.border} rounded-2xl p-6`}>
            <div className="flex items-center justify-between mb-5">
              <h3 className={`font-semibold ${tc.text}`}>Today's Schedule</h3>
              <span className={`text-sm ${tc.textMuted}`}>{new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</span>
            </div>
            
            {todayEvents.length === 0 ? (
              <div className={`text-center py-8 ${tc.textMuted}`}>
                <Calendar className="w-10 h-10 mb-2" />
                <p>No events scheduled today</p>
              </div>
            ) : (
              <div className="space-y-4">
                {todayEvents.map(event => (
                  <div key={event.id} className={`p-4 rounded-xl ${tc.cardBgAlt}`}>
                    <div className="flex items-start gap-4">
                      <div className="text-center">
                        <p className={`text-lg font-bold ${tc.text}`}>
                          {event.event_time ? new Date(`2000-01-01T${event.event_time}`).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }).split(' ')[0] : '‚Äî'}
                        </p>
                        <p className={`text-xs ${tc.textMuted}`}>
                          {event.event_time ? new Date(`2000-01-01T${event.event_time}`).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }).split(' ')[1] : ''}
                        </p>
                      </div>
                      <div className="flex-1">
                        <span className={`text-xs font-semibold uppercase px-2 py-0.5 rounded ${
                          event.event_type === 'game' ? 'bg-emerald-500/20 text-emerald-500' :
                          event.event_type === 'practice' ? 'bg-sky-500/20 text-sky-500' :
                          'bg-purple-500/20 text-purple-500'
                        }`}>
                          {event.event_type}
                        </span>
                        <p className={`font-semibold ${tc.text} mt-1`}>
                          {event.title || (event.event_type === 'game' ? `${event.teams?.name || 'Team'} vs ${event.opponent_name || 'Opponent'}` : `${event.teams?.name || 'Team'} Practice`)}
                        </p>
                        <p className={`text-sm ${tc.textMuted} flex items-center gap-1 mt-1`}>
                          <span>üìç</span> {event.venue_name || 'TBD'}
                        </p>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
            
            <button 
              onClick={() => onNavigate('schedule')}
              className={`w-full mt-4 py-3 rounded-xl border ${tc.border} ${tc.text} font-medium ${tc.hoverBg} transition flex items-center justify-center gap-2`}
            >
              <Calendar className="w-5 h-5" /> View Full Calendar
            </button>
          </div>
        </div>
      </div>
    </div>
  )
}

// ============================================
// ENHANCED PARENT PORTAL COMPONENTS
// Player profiles, jersey management, chat, share, gamification
// ============================================

// Achievement/Badge definitions
const PLAYER_BADGES = [
  { id: 'first_practice', name: 'First Practice', icon: 'üåü', description: 'Attended first practice', category: 'attendance' },
  { id: 'perfect_attendance', name: 'Perfect Attendance', icon: 'star', description: 'Never missed a practice', category: 'attendance' },
  { id: 'attendance_streak_5', name: '5 Game Streak', icon: 'üî•', description: 'Attended 5 events in a row', category: 'attendance' },
  { id: 'attendance_streak_10', name: '10 Game Streak', icon: 'üí•', description: 'Attended 10 events in a row', category: 'attendance' },
  { id: 'early_bird', name: 'Early Bird', icon: 'üê¶', description: 'Registered in first week', category: 'registration' },
  { id: 'returning_player', name: 'Returning Player', icon: 'home', description: 'Played multiple seasons', category: 'registration' },
  { id: 'team_player', name: 'Team Player', icon: 'ü§ù', description: 'Great sportsmanship', category: 'coach' },
  { id: 'mvp', name: 'MVP', icon: 'trophy', description: 'Most Valuable Player', category: 'coach' },
  { id: 'most_improved', name: 'Most Improved', icon: 'trending-up', description: 'Showed great improvement', category: 'coach' },
  { id: 'hustle_award', name: 'Hustle Award', icon: 'üí™', description: 'Always gives 100%', category: 'coach' },
  { id: 'first_game', name: 'Game Day', icon: 'üéÆ', description: 'Played first game', category: 'gameplay' },
  { id: 'first_win', name: 'Winner', icon: 'ü•á', description: 'Won first game', category: 'gameplay' },
  { id: 'tournament_ready', name: 'Tournament Ready', icon: 'target', description: 'Competed in a tournament', category: 'gameplay' },
]

// ============================================
// PLAYER PROFILE PAGE (Trading Card Style)
// ============================================
function PlayerProfilePage({ playerId, roleContext, showToast }) {
  const { organization } = useAuth()
  const tc = useThemeClasses()
  const { isDark } = useTheme()
  
  const [player, setPlayer] = useState(null)
  const [teams, setTeams] = useState([])
  const [stats, setStats] = useState(null)
  const [badges, setBadges] = useState([])
  const [loading, setLoading] = useState(true)
  const [activeTab, setActiveTab] = useState('overview')
  const [editingJersey, setEditingJersey] = useState(false)
  const [jerseyPrefs, setJerseyPrefs] = useState({ pref1: '', pref2: '', pref3: '', size: '' })

  useEffect(() => {
    loadPlayerData()
  }, [playerId])

  async function loadPlayerData() {
    setLoading(true)
    try {
      // First get basic player data
      const { data: playerData, error: playerError } = await supabase
        .from('players')
        .select('*')
        .eq('id', playerId)
        .single()

      if (playerError) {
        console.error('Player query error:', playerError)
        setLoading(false)
        return
      }

      if (!playerData) {
        console.error('No player found with id:', playerId)
        setLoading(false)
        return
      }

      // Get team_players separately
      const { data: teamPlayersData } = await supabase
        .from('team_players')
        .select('id, team_id, jersey_number, position, teams (id, name, color, season_id)')
        .eq('player_id', playerId)

      // Get season info if player has season_id
      let seasonData = null
      if (playerData.season_id) {
        const { data: season } = await supabase
          .from('seasons')
          .select('id, name, sport_id, sports (name, icon)')
          .eq('id', playerData.season_id)
          .single()
        seasonData = season
      }

      // Combine all data
      const enrichedPlayer = {
        ...playerData,
        seasons: seasonData,
        team_players: teamPlayersData || []
      }

      setPlayer(enrichedPlayer)
      setJerseyPrefs({
        pref1: playerData.jersey_pref_1 || '',
        pref2: playerData.jersey_pref_2 || '',
        pref3: playerData.jersey_pref_3 || '',
        size: playerData.uniform_size_jersey || ''
      })
      setTeams((teamPlayersData || []).map(tp => tp.teams).filter(Boolean))

      // Load badges (table might not exist yet, so handle gracefully)
      try {
        const { data: badgeData } = await supabase
          .from('player_badges')
          .select('badge_id, earned_at')
          .eq('player_id', playerId)

        if (badgeData) {
          const earnedBadges = badgeData.map(b => ({
            ...PLAYER_BADGES.find(pb => pb.id === b.badge_id),
            earned_at: b.earned_at
          })).filter(Boolean)
          setBadges(earnedBadges)
        }
      } catch (err) {
        console.log('Badges table may not exist yet:', err)
        setBadges([])
      }

      // Load attendance stats
      try {
        const { data: attendanceData } = await supabase
          .from('event_rsvps')
          .select('status, schedule_events(event_type)')
          .eq('player_id', playerId)

        if (attendanceData) {
          const attended = attendanceData.filter(r => r.status === 'attending' || r.status === 'attended').length
          const total = attendanceData.length
          setStats({
            attendanceRate: total > 0 ? Math.round((attended / total) * 100) : 0,
            gamesPlayed: attendanceData.filter(r => r.schedule_events?.event_type === 'game').length,
            practicesAttended: attendanceData.filter(r => r.schedule_events?.event_type === 'practice').length
          })
        }
      } catch (err) {
        console.log('Error loading attendance:', err)
        setStats({ attendanceRate: 0, gamesPlayed: 0, practicesAttended: 0 })
      }
    } catch (err) {
      console.error('Error loading player:', err)
    }
    setLoading(false)
  }

  async function saveJerseyPreferences() {
    try {
      const { error } = await supabase
        .from('players')
        .update({
          jersey_pref_1: jerseyPrefs.pref1 ? parseInt(jerseyPrefs.pref1) : null,
          jersey_pref_2: jerseyPrefs.pref2 ? parseInt(jerseyPrefs.pref2) : null,
          jersey_pref_3: jerseyPrefs.pref3 ? parseInt(jerseyPrefs.pref3) : null,
          uniform_size_jersey: jerseyPrefs.size || null
        })
        .eq('id', playerId)

      if (error) throw error
      showToast('Jersey preferences saved!', 'success')
      setEditingJersey(false)
      loadPlayerData()
    } catch (err) {
      showToast('Error saving preferences: ' + err.message, 'error')
    }
  }

  if (loading) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="animate-spin w-8 h-8 border-2 border-[var(--accent-primary)] border-t-transparent rounded-full" />
      </div>
    )
  }

  if (!player) {
    return (
      <div className="text-center py-12">
        <span className="text-6xl">üòï</span>
        <h2 className={`text-xl font-bold ${tc.text} mt-4`}>Player Not Found</h2>
      </div>
    )
  }

  const primaryTeam = teams[0]
  const teamColor = primaryTeam?.color || '#EAB308'

  return (
    <div className="max-w-4xl mx-auto space-y-6">
      {/* Player Card Header */}
      <div 
        className="relative rounded-3xl overflow-hidden"
        style={{ background: `linear-gradient(135deg, ${teamColor}40, ${teamColor}10)` }}
      >
        <div className="absolute inset-0 opacity-10">
          <div className="absolute top-0 right-0 w-64 h-64 rounded-full" style={{ background: teamColor, transform: 'translate(30%, -30%)' }} />
          <div className="absolute bottom-0 left-0 w-48 h-48 rounded-full" style={{ background: teamColor, transform: 'translate(-30%, 30%)' }} />
        </div>

        <div className="relative p-8">
          <div className="flex flex-col md:flex-row items-center gap-6">
            <div className="relative">
              {player.photo_url ? (
                <img 
                  src={player.photo_url} 
                  alt={player.first_name}
                  className="w-32 h-32 md:w-40 md:h-40 rounded-2xl object-cover border-4 border-white shadow-xl"
                />
              ) : (
                <div 
                  className="w-32 h-32 md:w-40 md:h-40 rounded-2xl flex items-center justify-center text-5xl font-bold border-4 border-white shadow-xl"
                  style={{ backgroundColor: `${teamColor}30`, color: teamColor }}
                >
                  {player.first_name?.[0]}{player.last_name?.[0]}
                </div>
              )}
              {player.team_players?.[0]?.jersey_number && (
                <div 
                  className="absolute -bottom-3 -right-3 w-14 h-14 rounded-xl flex items-center justify-center text-2xl font-bold text-white shadow-lg"
                  style={{ backgroundColor: teamColor }}
                >
                  {player.team_players[0].jersey_number}
                </div>
              )}
            </div>

            <div className="flex-1 text-center md:text-left">
              <h1 className={`text-3xl md:text-4xl font-bold ${tc.text}`}>
                {player.first_name} {player.last_name}
              </h1>
              <div className="flex flex-wrap justify-center md:justify-start gap-2 mt-3">
                {teams.map(team => (
                  <span 
                    key={team.id}
                    className="px-3 py-1 rounded-full text-sm font-medium text-white"
                    style={{ backgroundColor: team.color || '#EAB308' }}
                  >
                    {team.name}
                  </span>
                ))}
              </div>
            </div>

            <div className="flex gap-4">
              <div className="text-center">
                <p className="text-3xl font-bold" style={{ color: teamColor }}>{stats?.gamesPlayed || 0}</p>
                <p className={`text-xs ${tc.textMuted}`}>Games</p>
              </div>
              <div className="text-center">
                <p className="text-3xl font-bold" style={{ color: teamColor }}>{stats?.attendanceRate || 0}%</p>
                <p className={`text-xs ${tc.textMuted}`}>Attendance</p>
              </div>
              <div className="text-center">
                <p className="text-3xl font-bold" style={{ color: teamColor }}>{badges.length}</p>
                <p className={`text-xs ${tc.textMuted}`}>Badges</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Tabs */}
      <div className={`${tc.cardBg} border ${tc.border} rounded-2xl overflow-hidden`}>
        <div className={`flex border-b ${tc.border}`}>
          {[
            { id: 'overview', label: 'Overview', icon: 'clipboard' },
            { id: 'jersey', label: 'Jersey', icon: 'shirt' },
            { id: 'badges', label: 'Badges', icon: 'trophy' },
          ].map(tab => (
            <button
              key={tab.id}
              onClick={() => setActiveTab(tab.id)}
              className={`flex-1 px-4 py-3 font-medium transition flex items-center justify-center gap-2 text-sm ${
                activeTab === tab.id ? 'border-b-2 text-[var(--accent-primary)]' : `${tc.textMuted} ${tc.hoverBg}`
              }`}
              style={activeTab === tab.id ? { borderColor: teamColor, color: teamColor } : {}}
            >
              <span>{tab.icon}</span>
              <span className="hidden sm:inline">{tab.label}</span>
            </button>
          ))}
        </div>

        <div className="p-6">
          {activeTab === 'overview' && (
            <div className="space-y-6">
              <div>
                <h3 className={`font-semibold ${tc.text} mb-3`}>Registration Info</h3>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <div className={`${tc.cardBgAlt} rounded-xl p-4`}>
                    <p className={`text-xs ${tc.textMuted}`}>Season</p>
                    <p className={`font-medium ${tc.text}`}>{player.seasons?.name || 'N/A'}</p>
                  </div>
                  <div className={`${tc.cardBgAlt} rounded-xl p-4`}>
                    <p className={`text-xs ${tc.textMuted}`}>Sport</p>
                    <p className={`font-medium ${tc.text}`}>{player.seasons?.sports?.icon} {player.seasons?.sports?.name || 'N/A'}</p>
                  </div>
                  <div className={`${tc.cardBgAlt} rounded-xl p-4`}>
                    <p className={`text-xs ${tc.textMuted}`}>Status</p>
                    <p className={`font-medium ${player.status === 'active' ? 'text-emerald-500' : tc.text}`}>
                      {player.status === 'active' ? '‚úì Active' : player.status}
                    </p>
                  </div>
                  <div className={`${tc.cardBgAlt} rounded-xl p-4`}>
                    <p className={`text-xs ${tc.textMuted}`}>Registered</p>
                    <p className={`font-medium ${tc.text}`}>{player.created_at ? new Date(player.created_at).toLocaleDateString() : 'N/A'}</p>
                  </div>
                </div>
              </div>

              <div>
                <h3 className={`font-semibold ${tc.text} mb-3`}>Attendance Summary</h3>
                <div className="grid grid-cols-3 gap-4">
                  <div className={`${tc.cardBgAlt} rounded-xl p-4 text-center`}>
                    <p className="text-3xl font-bold text-emerald-500">{stats?.attendanceRate || 0}%</p>
                    <p className={`text-xs ${tc.textMuted}`}>Overall Rate</p>
                  </div>
                  <div className={`${tc.cardBgAlt} rounded-xl p-4 text-center`}>
                    <p className="text-3xl font-bold" style={{ color: teamColor }}>{stats?.practicesAttended || 0}</p>
                    <p className={`text-xs ${tc.textMuted}`}>Practices</p>
                  </div>
                  <div className={`${tc.cardBgAlt} rounded-xl p-4 text-center`}>
                    <p className="text-3xl font-bold" style={{ color: teamColor }}>{stats?.gamesPlayed || 0}</p>
                    <p className={`text-xs ${tc.textMuted}`}>Games</p>
                  </div>
                </div>
              </div>
            </div>
          )}

          {activeTab === 'jersey' && (
            <div className="space-y-6">
              <div>
                <h3 className={`font-semibold ${tc.text} mb-3`}>Current Jersey</h3>
                <div className="flex items-center gap-6">
                  <div 
                    className="w-24 h-28 rounded-xl flex flex-col items-center justify-center text-white relative overflow-hidden"
                    style={{ backgroundColor: teamColor }}
                  >
                    <div className="absolute top-0 left-1/2 -translate-x-1/2 w-8 h-3 rounded-b-full" style={{ backgroundColor: 'rgba(0,0,0,0.2)' }} />
                    <span className="text-4xl font-bold mt-2">{player.team_players?.[0]?.jersey_number || '?'}</span>
                    <span className="text-xs opacity-80 mt-1">{primaryTeam?.name}</span>
                  </div>
                  <div className="flex-1">
                    <p className={tc.text}><span className="font-semibold">Number:</span> #{player.team_players?.[0]?.jersey_number || 'Not assigned'}</p>
                    <p className={tc.text}><span className="font-semibold">Size:</span> {player.uniform_size_jersey || 'Not set'}</p>
                  </div>
                </div>
              </div>

              <div>
                <div className="flex items-center justify-between mb-3">
                  <h3 className={`font-semibold ${tc.text}`}>Your Preferences</h3>
                  {!editingJersey && (
                    <button onClick={() => setEditingJersey(true)} className="px-3 py-1.5 rounded-lg text-sm font-medium bg-[var(--accent-primary)]/10 text-[var(--accent-primary)]"><Edit className="w-4 h-4 inline mr-1" />Edit</button>
                  )}
                </div>

                {editingJersey ? (
                  <div className={`${tc.cardBgAlt} rounded-xl p-5 space-y-4`}>
                    <p className={`text-sm ${tc.textMuted}`}>Set your preferred jersey numbers!</p>
                    <div className="grid grid-cols-3 gap-4">
                      <div>
                        <label className={`block text-xs ${tc.textMuted} mb-1`}>1st Choice</label>
                        <input type="number" min="1" max="99" value={jerseyPrefs.pref1} onChange={e => setJerseyPrefs({ ...jerseyPrefs, pref1: e.target.value })} placeholder="1-99" className={`w-full px-3 py-2 rounded-lg border ${tc.input} text-center text-xl font-bold`} />
                      </div>
                      <div>
                        <label className={`block text-xs ${tc.textMuted} mb-1`}>2nd Choice</label>
                        <input type="number" min="1" max="99" value={jerseyPrefs.pref2} onChange={e => setJerseyPrefs({ ...jerseyPrefs, pref2: e.target.value })} placeholder="1-99" className={`w-full px-3 py-2 rounded-lg border ${tc.input} text-center text-xl font-bold`} />
                      </div>
                      <div>
                        <label className={`block text-xs ${tc.textMuted} mb-1`}>3rd Choice</label>
                        <input type="number" min="1" max="99" value={jerseyPrefs.pref3} onChange={e => setJerseyPrefs({ ...jerseyPrefs, pref3: e.target.value })} placeholder="1-99" className={`w-full px-3 py-2 rounded-lg border ${tc.input} text-center text-xl font-bold`} />
                      </div>
                    </div>
                    <div>
                      <label className={`block text-xs ${tc.textMuted} mb-1`}>Jersey Size</label>
                      <select value={jerseyPrefs.size} onChange={e => setJerseyPrefs({ ...jerseyPrefs, size: e.target.value })} className={`w-full px-3 py-2 rounded-lg border ${tc.input}`}>
                        <option value="">Select size...</option>
                        <optgroup label="Youth"><option value="YXS">Youth XS</option><option value="YS">Youth S</option><option value="YM">Youth M</option><option value="YL">Youth L</option><option value="YXL">Youth XL</option></optgroup>
                        <optgroup label="Adult"><option value="AS">Adult S</option><option value="AM">Adult M</option><option value="AL">Adult L</option><option value="AXL">Adult XL</option><option value="A2XL">Adult 2XL</option></optgroup>
                      </select>
                    </div>
                    <div className="flex gap-3">
                      <button onClick={() => setEditingJersey(false)} className={`flex-1 py-2 rounded-lg ${tc.cardBg} border ${tc.border} ${tc.text}`}>Cancel</button>
                      <button onClick={saveJerseyPreferences} className="flex-1 py-2 rounded-lg bg-[var(--accent-primary)] text-white font-semibold">Save Preferences</button>
                    </div>
                  </div>
                ) : (
                  <div className={`${tc.cardBgAlt} rounded-xl p-4`}>
                    <div className="grid grid-cols-4 gap-4 text-center">
                      <div><p className={`text-xs ${tc.textMuted}`}>1st Choice</p><p className={`text-2xl font-bold ${tc.text}`}>{player.jersey_pref_1 || '‚Äî'}</p></div>
                      <div><p className={`text-xs ${tc.textMuted}`}>2nd Choice</p><p className={`text-2xl font-bold ${tc.text}`}>{player.jersey_pref_2 || '‚Äî'}</p></div>
                      <div><p className={`text-xs ${tc.textMuted}`}>3rd Choice</p><p className={`text-2xl font-bold ${tc.text}`}>{player.jersey_pref_3 || '‚Äî'}</p></div>
                      <div><p className={`text-xs ${tc.textMuted}`}>Size</p><p className={`text-2xl font-bold ${tc.text}`}>{player.uniform_size_jersey || '‚Äî'}</p></div>
                    </div>
                  </div>
                )}
              </div>
            </div>
          )}

          {activeTab === 'badges' && (
            <div className="space-y-6">
              <div>
                <h3 className={`font-semibold ${tc.text} mb-3`}>Earned Badges ({badges.length})</h3>
                {badges.length > 0 ? (
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    {badges.map(badge => (
                      <div key={badge.id} className={`${tc.cardBgAlt} rounded-xl p-4 text-center hover:scale-105 transition`}>
                        <span className="text-4xl">{badge.icon}</span>
                        <p className={`font-semibold ${tc.text} mt-2`}>{badge.name}</p>
                        <p className={`text-xs ${tc.textMuted}`}>{badge.description}</p>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className={`${tc.cardBgAlt} rounded-xl p-8 text-center`}>
                    <Target className="w-16 h-16" />
                    <p className={`${tc.textSecondary} mt-2`}>No badges earned yet</p>
                    <p className={`text-sm ${tc.textMuted}`}>Keep playing to unlock badges!</p>
                  </div>
                )}
              </div>

              <div>
                <h3 className={`font-semibold ${tc.text} mb-3`}>Available Badges</h3>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                  {PLAYER_BADGES.filter(b => !badges.find(eb => eb.id === b.id)).slice(0, 8).map(badge => (
                    <div key={badge.id} className={`${tc.cardBgAlt} rounded-xl p-4 text-center opacity-50`}>
                      <span className="text-4xl grayscale">{badge.icon}</span>
                      <p className={`font-semibold ${tc.textMuted} mt-2`}>{badge.name}</p>
                      <p className={`text-xs ${tc.textMuted}`}>{badge.description}</p>
                      <p className="text-xs text-amber-500 mt-1"><Lock className="w-3 h-3 inline mr-1" />Locked</p>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  )
}

// ============================================
// PARENT MESSAGES PAGE
// ============================================
function ParentMessagesPage({ roleContext, showToast }) {
  const { user } = useAuth()
  const tc = useThemeClasses()
  const { isDark } = useTheme()
  
  const [teams, setTeams] = useState([])
  const [selectedTeam, setSelectedTeam] = useState(null)
  const [announcements, setAnnouncements] = useState([])
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    loadTeams()
  }, [roleContext])

  useEffect(() => {
    if (selectedTeam) loadAnnouncements()
  }, [selectedTeam])

  async function loadTeams() {
    const playerIds = roleContext?.children?.map(c => c.id) || []
    if (playerIds.length === 0) { setLoading(false); return }

    try {
      const { data: teamPlayers } = await supabase.from('team_players').select('team_id, teams(id, name, color)').in('player_id', playerIds)
      const uniqueTeams = [...new Map((teamPlayers || []).filter(tp => tp.teams).map(tp => [tp.teams.id, tp.teams])).values()]
      setTeams(uniqueTeams)
      if (uniqueTeams.length > 0) setSelectedTeam(uniqueTeams[0])
    } catch (err) { console.error('Error loading teams:', err) }
    setLoading(false)
  }

  async function loadAnnouncements() {
    if (!selectedTeam) return
    try {
      const { data: posts } = await supabase.from('team_posts').select('*, profiles(full_name)').eq('team_id', selectedTeam.id).order('created_at', { ascending: false }).limit(20)
      setAnnouncements(posts || [])
    } catch (err) { console.error('Error loading announcements:', err) }
  }

  if (loading) return <div className="flex items-center justify-center h-64"><div className="animate-spin w-8 h-8 border-2 border-[var(--accent-primary)] border-t-transparent rounded-full" /></div>

  if (teams.length === 0) return <div className="text-center py-12"><MessageCircle className="w-16 h-16" /><h2 className={`text-xl font-bold ${tc.text} mt-4`}>No Teams</h2><p className={tc.textMuted}>Join a team to see messages</p></div>

  return (
    <div className="max-w-4xl mx-auto space-y-6">
      <div><h1 className={`text-3xl font-bold ${tc.text}`}>Messages</h1><p className={tc.textSecondary}>Stay connected with your team</p></div>

      <div className="flex gap-2 overflow-x-auto pb-2">
        {teams.map(team => (
          <button key={team.id} onClick={() => setSelectedTeam(team)} className={`px-4 py-2 rounded-xl whitespace-nowrap flex items-center gap-2 transition font-medium ${selectedTeam?.id === team.id ? 'text-white shadow-lg' : `${tc.cardBg} border ${tc.border} ${tc.textSecondary} ${tc.hoverBg}`}`} style={selectedTeam?.id === team.id ? { backgroundColor: team.color } : {}}>
            <span className="w-2 h-2 rounded-full" style={{ backgroundColor: team.color }} />{team.name}
          </button>
        ))}
      </div>

      <div className={`${tc.cardBg} border ${tc.border} rounded-2xl p-4 space-y-4 max-h-[500px] overflow-y-auto`}>
        <h3 className={`font-semibold ${tc.text}`}>Team Announcements</h3>
        {announcements.length > 0 ? announcements.map(post => (
          <div key={post.id} className={`${tc.cardBgAlt} rounded-xl p-4`}>
            <div className="flex items-center justify-between mb-2">
              <span className={`text-xs px-2 py-1 rounded-full ${post.post_type === 'announcement' ? 'bg-red-500/20 text-red-500' : 'bg-blue-500/20 text-blue-500'}`}>{post.post_type || 'Update'}</span>
              <span className={`text-xs ${tc.textMuted}`}>{new Date(post.created_at).toLocaleDateString()}</span>
            </div>
            <h3 className={`font-semibold ${tc.text}`}>{post.title}</h3>
            <p className={`${tc.textSecondary} text-sm mt-1`}>{post.content}</p>
            {post.profiles && <p className={`text-xs ${tc.textMuted} mt-2`}>‚Äî {post.profiles.full_name}</p>}
          </div>
        )) : <div className="text-center py-8"><span className="text-4xl">üì≠</span><p className={tc.textSecondary}>No announcements yet</p></div>}
      </div>
    </div>
  )
}

// ============================================
// INVITE FRIENDS PAGE
// ============================================
function InviteFriendsPage({ roleContext, showToast }) {
  const { organization } = useAuth()
  const tc = useThemeClasses()
  const { isDark } = useTheme()
  
  const [registrationLink, setRegistrationLink] = useState('')
  const [copied, setCopied] = useState(false)

  useEffect(() => {
    if (organization) {
      const baseUrl = window.location.origin
      setRegistrationLink(`${baseUrl}/register/${organization.id}`)
    }
  }, [organization])

  function copyLink() {
    navigator.clipboard.writeText(registrationLink)
    setCopied(true)
    showToast('Link copied to clipboard!', 'success')
    setTimeout(() => setCopied(false), 2000)
  }

  function shareVia(platform) {
    const text = `Join our youth volleyball league! Register here: ${registrationLink}`
    const encodedText = encodeURIComponent(text)
    const encodedUrl = encodeURIComponent(registrationLink)
    const urls = {
      facebook: `https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}`,
      twitter: `https://twitter.com/intent/tweet?text=${encodedText}`,
      whatsapp: `https://wa.me/?text=${encodedText}`,
      email: `mailto:?subject=Join Our League!&body=${encodedText}`,
      sms: `sms:?body=${encodedText}`
    }
    if (urls[platform]) window.open(urls[platform], '_blank')
  }

  return (
    <div className="max-w-2xl mx-auto space-y-6">
      <div><h1 className={`text-3xl font-bold ${tc.text}`}>Invite Friends üéâ</h1><p className={tc.textSecondary}>Share the fun! Invite friends to join the league.</p></div>

      <div className={`${tc.cardBg} border ${tc.border} rounded-2xl p-6`}>
        <div className="text-center mb-6">
          <span className="text-6xl"><VolleyballIcon className="w-16 h-16" /></span>
          <h2 className={`text-xl font-bold ${tc.text} mt-4`}>{organization?.name || 'Our League'}</h2>
          <p className={tc.textMuted}>Share this link with friends to register</p>
        </div>

        <div className={`${tc.cardBgAlt} rounded-xl p-4 flex items-center gap-3`}>
          <input type="text" value={registrationLink} readOnly className={`flex-1 bg-transparent ${tc.text} text-sm truncate outline-none`} />
          <button onClick={copyLink} className={`px-4 py-2 rounded-lg font-medium transition ${copied ? 'bg-emerald-500 text-white' : 'bg-[var(--accent-primary)] text-white hover:brightness-110'}`}>
            {copied ? '‚úì Copied!' : 'Copy'}
          </button>
        </div>

        <div className="mt-6">
          <p className={`text-sm ${tc.textMuted} mb-3 text-center`}>Or share via</p>
          <div className="flex justify-center gap-3 flex-wrap">
            <button onClick={() => shareVia('facebook')} className="w-12 h-12 rounded-xl bg-[#1877F2] text-white flex items-center justify-center text-2xl hover:scale-105 transition" title="Facebook">f</button>
            <button onClick={() => shareVia('twitter')} className="w-12 h-12 rounded-xl bg-[#1DA1F2] text-white flex items-center justify-center text-2xl hover:scale-105 transition" title="Twitter">ùïè</button>
            <button onClick={() => shareVia('whatsapp')} className="w-12 h-12 rounded-xl bg-[#25D366] text-white flex items-center justify-center text-2xl hover:scale-105 transition" title="WhatsApp">üí¨</button>
            <button onClick={() => shareVia('email')} className={`w-12 h-12 rounded-xl ${tc.cardBgAlt} ${tc.text} flex items-center justify-center text-2xl hover:scale-105 transition`} title="Email">üìß</button>
            <button onClick={() => shareVia('sms')} className={`w-12 h-12 rounded-xl ${tc.cardBgAlt} ${tc.text} flex items-center justify-center text-2xl hover:scale-105 transition`} title="Text">üì±</button>
          </div>
        </div>
      </div>

      <div className={`${tc.cardBg} border ${tc.border} rounded-2xl p-6`}>
        <h3 className={`font-semibold ${tc.text} mb-4`}>üéÅ Referral Rewards</h3>
        <div className="grid grid-cols-3 gap-4 text-center">
          <div className={`${tc.cardBgAlt} rounded-xl p-4`}><p className="text-2xl">ü•â</p><p className={`font-bold ${tc.text} mt-1`}>1 Friend</p><p className={`text-xs ${tc.textMuted}`}>Bronze Badge</p></div>
          <div className={`${tc.cardBgAlt} rounded-xl p-4`}><p className="text-2xl">ü•à</p><p className={`font-bold ${tc.text} mt-1`}>3 Friends</p><p className={`text-xs ${tc.textMuted}`}>Silver Badge</p></div>
          <div className={`${tc.cardBgAlt} rounded-xl p-4`}><p className="text-2xl">ü•á</p><p className={`font-bold ${tc.text} mt-1`}>5+ Friends</p><p className={`text-xs ${tc.textMuted}`}>Gold Badge + Swag!</p></div>
        </div>
      </div>
    </div>
  )
}

// ============================================
// PARENT PAYMENTS PAGE (Privacy-Aware)
// ============================================
function ParentPaymentsPage({ roleContext, showToast }) {
  const { user } = useAuth()
  const tc = useThemeClasses()
  const { isDark } = useTheme()
  
  const [payments, setPayments] = useState([])
  const [loading, setLoading] = useState(true)
  const [selectedPayments, setSelectedPayments] = useState(new Set())
  const [processing, setProcessing] = useState(false)
  const [organization, setOrganization] = useState(null)
  const [showPaymentOptions, setShowPaymentOptions] = useState(false)

  useEffect(() => { loadPayments() }, [roleContext])

  async function loadPayments() {
    const playerIds = roleContext?.children?.map(c => c.id) || []
    if (playerIds.length === 0) { setLoading(false); return }

    try {
      const { data } = await supabase
        .from('payments')
        .select('*, players (id, first_name, last_name, season_id), seasons (id, name, organization_id, organizations(id, name, payment_venmo, payment_zelle, payment_cashapp, payment_instructions, stripe_enabled, stripe_publishable_key))')
        .in('player_id', playerIds)
        .order('created_at', { ascending: false })
      
      setPayments(data || [])
      
      // Get organization from first payment
      if (data?.[0]?.seasons?.organizations) {
        setOrganization(data[0].seasons.organizations)
      }
    } catch (err) { console.error('Error loading payments:', err) }
    setLoading(false)
  }

  const totalDue = payments.filter(p => !p.paid).reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0)
  const totalPaid = payments.filter(p => p.paid).reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0)
  const unpaidPayments = payments.filter(p => !p.paid)
  const paidPayments = payments.filter(p => p.paid)
  
  // Calculate selected total
  const selectedTotal = unpaidPayments
    .filter(p => selectedPayments.has(p.id))
    .reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0)

  function togglePaymentSelection(paymentId) {
    const newSelected = new Set(selectedPayments)
    if (newSelected.has(paymentId)) {
      newSelected.delete(paymentId)
    } else {
      newSelected.add(paymentId)
    }
    setSelectedPayments(newSelected)
  }

  function selectAllUnpaid() {
    setSelectedPayments(new Set(unpaidPayments.map(p => p.id)))
  }

  function clearSelection() {
    setSelectedPayments(new Set())
  }

  async function handleStripeCheckout() {
    if (selectedPayments.size === 0) {
      showToast('Please select fees to pay', 'warning')
      return
    }
    
    setProcessing(true)
    try {
      // In production, you'd call your backend to create a Stripe Checkout session
      // For now, we'll show the manual payment options
      showToast('Stripe checkout coming soon! Use manual payment options below.', 'info')
      setShowPaymentOptions(true)
    } catch (err) {
      showToast('Error: ' + err.message, 'error')
    }
    setProcessing(false)
  }

  if (loading) return <div className="flex items-center justify-center h-64"><div className="animate-spin w-8 h-8 border-2 border-[var(--accent-primary)] border-t-transparent rounded-full" /></div>

  return (
    <div className="max-w-4xl mx-auto space-y-6">
      <div>
        <h1 className={`text-3xl font-bold ${tc.text}`}>Payments</h1>
        <p className={tc.textSecondary}>Manage your family's payments</p>
      </div>

      {/* Summary Cards */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div className={`${tc.cardBg} border ${tc.border} rounded-2xl p-5`}>
          <p className={tc.textMuted}>Total Due</p>
          <p className={`text-3xl font-bold ${totalDue > 0 ? 'text-red-500' : 'text-emerald-500'}`}>${totalDue.toFixed(2)}</p>
          {unpaidPayments.length > 0 && <p className="text-xs text-red-400 mt-1">{unpaidPayments.length} unpaid fees</p>}
        </div>
        <div className={`${tc.cardBg} border ${tc.border} rounded-2xl p-5`}>
          <p className={tc.textMuted}>Total Paid</p>
          <p className="text-3xl font-bold text-emerald-500">${totalPaid.toFixed(2)}</p>
          <p className={`text-xs ${tc.textMuted} mt-1`}>{paidPayments.length} payments</p>
        </div>
        <div className={`${tc.cardBg} border ${tc.border} rounded-2xl p-5`}>
          {selectedPayments.size > 0 ? (
            <div>
              <p className={tc.textMuted}>Selected</p>
              <p className="text-3xl font-bold text-[var(--accent-primary)]">${selectedTotal.toFixed(2)}</p>
              <p className={`text-xs ${tc.textMuted} mt-1`}>{selectedPayments.size} fees selected</p>
            </div>
          ) : totalDue > 0 ? (
            <div className="flex flex-col justify-center h-full">
              <p className={`text-sm ${tc.textMuted} mb-2`}>Select fees below to pay</p>
              <button 
                onClick={selectAllUnpaid}
                className="py-2 rounded-xl bg-[var(--accent-primary)]/20 text-[var(--accent-primary)] font-medium hover:bg-[var(--accent-primary)]/30 transition"
              >
                Select All
              </button>
            </div>
          ) : (
            <div className="flex flex-col items-center justify-center h-full">
              <Check className="w-12 h-12 text-emerald-500" />
              <p className={`${tc.text} font-semibold mt-2`}>All Paid!</p>
            </div>
          )}
        </div>
      </div>

      {/* Pay Selected Button */}
      {selectedPayments.size > 0 && (
        <div className={`${tc.cardBg} border-2 border-[var(--accent-primary)] rounded-2xl p-5`}>
          <div className="flex items-center justify-between">
            <div>
              <p className={tc.text}>Ready to pay <span className="font-bold">${selectedTotal.toFixed(2)}</span></p>
              <p className={`text-sm ${tc.textMuted}`}>{selectedPayments.size} fees selected</p>
            </div>
            <div className="flex gap-3">
              <button 
                onClick={clearSelection}
                className={`px-4 py-2 rounded-xl border ${tc.border} ${tc.text}`}
              >
                Clear
              </button>
              <button 
                onClick={() => setShowPaymentOptions(true)}
                disabled={processing}
                className="px-6 py-2 rounded-xl bg-[var(--accent-primary)] text-white font-semibold hover:brightness-110 transition disabled:opacity-50"
              >
                {processing ? 'Processing...' : 'üí≥ Pay Now'}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Outstanding Payments */}
      {unpaidPayments.length > 0 && (
        <div className={`${tc.cardBg} border ${tc.border} rounded-2xl p-5`}>
          <div className="flex items-center justify-between mb-4">
            <h2 className={`font-semibold ${tc.text} flex items-center gap-2`}>
              <span className="text-red-500">‚ö†Ô∏è</span> Outstanding Payments
            </h2>
            <button 
              onClick={selectedPayments.size === unpaidPayments.length ? clearSelection : selectAllUnpaid}
              className="text-sm text-[var(--accent-primary)] hover:underline"
            >
              {selectedPayments.size === unpaidPayments.length ? 'Deselect All' : 'Select All'}
            </button>
          </div>
          <div className="space-y-3">
            {unpaidPayments.map(payment => {
              const isSelected = selectedPayments.has(payment.id)
              return (
                <div 
                  key={payment.id} 
                  onClick={() => togglePaymentSelection(payment.id)}
                  className={`${tc.cardBgAlt} rounded-xl p-4 flex items-center gap-4 cursor-pointer transition ${isSelected ? 'ring-2 ring-[var(--accent-primary)]' : 'hover:bg-slate-800/50'}`}
                >
                  <div className={`w-6 h-6 rounded-lg border-2 flex items-center justify-center transition ${isSelected ? 'bg-[var(--accent-primary)] border-[var(--accent-primary)]' : `border-slate-600`}`}>
                    {isSelected && <span className="text-white text-sm">‚úì</span>}
                  </div>
                  <div className="w-12 h-12 rounded-xl bg-red-500/20 flex items-center justify-center">
                    <span className="text-2xl">üíµ</span>
                  </div>
                  <div className="flex-1">
                    <p className={`font-semibold ${tc.text}`}>{payment.fee_name || payment.description || 'Payment'}</p>
                    <p className={`text-sm ${tc.textMuted}`}>
                      {payment.players?.first_name} ‚Ä¢ {payment.seasons?.name || 'Season'}
                      {payment.due_date && ` ‚Ä¢ Due ${new Date(payment.due_date).toLocaleDateString()}`}
                    </p>
                    {payment.fee_category === 'per_family' && (
                      <span className="text-xs bg-blue-500/20 text-blue-400 px-2 py-0.5 rounded-full">Family Fee</span>
                    )}
                  </div>
                  <div className="text-right">
                    <p className="text-xl font-bold text-red-500">${parseFloat(payment.amount).toFixed(2)}</p>
                  </div>
                </div>
              )
            })}
          </div>
        </div>
      )}

      {/* Payment Options Modal */}
      {showPaymentOptions && (
        <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50">
          <div className={`${tc.cardBg} border ${tc.border} rounded-2xl w-full max-w-md`}>
            <div className={`p-6 border-b ${tc.border}`}>
              <h2 className={`text-xl font-semibold ${tc.text}`}>Payment Options</h2>
              <p className={`${tc.textMuted} text-sm mt-1`}>Total: ${selectedTotal.toFixed(2)}</p>
            </div>
            
            <div className="p-6 space-y-4">
              {/* Selected fees summary */}
              <div className={`${tc.cardBgAlt} rounded-xl p-4 max-h-40 overflow-y-auto`}>
                <p className={`text-xs ${tc.textMuted} uppercase mb-2`}>Paying for:</p>
                {unpaidPayments.filter(p => selectedPayments.has(p.id)).map(p => (
                  <div key={p.id} className="flex justify-between text-sm py-1">
                    <span className={tc.textSecondary}>{p.fee_name || p.description} ({p.players?.first_name})</span>
                    <span className={tc.text}>${parseFloat(p.amount).toFixed(2)}</span>
                  </div>
                ))}
                <div className={`flex justify-between font-bold pt-2 mt-2 border-t ${tc.border}`}>
                  <span className={tc.text}>Total</span>
                  <span className="text-[var(--accent-primary)]">${selectedTotal.toFixed(2)}</span>
                </div>
              </div>

              {/* Payment methods */}
              <div className="space-y-3">
                <p className={`text-sm font-medium ${tc.text}`}>Send payment via:</p>
                
                {organization?.payment_venmo && (
                  <a 
                    href={`https://venmo.com/${organization.payment_venmo}?txn=pay&amount=${selectedTotal.toFixed(2)}&note=VolleyBrain%20Fees`}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="flex items-center gap-3 p-4 bg-[#3D95CE]/20 rounded-xl hover:bg-[#3D95CE]/30 transition"
                  >
                    <span className="text-2xl">üí≥</span>
                    <div className="flex-1">
                      <p className="font-medium text-[#3D95CE]">Venmo</p>
                      <p className={`text-sm ${tc.textMuted}`}>@{organization.payment_venmo}</p>
                    </div>
                    <span className="text-[#3D95CE]">‚Üí</span>
                  </a>
                )}
                
                {organization?.payment_zelle && (
                  <div className="flex items-center gap-3 p-4 bg-purple-500/20 rounded-xl">
                    <span className="text-2xl">üí∏</span>
                    <div className="flex-1">
                      <p className="font-medium text-purple-400">Zelle</p>
                      <p className={`text-sm ${tc.textMuted}`}>{organization.payment_zelle}</p>
                    </div>
                    <button 
                      onClick={() => {
                        navigator.clipboard.writeText(organization.payment_zelle)
                        showToast('Zelle email copied!', 'success')
                      }}
                      className="text-purple-400 hover:underline text-sm"
                    >
                      Copy
                    </button>
                  </div>
                )}
                
                {organization?.payment_cashapp && (
                  <a 
                    href={`https://cash.app/${organization.payment_cashapp}/${selectedTotal.toFixed(2)}`}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="flex items-center gap-3 p-4 bg-emerald-500/20 rounded-xl hover:bg-emerald-500/30 transition"
                  >
                    <span className="text-2xl">üíµ</span>
                    <div className="flex-1">
                      <p className="font-medium text-emerald-400">Cash App</p>
                      <p className={`text-sm ${tc.textMuted}`}>{organization.payment_cashapp}</p>
                    </div>
                    <span className="text-emerald-400">‚Üí</span>
                  </a>
                )}

                {organization?.payment_instructions && (
                  <div className={`p-4 ${tc.cardBgAlt} rounded-xl`}>
                    <p className={`text-sm font-medium ${tc.text} mb-2`}>Other Payment Options:</p>
                    <p className={`text-sm ${tc.textSecondary} whitespace-pre-wrap`}>{organization.payment_instructions}</p>
                  </div>
                )}

                {!organization?.payment_venmo && !organization?.payment_zelle && !organization?.payment_cashapp && !organization?.payment_instructions && (
                  <div className={`p-4 ${tc.cardBgAlt} rounded-xl text-center`}>
                    <p className={tc.textMuted}>Contact your league administrator for payment options.</p>
                  </div>
                )}
              </div>

              <div className={`bg-amber-500/10 border border-amber-500/30 rounded-xl p-4`}>
                <p className="text-amber-400 text-sm">
                  üí° After sending payment, your admin will mark it as paid within 1-2 business days.
                </p>
              </div>
            </div>
            
            <div className={`p-6 border-t ${tc.border}`}>
              <button 
                onClick={() => setShowPaymentOptions(false)} 
                className={`w-full py-2 rounded-xl border ${tc.border} ${tc.text}`}
              >
                Close
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Payment History */}
      <div className={`${tc.cardBg} border ${tc.border} rounded-2xl p-5`}>
        <h2 className={`font-semibold ${tc.text} mb-4`}>Payment History</h2>
        {paidPayments.length > 0 ? (
          <div className="space-y-2">
            {paidPayments.map(payment => (
              <div key={payment.id} className={`${tc.cardBgAlt} rounded-xl p-4 flex items-center gap-4`}>
                <div className="w-10 h-10 rounded-lg bg-emerald-500/20 flex items-center justify-center">
                  <span className="text-emerald-500">‚úì</span>
                </div>
                <div className="flex-1">
                  <p className={tc.text}>{payment.fee_name || payment.description || 'Payment'}</p>
                  <p className={`text-xs ${tc.textMuted}`}>
                    {payment.players?.first_name} ‚Ä¢ {payment.payment_method && `${payment.payment_method} ‚Ä¢ `}
                    {payment.paid_at ? new Date(payment.paid_at).toLocaleDateString() : new Date(payment.updated_at).toLocaleDateString()}
                  </p>
                </div>
                <p className="font-semibold text-emerald-500">${parseFloat(payment.amount).toFixed(2)}</p>
              </div>
            ))}
          </div>
        ) : (
          <div className="text-center py-6">
            <span className="text-4xl">üìú</span>
            <p className={tc.textMuted}>No payment history</p>
          </div>
        )}
      </div>
    </div>
  )
}

// ============================================
// PARENT DASHBOARD
// ============================================
function ParentDashboard({ roleContext, navigateToTeamWall, showToast, onNavigate }) {
  const { profile } = useAuth()
  const tc = useThemeClasses()
  const { isDark } = useTheme()
  const { selectedSport } = useSport()
  
  const [loading, setLoading] = useState(true)
  const [upcomingEvents, setUpcomingEvents] = useState([])
  const [payments, setPayments] = useState([])
  const [recentPosts, setRecentPosts] = useState([])
  const [playerDetails, setPlayerDetails] = useState([])
  const [selectedEventDetail, setSelectedEventDetail] = useState(null)
  const [teams, setTeams] = useState([])
  
  // New state for registration features
  const [registrationData, setRegistrationData] = useState([])
  const [openSeasons, setOpenSeasons] = useState([])
  const [showAddChildModal, setShowAddChildModal] = useState(false)
  const [showReRegisterModal, setShowReRegisterModal] = useState(null)
  
  // Helper to generate GitHub Pages registration URL
  function getRegistrationUrl(season) {
    const orgSlug = season.organizations?.slug || 'black-hornets'
    const registrationBaseUrl = season.organizations?.settings?.registration_url || 'https://sgtxtorque.github.io/volleyball-registration'
    return `${registrationBaseUrl}?org=${orgSlug}&season=${season.id}`
  }

  useEffect(() => {
    if (roleContext?.children?.length > 0) {
      loadParentData()
    } else {
      setLoading(false)
      // Still load open seasons even if no children yet
      loadOpenSeasons()
    }
  }, [roleContext])

  async function loadOpenSeasons() {
    try {
      // Get organizations the parent has players in (or any open registrations)
      const parentEmail = profile?.email
      if (!parentEmail) return
      
      // First get org IDs from existing players
      const playerIds = roleContext?.children?.map(c => c.id) || []
      let orgIds = []
      
      if (playerIds.length > 0) {
        const { data: playerSeasons } = await supabase
          .from('players')
          .select('season_id, seasons(organization_id)')
          .in('id', playerIds)
        
        orgIds = [...new Set((playerSeasons || []).map(p => p.seasons?.organization_id).filter(Boolean))]
      }
      
      // Get seasons with open registration
      const now = new Date().toISOString()
      let query = supabase
        .from('seasons')
        .select('*, sports(name, icon), organizations(id, name, logo_url, slug, settings)')
        .lte('registration_opens', now)
        .or(`registration_closes.is.null,registration_closes.gte.${now}`)
        .in('status', ['upcoming', 'active'])
        .order('start_date', { ascending: true })
      
      // If we have org IDs, filter to those orgs (otherwise show all open)
      if (orgIds.length > 0) {
        query = query.in('organization_id', orgIds)
      }
      
      const { data: seasons } = await query
      
      // Filter out seasons player is already registered for
      const registeredSeasonIds = (roleContext?.children || []).map(c => c.season_id)
      const availableSeasons = (seasons || []).filter(s => !registeredSeasonIds.includes(s.id))
      
      setOpenSeasons(availableSeasons)
    } catch (err) {
      console.error('Error loading open seasons:', err)
    }
  }

  async function loadParentData() {
    setLoading(true)
    try {
      const playerIds = roleContext.children.map(c => c.id)
      console.log('Parent Dashboard - Player IDs:', playerIds)
      
      // Load detailed player info with registration status
      const { data: players, error: playersError } = await supabase
        .from('players')
        .select(`
          id, first_name, last_name, photo_url, jersey_number, season_id,
          birth_date, grade, gender, school, parent_name, parent_email, parent_phone,
          registrations(id, status, created_at, approved_at)
        `)
        .in('id', playerIds)
      
      if (playersError) {
        console.error('Parent Dashboard - Players query error:', playersError)
      }
      console.log('Parent Dashboard - Players:', players)
      setPlayerDetails(players || [])

      // Load season info for each player
      const seasonIds = [...new Set((players || []).map(p => p.season_id).filter(Boolean))]
      if (seasonIds.length > 0) {
        const { data: seasons } = await supabase
          .from('seasons')
          .select('id, name, status, start_date, end_date, sports(name, icon), organizations(id, name)')
          .in('id', seasonIds)
        
        // Load payments for each player
        const { data: allPayments } = await supabase
          .from('payments')
          .select('*')
          .in('player_id', playerIds)
        
        // Build registration data with all info
        const regData = (players || []).map(player => {
          const season = seasons?.find(s => s.id === player.season_id)
          const playerPayments = (allPayments || []).filter(p => p.player_id === player.id)
          const totalFees = playerPayments.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0)
          const totalPaid = playerPayments.filter(p => p.paid).reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0)
          
          return {
            ...player,
            season,
            payments: playerPayments,
            totalFees,
            totalPaid,
            balanceDue: totalFees - totalPaid,
            registrationStatus: player.registrations?.[0]?.status || 'unknown'
          }
        })
        
        setRegistrationData(regData)
      }

      // Query team_players directly to get team IDs
      const { data: teamPlayerLinks, error: tpError } = await supabase
        .from('team_players')
        .select('team_id')
        .in('player_id', playerIds)
      
      if (tpError) {
        console.error('Parent Dashboard - Team players query error:', tpError)
      }
      console.log('Parent Dashboard - Team Player Links:', teamPlayerLinks)
      
      const teamIds = [...new Set((teamPlayerLinks || []).map(tp => tp.team_id).filter(Boolean))]
      console.log('Parent Dashboard - Team IDs:', teamIds)

      // Load upcoming events for all teams
      if (teamIds.length > 0) {
        const today = new Date().toISOString().split('T')[0]
        console.log('Parent Dashboard - Today:', today)
        
        const { data: events, error: eventsError } = await supabase
          .from('schedule_events')
          .select('id, title, event_type, event_date, event_time, end_time, venue_name, venue_address, opponent_name, location_type, team_id')
          .in('team_id', teamIds)
          .gte('event_date', today)
          .order('event_date', { ascending: true })
          .order('event_time', { ascending: true })
          .limit(15)
        
        if (eventsError) {
          console.error('Parent Dashboard - Events query error:', eventsError)
        }
        console.log('Parent Dashboard - Events:', events)
        
        // Load team info separately
        if (events?.length > 0) {
          const eventTeamIds = [...new Set(events.map(e => e.team_id))]
          const { data: teamsData } = await supabase
            .from('teams')
            .select('id, name, color')
            .in('id', eventTeamIds)
          
          // Save teams for EventDetailModal
          setTeams(teamsData || [])
          
          // Attach team info to events
          const eventsWithTeams = events.map(event => ({
            ...event,
            teams: teamsData?.find(t => t.id === event.team_id)
          }))
          setUpcomingEvents(eventsWithTeams)
        } else {
          setUpcomingEvents([])
        }
      } else {
        console.log('Parent Dashboard - No team IDs found, skipping events query')
        setUpcomingEvents([])
      }

      // Load payments for parent's players - simplified
      if (playerIds.length > 0) {
        const { data: paymentData, error: paymentError } = await supabase
          .from('payments')
          .select('id, amount, paid, due_date, description, player_id, created_at')
          .in('player_id', playerIds)
          .order('created_at', { ascending: false })
          .limit(10)
        
        if (paymentError) {
          console.error('Parent Dashboard - Payments query error:', paymentError)
        }
        
        // Attach player info
        const paymentsWithPlayers = (paymentData || []).map(payment => ({
          ...payment,
          players: players?.find(p => p.id === payment.player_id)
        }))
        setPayments(paymentsWithPlayers)
      }

      // Load recent posts from teams - simplified
      if (teamIds.length > 0) {
        const { data: posts, error: postsError } = await supabase
          .from('team_posts')
          .select('id, title, content, post_type, created_at, team_id, is_pinned')
          .in('team_id', teamIds)
          .order('created_at', { ascending: false })
          .limit(6)
        
        if (postsError) {
          console.error('Parent Dashboard - Posts query error:', postsError)
        }
        
        // Load team info for posts
        if (posts?.length > 0) {
          const postTeamIds = [...new Set(posts.map(p => p.team_id))]
          const { data: teamsData } = await supabase
            .from('teams')
            .select('id, name, color')
            .in('id', postTeamIds)
          
          const postsWithTeams = posts.map(post => ({
            ...post,
            teams: teamsData?.find(t => t.id === post.team_id)
          }))
          setRecentPosts(postsWithTeams)
        } else {
          setRecentPosts([])
        }
      }

      // Load open seasons
      await loadOpenSeasons()

    } catch (err) {
      console.error('Error loading parent data:', err)
    }
    setLoading(false)
  }

  // Calculate totals
  const totalDue = payments.filter(p => !p.paid).reduce((sum, p) => sum + (p.amount || 0), 0)

  // Group players by sport for better organization
  const playersBySport = playerDetails.reduce((acc, player) => {
    const sportName = player.seasons?.sports?.name || 'Other'
    const sportIcon = player.seasons?.sports?.icon || 'üèÖ'
    if (!acc[sportName]) {
      acc[sportName] = { icon: sportIcon, players: [] }
    }
    acc[sportName].players.push(player)
    return acc
  }, {})

  // Get status badge color
  function getStatusBadge(status) {
    switch(status) {
      case 'approved': return { bg: 'bg-blue-500/20', text: 'text-blue-400', label: 'Approved' }
      case 'rostered': return { bg: 'bg-emerald-500/20', text: 'text-emerald-400', label: 'On Roster' }
      case 'pending': case 'submitted': case 'new': return { bg: 'bg-[var(--accent-primary)]/20', text: 'text-[var(--accent-primary)]', label: 'Pending Review' }
      case 'waitlist': return { bg: 'bg-amber-500/20', text: 'text-amber-400', label: 'Waitlist' }
      case 'withdrawn': return { bg: 'bg-red-500/20', text: 'text-red-400', label: 'Denied' }
      default: return { bg: 'bg-gray-500/20', text: 'text-gray-400', label: status || 'Unknown' }
    }
  }

  if (loading) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className={tc.textSecondary}>Loading your dashboard...</div>
      </div>
    )
  }

  if (!roleContext?.children?.length) {
    return (
      <div className="space-y-6">
        <div className="flex flex-col items-center justify-center py-12 text-center">
          <span className="text-6xl mb-4">Parent</span>
          <h2 className={`text-xl font-bold ${tc.text} mb-2`}>Welcome!</h2>
          <p className={tc.textSecondary}>You haven't registered any players yet.</p>
          <p className={`${tc.textMuted} mb-6`}>Get started by registering for an open season below.</p>
        </div>
        
        {/* Show open seasons even with no children */}
        {openSeasons.length > 0 && (
          <div className={`${tc.cardBg} border ${tc.border} rounded-2xl p-5`}>
            <h2 className={`font-semibold ${tc.text} mb-4 flex items-center gap-2`}>
              <VolleyballIcon className="w-4 h-4" /> Open Registrations
            </h2>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {openSeasons.map(season => (
                <div key={season.id} className={`${tc.cardBgAlt} rounded-xl p-4 flex items-center gap-4`}>
                  <div className="w-14 h-14 rounded-xl bg-[var(--accent-primary)]/20 flex items-center justify-center text-2xl">
                    {season.sports?.icon || 'üèÖ'}
                  </div>
                  <div className="flex-1">
                    <p className={`font-semibold ${tc.text}`}>{season.name}</p>
                    <p className={`text-sm ${tc.textSecondary}`}>{season.organizations?.name}</p>
                    <p className={`text-xs ${tc.textMuted}`}>
                      {season.start_date && `Starts ${new Date(season.start_date).toLocaleDateString()}`}
                    </p>
                  </div>
                  <a 
                    href={getRegistrationUrl(season)}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="px-4 py-2 bg-[var(--accent-primary)] text-white rounded-xl font-semibold hover:brightness-110 transition"
                  >
                    Register ‚Üí
                  </a>
                </div>
              ))}
            </div>
          </div>
        )}
      </div>
    )
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-start justify-between">
        <div>
          <h1 className={`text-3xl font-bold ${tc.text}`}>Welcome back! üëã</h1>
          <p className={tc.textSecondary}>Here's what's happening with your players</p>
        </div>
        <div className="flex gap-3">
          {totalDue > 0 && (
            <button 
              onClick={() => onNavigate('payments')}
              className="px-4 py-2 bg-red-500/20 border border-red-500/30 rounded-xl hover:bg-red-500/30 transition"
            >
              <p className="text-red-400 font-medium text-sm"><DollarSign className="w-4 h-4 inline" /> ${totalDue.toFixed(2)} Due</p>
            </button>
          )}
        </div>
      </div>

      {/* Registration Status Cards */}
      <div>
        <div className="flex items-center justify-between mb-3">
          <h2 className={`font-semibold ${tc.text} flex items-center gap-2`}>
            <ClipboardList className="w-5 h-5" /> Registration Status
          </h2>
        </div>
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {registrationData.map(player => {
            const statusBadge = getStatusBadge(player.registrationStatus)
            return (
              <div 
                key={player.id}
                className={`${tc.cardBg} border ${tc.border} rounded-2xl p-4 hover:border-[var(--accent-primary)]/50 transition`}
              >
                <div className="flex items-start justify-between mb-3">
                  <div className="flex items-center gap-3">
                    {player.photo_url ? (
                      <img src={player.photo_url} alt={player.first_name} className="w-12 h-12 rounded-xl object-cover" />
                    ) : (
                      <div className="w-12 h-12 rounded-xl bg-[var(--accent-primary)]/20 flex items-center justify-center text-lg font-bold text-[var(--accent-primary)]">
                        {player.first_name?.[0]}{player.last_name?.[0]}
                      </div>
                    )}
                    <div>
                      <h3 className={`font-semibold ${tc.text}`}>{player.first_name} {player.last_name}</h3>
                      <p className={`text-xs ${tc.textMuted}`}>{player.season?.sports?.icon} {player.season?.name}</p>
                    </div>
                  </div>
                  <span className={`px-2 py-1 rounded-full text-xs font-medium ${statusBadge.bg} ${statusBadge.text}`}>
                    {statusBadge.label}
                  </span>
                </div>
                
                {/* Payment Summary for this player */}
                {player.totalFees > 0 && (
                  <div className={`${tc.cardBgAlt} rounded-xl p-3 mt-2`}>
                    <div className="flex justify-between text-sm">
                      <span className={tc.textMuted}>Total Fees</span>
                      <span className={tc.text}>${player.totalFees.toFixed(2)}</span>
                    </div>
                    <div className="flex justify-between text-sm">
                      <span className={tc.textMuted}>Paid</span>
                      <span className="text-emerald-400">${player.totalPaid.toFixed(2)}</span>
                    </div>
                    {player.balanceDue > 0 && (
                      <div className="flex justify-between text-sm font-medium pt-2 border-t border-slate-700/50 mt-2">
                        <span className="text-red-400">Balance Due</span>
                        <span className="text-red-400">${player.balanceDue.toFixed(2)}</span>
                      </div>
                    )}
                  </div>
                )}
                
                {/* View Details */}
                <button 
                  onClick={() => onNavigate(`player-${player.id}`)}
                  className="w-full mt-3 py-2 text-sm text-[var(--accent-primary)] hover:underline"
                >
                  View Details ‚Üí
                </button>
              </div>
            )
          })}
          
          {/* Add Another Child Card */}
          <div 
            onClick={() => setShowAddChildModal(true)}
            className={`${tc.cardBg} border-2 border-dashed ${tc.border} rounded-2xl p-4 flex flex-col items-center justify-center min-h-[180px] cursor-pointer hover:border-[var(--accent-primary)]/50 hover:bg-[var(--accent-primary)]/5 transition group`}
          >
            <div className="w-14 h-14 rounded-full bg-[var(--accent-primary)]/10 flex items-center justify-center text-3xl text-[var(--accent-primary)] group-hover:scale-110 transition">
              +
            </div>
            <p className={`font-medium ${tc.text} mt-3`}>Add Another Child</p>
            <p className={`text-xs ${tc.textMuted}`}>Register a sibling</p>
          </div>
        </div>
      </div>

      {/* Open Seasons for Re-Registration */}
      {openSeasons.length > 0 && (
        <div className={`${tc.cardBg} border ${tc.border} rounded-2xl p-5`}>
          <h2 className={`font-semibold ${tc.text} mb-4 flex items-center gap-2`}>
            <span>üîÑ</span> Register for Another Season
          </h2>
          <p className={`text-sm ${tc.textMuted} mb-4`}>New seasons are open! Register your players to continue playing.</p>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {openSeasons.map(season => (
              <div key={season.id} className={`${tc.cardBgAlt} rounded-xl p-4`}>
                <div className="flex items-center gap-4">
                  <div className="w-12 h-12 rounded-xl bg-[var(--accent-primary)]/20 flex items-center justify-center text-xl">
                    {season.sports?.icon || 'üèÖ'}
                  </div>
                  <div className="flex-1">
                    <p className={`font-semibold ${tc.text}`}>{season.name}</p>
                    <p className={`text-sm ${tc.textSecondary}`}>{season.organizations?.name}</p>
                    <p className={`text-xs ${tc.textMuted}`}>
                      {season.start_date && `Starts ${new Date(season.start_date).toLocaleDateString()}`}
                    </p>
                  </div>
                </div>
                <div className="flex gap-2 mt-3">
                  {registrationData.map(player => (
                    <button
                      key={player.id}
                      onClick={() => setShowReRegisterModal({ player, season })}
                      className="flex-1 px-3 py-2 bg-[var(--accent-primary)] text-white rounded-lg text-sm font-medium hover:brightness-110 transition"
                    >
                      Register {player.first_name}
                    </button>
                  ))}
                </div>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Quick Actions - Horizontal */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
        {playerDetails[0]?.team_players?.[0]?.team_id && (
          <button 
            onClick={() => navigateToTeamWall(playerDetails[0].team_players[0].team_id)}
            className={`p-4 rounded-xl ${tc.cardBg} border ${tc.border} ${tc.hoverBg} transition flex items-center gap-3`}
          >
            <span className="text-2xl">üè†</span>
            <div className="text-left">
              <p className={`font-medium ${tc.text}`}>Team Wall</p>
              <p className={`text-xs ${tc.textMuted}`}>View updates</p>
            </div>
          </button>
        )}
        <button 
          onClick={() => onNavigate('schedule')}
          className={`p-4 rounded-xl ${tc.cardBg} border ${tc.border} ${tc.hoverBg} transition flex items-center gap-3`}
        >
          <Calendar className="w-8 h-8" />
          <div className="text-left">
            <p className={`font-medium ${tc.text}`}>Full Schedule</p>
            <p className={`text-xs ${tc.textMuted}`}>All events</p>
          </div>
        </button>
        <button 
          onClick={() => onNavigate('payments')}
          className={`p-4 rounded-xl ${tc.cardBg} border ${tc.border} ${tc.hoverBg} transition flex items-center gap-3`}
        >
          <DollarSign className="w-7 h-7" />
          <div className="text-left">
            <p className={`font-medium ${tc.text}`}>Payments</p>
            <p className={`text-xs ${tc.textMuted}`}>{totalDue > 0 ? `$${totalDue} due` : 'All paid'}</p>
          </div>
        </button>
        <button 
          onClick={() => onNavigate('messages')}
          className={`p-4 rounded-xl ${tc.cardBg} border ${tc.border} ${tc.hoverBg} transition flex items-center gap-3`}
        >
          <MessageCircle className="w-7 h-7" />
          <div className="text-left">
            <p className={`font-medium ${tc.text}`}>Messages</p>
            <p className={`text-xs ${tc.textMuted}`}>Team updates</p>
          </div>
        </button>
      </div>

      {/* Team Updates */}
      {recentPosts.length > 0 && (
        <div className={`${tc.cardBg} border ${tc.border} rounded-2xl p-5`}>
          <h2 className={`font-semibold ${tc.text} mb-4 flex items-center gap-2`}>
            <Megaphone className="w-4 h-4" /> Team Updates
          </h2>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {recentPosts.map(post => (
              <div 
                key={post.id}
                className={`p-4 rounded-xl ${tc.cardBgAlt} cursor-pointer hover:scale-[1.01] transition`}
                onClick={() => navigateToTeamWall(post.team_id)}
              >
                <div className="flex items-center justify-between mb-2">
                  <div className="flex items-center gap-2">
                    {post.teams?.seasons?.sports?.icon && (
                      <span className="text-sm">{post.teams.seasons.sports.icon}</span>
                    )}
                    <span 
                      className="px-2 py-0.5 rounded-full text-xs font-medium"
                      style={{ 
                        background: `${post.teams?.color || '#EAB308'}20`,
                        color: post.teams?.color || '#EAB308'
                      }}
                    >
                      {post.teams?.name}
                    </span>
                  </div>
                  <span className={`text-xs ${tc.textMuted}`}>
                    {new Date(post.created_at).toLocaleDateString()}
                  </span>
                </div>
                <h3 className={`font-medium ${tc.text}`}>{post.title}</h3>
                <p className={`text-sm ${tc.textSecondary} line-clamp-2`}>{post.content}</p>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Schedule & Payments Row */}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Upcoming Events */}
        <div className={`lg:col-span-2 ${tc.cardBg} border ${tc.border} rounded-2xl p-5`}>
          <div className="flex items-center justify-between mb-4">
            <h2 className={`font-semibold ${tc.text} flex items-center gap-2`}>
              <Calendar className="w-5 h-5" /> Upcoming Schedule
            </h2>
            <button 
              onClick={() => onNavigate('schedule')}
              className="text-sm text-[var(--accent-primary)] hover:underline"
            >
              View All ‚Üí
            </button>
          </div>
          {upcomingEvents.length > 0 ? (
            <div className="space-y-3">
              {upcomingEvents.slice(0, 5).map(event => {
                const eventDate = new Date(event.event_date)
                const isToday = eventDate.toDateString() === new Date().toDateString()
                const isTomorrow = eventDate.toDateString() === new Date(Date.now() + 86400000).toDateString()
                
                return (
                  <div 
                    key={event.id}
                    className={`flex items-center gap-4 p-3 rounded-xl ${tc.cardBgAlt} cursor-pointer hover:scale-[1.01] transition`}
                    onClick={() => setSelectedEventDetail(event)}
                  >
                    <div 
                      className="w-14 h-14 rounded-xl flex flex-col items-center justify-center text-xs font-bold"
                      style={{ 
                        background: `${event.teams?.color || '#EAB308'}20`,
                        color: event.teams?.color || '#EAB308'
                      }}
                    >
                      <span>{eventDate.toLocaleDateString('en-US', { weekday: 'short' })}</span>
                      <span className="text-lg">{eventDate.getDate()}</span>
                    </div>
                    <div className="flex-1">
                      <div className="flex items-center gap-2">
                        <span className={`font-medium ${tc.text}`}>
                          {event.event_type === 'practice' && 'practice'}
                          {event.event_type === 'game' && 'üèÜ'}
                          {event.event_type === 'tournament' && <Target className="w-4 h-4 inline" />}
                          {event.event_type === 'meeting' && <ClipboardList className="w-4 h-4 inline" />}
                          {' '}{event.title || event.event_type}
                        </span>
                        {isToday && <span className="px-2 py-0.5 bg-emerald-500/20 text-emerald-400 text-xs rounded-full">Today</span>}
                        {isTomorrow && <span className="px-2 py-0.5 bg-[var(--accent-primary)]/20 text-[var(--accent-primary)] text-xs rounded-full">Tomorrow</span>}
                      </div>
                      <p className={`text-sm ${tc.textSecondary}`}>
                        {event.event_time && formatTime12(event.event_time)}
                        {event.venue_name && ` ‚Ä¢ ${event.venue_name}`}
                      </p>
                      <div className="flex items-center gap-2">
                        {event.teams?.seasons?.sports?.icon && (
                          <span className="text-xs">{event.teams.seasons.sports.icon}</span>
                        )}
                        <p className="text-xs" style={{ color: event.teams?.color || '#EAB308' }}>
                          {event.teams?.name}
                        </p>
                      </div>
                    </div>
                  </div>
                )
              })}
            </div>
          ) : (
            <div className="text-center py-8">
              <Calendar className="w-12 h-12" />
              <p className={`${tc.textSecondary} mt-2`}>No upcoming events</p>
            </div>
          )}
        </div>

        {/* Payment Summary */}
        <div className={`${tc.cardBg} border ${tc.border} rounded-2xl p-5`}>
          <div className="flex items-center justify-between mb-4">
            <h2 className={`font-semibold ${tc.text} flex items-center gap-2`}>
              <DollarSign className="w-5 h-5" /> Payments
            </h2>
            <button 
              onClick={() => onNavigate('payments')}
              className="text-sm text-[var(--accent-primary)] hover:underline"
            >
              View All ‚Üí
            </button>
          </div>
          
          {/* Balance Summary */}
          <div className={`p-4 rounded-xl mb-4 ${totalDue > 0 ? 'bg-red-500/10 border border-red-500/30' : 'bg-emerald-500/10 border border-emerald-500/30'}`}>
            <p className={`text-sm ${totalDue > 0 ? 'text-red-400' : 'text-emerald-400'}`}>
              {totalDue > 0 ? 'Balance Due' : 'All Paid!'}
            </p>
            <p className={`text-3xl font-bold ${totalDue > 0 ? 'text-red-400' : 'text-emerald-400'}`}>
              ${totalDue.toFixed(2)}
            </p>
            {totalDue > 0 && (
              <button 
                onClick={() => onNavigate('payments')}
                className="w-full mt-3 py-2 bg-[var(--accent-primary)] text-white rounded-lg font-medium hover:brightness-110 transition"
              >
                Pay Now ‚Üí
              </button>
            )}
          </div>

          {/* Recent Payments */}
          <p className={`text-xs ${tc.textMuted} uppercase tracking-wider mb-2`}>Recent Activity</p>
          <div className="space-y-2">
            {payments.slice(0, 4).map(payment => (
              <div key={payment.id} className={`flex items-center justify-between p-2 rounded-lg ${tc.cardBgAlt}`}>
                <div className="flex items-center gap-2">
                  {payment.players?.seasons?.sports?.icon && (
                    <span className="text-sm">{payment.players.seasons.sports.icon}</span>
                  )}
                  <div>
                    <p className={`text-sm ${tc.text}`}>{payment.description || 'Payment'}</p>
                    <p className={`text-xs ${tc.textMuted}`}>{payment.players?.first_name}</p>
                  </div>
                </div>
                <div className="text-right">
                  <p className={`font-medium ${payment.paid ? 'text-emerald-400' : 'text-red-400'}`}>
                    ${payment.amount}
                  </p>
                  <p className={`text-xs ${payment.paid ? 'text-emerald-400' : 'text-red-400'}`}>
                    {payment.paid ? '‚úì Paid' : 'Due'}
                  </p>
                </div>
              </div>
            ))}
          </div>

          {payments.length === 0 && (
            <p className={`text-sm ${tc.textMuted} text-center py-4`}>No payment records</p>
          )}
        </div>
      </div>

      {/* Event Detail Modal */}
      {selectedEventDetail && (
        <EventDetailModal
          event={selectedEventDetail}
          teams={teams}
          venues={[]}
          onClose={() => setSelectedEventDetail(null)}
          onUpdate={() => {}}
          onDelete={() => {}}
          activeView="parent"
        />
      )}

      {/* Add Another Child Modal */}
      {showAddChildModal && (
        <AddChildModal
          existingChildren={registrationData}
          onClose={() => setShowAddChildModal(false)}
          showToast={showToast}
        />
      )}

      {/* Re-Register Modal */}
      {showReRegisterModal && (
        <ReRegisterModal
          player={showReRegisterModal.player}
          season={showReRegisterModal.season}
          onClose={() => setShowReRegisterModal(null)}
          showToast={showToast}
        />
      )}
    </div>
  )
}

// ============================================
// ADD CHILD MODAL
// ============================================
function AddChildModal({ existingChildren, onClose, showToast }) {
  const tc = useThemeClasses()
  const [openSeasons, setOpenSeasons] = useState([])
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    loadOpenSeasons()
  }, [])

  async function loadOpenSeasons() {
    try {
      // Get org IDs from existing children
      const orgIds = [...new Set(existingChildren.map(c => c.season?.organizations?.id).filter(Boolean))]
      
      const now = new Date().toISOString()
      let query = supabase
        .from('seasons')
        .select('*, sports(name, icon), organizations(id, name, slug, settings)')
        .lte('registration_opens', now)
        .or(`registration_closes.is.null,registration_closes.gte.${now}`)
        .in('status', ['upcoming', 'active'])
      
      if (orgIds.length > 0) {
        query = query.in('organization_id', orgIds)
      }
      
      const { data } = await query
      setOpenSeasons(data || [])
    } catch (err) {
      console.error('Error loading seasons:', err)
    }
    setLoading(false)
  }

  // Get the first existing child's info for pre-filling parent info
  const templateChild = existingChildren[0]
  
  // Build sibling registration URL with parent info pre-filled
  function getSiblingRegistrationUrl(season) {
    const orgSlug = season.organizations?.slug || 'black-hornets'
    const registrationBaseUrl = season.organizations?.settings?.registration_url || 'https://sgtxtorque.github.io/volleyball-registration'
    
    const prefillParams = new URLSearchParams({
      org: orgSlug,
      season: season.id,
      prefill: 'true',
      // Only pre-fill parent/contact info for siblings (not player info)
      parent_name: templateChild?.parent_name || '',
      parent_email: templateChild?.parent_email || '',
      parent_phone: templateChild?.parent_phone || '',
      address: templateChild?.address || '',
      emergency_name: templateChild?.emergency_contact_name || '',
      emergency_phone: templateChild?.emergency_contact_phone || '',
      emergency_relation: templateChild?.emergency_contact_relation || '',
    })
    
    // Remove empty params
    const cleanParams = new URLSearchParams()
    prefillParams.forEach((value, key) => {
      if (value) cleanParams.append(key, value)
    })
    
    return `${registrationBaseUrl}?${cleanParams.toString()}`
  }

  return (
    <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50">
      <div className={`${tc.cardBg} border ${tc.border} rounded-2xl w-full max-w-lg max-h-[80vh] overflow-y-auto`}>
        <div className={`p-6 border-b ${tc.border}`}>
          <h2 className={`text-xl font-semibold ${tc.text}`}>Add Another Child</h2>
          <p className={`${tc.textMuted} text-sm mt-1`}>Select a season to register a sibling</p>
        </div>
        
        <div className="p-6 space-y-4">
          {loading ? (
            <div className="text-center py-8">
              <div className="animate-spin w-8 h-8 border-2 border-[var(--accent-primary)] border-t-transparent rounded-full mx-auto" />
            </div>
          ) : openSeasons.length > 0 ? (
            <>
              <p className={`text-sm ${tc.textSecondary}`}>
                Parent info will be pre-filled from {templateChild?.first_name}'s registration.
              </p>
              {openSeasons.map(season => (
                <a
                  key={season.id}
                  href={getSiblingRegistrationUrl(season)}
                  target="_blank"
                  rel="noopener noreferrer"
                  className={`block ${tc.cardBgAlt} rounded-xl p-4 hover:border-[var(--accent-primary)] border border-transparent transition`}
                >
                  <div className="flex items-center gap-4">
                    <div className="w-12 h-12 rounded-xl bg-[var(--accent-primary)]/20 flex items-center justify-center text-xl">
                      {season.sports?.icon || 'üèÖ'}
                    </div>
                    <div className="flex-1">
                      <p className={`font-semibold ${tc.text}`}>{season.name}</p>
                      <p className={`text-sm ${tc.textSecondary}`}>{season.organizations?.name}</p>
                    </div>
                    <span className="text-[var(--accent-primary)]">‚Üí</span>
                  </div>
                </a>
              ))}
            </>
          ) : (
            <div className="text-center py-8">
              <Calendar className="w-12 h-12" />
              <p className={`${tc.textSecondary} mt-2`}>No open registrations at this time</p>
            </div>
          )}
        </div>
        
        <div className={`p-6 border-t ${tc.border}`}>
          <button onClick={onClose} className={`w-full py-2 rounded-xl border ${tc.border} ${tc.text}`}>
            Close
          </button>
        </div>
      </div>
    </div>
  )
}

// ============================================
// RE-REGISTER MODAL
// ============================================
function ReRegisterModal({ player, season, onClose, showToast }) {
  const tc = useThemeClasses()
  const [processing, setProcessing] = useState(false)
  const [copied, setCopied] = useState(false)

  // Get the organization slug
  const orgSlug = season.organizations?.slug || 'black-hornets'
  
  // Use GitHub Pages registration URL (can be overridden in org settings)
  const registrationBaseUrl = season.organizations?.settings?.registration_url || 'https://sgtxtorque.github.io/volleyball-registration'

  // Build pre-fill URL with player data - matching index.html expected parameters
  const prefillParams = new URLSearchParams({
    org: orgSlug,
    season: season.id,
    prefill: 'true',
    // Player info
    first_name: player.first_name || '',
    last_name: player.last_name || '',
    dob: player.dob || player.birth_date || '',
    grade: player.grade === 0 ? 'K' : String(player.grade || ''),
    gender: player.gender || '',
    school: player.school || '',
    jersey_size: player.uniform_size_jersey || '',
    shorts_size: player.uniform_size_shorts || '',
    // Parent info
    parent_name: player.parent_name || '',
    parent_email: player.parent_email || '',
    parent_phone: player.parent_phone || '',
    // Address
    address: player.address || '',
    // Emergency contact
    emergency_name: player.emergency_contact_name || '',
    emergency_phone: player.emergency_contact_phone || '',
    emergency_relation: player.emergency_contact_relation || '',
  })
  
  // Remove empty params to keep URL clean
  const cleanParams = new URLSearchParams()
  prefillParams.forEach((value, key) => {
    if (value) cleanParams.append(key, value)
  })

  const registrationUrl = `${registrationBaseUrl}?${cleanParams.toString()}`
  
  const copyLink = async () => {
    try {
      await navigator.clipboard.writeText(registrationUrl)
      setCopied(true)
      showToast?.('Link copied to clipboard!')
      setTimeout(() => setCopied(false), 2000)
    } catch (err) {
      console.error('Copy failed:', err)
    }
  }

  return (
    <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50">
      <div className={`${tc.cardBg} border ${tc.border} rounded-2xl w-full max-w-md`}>
        <div className={`p-6 border-b ${tc.border}`}>
          <h2 className={`text-xl font-semibold ${tc.text}`}>Re-Register {player.first_name}</h2>
          <p className={`${tc.textMuted} text-sm mt-1`}>for {season.name}</p>
        </div>
        
        <div className="p-6 space-y-4">
          <div className={`${tc.cardBgAlt} rounded-xl p-4`}>
            <div className="flex items-center gap-4">
              <div className="w-14 h-14 rounded-xl bg-[var(--accent-primary)]/20 flex items-center justify-center text-2xl">
                {season.sports?.icon || 'üèÖ'}
              </div>
              <div>
                <p className={`font-semibold ${tc.text}`}>{season.name}</p>
                <p className={`text-sm ${tc.textSecondary}`}>{season.organizations?.name}</p>
                {season.start_date && (
                  <p className={`text-xs ${tc.textMuted}`}>Starts {new Date(season.start_date).toLocaleDateString()}</p>
                )}
              </div>
            </div>
          </div>
          
          <div className={`bg-emerald-500/10 border border-emerald-500/30 rounded-xl p-4`}>
            <p className="text-emerald-400 text-sm">
              ‚úì {player.first_name}'s information will be pre-filled to save time!
            </p>
          </div>
          
          {/* Copy Link Option */}
          <div className={`${tc.cardBgAlt} rounded-xl p-4`}>
            <p className={`text-sm ${tc.textMuted} mb-2`}>Or share this link:</p>
            <div className="flex gap-2">
              <input 
                type="text" 
                value={registrationUrl} 
                readOnly 
                className={`flex-1 ${tc.cardBg} border ${tc.border} rounded-lg px-3 py-2 text-xs ${tc.text} truncate`}
              />
              <button
                onClick={copyLink}
                className={`px-3 py-2 rounded-lg border ${tc.border} ${tc.text} hover:bg-[var(--accent-primary)]/10 transition flex items-center gap-1`}
              >
                {copied ? <Check className="w-4 h-4" /> : <Copy className="w-4 h-4" />}
              </button>
            </div>
          </div>
        </div>
        
        <div className={`p-6 border-t ${tc.border} flex gap-3`}>
          <button onClick={onClose} className={`flex-1 py-2 rounded-xl border ${tc.border} ${tc.text}`}>
            Cancel
          </button>
          <a
            href={registrationUrl}
            target="_blank"
            rel="noopener noreferrer"
            className="flex-1 py-2 rounded-xl bg-[var(--accent-primary)] text-white font-semibold text-center hover:brightness-110 transition"
          >
            Open Registration ‚Üí
          </a>
        </div>
      </div>
    </div>
  )
}

// ============================================
// COACH DASHBOARD
// ============================================
function CoachDashboard({ roleContext, navigateToTeamWall, showToast, onNavigate }) {
  const { profile } = useAuth()
  const tc = useThemeClasses()
  const { isDark } = useTheme()
  
  const [loading, setLoading] = useState(true)
  const [teams, setTeams] = useState([])
  const [upcomingEvents, setUpcomingEvents] = useState([])
  const [todayEvents, setTodayEvents] = useState([])
  const [rsvpSummary, setRsvpSummary] = useState({})
  const [recentActivity, setRecentActivity] = useState([])
  const [selectedEventDetail, setSelectedEventDetail] = useState(null)
  const [selectedTeamFilter, setSelectedTeamFilter] = useState('all')

  useEffect(() => {
    if (roleContext?.coachInfo?.team_coaches?.length > 0) {
      loadCoachData()
    } else {
      setLoading(false)
    }
  }, [roleContext])

  async function loadCoachData() {
    setLoading(true)
    try {
      let teamIds = roleContext.coachInfo.team_coaches.map(tc => tc.team_id).filter(Boolean)
      console.log('Coach Dashboard - Team IDs from roleContext:', teamIds)
      
      if (teamIds.length === 0) {
        // Try to get team IDs directly from team_coaches table
        const { data: coachTeams, error: ctError } = await supabase
          .from('team_coaches')
          .select('team_id')
          .eq('coach_id', roleContext.coachInfo.id)
        
        console.log('Coach Dashboard - Direct team_coaches query:', coachTeams, 'Error:', ctError)
        
        if (coachTeams?.length > 0) {
          teamIds = coachTeams.map(ct => ct.team_id).filter(Boolean)
        }
      }
      
      console.log('Coach Dashboard - Final Team IDs:', teamIds)

      if (teamIds.length === 0) {
        setLoading(false)
        return
      }

      // Load team details with player counts - simplified query
      const { data: teamData, error: teamError } = await supabase
        .from('teams')
        .select('id, name, color, season_id')
        .in('id', teamIds)
      
      if (teamError) {
        console.error('Coach Dashboard - Teams query error:', teamError)
      }
      console.log('Coach Dashboard - Teams:', teamData)
      setTeams(teamData || [])

      // Load upcoming events - simplified query
      const today = new Date().toISOString().split('T')[0]
      console.log('Coach Dashboard - Today:', today)
      
      const { data: events, error: eventsError } = await supabase
        .from('schedule_events')
        .select('id, title, event_type, event_date, event_time, end_time, venue_name, venue_address, opponent_name, location_type, team_id')
        .in('team_id', teamIds)
        .gte('event_date', today)
        .order('event_date', { ascending: true })
        .order('event_time', { ascending: true })
        .limit(20)
      
      if (eventsError) {
        console.error('Coach Dashboard - Events query error:', eventsError)
      }
      console.log('Coach Dashboard - Events:', events)
      
      // Attach team info to events
      if (events?.length > 0) {
        const eventsWithTeams = events.map(event => ({
          ...event,
          teams: teamData?.find(t => t.id === event.team_id)
        }))
        setUpcomingEvents(eventsWithTeams)
        setTodayEvents(eventsWithTeams.filter(e => e.event_date === today))
      } else {
        setUpcomingEvents([])
        setTodayEvents([])
      }

      // Load RSVP summary
      if (events?.length > 0) {
        const eventIds = events.slice(0, 10).map(e => e.id)
        const { data: rsvps } = await supabase
          .from('event_rsvps')
          .select('event_id, status')
          .in('event_id', eventIds)
        
        const summary = {}
        eventIds.forEach(id => {
          const eventRsvps = (rsvps || []).filter(r => r.event_id === id)
          summary[id] = {
            yes: eventRsvps.filter(r => r.status === 'yes').length,
            no: eventRsvps.filter(r => r.status === 'no').length,
            maybe: eventRsvps.filter(r => r.status === 'maybe').length,
            total: eventRsvps.length
          }
        })
        setRsvpSummary(summary)
      }

      // Load recent posts - simplified query
      const { data: posts, error: postsError } = await supabase
        .from('team_posts')
        .select('id, title, content, post_type, created_at, team_id, author_id, is_pinned')
        .in('team_id', teamIds)
        .order('created_at', { ascending: false })
        .limit(6)
      
      if (postsError) {
        console.error('Coach Dashboard - Posts query error:', postsError)
      }
      
      // Attach team info to posts
      const postsWithTeams = (posts || []).map(post => ({
        ...post,
        teams: teamData?.find(t => t.id === post.team_id)
      }))
      setRecentActivity(postsWithTeams)

    } catch (err) {
      console.error('Error loading coach data:', err)
    }
    setLoading(false)
  }

  if (loading) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className={tc.textSecondary}>Loading coach dashboard...</div>
      </div>
    )
  }

  if (!roleContext?.coachInfo?.team_coaches?.length) {
    return (
      <div className="flex flex-col items-center justify-center h-64 text-center">
        <span className="text-6xl mb-4">Coach</span>
        <h2 className={`text-xl font-bold ${tc.text} mb-2`}>No Teams Assigned</h2>
        <p className={tc.textSecondary}>You haven't been assigned to any teams yet.</p>
        <p className={tc.textMuted}>Contact your league administrator to get assigned.</p>
      </div>
    )
  }

  const totalPlayers = teams.reduce((sum, t) => sum + (t.team_players?.[0]?.count || 0), 0)
  
  // Filter events by selected team
  const filteredEvents = selectedTeamFilter === 'all' 
    ? upcomingEvents 
    : upcomingEvents.filter(e => e.team_id === selectedTeamFilter)

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-start justify-between">
        <div>
          <h1 className={`text-3xl font-bold ${tc.text}`}>Coach Dashboard Coach</h1>
          <p className={tc.textSecondary}>
            Managing {teams.length} team{teams.length !== 1 ? 's' : ''} ‚Ä¢ {totalPlayers} players
          </p>
        </div>
        {todayEvents.length > 0 && (
          <div className="px-4 py-2 bg-emerald-500/20 border border-emerald-500/30 rounded-xl">
            <p className="text-emerald-400 font-medium">
              <Target className="w-4 h-4 inline mr-1" />{todayEvents.length} event{todayEvents.length !== 1 ? 's' : ''} today!
            </p>
          </div>
        )}
      </div>

      {/* My Teams */}
      <div>
        <h2 className={`font-semibold ${tc.text} mb-3 flex items-center gap-2`}>
          <VolleyballIcon className="w-4 h-4" /> My Teams
        </h2>
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {teams.map(team => {
            const coachRole = roleContext.coachInfo.team_coaches.find(tc => tc.team_id === team.id)?.role
            const nextEvent = upcomingEvents.find(e => e.team_id === team.id)
            const teamTodayEvents = todayEvents.filter(e => e.team_id === team.id)
            
            return (
              <div 
                key={team.id}
                onClick={() => navigateToTeamWall(team.id)}
                className={`${tc.cardBg} border ${tc.border} rounded-2xl p-5 cursor-pointer hover:border-[var(--accent-primary)]/30 hover:scale-[1.02] transition`}
                style={{ borderLeftWidth: 4, borderLeftColor: team.color }}
              >
                <div className="flex items-start justify-between mb-3">
                  <div className="flex items-center gap-2">
                    {team.seasons?.sports?.icon && (
                      <span className="text-xl">{team.seasons.sports.icon}</span>
                    )}
                    <div>
                      <h3 className={`font-bold text-lg ${tc.text}`}>{team.name}</h3>
                      <p className={`text-sm ${tc.textSecondary}`}>
                        {team.team_players?.[0]?.count || 0} players
                      </p>
                    </div>
                  </div>
                  <div className="flex flex-col items-end gap-1">
                    {coachRole === 'head' && (
                      <span className="px-2 py-0.5 bg-[var(--accent-primary)]/20 text-[var(--accent-primary)] text-xs rounded-full font-medium">
                        Head
                      </span>
                    )}
                    {teamTodayEvents.length > 0 && (
                      <span className="px-2 py-0.5 bg-emerald-500/20 text-emerald-400 text-xs rounded-full font-medium">
                        {teamTodayEvents.length} today
                      </span>
                    )}
                  </div>
                </div>
                
                {nextEvent ? (
                  <div className={`p-3 rounded-lg ${tc.cardBgAlt}`}>
                    <p className={`text-xs ${tc.textMuted} uppercase tracking-wider mb-1`}>Next Event</p>
                    <p className={`font-medium ${tc.text}`}>
                      {nextEvent.event_type === 'practice' && 'practice'}
                      {nextEvent.event_type === 'game' && 'üèÜ'}
                      {nextEvent.event_type === 'tournament' && <Target className="w-4 h-4 inline" />}
                      {' '}{nextEvent.title || nextEvent.event_type}
                    </p>
                    <p className={`text-sm ${tc.textSecondary}`}>
                      {new Date(nextEvent.event_date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}
                      {nextEvent.event_time && ` at ${formatTime12(nextEvent.event_time)}`}
                    </p>
                  </div>
                ) : (
                  <div className={`p-3 rounded-lg ${tc.cardBgAlt}`}>
                    <p className={`text-sm ${tc.textMuted}`}>No upcoming events</p>
                  </div>
                )}
              </div>
            )
          })}
        </div>
      </div>

      {/* At a Glance - Horizontal Stats */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div className={`${tc.cardBg} border ${tc.border} rounded-xl p-4 text-center`}>
          <p className="text-3xl font-bold text-[var(--accent-primary)]">{teams.length}</p>
          <p className={`text-sm ${tc.textMuted}`}>Teams</p>
        </div>
        <div className={`${tc.cardBg} border ${tc.border} rounded-xl p-4 text-center`}>
          <p className="text-3xl font-bold text-[var(--accent-primary)]">{totalPlayers}</p>
          <p className={`text-sm ${tc.textMuted}`}>Players</p>
        </div>
        <div className={`${tc.cardBg} border ${tc.border} rounded-xl p-4 text-center`}>
          <p className="text-3xl font-bold text-emerald-400">{todayEvents.length}</p>
          <p className={`text-sm ${tc.textMuted}`}>Today</p>
        </div>
        <div className={`${tc.cardBg} border ${tc.border} rounded-xl p-4 text-center`}>
          <p className="text-3xl font-bold text-blue-400">{upcomingEvents.length}</p>
          <p className={`text-sm ${tc.textMuted}`}>Upcoming</p>
        </div>
      </div>

      {/* Quick Actions - Horizontal */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
        <button 
          onClick={() => teams[0] && navigateToTeamWall(teams[0].id)}
          className={`p-4 rounded-xl ${tc.cardBg} border ${tc.border} ${tc.hoverBg} transition flex items-center gap-3`}
        >
          <Megaphone className="w-6 h-6" />
          <div className="text-left">
            <p className={`font-medium ${tc.text}`}>New Post</p>
            <p className={`text-xs ${tc.textMuted}`}>Team update</p>
          </div>
        </button>
        <button 
          onClick={() => onNavigate('attendance')}
          className={`p-4 rounded-xl ${tc.cardBg} border ${tc.border} ${tc.hoverBg} transition flex items-center gap-3`}
        >
          <CheckSquare className="w-6 h-6" />
          <div className="text-left">
            <p className={`font-medium ${tc.text}`}>Attendance</p>
            <p className={`text-xs ${tc.textMuted}`}>Take roll</p>
          </div>
        </button>
        <button 
          onClick={() => onNavigate('schedule')}
          className={`p-4 rounded-xl ${tc.cardBg} border ${tc.border} ${tc.hoverBg} transition flex items-center gap-3`}
        >
          <Calendar className="w-8 h-8" />
          <div className="text-left">
            <p className={`font-medium ${tc.text}`}>Schedule</p>
            <p className={`text-xs ${tc.textMuted}`}>All events</p>
          </div>
        </button>
        <button 
          onClick={() => teams[0] && navigateToTeamWall(teams[0].id)}
          className={`p-4 rounded-xl ${tc.cardBg} border ${tc.border} ${tc.hoverBg} transition flex items-center gap-3`}
        >
          <ClipboardList className="w-7 h-7" />
          <div className="text-left">
            <p className={`font-medium ${tc.text}`}>Roster</p>
            <p className={`text-xs ${tc.textMuted}`}>View players</p>
          </div>
        </button>
      </div>

      {/* Today's Events Alert */}
      {todayEvents.length > 0 && (
        <div className="bg-emerald-500/10 border border-emerald-500/30 rounded-2xl p-5">
          <h3 className="font-semibold text-emerald-400 mb-3 flex items-center gap-2">
            <Target className="w-4 h-4 inline mr-1" />Today's Events
          </h3>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
            {todayEvents.map(event => (
              <div 
                key={event.id} 
                className={`p-3 rounded-xl ${tc.cardBg} cursor-pointer hover:scale-[1.02] transition`}
                onClick={() => setSelectedEventDetail(event)}
              >
                <div className="flex items-center justify-between">
                  <div>
                    <p className={`font-medium ${tc.text}`}>
                      {event.event_type === 'practice' && 'practice'}
                      {event.event_type === 'game' && 'üèÜ'}
                      {event.event_type === 'tournament' && <Target className="w-4 h-4 inline" />}
                      {' '}{event.title || event.event_type}
                    </p>
                    <p className="text-sm text-emerald-400">
                      {event.event_time && formatTime12(event.event_time)}
                      {event.venue_name && ` ‚Ä¢ ${event.venue_name}`}
                    </p>
                  </div>
                  <span 
                    className="px-2 py-0.5 rounded-full text-xs font-medium"
                    style={{ 
                      background: `${event.teams?.color || '#EAB308'}20`,
                      color: event.teams?.color || '#EAB308'
                    }}
                  >
                    {event.teams?.name}
                  </span>
                </div>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Upcoming Schedule with Team Filter */}
      <div className={`${tc.cardBg} border ${tc.border} rounded-2xl p-5`}>
        <div className="flex items-center justify-between mb-4">
          <h2 className={`font-semibold ${tc.text} flex items-center gap-2`}>
            <Calendar className="w-5 h-5" /> Upcoming Schedule
          </h2>
          <div className="flex items-center gap-2">
            {/* Team Filter */}
            {teams.length > 1 && (
              <select
                value={selectedTeamFilter}
                onChange={(e) => setSelectedTeamFilter(e.target.value)}
                className={`text-sm px-3 py-1.5 rounded-lg ${tc.cardBgAlt} ${tc.text} border ${tc.border}`}
              >
                <option value="all">All Teams</option>
                {teams.map(team => (
                  <option key={team.id} value={team.id}>{team.name}</option>
                ))}
              </select>
            )}
            <button 
              onClick={() => onNavigate('schedule')}
              className="text-sm text-[var(--accent-primary)] hover:underline"
            >
              View All ‚Üí
            </button>
          </div>
        </div>
        
        {filteredEvents.length > 0 ? (
          <div className="space-y-3">
            {filteredEvents.slice(0, 8).map(event => {
              const eventDate = new Date(event.event_date)
              const isToday = eventDate.toDateString() === new Date().toDateString()
              const rsvp = rsvpSummary[event.id]
              
              return (
                <div 
                  key={event.id}
                  className={`flex items-center gap-4 p-3 rounded-xl ${tc.cardBgAlt} cursor-pointer hover:scale-[1.01] transition ${isToday ? 'ring-2 ring-green-500/50' : ''}`}
                  onClick={() => setSelectedEventDetail(event)}
                >
                  <div 
                    className="w-14 h-14 rounded-xl flex flex-col items-center justify-center text-xs font-bold"
                    style={{ 
                      background: `${event.teams?.color || '#EAB308'}20`,
                      color: event.teams?.color || '#EAB308'
                    }}
                  >
                    <span>{eventDate.toLocaleDateString('en-US', { weekday: 'short' })}</span>
                    <span className="text-lg">{eventDate.getDate()}</span>
                  </div>
                  <div className="flex-1">
                    <div className="flex items-center gap-2">
                      <span className={`font-medium ${tc.text}`}>
                        {event.event_type === 'practice' && 'practice'}
                        {event.event_type === 'game' && 'üèÜ'}
                        {event.event_type === 'tournament' && <Target className="w-4 h-4 inline" />}
                        {event.event_type === 'meeting' && <ClipboardList className="w-4 h-4 inline" />}
                        {' '}{event.title || event.event_type}
                      </span>
                      {isToday && <span className="px-2 py-0.5 bg-emerald-500/20 text-emerald-400 text-xs rounded-full">Today</span>}
                    </div>
                    <p className={`text-sm ${tc.textSecondary}`}>
                      {event.event_time && formatTime12(event.event_time)}
                      {event.venue_name && ` ‚Ä¢ ${event.venue_name}`}
                    </p>
                    <div className="flex items-center gap-2">
                      {event.teams?.seasons?.sports?.icon && (
                        <span className="text-xs">{event.teams.seasons.sports.icon}</span>
                      )}
                      <p className="text-xs" style={{ color: event.teams?.color || '#EAB308' }}>
                        {event.teams?.name}
                      </p>
                    </div>
                  </div>
                  {rsvp && (
                    <div className="text-right">
                      <p className="text-emerald-400 text-sm font-medium flex items-center gap-1"><Check className="w-4 h-4 inline" /> {rsvp.yes}</p>
                      <p className={`text-xs ${tc.textMuted}`}>{rsvp.total} RSVPs</p>
                    </div>
                  )}
                </div>
              )
            })}
          </div>
        ) : (
          <div className="text-center py-8">
            <Calendar className="w-12 h-12" />
            <p className={`${tc.textSecondary} mt-2`}>No upcoming events</p>
          </div>
        )}
      </div>

      {/* Recent Activity */}
      {recentActivity.length > 0 && (
        <div className={`${tc.cardBg} border ${tc.border} rounded-2xl p-5`}>
          <h2 className={`font-semibold ${tc.text} mb-4 flex items-center gap-2`}>
            <span>üì∞</span> Recent Team Activity
          </h2>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {recentActivity.map(post => (
              <div 
                key={post.id}
                onClick={() => navigateToTeamWall(post.team_id)}
                className={`p-4 rounded-xl ${tc.cardBgAlt} cursor-pointer hover:scale-[1.01] transition`}
              >
                <div className="flex items-center justify-between mb-2">
                  <div className="flex items-center gap-2">
                    {post.teams?.seasons?.sports?.icon && (
                      <span className="text-sm">{post.teams.seasons.sports.icon}</span>
                    )}
                    <span 
                      className="px-2 py-0.5 rounded-full text-xs font-medium"
                      style={{ 
                        background: `${post.teams?.color || '#EAB308'}20`,
                        color: post.teams?.color || '#EAB308'
                      }}
                    >
                      {post.teams?.name}
                    </span>
                  </div>
                  <span className={`text-xs ${tc.textMuted}`}>
                    {new Date(post.created_at).toLocaleDateString()}
                  </span>
                </div>
                <h4 className={`font-medium ${tc.text}`}>{post.title}</h4>
                <p className={`text-sm ${tc.textSecondary} line-clamp-2`}>{post.content}</p>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Event Detail Modal */}
      {selectedEventDetail && (
        <EventDetailModal
          event={selectedEventDetail}
          teams={teams}
          venues={[]}
          onClose={() => setSelectedEventDetail(null)}
          onUpdate={() => {}}
          onDelete={() => {}}
          activeView="coach"
        />
      )}
    </div>
  )
}

// ============================================
// PLAYER DASHBOARD (Simple)
// ============================================
function PlayerDashboard({ roleContext, navigateToTeamWall, onNavigate }) {
  const tc = useThemeClasses()
  const [upcomingEvents, setUpcomingEvents] = useState([])
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    if (roleContext?.playerInfo) {
      loadPlayerData()
    } else {
      setLoading(false)
    }
  }, [roleContext])

  async function loadPlayerData() {
    try {
      const teamIds = roleContext.playerInfo.team_players?.map(tp => tp.team_id).filter(Boolean) || []
      
      if (teamIds.length > 0) {
        const today = new Date().toISOString().split('T')[0]
        const { data: events } = await supabase
          .from('schedule_events')
          .select('*, teams(name, color)')
          .in('team_id', teamIds)
          .gte('event_date', today)
          .order('event_date', { ascending: true })
          .limit(5)
        setUpcomingEvents(events || [])
      }
    } catch (err) {
      console.error('Error loading player data:', err)
    }
    setLoading(false)
  }
  
  if (!roleContext?.playerInfo) {
    return (
      <div className="flex flex-col items-center justify-center h-64 text-center">
        <VolleyballIcon className="w-16 h-16 mb-4" />
        <h2 className={`text-xl font-bold ${tc.text} mb-2`}>No Player Profile</h2>
        <p className={tc.textSecondary}>Your account isn't linked to a player profile.</p>
      </div>
    )
  }

  const player = roleContext.playerInfo
  const teams = player.team_players || []

  return (
    <div className="space-y-6">
      <div className="flex items-center gap-3">
        <h1 className={`text-3xl font-bold ${tc.text}`}>Hey {player.first_name}!</h1>
        <VolleyballIcon className="w-8 h-8 text-[var(--accent-primary)]" />
      </div>
      <p className={tc.textSecondary}>Ready to play?</p>

      {/* My Teams */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        {teams.map(tp => (
          <button
            key={tp.team_id}
            onClick={() => navigateToTeamWall(tp.team_id)}
            className={`${tc.cardBg} border ${tc.border} rounded-2xl p-6 text-left hover:border-[var(--accent-primary)]/30 hover:scale-[1.02] transition`}
            style={{ borderLeftWidth: 4, borderLeftColor: tp.teams?.color }}
          >
            <h3 className={`text-xl font-bold ${tc.text}`}>{tp.teams?.name}</h3>
            <p className={tc.textSecondary}>View team wall ‚Üí</p>
          </button>
        ))}
      </div>

      {/* Quick Actions */}
      <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
        <button 
          onClick={() => onNavigate('schedule')}
          className={`p-4 rounded-xl ${tc.cardBg} border ${tc.border} ${tc.hoverBg} transition flex items-center gap-3`}
        >
          <Calendar className="w-8 h-8" />
          <div className="text-left">
            <p className={`font-medium ${tc.text}`}>Schedule</p>
            <p className={`text-xs ${tc.textMuted}`}>All events</p>
          </div>
        </button>
        {teams[0] && (
          <button 
            onClick={() => navigateToTeamWall(teams[0].team_id)}
            className={`p-4 rounded-xl ${tc.cardBg} border ${tc.border} ${tc.hoverBg} transition flex items-center gap-3`}
          >
            <Users className="w-7 h-7" />
            <div className="text-left">
              <p className={`font-medium ${tc.text}`}>My Team</p>
              <p className={`text-xs ${tc.textMuted}`}>Roster & info</p>
            </div>
          </button>
        )}
      </div>

      {/* Upcoming Events */}
      {upcomingEvents.length > 0 && (
        <div className={`${tc.cardBg} border ${tc.border} rounded-2xl p-5`}>
          <h2 className={`font-semibold ${tc.text} mb-4 flex items-center gap-2`}>
            <Calendar className="w-5 h-5" /> Coming Up
          </h2>
          <div className="space-y-3">
            {upcomingEvents.map(event => {
              const eventDate = new Date(event.event_date)
              const isToday = eventDate.toDateString() === new Date().toDateString()
              
              return (
                <div 
                  key={event.id}
                  className={`flex items-center gap-4 p-3 rounded-xl ${tc.cardBgAlt}`}
                >
                  <div 
                    className="w-12 h-12 rounded-lg flex flex-col items-center justify-center text-xs font-bold"
                    style={{ 
                      background: `${event.teams?.color || '#EAB308'}20`,
                      color: event.teams?.color || '#EAB308'
                    }}
                  >
                    <span>{eventDate.toLocaleDateString('en-US', { weekday: 'short' })}</span>
                    <span className="text-sm">{eventDate.getDate()}</span>
                  </div>
                  <div className="flex-1">
                    <div className="flex items-center gap-2">
                      <span className={`font-medium ${tc.text}`}>
                        {event.event_type === 'practice' && 'practice'}
                        {event.event_type === 'game' && 'üèÜ'}
                        {event.event_type === 'tournament' && <Target className="w-4 h-4 inline" />}
                        {' '}{event.title || event.event_type}
                      </span>
                      {isToday && <span className="px-2 py-0.5 bg-emerald-500/20 text-emerald-400 text-xs rounded-full">Today!</span>}
                    </div>
                    <p className={`text-sm ${tc.textSecondary}`}>
                      {event.event_time && formatTime12(event.event_time)}
                      {event.venue_name && ` ‚Ä¢ ${event.venue_name}`}
                    </p>
                  </div>
                </div>
              )
            })}
          </div>
        </div>
      )}
    </div>
  )
}

// ============================================
// REGISTRATION ANALYTICS DASHBOARD
// ============================================
function RegistrationAnalytics({ registrations, season, statusCounts, showToast }) {
  const tc = useThemeClasses()
  const [payments, setPayments] = useState([])
  const [loading, setLoading] = useState(true)
  const [dateRange, setDateRange] = useState('all') // 'all', '7d', '30d', '90d'

  useEffect(() => {
    if (season?.id) loadPaymentData()
  }, [season?.id])

  async function loadPaymentData() {
    try {
      const { data } = await supabase
        .from('payments')
        .select('*')
        .eq('season_id', season.id)
      setPayments(data || [])
    } catch (err) {
      console.error('Error loading payments:', err)
    }
    setLoading(false)
  }

  // Calculate metrics
  const totalRegistrations = registrations.length
  const approvalRate = totalRegistrations > 0 
    ? ((statusCounts.approved + statusCounts.rostered) / totalRegistrations * 100).toFixed(1)
    : 0

  // Revenue metrics
  const totalRevenue = payments.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0)
  const collectedRevenue = payments.filter(p => p.paid).reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0)
  const outstandingRevenue = totalRevenue - collectedRevenue
  const collectionRate = totalRevenue > 0 ? (collectedRevenue / totalRevenue * 100).toFixed(1) : 0

  // Family metrics (unique parent emails)
  const uniqueFamilies = [...new Set(registrations.map(r => r.parent_email?.toLowerCase()).filter(Boolean))]
  const familyCount = uniqueFamilies.length
  const avgPlayersPerFamily = familyCount > 0 ? (totalRegistrations / familyCount).toFixed(1) : 0

  // Registration timeline - group by date
  const registrationsByDate = registrations.reduce((acc, r) => {
    const date = r.created_at ? new Date(r.created_at).toLocaleDateString() : 'Unknown'
    acc[date] = (acc[date] || 0) + 1
    return acc
  }, {})

  // Get last 14 days of data
  const last14Days = []
  for (let i = 13; i >= 0; i--) {
    const date = new Date()
    date.setDate(date.getDate() - i)
    const dateStr = date.toLocaleDateString()
    last14Days.push({
      date: dateStr,
      shortDate: date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
      count: registrationsByDate[dateStr] || 0
    })
  }

  // Find max for scaling
  const maxDailyRegs = Math.max(...last14Days.map(d => d.count), 1)

  // Grade distribution
  const gradeDistribution = registrations.reduce((acc, r) => {
    const grade = r.grade || 'Unknown'
    acc[grade] = (acc[grade] || 0) + 1
    return acc
  }, {})

  // Gender distribution
  const genderDistribution = registrations.reduce((acc, r) => {
    const gender = r.gender || 'Unknown'
    acc[gender] = (acc[gender] || 0) + 1
    return acc
  }, {})

  // Conversion funnel
  const funnel = [
    { stage: 'Submitted', count: totalRegistrations, color: 'bg-slate-500' },
    { stage: 'Pending Review', count: statusCounts.pending, color: 'bg-[var(--accent-primary)]' },
    { stage: 'Approved', count: statusCounts.approved, color: 'bg-blue-500' },
    { stage: 'On Roster', count: statusCounts.rostered, color: 'bg-emerald-500' },
  ]

  // Calculate capacity if available
  const capacity = season?.capacity || 0
  const capacityUsed = statusCounts.approved + statusCounts.rostered
  const capacityPercent = capacity > 0 ? (capacityUsed / capacity * 100).toFixed(0) : null

  return (
    <div className="space-y-6">
      {/* Top Stats Row */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div className={`${tc.cardBg} border ${tc.border} rounded-2xl p-5`}>
          <div className="flex items-center justify-between">
            <div>
              <p className={`text-sm ${tc.textMuted}`}>Total Registrations</p>
              <p className={`text-3xl font-bold ${tc.text}`}>{totalRegistrations}</p>
            </div>
            <ClipboardList className="w-8 h-8" />
          </div>
          <p className={`text-xs ${tc.textMuted} mt-2`}>{familyCount} families</p>
        </div>

        <div className={`${tc.cardBg} border ${tc.border} rounded-2xl p-5`}>
          <div className="flex items-center justify-between">
            <div>
              <p className={`text-sm ${tc.textMuted}`}>Approval Rate</p>
              <p className={`text-3xl font-bold text-emerald-400`}>{approvalRate}%</p>
            </div>
            <Check className="w-8 h-8 text-emerald-500" />
          </div>
          <p className={`text-xs ${tc.textMuted} mt-2`}>{statusCounts.approved + statusCounts.rostered} approved</p>
        </div>

        <div className={`${tc.cardBg} border ${tc.border} rounded-2xl p-5`}>
          <div className="flex items-center justify-between">
            <div>
              <p className={`text-sm ${tc.textMuted}`}>Revenue</p>
              <p className={`text-3xl font-bold text-emerald-400`}>${collectedRevenue.toFixed(0)}</p>
            </div>
            <DollarSign className="w-10 h-10" />
          </div>
          <p className={`text-xs text-amber-400 mt-2`}>${outstandingRevenue.toFixed(0)} outstanding</p>
        </div>

        <div className={`${tc.cardBg} border ${tc.border} rounded-2xl p-5`}>
          <div className="flex items-center justify-between">
            <div>
              <p className={`text-sm ${tc.textMuted}`}>Collection Rate</p>
              <p className={`text-3xl font-bold ${parseFloat(collectionRate) >= 80 ? 'text-emerald-400' : 'text-amber-400'}`}>{collectionRate}%</p>
            </div>
            <span className="text-3xl">üìà</span>
          </div>
          <p className={`text-xs ${tc.textMuted} mt-2`}>${totalRevenue.toFixed(0)} total due</p>
        </div>
      </div>

      {/* Capacity Bar (if capacity is set) */}
      {capacity > 0 && (
        <div className={`${tc.cardBg} border ${tc.border} rounded-2xl p-5`}>
          <div className="flex items-center justify-between mb-3">
            <h3 className={`font-semibold ${tc.text}`}>Season Capacity</h3>
            <span className={`text-sm ${capacityPercent >= 90 ? 'text-red-400' : capacityPercent >= 70 ? 'text-amber-400' : 'text-emerald-400'}`}>
              {capacityUsed} / {capacity} spots filled
            </span>
          </div>
          <div className="w-full h-4 bg-slate-700 rounded-full overflow-hidden">
            <div 
              className={`h-full transition-all ${capacityPercent >= 90 ? 'bg-red-500' : capacityPercent >= 70 ? 'bg-amber-500' : 'bg-emerald-500'}`}
              style={{ width: `${Math.min(capacityPercent, 100)}%` }}
            />
          </div>
          <div className="flex justify-between mt-2">
            <span className={`text-xs ${tc.textMuted}`}>
              {statusCounts.waitlist > 0 && `${statusCounts.waitlist} on waitlist`}
            </span>
            <span className={`text-xs ${tc.textMuted}`}>
              {capacity - capacityUsed > 0 ? `${capacity - capacityUsed} spots left` : 'Full!'}
            </span>
          </div>
        </div>
      )}

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* Registration Timeline Chart */}
        <div className={`${tc.cardBg} border ${tc.border} rounded-2xl p-5`}>
          <h3 className={`font-semibold ${tc.text} mb-4 flex items-center gap-2`}><Calendar className="w-5 h-5" />Registration Timeline (Last 14 Days)</h3>
          <div className="flex items-end justify-between h-40 gap-1">
            {last14Days.map((day, i) => (
              <div key={i} className="flex-1 flex flex-col items-center">
                <div className="flex-1 w-full flex items-end justify-center">
                  <div 
                    className="w-full max-w-[24px] bg-[var(--accent-primary)] rounded-t transition-all hover:brightness-110"
                    style={{ height: `${(day.count / maxDailyRegs) * 100}%`, minHeight: day.count > 0 ? '8px' : '2px' }}
                    title={`${day.date}: ${day.count} registrations`}
                  />
                </div>
                <p className={`text-[10px] ${tc.textMuted} mt-1 rotate-[-45deg] origin-top-left translate-y-2`}>
                  {day.shortDate}
                </p>
              </div>
            ))}
          </div>
          <div className="mt-6 pt-2 border-t border-slate-700/50">
            <p className={`text-sm ${tc.textMuted}`}>
              Total in period: <span className={tc.text}>{last14Days.reduce((sum, d) => sum + d.count, 0)}</span>
              {' ¬∑ '}Avg/day: <span className={tc.text}>{(last14Days.reduce((sum, d) => sum + d.count, 0) / 14).toFixed(1)}</span>
            </p>
          </div>
        </div>

        {/* Status Funnel */}
        <div className={`${tc.cardBg} border ${tc.border} rounded-2xl p-5`}>
          <h3 className={`font-semibold ${tc.text} mb-4`}>üîÑ Registration Funnel</h3>
          <div className="space-y-3">
            {funnel.map((stage, i) => {
              const percent = totalRegistrations > 0 ? (stage.count / totalRegistrations * 100) : 0
              return (
                <div key={i}>
                  <div className="flex justify-between mb-1">
                    <span className={`text-sm ${tc.textSecondary}`}>{stage.stage}</span>
                    <span className={`text-sm font-medium ${tc.text}`}>{stage.count}</span>
                  </div>
                  <div className="w-full h-3 bg-slate-700 rounded-full overflow-hidden">
                    <div 
                      className={`h-full ${stage.color} transition-all`}
                      style={{ width: `${percent}%` }}
                    />
                  </div>
                </div>
              )
            })}
          </div>
          {statusCounts.waitlist > 0 && (
            <div className="mt-4 pt-4 border-t border-slate-700/50">
              <div className="flex items-center justify-between">
                <span className={`text-sm text-amber-400`}>‚è≥ Waitlist</span>
                <span className={`text-sm font-medium text-amber-400`}>{statusCounts.waitlist}</span>
              </div>
            </div>
          )}
          {statusCounts.denied > 0 && (
            <div className="mt-2">
              <div className="flex items-center justify-between">
                <span className={`text-sm text-red-400`}>‚úó Denied</span>
                <span className={`text-sm font-medium text-red-400`}>{statusCounts.denied}</span>
              </div>
            </div>
          )}
        </div>

        {/* Grade Distribution */}
        <div className={`${tc.cardBg} border ${tc.border} rounded-2xl p-5`}>
          <h3 className={`font-semibold ${tc.text} mb-4`}>üéì Grade Distribution</h3>
          <div className="space-y-2">
            {Object.entries(gradeDistribution)
              .sort((a, b) => {
                const gradeOrder = ['K', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', 'Unknown']
                return gradeOrder.indexOf(a[0]) - gradeOrder.indexOf(b[0])
              })
              .map(([grade, count]) => {
                const percent = (count / totalRegistrations * 100)
                return (
                  <div key={grade} className="flex items-center gap-3">
                    <span className={`w-20 text-sm ${tc.textSecondary}`}>Grade {grade}</span>
                    <div className="flex-1 h-6 bg-slate-700 rounded overflow-hidden">
                      <div 
                        className="h-full bg-[var(--accent-primary)] flex items-center justify-end pr-2"
                        style={{ width: `${percent}%`, minWidth: count > 0 ? '30px' : '0' }}
                      >
                        <span className="text-xs text-white font-medium">{count}</span>
                      </div>
                    </div>
                    <span className={`w-12 text-xs ${tc.textMuted} text-right`}>{percent.toFixed(0)}%</span>
                  </div>
                )
              })}
          </div>
        </div>

        {/* Gender & Family Stats */}
        <div className={`${tc.cardBg} border ${tc.border} rounded-2xl p-5`}>
          <h3 className={`font-semibold ${tc.text} mb-4`}>Demographics</h3>
          
          {/* Gender Pills */}
          <div className="flex gap-3 mb-6">
            {Object.entries(genderDistribution).map(([gender, count]) => {
              const percent = (count / totalRegistrations * 100).toFixed(0)
              const icon = gender.toLowerCase() === 'male' ? 'M' : gender.toLowerCase() === 'female' ? 'F' : 'O'
              const color = gender.toLowerCase() === 'male' ? 'bg-blue-500/20 text-blue-400' : gender.toLowerCase() === 'female' ? 'bg-pink-500/20 text-pink-400' : 'bg-gray-500/20 text-gray-400'
              return (
                <div key={gender} className={`flex-1 ${color} rounded-xl p-4 text-center`}>
                  <span className="text-2xl">{icon}</span>
                  <p className="text-2xl font-bold mt-1">{count}</p>
                  <p className="text-xs opacity-75">{gender} ({percent}%)</p>
                </div>
              )
            })}
          </div>

          {/* Family Stats */}
          <div className="grid grid-cols-2 gap-4">
            <div className={`${tc.cardBgAlt} rounded-xl p-4 text-center`}>
              <p className={`text-3xl font-bold ${tc.text}`}>{familyCount}</p>
              <p className={`text-xs ${tc.textMuted}`}>Unique Families</p>
            </div>
            <div className={`${tc.cardBgAlt} rounded-xl p-4 text-center`}>
              <p className={`text-3xl font-bold ${tc.text}`}>{avgPlayersPerFamily}</p>
              <p className={`text-xs ${tc.textMuted}`}>Avg Players/Family</p>
            </div>
          </div>
        </div>
      </div>

      {/* Revenue Breakdown */}
      <div className={`${tc.cardBg} border ${tc.border} rounded-2xl p-5`}>
        <h3 className={`font-semibold ${tc.text} mb-4`}>üíµ Revenue Breakdown</h3>
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div className={`${tc.cardBgAlt} rounded-xl p-4`}>
            <p className={`text-sm ${tc.textMuted}`}>Total Expected</p>
            <p className={`text-2xl font-bold ${tc.text}`}>${totalRevenue.toFixed(2)}</p>
          </div>
          <div className={`${tc.cardBgAlt} rounded-xl p-4`}>
            <p className={`text-sm ${tc.textMuted}`}>Collected</p>
            <p className={`text-2xl font-bold text-emerald-400`}>${collectedRevenue.toFixed(2)}</p>
          </div>
          <div className={`${tc.cardBgAlt} rounded-xl p-4`}>
            <p className={`text-sm ${tc.textMuted}`}>Outstanding</p>
            <p className={`text-2xl font-bold text-amber-400`}>${outstandingRevenue.toFixed(2)}</p>
          </div>
          <div className={`${tc.cardBgAlt} rounded-xl p-4`}>
            <p className={`text-sm ${tc.textMuted}`}>Avg per Player</p>
            <p className={`text-2xl font-bold ${tc.text}`}>${totalRegistrations > 0 ? (totalRevenue / totalRegistrations).toFixed(2) : '0.00'}</p>
          </div>
        </div>
        
        {/* Fee Type Breakdown */}
        {payments.length > 0 && (
          <div className="mt-4 pt-4 border-t border-slate-700/50">
            <p className={`text-sm ${tc.textMuted} mb-3`}>By Fee Type</p>
            <div className="flex flex-wrap gap-3">
              {Object.entries(
                payments.reduce((acc, p) => {
                  const type = p.fee_type || 'other'
                  if (!acc[type]) acc[type] = { total: 0, paid: 0 }
                  acc[type].total += parseFloat(p.amount) || 0
                  if (p.paid) acc[type].paid += parseFloat(p.amount) || 0
                  return acc
                }, {})
              ).map(([type, data]) => (
                <div key={type} className={`${tc.cardBg} border ${tc.border} rounded-lg px-4 py-2`}>
                  <p className={`text-xs ${tc.textMuted} capitalize`}>{type}</p>
                  <p className={`font-medium ${tc.text}`}>${data.total.toFixed(0)}</p>
                  <p className="text-xs text-emerald-400">${data.paid.toFixed(0)} paid</p>
                </div>
              ))}
            </div>
          </div>
        )}
      </div>
    </div>
  )
}

// ============================================
// REGISTRATIONS PAGE
// ============================================
function RegistrationsPage({ showToast }) {
  const journey = useJourney()
  const { selectedSeason } = useSeason()
  const { organization } = useAuth()
  const tc = useThemeClasses()
  const [registrations, setRegistrations] = useState([])
  const [statusFilter, setStatusFilter] = useState('all')
  const [searchQuery, setSearchQuery] = useState('')
  const [loading, setLoading] = useState(true)
  const [selectedPlayer, setSelectedPlayer] = useState(null)
  const [editMode, setEditMode] = useState(false)
  const [showDenyModal, setShowDenyModal] = useState(null)
  
  // Bulk selection state
  const [selectedIds, setSelectedIds] = useState(new Set())
  const [bulkProcessing, setBulkProcessing] = useState(false)
  const [showBulkDenyModal, setShowBulkDenyModal] = useState(false)
  
  // View mode: 'table' or 'analytics'
  const [viewMode, setViewMode] = useState('table')

  useEffect(() => {
    if (selectedSeason?.id) loadRegistrations()
  }, [selectedSeason?.id, statusFilter])

  // Clear selection when filter changes
  useEffect(() => {
    setSelectedIds(new Set())
  }, [statusFilter])

  async function loadRegistrations() {
    if (!selectedSeason?.id) return
    setLoading(true)
    const { data, error } = await supabase
      .from('players')
      .select('*, registrations(*)')
      .eq('season_id', selectedSeason.id)
      .order('created_at', { ascending: false })
    
    if (error) {
      console.error('Error loading registrations:', error)
    } else {
      let filtered = data || []
      if (statusFilter !== 'all') {
        if (statusFilter === 'pending') {
          filtered = filtered.filter(p => ['submitted', 'pending', 'new'].includes(p.registrations?.[0]?.status))
        } else if (statusFilter === 'denied') {
          filtered = filtered.filter(p => p.registrations?.[0]?.status === 'withdrawn')
        } else {
          filtered = filtered.filter(p => p.registrations?.[0]?.status === statusFilter)
        }
      }
      setRegistrations(filtered)
    }
    setLoading(false)
  }

  async function updateStatus(playerId, regId, newStatus) {
    try {
      await supabase.from('registrations').update({ 
        status: newStatus, 
        updated_at: new Date().toISOString(),
        ...(newStatus === 'approved' ? { approved_at: new Date().toISOString() } : {})
      }).eq('id', regId)
      
      // Generate fees automatically when approving
      if (newStatus === 'approved' && selectedSeason) {
        // Get the full player data
        const { data: playerData } = await supabase
          .from('players')
          .select('*, registrations(*)')
          .eq('id', playerId)
          .single()
        
        if (playerData) {
          const result = await generateFeesForPlayer(supabase, playerData, selectedSeason, null)
          if (result.success && !result.skipped) {
            showToast(`Approved! Generated ${result.feesCreated} fees ($${result.totalAmount.toFixed(2)})`, 'success')
            
            // Send approval email notification
            if (isEmailEnabled(organization, 'registration_approved') && playerData.parent_email) {
              const fees = result.fees || []
              EmailService.sendApprovalNotification(playerData, selectedSeason, organization, fees)
                .then(r => r.success && console.log('Approval email queued'))
                .catch(e => console.error('Email queue error:', e))
            }
          } else if (result.skipped) {
            showToast('Registration approved!', 'success')
            // Still send email even if fees were skipped
            if (isEmailEnabled(organization, 'registration_approved') && playerData.parent_email) {
              EmailService.sendApprovalNotification(playerData, selectedSeason, organization, [])
                .then(r => r.success && console.log('Approval email queued'))
                .catch(e => console.error('Email queue error:', e))
            }
          } else {
            showToast('Approved (fee generation failed - check manually)', 'warning')
          }
        } else {
          showToast('Registration approved!', 'success')
        }
        journey?.completeStep('register_players')
      } else {
        showToast(`Registration ${newStatus}!`, 'success')
      }
      
      loadRegistrations()
    } catch (err) {
      showToast('Error updating status: ' + err.message, 'error')
    }
  }

  async function denyRegistration(regId, reason) {
    try {
      await supabase.from('registrations').update({ 
        status: 'withdrawn', 
        denial_reason: reason,
        updated_at: new Date().toISOString()
      }).eq('id', regId)
      showToast('Registration denied', 'success')
      setShowDenyModal(null)
      loadRegistrations()
    } catch (err) {
      showToast('Error: ' + err.message, 'error')
    }
  }

  // ========== BULK ACTIONS ==========
  
  function toggleSelectAll() {
    if (selectedIds.size === filteredRegs.length) {
      setSelectedIds(new Set())
    } else {
      setSelectedIds(new Set(filteredRegs.map(p => p.id)))
    }
  }

  function toggleSelect(playerId) {
    const newSelected = new Set(selectedIds)
    if (newSelected.has(playerId)) {
      newSelected.delete(playerId)
    } else {
      newSelected.add(playerId)
    }
    setSelectedIds(newSelected)
  }

  async function bulkApprove() {
    setBulkProcessing(true)
    const selectedPlayers = filteredRegs.filter(p => selectedIds.has(p.id))
    const pendingPlayers = selectedPlayers.filter(p => 
      ['submitted', 'pending', 'new'].includes(p.registrations?.[0]?.status)
    )
    
    if (pendingPlayers.length === 0) {
      showToast('No pending registrations selected', 'warning')
      setBulkProcessing(false)
      return
    }

    let approved = 0
    let feesGenerated = 0
    let totalFeeAmount = 0
    let emailsQueued = 0

    for (const player of pendingPlayers) {
      const reg = player.registrations?.[0]
      if (!reg) continue

      try {
        // Update registration status
        await supabase.from('registrations').update({ 
          status: 'approved', 
          updated_at: new Date().toISOString(),
          approved_at: new Date().toISOString()
        }).eq('id', reg.id)
        
        approved++

        // Generate fees
        let fees = []
        if (selectedSeason) {
          const result = await generateFeesForPlayer(supabase, player, selectedSeason, null)
          if (result.success && !result.skipped) {
            feesGenerated += result.feesCreated
            totalFeeAmount += result.totalAmount
            fees = result.fees || []
          }
        }
        
        // Queue approval email
        if (isEmailEnabled(organization, 'registration_approved') && player.parent_email) {
          const emailResult = await EmailService.sendApprovalNotification(player, selectedSeason, organization, fees)
          if (emailResult.success) emailsQueued++
        }
      } catch (err) {
        console.error('Error approving player:', player.id, err)
      }
    }

    showToast(
      `Approved ${approved} registrations! Generated ${feesGenerated} fees ($${totalFeeAmount.toFixed(2)})${emailsQueued > 0 ? ` ‚Ä¢ ${emailsQueued} emails queued` : ''}`,
      'success'
    )
    
    journey?.completeStep('register_players')
    setSelectedIds(new Set())
    setBulkProcessing(false)
    loadRegistrations()
  }

  async function bulkApproveAllPending() {
    setBulkProcessing(true)
    const pendingPlayers = registrations.filter(p => 
      ['submitted', 'pending', 'new'].includes(p.registrations?.[0]?.status)
    )
    
    if (pendingPlayers.length === 0) {
      showToast('No pending registrations to approve', 'warning')
      setBulkProcessing(false)
      return
    }

    let approved = 0
    let feesGenerated = 0
    let totalFeeAmount = 0
    let emailsQueued = 0

    for (const player of pendingPlayers) {
      const reg = player.registrations?.[0]
      if (!reg) continue

      try {
        await supabase.from('registrations').update({ 
          status: 'approved', 
          updated_at: new Date().toISOString(),
          approved_at: new Date().toISOString()
        }).eq('id', reg.id)
        
        approved++

        let fees = []
        if (selectedSeason) {
          const result = await generateFeesForPlayer(supabase, player, selectedSeason, null)
          if (result.success && !result.skipped) {
            feesGenerated += result.feesCreated
            totalFeeAmount += result.totalAmount
            fees = result.fees || []
          }
        }
        
        // Queue approval email
        if (isEmailEnabled(organization, 'registration_approved') && player.parent_email) {
          const emailResult = await EmailService.sendApprovalNotification(player, selectedSeason, organization, fees)
          if (emailResult.success) emailsQueued++
        }
      } catch (err) {
        console.error('Error approving player:', player.id, err)
      }
    }

    showToast(
      `Approved all ${approved} pending registrations! Generated ${feesGenerated} fees ($${totalFeeAmount.toFixed(2)})${emailsQueued > 0 ? ` ‚Ä¢ ${emailsQueued} emails queued` : ''}`,
      'success'
    )
    
    journey?.completeStep('register_players')
    setBulkProcessing(false)
    loadRegistrations()
  }

  async function bulkDeny(reason) {
    setBulkProcessing(true)
    const selectedPlayers = filteredRegs.filter(p => selectedIds.has(p.id))
    const pendingPlayers = selectedPlayers.filter(p => 
      ['submitted', 'pending', 'new', 'waitlist'].includes(p.registrations?.[0]?.status)
    )
    
    let denied = 0

    for (const player of pendingPlayers) {
      const reg = player.registrations?.[0]
      if (!reg) continue

      try {
        await supabase.from('registrations').update({ 
          status: 'withdrawn', 
          denial_reason: reason,
          updated_at: new Date().toISOString()
        }).eq('id', reg.id)
        denied++
      } catch (err) {
        console.error('Error denying player:', player.id, err)
      }
    }

    showToast(`Denied ${denied} registrations`, 'success')
    setSelectedIds(new Set())
    setShowBulkDenyModal(false)
    setBulkProcessing(false)
    loadRegistrations()
  }

  async function bulkMoveToWaitlist() {
    setBulkProcessing(true)
    const selectedPlayers = filteredRegs.filter(p => selectedIds.has(p.id))
    const eligiblePlayers = selectedPlayers.filter(p => 
      ['submitted', 'pending', 'new', 'approved'].includes(p.registrations?.[0]?.status)
    )
    
    let moved = 0

    for (const player of eligiblePlayers) {
      const reg = player.registrations?.[0]
      if (!reg) continue

      try {
        await supabase.from('registrations').update({ 
          status: 'waitlist', 
          updated_at: new Date().toISOString()
        }).eq('id', reg.id)
        moved++
      } catch (err) {
        console.error('Error moving player to waitlist:', player.id, err)
      }
    }

    showToast(`Moved ${moved} registrations to waitlist`, 'success')
    setSelectedIds(new Set())
    setBulkProcessing(false)
    loadRegistrations()
  }

  function bulkExport() {
    const selectedPlayers = filteredRegs.filter(p => selectedIds.has(p.id))
    if (selectedPlayers.length === 0) {
      showToast('No registrations selected', 'warning')
      return
    }
    exportToCSV(selectedPlayers, 'selected_registrations', csvColumns)
    showToast(`Exported ${selectedPlayers.length} registrations`, 'success')
  }

  const filteredRegs = registrations.filter(p => {
    if (!searchQuery) return true
    const search = searchQuery.toLowerCase()
    return (
      p.first_name?.toLowerCase().includes(search) ||
      p.last_name?.toLowerCase().includes(search) ||
      p.parent_name?.toLowerCase().includes(search) ||
      p.parent_email?.toLowerCase().includes(search)
    )
  })

  const statusCounts = {
    all: registrations.length,
    pending: registrations.filter(p => ['submitted', 'pending', 'new'].includes(p.registrations?.[0]?.status)).length,
    approved: registrations.filter(p => p.registrations?.[0]?.status === 'approved').length,
    rostered: registrations.filter(p => p.registrations?.[0]?.status === 'rostered').length,
    waitlist: registrations.filter(p => p.registrations?.[0]?.status === 'waitlist').length,
    denied: registrations.filter(p => p.registrations?.[0]?.status === 'withdrawn').length,
  }

  // Count selected by status for bulk action context
  const selectedPendingCount = filteredRegs.filter(p => 
    selectedIds.has(p.id) && ['submitted', 'pending', 'new'].includes(p.registrations?.[0]?.status)
  ).length

  const csvColumns = [
    { label: 'First Name', accessor: r => r.first_name },
    { label: 'Last Name', accessor: r => r.last_name },
    { label: 'DOB', accessor: r => r.birth_date || r.dob },
    { label: 'Grade', accessor: r => r.grade },
    { label: 'Gender', accessor: r => r.gender },
    { label: 'Parent Name', accessor: r => r.parent_name },
    { label: 'Parent Email', accessor: r => r.parent_email },
    { label: 'Parent Phone', accessor: r => r.parent_phone },
    { label: 'Status', accessor: r => r.registrations?.[0]?.status },
    { label: 'Liability Waiver', accessor: r => r.waiver_liability ? 'Yes' : 'No' },
    { label: 'Photo Waiver', accessor: r => r.waiver_photo ? 'Yes' : 'No' },
    { label: 'Conduct Waiver', accessor: r => r.waiver_conduct ? 'Yes' : 'No' },
  ]

  if (!selectedSeason) {
    return (
      <div className="flex items-center justify-center h-64">
        <p className={tc.textSecondary}>Please select a season from the sidebar</p>
      </div>
    )
  }

  return (
    <div className="space-y-6">
      <div className="flex items-start justify-between">
        <div>
          <h1 className={`text-3xl font-bold ${tc.text}`}>Registrations</h1>
          <p className={`${tc.textSecondary} mt-1`}>View and manage player registrations ‚Ä¢ {selectedSeason.name}</p>
        </div>
        <div className="flex gap-3">
          {/* View Toggle */}
          <div className={`flex ${tc.cardBg} rounded-xl p-1 border ${tc.border}`}>
            <button
              onClick={() => setViewMode('table')}
              className={`px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2 ${viewMode === 'table' ? 'bg-[var(--accent-primary)] text-white' : `${tc.textSecondary} ${tc.hoverBg}`}`}
            >
              <Table className="w-4 h-4" /> Table
            </button>
            <button
              onClick={() => setViewMode('analytics')}
              className={`px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2 ${viewMode === 'analytics' ? 'bg-[var(--accent-primary)] text-white' : `${tc.textSecondary} ${tc.hoverBg}`}`}
            >
              <BarChart3 className="w-4 h-4" /> Analytics
            </button>
          </div>
          {viewMode === 'table' && statusCounts.pending > 0 && (
            <button 
              onClick={bulkApproveAllPending}
              disabled={bulkProcessing}
              className="bg-emerald-600 text-white px-4 py-2 rounded-xl hover:bg-emerald-700 flex items-center gap-2 font-medium disabled:opacity-50"
            >
              {bulkProcessing ? '‚è≥' : '‚úì'} Approve All Pending ({statusCounts.pending})
            </button>
          )}
          <button 
            onClick={() => exportToCSV(filteredRegs, 'registrations', csvColumns)}
            className={`${tc.cardBg} ${tc.text} px-4 py-2 rounded-xl ${tc.hoverBgAlt} flex items-center gap-2 border ${tc.border}`}
          >
            üì• Export CSV
          </button>
        </div>
      </div>

      {/* Analytics View */}
      {viewMode === 'analytics' && (
        <RegistrationAnalytics 
          registrations={registrations} 
          season={selectedSeason}
          statusCounts={statusCounts}
          showToast={showToast}
        />
      )}

      {/* Table View */}
      {viewMode === 'table' && (
        <>
      {/* Bulk Action Bar - appears when items selected */}
      {selectedIds.size > 0 && (
        <div className={`${tc.cardBg} border ${tc.border} rounded-xl p-4 flex items-center justify-between`}>
          <div className="flex items-center gap-4">
            <span className={`${tc.text} font-medium`}>
              {selectedIds.size} selected
            </span>
            <button onClick={() => setSelectedIds(new Set())} className={`text-sm ${tc.textMuted} hover:underline`}>
              Clear selection
            </button>
          </div>
          <div className="flex gap-2">
            {selectedPendingCount > 0 && (
              <button 
                onClick={bulkApprove}
                disabled={bulkProcessing}
                className="bg-emerald-600 text-white px-4 py-2 rounded-xl text-sm font-medium hover:bg-emerald-700 disabled:opacity-50 flex items-center gap-2"
              >
                {bulkProcessing ? '‚è≥' : '‚úì'} Approve ({selectedPendingCount})
              </button>
            )}
            <button 
              onClick={bulkMoveToWaitlist}
              disabled={bulkProcessing}
              className="bg-amber-500 text-white px-4 py-2 rounded-xl text-sm font-medium hover:bg-amber-600 disabled:opacity-50 flex items-center gap-2"
            >
              <List className="w-4 h-4" /> Waitlist
            </button>
            <button 
              onClick={() => setShowBulkDenyModal(true)}
              disabled={bulkProcessing}
              className="bg-red-600 text-white px-4 py-2 rounded-xl text-sm font-medium hover:bg-red-700 disabled:opacity-50"
            >
              ‚úó Deny
            </button>
            <button 
              onClick={bulkExport}
              className={`${tc.cardBgAlt} ${tc.text} px-4 py-2 rounded-xl text-sm font-medium ${tc.hoverBgAlt}`}
            >
              üì• Export Selected
            </button>
          </div>
        </div>
      )}

      {/* Filters */}
      <div className="flex flex-wrap gap-4 items-center">
        <div className={`flex ${tc.cardBg} rounded-xl p-1 border ${tc.border} flex-wrap`}>
          {[
            { key: 'all', label: 'All' },
            { key: 'pending', label: 'Pending' },
            { key: 'approved', label: 'Approved' },
            { key: 'rostered', label: 'Rostered' },
            { key: 'waitlist', label: 'Waitlist', color: 'text-amber-400' },
            { key: 'denied', label: 'Denied' },
          ].map(f => (
            <button key={f.key} onClick={() => setStatusFilter(f.key)}
              className={`px-4 py-2 rounded-lg text-sm font-medium transition ${
                statusFilter === f.key ? 'bg-[var(--accent-primary)] text-white' : `${tc.textSecondary} ${tc.hoverBg}`
              }`}>
              {f.label} ({statusCounts[f.key] || 0})
            </button>
          ))}
        </div>
        <input type="text" placeholder="Search players or parents..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)}
          className={`flex-1 min-w-[200px] ${tc.cardBg} border ${tc.border} rounded-xl px-4 py-2 ${tc.text} placeholder-gray-500`} />
      </div>

      {/* Table */}
      {loading ? (
        <div className={`text-center py-12 ${tc.textSecondary}`}>Loading registrations...</div>
      ) : filteredRegs.length === 0 ? (
        <div className={`${tc.cardBg} border ${tc.border} rounded-2xl p-12 text-center`}>
          <ClipboardList className="w-16 h-16" />
          <h3 className={`text-lg font-medium ${tc.text} mt-4`}>No registrations found</h3>
          <p className={`${tc.textSecondary} mt-2`}>
            {statusFilter !== 'all' ? 'Try changing the filter' : 'Registrations will appear here'}
          </p>
        </div>
      ) : (
        <div className={`${tc.cardBg} border ${tc.border} rounded-2xl overflow-hidden`}>
          <table className="w-full">
            <thead>
              <tr className={`border-b ${tc.border}`}>
                <th className="w-12 px-4 py-4">
                  <input 
                    type="checkbox" 
                    checked={selectedIds.size === filteredRegs.length && filteredRegs.length > 0}
                    onChange={toggleSelectAll}
                    className="w-4 h-4 rounded cursor-pointer"
                  />
                </th>
                <th className={`text-left px-6 py-4 text-sm font-medium ${tc.textSecondary}`}>Player</th>
                <th className={`text-left px-6 py-4 text-sm font-medium ${tc.textSecondary}`}>Parent</th>
                <th className={`text-left px-6 py-4 text-sm font-medium ${tc.textSecondary}`}>Contact</th>
                <th className={`text-left px-6 py-4 text-sm font-medium ${tc.textSecondary}`}>Waivers</th>
                <th className={`text-left px-6 py-4 text-sm font-medium ${tc.textSecondary}`}>Status</th>
                <th className={`text-left px-6 py-4 text-sm font-medium ${tc.textSecondary}`}>Actions</th>
              </tr>
            </thead>
            <tbody>
              {filteredRegs.map(player => {
                const reg = player.registrations?.[0]
                const isSelected = selectedIds.has(player.id)
                return (
                  <tr key={player.id} className={`border-b ${tc.border} ${tc.hoverBg} ${isSelected ? 'bg-[var(--accent-primary)]/10' : ''}`}>
                    <td className="w-12 px-4 py-4">
                      <input 
                        type="checkbox" 
                        checked={isSelected}
                        onChange={() => toggleSelect(player.id)}
                        className="w-4 h-4 rounded cursor-pointer"
                      />
                    </td>
                    <td className="px-6 py-4">
                      <div>
                        <ClickablePlayerName 
                          player={player}
                          onPlayerSelect={(p) => { setSelectedPlayer(p); setEditMode(false) }}
                          className={`font-medium ${tc.text}`}
                        />
                        <p className={`text-xs ${tc.textMuted}`}>
                          {player.birth_date || player.dob ? `Age: ${calculateAge(player.birth_date || player.dob)}` : ''} 
                          {player.grade ? ` ‚Ä¢ Grade ${player.grade}` : ''}
                        </p>
                      </div>
                    </td>
                    <td className="px-6 py-4">
                      <p className={tc.text}>{player.parent_name || 'N/A'}</p>
                    </td>
                    <td className="px-6 py-4">
                      <p className={`text-sm ${tc.textSecondary}`}>{player.parent_email}</p>
                      <p className={`text-xs ${tc.textMuted}`}>{player.parent_phone}</p>
                    </td>
                    <td className="px-6 py-4">
                      <div className="flex gap-1">
                        <span className={`w-6 h-6 rounded-full flex items-center justify-center text-xs ${player.waiver_liability ? 'bg-emerald-500/20 text-emerald-400' : 'bg-red-500/20 text-red-400'}`}>
                          {player.waiver_liability ? '‚úì' : '‚úó'}
                        </span>
                        <span className={`w-6 h-6 rounded-full flex items-center justify-center text-xs ${player.waiver_photo ? 'bg-emerald-500/20 text-emerald-400' : 'bg-gray-500/20 text-slate-400'}`}>
                          {player.waiver_photo ? 'üì∑' : '‚Äì'}
                        </span>
                        <span className={`w-6 h-6 rounded-full flex items-center justify-center text-xs ${player.waiver_conduct ? 'bg-emerald-500/20 text-emerald-400' : 'bg-red-500/20 text-red-400'}`}>
                          {player.waiver_conduct ? '‚úì' : '‚úó'}
                        </span>
                      </div>
                    </td>
                    <td className="px-6 py-4">
                      <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                        ['submitted', 'pending', 'new'].includes(reg?.status) ? 'bg-[var(--accent-primary)]/20 text-[var(--accent-primary)]' :
                        reg?.status === 'approved' ? 'bg-blue-500/20 text-blue-400' :
                        reg?.status === 'rostered' ? 'bg-emerald-500/20 text-emerald-400' :
                        reg?.status === 'waitlist' ? 'bg-amber-500/20 text-amber-400' :
                        reg?.status === 'withdrawn' ? 'bg-red-500/20 text-red-400' :
                        'bg-gray-500/20 text-slate-400'
                      }`}>{reg?.status === 'submitted' || reg?.status === 'new' ? 'pending' : reg?.status || 'unknown'}</span>
                    </td>
                    <td className="px-6 py-4">
                      <div className="flex gap-2">
                        <button onClick={() => { setSelectedPlayer(player); setEditMode(false) }} className={`px-3 py-1 ${tc.cardBgAlt} rounded-lg text-xs ${tc.text} ${tc.hoverBgAlt}`}>
                          View
                        </button>
                        <button onClick={() => { setSelectedPlayer(player); setEditMode(true) }} className="px-3 py-1 bg-blue-500/20 rounded-lg text-xs text-blue-400 hover:bg-blue-500/30">
                          Edit
                        </button>
                        {['submitted', 'pending', 'new'].includes(reg?.status) && (
                          <>
                            <button onClick={() => updateStatus(player.id, reg.id, 'approved')} className="px-3 py-1 bg-emerald-500/20 rounded-lg text-xs text-emerald-400 hover:bg-emerald-500/30">
                              Approve
                            </button>
                            <button onClick={() => setShowDenyModal({ player, reg })} className="px-3 py-1 bg-red-500/20 rounded-lg text-xs text-red-400 hover:bg-red-500/30">
                              Deny
                            </button>
                          </>
                        )}
                        {reg?.status === 'waitlist' && (
                          <button onClick={() => updateStatus(player.id, reg.id, 'approved')} className="px-3 py-1 bg-amber-500/20 rounded-lg text-xs text-amber-400 hover:bg-amber-500/30" title="Promote from waitlist to approved">
                            ‚¨ÜÔ∏è Promote
                          </button>
                        )}
                      </div>
                    </td>
                  </tr>
                )
              })}
            </tbody>
          </table>
        </div>
      )}
        </>
      )}

      {/* Player Detail/Edit Modal */}
      {selectedPlayer && (
        <PlayerDetailModal 
          player={selectedPlayer} 
          editMode={editMode}
          onClose={() => { setSelectedPlayer(null); setEditMode(false) }} 
          onUpdate={() => { loadRegistrations(); setSelectedPlayer(null); setEditMode(false) }}
          showToast={showToast}
        />
      )}

      {/* Deny Modal (single) */}
      {showDenyModal && (
        <DenyRegistrationModal
          player={showDenyModal.player}
          onClose={() => setShowDenyModal(null)}
          onDeny={(reason) => denyRegistration(showDenyModal.reg.id, reason)}
        />
      )}

      {/* Bulk Deny Modal */}
      {showBulkDenyModal && (
        <BulkDenyModal
          count={selectedIds.size}
          onClose={() => setShowBulkDenyModal(false)}
          onDeny={bulkDeny}
          processing={bulkProcessing}
        />
      )}
    </div>
  )
}

// ============================================
// BULK DENY MODAL
// ============================================
function BulkDenyModal({ count, onClose, onDeny, processing }) {
  const tc = useThemeClasses()
  const [reason, setReason] = useState('')

  return (
    <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50">
      <div className={`${tc.cardBg} border ${tc.border} rounded-2xl w-full max-w-md`}>
        <div className={`p-6 border-b ${tc.border}`}>
          <h2 className={`text-xl font-semibold ${tc.text}`}>Deny {count} Registrations</h2>
          <p className={`${tc.textMuted} text-sm mt-1`}>This action cannot be undone.</p>
        </div>
        <div className="p-6 space-y-4">
          <div>
            <label className={`block text-sm ${tc.textMuted} mb-2`}>Reason for denial (optional)</label>
            <textarea 
              value={reason} 
              onChange={e => setReason(e.target.value)}
              placeholder="e.g., Season is full, missing required documents..."
              className={`w-full ${tc.inputBg} border ${tc.border} rounded-xl px-4 py-3 ${tc.text} min-h-[100px]`}
            />
          </div>
        </div>
        <div className={`p-6 border-t ${tc.border} flex justify-end gap-3`}>
          <button onClick={onClose} className={`px-6 py-2 rounded-xl border ${tc.border} ${tc.text}`}>
            Cancel
          </button>
          <button 
            onClick={() => onDeny(reason)}
            disabled={processing}
            className="px-6 py-2 rounded-xl bg-red-600 text-white font-semibold disabled:opacity-50"
          >
            {processing ? 'Processing...' : `Deny ${count} Registrations`}
          </button>
        </div>
      </div>
    </div>
  )
}

// ============================================
// PLAYER DETAIL/EDIT MODAL
// ============================================
function PlayerDetailModal({ player, editMode, onClose, onUpdate, showToast }) {
  const reg = player.registrations?.[0]
  const [isEditing, setIsEditing] = useState(editMode)
  const [saving, setSaving] = useState(false)
  const [form, setForm] = useState({
    first_name: player.first_name || '',
    last_name: player.last_name || '',
    birth_date: player.birth_date || player.dob || '',
    grade: player.grade || '',
    gender: player.gender || '',
    school: player.school || '',
    experience_level: player.experience_level || player.experience || '',
    parent_name: player.parent_name || '',
    parent_email: player.parent_email || '',
    parent_phone: player.parent_phone || '',
    address: player.address || '',
    parent_2_name: player.parent_2_name || '',
    parent_2_email: player.parent_2_email || '',
    parent_2_phone: player.parent_2_phone || '',
    emergency_contact_name: player.emergency_contact_name || player.emergency_name || '',
    emergency_contact_phone: player.emergency_contact_phone || player.emergency_phone || '',
    emergency_contact_relation: player.emergency_contact_relation || player.emergency_relation || '',
    medical_conditions: player.medical_conditions || '',
    allergies: player.allergies || '',
    medications: player.medications || '',
    jersey_number: player.jersey_number || '',
    jersey_size: player.jersey_size || '',
    notes: player.notes || '',
  })

  async function handleSave() {
    setSaving(true)
    try {
      const { error } = await supabase
        .from('players')
        .update({
          ...form,
          updated_at: new Date().toISOString()
        })
        .eq('id', player.id)

      if (error) throw error
      showToast('Player updated successfully!', 'success')
      onUpdate()
    } catch (err) {
      showToast('Error saving: ' + err.message, 'error')
    }
    setSaving(false)
  }

  return (
    <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50">
      <div className="bg-slate-800 border border-slate-700 rounded-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
        <div className="p-6 border-b border-slate-700 flex items-center justify-between sticky top-0 bg-slate-800">
          <div>
            <h2 className="text-xl font-semibold text-white">
              {isEditing ? 'Edit Player' : 'Player Details'}
            </h2>
            <p className="text-sm text-slate-400">{player.first_name} {player.last_name}</p>
          </div>
          <div className="flex items-center gap-2">
            {!isEditing && (
              <button onClick={() => setIsEditing(true)} className="px-4 py-2 bg-blue-500/20 text-blue-400 rounded-lg hover:bg-blue-500/30 flex items-center gap-2">
                <Edit className="w-4 h-4" /> Edit
              </button>
            )}
            <button onClick={onClose} className="text-slate-400 hover:text-white text-2xl">√ó</button>
          </div>
        </div>
        
        <div className="p-6 space-y-6">
          {/* Player Info */}
          <div>
            <h3 className="text-sm font-medium text-slate-400 mb-3">Player Information</h3>
            {isEditing ? (
              <div className="grid grid-cols-2 gap-4">
                <EditField label="First Name" value={form.first_name} onChange={v => setForm({...form, first_name: v})} />
                <EditField label="Last Name" value={form.last_name} onChange={v => setForm({...form, last_name: v})} />
                <EditField label="Date of Birth" value={form.birth_date} onChange={v => setForm({...form, birth_date: v})} type="date" />
                <EditField label="Grade" value={form.grade} onChange={v => setForm({...form, grade: v})} type="number" />
                <EditField label="Gender" value={form.gender} onChange={v => setForm({...form, gender: v})} options={['Male', 'Female', 'Other']} />
                <EditField label="School" value={form.school} onChange={v => setForm({...form, school: v})} />
                <EditField label="Experience" value={form.experience_level} onChange={v => setForm({...form, experience_level: v})} options={['Beginner', 'Intermediate', 'Advanced']} />
                <EditField label="Jersey Number" value={form.jersey_number} onChange={v => setForm({...form, jersey_number: v})} type="number" />
                <EditField label="Jersey Size" value={form.jersey_size} onChange={v => setForm({...form, jersey_size: v})} options={['YS', 'YM', 'YL', 'AS', 'AM', 'AL', 'AXL']} />
              </div>
            ) : (
              <div className="grid grid-cols-2 gap-4">
                <InfoRow label="Name" value={`${player.first_name} ${player.last_name}`} />
                <InfoRow label="DOB" value={player.birth_date || player.dob || 'N/A'} />
                <InfoRow label="Grade" value={player.grade || 'N/A'} />
                <InfoRow label="Gender" value={player.gender || 'N/A'} />
                <InfoRow label="School" value={player.school || 'N/A'} />
                <InfoRow label="Experience" value={player.experience_level || player.experience || 'N/A'} />
                <InfoRow label="Jersey #" value={player.jersey_number || 'N/A'} />
                <InfoRow label="Jersey Prefs" value={[player.jersey_pref_1, player.jersey_pref_2, player.jersey_pref_3].filter(Boolean).join(', ') || 'N/A'} />
                <InfoRow label="Jersey Size" value={player.jersey_size || 'N/A'} />
              </div>
            )}
          </div>

          {/* Parent Info */}
          <div>
            <h3 className="text-sm font-medium text-slate-400 mb-3">Parent/Guardian</h3>
            {isEditing ? (
              <div className="grid grid-cols-2 gap-4">
                <EditField label="Parent Name" value={form.parent_name} onChange={v => setForm({...form, parent_name: v})} />
                <EditField label="Parent Email" value={form.parent_email} onChange={v => setForm({...form, parent_email: v})} type="email" />
                <EditField label="Parent Phone" value={form.parent_phone} onChange={v => setForm({...form, parent_phone: v})} type="tel" />
                <EditField label="Address" value={form.address} onChange={v => setForm({...form, address: v})} />
                <EditField label="Parent 2 Name" value={form.parent_2_name} onChange={v => setForm({...form, parent_2_name: v})} />
                <EditField label="Parent 2 Phone" value={form.parent_2_phone} onChange={v => setForm({...form, parent_2_phone: v})} type="tel" />
              </div>
            ) : (
              <div className="grid grid-cols-2 gap-4">
                <InfoRow label="Name" value={player.parent_name || 'N/A'} />
                <InfoRow label="Email" value={player.parent_email || 'N/A'} />
                <InfoRow label="Phone" value={player.parent_phone || 'N/A'} />
                <InfoRow label="Address" value={player.address || 'N/A'} />
                {player.parent_2_name && <InfoRow label="Parent 2" value={player.parent_2_name} />}
                {player.parent_2_phone && <InfoRow label="Parent 2 Phone" value={player.parent_2_phone} />}
              </div>
            )}
          </div>

          {/* Emergency Contact */}
          <div>
            <h3 className="text-sm font-medium text-slate-400 mb-3">Emergency Contact</h3>
            {isEditing ? (
              <div className="grid grid-cols-3 gap-4">
                <EditField label="Name" value={form.emergency_contact_name} onChange={v => setForm({...form, emergency_contact_name: v})} />
                <EditField label="Phone" value={form.emergency_contact_phone} onChange={v => setForm({...form, emergency_contact_phone: v})} type="tel" />
                <EditField label="Relation" value={form.emergency_contact_relation} onChange={v => setForm({...form, emergency_contact_relation: v})} />
              </div>
            ) : (
              <div className="grid grid-cols-3 gap-4">
                <InfoRow label="Name" value={player.emergency_contact_name || player.emergency_name || 'N/A'} />
                <InfoRow label="Phone" value={player.emergency_contact_phone || player.emergency_phone || 'N/A'} />
                <InfoRow label="Relation" value={player.emergency_contact_relation || player.emergency_relation || 'N/A'} />
              </div>
            )}
          </div>

          {/* Medical */}
          <div>
            <h3 className="text-sm font-medium text-slate-400 mb-3">Medical Information</h3>
            {isEditing ? (
              <div className="grid grid-cols-1 gap-4">
                <EditField label="Medical Conditions" value={form.medical_conditions} onChange={v => setForm({...form, medical_conditions: v})} multiline />
                <EditField label="Allergies" value={form.allergies} onChange={v => setForm({...form, allergies: v})} multiline />
                <EditField label="Medications" value={form.medications} onChange={v => setForm({...form, medications: v})} multiline />
              </div>
            ) : (
              <div className="space-y-2">
                <InfoRow label="Conditions" value={player.medical_conditions || 'None'} />
                <InfoRow label="Allergies" value={player.allergies || 'None'} />
                <InfoRow label="Medications" value={player.medications || 'None'} />
              </div>
            )}
          </div>

          {/* Waivers (view only) */}
          {!isEditing && (
            <div>
              <h3 className="text-sm font-medium text-slate-400 mb-3">Waivers</h3>
              <div className="flex gap-4">
                <WaiverBadge label="Liability" signed={player.waiver_liability} />
                <WaiverBadge label="Photo" signed={player.waiver_photo} />
                <WaiverBadge label="Conduct" signed={player.waiver_conduct} />
              </div>
              {player.waiver_signed_by && (
                <p className="text-xs text-slate-500 mt-2">
                  Signed by {player.waiver_signed_by} on {player.waiver_signed_date ? new Date(player.waiver_signed_date).toLocaleDateString() : 'N/A'}
                </p>
              )}
            </div>
          )}

          {/* Notes */}
          {isEditing && (
            <div>
              <h3 className="text-sm font-medium text-slate-400 mb-3">Admin Notes</h3>
              <EditField label="Notes" value={form.notes} onChange={v => setForm({...form, notes: v})} multiline />
            </div>
          )}

          {/* Registration Status (view only) */}
          {!isEditing && (
            <div>
              <h3 className="text-sm font-medium text-slate-400 mb-3">Registration Status</h3>
              <div className="flex items-center gap-4">
                <span className={`px-3 py-1 rounded-full text-sm font-medium ${
                  reg?.status === 'submitted' ? 'bg-[var(--accent-primary)]/20 text-[var(--accent-primary)]' :
                  reg?.status === 'approved' ? 'bg-blue-500/20 text-blue-400' :
                  reg?.status === 'rostered' ? 'bg-emerald-500/20 text-emerald-400' :
                  reg?.status === 'withdrawn' ? 'bg-red-500/20 text-red-400' :
                  'bg-gray-500/20 text-slate-400'
                }`}>{reg?.status || 'unknown'}</span>
                <span className="text-xs text-slate-500">
                  Submitted {reg?.submitted_at ? new Date(reg.submitted_at).toLocaleDateString() : 'N/A'}
                </span>
              </div>
              {reg?.denial_reason && (
                <p className="text-sm text-red-400 mt-2">Denial Reason: {reg.denial_reason}</p>
              )}
            </div>
          )}
        </div>

        <div className="p-6 border-t border-slate-700 flex justify-end gap-3 sticky bottom-0 bg-slate-800">
          {isEditing ? (
            <>
              <button onClick={() => setIsEditing(false)} className="px-6 py-2 rounded-xl border border-slate-700 text-white">
                Cancel
              </button>
              <button onClick={handleSave} disabled={saving} className="px-6 py-2 rounded-xl bg-[var(--accent-primary)] text-white font-semibold disabled:opacity-50">
                {saving ? 'Saving...' : 'Save Changes'}
              </button>
            </>
          ) : (
            <button onClick={onClose} className="px-6 py-2 rounded-xl bg-slate-700 text-white hover:bg-slate-600">
              Close
            </button>
          )}
        </div>
      </div>
    </div>
  )
}

function EditField({ label, value, onChange, type = 'text', options, multiline }) {
  if (options) {
    return (
      <div>
        <label className="block text-xs text-slate-500 mb-1">{label}</label>
        <select value={value} onChange={e => onChange(e.target.value)}
          className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm">
          <option value="">Select...</option>
          {options.map(o => <option key={o} value={o}>{o}</option>)}
        </select>
      </div>
    )
  }
  if (multiline) {
    return (
      <div>
        <label className="block text-xs text-slate-500 mb-1">{label}</label>
        <textarea value={value} onChange={e => onChange(e.target.value)}
          className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm min-h-[80px]" />
      </div>
    )
  }
  return (
    <div>
      <label className="block text-xs text-slate-500 mb-1">{label}</label>
      <input type={type} value={value} onChange={e => onChange(e.target.value)}
        className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm" />
    </div>
  )
}

// ============================================
// DENY REGISTRATION MODAL
// ============================================
function DenyRegistrationModal({ player, onClose, onDeny }) {
  const [reason, setReason] = useState('')

  return (
    <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50">
      <div className="bg-slate-800 border border-slate-700 rounded-2xl w-full max-w-md">
        <div className="p-6 border-b border-slate-700">
          <h2 className="text-xl font-semibold text-white">Deny Registration</h2>
          <p className="text-slate-400 text-sm mt-1">{player.first_name} {player.last_name}</p>
        </div>
        <div className="p-6">
          <label className="block text-sm text-slate-400 mb-2">Reason for denial (optional)</label>
          <textarea 
            value={reason} 
            onChange={e => setReason(e.target.value)}
            placeholder="Enter reason..."
            className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white min-h-[100px]"
          />
        </div>
        <div className="p-6 border-t border-slate-700 flex justify-end gap-3">
          <button onClick={onClose} className="px-6 py-2 rounded-xl border border-slate-700 text-white">
            Cancel
          </button>
          <button onClick={() => onDeny(reason)} className="px-6 py-2 rounded-xl bg-red-500 text-white font-semibold">
            Deny Registration
          </button>
        </div>
      </div>
    </div>
  )
}

function InfoRow({ label, value }) {
  return (
    <div className="bg-slate-900 rounded-lg p-3">
      <p className="text-xs text-slate-500">{label}</p>
      <p className="text-white text-sm mt-1">{value}</p>
    </div>
  )
}

function WaiverBadge({ label, signed }) {
  return (
    <div className={`px-3 py-2 rounded-lg ${signed ? 'bg-emerald-500/20' : 'bg-red-500/20'}`}>
      <p className={`text-xs font-medium ${signed ? 'text-emerald-400' : 'text-red-400'}`}>
        {signed ? '‚úì' : '‚úó'} {label}
      </p>
    </div>
  )
}

function calculateAge(birthDate) {
  if (!birthDate) return 'N/A'
  const today = new Date()
  const birth = new Date(birthDate)
  let age = today.getFullYear() - birth.getFullYear()
  const m = today.getMonth() - birth.getMonth()
  if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--
  return age
}

// ============================================
// PAYMENTS PAGE
// ============================================
function PaymentsPage({ showToast }) {
  const { selectedSeason } = useSeason()
  const tc = useThemeClasses()
  const [payments, setPayments] = useState([])
  const [players, setPlayers] = useState([])
  const [statusFilter, setStatusFilter] = useState('all')
  const [viewMode, setViewMode] = useState('individual') // 'individual' or 'family'
  const [loading, setLoading] = useState(true)
  const [showAddModal, setShowAddModal] = useState(false)
  const [selectedPlayer, setSelectedPlayer] = useState(null)
  const [showMarkPaidModal, setShowMarkPaidModal] = useState(null)
  const [backfillLoading, setBackfillLoading] = useState(false)
  const [showEmailModal, setShowEmailModal] = useState(null)

  useEffect(() => {
    if (selectedSeason?.id) {
      loadPayments()
      loadPlayers()
    }
  }, [selectedSeason?.id, statusFilter])

  async function loadPlayers() {
    const { data } = await supabase
      .from('players')
      .select('id, first_name, last_name, photo_url, position, grade, jersey_number, parent_email, parent_name')
      .eq('season_id', selectedSeason.id)
    setPlayers(data || [])
  }

  async function loadPayments() {
    if (!selectedSeason?.id) return
    setLoading(true)
    let query = supabase
      .from('payments')
      .select('*, players(id, first_name, last_name, parent_name, parent_email, photo_url, position, grade, jersey_number)')
      .eq('season_id', selectedSeason.id)
      .order('created_at', { ascending: false })
    
    if (statusFilter === 'paid') query = query.eq('paid', true)
    else if (statusFilter === 'unpaid') query = query.eq('paid', false)
    
    const { data } = await query
    setPayments(data || [])
    setLoading(false)
  }

  async function markAsPaidWithDetails(paymentId, details) {
    await supabase.from('payments').update({ 
      paid: true, 
      paid_date: details.paid_date || new Date().toISOString().split('T')[0],
      payment_method: details.payment_method,
      reference_number: details.reference_number,
      status: 'verified',
      verified_at: new Date().toISOString(),
      notes: details.notes || null
    }).eq('id', paymentId)
    showToast('Payment marked as paid', 'success')
    setShowMarkPaidModal(null)
    loadPayments()
  }

  async function markAsUnpaid(paymentId) {
    await supabase.from('payments').update({ 
      paid: false, 
      paid_date: null,
      reference_number: null,
      status: 'pending'
    }).eq('id', paymentId)
    showToast('Payment marked as unpaid', 'success')
    loadPayments()
  }

  async function addPayment(paymentData) {
    try {
      // Get player's parent email for family tracking
      const player = players.find(p => p.id === paymentData.player_id)
      await supabase.from('payments').insert({
        ...paymentData,
        season_id: selectedSeason.id,
        family_email: player?.parent_email?.toLowerCase(),
        auto_generated: false,
        created_at: new Date().toISOString()
      })
      showToast('Payment added!', 'success')
      setShowAddModal(false)
      loadPayments()
    } catch (err) {
      showToast('Error: ' + err.message, 'error')
    }
  }

  async function handleBackfillFees() {
    if (!selectedSeason) return
    setBackfillLoading(true)
    const result = await generateFeesForExistingPlayers(supabase, selectedSeason.id, showToast)
    setBackfillLoading(false)
    if (result.success) {
      loadPayments()
    }
  }

  // Group payments by family for family view
  const familyGroups = payments.reduce((acc, payment) => {
    const email = payment.family_email || payment.players?.parent_email || 'unknown'
    if (!acc[email]) {
      acc[email] = {
        email,
        parentName: payment.players?.parent_name || 'Unknown',
        payments: [],
        totalDue: 0,
        totalPaid: 0,
        players: new Set()
      }
    }
    acc[email].payments.push(payment)
    if (payment.paid) {
      acc[email].totalPaid += parseFloat(payment.amount) || 0
    } else {
      acc[email].totalDue += parseFloat(payment.amount) || 0
    }
    if (payment.players?.first_name) {
      acc[email].players.add(`${payment.players.first_name} ${payment.players.last_name}`)
    }
    return acc
  }, {})

  const families = Object.values(familyGroups).sort((a, b) => b.totalDue - a.totalDue)

  const totalOwed = payments.filter(p => !p.paid).reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0)
  const totalCollected = payments.filter(p => p.paid).reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0)
  const uniqueFamilies = new Set(payments.map(p => p.family_email || p.players?.parent_email)).size

  const csvColumns = [
    { label: 'Player First Name', accessor: p => p.players?.first_name },
    { label: 'Player Last Name', accessor: p => p.players?.last_name },
    { label: 'Parent', accessor: p => p.players?.parent_name || p.payer_name },
    { label: 'Parent Email', accessor: p => p.players?.parent_email || p.family_email },
    { label: 'Fee Type', accessor: p => p.fee_name || p.fee_type },
    { label: 'Fee Category', accessor: p => p.fee_category || 'per_player' },
    { label: 'Amount', accessor: p => p.amount },
    { label: 'Paid', accessor: p => p.paid ? 'Yes' : 'No' },
    { label: 'Paid Date', accessor: p => p.paid_date },
    { label: 'Method', accessor: p => p.payment_method },
    { label: 'Reference #', accessor: p => p.reference_number },
  ]

  if (!selectedSeason) {
    return (
      <div className="flex items-center justify-center h-64">
        <p className={tc.textSecondary}>Please select a season from the sidebar</p>
      </div>
    )
  }

  return (
    <div className="space-y-6">
      <div className="flex items-start justify-between">
        <div>
          <h1 className={`text-3xl font-bold ${tc.text}`}>Payments</h1>
          <p className={`${tc.textSecondary} mt-1`}>Track and manage payment status ‚Ä¢ {selectedSeason.name}</p>
        </div>
        <div className="flex gap-3">
          <button 
            onClick={handleBackfillFees}
            disabled={backfillLoading}
            className={`${tc.cardBg} border ${tc.border} ${tc.text} px-4 py-2 rounded-xl hover:brightness-110 flex items-center gap-2 ${backfillLoading ? 'opacity-50' : ''}`}
            title="Generate fees for approved players who don't have fees yet"
          >
            {backfillLoading ? '‚è≥' : 'üîÑ'} {backfillLoading ? 'Generating...' : 'Backfill Fees'}
          </button>
          <button 
            onClick={() => exportToCSV(payments, 'payments', csvColumns)}
            className={`${tc.cardBg} border ${tc.border} ${tc.text} px-4 py-2 rounded-xl hover:brightness-110 flex items-center gap-2`}
          >
            üì• Export CSV
          </button>
          <button 
            onClick={() => setShowAddModal(true)}
            className="bg-[var(--accent-primary)] text-white font-semibold px-4 py-2 rounded-xl hover:brightness-110"
          >
            ‚ûï Add Fee
          </button>
        </div>
      </div>

      {/* Summary Cards */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div className={`${tc.cardBg} border ${tc.border} rounded-2xl p-6`}>
          <p className={tc.textMuted}>Total Collected</p>
          <p className="text-3xl font-bold text-emerald-400 mt-1">${totalCollected.toFixed(2)}</p>
        </div>
        <div className={`${tc.cardBg} border ${tc.border} rounded-2xl p-6`}>
          <p className={tc.textMuted}>Outstanding</p>
          <p className="text-3xl font-bold text-red-400 mt-1">${totalOwed.toFixed(2)}</p>
        </div>
        <div className={`${tc.cardBg} border ${tc.border} rounded-2xl p-6`}>
          <p className={tc.textMuted}>Collection Rate</p>
          <p className="text-3xl font-bold text-[var(--accent-primary)] mt-1">
            {payments.length > 0 ? Math.round((payments.filter(p => p.paid).length / payments.length) * 100) : 0}%
          </p>
        </div>
        <div className={`${tc.cardBg} border ${tc.border} rounded-2xl p-6`}>
          <p className={tc.textMuted}>Families</p>
          <p className={`text-3xl font-bold ${tc.text} mt-1`}>{uniqueFamilies}</p>
        </div>
      </div>

      {/* Filters and View Toggle */}
      <div className="flex justify-between items-center">
        <div className="flex gap-4">
          <div className={`flex ${tc.cardBg} rounded-xl p-1 border ${tc.border}`}>
            {['all', 'unpaid', 'paid'].map(f => (
              <button key={f} onClick={() => setStatusFilter(f)}
                className={`px-4 py-2 rounded-lg text-sm font-medium transition capitalize ${
                  statusFilter === f ? 'bg-[var(--accent-primary)] text-white' : `${tc.textMuted} hover:${tc.text}`
                }`}>{f}</button>
            ))}
          </div>
        </div>
        <div className={`flex ${tc.cardBg} rounded-xl p-1 border ${tc.border}`}>
          <button 
            onClick={() => setViewMode('individual')}
            className={`px-4 py-2 rounded-lg text-sm font-medium transition ${
              viewMode === 'individual' ? 'bg-[var(--accent-primary)] text-white' : `${tc.textMuted} hover:${tc.text}`
            }`}
          >
            Individual
          </button>
          <button 
            onClick={() => setViewMode('family')}
            className={`px-4 py-2 rounded-lg text-sm font-medium transition ${
              viewMode === 'family' ? 'bg-[var(--accent-primary)] text-white' : `${tc.textMuted} hover:${tc.text}`
            }`}
          >
            Family
          </button>
        </div>
      </div>

      {/* Content */}
      {loading ? (
        <div className={`text-center py-12 ${tc.textSecondary}`}>Loading payments...</div>
      ) : payments.length === 0 ? (
        <div className={`${tc.cardBg} border ${tc.border} rounded-2xl p-12 text-center`}>
          <DollarSign className="w-16 h-16" />
          <h3 className={`text-lg font-medium ${tc.text} mt-4`}>No payments found</h3>
          <p className={`${tc.textMuted} mt-2`}>Fees are automatically generated when registrations are approved.</p>
          <button 
            onClick={handleBackfillFees}
            className="mt-4 bg-[var(--accent-primary)] text-white px-6 py-2 rounded-xl"
          >
            Generate Fees for Existing Players
          </button>
        </div>
      ) : viewMode === 'family' ? (
        /* Family View */
        <div className="space-y-4">
          {families.map(family => (
            <div key={family.email} className={`${tc.cardBg} border ${tc.border} rounded-2xl overflow-hidden`}>
              <div className={`p-4 border-b ${tc.border} flex justify-between items-center`}>
                <div>
                  <p className={`font-semibold ${tc.text}`}>{family.parentName}</p>
                  <p className={`text-sm ${tc.textMuted}`}>{family.email}</p>
                  <p className={`text-xs ${tc.textMuted} mt-1`}>Players: {[...family.players].join(', ')}</p>
                </div>
                <div className="text-right">
                  {family.totalDue > 0 ? (
                    <p className="text-xl font-bold text-red-400">${family.totalDue.toFixed(2)} due</p>
                  ) : (
                    <p className="text-xl font-bold text-emerald-400">Paid in full</p>
                  )}
                  <p className={`text-sm ${tc.textMuted}`}>${family.totalPaid.toFixed(2)} paid</p>
                  <button 
                    onClick={() => setShowEmailModal(family)}
                    className={`mt-2 text-xs px-3 py-1 rounded-lg ${tc.hoverBg} ${tc.textMuted}`}
                  >
                    üìß Generate Email
                  </button>
                </div>
              </div>
              <table className="w-full">
                <tbody>
                  {family.payments.map(payment => (
                    <tr key={payment.id} className={`border-b ${tc.border} last:border-0`}>
                      <td className="px-4 py-3">
                        <p className={tc.text}>{payment.players?.first_name || 'Family'}</p>
                        <p className={`text-xs ${tc.textMuted}`}>{payment.fee_name || payment.fee_type}</p>
                      </td>
                      <td className="px-4 py-3 text-right">
                        <p className={`font-medium ${tc.text}`}>${parseFloat(payment.amount || 0).toFixed(2)}</p>
                      </td>
                      <td className="px-4 py-3 text-right">
                        <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                          payment.paid ? 'bg-emerald-500/20 text-emerald-400' : 'bg-red-500/20 text-red-400'
                        }`}>
                          {payment.paid ? 'Paid' : 'Unpaid'}
                        </span>
                      </td>
                      <td className="px-4 py-3 text-right">
                        {payment.paid ? (
                          <button onClick={() => markAsUnpaid(payment.id)} className={`px-3 py-1 rounded-lg text-xs ${tc.textMuted} ${tc.hoverBg}`}>
                            Undo
                          </button>
                        ) : (
                          <button onClick={() => setShowMarkPaidModal(payment)} className="px-3 py-1 bg-emerald-500/20 rounded-lg text-xs text-emerald-400 hover:bg-emerald-500/30">
                            Mark Paid
                          </button>
                        )}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          ))}
        </div>
      ) : (
        /* Individual View (Original Table) */
        <div className={`${tc.cardBg} border ${tc.border} rounded-2xl overflow-hidden`}>
          <table className="w-full">
            <thead>
              <tr className={`border-b ${tc.border}`}>
                <th className={`text-left px-6 py-4 text-sm font-medium ${tc.textMuted}`}>Player</th>
                <th className={`text-left px-6 py-4 text-sm font-medium ${tc.textMuted}`}>Parent</th>
                <th className={`text-left px-6 py-4 text-sm font-medium ${tc.textMuted}`}>Fee Type</th>
                <th className={`text-left px-6 py-4 text-sm font-medium ${tc.textMuted}`}>Amount</th>
                <th className={`text-left px-6 py-4 text-sm font-medium ${tc.textMuted}`}>Status</th>
                <th className={`text-left px-6 py-4 text-sm font-medium ${tc.textMuted}`}>Actions</th>
              </tr>
            </thead>
            <tbody>
              {payments.map(payment => (
                <tr key={payment.id} className={`border-b ${tc.border} ${tc.hoverBg}`}>
                  <td className="px-6 py-4">
                    <ClickablePlayerName 
                      player={payment.players}
                      onPlayerSelect={setSelectedPlayer}
                      className={`font-medium ${tc.text}`}
                    />
                  </td>
                  <td className="px-6 py-4">
                    <p className={tc.textSecondary}>{payment.players?.parent_name || payment.payer_name || 'N/A'}</p>
                    <p className={`text-xs ${tc.textMuted}`}>{payment.players?.parent_email}</p>
                  </td>
                  <td className="px-6 py-4">
                    <p className={tc.text}>{payment.fee_name || payment.fee_type || 'N/A'}</p>
                    {payment.fee_category === 'per_family' && (
                      <span className="text-xs bg-blue-500/20 text-blue-400 px-2 py-0.5 rounded-full">Family</span>
                    )}
                  </td>
                  <td className="px-6 py-4">
                    <p className={`${tc.text} font-medium`}>${parseFloat(payment.amount || 0).toFixed(2)}</p>
                  </td>
                  <td className="px-6 py-4">
                    <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                      payment.paid ? 'bg-emerald-500/20 text-emerald-400' : 'bg-red-500/20 text-red-400'
                    }`}>
                      {payment.paid ? 'Paid' : 'Unpaid'}
                    </span>
                    {payment.paid_date && (
                      <p className={`text-xs ${tc.textMuted} mt-1`}>{new Date(payment.paid_date).toLocaleDateString()}</p>
                    )}
                    {payment.reference_number && (
                      <p className={`text-xs ${tc.textMuted}`}>Ref: {payment.reference_number}</p>
                    )}
                  </td>
                  <td className="px-6 py-4">
                    {payment.paid ? (
                      <button onClick={() => markAsUnpaid(payment.id)} className={`px-3 py-1 rounded-lg text-xs ${tc.textMuted} ${tc.hoverBg}`}>
                        Mark Unpaid
                      </button>
                    ) : (
                      <button onClick={() => setShowMarkPaidModal(payment)} className="px-3 py-1 bg-emerald-500/20 rounded-lg text-xs text-emerald-400 hover:bg-emerald-500/30">
                        Mark Paid
                      </button>
                    )}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}

      {/* Add Payment Modal */}
      {showAddModal && (
        <AddPaymentModal 
          players={players}
          season={selectedSeason}
          onClose={() => setShowAddModal(false)}
          onAdd={addPayment}
        />
      )}

      {/* Mark Paid Modal */}
      {showMarkPaidModal && (
        <MarkPaidModal
          payment={showMarkPaidModal}
          onClose={() => setShowMarkPaidModal(null)}
          onConfirm={(details) => markAsPaidWithDetails(showMarkPaidModal.id, details)}
        />
      )}

      {/* Email Generation Modal */}
      {showEmailModal && (
        <EmailGeneratorModal
          family={showEmailModal}
          season={selectedSeason}
          onClose={() => setShowEmailModal(null)}
          showToast={showToast}
        />
      )}

      {/* Player Card Modal */}
      {selectedPlayer && (
        <PlayerCardExpanded
          player={selectedPlayer}
          visible={!!selectedPlayer}
          onClose={() => setSelectedPlayer(null)}
          context="payment"
        />
      )}
    </div>
  )
}

// ============================================
// MARK PAID MODAL - With reference number
// ============================================
function MarkPaidModal({ payment, onClose, onConfirm }) {
  const tc = useThemeClasses()
  const [details, setDetails] = useState({
    payment_method: '',
    reference_number: '',
    paid_date: new Date().toISOString().split('T')[0],
    notes: ''
  })

  return (
    <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50">
      <div className={`${tc.cardBg} border ${tc.border} rounded-2xl w-full max-w-md`}>
        <div className={`p-6 border-b ${tc.border}`}>
          <h2 className={`text-xl font-semibold ${tc.text}`}>Mark Payment as Paid</h2>
          <p className={`${tc.textMuted} text-sm mt-1`}>
            {payment.players?.first_name} {payment.players?.last_name} - {payment.fee_name || payment.fee_type} - ${payment.amount}
          </p>
        </div>
        <div className="p-6 space-y-4">
          <div>
            <label className={`block text-sm ${tc.textMuted} mb-2`}>Payment Method *</label>
            <select 
              value={details.payment_method} 
              onChange={e => setDetails({...details, payment_method: e.target.value})}
              className={`w-full ${tc.inputBg} border ${tc.border} rounded-xl px-4 py-3 ${tc.text}`}
            >
              <option value="">Select method...</option>
              <option value="venmo">Venmo</option>
              <option value="zelle">Zelle</option>
              <option value="cashapp">Cash App</option>
              <option value="cash">Cash</option>
              <option value="check">Check</option>
              <option value="stripe">Stripe</option>
              <option value="square">Square</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div>
            <label className={`block text-sm ${tc.textMuted} mb-2`}>Reference/Confirmation # (optional)</label>
            <input 
              type="text" 
              value={details.reference_number} 
              onChange={e => setDetails({...details, reference_number: e.target.value})}
              placeholder="e.g., Venmo ID, Check #, etc."
              className={`w-full ${tc.inputBg} border ${tc.border} rounded-xl px-4 py-3 ${tc.text}`}
            />
          </div>
          <div>
            <label className={`block text-sm ${tc.textMuted} mb-2`}>Payment Date</label>
            <input 
              type="date" 
              value={details.paid_date} 
              onChange={e => setDetails({...details, paid_date: e.target.value})}
              className={`w-full ${tc.inputBg} border ${tc.border} rounded-xl px-4 py-3 ${tc.text}`}
            />
          </div>
          <div>
            <label className={`block text-sm ${tc.textMuted} mb-2`}>Notes (optional)</label>
            <textarea 
              value={details.notes} 
              onChange={e => setDetails({...details, notes: e.target.value})}
              placeholder="Any additional notes..."
              className={`w-full ${tc.inputBg} border ${tc.border} rounded-xl px-4 py-3 ${tc.text} min-h-[60px]`}
            />
          </div>
        </div>
        <div className={`p-6 border-t ${tc.border} flex justify-end gap-3`}>
          <button onClick={onClose} className={`px-6 py-2 rounded-xl border ${tc.border} ${tc.text}`}>
            Cancel
          </button>
          <button 
            onClick={() => onConfirm(details)}
            disabled={!details.payment_method}
            className="px-6 py-2 rounded-xl bg-emerald-600 text-white font-semibold disabled:opacity-50"
          >
            Confirm Payment
          </button>
        </div>
      </div>
    </div>
  )
}

// ============================================
// EMAIL GENERATOR MODAL
// ============================================
function EmailGeneratorModal({ family, season, onClose, showToast }) {
  const tc = useThemeClasses()
  const { organization } = useAuth()
  const [emailType, setEmailType] = useState(family.totalDue > 0 ? 'payment_reminder' : 'registration_confirmation')
  
  // Find a player from this family for email generation
  const familyPayment = family.payments[0]
  const player = familyPayment?.players
  const unpaidFees = family.payments.filter(p => !p.paid)
  
  const emailContent = generateEmailContent(emailType, {
    player: { ...player, parent_name: family.parentName },
    season,
    organization,
    fees: emailType === 'payment_reminder' ? unpaidFees : family.payments,
    totalDue: family.totalDue
  })

  function copyToClipboard() {
    const fullEmail = `To: ${family.email}\nSubject: ${emailContent.subject}\n\n${emailContent.body}`
    navigator.clipboard.writeText(fullEmail)
    showToast('Email copied to clipboard!', 'success')
  }

  function openInGmail() {
    const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(family.email)}&su=${encodeURIComponent(emailContent.subject)}&body=${encodeURIComponent(emailContent.body)}`
    window.open(gmailUrl, '_blank')
  }

  return (
    <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50">
      <div className={`${tc.cardBg} border ${tc.border} rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col`}>
        <div className={`p-6 border-b ${tc.border}`}>
          <h2 className={`text-xl font-semibold ${tc.text}`}>Generate Email</h2>
          <p className={`${tc.textMuted} text-sm mt-1`}>To: {family.parentName} ({family.email})</p>
        </div>
        
        <div className="p-6 space-y-4 overflow-auto flex-1">
          {/* Email Type Selector */}
          <div>
            <label className={`block text-sm ${tc.textMuted} mb-2`}>Email Type</label>
            <div className="flex gap-2">
              <button
                onClick={() => setEmailType('registration_confirmation')}
                className={`px-4 py-2 rounded-xl text-sm ${emailType === 'registration_confirmation' ? 'bg-[var(--accent-primary)] text-white' : `${tc.cardBgAlt} ${tc.text}`}`}
              >
                ‚úÖ Confirmation
              </button>
              <button
                onClick={() => setEmailType('payment_reminder')}
                className={`px-4 py-2 rounded-xl text-sm ${emailType === 'payment_reminder' ? 'bg-[var(--accent-primary)] text-white' : `${tc.cardBgAlt} ${tc.text}`}`}
              >
                üí∞ Payment Reminder
              </button>
            </div>
          </div>

          {/* Preview */}
          <div>
            <label className={`block text-sm ${tc.textMuted} mb-2`}>Subject</label>
            <div className={`${tc.cardBgAlt} rounded-xl px-4 py-3 ${tc.text}`}>
              {emailContent.subject}
            </div>
          </div>
          
          <div>
            <label className={`block text-sm ${tc.textMuted} mb-2`}>Body</label>
            <pre className={`${tc.cardBgAlt} rounded-xl px-4 py-3 ${tc.text} text-sm whitespace-pre-wrap font-sans max-h-[300px] overflow-auto`}>
              {emailContent.body}
            </pre>
          </div>
        </div>
        
        <div className={`p-6 border-t ${tc.border} flex justify-between`}>
          <button onClick={onClose} className={`px-6 py-2 rounded-xl border ${tc.border} ${tc.text}`}>
            Close
          </button>
          <div className="flex gap-3">
            <button 
              onClick={copyToClipboard}
              className={`px-6 py-2 rounded-xl ${tc.cardBgAlt} ${tc.text} flex items-center gap-2`}
            >
              <Copy className="w-4 h-4" /> Copy
            </button>
            <button 
              onClick={openInGmail}
              className="px-6 py-2 rounded-xl bg-[var(--accent-primary)] text-white font-semibold flex items-center gap-2"
            >
              <Mail className="w-4 h-4" /> Open in Gmail
            </button>
          </div>
        </div>
      </div>
    </div>
  )
}

// ============================================
// ADD PAYMENT MODAL
// ============================================
function AddPaymentModal({ players, season, onClose, onAdd }) {
  const tc = useThemeClasses()
  const [form, setForm] = useState({
    player_id: '',
    fee_type: 'registration',
    fee_name: '',
    fee_category: 'per_player',
    amount: '',
    payment_method: '',
    paid: false,
    notes: ''
  })

  const feeTypes = [
    { value: 'registration', label: 'Registration', amount: season.fee_registration || 0, category: 'per_player' },
    { value: 'uniform', label: 'Uniform', amount: season.fee_uniform || 0, category: 'per_player' },
    { value: 'monthly', label: 'Monthly', amount: season.fee_monthly || 0, category: 'per_player' },
    { value: 'family', label: 'Family Fee', amount: season.fee_per_family || 0, category: 'per_family' },
    { value: 'other', label: 'Other', amount: '', category: 'per_player' },
  ]

  useEffect(() => {
    const feeInfo = feeTypes.find(f => f.value === form.fee_type)
    if (feeInfo && form.fee_type !== 'other') {
      setForm(prev => ({ 
        ...prev, 
        fee_name: feeInfo.label,
        fee_category: feeInfo.category,
        amount: feeInfo.amount 
      }))
    }
  }, [form.fee_type])

  function handleSubmit() {
    if (!form.player_id || !form.amount) {
      alert('Please select a player and enter an amount')
      return
    }
    onAdd({
      ...form,
      amount: parseFloat(form.amount),
      paid_date: form.paid ? new Date().toISOString().split('T')[0] : null
    })
  }

  return (
    <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50">
      <div className={`${tc.cardBg} border ${tc.border} rounded-2xl w-full max-w-md`}>
        <div className={`p-6 border-b ${tc.border}`}>
          <h2 className={`text-xl font-semibold ${tc.text}`}>Add Fee</h2>
        </div>
        <div className="p-6 space-y-4">
          <div>
            <label className={`block text-sm ${tc.textMuted} mb-2`}>Player</label>
            <select value={form.player_id} onChange={e => setForm({...form, player_id: e.target.value})}
              className={`w-full ${tc.inputBg} border ${tc.border} rounded-xl px-4 py-3 ${tc.text}`}>
              <option value="">Select player...</option>
              {players.map(p => (
                <option key={p.id} value={p.id}>{p.first_name} {p.last_name}</option>
              ))}
            </select>
          </div>
          <div>
            <label className={`block text-sm ${tc.textMuted} mb-2`}>Fee Type</label>
            <select value={form.fee_type} onChange={e => setForm({...form, fee_type: e.target.value})}
              className={`w-full ${tc.inputBg} border ${tc.border} rounded-xl px-4 py-3 ${tc.text}`}>
              {feeTypes.filter(f => f.amount > 0 || f.value === 'other').map(f => (
                <option key={f.value} value={f.value}>
                  {f.label} {f.amount ? `($${f.amount})` : ''} {f.category === 'per_family' ? '(per family)' : ''}
                </option>
              ))}
            </select>
            {form.fee_type === 'family' && (
              <p className={`text-xs ${tc.textMuted} mt-1`}>Family fees are charged once per family per season</p>
            )}
          </div>
          {form.fee_type === 'other' && (
            <div>
              <label className={`block text-sm ${tc.textMuted} mb-2`}>Fee Name</label>
              <input type="text" value={form.fee_name} onChange={e => setForm({...form, fee_name: e.target.value})}
                placeholder="e.g., Tournament Fee"
                className={`w-full ${tc.inputBg} border ${tc.border} rounded-xl px-4 py-3 ${tc.text}`} />
            </div>
          )}
          <div>
            <label className={`block text-sm ${tc.textMuted} mb-2`}>Amount</label>
            <input type="number" value={form.amount} onChange={e => setForm({...form, amount: e.target.value})}
              className={`w-full ${tc.inputBg} border ${tc.border} rounded-xl px-4 py-3 ${tc.text}`} />
          </div>
          <div>
            <label className={`block text-sm ${tc.textMuted} mb-2`}>Payment Method (if paid)</label>
            <select value={form.payment_method} onChange={e => setForm({...form, payment_method: e.target.value})}
              className={`w-full ${tc.inputBg} border ${tc.border} rounded-xl px-4 py-3 ${tc.text}`}>
              <option value="">Select...</option>
              <option value="venmo">Venmo</option>
              <option value="zelle">Zelle</option>
              <option value="cashapp">Cash App</option>
              <option value="cash">Cash</option>
              <option value="check">Check</option>
              <option value="stripe">Stripe</option>
              <option value="square">Square</option>
              <option value="other">Other</option>
            </select>
          </div>
          <label className="flex items-center gap-3 cursor-pointer">
            <input type="checkbox" checked={form.paid} onChange={e => setForm({...form, paid: e.target.checked})}
              className="w-5 h-5 rounded" />
            <span className={tc.text}>Mark as already paid</span>
          </label>
          <div>
            <label className={`block text-sm ${tc.textMuted} mb-2`}>Notes (optional)</label>
            <textarea value={form.notes} onChange={e => setForm({...form, notes: e.target.value})}
              className={`w-full ${tc.inputBg} border ${tc.border} rounded-xl px-4 py-3 ${tc.text} min-h-[80px]`} />
          </div>
        </div>
        <div className={`p-6 border-t ${tc.border} flex justify-end gap-3`}>
          <button onClick={onClose} className={`px-6 py-2 rounded-xl border ${tc.border} ${tc.text}`}>
            Cancel
          </button>
          <button onClick={handleSubmit} className="px-6 py-2 rounded-xl bg-[var(--accent-primary)] text-white font-semibold">
            Add Fee
          </button>
        </div>
      </div>
    </div>
  )
}

// ============================================
// TEAMS PAGE
// ============================================
function TeamsPage({ showToast, navigateToTeamWall, onNavigate }) {
  const journey = useJourney()
  const { selectedSeason, seasons, loading: seasonLoading, selectSeason } = useSeason()
  const { user } = useAuth()
  const [teams, setTeams] = useState([])
  const [loading, setLoading] = useState(true)
  const [showNewTeamModal, setShowNewTeamModal] = useState(false)
  const [unrosteredPlayers, setUnrosteredPlayers] = useState([])
  
  // View controls
  const [viewMode, setViewMode] = useState('list') // 'list', 'cards', 'compact'
  const [showPhotos, setShowPhotos] = useState(true)
  const [selectedPlayer, setSelectedPlayer] = useState(null)
  const [expandedTeam, setExpandedTeam] = useState(null)

  useEffect(() => {
    if (selectedSeason?.id) {
      loadTeams()
      loadUnrosteredPlayers()
    }
  }, [selectedSeason?.id])

  async function loadTeams() {
    if (!selectedSeason?.id) return
    setLoading(true)
    const { data } = await supabase
      .from('teams')
      .select('*, team_players(*, players(id, first_name, last_name, jersey_number, position, photo_url, grade, status, uniform_size_jersey))')
      .eq('season_id', selectedSeason.id)
      .order('name')
    setTeams(data || [])
    setLoading(false)
  }

  async function loadUnrosteredPlayers() {
    if (!selectedSeason?.id) return
    const { data: allPlayers } = await supabase
      .from('players')
      .select('id, first_name, last_name, position, jersey_number, photo_url, grade')
      .eq('season_id', selectedSeason.id)
    
    const { data: rostered } = await supabase
      .from('team_players')
      .select('player_id, teams!inner(season_id)')
      .eq('teams.season_id', selectedSeason.id)
    
    const rosteredIds = new Set(rostered?.map(r => r.player_id) || [])
    setUnrosteredPlayers((allPlayers || []).filter(p => !rosteredIds.has(p.id)))
  }

  async function createTeam(formData) {
    try {
      // Create the team with all the new fields
      const { data: newTeam, error } = await supabase
        .from('teams')
        .insert({ 
          season_id: selectedSeason.id, 
          name: formData.name,
          abbreviation: formData.abbreviation || null,
          color: formData.color,
          logo_url: formData.logo_url || null,
          age_group: formData.age_group,
          age_group_type: formData.age_group_type,
          team_type: formData.team_type,
          skill_level: formData.skill_level,
          gender: formData.gender,
          max_roster_size: formData.max_roster_size,
          min_roster_size: formData.min_roster_size,
          roster_open: formData.roster_open,
          description: formData.description || null,
          internal_notes: formData.internal_notes || null
        })
        .select()
        .single()
      
      if (error) {
        console.error('Error creating team:', error)
        showToast('Error creating team: ' + error.message, 'error')
        return
      }
      
      const createdItems = ['team']
      
      // Auto-create team chat channel (if enabled)
      if (formData.create_team_chat) {
        const { error: chatError } = await supabase.from('chat_channels').insert({
          season_id: selectedSeason.id,
          team_id: newTeam.id,
          name: `${formData.name} - Team Chat`,
          description: 'Chat for parents and coaches',
          channel_type: 'team_chat',
          created_by: user?.id
        })
        if (chatError) {
          console.error('Error creating team chat:', chatError)
        } else {
          createdItems.push('team chat')
        }
      }
      
      // Auto-create player chat channel (if enabled)
      if (formData.create_player_chat) {
        const { error: playerChatError } = await supabase.from('chat_channels').insert({
          season_id: selectedSeason.id,
          team_id: newTeam.id,
          name: `${formData.name} - Player Chat`,
          description: 'Chat for players and coaches',
          channel_type: 'player_chat',
          created_by: user?.id
        })
        if (playerChatError) {
          console.error('Error creating player chat:', playerChatError)
        } else {
          createdItems.push('player chat')
        }
      }
      
      if (formData.create_team_wall) {
        createdItems.push('team wall')
      }
      
      showToast(`Created: ${createdItems.join(', ')}!`, 'success')
      journey?.completeStep('add_teams')
      setShowNewTeamModal(false)
      loadTeams()
    } catch (err) {
      console.error('Unexpected error creating team:', err)
      showToast('Unexpected error creating team', 'error')
      setShowNewTeamModal(false)
    }
  }

  async function deleteTeam(teamId) {
    if (!confirm('Delete this team? Players will be unrostered.')) return
    await supabase.from('team_players').delete().eq('team_id', teamId)
    await supabase.from('teams').delete().eq('id', teamId)
    showToast('Team deleted', 'success')
    loadTeams()
    loadUnrosteredPlayers()
  }

  async function addPlayerToTeam(teamId, playerId) {
    await supabase.from('team_players').insert({ team_id: teamId, player_id: playerId })
    
    // Auto-add player and parent to appropriate chat channels
    await autoAddMemberToTeamChannels(teamId, playerId)
    
    showToast('Player added to team', 'success')
    loadTeams()
    loadUnrosteredPlayers()
  }
  
  // Helper function to auto-add members to team chat channels
  async function autoAddMemberToTeamChannels(teamId, playerId) {
    try {
      // Get the player info to find parent
      const { data: player } = await supabase
        .from('players')
        .select('id, first_name, last_name, parent_account_id')
        .eq('id', playerId)
        .single()
      
      if (!player) return
      
      // Get team channels
      const { data: channels } = await supabase
        .from('chat_channels')
        .select('id, channel_type')
        .eq('team_id', teamId)
        .in('channel_type', ['team_chat', 'player_chat'])
      
      if (!channels || channels.length === 0) return
      
      // Add parent to team_chat channel (if they have an account)
      if (player.parent_account_id) {
        const teamChat = channels.find(c => c.channel_type === 'team_chat')
        if (teamChat) {
          // Check if already a member
          const { data: existing } = await supabase
            .from('channel_members')
            .select('id')
            .eq('channel_id', teamChat.id)
            .eq('user_id', player.parent_account_id)
            .maybeSingle()
          
          if (!existing) {
            await supabase.from('channel_members').insert({
              channel_id: teamChat.id,
              user_id: player.parent_account_id,
              display_name: `${player.first_name}'s Parent`,
              member_role: 'parent',
              can_post: true
            })
          }
        }
        
        // Add parent to player_chat as view-only
        const playerChat = channels.find(c => c.channel_type === 'player_chat')
        if (playerChat) {
          const { data: existing } = await supabase
            .from('channel_members')
            .select('id')
            .eq('channel_id', playerChat.id)
            .eq('user_id', player.parent_account_id)
            .maybeSingle()
          
          if (!existing) {
            await supabase.from('channel_members').insert({
              channel_id: playerChat.id,
              user_id: player.parent_account_id,
              display_name: `${player.first_name}'s Parent`,
              member_role: 'parent',
              can_post: false // Parents can't post in player chat
            })
          }
        }
      }
    } catch (err) {
      console.error('Error auto-adding member to channels:', err)
    }
  }

  async function removePlayerFromTeam(teamPlayerId) {
    await supabase.from('team_players').delete().eq('id', teamPlayerId)
    showToast('Player removed from team', 'success')
    loadTeams()
    loadUnrosteredPlayers()
  }

  const csvColumns = [
    { label: 'Team', accessor: t => t.name },
    { label: 'Color', accessor: t => t.color },
    { label: 'Player Count', accessor: t => t.team_players?.length || 0 },
  ]

  // If no season selected, show helpful state
  if (!selectedSeason) {
    // Still loading
    if (seasonLoading) {
      return (
        <div className="flex items-center justify-center h-64">
          <div className="flex flex-col items-center gap-3">
            <div className="w-8 h-8 border-2 border-t-transparent rounded-full animate-spin" style={{ borderColor: 'var(--accent-primary)', borderTopColor: 'transparent' }}></div>
            <span className="text-slate-400">Loading seasons...</span>
          </div>
        </div>
      )
    }

    // No seasons exist at all
    if (!seasons || seasons.length === 0) {
      return (
        <div className="flex items-center justify-center min-h-[60vh]">
          <div className="text-center max-w-md">
            <div className="w-20 h-20 rounded-full bg-slate-800 flex items-center justify-center mx-auto mb-6">
              <Calendar className="w-10 h-10 text-slate-400" />
            </div>
            <h2 className="text-2xl font-bold text-white mb-3">Create Your First Season</h2>
            <p className="text-slate-400 mb-6">
              Before you can create teams, you need to set up a season. Seasons help you organize your teams, players, and schedules.
            </p>
            <button
              onClick={() => onNavigate && onNavigate('seasons')}
              className="bg-[var(--accent-primary)] text-white font-semibold px-6 py-3 rounded-xl hover:brightness-110 transition"
            >
              ‚ûï Create First Season
            </button>
          </div>
        </div>
      )
    }

    // Seasons exist but none selected - auto-select the first one
    if (seasons.length > 0) {
      // Auto-select the first available season
      const activeSeason = seasons.find(s => s.status === 'active') || seasons[0]
      if (activeSeason) {
        selectSeason(activeSeason)
      }
      return (
        <div className="flex items-center justify-center h-64">
          <div className="text-center">
            <p className="text-slate-400 mb-4">Selecting season...</p>
            <select 
              value=""
              onChange={(e) => {
                const s = seasons.find(s => s.id === e.target.value)
                if (s) selectSeason(s)
              }}
              className="bg-slate-800 border border-slate-700 rounded-xl px-4 py-2 text-white"
            >
              <option value="">Choose a season...</option>
              {seasons.map(s => (
                <option key={s.id} value={s.id}>{s.name}</option>
              ))}
            </select>
          </div>
        </div>
      )
    }

    return (
      <div className="flex items-center justify-center h-64">
        <p className="text-slate-400">Please select a season from the sidebar</p>
      </div>
    )
  }

  return (
    <div className="space-y-6">
      <div className="flex items-start justify-between">
        <div>
          <h1 className="text-3xl font-bold text-white">Teams & Rosters</h1>
          <p className="text-slate-400 mt-1">Manage teams and assign players ‚Ä¢ {selectedSeason.name}</p>
        </div>
        <div className="flex gap-3">
          {/* View Controls */}
          <div className="flex bg-slate-800 rounded-xl p-1">
            {[
              { id: 'list', icon: '‚ò∞', label: 'List' },
              { id: 'cards', icon: '‚ñ¶', label: 'Cards' },
              { id: 'compact', icon: '‚ñ§', label: 'Compact' }
            ].map(v => (
              <button
                key={v.id}
                onClick={() => setViewMode(v.id)}
                className={`px-3 py-1.5 rounded-lg text-sm transition ${
                  viewMode === v.id ? 'bg-[var(--accent-primary)] text-white font-semibold' : 'text-slate-400 hover:text-white'
                }`}
                title={v.label}
              >
                {v.icon}
              </button>
            ))}
          </div>
          <button
            onClick={() => setShowPhotos(!showPhotos)}
            className={`px-3 py-2 rounded-xl text-sm transition ${
              showPhotos ? 'bg-slate-700 text-white' : 'bg-slate-800 text-slate-500'
            }`}
            title={showPhotos ? 'Hide Photos' : 'Show Photos'}
          >
            üì∑
          </button>
          <button 
            onClick={() => exportToCSV(teams, 'teams', csvColumns)}
            className="bg-slate-700 text-white px-4 py-2 rounded-xl hover:bg-slate-600 flex items-center gap-2"
          >
            üì• Export
          </button>
          <button onClick={() => setShowNewTeamModal(true)} className="bg-[var(--accent-primary)] text-white font-semibold px-4 py-2 rounded-xl hover:brightness-110">
            ‚ûï New Team
          </button>
        </div>
      </div>

      {/* Unrostered Players Alert */}
      {unrosteredPlayers.length > 0 && (
        <div className="bg-[var(--accent-primary)]/10 border border-[var(--accent-primary)]/30 rounded-xl p-4 flex items-center gap-3">
          <span className="text-2xl">‚ö†Ô∏è</span>
          <div className="flex-1">
            <p className="text-[var(--accent-primary)] font-medium">{unrosteredPlayers.length} Unrostered Players</p>
            <p className="text-sm text-slate-400">
              {unrosteredPlayers.slice(0, 3).map(p => `${p.first_name} ${p.last_name}`).join(', ')}
              {unrosteredPlayers.length > 3 && ` and ${unrosteredPlayers.length - 3} more`}
            </p>
          </div>
          {viewMode === 'cards' && (
            <div className="flex flex-wrap gap-2 max-w-md">
              {unrosteredPlayers.slice(0, 4).map(p => (
                <div key={p.id} className="px-2 py-1 bg-[var(--accent-primary)]/20 rounded text-xs text-[var(--accent-primary)]">
                  {p.first_name} {p.last_name?.[0]}.
                </div>
              ))}
            </div>
          )}
        </div>
      )}

      {loading ? (
        <div className="text-center py-12 text-slate-400">Loading teams...</div>
      ) : teams.length === 0 ? (
        <div className="bg-slate-800 border border-slate-700 rounded-2xl p-12 text-center">
          <Users className="w-12 h-12" />
          <h3 className="text-lg font-medium text-white mt-4">No teams yet</h3>
          <p className="text-slate-400 mt-2">Create your first team to start building rosters</p>
          <button onClick={() => setShowNewTeamModal(true)} className="mt-4 bg-[var(--accent-primary)] text-white font-semibold px-6 py-2 rounded-xl">
            Create Team
          </button>
        </div>
      ) : (
        <div className={`grid gap-6 ${viewMode === 'compact' ? 'grid-cols-1' : 'grid-cols-1 md:grid-cols-2 lg:grid-cols-3'}`}>
          {teams.map(team => (
            <div key={team.id} className="bg-slate-800 border border-slate-700 rounded-2xl overflow-hidden">
              <div 
                className="p-4 border-b border-slate-700 flex items-center justify-between cursor-pointer"
                style={{ borderLeftColor: team.color, borderLeftWidth: 4 }}
                onClick={() => setExpandedTeam(expandedTeam === team.id ? null : team.id)}
              >
                <div>
                  <h3 className="font-semibold text-white">{team.name}</h3>
                  <p className="text-xs text-slate-500">{team.team_players?.length || 0} players</p>
                </div>
                <div className="flex gap-1 items-center">
                  <button 
                    onClick={(e) => { e.stopPropagation(); navigateToTeamWall(team.id); }} 
                    className="px-2 py-1 rounded-lg text-xs font-medium transition"
                    style={{ background: `${team.color}20`, color: team.color }}
                    title="View Team Wall"
                  >
                    üè† Wall
                  </button>
                  <span className="text-slate-500 text-sm mx-2">{expandedTeam === team.id ? '‚ñº' : '‚ñ∂'}</span>
                  <button onClick={(e) => { e.stopPropagation(); deleteTeam(team.id); }} className="p-2 rounded-lg hover:bg-red-500/10 text-slate-400 hover:text-red-400 text-sm"><Trash2 className="w-4 h-4" /></button>
                </div>
              </div>
              
              {(expandedTeam === team.id || viewMode !== 'compact') && (
                <div className={`p-4 ${viewMode === 'compact' ? '' : 'max-h-80'} overflow-y-auto`}>
                  {team.team_players?.length === 0 ? (
                    <p className="text-slate-500 text-sm text-center py-4">No players assigned</p>
                  ) : viewMode === 'cards' ? (
                    /* Card View */
                    <div className="flex flex-wrap gap-3 justify-center">
                      {team.team_players?.map(tp => (
                        <PlayerCard
                          key={tp.id}
                          player={tp.players}
                          context="roster"
                          teamColor={team.color}
                          showPhoto={showPhotos}
                          size="small"
                          onClick={() => setSelectedPlayer(tp.players)}
                        />
                      ))}
                    </div>
                  ) : (
                    /* List View */
                    <div className="space-y-2">
                      {team.team_players?.map(tp => (
                        <div 
                          key={tp.id} 
                          className="flex items-center justify-between p-2 bg-slate-900 rounded-lg hover:bg-slate-700 transition"
                        >
                          <div className="flex items-center gap-3">
                            {showPhotos && (
                              tp.players?.photo_url ? (
                                <img src={tp.players.photo_url} alt="" className="w-8 h-8 rounded-full object-cover" />
                              ) : (
                                <div className="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-slate-500"><User className="w-5 h-5" /></div>
                              )
                            )}
                            {tp.players?.jersey_number && (
                              <span className="w-6 h-6 rounded text-xs flex items-center justify-center font-bold" style={{ backgroundColor: team.color + '30', color: team.color }}>
                                {tp.players.jersey_number}
                              </span>
                            )}
                            <div>
                              <ClickablePlayerName 
                                player={tp.players}
                                onPlayerSelect={setSelectedPlayer}
                                className="text-white text-sm"
                              />
                              {tp.players?.position && (
                                <span className="ml-2 px-1.5 py-0.5 rounded text-[10px] font-bold" style={{ backgroundColor: positionColors[tp.players.position] || '#666', color: '#000' }}>
                                  {tp.players.position}
                                </span>
                              )}
                            </div>
                          </div>
                          <div className="flex items-center gap-2">
                            {tp.players?.grade && <span className="text-xs text-slate-500">Gr {tp.players.grade}</span>}
                            <button onClick={(e) => { e.stopPropagation(); removePlayerFromTeam(tp.id); }} className="text-slate-500 hover:text-red-400 text-xs p-1"><X className="w-4 h-4" /></button>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              )}
              
              {unrosteredPlayers.length > 0 && (expandedTeam === team.id || viewMode !== 'compact') && (
                <div className="p-4 border-t border-slate-700">
                  <select onChange={e => { if (e.target.value) addPlayerToTeam(team.id, e.target.value); e.target.value = '' }}
                    className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm">
                    <option value="">+ Add player...</option>
                    {unrosteredPlayers.map(p => (
                      <option key={p.id} value={p.id}>{p.first_name} {p.last_name}</option>
                    ))}
                  </select>
                </div>
              )}
            </div>
          ))}
        </div>
      )}

      {showNewTeamModal && <NewTeamModal onClose={() => setShowNewTeamModal(false)} onCreate={createTeam} />}
      
      {/* Player Card Expanded Modal */}
      {selectedPlayer && (
        <PlayerCardExpanded
          player={selectedPlayer}
          visible={!!selectedPlayer}
          onClose={() => setSelectedPlayer(null)}
          context="roster"
        />
      )}
    </div>
  )
}

function NewTeamModal({ onClose, onCreate }) {
  const tc = useThemeClasses()
  const { isDark } = useTheme()
  const [form, setForm] = useState({
    name: '',
    abbreviation: '',
    color: '#FFD700',
    logo_url: '',
    age_group_type: 'age', // 'age' or 'grade'
    age_group: '',
    team_type: 'recreational',
    skill_level: 'all',
    gender: 'coed',
    max_roster_size: 12,
    min_roster_size: 6,
    roster_open: true,
    description: '',
    internal_notes: '',
    create_team_chat: true,
    create_player_chat: true,
    create_team_wall: true
  })
  const [uploading, setUploading] = useState(false)
  const [activeTab, setActiveTab] = useState('basic') // basic, classification, roster, settings

  const ageOptions = [
    '8U', '9U', '10U', '11U', '12U', '13U', '14U', '15U', '16U', '17U', '18U', 'Adult'
  ]
  
  const gradeOptions = [
    { value: '3rd', label: '3rd Grade' },
    { value: '4th', label: '4th Grade' },
    { value: '5th', label: '5th Grade' },
    { value: '6th', label: '6th Grade' },
    { value: '7th', label: '7th Grade' },
    { value: '8th', label: '8th Grade' },
    { value: '9th', label: '9th Grade (Freshman)' },
    { value: '10th', label: '10th Grade (Sophomore)' },
    { value: '11th', label: '11th Grade (Junior)' },
    { value: '12th', label: '12th Grade (Senior)' },
  ]

  async function handleLogoUpload(e) {
    const file = e.target.files?.[0]
    if (!file) return
    
    setUploading(true)
    try {
      const fileExt = file.name.split('.').pop()
      const fileName = `team-logo-${Date.now()}.${fileExt}`
      
      const { data, error } = await supabase.storage
        .from('team-assets')
        .upload(fileName, file)
      
      if (error) {
        console.error('Upload error:', error)
        // If bucket doesn't exist, just store locally for now
        const reader = new FileReader()
        reader.onload = (e) => setForm({ ...form, logo_url: e.target.result })
        reader.readAsDataURL(file)
      } else {
        const { data: { publicUrl } } = supabase.storage
          .from('team-assets')
          .getPublicUrl(fileName)
        setForm({ ...form, logo_url: publicUrl })
      }
    } catch (err) {
      console.error('Upload error:', err)
    }
    setUploading(false)
  }

  const [creating, setCreating] = useState(false)

  async function handleCreate() {
    if (!form.name.trim() || creating) return
    setCreating(true)
    try {
      await onCreate(form)
    } catch (err) {
      console.error('Error creating team:', err)
    }
    setCreating(false)
  }

  const tabs = [
    { id: 'basic', label: 'Basic Info', icon: 'volleyball' },
    { id: 'classification', label: 'Classification', icon: 'clipboard' },
    { id: 'roster', label: 'Roster', icon: 'users' },
    { id: 'settings', label: 'Settings', icon: 'settings' },
  ]

  const isValid = form.name.trim() && form.age_group

  return (
    <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
      <div className={`${tc.cardBg} rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col`}>
        {/* Header */}
        <div className={`p-4 border-b ${tc.border} flex items-center justify-between`}>
          <h2 className={`text-xl font-bold ${tc.text}`}>Create New Team</h2>
          <button onClick={onClose} className={`p-2 rounded-lg ${tc.hoverBg} ${tc.textMuted}`}><X className="w-4 h-4" /></button>
        </div>
        
        {/* Tabs */}
        <div className={`flex border-b ${tc.border}`}>
          {tabs.map(tab => (
            <button
              key={tab.id}
              onClick={() => setActiveTab(tab.id)}
              className={`flex-1 px-4 py-3 text-sm font-medium transition ${
                activeTab === tab.id
                  ? `${tc.text} border-b-2 border-[var(--accent-primary)]`
                  : `${tc.textMuted} hover:${tc.text}`
              }`}
            >
              <span className="mr-1">{tab.icon}</span> {tab.label}
            </button>
          ))}
        </div>
        
        {/* Content */}
        <div className="flex-1 overflow-y-auto p-6">
          {/* Basic Info Tab */}
          {activeTab === 'basic' && (
            <div className="space-y-5">
              {/* Team Name */}
              <div>
                <label className={`block text-sm font-medium ${tc.text} mb-2`}>Team Name *</label>
                <input 
                  type="text" 
                  value={form.name} 
                  onChange={e => setForm({...form, name: e.target.value})} 
                  placeholder="e.g., Black Hornets Elite"
                  className={`w-full ${tc.input} rounded-xl px-4 py-3`} 
                />
              </div>
              
              {/* Abbreviation */}
              <div>
                <label className={`block text-sm font-medium ${tc.text} mb-2`}>Abbreviation</label>
                <input 
                  type="text" 
                  value={form.abbreviation} 
                  onChange={e => setForm({...form, abbreviation: e.target.value.toUpperCase().slice(0, 5)})} 
                  placeholder="e.g., BHE"
                  maxLength={5}
                  className={`w-full ${tc.input} rounded-xl px-4 py-3 uppercase`} 
                />
                <p className={`text-xs ${tc.textMuted} mt-1`}>Short code for scoreboards & schedules (max 5 chars)</p>
              </div>
              
              {/* Team Color */}
              <div>
                <label className={`block text-sm font-medium ${tc.text} mb-2`}>Team Color</label>
                <div className="flex gap-3">
                  <div 
                    className="w-14 h-14 rounded-xl border-2 border-white/20 cursor-pointer overflow-hidden"
                    style={{ backgroundColor: form.color }}
                  >
                    <input 
                      type="color" 
                      value={form.color} 
                      onChange={e => setForm({...form, color: e.target.value})} 
                      className="w-full h-full cursor-pointer opacity-0" 
                    />
                  </div>
                  <input 
                    type="text" 
                    value={form.color} 
                    onChange={e => setForm({...form, color: e.target.value})}
                    className={`flex-1 ${tc.input} rounded-xl px-4 py-3 font-mono`} 
                  />
                </div>
                {/* Quick color picks */}
                <div className="flex gap-2 mt-2">
                  {['#EF4444', '#F97316', '#EAB308', '#22C55E', '#06B6D4', '#3B82F6', '#8B5CF6', '#EC4899', '#000000'].map(c => (
                    <button
                      key={c}
                      onClick={() => setForm({...form, color: c})}
                      className={`w-8 h-8 rounded-lg border-2 transition ${form.color === c ? 'border-white scale-110' : 'border-transparent'}`}
                      style={{ backgroundColor: c }}
                    />
                  ))}
                </div>
              </div>
              
              {/* Team Logo */}
              <div>
                <label className={`block text-sm font-medium ${tc.text} mb-2`}>Team Logo</label>
                <div className="flex items-center gap-4">
                  {form.logo_url ? (
                    <div className="relative">
                      <img src={form.logo_url} alt="Logo" className="w-20 h-20 rounded-xl object-cover" />
                      <button
                        onClick={() => setForm({...form, logo_url: ''})}
                        className="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full text-sm"
                      >√ó</button>
                    </div>
                  ) : (
                    <label className={`w-20 h-20 rounded-xl ${tc.cardBgAlt} border-2 border-dashed ${tc.border} flex flex-col items-center justify-center cursor-pointer hover:border-[var(--accent-primary)] transition`}>
                      <span className="text-2xl">üì∑</span>
                      <span className={`text-xs ${tc.textMuted}`}>Upload</span>
                      <input type="file" accept="image/*" onChange={handleLogoUpload} className="hidden" />
                    </label>
                  )}
                  <div className={`text-sm ${tc.textMuted}`}>
                    <p>Recommended: 200x200px</p>
                    <p>PNG or JPG</p>
                    {uploading && <p className="text-[var(--accent-primary)]">Uploading...</p>}
                  </div>
                </div>
              </div>
              
              {/* Description */}
              <div>
                <label className={`block text-sm font-medium ${tc.text} mb-2`}>Description</label>
                <textarea 
                  value={form.description} 
                  onChange={e => setForm({...form, description: e.target.value})} 
                  placeholder="Team bio, goals, or info for parents..."
                  rows={3}
                  className={`w-full ${tc.input} rounded-xl px-4 py-3 resize-none`} 
                />
              </div>
            </div>
          )}
          
          {/* Classification Tab */}
          {activeTab === 'classification' && (
            <div className="space-y-5">
              {/* Age Group Type Toggle */}
              <div>
                <label className={`block text-sm font-medium ${tc.text} mb-2`}>Division Type *</label>
                <div className="flex gap-2">
                  <button
                    onClick={() => setForm({...form, age_group_type: 'age', age_group: ''})}
                    className={`flex-1 px-4 py-3 rounded-xl font-medium transition ${
                      form.age_group_type === 'age'
                        ? 'bg-[var(--accent-primary)] text-white'
                        : `${tc.cardBgAlt} ${tc.text}`
                    }`}
                  >
                    By Age (8U, 10U, etc.)
                  </button>
                  <button
                    onClick={() => setForm({...form, age_group_type: 'grade', age_group: ''})}
                    className={`flex-1 px-4 py-3 rounded-xl font-medium transition ${
                      form.age_group_type === 'grade'
                        ? 'bg-[var(--accent-primary)] text-white'
                        : `${tc.cardBgAlt} ${tc.text}`
                    }`}
                  >
                    By Grade Level
                  </button>
                </div>
              </div>
              
              {/* Age Group Selection */}
              <div>
                <label className={`block text-sm font-medium ${tc.text} mb-2`}>
                  {form.age_group_type === 'age' ? 'Age Group *' : 'Grade Level *'}
                </label>
                {form.age_group_type === 'age' ? (
                  <div className="grid grid-cols-4 gap-2">
                    {ageOptions.map(age => (
                      <button
                        key={age}
                        onClick={() => setForm({...form, age_group: age})}
                        className={`px-4 py-3 rounded-xl font-medium transition ${
                          form.age_group === age
                            ? 'bg-[var(--accent-primary)] text-white'
                            : `${tc.cardBgAlt} ${tc.text} ${tc.hoverBg}`
                        }`}
                      >
                        {age}
                      </button>
                    ))}
                  </div>
                ) : (
                  <div className="grid grid-cols-3 gap-2">
                    {gradeOptions.map(grade => (
                      <button
                        key={grade.value}
                        onClick={() => setForm({...form, age_group: grade.value})}
                        className={`px-3 py-2 rounded-xl text-sm font-medium transition ${
                          form.age_group === grade.value
                            ? 'bg-[var(--accent-primary)] text-white'
                            : `${tc.cardBgAlt} ${tc.text} ${tc.hoverBg}`
                        }`}
                      >
                        {grade.label}
                      </button>
                    ))}
                  </div>
                )}
              </div>
              
              {/* Team Type */}
              <div>
                <label className={`block text-sm font-medium ${tc.text} mb-2`}>Team Type *</label>
                <div className="grid grid-cols-2 gap-3">
                  <button
                    onClick={() => setForm({...form, team_type: 'recreational'})}
                    className={`p-4 rounded-xl border-2 transition text-left ${
                      form.team_type === 'recreational'
                        ? 'border-[var(--accent-primary)] bg-[var(--accent-primary)]/10'
                        : `border-transparent ${tc.cardBgAlt}`
                    }`}
                  >
                    <span className="text-3xl">üéâ</span>
                    <p className={`font-semibold ${tc.text} mt-2`}>Recreational</p>
                    <p className={`text-xs ${tc.textMuted}`}>Fun, learning & development</p>
                  </button>
                  <button
                    onClick={() => setForm({...form, team_type: 'competitive'})}
                    className={`p-4 rounded-xl border-2 transition text-left ${
                      form.team_type === 'competitive'
                        ? 'border-[var(--accent-primary)] bg-[var(--accent-primary)]/10'
                        : `border-transparent ${tc.cardBgAlt}`
                    }`}
                  >
                    <span className="text-3xl">üèÜ</span>
                    <p className={`font-semibold ${tc.text} mt-2`}>Competitive</p>
                    <p className={`text-xs ${tc.textMuted}`}>Travel, tournaments & leagues</p>
                  </button>
                </div>
              </div>
              
              {/* Gender */}
              <div>
                <label className={`block text-sm font-medium ${tc.text} mb-2`}>Gender</label>
                <div className="flex gap-2">
                  {[
                    { value: 'girls', label: 'F Girls', color: 'pink' },
                    { value: 'boys', label: 'M Boys', color: 'blue' },
                    { value: 'coed', label: 'üë´ Coed', color: 'purple' },
                  ].map(g => (
                    <button
                      key={g.value}
                      onClick={() => setForm({...form, gender: g.value})}
                      className={`flex-1 px-4 py-3 rounded-xl font-medium transition ${
                        form.gender === g.value
                          ? 'bg-[var(--accent-primary)] text-white'
                          : `${tc.cardBgAlt} ${tc.text}`
                      }`}
                    >
                      {g.label}
                    </button>
                  ))}
                </div>
              </div>
              
              {/* Skill Level */}
              <div>
                <label className={`block text-sm font-medium ${tc.text} mb-2`}>Skill Level</label>
                <div className="flex gap-2">
                  {[
                    { value: 'beginner', label: 'Beginner' },
                    { value: 'intermediate', label: 'Intermediate' },
                    { value: 'advanced', label: 'Advanced' },
                    { value: 'all', label: 'All Levels' },
                  ].map(s => (
                    <button
                      key={s.value}
                      onClick={() => setForm({...form, skill_level: s.value})}
                      className={`flex-1 px-3 py-2 rounded-xl text-sm font-medium transition ${
                        form.skill_level === s.value
                          ? 'bg-[var(--accent-primary)] text-white'
                          : `${tc.cardBgAlt} ${tc.text}`
                      }`}
                    >
                      {s.label}
                    </button>
                  ))}
                </div>
              </div>
            </div>
          )}
          
          {/* Roster Tab */}
          {activeTab === 'roster' && (
            <div className="space-y-5">
              {/* Max Roster Size */}
              <div>
                <label className={`block text-sm font-medium ${tc.text} mb-2`}>
                  Maximum Roster Size: <span className="text-[var(--accent-primary)] font-bold text-lg">{form.max_roster_size}</span>
                </label>
                <input
                  type="range"
                  min="6"
                  max="16"
                  value={form.max_roster_size}
                  onChange={e => setForm({...form, max_roster_size: parseInt(e.target.value)})}
                  className="w-full h-3 rounded-full appearance-none cursor-pointer accent-[var(--accent-primary)]"
                  style={{
                    background: `linear-gradient(to right, var(--accent-primary) 0%, var(--accent-primary) ${((form.max_roster_size - 6) / 10) * 100}%, ${isDark ? '#334155' : '#E2E8F0'} ${((form.max_roster_size - 6) / 10) * 100}%, ${isDark ? '#334155' : '#E2E8F0'} 100%)`
                  }}
                />
                <div className={`flex justify-between text-xs ${tc.textMuted} mt-2`}>
                  <span>6</span>
                  <span>10</span>
                  <span className="font-medium">12 (default)</span>
                  <span>14</span>
                  <span>16</span>
                </div>
              </div>
              
              {/* Min Roster Size */}
              <div>
                <label className={`block text-sm font-medium ${tc.text} mb-2`}>
                  Minimum Roster Size: <span className="text-[var(--accent-primary)] font-bold text-lg">{form.min_roster_size}</span>
                </label>
                <input
                  type="range"
                  min="4"
                  max={form.max_roster_size}
                  value={form.min_roster_size}
                  onChange={e => setForm({...form, min_roster_size: parseInt(e.target.value)})}
                  className="w-full h-3 rounded-full appearance-none cursor-pointer accent-[var(--accent-primary)]"
                  style={{
                    background: `linear-gradient(to right, var(--accent-primary) 0%, var(--accent-primary) ${((form.min_roster_size - 4) / (form.max_roster_size - 4)) * 100}%, ${isDark ? '#334155' : '#E2E8F0'} ${((form.min_roster_size - 4) / (form.max_roster_size - 4)) * 100}%, ${isDark ? '#334155' : '#E2E8F0'} 100%)`
                  }}
                />
                <p className={`text-xs ${tc.textMuted} mt-2`}>Minimum players needed to field a team</p>
              </div>
              
              {/* Roster Status */}
              <div>
                <label className={`block text-sm font-medium ${tc.text} mb-2`}>Roster Status</label>
                <div className="grid grid-cols-2 gap-3">
                  <button
                    onClick={() => setForm({...form, roster_open: true})}
                    className={`p-4 rounded-xl border-2 transition text-left ${
                      form.roster_open
                        ? 'border-emerald-500 bg-emerald-500/10'
                        : `border-transparent ${tc.cardBgAlt}`
                    }`}
                  >
                    <span className="text-2xl">üü¢</span>
                    <p className={`font-semibold ${tc.text} mt-2`}>Open</p>
                    <p className={`text-xs ${tc.textMuted}`}>Accepting new players</p>
                  </button>
                  <button
                    onClick={() => setForm({...form, roster_open: false})}
                    className={`p-4 rounded-xl border-2 transition text-left ${
                      !form.roster_open
                        ? 'border-red-500 bg-red-500/10'
                        : `border-transparent ${tc.cardBgAlt}`
                    }`}
                  >
                    <span className="text-2xl">üî¥</span>
                    <p className={`font-semibold ${tc.text} mt-2`}>Closed</p>
                    <p className={`text-xs ${tc.textMuted}`}>Roster is full/locked</p>
                  </button>
                </div>
              </div>
              
              {/* Roster Preview */}
              <div className={`${tc.cardBgAlt} rounded-xl p-4`}>
                <p className={`text-sm ${tc.textMuted} mb-2`}>Roster Preview</p>
                <div className="flex items-center gap-3">
                  <div className="flex -space-x-2">
                    {Array.from({ length: Math.min(form.max_roster_size, 8) }).map((_, i) => (
                      <div key={i} className={`w-8 h-8 rounded-full ${tc.cardBg} border-2 ${tc.border} flex items-center justify-center text-xs ${tc.textMuted}`}>
                        {i + 1}
                      </div>
                    ))}
                    {form.max_roster_size > 8 && (
                      <div className={`w-8 h-8 rounded-full ${tc.cardBg} border-2 ${tc.border} flex items-center justify-center text-xs ${tc.textMuted}`}>
                        +{form.max_roster_size - 8}
                      </div>
                    )}
                  </div>
                  <span className={tc.text}>{form.min_roster_size} - {form.max_roster_size} players</span>
                </div>
              </div>
            </div>
          )}
          
          {/* Settings Tab */}
          {activeTab === 'settings' && (
            <div className="space-y-5">
              {/* Auto-create options */}
              <div>
                <label className={`block text-sm font-medium ${tc.text} mb-3`}>Auto-Create on Team Creation</label>
                <div className="space-y-3">
                  <label className={`flex items-center justify-between p-4 rounded-xl ${tc.cardBgAlt} cursor-pointer`}>
                    <div className="flex items-center gap-3">
                      <MessageCircle className="w-7 h-7" />
                      <div>
                        <p className={`font-medium ${tc.text}`}>Team Chat</p>
                        <p className={`text-xs ${tc.textMuted}`}>Parents & coaches can message</p>
                      </div>
                    </div>
                    <input 
                      type="checkbox" 
                      checked={form.create_team_chat} 
                      onChange={e => setForm({...form, create_team_chat: e.target.checked})}
                      className="w-5 h-5 rounded accent-[var(--accent-primary)]"
                    />
                  </label>
                  
                  <label className={`flex items-center justify-between p-4 rounded-xl ${tc.cardBgAlt} cursor-pointer`}>
                    <div className="flex items-center gap-3">
                      <span className="text-2xl">üßí</span>
                      <div>
                        <p className={`font-medium ${tc.text}`}>Player Chat</p>
                        <p className={`text-xs ${tc.textMuted}`}>Players & coaches (parents view-only)</p>
                      </div>
                    </div>
                    <input 
                      type="checkbox" 
                      checked={form.create_player_chat} 
                      onChange={e => setForm({...form, create_player_chat: e.target.checked})}
                      className="w-5 h-5 rounded accent-[var(--accent-primary)]"
                    />
                  </label>
                  
                  <label className={`flex items-center justify-between p-4 rounded-xl ${tc.cardBgAlt} cursor-pointer`}>
                    <div className="flex items-center gap-3">
                      <ClipboardList className="w-7 h-7" />
                      <div>
                        <p className={`font-medium ${tc.text}`}>Team Wall/Page</p>
                        <p className={`text-xs ${tc.textMuted}`}>Team announcements, events & posts</p>
                      </div>
                    </div>
                    <input 
                      type="checkbox" 
                      checked={form.create_team_wall} 
                      onChange={e => setForm({...form, create_team_wall: e.target.checked})}
                      className="w-5 h-5 rounded accent-[var(--accent-primary)]"
                    />
                  </label>
                </div>
              </div>
              
              {/* Internal Notes */}
              <div>
                <label className={`block text-sm font-medium ${tc.text} mb-2`}>Internal Notes (Admin Only)</label>
                <textarea 
                  value={form.internal_notes} 
                  onChange={e => setForm({...form, internal_notes: e.target.value})} 
                  placeholder="Notes for coaches/admins only (not visible to parents)..."
                  rows={3}
                  className={`w-full ${tc.input} rounded-xl px-4 py-3 resize-none`} 
                />
              </div>
            </div>
          )}
        </div>
        
        {/* Footer */}
        <div className={`p-4 border-t ${tc.border} flex items-center justify-between`}>
          <div className={`text-sm ${tc.textMuted}`}>
            {!form.name && <span className="text-amber-500">‚ö† Team name required</span>}
            {form.name && !form.age_group && <span className="text-amber-500">‚ö† Age group required</span>}
            {form.name && form.age_group && !creating && <span className="text-emerald-500">‚úì Ready to create</span>}
            {creating && <span className="text-[var(--accent-primary)]">Creating team...</span>}
          </div>
          <div className="flex gap-3">
            <button 
              onClick={onClose} 
              disabled={creating}
              className={`px-6 py-2 rounded-xl ${tc.cardBgAlt} ${tc.text} font-medium disabled:opacity-50`}
            >
              Cancel
            </button>
            <button 
              onClick={handleCreate} 
              disabled={!isValid || creating}
              className="px-6 py-3 rounded-xl bg-[var(--accent-primary)] text-white font-semibold disabled:opacity-50 disabled:cursor-not-allowed hover:brightness-110 transition"
            >
              {creating ? 'Creating...' : 'Create Team'}
            </button>
          </div>
        </div>
      </div>
    </div>
  )
}

// ============================================
// SCHEDULE PAGE - COMPREHENSIVE CALENDAR SYSTEM
// ============================================
function SchedulePage({ showToast, activeView }) {
  const journey = useJourney()
  const { organization } = useAuth()
  const { selectedSeason } = useSeason()
  const [events, setEvents] = useState([])
  const [teams, setTeams] = useState([])
  const [venues, setVenues] = useState([])
  const [loading, setLoading] = useState(true)
  const [view, setView] = useState('month') // month, week, day, list
  const [currentDate, setCurrentDate] = useState(new Date())
  const [selectedTeam, setSelectedTeam] = useState('all')
  const [selectedEventType, setSelectedEventType] = useState('all')
  
  // Modals
  const [showAddEvent, setShowAddEvent] = useState(false)
  const [showBulkPractice, setShowBulkPractice] = useState(false)
  const [showBulkGames, setShowBulkGames] = useState(false)
  const [showVenueManager, setShowVenueManager] = useState(false)
  const [showAvailabilitySurvey, setShowAvailabilitySurvey] = useState(false)
  const [selectedEvent, setSelectedEvent] = useState(null)
  const [showQuickActions, setShowQuickActions] = useState(false)

  useEffect(() => {
    if (selectedSeason?.id) {
      loadEvents()
      loadTeams()
      loadVenues()
    }
  }, [selectedSeason?.id, currentDate])

  async function loadEvents() {
    if (!selectedSeason?.id) {
      console.log('loadEvents: No season selected')
      return
    }
    setLoading(true)
    
    // Get date range based on view
    const startOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1)
    const endOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0)
    
    // Format as YYYY-MM-DD for date comparison
    const startDate = startOfMonth.toISOString().split('T')[0]
    const endDate = endOfMonth.toISOString().split('T')[0]
    
    console.log('loadEvents: Querying with', {
      season_id: selectedSeason.id,
      startDate,
      endDate
    })
    
    const { data, error } = await supabase
      .from('schedule_events')
      .select('*, teams!schedule_events_team_id_fkey(id, name, color)')
      .eq('season_id', selectedSeason.id)
      .gte('event_date', startDate)
      .lte('event_date', endDate)
      .order('event_date', { ascending: true })
      .order('event_time', { ascending: true })
    
    console.log('loadEvents: Result', { data, error, count: data?.length })
    
    if (error) console.error('Error loading events:', error)
    
    // Transform data to add computed start_time for calendar views
    const transformedData = (data || []).map(event => ({
      ...event,
      // Combine event_date and event_time into a start_time for calendar compatibility
      start_time: event.event_date && event.event_time 
        ? `${event.event_date}T${event.event_time}` 
        : event.event_date,
      // Also create end_time timestamp if end_time exists
      end_time_full: event.event_date && event.end_time 
        ? `${event.event_date}T${event.end_time}` 
        : null
    }))
    
    setEvents(transformedData)
    setLoading(false)
  }

  async function loadTeams() {
    if (!selectedSeason?.id) return
    const { data } = await supabase
      .from('teams')
      .select('id, name, color')
      .eq('season_id', selectedSeason.id)
      .order('name')
    setTeams(data || [])
  }

  async function loadVenues() {
    if (!organization?.id) return
    // Load from org settings or a venues table
    const savedVenues = organization.settings?.venues || []
    setVenues(savedVenues)
  }

  async function saveVenues(newVenues) {
    const newSettings = { ...organization.settings, venues: newVenues }
    await supabase.from('organizations').update({ settings: newSettings }).eq('id', organization.id)
    setVenues(newVenues)
    showToast('Venues saved!', 'success')
  }

  async function createEvent(eventData) {
    try {
      const { error } = await supabase.from('schedule_events').insert({
        ...eventData,
        season_id: selectedSeason.id,
        created_at: new Date().toISOString()
      })
      if (error) throw error
      showToast('Event created!', 'success')
      journey?.completeStep('create_schedule')
      loadEvents()
      return true
    } catch (err) {
      showToast('Error: ' + err.message, 'error')
      return false
    }
  }

  async function createBulkEvents(eventsData, notify = false) {
    try {
      const events = eventsData.map(e => ({
        ...e,
        season_id: selectedSeason.id,
        created_at: new Date().toISOString()
      }))
      const { error } = await supabase.from('schedule_events').insert(events)
      if (error) throw error
      showToast(`${events.length} events created!`, 'success')
      journey?.completeStep('create_schedule')
      loadEvents()
      // TODO: If notify, trigger notification to families
      return true
    } catch (err) {
      showToast('Error: ' + err.message, 'error')
      return false
    }
  }

  async function updateEvent(eventId, eventData) {
    try {
      const { error } = await supabase
        .from('schedule_events')
        .update({ ...eventData, updated_at: new Date().toISOString() })
        .eq('id', eventId)
      if (error) throw error
      showToast('Event updated!', 'success')
      loadEvents()
      return true
    } catch (err) {
      showToast('Error: ' + err.message, 'error')
      return false
    }
  }

  async function deleteEvent(eventId) {
    if (!confirm('Delete this event?')) return
    try {
      const { error } = await supabase.from('schedule_events').delete().eq('id', eventId)
      if (error) throw error
      showToast('Event deleted', 'success')
      setSelectedEvent(null)
      loadEvents()
    } catch (err) {
      showToast('Error: ' + err.message, 'error')
    }
  }

  // Filter events - show org-wide events (null team_id) always, plus team-specific events
  const filteredEvents = events.filter(e => {
    // If "All Teams" selected, show everything
    if (selectedTeam === 'all') {
      // Just filter by event type if needed
      if (selectedEventType !== 'all' && e.event_type !== selectedEventType) return false
      return true
    }
    
    // If specific team selected, show: team's events + org-wide events (null team_id)
    if (e.team_id !== selectedTeam && e.team_id !== null) return false
    if (selectedEventType !== 'all' && e.event_type !== selectedEventType) return false
    return true
  })

  // Navigation helpers
  function prevMonth() {
    setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1))
  }
  function nextMonth() {
    setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1))
  }
  function goToToday() {
    setCurrentDate(new Date())
  }

  // Generate iCal export
  function exportToICal() {
    const icsEvents = filteredEvents.map(event => {
      const start = new Date(event.start_time)
      const end = event.end_time ? new Date(event.end_time) : new Date(start.getTime() + 60 * 60 * 1000)
      
      const formatDate = (d) => d.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z'
      
      return `BEGIN:VEVENT
DTSTART:${formatDate(start)}
DTEND:${formatDate(end)}
SUMMARY:${event.title || event.event_type}
DESCRIPTION:${event.description || ''}
LOCATION:${event.venue_name || ''} ${event.venue_address || ''}
END:VEVENT`
    }).join('\n')

    const ical = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//VolleyBrain//Schedule//EN
${icsEvents}
END:VCALENDAR`

    const blob = new Blob([ical], { type: 'text/calendar' })
    const url = URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
    a.download = `volleybrain-schedule-${selectedSeason?.name || 'calendar'}.ics`
    a.click()
    URL.revokeObjectURL(url)
    showToast('Calendar exported!', 'success')
  }

  if (!selectedSeason) {
    return (
      <div className="flex items-center justify-center h-64">
        <p className="text-slate-400">Please select a season from the sidebar</p>
      </div>
    )
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-start justify-between">
        <div>
          <h1 className="text-3xl font-bold text-white">Schedule</h1>
          <p className="text-slate-400 mt-1">Manage practices, games, and events ‚Ä¢ {selectedSeason.name}</p>
        </div>
        <div className="flex gap-3">
          <button onClick={exportToICal} className="bg-slate-700 text-white px-4 py-2 rounded-xl hover:bg-slate-600 flex items-center gap-2">
            üìÖ Export iCal
          </button>
          <div className="relative">
            <button 
              onClick={() => setShowQuickActions(!showQuickActions)}
              className="bg-[var(--accent-primary)] text-white font-semibold px-4 py-2 rounded-xl hover:brightness-110 flex items-center gap-2"
            >
              ‚ûï Add Events ‚ñæ
            </button>
            {showQuickActions && (
              <div className="absolute right-0 mt-2 w-56 bg-slate-700 border border-slate-700 rounded-xl shadow-xl z-20">
                <button onClick={() => { setShowAddEvent(true); setShowQuickActions(false) }}
                  className="w-full text-left px-4 py-3 text-white hover:bg-slate-700 rounded-t-xl flex items-center gap-3">
                  <span>üìù</span> Single Event
                </button>
                <button onClick={() => { setShowBulkPractice(true); setShowQuickActions(false) }}
                  className="w-full text-left px-4 py-3 text-white hover:bg-slate-700 flex items-center gap-3">
                  <span>üîÑ</span> Recurring Practice
                </button>
                <button onClick={() => { setShowBulkGames(true); setShowQuickActions(false) }}
                  className="w-full text-left px-4 py-3 text-white hover:bg-slate-700 flex items-center gap-3">
                  <VolleyballIcon className="w-4 h-4" /> Bulk Add Games
                </button>
                <button onClick={() => { setShowVenueManager(true); setShowQuickActions(false) }}
                  className="w-full text-left px-4 py-3 text-white hover:bg-slate-700 flex items-center gap-3">
                  <span>üìç</span> Manage Venues
                </button>
                <button onClick={() => { setShowAvailabilitySurvey(true); setShowQuickActions(false) }}
                  className="w-full text-left px-4 py-3 text-white hover:bg-slate-700 rounded-b-xl flex items-center gap-3">
                  <BarChart3 className="w-5 h-5" /> Availability Survey
                </button>
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Filters & View Toggle */}
      <div className="flex flex-wrap gap-4 items-center justify-between">
        <div className="flex gap-4 items-center">
          <select value={selectedTeam} onChange={e => setSelectedTeam(e.target.value)}
            className="bg-slate-800 border border-slate-700 rounded-xl px-4 py-2 text-white">
            <option value="all">All Teams</option>
            {teams.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}
          </select>
          <select value={selectedEventType} onChange={e => setSelectedEventType(e.target.value)}
            className="bg-slate-800 border border-slate-700 rounded-xl px-4 py-2 text-white">
            <option value="all">All Types</option>
            <option value="practice">Practices</option>
            <option value="game">Games</option>
            <option value="tournament">Tournaments</option>
            <option value="team_event">Team Events</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div className="flex items-center gap-2">
          <div className="flex bg-slate-800 rounded-xl p-1 border border-slate-700">
            {['month', 'week', 'day', 'list'].map(v => (
              <button key={v} onClick={() => setView(v)}
                className={`px-4 py-2 rounded-lg text-sm font-medium transition capitalize ${
                  view === v ? 'bg-[var(--accent-primary)] text-white' : 'text-slate-400 hover:text-white'
                }`}>{v}</button>
            ))}
          </div>
        </div>
      </div>

      {/* Calendar Navigation */}
      <div className="flex items-center justify-between bg-slate-800 border border-slate-700 rounded-xl p-4">
        <button onClick={prevMonth} className="p-2 hover:bg-slate-700 rounded-lg text-white">‚Üê Prev</button>
        <div className="flex items-center gap-4">
          <h2 className="text-xl font-bold text-white">
            {currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
          </h2>
          <button onClick={goToToday} className="px-3 py-1 bg-slate-700 rounded-lg text-sm text-white hover:bg-slate-600">
            Today
          </button>
        </div>
        <button onClick={nextMonth} className="p-2 hover:bg-slate-700 rounded-lg text-white">Next ‚Üí</button>
      </div>

      {/* Calendar View */}
      {loading ? (
        <div className="text-center py-12 text-slate-400">Loading schedule...</div>
      ) : view === 'month' ? (
        <MonthView 
          events={filteredEvents} 
          currentDate={currentDate} 
          onSelectEvent={setSelectedEvent}
          onSelectDate={(date) => { setCurrentDate(date); setView('day') }}
          teams={teams}
        />
      ) : view === 'week' ? (
        <WeekView 
          events={filteredEvents} 
          currentDate={currentDate}
          onSelectEvent={setSelectedEvent}
          teams={teams}
        />
      ) : view === 'day' ? (
        <DayView 
          events={filteredEvents} 
          currentDate={currentDate}
          onSelectEvent={setSelectedEvent}
          teams={teams}
        />
      ) : (
        <ListView 
          events={filteredEvents}
          onSelectEvent={setSelectedEvent}
          teams={teams}
        />
      )}

      {/* Event Count */}
      <div className="text-center text-slate-500 text-sm">
        {filteredEvents.length} event{filteredEvents.length !== 1 ? 's' : ''} this month
      </div>

      {/* Modals */}
      {showAddEvent && (
        <AddEventModal
          teams={teams}
          venues={venues}
          onClose={() => setShowAddEvent(false)}
          onCreate={createEvent}
        />
      )}

      {showBulkPractice && (
        <BulkPracticeModal
          teams={teams}
          venues={venues}
          onClose={() => setShowBulkPractice(false)}
          onCreate={createBulkEvents}
        />
      )}

      {showBulkGames && (
        <BulkGamesModal
          teams={teams}
          venues={venues}
          onClose={() => setShowBulkGames(false)}
          onCreate={createBulkEvents}
        />
      )}

      {showVenueManager && (
        <VenueManagerModal
          venues={venues}
          onClose={() => setShowVenueManager(false)}
          onSave={saveVenues}
        />
      )}

      {showAvailabilitySurvey && (
        <AvailabilitySurveyModal
          teams={teams}
          organization={organization}
          onClose={() => setShowAvailabilitySurvey(false)}
          showToast={showToast}
        />
      )}

      {selectedEvent && (
        <EventDetailModal
          event={selectedEvent}
          teams={teams}
          venues={venues}
          onClose={() => setSelectedEvent(null)}
          onUpdate={updateEvent}
          onDelete={deleteEvent}
          activeView={activeView}
        />
      )}

      {/* Click outside to close quick actions */}
      {showQuickActions && (
        <div className="fixed inset-0 z-10" onClick={() => setShowQuickActions(false)} />
      )}
    </div>
  )
}

// ============================================
// CALENDAR VIEWS
// ============================================
function MonthView({ events, currentDate, onSelectEvent, onSelectDate, teams }) {
  const year = currentDate.getFullYear()
  const month = currentDate.getMonth()
  const firstDay = new Date(year, month, 1)
  const lastDay = new Date(year, month + 1, 0)
  const startPadding = firstDay.getDay()
  const daysInMonth = lastDay.getDate()

  const days = []
  for (let i = 0; i < startPadding; i++) {
    days.push(null)
  }
  for (let i = 1; i <= daysInMonth; i++) {
    days.push(i)
  }

  const getEventsForDay = (day) => {
    if (!day) return []
    const dayStart = new Date(year, month, day)
    const dayEnd = new Date(year, month, day, 23, 59, 59)
    return events.filter(e => {
      const eventDate = new Date(e.start_time)
      return eventDate >= dayStart && eventDate <= dayEnd
    })
  }

  const isToday = (day) => {
    if (!day) return false
    const today = new Date()
    return day === today.getDate() && month === today.getMonth() && year === today.getFullYear()
  }

  return (
    <div className="bg-slate-800 border border-slate-700 rounded-2xl overflow-hidden">
      {/* Day headers */}
      <div className="grid grid-cols-7 border-b border-slate-700">
        {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(d => (
          <div key={d} className="p-3 text-center text-sm font-medium text-slate-400">{d}</div>
        ))}
      </div>
      {/* Days grid */}
      <div className="grid grid-cols-7">
        {days.map((day, i) => {
          const dayEvents = getEventsForDay(day)
          return (
            <div 
              key={i} 
              className={`min-h-[100px] p-2 border-b border-r border-slate-700 ${!day ? 'bg-slate-900' : 'hover:bg-slate-700 cursor-pointer'}`}
              onClick={() => day && onSelectDate(new Date(year, month, day))}
            >
              {day && (
                <>
                  <div className={`text-sm font-medium mb-1 ${isToday(day) ? 'w-7 h-7 bg-[var(--accent-primary)] text-white rounded-full flex items-center justify-center' : 'text-white'}`}>
                    {day}
                  </div>
                  <div className="space-y-1">
                    {dayEvents.slice(0, 3).map(event => (
                      <div 
                        key={event.id}
                        onClick={(e) => { e.stopPropagation(); onSelectEvent(event) }}
                        className="text-xs p-1 rounded truncate cursor-pointer hover:opacity-80"
                        style={{ 
                          backgroundColor: getEventColor(event.event_type) + '30',
                          color: getEventColor(event.event_type),
                          borderLeft: `3px solid ${event.teams?.color || getEventColor(event.event_type)}`
                        }}
                      >
                        {formatTime(event.start_time)} {event.title || event.event_type}
                      </div>
                    ))}
                    {dayEvents.length > 3 && (
                      <div className="text-xs text-slate-500">+{dayEvents.length - 3} more</div>
                    )}
                  </div>
                </>
              )}
            </div>
          )
        })}
      </div>
    </div>
  )
}

function WeekView({ events, currentDate, onSelectEvent, teams }) {
  const startOfWeek = new Date(currentDate)
  startOfWeek.setDate(currentDate.getDate() - currentDate.getDay())
  
  const weekDays = []
  for (let i = 0; i < 7; i++) {
    const day = new Date(startOfWeek)
    day.setDate(startOfWeek.getDate() + i)
    weekDays.push(day)
  }

  const hours = []
  for (let h = 6; h <= 22; h++) {
    hours.push(h)
  }

  const getEventsForDayHour = (day, hour) => {
    return events.filter(e => {
      const eventDate = new Date(e.start_time)
      return eventDate.getDate() === day.getDate() &&
             eventDate.getMonth() === day.getMonth() &&
             eventDate.getHours() === hour
    })
  }

  const isToday = (day) => {
    const today = new Date()
    return day.getDate() === today.getDate() && 
           day.getMonth() === today.getMonth() && 
           day.getFullYear() === today.getFullYear()
  }

  return (
    <div className="bg-slate-800 border border-slate-700 rounded-2xl overflow-hidden">
      {/* Day headers */}
      <div className="grid grid-cols-8 border-b border-slate-700">
        <div className="p-3 text-center text-sm font-medium text-slate-400"></div>
        {weekDays.map((day, i) => (
          <div key={i} className={`p-3 text-center ${isToday(day) ? 'bg-[var(--accent-primary)]/10' : ''}`}>
            <div className="text-xs text-slate-400">{day.toLocaleDateString('en-US', { weekday: 'short' })}</div>
            <div className={`text-lg font-bold ${isToday(day) ? 'text-[var(--accent-primary)]' : 'text-white'}`}>
              {day.getDate()}
            </div>
          </div>
        ))}
      </div>
      {/* Time grid */}
      <div className="max-h-[600px] overflow-y-auto">
        {hours.map(hour => (
          <div key={hour} className="grid grid-cols-8 border-b border-slate-700">
            <div className="p-2 text-xs text-slate-500 text-right pr-3">
              {hour > 12 ? hour - 12 : hour}{hour >= 12 ? 'pm' : 'am'}
            </div>
            {weekDays.map((day, i) => {
              const hourEvents = getEventsForDayHour(day, hour)
              return (
                <div key={i} className={`p-1 min-h-[50px] border-l border-slate-700 ${isToday(day) ? 'bg-yellow-500/5' : ''}`}>
                  {hourEvents.map(event => (
                    <div 
                      key={event.id}
                      onClick={() => onSelectEvent(event)}
                      className="text-xs p-1 rounded truncate cursor-pointer hover:opacity-80 mb-1"
                      style={{ 
                        backgroundColor: getEventColor(event.event_type) + '30',
                        color: getEventColor(event.event_type)
                      }}
                    >
                      {event.title || event.event_type}
                    </div>
                  ))}
                </div>
              )
            })}
          </div>
        ))}
      </div>
    </div>
  )
}

function DayView({ events, currentDate, onSelectEvent, teams }) {
  const dayEvents = events.filter(e => {
    const eventDate = new Date(e.start_time)
    return eventDate.getDate() === currentDate.getDate() &&
           eventDate.getMonth() === currentDate.getMonth() &&
           eventDate.getFullYear() === currentDate.getFullYear()
  })

  const hours = []
  for (let h = 6; h <= 22; h++) {
    hours.push(h)
  }

  return (
    <div className="bg-slate-800 border border-slate-700 rounded-2xl overflow-hidden">
      <div className="p-4 border-b border-slate-700">
        <h3 className="text-lg font-bold text-white">
          {currentDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}
        </h3>
        <p className="text-sm text-slate-400">{dayEvents.length} event{dayEvents.length !== 1 ? 's' : ''}</p>
      </div>
      <div className="max-h-[600px] overflow-y-auto">
        {hours.map(hour => {
          const hourEvents = dayEvents.filter(e => new Date(e.start_time).getHours() === hour)
          return (
            <div key={hour} className="flex border-b border-slate-700">
              <div className="w-20 p-3 text-sm text-slate-500 text-right shrink-0">
                {hour > 12 ? hour - 12 : hour}:00 {hour >= 12 ? 'PM' : 'AM'}
              </div>
              <div className="flex-1 p-2 min-h-[60px]">
                {hourEvents.map(event => (
                  <div 
                    key={event.id}
                    onClick={() => onSelectEvent(event)}
                    className="p-3 rounded-xl cursor-pointer hover:opacity-80 mb-2"
                    style={{ 
                      backgroundColor: getEventColor(event.event_type) + '20',
                      borderLeft: `4px solid ${event.teams?.color || getEventColor(event.event_type)}`
                    }}
                  >
                    <div className="flex items-center justify-between">
                      <span className="font-medium text-white">{event.title || event.event_type}</span>
                      <span className="text-xs px-2 py-1 rounded-full" style={{ backgroundColor: getEventColor(event.event_type) + '30', color: getEventColor(event.event_type) }}>
                        {event.event_type}
                      </span>
                    </div>
                    <div className="text-sm text-slate-400 mt-1">
                      {formatTime(event.start_time)} - {event.end_time ? formatTime(event.end_time) : 'TBD'}
                    </div>
                    {event.venue_name && (
                      <div className="text-sm text-slate-500 mt-1">üìç {event.venue_name}</div>
                    )}
                    {event.teams?.name && (
                      <div className="text-sm mt-1" style={{ color: event.teams.color }}>{event.teams.name}</div>
                    )}
                  </div>
                ))}
              </div>
            </div>
          )
        })}
      </div>
    </div>
  )
}

function ListView({ events, onSelectEvent, teams }) {
  const sortedEvents = [...events].sort((a, b) => new Date(a.start_time) - new Date(b.start_time))
  
  // Group by date
  const grouped = sortedEvents.reduce((acc, event) => {
    const date = new Date(event.start_time).toLocaleDateString()
    if (!acc[date]) acc[date] = []
    acc[date].push(event)
    return acc
  }, {})

  return (
    <div className="space-y-6">
      {Object.entries(grouped).map(([date, dayEvents]) => (
        <div key={date}>
          <h3 className="text-sm font-medium text-slate-400 mb-3">
            {new Date(date).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}
          </h3>
          <div className="space-y-2">
            {dayEvents.map(event => (
              <div 
                key={event.id}
                onClick={() => onSelectEvent(event)}
                className="bg-slate-800 border border-slate-700 rounded-xl p-4 cursor-pointer hover:border-[var(--accent-primary)]/30 transition"
              >
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <div 
                      className="w-1 h-12 rounded-full"
                      style={{ backgroundColor: event.teams?.color || getEventColor(event.event_type) }}
                    />
                    <div>
                      <p className="font-medium text-white">{event.title || event.event_type}</p>
                      <p className="text-sm text-slate-400">
                        {formatTime(event.start_time)} - {event.end_time ? formatTime(event.end_time) : 'TBD'}
                        {event.venue_name && ` ‚Ä¢ ${event.venue_name}`}
                      </p>
                    </div>
                  </div>
                  <div className="text-right">
                    <span className="text-xs px-2 py-1 rounded-full" style={{ backgroundColor: getEventColor(event.event_type) + '30', color: getEventColor(event.event_type) }}>
                      {event.event_type}
                    </span>
                    {event.teams?.name && (
                      <p className="text-xs mt-1" style={{ color: event.teams.color }}>{event.teams.name}</p>
                    )}
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
      ))}
      {Object.keys(grouped).length === 0 && (
        <div className="bg-slate-800 border border-slate-700 rounded-2xl p-12 text-center">
          <span className="text-5xl">üóìÔ∏è</span>
          <h3 className="text-lg font-medium text-white mt-4">No events this month</h3>
          <p className="text-slate-400 mt-2">Create your first event to get started</p>
        </div>
      )}
    </div>
  )
}

// Helper functions
function getEventColor(type) {
  const colors = {
    practice: '#10B981', // green
    game: '#F59E0B', // yellow/orange
    tournament: '#8B5CF6', // purple
    team_event: '#3B82F6', // blue
    other: '#6B7280' // gray
  }
  return colors[type] || colors.other
}

function formatTime(dateStr) {
  const date = new Date(dateStr)
  return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })
}

// ============================================
// ADD SINGLE EVENT MODAL
// ============================================
function AddEventModal({ teams, venues, onClose, onCreate }) {
  const [form, setForm] = useState({
    team_id: '',
    event_type: 'practice',
    title: '',
    description: '',
    start_date: '',
    start_time: '18:00',
    end_time: '19:00',
    venue_name: '',
    venue_address: '',
    location_type: 'home',
    opponent_name: '',
    arrival_time: '',
    notify_families: false
  })

  function handleVenueSelect(venueName) {
    const venue = venues.find(v => v.name === venueName)
    setForm({ ...form, venue_name: venue?.name || venueName, venue_address: venue?.address || '' })
  }

  async function handleSubmit() {
    if (!form.start_date || !form.start_time) {
      alert('Please enter date and time')
      return
    }
    
    // Build arrival_time as full timestamp if provided
    let arrivalTimestamp = null
    if (form.arrival_time) {
      arrivalTimestamp = `${form.start_date}T${form.arrival_time}:00`
    }
    
    // Use your schema: event_date (date) + event_time (time) + end_time (time)
    const eventData = {
      team_id: form.team_id || null,
      event_type: form.event_type,
      title: form.title || form.event_type.charAt(0).toUpperCase() + form.event_type.slice(1),
      notes: form.description,  // Your schema uses 'notes' not 'description'
      event_date: form.start_date,  // DATE format: YYYY-MM-DD
      event_time: form.start_time,  // TIME format: HH:MM
      end_time: form.end_time || null,  // TIME format: HH:MM
      venue_name: form.venue_name,
      venue_address: form.venue_address,
      location_type: form.location_type,
      opponent_name: form.opponent_name,
      arrival_time: arrivalTimestamp  // TIMESTAMP format: YYYY-MM-DDTHH:MM:SS
    }
    
    const success = await onCreate(eventData)
    if (success) onClose()
  }

  return (
    <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50">
      <div className="bg-slate-800 border border-slate-700 rounded-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
        <div className="p-6 border-b border-slate-700 flex items-center justify-between sticky top-0 bg-slate-800">
          <h2 className="text-xl font-semibold text-white">Add Event</h2>
          <button onClick={onClose} className="text-slate-400 hover:text-white text-2xl">√ó</button>
        </div>
        <div className="p-6 space-y-4">
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm text-slate-400 mb-2">Event Type</label>
              <select value={form.event_type} onChange={e => setForm({...form, event_type: e.target.value})}
                className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white">
                <option value="practice">Practice</option>
                <option value="game">Game</option>
                <option value="tournament">Tournament</option>
                <option value="team_event">Team Event</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div>
              <label className="block text-sm text-slate-400 mb-2">Team (optional)</label>
              <select value={form.team_id} onChange={e => setForm({...form, team_id: e.target.value})}
                className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white">
                <option value="">All Teams / Org-wide</option>
                {teams.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}
              </select>
            </div>
          </div>
          
          <div>
            <label className="block text-sm text-slate-400 mb-2">Title</label>
            <input type="text" value={form.title} onChange={e => setForm({...form, title: e.target.value})}
              placeholder={form.event_type.charAt(0).toUpperCase() + form.event_type.slice(1)}
              className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white" />
          </div>

          <div className="grid grid-cols-3 gap-4">
            <div>
              <label className="block text-sm text-slate-400 mb-2">Date</label>
              <input type="date" value={form.start_date} onChange={e => setForm({...form, start_date: e.target.value})}
                className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white" />
            </div>
            <div>
              <label className="block text-sm text-slate-400 mb-2">Start Time</label>
              <input type="time" value={form.start_time} onChange={e => setForm({...form, start_time: e.target.value})}
                className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white" />
            </div>
            <div>
              <label className="block text-sm text-slate-400 mb-2">End Time</label>
              <input type="time" value={form.end_time} onChange={e => setForm({...form, end_time: e.target.value})}
                className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white" />
            </div>
          </div>

          <div>
            <label className="block text-sm text-slate-400 mb-2">Venue</label>
            <select value={form.venue_name} onChange={e => handleVenueSelect(e.target.value)}
              className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white mb-2">
              <option value="">Select saved venue or enter below</option>
              {venues.map(v => <option key={v.name} value={v.name}>{v.name}</option>)}
            </select>
            <input type="text" value={form.venue_name} onChange={e => setForm({...form, venue_name: e.target.value})}
              placeholder="Venue name"
              className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white mb-2" />
            <input type="text" value={form.venue_address} onChange={e => setForm({...form, venue_address: e.target.value})}
              placeholder="Address"
              className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white" />
          </div>

          {form.event_type === 'game' && (
            <>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm text-slate-400 mb-2">Location Type</label>
                  <select value={form.location_type} onChange={e => setForm({...form, location_type: e.target.value})}
                    className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white">
                    <option value="home">Home</option>
                    <option value="away">Away</option>
                    <option value="neutral">Neutral</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm text-slate-400 mb-2">Opponent</label>
                  <input type="text" value={form.opponent_name} onChange={e => setForm({...form, opponent_name: e.target.value})}
                    placeholder="Opponent team name"
                    className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white" />
                </div>
              </div>
              <div>
                <label className="block text-sm text-slate-400 mb-2">Arrival Time (optional)</label>
                <input type="time" value={form.arrival_time} onChange={e => setForm({...form, arrival_time: e.target.value})}
                  className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white" />
              </div>
            </>
          )}

          <div>
            <label className="block text-sm text-slate-400 mb-2">Description (optional)</label>
            <textarea value={form.description} onChange={e => setForm({...form, description: e.target.value})}
              placeholder="Additional details..."
              className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white min-h-[80px]" />
          </div>

          <label className="flex items-center gap-3 cursor-pointer p-3 bg-slate-900 rounded-xl">
            <input type="checkbox" checked={form.notify_families} onChange={e => setForm({...form, notify_families: e.target.checked})}
              className="w-5 h-5 rounded" />
            <span className="text-white">Notify all families after creating</span>
          </label>
        </div>
        <div className="p-6 border-t border-slate-700 flex justify-end gap-3 sticky bottom-0 bg-slate-800">
          <button onClick={onClose} className="px-6 py-2 rounded-xl border border-slate-700 text-white">Cancel</button>
          <button onClick={handleSubmit} className="px-6 py-2 rounded-xl bg-[var(--accent-primary)] text-white font-semibold">Create Event</button>
        </div>
      </div>
    </div>
  )
}

// ============================================
// BULK PRACTICE MODAL (RECURRING)
// ============================================
function BulkPracticeModal({ teams, venues, onClose, onCreate }) {
  const [form, setForm] = useState({
    team_id: '',
    start_time: '18:00',
    end_time: '19:30',
    start_date: '',
    end_date: '',
    notify_families: true
  })
  
  // Track day configurations with their own venues
  const [dayConfigs, setDayConfigs] = useState([])
  const [preview, setPreview] = useState([])
  const [showPreviewEdit, setShowPreviewEdit] = useState(false)

  const dayOptions = [
    { value: 0, label: 'Sunday', short: 'Sun' },
    { value: 1, label: 'Monday', short: 'Mon' },
    { value: 2, label: 'Tuesday', short: 'Tue' },
    { value: 3, label: 'Wednesday', short: 'Wed' },
    { value: 4, label: 'Thursday', short: 'Thu' },
    { value: 5, label: 'Friday', short: 'Fri' },
    { value: 6, label: 'Saturday', short: 'Sat' },
  ]

  function toggleDay(dayValue) {
    const existing = dayConfigs.find(d => d.day === dayValue)
    if (existing) {
      setDayConfigs(dayConfigs.filter(d => d.day !== dayValue))
    } else {
      setDayConfigs([...dayConfigs, { 
        day: dayValue, 
        venue_name: '', 
        venue_address: '',
        start_time: form.start_time,
        end_time: form.end_time
      }])
    }
  }

  function updateDayConfig(dayValue, field, value) {
    setDayConfigs(dayConfigs.map(d => 
      d.day === dayValue ? { ...d, [field]: value } : d
    ))
  }

  function handleVenueSelectForDay(dayValue, venueName) {
    const venue = venues.find(v => v.name === venueName)
    setDayConfigs(dayConfigs.map(d => 
      d.day === dayValue ? { 
        ...d, 
        venue_name: venue?.name || venueName, 
        venue_address: venue?.address || '' 
      } : d
    ))
  }

  function applyVenueToAllDays(venueName) {
    const venue = venues.find(v => v.name === venueName)
    setDayConfigs(dayConfigs.map(d => ({
      ...d,
      venue_name: venue?.name || venueName,
      venue_address: venue?.address || ''
    })))
  }

  function generatePreview() {
    if (!form.start_date || !form.end_date || dayConfigs.length === 0) {
      setPreview([])
      return
    }

    const events = []
    const start = new Date(form.start_date)
    const end = new Date(form.end_date)
    
    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
      const dayConfig = dayConfigs.find(dc => dc.day === d.getDay())
      if (dayConfig) {
        events.push({
          id: `${d.getTime()}`,
          date: new Date(d),
          dayName: dayOptions.find(opt => opt.value === d.getDay())?.label,
          venue_name: dayConfig.venue_name,
          venue_address: dayConfig.venue_address,
          start_time: dayConfig.start_time || form.start_time,
          end_time: dayConfig.end_time || form.end_time
        })
      }
    }
    setPreview(events)
  }

  useEffect(() => {
    generatePreview()
  }, [form.start_date, form.end_date, dayConfigs])

  function updatePreviewItem(id, field, value) {
    setPreview(preview.map(p => p.id === id ? { ...p, [field]: value } : p))
  }

  function removePreviewItem(id) {
    setPreview(preview.filter(p => p.id !== id))
  }

  async function handleSubmit() {
    if (preview.length === 0) {
      alert('No practices to create. Please select days and date range.')
      return
    }

    const eventsData = preview.map(p => {
      // Format date as YYYY-MM-DD
      const eventDate = p.date.toISOString().split('T')[0]
      
      return {
        team_id: form.team_id || null,
        event_type: 'practice',
        title: 'Practice',
        notes: '',  // Your schema uses 'notes' not 'description'
        event_date: eventDate,  // DATE format: YYYY-MM-DD
        event_time: p.start_time || form.start_time,  // TIME format: HH:MM
        end_time: p.end_time || form.end_time,  // TIME format: HH:MM
        venue_name: p.venue_name || '',
        venue_address: p.venue_address || '',
        location_type: 'home'
      }
    })

    const success = await onCreate(eventsData, form.notify_families)
    if (success) onClose()
  }

  const selectedDays = dayConfigs.map(d => d.day)

  return (
    <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50">
      <div className="bg-slate-800 border border-slate-700 rounded-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
        <div className="p-6 border-b border-slate-700 flex items-center justify-between sticky top-0 bg-slate-800">
          <div>
            <h2 className="text-xl font-semibold text-white">Create Recurring Practice</h2>
            <p className="text-sm text-slate-400">Schedule practices with per-day venue control</p>
          </div>
          <button onClick={onClose} className="text-slate-400 hover:text-white text-2xl">√ó</button>
        </div>
        <div className="p-6 space-y-6">
          {/* Team Selection */}
          <div>
            <label className="block text-sm text-slate-400 mb-2">Team</label>
            <select value={form.team_id} onChange={e => setForm({...form, team_id: e.target.value})}
              className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white">
              <option value="">All Teams / Org-wide</option>
              {teams.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}
            </select>
          </div>

          {/* Date Range */}
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm text-slate-400 mb-2">First Practice</label>
              <input type="date" value={form.start_date} onChange={e => setForm({...form, start_date: e.target.value})}
                className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white" />
            </div>
            <div>
              <label className="block text-sm text-slate-400 mb-2">Last Practice</label>
              <input type="date" value={form.end_date} onChange={e => setForm({...form, end_date: e.target.value})}
                className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white" />
            </div>
          </div>

          {/* Default Times */}
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm text-slate-400 mb-2">Default Start Time</label>
              <input type="time" value={form.start_time} onChange={e => setForm({...form, start_time: e.target.value})}
                className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white" />
            </div>
            <div>
              <label className="block text-sm text-slate-400 mb-2">Default End Time</label>
              <input type="time" value={form.end_time} onChange={e => setForm({...form, end_time: e.target.value})}
                className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white" />
            </div>
          </div>

          {/* Day Selection */}
          <div>
            <label className="block text-sm text-slate-400 mb-3">Practice Days</label>
            <div className="flex flex-wrap gap-2">
              {dayOptions.map(day => (
                <button
                  key={day.value}
                  onClick={() => toggleDay(day.value)}
                  className={`px-4 py-2 rounded-xl text-sm font-medium transition ${
                    selectedDays.includes(day.value)
                      ? 'bg-[var(--accent-primary)] text-white'
                      : 'bg-slate-900 border border-slate-700 text-slate-400 hover:text-white'
                  }`}
                >
                  {day.label}
                </button>
              ))}
            </div>
          </div>

          {/* Per-Day Venue Configuration */}
          {dayConfigs.length > 0 && (
            <div className="bg-slate-900 rounded-xl p-4">
              <div className="flex items-center justify-between mb-4">
                <h4 className="text-sm font-medium text-white">Venue per Day</h4>
                {venues.length > 0 && (
                  <select 
                    onChange={e => e.target.value && applyVenueToAllDays(e.target.value)}
                    className="bg-slate-800 border border-slate-700 rounded-lg px-3 py-1 text-sm text-white"
                  >
                    <option value="">Apply to all days...</option>
                    {venues.map(v => <option key={v.name} value={v.name}>{v.name}</option>)}
                  </select>
                )}
              </div>
              <div className="space-y-3">
                {dayConfigs.sort((a, b) => a.day - b.day).map(dc => (
                  <div key={dc.day} className="flex items-center gap-3 p-3 bg-slate-800 rounded-lg">
                    <div className="w-24 font-medium text-white">
                      {dayOptions.find(d => d.value === dc.day)?.label}
                    </div>
                    <select 
                      value={dc.venue_name}
                      onChange={e => handleVenueSelectForDay(dc.day, e.target.value)}
                      className="flex-1 bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white"
                    >
                      <option value="">Select venue...</option>
                      {venues.map(v => <option key={v.name} value={v.name}>{v.name}</option>)}
                    </select>
                    <input 
                      type="time" 
                      value={dc.start_time || form.start_time}
                      onChange={e => updateDayConfig(dc.day, 'start_time', e.target.value)}
                      className="w-28 bg-slate-900 border border-slate-700 rounded-lg px-2 py-2 text-sm text-white"
                    />
                    <span className="text-slate-500">-</span>
                    <input 
                      type="time" 
                      value={dc.end_time || form.end_time}
                      onChange={e => updateDayConfig(dc.day, 'end_time', e.target.value)}
                      className="w-28 bg-slate-900 border border-slate-700 rounded-lg px-2 py-2 text-sm text-white"
                    />
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Preview */}
          {preview.length > 0 && (
            <div className="bg-slate-900 rounded-xl p-4">
              <div className="flex items-center justify-between mb-3">
                <h4 className="text-sm font-medium text-white">Preview: {preview.length} practices</h4>
                <button 
                  onClick={() => setShowPreviewEdit(!showPreviewEdit)}
                  className="text-xs text-[var(--accent-primary)] hover:text-yellow-300"
                >
                  {showPreviewEdit ? 'Hide Details' : 'Edit Individual Practices'}
                </button>
              </div>
              
              {showPreviewEdit ? (
                <div className="max-h-60 overflow-y-auto space-y-2">
                  {preview.map((p, i) => (
                    <div key={p.id} className="flex items-center gap-2 p-2 bg-slate-800 rounded-lg text-sm">
                      <span className="w-20 text-slate-400">{p.date.toLocaleDateString()}</span>
                      <span className="w-16 text-white">{p.dayName?.slice(0, 3)}</span>
                      <select 
                        value={p.venue_name}
                        onChange={e => {
                          const venue = venues.find(v => v.name === e.target.value)
                          updatePreviewItem(p.id, 'venue_name', venue?.name || '')
                          updatePreviewItem(p.id, 'venue_address', venue?.address || '')
                        }}
                        className="flex-1 bg-slate-900 border border-slate-700 rounded px-2 py-1 text-white text-xs"
                      >
                        <option value="">No venue</option>
                        {venues.map(v => <option key={v.name} value={v.name}>{v.name}</option>)}
                      </select>
                      <button onClick={() => removePreviewItem(p.id)} className="text-red-400 hover:text-red-300 px-2"><X className="w-4 h-4" /></button>
                    </div>
                  ))}
                </div>
              ) : (
                <div className="max-h-40 overflow-y-auto space-y-1">
                  {preview.slice(0, 15).map((p, i) => (
                    <div key={p.id} className="text-sm text-slate-400 flex justify-between">
                      <span>{p.dayName} - {p.date.toLocaleDateString()}</span>
                      <span className="text-slate-500">{p.venue_name || 'No venue'}</span>
                    </div>
                  ))}
                  {preview.length > 15 && (
                    <div className="text-sm text-slate-500">...and {preview.length - 15} more</div>
                  )}
                </div>
              )}
            </div>
          )}

          <label className="flex items-center gap-3 cursor-pointer p-3 bg-slate-900 rounded-xl">
            <input type="checkbox" checked={form.notify_families} onChange={e => setForm({...form, notify_families: e.target.checked})}
              className="w-5 h-5 rounded" />
            <span className="text-white">Notify all families after creating</span>
          </label>
        </div>
        <div className="p-6 border-t border-slate-700 flex justify-between items-center sticky bottom-0 bg-slate-800">
          <span className="text-slate-400">
            {preview.length > 0 ? `${preview.length} practices will be created` : 'Select days and date range'}
          </span>
          <div className="flex gap-3">
            <button onClick={onClose} className="px-6 py-2 rounded-xl border border-slate-700 text-white">Cancel</button>
            <button onClick={handleSubmit} disabled={preview.length === 0}
              className="px-6 py-2 rounded-xl bg-[var(--accent-primary)] text-white font-semibold disabled:opacity-50">
              Create {preview.length} Practices
            </button>
          </div>
        </div>
      </div>
    </div>
  )
}

// ============================================
// BULK GAMES MODAL
// ============================================
function BulkGamesModal({ teams, venues, onClose, onCreate }) {
  const [games, setGames] = useState([
    { team_id: '', date: '', time: '10:00', opponent: '', venue_name: '', location_type: 'home' }
  ])
  const [notifyFamilies, setNotifyFamilies] = useState(true)

  function addRow() {
    setGames([...games, { team_id: '', date: '', time: '10:00', opponent: '', venue_name: '', location_type: 'home' }])
  }

  function removeRow(index) {
    setGames(games.filter((_, i) => i !== index))
  }

  function updateRow(index, field, value) {
    const updated = [...games]
    updated[index][field] = value
    setGames(updated)
  }

  async function handleSubmit() {
    const validGames = games.filter(g => g.date && g.time)
    if (validGames.length === 0) {
      alert('Please enter at least one game with date and time')
      return
    }

    const eventsData = validGames.map(g => {
      const venue = venues.find(v => v.name === g.venue_name)
      
      // Calculate end time (2 hours after start)
      const [hours, minutes] = g.time.split(':')
      const endHours = (parseInt(hours) + 2) % 24
      const endTime = `${endHours.toString().padStart(2, '0')}:${minutes}`

      return {
        team_id: g.team_id || null,
        event_type: 'game',
        title: g.opponent ? `vs ${g.opponent}` : 'Game',
        notes: '',
        event_date: g.date,  // DATE format: YYYY-MM-DD
        event_time: g.time,  // TIME format: HH:MM
        end_time: endTime,   // TIME format: HH:MM
        opponent_name: g.opponent,
        venue_name: g.venue_name,
        venue_address: venue?.address || '',
        location_type: g.location_type
      }
    })

    const success = await onCreate(eventsData, notifyFamilies)
    if (success) onClose()
  }

  return (
    <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50">
      <div className="bg-slate-800 border border-slate-700 rounded-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
        <div className="p-6 border-b border-slate-700 flex items-center justify-between sticky top-0 bg-slate-800">
          <div>
            <h2 className="text-xl font-semibold text-white">Bulk Add Games</h2>
            <p className="text-sm text-slate-400">Enter multiple games at once</p>
          </div>
          <button onClick={onClose} className="text-slate-400 hover:text-white text-2xl">√ó</button>
        </div>
        <div className="p-6">
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead>
                <tr className="text-left text-sm text-slate-400">
                  <th className="pb-3 pr-2">Team</th>
                  <th className="pb-3 pr-2">Date</th>
                  <th className="pb-3 pr-2">Time</th>
                  <th className="pb-3 pr-2">Opponent</th>
                  <th className="pb-3 pr-2">Venue</th>
                  <th className="pb-3 pr-2">H/A</th>
                  <th className="pb-3 w-10"></th>
                </tr>
              </thead>
              <tbody>
                {games.map((game, i) => (
                  <tr key={i}>
                    <td className="pb-2 pr-2">
                      <select value={game.team_id} onChange={e => updateRow(i, 'team_id', e.target.value)}
                        className="w-full bg-slate-900 border border-slate-700 rounded-lg px-2 py-2 text-white text-sm">
                        <option value="">All</option>
                        {teams.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}
                      </select>
                    </td>
                    <td className="pb-2 pr-2">
                      <input type="date" value={game.date} onChange={e => updateRow(i, 'date', e.target.value)}
                        className="w-full bg-slate-900 border border-slate-700 rounded-lg px-2 py-2 text-white text-sm" />
                    </td>
                    <td className="pb-2 pr-2">
                      <input type="time" value={game.time} onChange={e => updateRow(i, 'time', e.target.value)}
                        className="w-full bg-slate-900 border border-slate-700 rounded-lg px-2 py-2 text-white text-sm" />
                    </td>
                    <td className="pb-2 pr-2">
                      <input type="text" value={game.opponent} onChange={e => updateRow(i, 'opponent', e.target.value)}
                        placeholder="Opponent"
                        className="w-full bg-slate-900 border border-slate-700 rounded-lg px-2 py-2 text-white text-sm" />
                    </td>
                    <td className="pb-2 pr-2">
                      <select value={game.venue_name} onChange={e => updateRow(i, 'venue_name', e.target.value)}
                        className="w-full bg-slate-900 border border-slate-700 rounded-lg px-2 py-2 text-white text-sm">
                        <option value="">Select venue</option>
                        {venues.map(v => <option key={v.name} value={v.name}>{v.name}</option>)}
                      </select>
                    </td>
                    <td className="pb-2 pr-2">
                      <select value={game.location_type} onChange={e => updateRow(i, 'location_type', e.target.value)}
                        className="w-full bg-slate-900 border border-slate-700 rounded-lg px-2 py-2 text-white text-sm">
                        <option value="home">Home</option>
                        <option value="away">Away</option>
                        <option value="neutral">Neutral</option>
                      </select>
                    </td>
                    <td className="pb-2">
                      <button onClick={() => removeRow(i)} className="text-red-400 hover:text-red-300 p-2"><X className="w-4 h-4" /></button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
          
          <button onClick={addRow} className="mt-4 px-4 py-2 border border-dashed border-slate-700 rounded-xl text-slate-400 hover:text-white hover:border-[var(--accent-primary)]/30 w-full">
            + Add Another Game
          </button>

          <label className="flex items-center gap-3 cursor-pointer p-3 bg-slate-900 rounded-xl mt-4">
            <input type="checkbox" checked={notifyFamilies} onChange={e => setNotifyFamilies(e.target.checked)}
              className="w-5 h-5 rounded" />
            <span className="text-white">Notify all families after creating</span>
          </label>
        </div>
        <div className="p-6 border-t border-slate-700 flex justify-between items-center sticky bottom-0 bg-slate-800">
          <span className="text-slate-400">
            {games.filter(g => g.date && g.time).length} valid game{games.filter(g => g.date && g.time).length !== 1 ? 's' : ''}
          </span>
          <div className="flex gap-3">
            <button onClick={onClose} className="px-6 py-2 rounded-xl border border-slate-700 text-white">Cancel</button>
            <button onClick={handleSubmit} className="px-6 py-2 rounded-xl bg-[var(--accent-primary)] text-white font-semibold">
              Create Games
            </button>
          </div>
        </div>
      </div>
    </div>
  )
}

// ============================================
// VENUE MANAGER MODAL
// ============================================
function VenueManagerModal({ venues, onClose, onSave }) {
  const [localVenues, setLocalVenues] = useState([...venues])
  const [newVenue, setNewVenue] = useState({ name: '', address: '', notes: '' })

  function addVenue() {
    if (!newVenue.name) return
    setLocalVenues([...localVenues, { ...newVenue }])
    setNewVenue({ name: '', address: '', notes: '' })
  }

  function removeVenue(index) {
    setLocalVenues(localVenues.filter((_, i) => i !== index))
  }

  function handleSave() {
    onSave(localVenues)
    onClose()
  }

  return (
    <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50">
      <div className="bg-slate-800 border border-slate-700 rounded-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
        <div className="p-6 border-b border-slate-700 flex items-center justify-between">
          <h2 className="text-xl font-semibold text-white">Manage Venues</h2>
          <button onClick={onClose} className="text-slate-400 hover:text-white text-2xl">√ó</button>
        </div>
        <div className="p-6 space-y-4">
          <p className="text-slate-400 text-sm">Save frequently used locations for quick selection</p>
          
          {/* Existing venues */}
          <div className="space-y-2">
            {localVenues.map((venue, i) => (
              <div key={i} className="bg-slate-900 rounded-xl p-4 flex items-start justify-between">
                <div>
                  <p className="font-medium text-white">{venue.name}</p>
                  {venue.address && <p className="text-sm text-slate-400">{venue.address}</p>}
                  {venue.notes && <p className="text-xs text-slate-500 mt-1">{venue.notes}</p>}
                </div>
                <button onClick={() => removeVenue(i)} className="text-red-400 hover:text-red-300"><X className="w-4 h-4" /></button>
              </div>
            ))}
          </div>

          {/* Add new venue */}
          <div className="border-t border-slate-700 pt-4">
            <h4 className="text-sm font-medium text-white mb-3">Add New Venue</h4>
            <div className="space-y-3">
              <input type="text" value={newVenue.name} onChange={e => setNewVenue({...newVenue, name: e.target.value})}
                placeholder="Venue name (e.g., Main Gym)"
                className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white" />
              <input type="text" value={newVenue.address} onChange={e => setNewVenue({...newVenue, address: e.target.value})}
                placeholder="Address"
                className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white" />
              <input type="text" value={newVenue.notes} onChange={e => setNewVenue({...newVenue, notes: e.target.value})}
                placeholder="Notes (e.g., Court 2, Park at back)"
                className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white" />
              <button onClick={addVenue} disabled={!newVenue.name}
                className="w-full px-4 py-2 bg-slate-700 text-white rounded-xl hover:bg-slate-600 disabled:opacity-50">
                + Add Venue
              </button>
            </div>
          </div>
        </div>
        <div className="p-6 border-t border-slate-700 flex justify-end gap-3">
          <button onClick={onClose} className="px-6 py-2 rounded-xl border border-slate-700 text-white">Cancel</button>
          <button onClick={handleSave} className="px-6 py-2 rounded-xl bg-[var(--accent-primary)] text-white font-semibold">Save Venues</button>
        </div>
      </div>
    </div>
  )
}

// ============================================
// AVAILABILITY SURVEY MODAL
// ============================================
function AvailabilitySurveyModal({ teams, organization, onClose, showToast }) {
  const [step, setStep] = useState('create') // create, view
  const [surveys, setSurveys] = useState([])
  const [selectedSurvey, setSelectedSurvey] = useState(null)
  
  // Create form
  const [form, setForm] = useState({
    title: 'Practice Availability',
    team_id: '',
    slots: [
      { day: 'Monday', time: '5:00 PM - 7:00 PM' },
      { day: 'Tuesday', time: '6:00 PM - 8:00 PM' },
      { day: 'Wednesday', time: '5:00 PM - 7:00 PM' },
    ],
    deadline: ''
  })

  useEffect(() => {
    loadSurveys()
  }, [])

  async function loadSurveys() {
    // Load from organization settings
    const existingSurveys = organization.settings?.availability_surveys || []
    setSurveys(existingSurveys)
  }

  function addSlot() {
    setForm({ ...form, slots: [...form.slots, { day: '', time: '' }] })
  }

  function removeSlot(index) {
    setForm({ ...form, slots: form.slots.filter((_, i) => i !== index) })
  }

  function updateSlot(index, field, value) {
    const updated = [...form.slots]
    updated[index][field] = value
    setForm({ ...form, slots: updated })
  }

  async function createSurvey() {
    const newSurvey = {
      id: Date.now().toString(),
      ...form,
      created_at: new Date().toISOString(),
      responses: [],
      status: 'active'
    }

    const updatedSurveys = [...surveys, newSurvey]
    const newSettings = { ...organization.settings, availability_surveys: updatedSurveys }
    
    await supabase.from('organizations').update({ settings: newSettings }).eq('id', organization.id)
    
    setSurveys(updatedSurveys)
    showToast('Survey created! Share the link with families.', 'success')
    setSelectedSurvey(newSurvey)
    setStep('view')
  }

  async function deleteSurvey(surveyId) {
    if (!confirm('Delete this survey and all responses?')) return
    const updatedSurveys = surveys.filter(s => s.id !== surveyId)
    const newSettings = { ...organization.settings, availability_surveys: updatedSurveys }
    await supabase.from('organizations').update({ settings: newSettings }).eq('id', organization.id)
    setSurveys(updatedSurveys)
    setSelectedSurvey(null)
    showToast('Survey deleted', 'success')
  }

  function copyShareLink(surveyId) {
    // In production, this would be a real shareable URL
    const link = `${window.location.origin}/availability/${organization.id}/${surveyId}`
    navigator.clipboard.writeText(link)
    showToast('Link copied to clipboard!', 'success')
  }

  return (
    <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50">
      <div className="bg-slate-800 border border-slate-700 rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <div className="p-6 border-b border-slate-700 flex items-center justify-between sticky top-0 bg-slate-800">
          <div>
            <h2 className="text-xl font-semibold text-white">Availability Survey</h2>
            <p className="text-sm text-slate-400">Collect availability from families</p>
          </div>
          <button onClick={onClose} className="text-slate-400 hover:text-white text-2xl">√ó</button>
        </div>

        {step === 'create' ? (
          <div className="p-6 space-y-6">
            {/* Existing surveys */}
            {surveys.length > 0 && (
              <div>
                <h3 className="text-sm font-medium text-slate-400 mb-3">Existing Surveys</h3>
                <div className="space-y-2">
                  {surveys.map(survey => (
                    <div key={survey.id} className="bg-slate-900 rounded-xl p-4 flex items-center justify-between">
                      <div>
                        <p className="font-medium text-white">{survey.title}</p>
                        <p className="text-sm text-slate-400">{survey.responses?.length || 0} responses</p>
                      </div>
                      <div className="flex gap-2">
                        <button onClick={() => { setSelectedSurvey(survey); setStep('view') }}
                          className="px-3 py-1 bg-slate-700 rounded-lg text-xs text-white hover:bg-slate-600">
                          View Results
                        </button>
                        <button onClick={() => copyShareLink(survey.id)}
                          className="px-3 py-1 bg-blue-500/20 rounded-lg text-xs text-blue-400 hover:bg-blue-500/30">
                          Copy Link
                        </button>
                        <button onClick={() => deleteSurvey(survey.id)}
                          className="px-3 py-1 bg-red-500/20 rounded-lg text-xs text-red-400 hover:bg-red-500/30">
                          Delete
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Create new survey */}
            <div className="border-t border-slate-700 pt-6">
              <h3 className="text-sm font-medium text-white mb-4">Create New Survey</h3>
              
              <div className="space-y-4">
                <div>
                  <label className="block text-sm text-slate-400 mb-2">Survey Title</label>
                  <input type="text" value={form.title} onChange={e => setForm({...form, title: e.target.value})}
                    className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white" />
                </div>

                <div>
                  <label className="block text-sm text-slate-400 mb-2">Team (optional)</label>
                  <select value={form.team_id} onChange={e => setForm({...form, team_id: e.target.value})}
                    className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white">
                    <option value="">All Teams</option>
                    {teams.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}
                  </select>
                </div>

                <div>
                  <label className="block text-sm text-slate-400 mb-2">Time Slot Options</label>
                  <div className="space-y-2">
                    {form.slots.map((slot, i) => (
                      <div key={i} className="flex gap-2">
                        <select value={slot.day} onChange={e => updateSlot(i, 'day', e.target.value)}
                          className="flex-1 bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm">
                          <option value="">Select day</option>
                          {['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'].map(d => (
                            <option key={d} value={d}>{d}</option>
                          ))}
                        </select>
                        <input type="text" value={slot.time} onChange={e => updateSlot(i, 'time', e.target.value)}
                          placeholder="e.g., 5:00 PM - 7:00 PM"
                          className="flex-1 bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm" />
                        <button onClick={() => removeSlot(i)} className="text-red-400 hover:text-red-300 px-2"><X className="w-4 h-4" /></button>
                      </div>
                    ))}
                    <button onClick={addSlot}
                      className="w-full px-4 py-2 border border-dashed border-slate-700 rounded-xl text-slate-400 hover:text-white hover:border-[var(--accent-primary)]/30">
                      + Add Time Slot
                    </button>
                  </div>
                </div>

                <div>
                  <label className="block text-sm text-slate-400 mb-2">Response Deadline (optional)</label>
                  <input type="date" value={form.deadline} onChange={e => setForm({...form, deadline: e.target.value})}
                    className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white" />
                </div>
              </div>
            </div>
          </div>
        ) : (
          // View survey results
          <div className="p-6">
            <button onClick={() => setStep('create')} className="text-slate-400 hover:text-white mb-4 flex items-center gap-2">
              ‚Üê Back to surveys
            </button>
            
            {selectedSurvey && (
              <div className="space-y-6">
                <div>
                  <h3 className="text-lg font-semibold text-white">{selectedSurvey.title}</h3>
                  <p className="text-sm text-slate-400">{selectedSurvey.responses?.length || 0} responses received</p>
                </div>

                {/* Results heatmap */}
                <div className="bg-slate-900 rounded-xl p-4">
                  <h4 className="text-sm font-medium text-white mb-4">Availability Summary</h4>
                  <div className="space-y-3">
                    {selectedSurvey.slots.map((slot, i) => {
                      const available = selectedSurvey.responses?.filter(r => r.available?.includes(i)).length || 0
                      const notAvailable = selectedSurvey.responses?.filter(r => r.notAvailable?.includes(i)).length || 0
                      const total = selectedSurvey.responses?.length || 1
                      const percentage = Math.round((available / total) * 100)
                      
                      return (
                        <div key={i} className="flex items-center gap-4">
                          <div className="w-40 text-sm text-white">
                            {slot.day} {slot.time}
                          </div>
                          <div className="flex-1 bg-slate-700 rounded-full h-6 overflow-hidden">
                            <div 
                              className="h-full rounded-full transition-all"
                              style={{ 
                                width: `${percentage}%`,
                                backgroundColor: percentage >= 70 ? '#10B981' : percentage >= 40 ? '#F59E0B' : '#EF4444'
                              }}
                            />
                          </div>
                          <div className="w-24 text-right text-sm">
                            <span className="text-emerald-400">{available}‚úì</span>
                            <span className="text-slate-500 mx-1">/</span>
                            <span className="text-red-400">{notAvailable}‚úó</span>
                          </div>
                        </div>
                      )
                    })}
                  </div>
                </div>

                {/* Individual responses */}
                {selectedSurvey.responses?.length > 0 && (
                  <div>
                    <h4 className="text-sm font-medium text-white mb-3">Individual Responses</h4>
                    <div className="space-y-2 max-h-60 overflow-y-auto">
                      {selectedSurvey.responses.map((response, i) => (
                        <div key={i} className="bg-slate-900 rounded-lg p-3 text-sm">
                          <p className="text-white font-medium">{response.name}</p>
                          <p className="text-slate-400 text-xs">
                            Available: {response.available?.map(idx => selectedSurvey.slots[idx]?.day).join(', ') || 'None'}
                          </p>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                <div className="flex gap-3">
                  <button onClick={() => copyShareLink(selectedSurvey.id)}
                    className="flex-1 px-4 py-2 bg-blue-500/20 text-blue-400 rounded-xl hover:bg-blue-500/30">
                    üìã Copy Share Link
                  </button>
                </div>
              </div>
            )}
          </div>
        )}

        <div className="p-6 border-t border-slate-700 flex justify-end gap-3 sticky bottom-0 bg-slate-800">
          <button onClick={onClose} className="px-6 py-2 rounded-xl border border-slate-700 text-white">Close</button>
          {step === 'create' && (
            <button onClick={createSurvey} disabled={form.slots.length === 0}
              className="px-6 py-2 rounded-xl bg-[var(--accent-primary)] text-white font-semibold disabled:opacity-50">
              Create Survey
            </button>
          )}
        </div>
      </div>
    </div>
  )
}

// ============================================
// EVENT DETAIL MODAL (VIEW/EDIT)
// ============================================
function EventDetailModal({ event, teams, venues, onClose, onUpdate, onDelete, activeView, showToast }) {
  const { isAdmin: hasAdminRole, profile, user } = useAuth()
  // Use activeView if provided, otherwise fall back to admin role check
  const isAdminView = activeView ? (activeView === 'admin' || activeView === 'coach') : hasAdminRole
  const isCoachView = activeView === 'coach'
  const [activeTab, setActiveTab] = useState('details')
  const [isEditing, setIsEditing] = useState(false)
  const [loading, setLoading] = useState(true)
  const [showLineupBuilder, setShowLineupBuilder] = useState(false)
  
  // Rich data
  const [roster, setRoster] = useState([])
  const [rsvps, setRsvps] = useState({})
  const [volunteers, setVolunteers] = useState([])
  const [coaches, setCoaches] = useState([])
  const [selectedPlayer, setSelectedPlayer] = useState(null)
  const [selectedCoach, setSelectedCoach] = useState(null)
  
  // View controls
  const [showPhotos, setShowPhotos] = useState(true)
  const [availableParents, setAvailableParents] = useState([])
  const [volunteerAssignModal, setVolunteerAssignModal] = useState(null)
  
  const [form, setForm] = useState({
    team_id: event.team_id || '',
    event_type: event.event_type || 'practice',
    title: event.title || '',
    description: event.description || '',
    start_date: event.event_date || (event.start_time ? new Date(event.start_time).toISOString().split('T')[0] : ''),
    start_time: event.event_time || (event.start_time ? new Date(event.start_time).toTimeString().slice(0, 5) : ''),
    end_time: event.end_time || '',
    venue_name: event.venue_name || '',
    venue_address: event.venue_address || '',
    location_type: event.location_type || 'home',
    opponent_name: event.opponent_name || ''
  })

  useEffect(() => {
    if (event?.id) loadEventData()
  }, [event?.id])

  async function loadEventData() {
    setLoading(true)
    try {
      // Load team roster if team is assigned
      if (event.team_id) {
        const { data: teamPlayers } = await supabase
          .from('team_players')
          .select('*, players(id, first_name, last_name, jersey_number, position, photo_url, grade, status)')
          .eq('team_id', event.team_id)
        setRoster(teamPlayers?.map(tp => tp.players).filter(Boolean) || [])

        // Load coaches for this team
        const { data: teamCoaches } = await supabase
          .from('team_coaches')
          .select('*, coaches(id, first_name, last_name, email, phone, role, photo_url)')
          .eq('team_id', event.team_id)
        setCoaches(teamCoaches?.map(tc => tc.coaches).filter(Boolean) || [])
      }

      // Load RSVPs for this event
      const { data: rsvpData } = await supabase
        .from('event_rsvps')
        .select('*')
        .eq('event_id', event.id)
      
      const rsvpMap = {}
      rsvpData?.forEach(r => { rsvpMap[r.player_id] = r })
      setRsvps(rsvpMap)

      // Load volunteers for this event
      const { data: volunteerData } = await supabase
        .from('event_volunteers')
        .select('*, profiles(id, full_name, email)')
        .eq('event_id', event.id)
      setVolunteers(volunteerData || [])

      // Load available parents for volunteer assignment
      const { data: parentsData } = await supabase
        .from('profiles')
        .select('id, first_name, last_name, full_name, email')
        .order('first_name')
      setAvailableParents(parentsData || [])

    } catch (err) {
      console.error('Error loading event data:', err)
    }
    setLoading(false)
  }

  async function updateRsvp(playerId, status) {
    const existing = rsvps[playerId]
    
    if (existing) {
      await supabase.from('event_rsvps')
        .update({ status, updated_at: new Date().toISOString() })
        .eq('id', existing.id)
    } else {
      await supabase.from('event_rsvps').insert({
        event_id: event.id,
        player_id: playerId,
        status,
        responded_at: new Date().toISOString()
      })
    }
    
    // Refresh RSVPs
    const { data: rsvpData } = await supabase
      .from('event_rsvps')
      .select('*')
      .eq('event_id', event.id)
    
    const rsvpMap = {}
    rsvpData?.forEach(r => { rsvpMap[r.player_id] = r })
    setRsvps(rsvpMap)
  }

  async function removeVolunteer(volunteerId) {
    await supabase.from('event_volunteers').delete().eq('id', volunteerId)
    setVolunteers(volunteers.filter(v => v.id !== volunteerId))
  }

  async function assignVolunteer(role, position, profileId) {
    // Check if slot is taken
    const existing = volunteers.find(v => v.role === role && v.position === position)
    if (existing) return

    const { data, error } = await supabase
      .from('event_volunteers')
      .insert({
        event_id: event.id,
        profile_id: profileId,
        role,
        position
      })
      .select('*, profiles(id, full_name, email)')
      .single()

    if (!error && data) {
      setVolunteers([...volunteers, data])
    }
  }

  async function handleSave() {
    const success = await onUpdate(event.id, {
      team_id: form.team_id || null,
      event_type: form.event_type,
      title: form.title,
      description: form.description,
      event_date: form.start_date,
      event_time: form.start_time,
      end_time: form.end_time,
      venue_name: form.venue_name,
      venue_address: form.venue_address,
      location_type: form.location_type,
      opponent_name: form.opponent_name
    })
    if (success) {
      setIsEditing(false)
      loadEventData()
    }
  }

  // RSVP counts
  const rsvpCounts = {
    yes: Object.values(rsvps).filter(r => r.status === 'yes').length,
    no: Object.values(rsvps).filter(r => r.status === 'no').length,
    maybe: Object.values(rsvps).filter(r => r.status === 'maybe').length,
    pending: roster.length - Object.keys(rsvps).length
  }

  // Volunteer helpers
  const getVolunteer = (role, position) => volunteers.find(v => v.role === role && v.position === position)
  const isGame = event.event_type === 'game'

  const tabs = [
    { id: 'details', label: 'Details', icon: 'clipboard' },
    { id: 'roster', label: `Roster (${roster.length})`, icon: 'users' },
    { id: 'rsvp', label: `RSVPs`, icon: '‚úì', badge: rsvpCounts.pending > 0 ? rsvpCounts.pending : null },
    ...(isGame ? [{ id: 'volunteers', label: 'Volunteers', icon: 'üôã' }] : []),
    { id: 'coaches', label: `Coaches (${coaches.length})`, icon: 'user-cog' },
    ...(isGame && isAdminView ? [{ id: 'gameprep', label: 'Game Prep', icon: 'volleyball' }] : [])
  ]

  const teamColor = event.teams?.color || '#EAB308'

  return (
    <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
      <div className="bg-slate-800 border border-slate-700 rounded-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
        {/* Header */}
        <div className="p-4 border-b border-slate-700 flex items-center justify-between" style={{ borderLeftColor: teamColor, borderLeftWidth: 4 }}>
          <div className="flex items-center gap-4">
            <span className="text-3xl">{event.event_type === 'game' ? 'practice' : event.event_type === 'practice' ? 'üèÉ' : event.event_type === 'tournament' ? 'üèÜ' : 'üìÖ'}</span>
            <div>
              <div className="flex items-center gap-2">
                <h2 className="text-xl font-bold text-white">{event.title || (event.event_type === 'game' ? `vs ${event.opponent_name || 'TBD'}` : event.event_type)}</h2>
                <span className="px-2 py-0.5 rounded text-xs font-medium" style={{ backgroundColor: getEventColor(event.event_type) + '30', color: getEventColor(event.event_type) }}>
                  {event.event_type}
                </span>
              </div>
              <p className="text-slate-400 text-sm">
                {event.event_date ? new Date(event.event_date + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' }) : ''}
                {event.event_time && ` ‚Ä¢ ${formatTime12(event.event_time)}`}
                {event.teams?.name && ` ‚Ä¢ ${event.teams.name}`}
              </p>
            </div>
          </div>
          <div className="flex items-center gap-2">
            <button
              onClick={() => setShowPhotos(!showPhotos)}
              className={`p-2 rounded-lg transition ${showPhotos ? 'bg-slate-700 text-white' : 'text-slate-500'}`}
              title={showPhotos ? 'Hide Photos' : 'Show Photos'}
            >
              üì∑
            </button>
            <button onClick={onClose} className="text-slate-400 hover:text-white text-2xl p-2">√ó</button>
          </div>
        </div>

        {/* Tabs */}
        <div className="flex border-b border-slate-700 px-4">
          {tabs.map(tab => (
            <button
              key={tab.id}
              onClick={() => setActiveTab(tab.id)}
              className={`px-4 py-3 text-sm font-medium transition flex items-center gap-2 ${
                activeTab === tab.id 
                  ? 'text-[var(--accent-primary)] border-b-2 border-[var(--accent-primary)]' 
                  : 'text-slate-500 hover:text-gray-300'
              }`}
            >
              <span>{tab.icon}</span>
              <span>{tab.label}</span>
              {tab.badge && (
                <span className="px-1.5 py-0.5 rounded-full text-xs bg-red-500/20 text-red-400">{tab.badge}</span>
              )}
            </button>
          ))}
        </div>

        {/* Tab Content */}
        <div className="flex-1 overflow-y-auto p-6">
          {loading ? (
            <div className="text-center py-12 text-slate-400">Loading event details...</div>
          ) : (
            <>
              {/* Details Tab */}
              {activeTab === 'details' && (
                isEditing ? (
                  <div className="space-y-4 max-w-2xl">
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm text-slate-400 mb-2">Event Type</label>
                        <select value={form.event_type} onChange={e => setForm({...form, event_type: e.target.value})}
                          className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white">
                          <option value="practice">Practice</option>
                          <option value="game">Game</option>
                          <option value="tournament">Tournament</option>
                          <option value="team_event">Team Event</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm text-slate-400 mb-2">Team</label>
                        <select value={form.team_id} onChange={e => setForm({...form, team_id: e.target.value})}
                          className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white">
                          <option value="">All Teams</option>
                          {teams.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}
                        </select>
                      </div>
                    </div>

                    <div>
                      <label className="block text-sm text-slate-400 mb-2">Title</label>
                      <input type="text" value={form.title} onChange={e => setForm({...form, title: e.target.value})}
                        placeholder="e.g., Week 3 Practice"
                        className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white" />
                    </div>

                    <div className="grid grid-cols-3 gap-4">
                      <div>
                        <label className="block text-sm text-slate-400 mb-2">Date</label>
                        <input type="date" value={form.start_date} onChange={e => setForm({...form, start_date: e.target.value})}
                          className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white" />
                      </div>
                      <div>
                        <label className="block text-sm text-slate-400 mb-2">Start Time</label>
                        <input type="time" value={form.start_time} onChange={e => setForm({...form, start_time: e.target.value})}
                          className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white" />
                      </div>
                      <div>
                        <label className="block text-sm text-slate-400 mb-2">End Time</label>
                        <input type="time" value={form.end_time} onChange={e => setForm({...form, end_time: e.target.value})}
                          className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white" />
                      </div>
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm text-slate-400 mb-2">Venue</label>
                        <input type="text" value={form.venue_name} onChange={e => setForm({...form, venue_name: e.target.value})}
                          className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white" />
                      </div>
                      <div>
                        <label className="block text-sm text-slate-400 mb-2">Address</label>
                        <input type="text" value={form.venue_address} onChange={e => setForm({...form, venue_address: e.target.value})}
                          className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white" />
                      </div>
                    </div>

                    {form.event_type === 'game' && (
                      <div className="grid grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm text-slate-400 mb-2">Opponent</label>
                          <input type="text" value={form.opponent_name} onChange={e => setForm({...form, opponent_name: e.target.value})}
                            className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white" />
                        </div>
                        <div>
                          <label className="block text-sm text-slate-400 mb-2">Location Type</label>
                          <select value={form.location_type} onChange={e => setForm({...form, location_type: e.target.value})}
                            className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white">
                            <option value="home">Home</option>
                            <option value="away">Away</option>
                            <option value="neutral">Neutral</option>
                          </select>
                        </div>
                      </div>
                    )}

                    <div>
                      <label className="block text-sm text-slate-400 mb-2">Notes</label>
                      <textarea value={form.description} onChange={e => setForm({...form, description: e.target.value})}
                        className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white min-h-[80px]" />
                    </div>
                  </div>
                ) : (
                  <div className="grid grid-cols-2 gap-6">
                    {/* Left Column - Event Info */}
                    <div className="space-y-4">
                      <div className="bg-slate-900 rounded-xl p-4 space-y-3">
                        <h4 className="text-sm font-semibold text-slate-400 uppercase">Event Information</h4>
                        <div className="grid grid-cols-2 gap-3">
                          <DetailItem label="Date" value={event.event_date ? new Date(event.event_date + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' }) : 'TBD'} />
                          <DetailItem label="Time" value={event.event_time ? `${formatTime12(event.event_time)}${event.end_time ? ` - ${formatTime12(event.end_time)}` : ''}` : 'TBD'} />
                        </div>
                        {event.venue_name && <DetailItem label="Venue" value={event.venue_name} />}
                        {event.venue_address && <DetailItem label="Address" value={event.venue_address} />}
                        {event.teams?.name && <DetailItem label="Team" value={event.teams.name} highlight={teamColor} />}
                        {event.opponent_name && <DetailItem label="Opponent" value={event.opponent_name} />}
                        {event.location_type && isGame && <DetailItem label="Location" value={event.location_type.charAt(0).toUpperCase() + event.location_type.slice(1)} />}
                      </div>

                      {event.description && (
                        <div className="bg-slate-900 rounded-xl p-4">
                          <h4 className="text-sm font-semibold text-slate-400 uppercase mb-2">Notes</h4>
                          <p className="text-white text-sm">{event.description}</p>
                        </div>
                      )}
                    </div>

                    {/* Right Column - Quick Stats */}
                    <div className="space-y-4">
                      {/* RSVP Summary */}
                      <div className="bg-slate-900 rounded-xl p-4">
                        <div className="flex items-center justify-between mb-3">
                          <h4 className="text-sm font-semibold text-slate-400 uppercase">RSVP Summary</h4>
                          <button 
                            onClick={() => setActiveTab('rsvp')}
                            className="text-xs text-[var(--accent-primary)] hover:underline"
                          >
                            View All ‚Üí
                          </button>
                        </div>
                        <div className="grid grid-cols-4 gap-2">
                          <button 
                            onClick={() => setActiveTab('rsvp')}
                            className="text-center p-2 rounded-lg bg-emerald-500/10 hover:bg-emerald-500/20 transition cursor-pointer"
                          >
                            <div className="text-xl font-bold text-emerald-400">{rsvpCounts.yes}</div>
                            <div className="text-xs text-emerald-400">Going</div>
                          </button>
                          <button 
                            onClick={() => setActiveTab('rsvp')}
                            className="text-center p-2 rounded-lg bg-red-500/10 hover:bg-red-500/20 transition cursor-pointer"
                          >
                            <div className="text-xl font-bold text-red-400">{rsvpCounts.no}</div>
                            <div className="text-xs text-red-400">No</div>
                          </button>
                          <button 
                            onClick={() => setActiveTab('rsvp')}
                            className="text-center p-2 rounded-lg bg-[var(--accent-primary)]/10 hover:bg-[var(--accent-primary)]/20 transition cursor-pointer"
                          >
                            <div className="text-xl font-bold text-[var(--accent-primary)]">{rsvpCounts.maybe}</div>
                            <div className="text-xs text-[var(--accent-primary)]">Maybe</div>
                          </button>
                          <button 
                            onClick={() => setActiveTab('rsvp')}
                            className="text-center p-2 rounded-lg bg-gray-500/10 hover:bg-gray-500/20 transition cursor-pointer"
                          >
                            <div className="text-xl font-bold text-slate-400">{rsvpCounts.pending}</div>
                            <div className="text-xs text-slate-400">Pending</div>
                          </button>
                        </div>
                      </div>

                      {/* Volunteers Summary (Games only) */}
                      {isGame && (
                        <div className="bg-slate-900 rounded-xl p-4">
                          <h4 className="text-sm font-semibold text-slate-400 uppercase mb-3">Volunteers</h4>
                          <div className="space-y-2">
                            <VolunteerSlot 
                              role="Line Judge" 
                              volunteer={getVolunteer('line_judge', 'primary')} 
                              icon="üö©"
                              onClick={() => setActiveTab('volunteers')}
                            />
                            <VolunteerSlot 
                              role="Scorekeeper" 
                              volunteer={getVolunteer('scorekeeper', 'primary')} 
                              icon="clipboard"
                              onClick={() => setActiveTab('volunteers')}
                            />
                          </div>
                        </div>
                      )}

                      {/* Coaches */}
                      {coaches.length > 0 && (
                        <div className="bg-slate-900 rounded-xl p-4">
                          <h4 className="text-sm font-semibold text-slate-400 uppercase mb-3">Coaches</h4>
                          <div className="space-y-2">
                            {coaches.map(coach => (
                              <div key={coach.id} className="flex items-center gap-3 p-2 rounded-lg bg-slate-800">
                                {showPhotos && coach.photo_url ? (
                                  <img src={coach.photo_url} alt="" className="w-8 h-8 rounded-full object-cover" />
                                ) : (
                                  <div className="w-8 h-8 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-400 text-sm">Coach</div>
                                )}
                                <div>
                                  <ClickableCoachName 
                                    coach={coach}
                                    onCoachSelect={setSelectedCoach}
                                    className="text-white text-sm"
                                  />
                                  <div className="text-xs text-slate-500">{coach.role || 'Coach'}</div>
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                )
              )}

              {/* Roster Tab */}
              {activeTab === 'roster' && (
                <div>
                  {roster.length === 0 ? (
                    <div className="text-center py-12">
                      <Users className="w-10 h-10" />
                      <p className="text-slate-400 mt-4">No players on roster</p>
                      {!event.team_id && <p className="text-slate-500 text-sm mt-2">Assign a team to see roster</p>}
                    </div>
                  ) : (
                    <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                      {roster.map(player => (
                        <PlayerCard
                          key={player.id}
                          player={player}
                          context="attendance"
                          teamColor={teamColor}
                          showPhoto={showPhotos}
                          size="small"
                          onClick={() => setSelectedPlayer(player)}
                        />
                      ))}
                    </div>
                  )}
                </div>
              )}

              {/* RSVP Tab */}
              {activeTab === 'rsvp' && (
                <div>
                  {/* RSVP Summary Cards */}
                  <div className="grid grid-cols-4 gap-4 mb-6">
                    <div className="bg-emerald-500/10 border border-emerald-500/30 rounded-xl p-4 text-center">
                      <div className="text-3xl font-bold text-emerald-400">{rsvpCounts.yes}</div>
                      <div className="text-sm text-emerald-400">Going</div>
                    </div>
                    <div className="bg-red-500/10 border border-red-500/30 rounded-xl p-4 text-center">
                      <div className="text-3xl font-bold text-red-400">{rsvpCounts.no}</div>
                      <div className="text-sm text-red-400">Can't Go</div>
                    </div>
                    <div className="bg-[var(--accent-primary)]/10 border border-[var(--accent-primary)]/30 rounded-xl p-4 text-center">
                      <div className="text-3xl font-bold text-[var(--accent-primary)]">{rsvpCounts.maybe}</div>
                      <div className="text-sm text-[var(--accent-primary)]">Maybe</div>
                    </div>
                    <div className="bg-gray-500/10 border border-gray-500/30 rounded-xl p-4 text-center">
                      <div className="text-3xl font-bold text-slate-400">{rsvpCounts.pending}</div>
                      <div className="text-sm text-slate-400">Pending</div>
                    </div>
                  </div>

                  {/* Player RSVP List */}
                  {roster.length === 0 ? (
                    <div className="text-center py-8 text-slate-400">
                      {!event.team_id ? 'Assign a team to manage RSVPs' : 'No players on roster'}
                    </div>
                  ) : (
                    <div className="space-y-2">
                      {roster.map(player => {
                        const rsvp = rsvps[player.id]
                        return (
                          <div key={player.id} className="bg-slate-900 rounded-xl p-3 flex items-center justify-between">
                            <div className="flex items-center gap-3 cursor-pointer" onClick={() => setSelectedPlayer(player)}>
                              {showPhotos && (
                                player.photo_url ? (
                                  <img src={player.photo_url} alt="" className="w-10 h-10 rounded-full object-cover" />
                                ) : (
                                  <div className="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-slate-500"><User className="w-6 h-6" /></div>
                                )
                              )}
                              {player.jersey_number && (
                                <span className="w-8 h-8 rounded flex items-center justify-center text-sm font-bold" style={{ backgroundColor: teamColor + '30', color: teamColor }}>
                                  {player.jersey_number}
                                </span>
                              )}
                              <div>
                                <div className="text-white font-medium">{player.first_name} {player.last_name}</div>
                                <div className="text-xs text-slate-500">
                                  {player.position && <span className="mr-2">{player.position}</span>}
                                  {player.grade && <span>Grade {player.grade}</span>}
                                </div>
                              </div>
                            </div>
                            <div className="flex gap-2">
                              <button
                                onClick={() => updateRsvp(player.id, 'yes')}
                                className={`px-3 py-1.5 rounded-lg text-sm font-medium transition ${
                                  rsvp?.status === 'yes' ? 'bg-emerald-500 text-white' : 'bg-slate-700 text-slate-400 hover:bg-emerald-500/20 hover:text-emerald-400'
                                }`}
                              >
                                ‚úì Yes
                              </button>
                              <button
                                onClick={() => updateRsvp(player.id, 'no')}
                                className={`px-3 py-1.5 rounded-lg text-sm font-medium transition ${
                                  rsvp?.status === 'no' ? 'bg-red-500 text-white' : 'bg-slate-700 text-slate-400 hover:bg-red-500/20 hover:text-red-400'
                                }`}
                              >
                                ‚úó No
                              </button>
                              <button
                                onClick={() => updateRsvp(player.id, 'maybe')}
                                className={`px-3 py-1.5 rounded-lg text-sm font-medium transition ${
                                  rsvp?.status === 'maybe' ? 'bg-yellow-500 text-black' : 'bg-slate-700 text-slate-400 hover:bg-[var(--accent-primary)]/20 hover:text-[var(--accent-primary)]'
                                }`}
                              >
                                ? Maybe
                              </button>
                            </div>
                          </div>
                        )
                      })}
                    </div>
                  )}
                </div>
              )}

              {/* Volunteers Tab */}
              {activeTab === 'volunteers' && isGame && (
                <div className="space-y-6">
                  {/* Current user's volunteer status */}
                  {!isAdminView && user?.id && (
                    <div className={`p-4 rounded-xl ${volunteers.some(v => v.profile_id === user.id) ? 'bg-emerald-500/10 border border-emerald-500/30' : 'bg-[var(--accent-primary)]/10 border border-[var(--accent-primary)]/30'}`}>
                      {volunteers.some(v => v.profile_id === user.id) ? (
                        <div className="flex items-center gap-2">
                          <CheckSquare className="w-6 h-6" />
                          <div>
                            <p className="text-emerald-400 font-medium">You're signed up!</p>
                            <p className="text-emerald-400/70 text-sm">
                              {volunteers.find(v => v.profile_id === user.id)?.role === 'line_judge' ? 'Line Judge' : 'Scorekeeper'}
                              {' - '}
                              {volunteers.find(v => v.profile_id === user.id)?.position === 'primary' ? 'Primary' : 'Backup'}
                            </p>
                          </div>
                        </div>
                      ) : (
                        <div className="flex items-center gap-2">
                          <span className="text-2xl">üôã</span>
                          <div>
                            <p className="text-[var(--accent-primary)] font-medium">Volunteers needed!</p>
                            <p className="text-[var(--accent-primary)]/70 text-sm">Click a slot below to sign up</p>
                          </div>
                        </div>
                      )}
                    </div>
                  )}

                  {/* Line Judge */}
                  <div className="bg-slate-900 rounded-xl p-4">
                    <h4 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                      <span>üö©</span> Line Judge
                    </h4>
                    <div className="space-y-2">
                      {['primary', 'backup_1', 'backup_2'].map(position => {
                        const volunteer = getVolunteer('line_judge', position)
                        const isAssigning = volunteerAssignModal?.role === 'line_judge' && volunteerAssignModal?.position === position
                        const isCurrentUser = volunteer?.profile_id === user?.id
                        const userAlreadyVolunteering = volunteers.some(v => v.profile_id === user?.id)
                        
                        return (
                          <div key={position} className={`flex items-center justify-between p-3 rounded-lg ${isCurrentUser ? 'bg-emerald-500/10 border border-emerald-500/30' : 'bg-slate-800'}`}>
                            <div className="flex items-center gap-3">
                              <span className={position === 'primary' ? 'text-[var(--accent-primary)]' : 'text-slate-500'}>
                                {position === 'primary' ? Star : ''}
                              </span>
                              <span className="text-slate-400 text-sm w-20">{position === 'primary' ? 'Primary' : position.replace('_', ' ').replace('backup', 'Backup')}</span>
                              {volunteer ? (
                                <span className={isCurrentUser ? 'text-emerald-400 font-medium' : 'text-white'}>
                                  {isCurrentUser ? 'You' : (volunteer.profiles?.full_name || 'Volunteer')}
                                </span>
                              ) : isAdminView ? (
                                isAssigning ? (
                                  <div className="flex items-center gap-2">
                                    <select
                                      autoFocus
                                      onChange={(e) => {
                                        if (e.target.value) assignVolunteer('line_judge', position, e.target.value)
                                        setVolunteerAssignModal(null)
                                      }}
                                      onBlur={() => setVolunteerAssignModal(null)}
                                      className="bg-slate-700 border border-slate-700 rounded px-2 py-1 text-white text-sm"
                                    >
                                      <option value="">Select parent...</option>
                                      {availableParents.filter(p => !volunteers.some(v => v.profile_id === p.id)).map(parent => (
                                        <option key={parent.id} value={parent.id}>{parent.full_name || `${parent.first_name} ${parent.last_name}`}</option>
                                      ))}
                                    </select>
                                    <button onClick={() => setVolunteerAssignModal(null)} className="text-slate-500 hover:text-white"><X className="w-4 h-4" /></button>
                                  </div>
                                ) : (
                                  <button onClick={() => setVolunteerAssignModal({ role: 'line_judge', position })} className="text-[var(--accent-primary)] hover:underline text-sm">+ Assign</button>
                                )
                              ) : (
                                <button
                                  onClick={() => assignVolunteer('line_judge', position, user?.id)}
                                  disabled={userAlreadyVolunteering}
                                  className={`px-3 py-1 rounded-lg text-sm font-medium transition ${userAlreadyVolunteering ? 'bg-gray-500/20 text-slate-500 cursor-not-allowed' : 'bg-[var(--accent-primary)]/20 text-[var(--accent-primary)] hover:bg-yellow-400/30'}`}
                                >
                                  {userAlreadyVolunteering ? 'Open' : 'üôã Sign Up'}
                                </button>
                              )}
                            </div>
                            {volunteer && (isAdminView || isCurrentUser) && (
                              <button onClick={() => removeVolunteer(volunteer.id)} className="text-red-400 hover:text-red-300 text-sm">
                                {isCurrentUser ? 'Cancel' : 'Remove'}
                              </button>
                            )}
                          </div>
                        )
                      })}
                    </div>
                  </div>

                  {/* Scorekeeper */}
                  <div className="bg-slate-900 rounded-xl p-4">
                    <h4 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                      <ClipboardList className="w-5 h-5" /> Scorekeeper
                    </h4>
                    <div className="space-y-2">
                      {['primary', 'backup_1', 'backup_2'].map(position => {
                        const volunteer = getVolunteer('scorekeeper', position)
                        const isAssigning = volunteerAssignModal?.role === 'scorekeeper' && volunteerAssignModal?.position === position
                        const isCurrentUser = volunteer?.profile_id === user?.id
                        const userAlreadyVolunteering = volunteers.some(v => v.profile_id === user?.id)
                        
                        return (
                          <div key={position} className={`flex items-center justify-between p-3 rounded-lg ${isCurrentUser ? 'bg-emerald-500/10 border border-emerald-500/30' : 'bg-slate-800'}`}>
                            <div className="flex items-center gap-3">
                              <span className={position === 'primary' ? 'text-[var(--accent-primary)]' : 'text-slate-500'}>
                                {position === 'primary' ? Star : ''}
                              </span>
                              <span className="text-slate-400 text-sm w-20">{position === 'primary' ? 'Primary' : position.replace('_', ' ').replace('backup', 'Backup')}</span>
                              {volunteer ? (
                                <span className={isCurrentUser ? 'text-emerald-400 font-medium' : 'text-white'}>
                                  {isCurrentUser ? 'You' : (volunteer.profiles?.full_name || 'Volunteer')}
                                </span>
                              ) : isAdminView ? (
                                isAssigning ? (
                                  <div className="flex items-center gap-2">
                                    <select
                                      autoFocus
                                      onChange={(e) => {
                                        if (e.target.value) assignVolunteer('scorekeeper', position, e.target.value)
                                        setVolunteerAssignModal(null)
                                      }}
                                      onBlur={() => setVolunteerAssignModal(null)}
                                      className="bg-slate-700 border border-slate-700 rounded px-2 py-1 text-white text-sm"
                                    >
                                      <option value="">Select parent...</option>
                                      {availableParents.filter(p => !volunteers.some(v => v.profile_id === p.id)).map(parent => (
                                        <option key={parent.id} value={parent.id}>{parent.full_name || `${parent.first_name} ${parent.last_name}`}</option>
                                      ))}
                                    </select>
                                    <button onClick={() => setVolunteerAssignModal(null)} className="text-slate-500 hover:text-white"><X className="w-4 h-4" /></button>
                                  </div>
                                ) : (
                                  <button onClick={() => setVolunteerAssignModal({ role: 'scorekeeper', position })} className="text-[var(--accent-primary)] hover:underline text-sm">+ Assign</button>
                                )
                              ) : (
                                <button
                                  onClick={() => assignVolunteer('scorekeeper', position, user?.id)}
                                  disabled={userAlreadyVolunteering}
                                  className={`px-3 py-1 rounded-lg text-sm font-medium transition ${userAlreadyVolunteering ? 'bg-gray-500/20 text-slate-500 cursor-not-allowed' : 'bg-[var(--accent-primary)]/20 text-[var(--accent-primary)] hover:bg-yellow-400/30'}`}
                                >
                                  {userAlreadyVolunteering ? 'Open' : 'üôã Sign Up'}
                                </button>
                              )}
                            </div>
                            {volunteer && (isAdminView || isCurrentUser) && (
                              <button onClick={() => removeVolunteer(volunteer.id)} className="text-red-400 hover:text-red-300 text-sm">
                                {isCurrentUser ? 'Cancel' : 'Remove'}
                              </button>
                            )}
                          </div>
                        )
                      })}
                    </div>
                  </div>

                  <p className="text-slate-500 text-sm text-center">
                    {isAdminView ? 'Assign parents to volunteer slots above.' : 'Thank you for volunteering! Your help makes our league possible.'}
                  </p>
                </div>
              )}

              {/* Coaches Tab */}
              {activeTab === 'coaches' && (
                <div>
                  {coaches.length === 0 ? (
                    <div className="text-center py-12">
                      <span className="text-4xl">Coach</span>
                      <p className="text-slate-400 mt-4">No coaches assigned</p>
                      {!event.team_id && <p className="text-slate-500 text-sm mt-2">Assign a team to see coaches</p>}
                    </div>
                  ) : (
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      {coaches.map(coach => (
                        <div key={coach.id} className="bg-slate-900 rounded-xl p-4 flex items-center gap-4">
                          {showPhotos && coach.photo_url ? (
                            <img src={coach.photo_url} alt="" className="w-16 h-16 rounded-full object-cover" />
                          ) : (
                            <div className="w-16 h-16 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-400 text-2xl">Coach</div>
                          )}
                          <div className="flex-1">
                            <ClickableCoachName 
                              coach={coach}
                              onCoachSelect={setSelectedCoach}
                              className="text-white font-semibold text-lg"
                            />
                            <div className="text-slate-400 text-sm">{coach.role || 'Coach'}</div>
                            <div className="flex gap-4 mt-2">
                              {coach.email && (
                                <a href={`mailto:${coach.email}`} className="text-[var(--accent-primary)] hover:underline text-sm">Email</a>
                              )}
                              {coach.phone && (
                                <a href={`tel:${coach.phone}`} className="text-[var(--accent-primary)] hover:underline text-sm">Call</a>
                              )}
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              )}

              {/* Game Prep Tab - For coaches/admins on games */}
              {activeTab === 'gameprep' && isGame && (
                <div className="space-y-4">
                  {/* Quick Actions for Game Day */}
                  <div className="bg-slate-900 rounded-xl p-4">
                    <h4 className="text-sm font-semibold text-slate-400 uppercase mb-4">Game Day Prep</h4>
                    <div className="grid grid-cols-2 gap-3">
                      <button
                        onClick={() => setShowLineupBuilder(true)}
                        className="flex items-center gap-3 p-4 bg-[var(--accent-primary)]/20 rounded-xl hover:bg-[var(--accent-primary)]/30 transition text-left"
                      >
                        <ClipboardList className="w-7 h-7" />
                        <div>
                          <p className="text-white font-semibold">Set Lineup</p>
                          <p className="text-slate-400 text-xs">Build starting rotation</p>
                        </div>
                      </button>
                      
                      <button
                        onClick={() => setActiveTab('rsvp')}
                        className="flex items-center gap-3 p-4 bg-emerald-500/20 rounded-xl hover:bg-emerald-500/30 transition text-left"
                      >
                        <span className="text-2xl">‚úì</span>
                        <div>
                          <p className="text-white font-semibold">Check Attendance</p>
                          <p className="text-slate-400 text-xs">{rsvpCounts.yes} confirmed, {rsvpCounts.pending} pending</p>
                        </div>
                      </button>
                      
                      <button
                        onClick={() => setActiveTab('roster')}
                        className="flex items-center gap-3 p-4 bg-blue-500/20 rounded-xl hover:bg-blue-500/30 transition text-left"
                      >
                        <Users className="w-7 h-7" />
                        <div>
                          <p className="text-white font-semibold">View Roster</p>
                          <p className="text-slate-400 text-xs">{roster.length} players</p>
                        </div>
                      </button>
                      
                      <button
                        onClick={() => setActiveTab('volunteers')}
                        className="flex items-center gap-3 p-4 bg-purple-500/20 rounded-xl hover:bg-purple-500/30 transition text-left"
                      >
                        <span className="text-2xl">üôã</span>
                        <div>
                          <p className="text-white font-semibold">Volunteers</p>
                          <p className="text-slate-400 text-xs">{volunteers.length} assigned</p>
                        </div>
                      </button>
                    </div>
                  </div>
                  
                  {/* Game Info Summary */}
                  <div className="bg-slate-900 rounded-xl p-4">
                    <h4 className="text-sm font-semibold text-slate-400 uppercase mb-3">üìç Game Details</h4>
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <p className="text-slate-500 text-xs">Opponent</p>
                        <p className="text-white font-semibold text-lg">{event.opponent_name || 'TBD'}</p>
                      </div>
                      <div>
                        <p className="text-slate-500 text-xs">Location</p>
                        <p className="text-white font-semibold">{event.location_type === 'home' ? 'üè† Home' : event.location_type === 'away' ? '‚úàÔ∏è Away' : 'üèüÔ∏è Neutral'}</p>
                      </div>
                      <div>
                        <p className="text-slate-500 text-xs">Venue</p>
                        <p className="text-white">{event.venue_name || 'TBD'}</p>
                      </div>
                      <div>
                        <p className="text-slate-500 text-xs">Time</p>
                        <p className="text-white">{event.event_time ? formatTime12(event.event_time) : 'TBD'}</p>
                      </div>
                    </div>
                  </div>
                  
                  {/* Coach Notes */}
                  <div className="bg-slate-900 rounded-xl p-4">
                    <h4 className="text-sm font-semibold text-slate-400 uppercase mb-2">üìù Game Notes</h4>
                    <p className="text-slate-300 text-sm">{event.description || 'No notes added'}</p>
                  </div>
                </div>
              )}
            </>
          )}
        </div>

        {/* Footer Actions */}
        <div className="p-4 border-t border-slate-700 flex justify-between">
          <button onClick={() => onDelete(event.id)} className="px-4 py-2 text-red-400 hover:bg-red-500/10 rounded-xl">
            üóëÔ∏è Delete Event
          </button>
          <div className="flex gap-3">
            {isEditing ? (
              <>
                <button onClick={() => setIsEditing(false)} className="px-6 py-2 rounded-xl border border-slate-700 text-white">Cancel</button>
                <button onClick={handleSave} className="px-6 py-2 rounded-xl bg-[var(--accent-primary)] text-white font-semibold">Save Changes</button>
              </>
            ) : (
              <>
                <button onClick={onClose} className="px-6 py-2 rounded-xl border border-slate-700 text-white">Close</button>
                <button onClick={() => setIsEditing(true)} className="px-6 py-2 rounded-xl bg-blue-500/20 text-blue-400 hover:bg-blue-500/30"><Edit className="w-4 h-4 inline mr-1" />Edit Event</button>
              </>
            )}
          </div>
        </div>
      </div>

      {/* Player Card Expanded Modal */}
      {selectedPlayer && (
        <PlayerCardExpanded
          player={selectedPlayer}
          visible={!!selectedPlayer}
          onClose={() => setSelectedPlayer(null)}
          context="attendance"
        />
      )}

      {/* Coach Detail Modal */}
      {selectedCoach && (
        <CoachDetailModal
          coach={selectedCoach}
          onClose={() => setSelectedCoach(null)}
        />
      )}

      {/* Lineup Builder Modal */}
      {showLineupBuilder && event.team_id && (
        <LineupBuilder
          event={event}
          team={teams?.find(t => t.id === event.team_id) || { id: event.team_id, name: event.teams?.name }}
          onClose={() => setShowLineupBuilder(false)}
          showToast={showToast}
        />
      )}
    </div>
  )
}

// Helper components for Rich Event Modal
function DetailItem({ label, value, highlight }) {
  return (
    <div>
      <div className="text-xs text-slate-500">{label}</div>
      <div className="text-white font-medium" style={highlight ? { color: highlight } : {}}>{value || '‚Äî'}</div>
    </div>
  )
}

function VolunteerSlot({ role, volunteer, icon, onClick }) {
  return (
    <div className="flex items-center justify-between p-2 bg-slate-800 rounded-lg">
      <div className="flex items-center gap-2">
        <span>{icon}</span>
        <span className="text-slate-400 text-sm">{role}</span>
      </div>
      {volunteer ? (
        <span className="text-emerald-400 text-sm">{volunteer.profiles?.full_name || 'Assigned'}</span>
      ) : (
        <button 
          onClick={onClick}
          className="text-[var(--accent-primary)] text-sm hover:underline"
        >
          Need Volunteer ‚Üí
        </button>
      )}
    </div>
  )
}

function formatTime12(timeStr) {
  if (!timeStr) return ''
  const [hours, minutes] = timeStr.split(':')
  const h = parseInt(hours)
  const ampm = h >= 12 ? 'PM' : 'AM'
  const h12 = h % 12 || 12
  return `${h12}:${minutes} ${ampm}`
}

// ============================================
// COACHES PAGE
// ============================================
function CoachesPage({ showToast }) {
  const journey = useJourney()
  const { organization } = useAuth()
  const { selectedSeason } = useSeason()
  const [coaches, setCoaches] = useState([])
  const [teams, setTeams] = useState([])
  const [loading, setLoading] = useState(true)
  const [searchTerm, setSearchTerm] = useState('')
  const [filterStatus, setFilterStatus] = useState('active') // 'active', 'inactive', 'all'
  const [showAddModal, setShowAddModal] = useState(false)
  const [editingCoach, setEditingCoach] = useState(null)
  const [assigningCoach, setAssigningCoach] = useState(null)
  const [selectedCoachForDetail, setSelectedCoachForDetail] = useState(null)

  useEffect(() => {
    if (selectedSeason?.id) {
      loadCoaches()
      loadTeams()
    }
  }, [selectedSeason?.id])

  async function loadCoaches() {
    setLoading(true)
    try {
      // Load coaches for the current season (your schema uses season_id)
      const { data: coachesData, error: coachesError } = await supabase
        .from('coaches')
        .select('*')
        .eq('season_id', selectedSeason.id)
        .order('last_name', { ascending: true })

      if (coachesError) throw coachesError

      // Load team assignments using your team_coaches table
      const { data: assignmentsData } = await supabase
        .from('team_coaches')
        .select('*, teams(id, name, color)')
        .in('coach_id', (coachesData || []).map(c => c.id))

      // Attach assignments to coaches
      const coachesWithAssignments = (coachesData || []).map(coach => ({
        ...coach,
        assignments: (assignmentsData || []).filter(a => a.coach_id === coach.id)
      }))
      setCoaches(coachesWithAssignments)
    } catch (err) {
      console.error('Error loading coaches:', err)
      showToast('Error loading coaches', 'error')
    }
    setLoading(false)
  }

  async function loadTeams() {
    if (!selectedSeason?.id) return
    const { data } = await supabase
      .from('teams')
      .select('id, name, color')
      .eq('season_id', selectedSeason.id)
      .order('name')
    setTeams(data || [])
  }

  async function saveCoach(coachData) {
    try {
      if (editingCoach) {
        const { error } = await supabase
          .from('coaches')
          .update({ ...coachData, updated_at: new Date().toISOString() })
          .eq('id', editingCoach.id)
        if (error) throw error
        showToast('Coach updated!', 'success')
      } else {
        const { error } = await supabase
          .from('coaches')
          .insert({ ...coachData, season_id: selectedSeason.id })
        if (error) throw error
        showToast('Coach added!', 'success')
        // Complete journey step when adding NEW coach
        journey?.completeStep('add_coaches')
      }
      setEditingCoach(null)
      setShowAddModal(false)
      loadCoaches()
    } catch (err) {
      showToast('Error: ' + err.message, 'error')
    }
  }

  async function deleteCoach(coach) {
    if (!confirm(`Delete ${coach.first_name} ${coach.last_name}? This will also remove all team assignments.`)) return
    try {
      const { error } = await supabase.from('coaches').delete().eq('id', coach.id)
      if (error) throw error
      showToast('Coach deleted', 'success')
      loadCoaches()
    } catch (err) {
      showToast('Error: ' + err.message, 'error')
    }
  }

  async function toggleCoachStatus(coach) {
    const newStatus = coach.status === 'active' ? 'inactive' : 'active'
    try {
      const { error } = await supabase
        .from('coaches')
        .update({ status: newStatus, updated_at: new Date().toISOString() })
        .eq('id', coach.id)
      if (error) throw error
      showToast(newStatus === 'active' ? 'Coach activated' : 'Coach deactivated', 'success')
      loadCoaches()
    } catch (err) {
      showToast('Error: ' + err.message, 'error')
    }
  }

  async function saveAssignments(coachId, assignments) {
    try {
      // Get current assignments for this coach
      const { data: existingAssignments } = await supabase
        .from('team_coaches')
        .select('id, team_id')
        .eq('coach_id', coachId)

      const existingTeamIds = (existingAssignments || []).map(a => a.team_id)
      const newTeamIds = assignments.map(a => a.team_id)

      // Delete removed assignments
      const toDelete = (existingAssignments || []).filter(a => !newTeamIds.includes(a.team_id))
      for (const del of toDelete) {
        await supabase.from('team_coaches').delete().eq('id', del.id)
        // Also remove from chat channels
        await removeCoachFromTeamChannels(coachId, del.team_id)
      }

      // Insert new assignments
      const toInsert = assignments.filter(a => !existingTeamIds.includes(a.team_id))
      if (toInsert.length > 0) {
        const { error } = await supabase
          .from('team_coaches')
          .insert(toInsert.map(a => ({
            coach_id: coachId,
            team_id: a.team_id,
            role: a.role
          })))
        if (error) throw error
        
        // Auto-add coach to chat channels for new teams
        for (const assignment of toInsert) {
          await autoAddCoachToTeamChannels(coachId, assignment.team_id)
        }
      }

      // Update existing assignments (role changes)
      const toUpdate = assignments.filter(a => existingTeamIds.includes(a.team_id))
      for (const upd of toUpdate) {
        const existing = existingAssignments.find(e => e.team_id === upd.team_id)
        if (existing) {
          await supabase.from('team_coaches').update({ role: upd.role }).eq('id', existing.id)
        }
      }

      showToast('Team assignments saved!', 'success')
      setAssigningCoach(null)
      loadCoaches()
    } catch (err) {
      showToast('Error: ' + err.message, 'error')
    }
  }
  
  // Helper: Auto-add coach to team chat channels
  async function autoAddCoachToTeamChannels(coachId, teamId) {
    try {
      // Get coach info
      const { data: coach } = await supabase
        .from('coaches')
        .select('id, first_name, last_name, user_id')
        .eq('id', coachId)
        .single()
      
      if (!coach || !coach.user_id) return // Coach needs a user account
      
      // Get team channels
      const { data: channels } = await supabase
        .from('chat_channels')
        .select('id, channel_type')
        .eq('team_id', teamId)
        .in('channel_type', ['team_chat', 'player_chat'])
      
      if (!channels || channels.length === 0) return
      
      // Add coach to both team_chat and player_chat
      for (const channel of channels) {
        const { data: existing } = await supabase
          .from('channel_members')
          .select('id')
          .eq('channel_id', channel.id)
          .eq('user_id', coach.user_id)
          .maybeSingle()
        
        if (!existing) {
          await supabase.from('channel_members').insert({
            channel_id: channel.id,
            user_id: coach.user_id,
            display_name: `Coach ${coach.first_name}`,
            member_role: 'coach',
            can_post: true,
            can_moderate: true // Coaches can delete messages
          })
        }
      }
    } catch (err) {
      console.error('Error auto-adding coach to channels:', err)
    }
  }
  
  // Helper: Remove coach from team chat channels
  async function removeCoachFromTeamChannels(coachId, teamId) {
    try {
      const { data: coach } = await supabase
        .from('coaches')
        .select('user_id')
        .eq('id', coachId)
        .single()
      
      if (!coach?.user_id) return
      
      const { data: channels } = await supabase
        .from('chat_channels')
        .select('id')
        .eq('team_id', teamId)
      
      if (channels) {
        for (const channel of channels) {
          await supabase
            .from('channel_members')
            .delete()
            .eq('channel_id', channel.id)
            .eq('user_id', coach.user_id)
        }
      }
    } catch (err) {
      console.error('Error removing coach from channels:', err)
    }
  }

  // Filter coaches
  const filteredCoaches = coaches.filter(c => {
    // Status filter
    if (filterStatus === 'active' && c.status !== 'active') return false
    if (filterStatus === 'inactive' && c.status === 'active') return false
    
    // Search filter
    if (searchTerm) {
      const search = searchTerm.toLowerCase()
      const fullName = `${c.first_name} ${c.last_name}`.toLowerCase()
      const email = (c.email || '').toLowerCase()
      if (!fullName.includes(search) && !email.includes(search)) return false
    }
    
    return true
  })

  const roleLabels = {
    head: 'Head Coach',
    assistant: 'Assistant Coach',
    manager: 'Team Manager',
    volunteer: 'Volunteer'
  }

  if (!selectedSeason) {
    return (
      <div className="p-8 text-center">
        <div className="text-6xl mb-4">Coach</div>
        <h2 className="text-xl font-semibold text-white mb-2">No Season Selected</h2>
        <p className="text-slate-400">Please select a season to manage coaches</p>
      </div>
    )
  }

  return (
    <div className="p-8 max-w-7xl mx-auto">
      {/* Header */}
      <div className="flex items-center justify-between mb-8">
        <div>
          <h1 className="text-3xl font-bold text-white">Coaches</h1>
          <p className="text-slate-400 mt-1">Manage coaches and team assignments ‚Ä¢ {selectedSeason.name}</p>
        </div>
        <button
          onClick={() => { setEditingCoach(null); setShowAddModal(true) }}
          className="px-6 py-3 bg-[var(--accent-primary)] text-white font-semibold rounded-xl hover:brightness-110 transition flex items-center gap-2"
        >
          <span className="text-xl">+</span> Add Coach
        </button>
      </div>

      {/* Filters */}
      <div className="flex gap-4 mb-6">
        <div className="relative flex-1 max-w-md">
          <input
            type="text"
            placeholder="Search coaches..."
            value={searchTerm}
            onChange={e => setSearchTerm(e.target.value)}
            className="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 pl-10 text-white placeholder-gray-500"
          />
          <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500">üîç</span>
        </div>
        <select
          value={filterStatus}
          onChange={e => setFilterStatus(e.target.value)}
          className="bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-white"
        >
          <option value="active">Active Coaches</option>
          <option value="inactive">Inactive Coaches</option>
          <option value="all">All Coaches</option>
        </select>
      </div>

      {/* Stats */}
      <div className="grid grid-cols-4 gap-4 mb-8">
        <div className="bg-slate-800 border border-slate-700 rounded-xl p-4">
          <div className="text-2xl font-bold text-white">{coaches.filter(c => c.status === 'active').length}</div>
          <div className="text-sm text-slate-400">Active Coaches</div>
        </div>
        <div className="bg-slate-800 border border-slate-700 rounded-xl p-4">
          <div className="text-2xl font-bold text-white">{coaches.length}</div>
          <div className="text-sm text-slate-400">Total Coaches</div>
        </div>
        <div className="bg-slate-800 border border-slate-700 rounded-xl p-4">
          <div className="text-2xl font-bold text-purple-400">
            {coaches.filter(c => c.assignments?.some(a => a.role === 'head')).length}
          </div>
          <div className="text-sm text-slate-400">Head Coaches</div>
        </div>
        <div className="bg-slate-800 border border-slate-700 rounded-xl p-4">
          <div className="text-2xl font-bold text-blue-400">
            {coaches.reduce((sum, c) => sum + (c.assignments?.length || 0), 0)}
          </div>
          <div className="text-sm text-slate-400">Team Assignments</div>
        </div>
      </div>

      {/* Coaches List */}
      {loading ? (
        <div className="text-center py-12 text-slate-400">Loading coaches...</div>
      ) : filteredCoaches.length === 0 ? (
        <div className="bg-slate-800 border border-slate-700 rounded-2xl p-12 text-center">
          <UserCog className="w-16 h-16 mx-auto mb-4 text-slate-500" />
          <h3 className="text-xl font-semibold text-white mb-2">No coaches found</h3>
          <p className="text-slate-400 mb-6">
            {searchTerm ? 'Try a different search term' : 'Add your first coach to get started'}
          </p>
          {!searchTerm && (
            <button
              onClick={() => setShowAddModal(true)}
              className="px-6 py-3 bg-[var(--accent-primary)] text-white font-semibold rounded-xl"
            >
              Add First Coach
            </button>
          )}
        </div>
      ) : (
        <div className="grid gap-4">
          {filteredCoaches.map(coach => (
            <div
              key={coach.id}
              className={`bg-slate-800 border border-slate-700 rounded-xl p-5 ${coach.status !== 'active' ? 'opacity-60' : ''}`}
            >
              <div className="flex items-start justify-between">
                <div className="flex items-start gap-4">
                  {/* Avatar */}
                  <div className="w-14 h-14 rounded-full bg-gradient-to-br from-yellow-400 to-orange-500 flex items-center justify-center text-xl font-bold text-black">
                    {coach.first_name?.[0]}{coach.last_name?.[0]}
                  </div>
                  
                  {/* Info */}
                  <div>
                    <div className="flex items-center gap-3">
                      <ClickableCoachName 
                        coach={coach}
                        onCoachSelect={setSelectedCoachForDetail}
                        className="text-lg font-semibold text-white"
                      />
                      {coach.experience_years && (
                        <span className="px-2 py-0.5 rounded-full text-xs font-medium bg-emerald-500/20 text-emerald-400">
                          {coach.experience_years} yrs exp
                        </span>
                      )}
                      {coach.status !== 'active' && (
                        <span className="px-2 py-0.5 rounded-full text-xs font-medium bg-red-500/20 text-red-400">
                          Inactive
                        </span>
                      )}
                    </div>
                    
                    {/* Contact */}
                    <div className="flex items-center gap-4 mt-1 text-sm text-slate-400">
                      {coach.email && (
                        <a href={`mailto:${coach.email}`} className="hover:text-white flex items-center gap-1">
                          <Mail className="w-4 h-4" /> {coach.email}
                        </a>
                      )}
                      {coach.phone && (
                        <a href={`tel:${coach.phone}`} className="hover:text-white flex items-center gap-1">
                          <Phone className="w-4 h-4" /> {coach.phone}
                        </a>
                      )}
                    </div>

                    {/* Specialties */}
                    {coach.specialties && (
                      <div className="text-sm text-slate-500 mt-1">
                        Specialties: {coach.specialties}
                      </div>
                    )}

                    {/* Team Assignments */}
                    {coach.assignments?.length > 0 && (
                      <div className="flex flex-wrap gap-2 mt-3">
                        {coach.assignments.map(a => (
                          <span
                            key={a.id}
                            className="px-2 py-1 rounded-lg text-xs font-medium flex items-center gap-1"
                            style={{ backgroundColor: `${a.teams?.color}20`, color: a.teams?.color || '#888' }}
                          >
                            {a.role === 'head' && <Star className="w-3 h-3" />} {a.teams?.name}
                            <span className="opacity-60">({roleLabels[a.role] || a.role})</span>
                          </span>
                        ))}
                      </div>
                    )}
                  </div>
                </div>

                {/* Right side - Emergency Contact & Actions */}
                <div className="flex items-start gap-4">
                  {/* Emergency Contact */}
                  {coach.emergency_contact_name && (
                    <div className="text-right text-sm">
                      <div className="text-slate-500">Emergency Contact</div>
                      <div className="text-slate-400">{coach.emergency_contact_name}</div>
                      {coach.emergency_contact_phone && (
                        <a href={`tel:${coach.emergency_contact_phone}`} className="text-slate-400 hover:text-white">
                          {coach.emergency_contact_phone}
                        </a>
                      )}
                    </div>
                  )}

                  {/* Actions */}
                  <div className="flex items-center gap-2">
                    <button
                      onClick={() => setAssigningCoach(coach)}
                      className="p-2 rounded-lg bg-slate-900 text-slate-400 hover:text-white hover:bg-slate-700 transition"
                      title="Assign to Teams"
                    >
                      <Users className="w-4 h-4" />
                    </button>
                    <button
                      onClick={() => { setEditingCoach(coach); setShowAddModal(true) }}
                      className="p-2 rounded-lg bg-slate-900 text-slate-400 hover:text-white hover:bg-slate-700 transition"
                      title="Edit"
                    >
                      <Edit className="w-4 h-4" />
                    </button>
                    <button
                      onClick={() => toggleCoachStatus(coach)}
                      className="p-2 rounded-lg bg-slate-900 text-slate-400 hover:text-white hover:bg-slate-700 transition"
                      title={coach.status === 'active' ? 'Deactivate' : 'Activate'}
                    >
                      {coach.status === 'active' ? <X className="w-4 h-4" /> : <Check className="w-4 h-4" />}
                    </button>
                    <button
                      onClick={() => deleteCoach(coach)}
                      className="p-2 rounded-lg bg-slate-900 text-red-400 hover:text-red-300 hover:bg-red-500/10 transition"
                      title="Delete"
                    >
                      <Trash2 className="w-4 h-4" />
                    </button>
                  </div>
                </div>
              </div>
            </div>
          ))}
        </div>
      )}

      {/* Add/Edit Coach Modal */}
      {showAddModal && (
        <CoachFormModal
          coach={editingCoach}
          onSave={saveCoach}
          onClose={() => { setShowAddModal(false); setEditingCoach(null) }}
        />
      )}

      {/* Assign Teams Modal */}
      {assigningCoach && (
        <AssignTeamsModal
          coach={assigningCoach}
          teams={teams}
          onSave={(assignments) => saveAssignments(assigningCoach.id, assignments)}
          onClose={() => setAssigningCoach(null)}
        />
      )}

      {/* Coach Detail Modal */}
      {selectedCoachForDetail && (
        <CoachDetailModal
          coach={selectedCoachForDetail}
          onClose={() => setSelectedCoachForDetail(null)}
        />
      )}
    </div>
  )
}

// Coach Form Modal - Updated for existing schema
function CoachFormModal({ coach, onSave, onClose }) {
  const [form, setForm] = useState({
    first_name: coach?.first_name || '',
    last_name: coach?.last_name || '',
    email: coach?.email || '',
    phone: coach?.phone || '',
    address: coach?.address || '',
    experience_years: coach?.experience_years || '',
    experience_details: coach?.experience_details || '',
    specialties: coach?.specialties || '',
    emergency_contact_name: coach?.emergency_contact_name || '',
    emergency_contact_phone: coach?.emergency_contact_phone || '',
    emergency_contact_relation: coach?.emergency_contact_relation || '',
    status: coach?.status || 'active',
    notes: coach?.notes || ''
  })

  function handleSubmit() {
    if (!form.first_name || !form.last_name) {
      alert('Please enter first and last name')
      return
    }
    onSave({
      ...form,
      experience_years: form.experience_years ? parseInt(form.experience_years) : null
    })
  }

  return (
    <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50">
      <div className="bg-slate-800 border border-slate-700 rounded-2xl w-full max-w-xl max-h-[90vh] overflow-y-auto">
        <div className="p-6 border-b border-slate-700 flex items-center justify-between sticky top-0 bg-slate-800">
          <h2 className="text-xl font-semibold text-white">{coach ? 'Edit Coach' : 'Add Coach'}</h2>
          <button onClick={onClose} className="text-slate-400 hover:text-white text-2xl">√ó</button>
        </div>
        <div className="p-6 space-y-4">
          {/* Name */}
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm text-slate-400 mb-2">First Name *</label>
              <input
                type="text"
                value={form.first_name}
                onChange={e => setForm({ ...form, first_name: e.target.value })}
                className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white"
                placeholder="John"
              />
            </div>
            <div>
              <label className="block text-sm text-slate-400 mb-2">Last Name *</label>
              <input
                type="text"
                value={form.last_name}
                onChange={e => setForm({ ...form, last_name: e.target.value })}
                className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white"
                placeholder="Smith"
              />
            </div>
          </div>

          {/* Contact */}
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm text-slate-400 mb-2">Email</label>
              <input
                type="email"
                value={form.email}
                onChange={e => setForm({ ...form, email: e.target.value })}
                className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white"
                placeholder="coach@email.com"
              />
            </div>
            <div>
              <label className="block text-sm text-slate-400 mb-2">Phone</label>
              <input
                type="tel"
                value={form.phone}
                onChange={e => setForm({ ...form, phone: e.target.value })}
                className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white"
                placeholder="(555) 555-5555"
              />
            </div>
          </div>

          {/* Address */}
          <div>
            <label className="block text-sm text-slate-400 mb-2">Address</label>
            <input
              type="text"
              value={form.address}
              onChange={e => setForm({ ...form, address: e.target.value })}
              className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white"
              placeholder="123 Main St, City, State"
            />
          </div>

          {/* Experience */}
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm text-slate-400 mb-2">Years of Experience</label>
              <input
                type="number"
                value={form.experience_years}
                onChange={e => setForm({ ...form, experience_years: e.target.value })}
                className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white"
                placeholder="5"
                min="0"
              />
            </div>
            <div>
              <label className="block text-sm text-slate-400 mb-2">Specialties</label>
              <input
                type="text"
                value={form.specialties}
                onChange={e => setForm({ ...form, specialties: e.target.value })}
                className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white"
                placeholder="Setting, Defense"
              />
            </div>
          </div>

          {/* Experience Details */}
          <div>
            <label className="block text-sm text-slate-400 mb-2">Experience Details</label>
            <textarea
              value={form.experience_details}
              onChange={e => setForm({ ...form, experience_details: e.target.value })}
              className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white h-20 resize-none"
              placeholder="Previous coaching experience, certifications, etc."
            />
          </div>

          {/* Emergency Contact */}
          <div className="bg-slate-900 rounded-xl p-4">
            <h4 className="text-sm font-medium text-white mb-3">Emergency Contact</h4>
            <div className="grid grid-cols-3 gap-3">
              <div>
                <label className="block text-xs text-slate-400 mb-1">Name</label>
                <input
                  type="text"
                  value={form.emergency_contact_name}
                  onChange={e => setForm({ ...form, emergency_contact_name: e.target.value })}
                  className="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white"
                  placeholder="Jane Doe"
                />
              </div>
              <div>
                <label className="block text-xs text-slate-400 mb-1">Phone</label>
                <input
                  type="tel"
                  value={form.emergency_contact_phone}
                  onChange={e => setForm({ ...form, emergency_contact_phone: e.target.value })}
                  className="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white"
                  placeholder="(555) 555-5555"
                />
              </div>
              <div>
                <label className="block text-xs text-slate-400 mb-1">Relationship</label>
                <input
                  type="text"
                  value={form.emergency_contact_relation}
                  onChange={e => setForm({ ...form, emergency_contact_relation: e.target.value })}
                  className="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white"
                  placeholder="Spouse"
                />
              </div>
            </div>
          </div>

          {/* Status */}
          <div>
            <label className="block text-sm text-slate-400 mb-2">Status</label>
            <select
              value={form.status}
              onChange={e => setForm({ ...form, status: e.target.value })}
              className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white"
            >
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
            </select>
          </div>

          {/* Notes */}
          <div>
            <label className="block text-sm text-slate-400 mb-2">Notes</label>
            <textarea
              value={form.notes}
              onChange={e => setForm({ ...form, notes: e.target.value })}
              className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white h-24 resize-none"
              placeholder="Additional notes..."
            />
          </div>
        </div>
        <div className="p-6 border-t border-slate-700 flex justify-end gap-3 sticky bottom-0 bg-slate-800">
          <button onClick={onClose} className="px-6 py-2 rounded-xl border border-slate-700 text-white">
            Cancel
          </button>
          <button onClick={handleSubmit} className="px-6 py-2 rounded-xl bg-[var(--accent-primary)] text-white font-semibold">
            {coach ? 'Save Changes' : 'Add Coach'}
          </button>
        </div>
      </div>
    </div>
  )
}

// Assign Teams Modal - Updated for existing schema
function AssignTeamsModal({ coach, teams, onSave, onClose }) {
  const [assignments, setAssignments] = useState(
    coach.assignments?.map(a => ({
      team_id: a.team_id,
      role: a.role
    })) || []
  )

  function toggleTeam(teamId) {
    const existing = assignments.find(a => a.team_id === teamId)
    if (existing) {
      setAssignments(assignments.filter(a => a.team_id !== teamId))
    } else {
      setAssignments([...assignments, { team_id: teamId, role: 'assistant' }])
    }
  }

  function updateRole(teamId, role) {
    setAssignments(assignments.map(a =>
      a.team_id === teamId ? { ...a, role } : a
    ))
  }

  return (
    <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50">
      <div className="bg-slate-800 border border-slate-700 rounded-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
        <div className="p-6 border-b border-slate-700 flex items-center justify-between sticky top-0 bg-slate-800">
          <div>
            <h2 className="text-xl font-semibold text-white">Assign Teams</h2>
            <p className="text-sm text-slate-400">{coach.first_name} {coach.last_name}</p>
          </div>
          <button onClick={onClose} className="text-slate-400 hover:text-white text-2xl">√ó</button>
        </div>
        <div className="p-6">
          {teams.length === 0 ? (
            <div className="text-center py-8 text-slate-400">
              <p>No teams in current season</p>
              <p className="text-sm mt-1">Create teams first to assign coaches</p>
            </div>
          ) : (
            <div className="space-y-3">
              {teams.map(team => {
                const assignment = assignments.find(a => a.team_id === team.id)
                const isAssigned = !!assignment
                
                return (
                  <div
                    key={team.id}
                    className={`p-4 rounded-xl border transition ${
                      isAssigned
                        ? 'border-[var(--accent-primary)]/50 bg-yellow-400/5'
                        : 'border-slate-700 bg-slate-900'
                    }`}
                  >
                    <label className="flex items-center gap-3 cursor-pointer">
                      <input
                        type="checkbox"
                        checked={isAssigned}
                        onChange={() => toggleTeam(team.id)}
                        className="w-5 h-5 rounded"
                      />
                      <span
                        className="w-3 h-3 rounded-full"
                        style={{ backgroundColor: team.color || '#888' }}
                      />
                      <span className="text-white font-medium">{team.name}</span>
                    </label>
                    
                    {isAssigned && (
                      <div className="mt-3 ml-8">
                        <select
                          value={assignment.role}
                          onChange={e => updateRole(team.id, e.target.value)}
                          className="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white"
                        >
                          <option value="head">Head Coach</option>
                          <option value="assistant">Assistant Coach</option>
                          <option value="manager">Team Manager</option>
                          <option value="volunteer">Volunteer</option>
                        </select>
                      </div>
                    )}
                  </div>
                )
              })}
            </div>
          )}
        </div>
        <div className="p-6 border-t border-slate-700 flex justify-between items-center sticky bottom-0 bg-slate-800">
          <span className="text-sm text-slate-400">
            {assignments.length} team{assignments.length !== 1 ? 's' : ''} selected
          </span>
          <div className="flex gap-3">
            <button onClick={onClose} className="px-6 py-2 rounded-xl border border-slate-700 text-white">
              Cancel
            </button>
            <button
              onClick={() => onSave(assignments)}
              className="px-6 py-2 rounded-xl bg-[var(--accent-primary)] text-white font-semibold"
            >
              Save Assignments
            </button>
          </div>
        </div>
      </div>
    </div>
  )
}


// ============================================
// JERSEY MANAGEMENT PAGE - ENHANCED
// Full league support, edit/unassign, size management, comprehensive export
// ============================================

// Helper to get jersey tasks count (for nav badge)
async function getJerseyTasksCount(seasonId) {
  if (!seasonId) return 0
  
  try {
    // Count players needing jerseys
    const { count: needsJersey } = await supabase
      .from('team_players')
      .select('*, teams!inner(season_id)', { count: 'exact', head: true })
      .eq('teams.season_id', seasonId)
      .is('jersey_number', null)

    // Count jerseys needing to be ordered
    const { count: needsOrder } = await supabase
      .from('jersey_assignments')
      .select('*, teams!inner(season_id)', { count: 'exact', head: true })
      .eq('teams.season_id', seasonId)
      .eq('needs_jersey_order', true)

    return (needsJersey || 0) + (needsOrder || 0)
  } catch (err) {
    console.error('Error getting jersey tasks count:', err)
    return 0
  }
}

// Standard jersey sizes with validation
const JERSEY_SIZES = [
  { value: 'YXS', label: 'Youth XS', category: 'Youth' },
  { value: 'YS', label: 'Youth S', category: 'Youth' },
  { value: 'YM', label: 'Youth M', category: 'Youth' },
  { value: 'YL', label: 'Youth L', category: 'Youth' },
  { value: 'YXL', label: 'Youth XL', category: 'Youth' },
  { value: 'AS', label: 'Adult S', category: 'Adult' },
  { value: 'AM', label: 'Adult M', category: 'Adult' },
  { value: 'AL', label: 'Adult L', category: 'Adult' },
  { value: 'AXL', label: 'Adult XL', category: 'Adult' },
  { value: 'A2XL', label: 'Adult 2XL', category: 'Adult' },
  { value: 'A3XL', label: 'Adult 3XL', category: 'Adult' },
]

function JerseysPage({ showToast }) {
  const { organization, user } = useAuth()
  const { selectedSeason } = useSeason()
  const tc = useThemeClasses()
  const { isDark } = useTheme()
  
  // Data State
  const [teams, setTeams] = useState([])
  const [selectedTeam, setSelectedTeam] = useState(null) // null = all teams
  const [players, setPlayers] = useState([]) // All players (filtered or all)
  const [allPlayersAllTeams, setAllPlayersAllTeams] = useState([]) // For full report
  const [unrosteredCount, setUnrosteredCount] = useState(0) // Approved but not on a team
  const [loading, setLoading] = useState(true)
  
  // UI State
  const [activeTab, setActiveTab] = useState('needs') // 'needs', 'assigned', 'ordered'
  const [assigningPlayer, setAssigningPlayer] = useState(null)
  const [editingPlayer, setEditingPlayer] = useState(null)
  const [showFullReport, setShowFullReport] = useState(false)
  const [showConflictResolver, setShowConflictResolver] = useState(null)
  const [showOrderHistory, setShowOrderHistory] = useState(false)
  const [autoAssigning, setAutoAssigning] = useState(false)

  useEffect(() => {
    if (selectedSeason?.id) {
      loadTeams()
      checkUnrosteredRegistrations()
    }
  }, [selectedSeason?.id])

  useEffect(() => {
    loadPlayers()
  }, [selectedTeam?.id, selectedSeason?.id])

  // Check for approved registrations that aren't on any team roster
  async function checkUnrosteredRegistrations() {
    try {
      // Get approved registrations for this season
      const { data: registrations } = await supabase
        .from('registrations')
        .select('player_id')
        .eq('season_id', selectedSeason.id)
        .eq('status', 'approved')

      if (!registrations || registrations.length === 0) {
        setUnrosteredCount(0)
        return
      }

      const approvedPlayerIds = registrations.map(r => r.player_id)

      // Get team IDs for this season
      const { data: seasonTeams } = await supabase
        .from('teams')
        .select('id')
        .eq('season_id', selectedSeason.id)
      
      const seasonTeamIds = seasonTeams?.map(t => t.id) || []

      // Get players who are on team rosters for this season
      const { data: rosteredPlayers } = await supabase
        .from('team_players')
        .select('player_id')
        .in('team_id', seasonTeamIds)
        .in('player_id', approvedPlayerIds)

      const rosteredIds = new Set(rosteredPlayers?.map(rp => rp.player_id) || [])
      const unrostered = approvedPlayerIds.filter(id => !rosteredIds.has(id))
      
      setUnrosteredCount(unrostered.length)
    } catch (err) {
      console.error('Error checking unrostered:', err)
    }
  }

  async function loadTeams() {
    setLoading(true)
    try {
      const { data } = await supabase
        .from('teams')
        .select('id, name, color')
        .eq('season_id', selectedSeason.id)
        .order('name')
      setTeams(data || [])
    } catch (err) {
      console.error('Error loading teams:', err)
    }
    setLoading(false)
  }

  async function loadPlayers() {
    if (!selectedSeason?.id) {
      console.log(' No selected season')
      return
    }
    setLoading(true)
    
    try {
      console.log(' Loading players for season:', selectedSeason.id, selectedSeason.name)
      
      // Step 1: Get team IDs for this season
      const { data: seasonTeams, error: teamsError } = await supabase
        .from('teams')
        .select('id, name, color, season_id')
        .eq('season_id', selectedSeason.id)
      
      console.log(' Season teams:', seasonTeams, teamsError)
      
      if (!seasonTeams || seasonTeams.length === 0) {
        console.log('No teams found for this season')
        setPlayers([])
        setLoading(false)
        return
      }

      const seasonTeamIds = seasonTeams.map(t => t.id)
      const teamsMap = {}
      seasonTeams.forEach(t => { teamsMap[t.id] = t })

      // Step 2: Get team_players for these teams (simple query, no joins)
      const teamFilter = selectedTeam ? [selectedTeam.id] : seasonTeamIds
      const { data: teamPlayers, error: tpError } = await supabase
        .from('team_players')
        .select('id, team_id, player_id, jersey_number')
        .in('team_id', teamFilter)
      
      console.log(' team_players:', teamPlayers, tpError)

      if (tpError) {
        console.error('team_players error:', tpError)
        setLoading(false)
        return
      }

      if (!teamPlayers || teamPlayers.length === 0) {
        console.log('No team_players found')
        setPlayers([])
        setLoading(false)
        return
      }

      // Step 3: Get player details for these players
      const playerIds = [...new Set(teamPlayers.map(tp => tp.player_id))]
      const { data: playerDetails, error: playersError } = await supabase
        .from('players')
        .select('id, first_name, last_name, photo_url, jersey_pref_1, jersey_pref_2, jersey_pref_3, uniform_size_jersey, uniform_size_shorts, parent_email, parent_phone')
        .in('id', playerIds)
      
      console.log(' players:', playerDetails, playersError)

      const playersMap = {}
      playerDetails?.forEach(p => { playersMap[p.id] = p })

      // Step 4: Get jersey_assignments for order tracking (if table exists)
      let assignmentMap = {}
      try {
        const { data: assignments, error: assignErr } = await supabase
          .from('jersey_assignments')
          .select('player_id, team_id, needs_jersey_order, jersey_ordered_at')
          .in('team_id', teamFilter)
        
        if (!assignErr && assignments) {
          assignments.forEach(a => {
            assignmentMap[`${a.player_id}-${a.team_id}`] = a
          })
          console.log(' jersey_assignments loaded:', assignments.length)
        }
      } catch (e) {
        console.log(' jersey_assignments table not available:', e.message)
      }

      // Step 5: Join the data in JavaScript
      const enrichedPlayers = teamPlayers.map(tp => {
        const team = teamsMap[tp.team_id]
        const player = playersMap[tp.player_id]
        const hasJersey = !!tp.jersey_number
        const assignment = assignmentMap[`${tp.player_id}-${tp.team_id}`]
        
        // Order status from jersey_assignments table
        const isOrdered = hasJersey && assignment?.needs_jersey_order === false
        const needsOrder = hasJersey && !isOrdered
        
        return {
          ...tp,
          team,
          player,
          teams: team,  // For compatibility
          players: player, // For compatibility
          assignment,
          needsJersey: !hasJersey,
          needsOrder,
          isOrdered
        }
      }).filter(tp => tp.player) // Filter out any with missing player data

      console.log('Loaded players:', enrichedPlayers.length, 
        'needsJersey:', enrichedPlayers.filter(p => p.needsJersey).length,
        'needsOrder:', enrichedPlayers.filter(p => p.needsOrder).length,
        'ordered:', enrichedPlayers.filter(p => p.isOrdered).length
      )

      setPlayers(enrichedPlayers)
      
      if (!selectedTeam) {
        setAllPlayersAllTeams(enrichedPlayers)
      }

    } catch (err) {
      console.error('Error loading players:', err)
    }
    setLoading(false)
  }

  async function loadAllPlayersForReport() {
    try {
      // Get team IDs for this season
      const { data: seasonTeams } = await supabase
        .from('teams')
        .select('id, name, color, season_id')
        .eq('season_id', selectedSeason.id)
      
      const seasonTeamIds = seasonTeams?.map(t => t.id) || []
      if (seasonTeamIds.length === 0) {
        setAllPlayersAllTeams([])
        return
      }

      const teamsMap = {}
      seasonTeams.forEach(t => { teamsMap[t.id] = t })

      // Get team_players
      const { data: teamPlayers } = await supabase
        .from('team_players')
        .select('id, team_id, player_id, jersey_number')
        .in('team_id', seasonTeamIds)

      if (!teamPlayers || teamPlayers.length === 0) {
        setAllPlayersAllTeams([])
        return
      }

      // Get player details
      const playerIds = [...new Set(teamPlayers.map(tp => tp.player_id))]
      const { data: playerDetails } = await supabase
        .from('players')
        .select('id, first_name, last_name, uniform_size_jersey')
        .in('id', playerIds)

      const playersMap = {}
      playerDetails?.forEach(p => { playersMap[p.id] = p })

      // Join in JS
      const enriched = teamPlayers.map(tp => {
        const team = teamsMap[tp.team_id]
        const player = playersMap[tp.player_id]
        const hasJersey = !!tp.jersey_number
        
        return {
          ...tp,
          team,
          player,
          teams: team,
          players: player,
          needsJersey: !hasJersey,
          needsOrder: hasJersey,
          isOrdered: false
        }
      }).filter(tp => tp.player)

      setAllPlayersAllTeams(enriched)
    } catch (err) {
      console.error('Error loading all players for report:', err)
    }
  }

  // Categorize players
  const needsJersey = players.filter(p => p.needsJersey)
  const needsOrder = players.filter(p => p.needsOrder)
  const ordered = players.filter(p => p.isOrdered)

  // Get taken numbers for selected team (or all if no team selected)
  const takenNumbers = new Set(
    players.filter(p => p.jersey_number && (!selectedTeam || p.team_id === selectedTeam?.id))
      .map(p => p.jersey_number)
  )

  // Conflicts detection
  function getConflicts() {
    if (!selectedTeam) return [] // Only show conflicts for single team view
    
    const prefCounts = {}
    needsJersey.forEach(p => {
      [p.player?.jersey_pref_1, p.player?.jersey_pref_2, p.player?.jersey_pref_3]
        .filter(Boolean)
        .forEach(pref => {
          if (!prefCounts[pref]) prefCounts[pref] = []
          prefCounts[pref].push(p)
        })
    })
    return Object.entries(prefCounts)
      .filter(([_, players]) => players.length > 1)
      .map(([num, players]) => ({ number: parseInt(num), players }))
  }

  const conflicts = getConflicts()

  // Stats for current view
  const stats = {
    total: players.length,
    needsJersey: needsJersey.length,
    needsOrder: needsOrder.length,
    ordered: ordered.length,
    conflicts: conflicts.length,
    missingSize: players.filter(p => p.jersey_number && !p.player?.uniform_size_jersey).length
  }

  // Full league stats for nav badge
  const leagueStats = {
    needsJersey: allPlayersAllTeams.filter(p => p.needsJersey).length,
    needsOrder: allPlayersAllTeams.filter(p => p.needsOrder).length,
    total: allPlayersAllTeams.filter(p => p.needsJersey || p.needsOrder).length
  }

  // Auto-assign logic with smart priority
  async function handleAutoAssign() {
    if (needsJersey.length === 0) {
      showToast('All players already have jerseys assigned', 'info')
      return
    }

    setAutoAssigning(true)
    
    // If no specific team selected, process each team separately
    const teamsToProcess = selectedTeam 
      ? [selectedTeam] 
      : teams.filter(t => needsJersey.some(p => p.team_id === t.id))
    
    if (teamsToProcess.length === 0) {
      showToast('No teams with players needing jerseys', 'info')
      setAutoAssigning(false)
      return
    }

    let totalAssigned = 0
    const prefCounts = { 'returning': 0, '1st': 0, '2nd': 0, '3rd': 0, 'auto': 0 }

    for (const team of teamsToProcess) {
      const teamPlayers = needsJersey.filter(p => p.team_id === team.id)
      if (teamPlayers.length === 0) continue
      
      // Get taken numbers for this team
      const teamTaken = new Set(
        players.filter(p => p.team_id === team.id && p.jersey_number).map(p => p.jersey_number)
      )

      // Check for returning players from previous seasons
      let returningPlayerNumbers = {}
      try {
        const playerIds = teamPlayers.map(p => p.player?.id).filter(Boolean)
        const { data: previousAssignments } = await supabase
          .from('team_players')
          .select('players!inner(id), jersey_number, teams!inner(season_id)')
          .in('players.id', playerIds)
          .not('jersey_number', 'is', null)
          .neq('teams.season_id', selectedSeason.id)
        
        previousAssignments?.forEach(pa => {
          const playerId = pa.players?.id
          if (playerId && pa.jersey_number && !returningPlayerNumbers[playerId]) {
            returningPlayerNumbers[playerId] = pa.jersey_number
          }
        })
      } catch (e) {
        console.log('Could not fetch returning player history:', e.message)
      }

      // PRIORITY ORDER:
      // 1. Returning players who want their old number
      // 2. Players with preferences, by registration date
      // 3. Players without preferences, by registration date
      
      const sortedPlayers = [...teamPlayers].sort((a, b) => {
        const aPlayerId = a.player?.id
        const bPlayerId = b.player?.id
        
        const aReturning = returningPlayerNumbers[aPlayerId]
        const bReturning = returningPlayerNumbers[bPlayerId]
        const aWantsOldNumber = aReturning && (
          a.player?.jersey_pref_1 === aReturning ||
          a.player?.jersey_pref_2 === aReturning ||
          a.player?.jersey_pref_3 === aReturning ||
          !a.player?.jersey_pref_1 // No preferences = give them their old number
        )
        const bWantsOldNumber = bReturning && (
          b.player?.jersey_pref_1 === bReturning ||
          b.player?.jersey_pref_2 === bReturning ||
          b.player?.jersey_pref_3 === bReturning ||
          !b.player?.jersey_pref_1
        )
        
        if (aWantsOldNumber && !bWantsOldNumber) return -1
        if (bWantsOldNumber && !aWantsOldNumber) return 1
        
        const aHasPref = a.player?.jersey_pref_1 ? 1 : 0
        const bHasPref = b.player?.jersey_pref_1 ? 1 : 0
        if (aHasPref !== bHasPref) return bHasPref - aHasPref
        
        // First come first serve by registration
        const aDate = new Date(a.created_at || 0)
        const bDate = new Date(b.created_at || 0)
        return aDate - bDate
      })

      for (const tp of sortedPlayers) {
        const player = tp.player
        if (!player) continue

        let assignedNumber = null
        let assignmentNote = ''
        
        // Check if returning player
        const oldNumber = returningPlayerNumbers[player.id]
        if (oldNumber && !teamTaken.has(oldNumber)) {
          const wantsOld = !player.jersey_pref_1 || 
            player.jersey_pref_1 === oldNumber || 
            player.jersey_pref_2 === oldNumber || 
            player.jersey_pref_3 === oldNumber
          
          if (wantsOld) {
            assignedNumber = oldNumber
            assignmentNote = 'returning'
          }
        }

        // Try preferences in order
        if (!assignedNumber) {
          for (const pref of [player.jersey_pref_1, player.jersey_pref_2, player.jersey_pref_3]) {
            if (pref && !teamTaken.has(pref)) {
              assignedNumber = pref
              assignmentNote = assignedNumber === player.jersey_pref_1 ? '1st' :
                               assignedNumber === player.jersey_pref_2 ? '2nd' : '3rd'
              break
            }
          }
        }

        // Fallback to next available
        if (!assignedNumber) {
          for (let i = 1; i <= 99; i++) {
            if (!teamTaken.has(i)) {
              assignedNumber = i
              assignmentNote = 'auto'
              break
            }
          }
        }

        if (assignedNumber) {
          teamTaken.add(assignedNumber)
          
          // Save to database
          try {
            await supabase
              .from('team_players')
              .update({ jersey_number: assignedNumber })
              .eq('id', tp.id)

            // Try jersey_assignments (non-blocking)
            try {
              // Check if exists (use maybeSingle to not throw on no match)
              const { data: existing } = await supabase
                .from('jersey_assignments')
                .select('id')
                .eq('player_id', player.id)
                .eq('team_id', tp.team_id)
                .maybeSingle()

              if (existing) {
                await supabase.from('jersey_assignments').update({
                  jersey_number: assignedNumber,
                  needs_jersey_order: true
                }).eq('player_id', player.id).eq('team_id', tp.team_id)
              } else {
                await supabase.from('jersey_assignments').insert({
                  player_id: player.id,
                  team_id: tp.team_id,
                  organization_id: organization.id,
                  sport_id: selectedSeason.sport_id,
                  jersey_number: assignedNumber,
                  needs_jersey_order: true
                })
              }
            } catch (e) {}

            totalAssigned++
            prefCounts[assignmentNote]++
          } catch (err) {
            console.error('Error assigning jersey:', err)
          }
        }
      }
    }

    // Show summary
    const summary = []
    if (prefCounts['returning']) summary.push(`${prefCounts['returning']} returning`)
    if (prefCounts['1st']) summary.push(`${prefCounts['1st']} got 1st choice`)
    if (prefCounts['2nd']) summary.push(`${prefCounts['2nd']} got 2nd choice`)
    if (prefCounts['3rd']) summary.push(`${prefCounts['3rd']} got 3rd choice`)
    if (prefCounts['auto']) summary.push(`${prefCounts['auto']} auto-assigned`)

    if (totalAssigned > 0) {
      showToast(`Assigned ${totalAssigned} jerseys across ${teamsToProcess.length} team${teamsToProcess.length > 1 ? 's' : ''}! ${summary.join(', ')}`, 'success')
    } else {
      showToast('No jerseys were assigned', 'warning')
    }
    
    await loadPlayers()
    setAutoAssigning(false)
  }

  // Assign single jersey
  async function assignJersey(playerId, teamPlayerId, teamId, number, prefResult = 'manual') {
    // Check if taken on this team
    const teamTaken = players
      .filter(p => p.team_id === teamId && p.jersey_number)
      .map(p => p.jersey_number)
    
    if (teamTaken.includes(number)) {
      showToast(`#${number} is already taken on this team`, 'error')
      return false
    }

    try {
      // Update team_players with jersey number
      const { error: updateError } = await supabase
        .from('team_players')
        .update({ jersey_number: number })
        .eq('id', teamPlayerId)

      if (updateError) throw updateError

      // Try to save to jersey_assignments for tracking (non-blocking)
      try {
        // Check if row exists (use maybeSingle to not throw on no match)
        const { data: existing } = await supabase
          .from('jersey_assignments')
          .select('id')
          .eq('player_id', playerId)
          .eq('team_id', teamId)
          .maybeSingle()

        if (existing) {
          await supabase.from('jersey_assignments').update({
            jersey_number: number,
            needs_jersey_order: true
          }).eq('player_id', playerId).eq('team_id', teamId)
        } else {
          await supabase.from('jersey_assignments').insert({
            player_id: playerId,
            team_id: teamId,
            organization_id: organization.id,
            sport_id: selectedSeason.sport_id,
            jersey_number: number,
            needs_jersey_order: true
          })
        }
      } catch (e) {
        console.log('jersey_assignments save skipped:', e.message)
      }

      showToast(`Assigned #${number}${prefResult !== 'manual' ? ` (${prefResult} choice)` : ''}`, 'success')
      setAssigningPlayer(null)
      await loadPlayers() // Reload to refresh the list
      return true
    } catch (err) {
      console.error('Assignment error:', err)
      showToast('Error: ' + err.message, 'error')
      return false
    }
  }

  // Unassign jersey (remove number, put back to "needs jersey")
  async function unassignJersey(teamPlayerId, playerId, teamId) {
    try {
      await supabase
        .from('team_players')
        .update({ jersey_number: null })
        .eq('id', teamPlayerId)

      // Try to delete from jersey_assignments (non-blocking)
      try {
        await supabase
          .from('jersey_assignments')
          .delete()
          .eq('player_id', playerId)
          .eq('team_id', teamId)
      } catch (e) {
        console.log('jersey_assignments delete skipped:', e.message)
      }

      showToast('Jersey unassigned', 'success')
      setEditingPlayer(null)
      loadPlayers()
    } catch (err) {
      showToast('Error: ' + err.message, 'error')
    }
  }

  // Update jersey number
  async function updateJerseyNumber(teamPlayerId, playerId, teamId, newNumber) {
    const teamTaken = players
      .filter(p => p.team_id === teamId && p.jersey_number && p.id !== teamPlayerId)
      .map(p => p.jersey_number)
    
    if (teamTaken.includes(newNumber)) {
      showToast(`#${newNumber} is already taken`, 'error')
      return false
    }

    try {
      await supabase
        .from('team_players')
        .update({ jersey_number: newNumber })
        .eq('id', teamPlayerId)

      // Try to update jersey_assignments (non-blocking, table structure may vary)
      try {
        await supabase
          .from('jersey_assignments')
          .update({ jersey_number: newNumber })
          .eq('player_id', playerId)
          .eq('team_id', teamId)
      } catch (e) {
        console.log('jersey_assignments update skipped:', e.message)
      }

      showToast(`Changed to #${newNumber}`, 'success')
      setEditingPlayer(null)
      loadPlayers()
      return true
    } catch (err) {
      showToast('Error: ' + err.message, 'error')
      return false
    }
  }

  // Update jersey size
  async function updateJerseySize(playerId, newSize) {
    try {
      await supabase
        .from('players')
        .update({ uniform_size_jersey: newSize })
        .eq('id', playerId)

      showToast(`Size updated to ${newSize}`, 'success')
      loadPlayers()
      return true
    } catch (err) {
      showToast('Error: ' + err.message, 'error')
      return false
    }
  }

  // Change order status
  async function updateOrderStatus(playerId, teamId, needsOrder) {
    try {
      await supabase
        .from('jersey_assignments')
        .update({ 
          needs_jersey_order: needsOrder,
          jersey_ordered_at: needsOrder ? null : new Date().toISOString()
        })
        .eq('player_id', playerId)
        .eq('team_id', teamId)

      showToast(needsOrder ? 'Moved back to "Ready to Order"' : 'Marked as ordered', 'success')
      setEditingPlayer(null)
      loadPlayers()
    } catch (err) {
      showToast('Error: ' + err.message, 'error')
    }
  }

  // Bulk mark as ordered
  async function markOrdered(items) {
    try {
      let successCount = 0
      for (const item of items) {
        // First check if a row exists (use maybeSingle to not throw on no match)
        const { data: existing } = await supabase
          .from('jersey_assignments')
          .select('id')
          .eq('player_id', item.playerId)
          .eq('team_id', item.teamId)
          .maybeSingle()

        let error
        if (existing) {
          // Update existing row
          const result = await supabase
            .from('jersey_assignments')
            .update({ 
              needs_jersey_order: false,
              jersey_ordered_at: new Date().toISOString()
            })
            .eq('player_id', item.playerId)
            .eq('team_id', item.teamId)
          error = result.error
        } else {
          // Insert new row - include all required columns
          const result = await supabase
            .from('jersey_assignments')
            .insert({ 
              player_id: item.playerId,
              team_id: item.teamId,
              organization_id: organization.id,
              sport_id: selectedSeason.sport_id,
              jersey_number: item.jerseyNumber,
              needs_jersey_order: false,
              jersey_ordered_at: new Date().toISOString()
            })
          error = result.error
        }
        
        if (error) {
          console.error('Error marking ordered:', error)
        } else {
          successCount++
        }
      }

      if (successCount > 0) {
        showToast(`Marked ${successCount} as ordered`, 'success')
        await loadPlayers()
      } else {
        showToast('Failed to mark as ordered - check console for errors', 'error')
      }
    } catch (err) {
      console.error('Mark ordered error:', err)
      showToast('Error: ' + err.message, 'error')
    }
  }

  // Export comprehensive spreadsheet
  function exportFullReport() {
    // Get all players that need ordering across ALL teams
    const toExport = allPlayersAllTeams.filter(p => p.needsOrder)

    if (toExport.length === 0) {
      showToast('No jerseys to order', 'info')
      return
    }

    // Sort by team, then by number
    toExport.sort((a, b) => {
      const teamCompare = (a.team?.name || '').localeCompare(b.team?.name || '')
      if (teamCompare !== 0) return teamCompare
      return (a.jersey_number || 0) - (b.jersey_number || 0)
    })

    // Build CSV
    const headers = [
      'Team',
      'Jersey Number',
      'Player First Name',
      'Player Last Name',
      'Size',
      'Size Category',
      'Parent Email',
      'Parent Phone',
      'Notes'
    ]

    const rows = toExport.map(p => {
      const sizeInfo = JERSEY_SIZES.find(s => s.value === p.player?.uniform_size_jersey)
      return [
        p.team?.name || '',
        p.jersey_number || '',
        p.player?.first_name || '',
        p.player?.last_name || '',
        p.player?.uniform_size_jersey || 'MISSING SIZE',
        sizeInfo?.category || '',
        p.player?.parent_email || '',
        p.player?.parent_phone || '',
        !p.player?.uniform_size_jersey ? '‚ö†Ô∏è Size needed' : ''
      ]
    })

    // Add summary rows at the end
    const sizeCounts = {}
    toExport.forEach(p => {
      const size = p.player?.uniform_size_jersey || 'Unknown'
      sizeCounts[size] = (sizeCounts[size] || 0) + 1
    })

    rows.push([]) // Empty row
    rows.push(['--- ORDER SUMMARY ---'])
    rows.push(['Size', 'Quantity'])
    Object.entries(sizeCounts).sort().forEach(([size, count]) => {
      rows.push([size, count])
    })
    rows.push([])
    rows.push(['TOTAL JERSEYS', toExport.length])
    rows.push([])
    rows.push(['Report Generated', new Date().toLocaleString()])
    rows.push(['Season', selectedSeason?.name || ''])

    // Convert to CSV
    const csvContent = [
      headers.join(','),
      ...rows.map(row => row.map(cell => {
        const str = String(cell)
        return str.includes(',') || str.includes('"') || str.includes('\n')
          ? `"${str.replace(/"/g, '""')}"`
          : str
      }).join(','))
    ].join('\n')

    // Download
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' })
    const url = URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
    a.download = `jersey-order-${selectedSeason?.name?.replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.csv`
    a.click()
    URL.revokeObjectURL(url)
    showToast('Order spreadsheet downloaded!', 'success')
  }

  if (!selectedSeason) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="text-center">
          <Shirt className="w-16 h-16 mx-auto mb-4 text-slate-400" />
          <h2 className={`text-xl font-medium ${tc.text} mt-4`}>No Season Selected</h2>
          <p className={tc.textMuted}>Select a season to manage jerseys</p>
        </div>
      </div>
    )
  }

  return (
    <div className="max-w-7xl mx-auto space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between flex-wrap gap-4">
        <div>
          <h1 className={`text-3xl font-bold ${tc.text}`}>Jersey Management</h1>
          <p className={tc.textSecondary}>
            {selectedTeam ? selectedTeam.name : 'All Teams'} ‚Ä¢ {selectedSeason.name}
          </p>
        </div>
        <div className="flex gap-3 flex-wrap">
          {/* Order History Button */}
          <button
            onClick={() => setShowOrderHistory(true)}
            className={`px-4 py-2.5 rounded-xl font-medium flex items-center gap-2 transition ${tc.cardBg} border ${tc.border} ${tc.text} ${tc.hoverBg}`}
          >
            <Clock className="w-4 h-4" /> History
          </button>
          
          {/* Full Report Button */}
          <button
            onClick={() => setShowFullReport(true)}
            className={`px-4 py-2.5 rounded-xl font-medium flex items-center gap-2 transition ${tc.cardBg} border ${tc.border} ${tc.text} ${tc.hoverBg}`}
          >
            <BarChart3 className="w-4 h-4" /> Full League Report
            {leagueStats.needsOrder > 0 && (
              <span className="px-2 py-0.5 rounded-full text-xs font-bold bg-amber-500/20 text-amber-500">
                {leagueStats.needsOrder}
              </span>
            )}
          </button>
          
          {/* Auto-Assign Button - works for single team or all teams */}
          {needsJersey.length > 0 && (
            <button
              onClick={handleAutoAssign}
              disabled={autoAssigning}
              className={`px-4 py-2.5 rounded-xl font-semibold text-white transition flex items-center gap-2 ${
                autoAssigning 
                  ? 'bg-slate-400 cursor-wait' 
                  : 'bg-[var(--accent-primary)] hover:brightness-110'
              }`}
            >
              {autoAssigning ? (
                <>
                  <div className="animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full" />
                  Assigning...
                </>
              ) : (
                <>
                  <Sparkles className="w-4 h-4" /> Auto-Assign ({needsJersey.length})
                </>
              )}
            </button>
          )}
        </div>
      </div>

      {/* Team Filter */}
      <div className="flex gap-2 overflow-x-auto pb-2">
        <button
          onClick={() => setSelectedTeam(null)}
          className={`px-4 py-2.5 rounded-xl whitespace-nowrap flex items-center gap-2 transition font-medium ${
            !selectedTeam
              ? 'bg-[var(--accent-primary)] text-white shadow-lg'
              : `${tc.cardBg} border ${tc.border} ${tc.textSecondary} ${tc.hoverBg}`
          }`}
        >
          üèÜ All Teams
        </button>
        {teams.map(team => (
          <button
            key={team.id}
            onClick={() => setSelectedTeam(team)}
            className={`px-4 py-2.5 rounded-xl whitespace-nowrap flex items-center gap-2 transition font-medium ${
              selectedTeam?.id === team.id
                ? 'text-white shadow-lg'
                : `${tc.cardBg} border ${tc.border} ${tc.textSecondary} ${tc.hoverBg}`
            }`}
            style={selectedTeam?.id === team.id ? { backgroundColor: team.color || 'var(--accent-primary)' } : {}}
          >
            <span className="w-2.5 h-2.5 rounded-full" style={{ backgroundColor: team.color || '#888' }} />
            {team.name}
          </button>
        ))}
      </div>

      {/* Unrostered Registrations Alert - Most important! */}
      {unrosteredCount > 0 && (
        <div className={`${isDark ? 'bg-blue-500/10 border-blue-500/30' : 'bg-blue-50 border-blue-200'} border-2 rounded-2xl p-5`}>
          <div className="flex items-start gap-4">
            <div className={`w-12 h-12 rounded-xl flex items-center justify-center flex-shrink-0 ${isDark ? 'bg-blue-500/20' : 'bg-blue-100'}`}>
              <Users className="w-6 h-6 text-blue-500" />
            </div>
            <div className="flex-1">
              <h3 className={`font-bold text-lg ${isDark ? 'text-blue-400' : 'text-blue-700'}`}>
                {unrosteredCount} Approved Registration{unrosteredCount !== 1 ? 's' : ''} Not Yet Rostered
              </h3>
              <p className={`mt-1 ${isDark ? 'text-blue-300/80' : 'text-blue-600'}`}>
                These players are approved but haven't been added to a team roster yet. 
                Go to <strong>Teams & Rosters</strong> to add them to teams before managing jerseys.
              </p>
              <a 
                href="#" 
                onClick={(e) => { e.preventDefault(); /* Could link to roster page */ }}
                className={`inline-flex items-center gap-2 mt-3 px-4 py-2 rounded-lg font-medium transition ${
                  isDark ? 'bg-blue-500/20 text-blue-400 hover:bg-blue-500/30' : 'bg-blue-100 text-blue-700 hover:bg-blue-200'
                }`}
              >
                <UserPlus className="w-4 h-4" />
                Go to Teams & Rosters
              </a>
            </div>
          </div>
        </div>
      )}

      {/* Alerts */}
      {(conflicts.length > 0 || stats.missingSize > 0) && (
        <div className="space-y-3">
          {/* Conflict Alert */}
          {conflicts.length > 0 && (
            <div className={`${isDark ? 'bg-amber-500/10 border-amber-500/30' : 'bg-amber-50 border-amber-200'} border rounded-2xl p-4`}>
              <div className="flex items-start gap-3">
                <AlertTriangle className="w-6 h-6 text-amber-500 flex-shrink-0 mt-0.5" />
                <div className="flex-1">
                  <h3 className={`font-semibold ${isDark ? 'text-amber-400' : 'text-amber-700'}`}>
                    {conflicts.length} Number Conflict{conflicts.length !== 1 ? 's' : ''}
                  </h3>
                  <p className={isDark ? 'text-amber-300/80' : 'text-amber-600'}>
                    Multiple players want the same number
                  </p>
                  <div className="flex flex-wrap gap-2 mt-3">
                    {conflicts.map(c => (
                      <button
                        key={c.number}
                        onClick={() => setShowConflictResolver(c)}
                        className={`px-3 py-1.5 rounded-lg text-sm font-medium transition ${
                          isDark ? 'bg-amber-500/20 text-amber-400 hover:bg-amber-500/30' : 'bg-amber-100 text-amber-700 hover:bg-amber-200'
                        }`}
                      >
                        #{c.number} ({c.players.length} players)
                      </button>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Missing Size Alert */}
          {stats.missingSize > 0 && (
            <div className={`${isDark ? 'bg-red-500/10 border-red-500/30' : 'bg-red-50 border-red-200'} border rounded-2xl p-4`}>
              <div className="flex items-start gap-3">
                <AlertCircle className="w-6 h-6 text-red-500 flex-shrink-0 mt-0.5" />
                <div>
                  <h3 className={`font-semibold ${isDark ? 'text-red-400' : 'text-red-700'}`}>
                    {stats.missingSize} Player{stats.missingSize !== 1 ? 's' : ''} Missing Jersey Size
                  </h3>
                  <p className={isDark ? 'text-red-300/80' : 'text-red-600'}>
                    Edit players to add their size before ordering
                  </p>
                </div>
              </div>
            </div>
          )}
        </div>
      )}

      {/* Stats Cards */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        <StatCard
          icon="users"
          value={stats.total}
          label="Total Players"
          onClick={() => {}}
          tc={tc}
          isDark={isDark}
        />
        <StatCard
          icon="help-circle"
          value={stats.needsJersey}
          label="Needs Jersey"
          color={stats.needsJersey > 0 ? 'red' : null}
          onClick={() => setActiveTab('needs')}
          tc={tc}
          isDark={isDark}
        />
        <StatCard
          icon="package"
          value={stats.needsOrder}
          label="Ready to Order"
          color={stats.needsOrder > 0 ? 'amber' : null}
          onClick={() => setActiveTab('assigned')}
          tc={tc}
          isDark={isDark}
        />
        <StatCard
          icon="check"
          value={stats.ordered}
          label="Ordered"
          color="emerald"
          onClick={() => setActiveTab('ordered')}
          tc={tc}
          isDark={isDark}
        />
      </div>

      {/* Tabs */}
      <div className={`${tc.cardBg} border ${tc.border} rounded-2xl overflow-hidden`}>
        <div className={`flex border-b ${tc.border}`}>
          {[
            { id: 'needs', label: 'Needs Jersey', count: stats.needsJersey, color: 'red' },
            { id: 'assigned', label: 'Ready to Order', count: stats.needsOrder, color: 'amber' },
            { id: 'ordered', label: 'Ordered', count: stats.ordered, color: 'emerald' },
          ].map(tab => (
            <button
              key={tab.id}
              onClick={() => setActiveTab(tab.id)}
              className={`flex-1 px-4 py-4 font-medium transition flex items-center justify-center gap-2 ${
                activeTab === tab.id
                  ? `border-b-2 border-[var(--accent-primary)] text-[var(--accent-primary)]`
                  : `${tc.textMuted} ${tc.hoverBg}`
              }`}
            >
              {tab.label}
              {tab.count > 0 && (
                <span className={`px-2 py-0.5 rounded-full text-xs font-bold ${
                  tab.color === 'red' ? 'bg-red-500/20 text-red-500' :
                  tab.color === 'amber' ? 'bg-amber-500/20 text-amber-500' :
                  'bg-emerald-500/20 text-emerald-500'
                }`}>
                  {tab.count}
                </span>
              )}
            </button>
          ))}
        </div>

        {/* Tab Content */}
        <div className="p-6">
          {loading ? (
            <div className="text-center py-12">
              <div className="animate-spin w-8 h-8 border-2 border-[var(--accent-primary)] border-t-transparent rounded-full mx-auto" />
            </div>
          ) : activeTab === 'needs' ? (
            <NeedsJerseyList
              players={needsJersey}
              totalRostered={players.length}
              unrosteredCount={unrosteredCount}
              takenNumbers={takenNumbers}
              selectedTeam={selectedTeam}
              onAssign={(player) => setAssigningPlayer(player)}
              onAutoAssign={handleAutoAssign}
              autoAssigning={autoAssigning}
              tc={tc}
              isDark={isDark}
            />
          ) : activeTab === 'assigned' ? (
            <ReadyToOrderList
              players={needsOrder}
              selectedTeam={selectedTeam}
              onEdit={(player) => setEditingPlayer(player)}
              onMarkOrdered={markOrdered}
              tc={tc}
              isDark={isDark}
            />
          ) : (
            <OrderedList
              players={ordered}
              selectedTeam={selectedTeam}
              onEdit={(player) => setEditingPlayer(player)}
              tc={tc}
              isDark={isDark}
            />
          )}
        </div>
      </div>

      {/* Assignment Modal */}
      {assigningPlayer && (
        <JerseyAssignmentModal
          player={assigningPlayer}
          takenNumbers={new Set(
            players
              .filter(p => p.team_id === assigningPlayer.team_id && p.jersey_number)
              .map(p => p.jersey_number)
          )}
          teamColor={assigningPlayer.team?.color}
          onAssign={(number, prefResult) => assignJersey(
            assigningPlayer.player.id,
            assigningPlayer.id,
            assigningPlayer.team_id,
            number,
            prefResult || 'manual'
          )}
          onClose={() => setAssigningPlayer(null)}
          tc={tc}
          isDark={isDark}
        />
      )}

      {/* Edit Modal */}
      {editingPlayer && (
        <JerseyEditModal
          player={editingPlayer}
          takenNumbers={new Set(
            players
              .filter(p => p.team_id === editingPlayer.team_id && p.jersey_number && p.id !== editingPlayer.id)
              .map(p => p.jersey_number)
          )}
          onUpdateNumber={(num) => updateJerseyNumber(editingPlayer.id, editingPlayer.player.id, editingPlayer.team_id, num)}
          onUpdateSize={(size) => updateJerseySize(editingPlayer.player.id, size)}
          onUnassign={() => unassignJersey(editingPlayer.id, editingPlayer.player.id, editingPlayer.team_id)}
          onChangeStatus={(needsOrder) => updateOrderStatus(editingPlayer.player.id, editingPlayer.team_id, needsOrder)}
          onClose={() => setEditingPlayer(null)}
          tc={tc}
          isDark={isDark}
        />
      )}

      {/* Conflict Resolver */}
      {showConflictResolver && (
        <ConflictResolverModal
          conflict={showConflictResolver}
          takenNumbers={takenNumbers}
          teamColor={selectedTeam?.color}
          onAssign={(playerId, teamPlayerId, teamId, num) => assignJersey(playerId, teamPlayerId, teamId, num)}
          onClose={() => setShowConflictResolver(null)}
          tc={tc}
          isDark={isDark}
        />
      )}

      {/* Full League Report Modal */}
      {showFullReport && (
        <FullLeagueReportModal
          allPlayers={allPlayersAllTeams}
          teams={teams}
          seasonName={selectedSeason?.name}
          onExport={exportFullReport}
          onMarkOrdered={markOrdered}
          onClose={() => setShowFullReport(false)}
          tc={tc}
          isDark={isDark}
        />
      )}

      {/* Order History Modal */}
      {showOrderHistory && (
        <OrderHistoryModal
          orderedPlayers={ordered}
          teams={teams}
          seasonName={selectedSeason?.name}
          onClose={() => setShowOrderHistory(false)}
          tc={tc}
          isDark={isDark}
        />
      )}
    </div>
  )
}

// ============================================
// STAT CARD COMPONENT
// ============================================
function StatCard({ icon, value, label, color, onClick, tc, isDark }) {
  const colorClasses = {
    red: 'bg-red-500/20 text-red-500',
    amber: 'bg-amber-500/20 text-amber-500',
    emerald: 'bg-emerald-500/20 text-emerald-500',
  }

  // Map icon names to Lucide components
  const iconMap = {
    users: Users,
    shirt: Shirt,
    'help-circle': HelpCircle,
    package: Package,
    check: CheckCircle2,
  }
  const IconComponent = iconMap[icon] || Users

  return (
    <div
      onClick={onClick}
      className={`${tc.cardBg} border ${tc.border} rounded-2xl p-5 cursor-pointer transition hover:shadow-lg`}
    >
      <div className="flex items-center gap-3">
        <div className={`w-12 h-12 rounded-xl flex items-center justify-center ${
          color ? colorClasses[color] : isDark ? 'bg-slate-700' : 'bg-slate-100'
        }`}>
          <IconComponent className="w-6 h-6" />
        </div>
        <div>
          <p className={`text-2xl font-bold ${color ? colorClasses[color].split(' ')[1] : tc.text}`}>
            {value}
          </p>
          <p className={tc.textMuted}>{label}</p>
        </div>
      </div>
    </div>
  )
}

// ============================================
// NEEDS JERSEY LIST
// ============================================
function NeedsJerseyList({ players, totalRostered, unrosteredCount, takenNumbers, selectedTeam, onAssign, onAutoAssign, autoAssigning, tc, isDark }) {
  // Different empty states based on context
  if (players.length === 0) {
    // No players need jerseys
    if (totalRostered > 0) {
      // There ARE rostered players, they all have jerseys
      return (
        <div className="text-center py-12">
          <CheckCircle2 className="w-16 h-16 mx-auto mb-4 text-emerald-500" />
          <h3 className={`text-lg font-semibold ${tc.text} mt-4`}>All Players Have Jerseys!</h3>
          <p className={tc.textMuted}>Everyone on the roster has been assigned a number.</p>
        </div>
      )
    } else if (unrosteredCount > 0) {
      // No rostered players, but there ARE approved registrations waiting
      return (
        <div className="text-center py-12">
          <Users className="w-16 h-16 mx-auto mb-4 text-blue-500" />
          <h3 className={`text-lg font-semibold ${tc.text} mt-4`}>No Players on Team Rosters Yet</h3>
          <p className={tc.textMuted}>
            You have <strong>{unrosteredCount} approved registration{unrosteredCount !== 1 ? 's' : ''}</strong> waiting to be added to teams.
          </p>
          <p className={`${tc.textMuted} mt-2`}>
            Go to <strong>Teams & Rosters</strong> to add players to teams first.
          </p>
        </div>
      )
    } else {
      // No rostered players and no pending registrations
      return (
        <div className="text-center py-12">
          <Shirt className="w-16 h-16 mx-auto mb-4 text-slate-400" />
          <h3 className={`text-lg font-semibold ${tc.text} mt-4`}>No Players to Manage</h3>
          <p className={tc.textMuted}>Add players to team rosters to start managing jerseys.</p>
        </div>
      )
    }
  }

  // Count players with/without preferences
  const withPrefs = players.filter(p => p.player?.jersey_pref_1).length
  const withoutPrefs = players.length - withPrefs

  return (
    <div className="space-y-4">
      {/* Bulk Auto-Assign Section */}
      <div className={`${isDark ? 'bg-[var(--accent-primary)]/10 border-[var(--accent-primary)]/30' : 'bg-purple-50 border-purple-200'} border-2 border-dashed rounded-2xl p-6`}>
        <div className="flex items-center justify-between flex-wrap gap-4">
          <div className="flex items-center gap-4">
            <div className={`w-14 h-14 rounded-xl flex items-center justify-center ${isDark ? 'bg-[var(--accent-primary)]/20' : 'bg-purple-100'}`}>
              <Sparkles className="w-7 h-7 text-[var(--accent-primary)]" />
            </div>
            <div>
              <h3 className={`font-bold text-lg ${tc.text}`}>
                {players.length} Player{players.length !== 1 ? 's' : ''} Need{players.length === 1 ? 's' : ''} Jersey Numbers
              </h3>
              <p className={tc.textMuted}>
                {withPrefs > 0 && `${withPrefs} with preferences`}
                {withPrefs > 0 && withoutPrefs > 0 && ' ‚Ä¢ '}
                {withoutPrefs > 0 && `${withoutPrefs} without preferences`}
              </p>
            </div>
          </div>
          
          <button
            onClick={onAutoAssign}
            disabled={autoAssigning}
            className={`px-6 py-3 rounded-xl font-bold text-white transition flex items-center gap-2 shadow-lg ${
              autoAssigning 
                ? 'bg-slate-400 cursor-wait' 
                : 'bg-[var(--accent-primary)] hover:brightness-110 hover:shadow-xl'
            }`}
          >
            {autoAssigning ? (
              <>
                <div className="animate-spin w-5 h-5 border-2 border-white border-t-transparent rounded-full" />
                Assigning...
              </>
            ) : (
              <>
                <Sparkles className="w-5 h-5" />
                Auto-Assign All ({players.length})
              </>
            )}
          </button>
        </div>
        
        <p className={`mt-3 text-sm ${tc.textMuted}`}>
          <strong>Priority order:</strong> Returning players (same number as last season) ‚Üí Players with preferences (first registered first) ‚Üí Auto-assign next available
        </p>
      </div>

      {/* Individual Players */}
      <div className="space-y-3">
        {players.map(p => {
          const player = p.player
          if (!player) return null

          const prefs = [player.jersey_pref_1, player.jersey_pref_2, player.jersey_pref_3].filter(Boolean)
          const teamTaken = new Set(
            players.filter(x => x.team_id === p.team_id && x.jersey_number).map(x => x.jersey_number)
          )
          const availablePrefs = prefs.filter(n => !teamTaken.has(n))

          return (
            <div
              key={p.id}
              className={`${tc.cardBgAlt} border ${tc.border} rounded-xl p-4 flex items-center gap-4 transition hover:shadow-md`}
            >
              {/* Team Color Bar */}
              <div className="w-1 h-12 rounded-full" style={{ backgroundColor: p.team?.color || '#888' }} />

              {/* Avatar */}
              <div className="w-11 h-11 rounded-full flex items-center justify-center text-sm font-bold"
                style={{ backgroundColor: `${p.team?.color || '#888'}30`, color: p.team?.color || '#888' }}>
                {player.photo_url ? (
                  <img src={player.photo_url} alt="" className="w-11 h-11 rounded-full object-cover" />
                ) : (
                  `${player.first_name?.[0]}${player.last_name?.[0]}`
                )}
              </div>

              {/* Info */}
              <div className="flex-1 min-w-0">
                <div className="flex items-center gap-2 flex-wrap">
                  <h4 className={`font-semibold ${tc.text}`}>{player.first_name} {player.last_name}</h4>
                  {!selectedTeam && (
                    <span className="text-xs px-2 py-0.5 rounded-full" 
                      style={{ backgroundColor: `${p.team?.color || '#888'}20`, color: p.team?.color || '#888' }}>
                      {p.team?.name}
                    </span>
                  )}
                </div>
                <div className="flex items-center gap-3 mt-1 flex-wrap">
                  {player.uniform_size_jersey ? (
                    <span className={`text-xs px-2 py-0.5 rounded ${isDark ? 'bg-slate-700' : 'bg-slate-200'} ${tc.textMuted}`}>
                      {player.uniform_size_jersey}
                    </span>
                  ) : (
                    <span className="text-xs px-2 py-0.5 rounded bg-red-500/20 text-red-500 flex items-center gap-1">
                      <AlertTriangle className="w-3 h-3" /> No size
                    </span>
                  )}
                  {prefs.length > 0 ? (
                    <div className="flex items-center gap-1">
                      <span className={`text-xs ${tc.textMuted}`}>Wants:</span>
                      {prefs.map((n, i) => (
                        <span
                          key={i}
                          className={`text-xs px-1.5 py-0.5 rounded font-medium ${
                            teamTaken.has(n)
                              ? 'bg-red-500/20 text-red-500 line-through'
                              : 'bg-emerald-500/20 text-emerald-500'
                          }`}
                        >
                          #{n}
                        </span>
                      ))}
                    </div>
                  ) : (
                    <span className={`text-xs ${tc.textMuted} italic`}>No preferences set</span>
                  )}
                </div>
              </div>

              {/* Quick Assign Buttons */}
              {availablePrefs.length > 0 && (
                <div className="hidden md:flex gap-2">
                  {availablePrefs.slice(0, 3).map(num => (
                    <button
                      key={num}
                      onClick={() => onAssign({ ...p, quickAssign: num })}
                      className="w-10 h-10 rounded-lg font-bold text-white transition hover:scale-105"
                      style={{ backgroundColor: p.team?.color || 'var(--accent-primary)' }}
                      title={`Assign #${num}`}
                    >
                      {num}
                    </button>
                  ))}
                </div>
              )}

              {/* Assign Button */}
              <button
                onClick={() => onAssign(p)}
                className="px-4 py-2 rounded-xl font-medium bg-[var(--accent-primary)]/10 text-[var(--accent-primary)] hover:bg-[var(--accent-primary)]/20 transition"
              >
                Assign
              </button>
            </div>
          )
        })}
      </div>
    </div>
  )
}

// ============================================
// READY TO ORDER LIST
// ============================================
function ReadyToOrderList({ players, selectedTeam, onEdit, onMarkOrdered, tc, isDark }) {
  const [selected, setSelected] = useState(new Set())

  if (players.length === 0) {
    return (
      <div className="text-center py-12">
        <Package className="w-16 h-16 mx-auto mb-4 text-slate-400" />
        <h3 className={`text-lg font-semibold ${tc.text} mt-4`}>Nothing to Order</h3>
        <p className={tc.textMuted}>All assigned jerseys have been ordered.</p>
      </div>
    )
  }

  const toggleSelect = (id) => {
    const newSet = new Set(selected)
    if (newSet.has(id)) newSet.delete(id)
    else newSet.add(id)
    setSelected(newSet)
  }

  const selectAll = () => {
    if (selected.size === players.length) setSelected(new Set())
    else setSelected(new Set(players.map(p => p.id)))
  }

  // Group by size
  const bySize = {}
  players.forEach(p => {
    const size = p.player?.uniform_size_jersey || '‚ö†Ô∏è Unknown'
    if (!bySize[size]) bySize[size] = []
    bySize[size].push(p)
  })

  return (
    <div className="space-y-4">
      {/* Bulk Actions */}
      <div className="flex items-center justify-between flex-wrap gap-3">
        <label className="flex items-center gap-2 cursor-pointer">
          <input
            type="checkbox"
            checked={selected.size === players.length}
            onChange={selectAll}
            className="w-5 h-5 rounded"
          />
          <span className={tc.textSecondary}>Select All ({players.length})</span>
        </label>
        {selected.size > 0 && (
          <button
            onClick={() => {
              const items = players
                .filter(p => selected.has(p.id))
                .map(p => ({ playerId: p.player?.id, teamId: p.team_id, jerseyNumber: p.jersey_number }))
              onMarkOrdered(items)
              setSelected(new Set())
            }}
            className="px-4 py-2 rounded-xl font-semibold text-white bg-emerald-500 hover:bg-emerald-600 transition"
          >
            ‚úÖ Mark {selected.size} as Ordered
          </button>
        )}
      </div>

      {/* Grouped List */}
      {Object.entries(bySize).sort().map(([size, sizeGroup]) => (
        <div key={size}>
          <div className={`flex items-center gap-2 mb-2 ${tc.textMuted}`}>
            <span className={`font-medium uppercase text-sm ${size.includes('‚ö†Ô∏è') ? 'text-red-500' : ''}`}>{size}</span>
            <span className={`px-2 py-0.5 rounded-full text-xs ${isDark ? 'bg-slate-700' : 'bg-slate-200'}`}>
              {sizeGroup.length}
            </span>
          </div>
          <div className="space-y-2">
            {sizeGroup.map(p => {
              const player = p.player
              if (!player) return null

              return (
                <div
                  key={p.id}
                  className={`${tc.cardBgAlt} border ${tc.border} rounded-xl p-3 flex items-center gap-3 transition ${
                    selected.has(p.id) ? 'ring-2 ring-[var(--accent-primary)]' : ''
                  }`}
                >
                  <input
                    type="checkbox"
                    checked={selected.has(p.id)}
                    onChange={() => toggleSelect(p.id)}
                    className="w-5 h-5 rounded"
                  />

                  <div
                    className="w-11 h-11 rounded-lg flex items-center justify-center text-lg font-bold text-white"
                    style={{ backgroundColor: p.team?.color || 'var(--accent-primary)' }}
                  >
                    {p.jersey_number}
                  </div>

                  <div className="flex-1 min-w-0">
                    <span className={`font-medium ${tc.text}`}>{player.first_name} {player.last_name}</span>
                    {!selectedTeam && (
                      <span className="ml-2 text-xs" style={{ color: p.team?.color }}>{p.team?.name}</span>
                    )}
                  </div>

                  <span className={`text-sm ${tc.textMuted}`}>{player.uniform_size_jersey || '‚Äî'}</span>

                  <button
                    onClick={() => onEdit(p)}
                    className={`p-2 rounded-lg ${tc.hoverBg} ${tc.textMuted} transition`}
                    title="Edit"
                  >
                    <Edit className="w-4 h-4" />
                  </button>

                  <button
                    onClick={() => onMarkOrdered([{ playerId: player.id, teamId: p.team_id, jerseyNumber: p.jersey_number }])}
                    className="px-3 py-1.5 rounded-lg text-sm font-medium bg-emerald-500/10 text-emerald-500 hover:bg-emerald-500/20 transition flex items-center gap-1"
                  >
                    <Check className="w-4 h-4" /> Mark Ordered
                  </button>
                </div>
              )
            })}
          </div>
        </div>
      ))}
    </div>
  )
}

// ============================================
// ORDERED LIST
// ============================================
function OrderedList({ players, selectedTeam, onEdit, tc, isDark }) {
  if (players.length === 0) {
    return (
      <div className="text-center py-12">
        <ClipboardList className="w-16 h-16 mx-auto mb-4 text-slate-400" />
        <h3 className={`text-lg font-semibold ${tc.text}`}>No Orders Yet</h3>
        <p className={tc.textMuted}>Jerseys will appear here once marked as ordered.</p>
      </div>
    )
  }

  return (
    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
      {players.map(p => {
        const player = p.player
        if (!player) return null

        return (
          <div
            key={p.id}
            className={`${tc.cardBgAlt} border ${tc.border} rounded-xl p-4 flex items-center gap-3`}
          >
            <div
              className="w-12 h-12 rounded-lg flex items-center justify-center text-lg font-bold text-white"
              style={{ backgroundColor: p.team?.color || 'var(--accent-primary)' }}
            >
              {p.jersey_number}
            </div>
            <div className="flex-1 min-w-0">
              <h4 className={`font-medium ${tc.text} truncate`}>{player.first_name} {player.last_name}</h4>
              <div className="flex items-center gap-2">
                <p className={`text-xs ${tc.textMuted}`}>{player.uniform_size_jersey || 'No size'}</p>
                {!selectedTeam && (
                  <span className="text-xs" style={{ color: p.team?.color }}>{p.team?.name}</span>
                )}
              </div>
            </div>
            <button
              onClick={() => onEdit(p)}
              className={`p-2 rounded-lg ${tc.hoverBg} ${tc.textMuted} transition`}
              title="Edit"
            >
              <Edit className="w-4 h-4" />
            </button>
            <span className="text-emerald-500"><Check className="w-4 h-4" /></span>
          </div>
        )
      })}
    </div>
  )
}

// ============================================
// JERSEY ASSIGNMENT MODAL
// ============================================
function JerseyAssignmentModal({ player, takenNumbers, teamColor, onAssign, onClose, tc, isDark }) {
  const [selectedNumber, setSelectedNumber] = useState(player.quickAssign || null)
  const playerData = player.player

  const pref1 = playerData?.jersey_pref_1
  const pref2 = playerData?.jersey_pref_2
  const pref3 = playerData?.jersey_pref_3
  const hasPrefs = pref1 || pref2 || pref3

  // Available numbers
  const suggestions = []
  for (let i = 1; i <= 99 && suggestions.length < 20; i++) {
    if (!takenNumbers.has(i)) suggestions.push(i)
  }

  // Determine which preference the selected number fulfills
  const getPreferenceResult = (num) => {
    if (num === pref1) return '1st'
    if (num === pref2) return '2nd'
    if (num === pref3) return '3rd'
    return 'manual'
  }

  const handleAssign = () => {
    if (selectedNumber && !takenNumbers.has(selectedNumber)) {
      onAssign(selectedNumber, getPreferenceResult(selectedNumber))
    }
  }

  return (
    <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50" onClick={onClose}>
      <div className={`${tc.cardBg} border ${tc.border} rounded-2xl w-full max-w-md max-h-[90vh] overflow-y-auto`} onClick={e => e.stopPropagation()}>
        <div className={`p-6 border-b ${tc.border} sticky top-0 ${tc.cardBg}`}>
          <div className="flex items-center justify-between">
            <h2 className={`text-xl font-semibold ${tc.text}`}>Assign Jersey</h2>
            <button onClick={onClose} className={`${tc.textMuted} hover:${tc.text} text-2xl`}>√ó</button>
          </div>
        </div>

        <div className="p-6 space-y-6">
          {/* Player Info */}
          <div className="text-center">
            <div className="w-16 h-16 rounded-full mx-auto flex items-center justify-center text-xl font-bold"
              style={{ backgroundColor: `${teamColor}30`, color: teamColor }}>
              {playerData?.first_name?.[0]}{playerData?.last_name?.[0]}
            </div>
            <h3 className={`text-lg font-semibold ${tc.text} mt-3`}>{playerData?.first_name} {playerData?.last_name}</h3>
            <p className={tc.textMuted}>{player.team?.name}</p>
            {playerData?.uniform_size_jersey && (
              <p className={tc.textMuted}>Size: {playerData.uniform_size_jersey}</p>
            )}
          </div>

          {/* Preferences - Always show */}
          <div>
            <label className={`block text-sm font-medium ${tc.textMuted} mb-2`}>
              Player's Preferences {!hasPrefs && <span className="text-amber-500">(None set)</span>}
            </label>
            <div className="flex gap-2">
              {[pref1, pref2, pref3].map((pref, i) => {
                const isTaken = pref && takenNumbers.has(pref)
                const isSelected = selectedNumber === pref

                return (
                  <button
                    key={i}
                    onClick={() => !isTaken && pref && setSelectedNumber(pref)}
                    disabled={isTaken || !pref}
                    className={`flex-1 py-3 rounded-xl text-center transition ${
                      isSelected
                        ? 'ring-2 ring-[var(--accent-primary)] bg-[var(--accent-primary)]/20'
                        : isTaken
                          ? `${tc.cardBgAlt} border ${tc.border} opacity-50 cursor-not-allowed`
                          : pref
                            ? `${tc.cardBgAlt} border ${tc.border} hover:border-[var(--accent-primary)] cursor-pointer`
                            : `${tc.cardBgAlt} border ${tc.border} opacity-30`
                    }`}
                  >
                    <div className={`text-xs ${tc.textMuted}`}>{['1st', '2nd', '3rd'][i]}</div>
                    <div className={`text-lg font-bold ${isTaken ? 'line-through text-red-500' : tc.text}`}>
                      {pref || '‚Äî'}
                    </div>
                    {isTaken && <div className="text-[10px] text-red-500">Taken</div>}
                  </button>
                )
              })}
            </div>
          </div>

          {/* Number Grid */}
          <div>
            <label className={`block text-sm font-medium ${tc.textMuted} mb-2`}>Available Numbers</label>
            <div className="grid grid-cols-5 gap-2">
              {suggestions.map(num => {
                const isPref = num === pref1 || num === pref2 || num === pref3
                return (
                  <button
                    key={num}
                    onClick={() => setSelectedNumber(num)}
                    className={`h-11 rounded-lg font-semibold transition ${
                      selectedNumber === num
                        ? 'text-white'
                        : isPref
                          ? 'bg-emerald-500/20 border-2 border-emerald-500 text-emerald-600'
                          : `${tc.cardBgAlt} border ${tc.border} ${tc.text} hover:border-[var(--accent-primary)]`
                    }`}
                    style={selectedNumber === num ? { backgroundColor: teamColor || 'var(--accent-primary)' } : {}}
                  >
                    {num}
                    {isPref && selectedNumber !== num && <span className="text-[8px] block -mt-1">‚òÖ</span>}
                  </button>
                )
              })}
            </div>
          </div>

          {/* Custom Input */}
          <div>
            <label className={`block text-sm font-medium ${tc.textMuted} mb-2`}>Or Enter Number (1-99)</label>
            <input
              type="number"
              min="1"
              max="99"
              value={selectedNumber || ''}
              onChange={e => {
                const val = parseInt(e.target.value)
                if (!isNaN(val) && val >= 1 && val <= 99) setSelectedNumber(val)
                else if (e.target.value === '') setSelectedNumber(null)
              }}
              placeholder="1-99"
              className={`w-full px-4 py-3 rounded-xl text-2xl font-bold text-center border-2 ${tc.input} focus:border-[var(--accent-primary)] outline-none`}
            />
            {selectedNumber && takenNumbers.has(selectedNumber) && (
              <p className="text-red-500 text-sm mt-2 text-center">‚ö†Ô∏è #{selectedNumber} is already taken</p>
            )}
            {selectedNumber && !takenNumbers.has(selectedNumber) && getPreferenceResult(selectedNumber) !== 'manual' && (
              <p className="text-emerald-500 text-sm mt-2 text-center">‚úì This is their {getPreferenceResult(selectedNumber)} choice!</p>
            )}
          </div>
        </div>

        <div className={`p-4 border-t ${tc.border} flex gap-3 sticky bottom-0 ${tc.cardBg}`}>
          <button onClick={onClose} className={`flex-1 py-3 rounded-xl ${tc.cardBgAlt} ${tc.text} ${tc.hoverBg} transition`}>
            Cancel
          </button>
          <button
            onClick={handleAssign}
            disabled={!selectedNumber || takenNumbers.has(selectedNumber)}
            className="flex-1 py-3 rounded-xl font-semibold text-white bg-[var(--accent-primary)] hover:brightness-110 disabled:opacity-50 transition"
          >
            Assign #{selectedNumber || '?'}
          </button>
        </div>
      </div>
    </div>
  )
}

// ============================================
// JERSEY EDIT MODAL
// ============================================
function JerseyEditModal({ player, takenNumbers, onUpdateNumber, onUpdateSize, onUnassign, onChangeStatus, onClose, tc, isDark }) {
  const [newNumber, setNewNumber] = useState(player.jersey_number || '')
  const [newSize, setNewSize] = useState(player.player?.uniform_size_jersey || '')
  const playerData = player.player
  const isOrdered = player.isOrdered

  return (
    <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50" onClick={onClose}>
      <div className={`${tc.cardBg} border ${tc.border} rounded-2xl w-full max-w-md`} onClick={e => e.stopPropagation()}>
        <div className={`p-6 border-b ${tc.border}`}>
          <div className="flex items-center justify-between">
            <h2 className={`text-xl font-semibold ${tc.text}`}>Edit Jersey</h2>
            <button onClick={onClose} className={`${tc.textMuted} text-2xl`}>√ó</button>
          </div>
        </div>

        <div className="p-6 space-y-6">
          {/* Player Info */}
          <div className="flex items-center gap-4">
            <div
              className="w-14 h-14 rounded-lg flex items-center justify-center text-xl font-bold text-white"
              style={{ backgroundColor: player.team?.color || 'var(--accent-primary)' }}
            >
              {player.jersey_number || '?'}
            </div>
            <div>
              <h3 className={`font-semibold ${tc.text}`}>{playerData?.first_name} {playerData?.last_name}</h3>
              <p className={tc.textMuted}>{player.team?.name}</p>
              <span className={`text-xs px-2 py-0.5 rounded-full ${
                isOrdered ? 'bg-emerald-500/20 text-emerald-500' : 'bg-amber-500/20 text-amber-500'
              }`}>
                {isOrdered ? '‚úÖ Ordered' : 'üì¶ Ready to Order'}
              </span>
            </div>
          </div>

          {/* Jersey Number */}
          <div>
            <label className={`block text-sm font-medium ${tc.textMuted} mb-2`}>Jersey Number</label>
            <input
              type="number"
              min="1"
              max="99"
              value={newNumber}
              onChange={e => setNewNumber(e.target.value)}
              className={`w-full px-4 py-3 rounded-xl text-xl font-bold text-center border ${tc.input} focus:border-[var(--accent-primary)] outline-none`}
            />
            {newNumber && takenNumbers.has(parseInt(newNumber)) && parseInt(newNumber) !== player.jersey_number && (
              <p className="text-red-500 text-sm mt-1">‚ö†Ô∏è Already taken</p>
            )}
            {parseInt(newNumber) !== player.jersey_number && newNumber && !takenNumbers.has(parseInt(newNumber)) && (
              <button
                onClick={() => onUpdateNumber(parseInt(newNumber))}
                className="mt-2 w-full py-2 rounded-lg bg-[var(--accent-primary)]/10 text-[var(--accent-primary)] font-medium hover:bg-[var(--accent-primary)]/20 transition"
              >
                Update to #{newNumber}
              </button>
            )}
          </div>

          {/* Jersey Size */}
          <div>
            <label className={`block text-sm font-medium ${tc.textMuted} mb-2`}>Jersey Size</label>
            <select
              value={newSize}
              onChange={e => setNewSize(e.target.value)}
              className={`w-full px-4 py-3 rounded-xl border ${tc.input} cursor-pointer`}
            >
              <option value="">Select size...</option>
              <optgroup label="Youth">
                {JERSEY_SIZES.filter(s => s.category === 'Youth').map(s => (
                  <option key={s.value} value={s.value}>{s.label}</option>
                ))}
              </optgroup>
              <optgroup label="Adult">
                {JERSEY_SIZES.filter(s => s.category === 'Adult').map(s => (
                  <option key={s.value} value={s.value}>{s.label}</option>
                ))}
              </optgroup>
            </select>
            {newSize !== player.player?.uniform_size_jersey && newSize && (
              <button
                onClick={() => onUpdateSize(newSize)}
                className="mt-2 w-full py-2 rounded-lg bg-[var(--accent-primary)]/10 text-[var(--accent-primary)] font-medium hover:bg-[var(--accent-primary)]/20 transition"
              >
                Update Size to {newSize}
              </button>
            )}
          </div>

          {/* Status Change */}
          <div className={`pt-4 border-t ${tc.border}`}>
            <label className={`block text-sm font-medium ${tc.textMuted} mb-2`}>Order Status</label>
            {isOrdered ? (
              <button
                onClick={() => onChangeStatus(true)}
                className={`w-full py-3 rounded-xl font-medium ${tc.cardBgAlt} border ${tc.border} ${tc.text} ${tc.hoverBg} transition`}
              >
                ‚Ü©Ô∏è Move Back to "Ready to Order"
              </button>
            ) : (
              <button
                onClick={() => onChangeStatus(false)}
                className="w-full py-3 rounded-xl font-medium bg-emerald-500/10 text-emerald-500 hover:bg-emerald-500/20 transition"
              >
                ‚úÖ Mark as Ordered
              </button>
            )}
          </div>

          {/* Unassign */}
          <div className={`pt-4 border-t ${tc.border}`}>
            <button
              onClick={() => {
                if (confirm(`Unassign #${player.jersey_number} from ${playerData?.first_name}? This will move them back to "Needs Jersey".`)) {
                  onUnassign()
                }
              }}
              className="w-full py-3 rounded-xl font-medium bg-red-500/10 text-red-500 hover:bg-red-500/20 transition"
            >
              üóëÔ∏è Unassign Jersey
            </button>
          </div>
        </div>

        <div className={`p-4 border-t ${tc.border}`}>
          <button onClick={onClose} className={`w-full py-3 rounded-xl ${tc.cardBgAlt} ${tc.text} ${tc.hoverBg} transition`}>
            Close
          </button>
        </div>
      </div>
    </div>
  )
}

// ============================================
// CONFLICT RESOLVER MODAL
// ============================================
function ConflictResolverModal({ conflict, takenNumbers, teamColor, onAssign, onClose, tc, isDark }) {
  const [assignments, setAssignments] = useState({})

  function getAlternatives(player) {
    const prefs = [player.player?.jersey_pref_1, player.player?.jersey_pref_2, player.player?.jersey_pref_3].filter(Boolean)
    const available = prefs.filter(n => !takenNumbers.has(n) && n !== conflict.number)
    
    const nearby = []
    for (let offset = 1; offset <= 10; offset++) {
      if (!takenNumbers.has(conflict.number + offset) && conflict.number + offset <= 99) nearby.push(conflict.number + offset)
      if (!takenNumbers.has(conflict.number - offset) && conflict.number - offset > 0) nearby.push(conflict.number - offset)
    }
    
    return [...new Set([...available, ...nearby])].slice(0, 8)
  }

  return (
    <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50" onClick={onClose}>
      <div className={`${tc.cardBg} border ${tc.border} rounded-2xl w-full max-w-lg max-h-[90vh] overflow-hidden flex flex-col`} onClick={e => e.stopPropagation()}>
        <div className={`p-6 border-b ${tc.border}`}>
          <div className="flex items-center justify-between">
            <div>
              <h2 className={`text-xl font-semibold ${tc.text}`}>Resolve Conflict</h2>
              <p className={tc.textMuted}>{conflict.players.length} players want #{conflict.number}</p>
            </div>
            <button onClick={onClose} className={`${tc.textMuted} text-2xl`}>√ó</button>
          </div>
        </div>

        <div className="flex-1 overflow-y-auto p-6 space-y-4">
          <p className={tc.textSecondary}>
            Choose who gets #{conflict.number} and assign alternatives to others.
          </p>

          {conflict.players.map(p => {
            const player = p.player
            const alternatives = getAlternatives(p)
            const currentChoice = assignments[p.id]

            return (
              <div key={p.id} className={`${tc.cardBgAlt} border ${tc.border} rounded-xl p-4`}>
                <div className="flex items-center gap-3 mb-3">
                  <div className="w-10 h-10 rounded-full flex items-center justify-center font-bold"
                    style={{ backgroundColor: `${teamColor}30`, color: teamColor }}>
                    {player?.first_name?.[0]}{player?.last_name?.[0]}
                  </div>
                  <div className="flex-1">
                    <h4 className={`font-semibold ${tc.text}`}>{player?.first_name} {player?.last_name}</h4>
                  </div>
                  {currentChoice && (
                    <span className="px-2 py-1 rounded-lg text-sm font-bold text-white"
                      style={{ backgroundColor: teamColor || 'var(--accent-primary)' }}>
                      #{currentChoice}
                    </span>
                  )}
                </div>

                <div className="flex flex-wrap gap-2">
                  <button
                    onClick={() => setAssignments({ ...assignments, [p.id]: conflict.number })}
                    className={`px-3 py-2 rounded-lg font-semibold transition ${
                      currentChoice === conflict.number
                        ? 'text-white'
                        : 'bg-amber-500/20 text-amber-500 hover:bg-amber-500/30'
                    }`}
                    style={currentChoice === conflict.number ? { backgroundColor: teamColor || 'var(--accent-primary)' } : {}}
                  >
                    #{conflict.number}
                  </button>

                  {alternatives.map(num => (
                    <button
                      key={num}
                      onClick={() => setAssignments({ ...assignments, [p.id]: num })}
                      className={`px-3 py-2 rounded-lg font-semibold transition ${
                        currentChoice === num
                          ? 'text-white'
                          : `${tc.cardBg} border ${tc.border} ${tc.text} hover:border-[var(--accent-primary)]`
                      }`}
                      style={currentChoice === num ? { backgroundColor: teamColor || 'var(--accent-primary)' } : {}}
                    >
                      #{num}
                    </button>
                  ))}
                </div>
              </div>
            )
          })}
        </div>

        <div className={`p-4 border-t ${tc.border}`}>
          <button
            onClick={async () => {
              for (const p of conflict.players) {
                const num = assignments[p.id]
                if (num) {
                  await onAssign(p.player?.id, p.id, p.team_id, num)
                }
              }
              onClose()
            }}
            disabled={Object.keys(assignments).length < conflict.players.length}
            className="w-full py-3 rounded-xl font-semibold text-white bg-[var(--accent-primary)] hover:brightness-110 disabled:opacity-50 transition"
          >
            Apply Assignments ({Object.keys(assignments).length}/{conflict.players.length})
          </button>
        </div>
      </div>
    </div>
  )
}

// ============================================
// FULL LEAGUE REPORT MODAL
// ============================================
function FullLeagueReportModal({ allPlayers, teams, seasonName, onExport, onMarkOrdered, onClose, tc, isDark }) {
  const [selected, setSelected] = useState(new Set())

  // Filter to only those needing order
  const toOrder = allPlayers.filter(p => p.needsOrder)
  const alreadyOrdered = allPlayers.filter(p => p.isOrdered)

  // Group by team, then by size
  const byTeam = {}
  toOrder.forEach(p => {
    const teamName = p.team?.name || 'Unknown Team'
    if (!byTeam[teamName]) byTeam[teamName] = { color: p.team?.color, players: [] }
    byTeam[teamName].players.push(p)
  })

  // Size summary across all teams
  const sizeSummary = {}
  toOrder.forEach(p => {
    const size = p.player?.uniform_size_jersey || '‚ö†Ô∏è Unknown'
    sizeSummary[size] = (sizeSummary[size] || 0) + 1
  })

  const missingSize = toOrder.filter(p => !p.player?.uniform_size_jersey).length

  const toggleSelect = (id) => {
    const newSet = new Set(selected)
    if (newSet.has(id)) newSet.delete(id)
    else newSet.add(id)
    setSelected(newSet)
  }

  const selectAll = () => {
    if (selected.size === toOrder.length) setSelected(new Set())
    else setSelected(new Set(toOrder.map(p => p.id)))
  }

  return (
    <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50" onClick={onClose}>
      <div className={`${tc.cardBg} border ${tc.border} rounded-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col`} onClick={e => e.stopPropagation()}>
        <div className={`p-6 border-b ${tc.border} sticky top-0 ${tc.cardBg} z-10`}>
          <div className="flex items-center justify-between">
            <div>
              <h2 className={`text-xl font-semibold ${tc.text}`}>Full League Jersey Report</h2>
              <p className={tc.textMuted}>{seasonName} ‚Ä¢ {toOrder.length} jerseys to order</p>
            </div>
            <button onClick={onClose} className={`${tc.textMuted} text-2xl`}>√ó</button>
          </div>
        </div>

        <div className="flex-1 overflow-y-auto p-6 space-y-6">
          {/* Summary Cards */}
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div className={`${tc.cardBgAlt} border ${tc.border} rounded-xl p-4 text-center`}>
              <p className="text-3xl font-bold text-[var(--accent-primary)]">{toOrder.length}</p>
              <p className={tc.textMuted}>To Order</p>
            </div>
            <div className={`${tc.cardBgAlt} border ${tc.border} rounded-xl p-4 text-center`}>
              <p className="text-3xl font-bold text-emerald-500">{alreadyOrdered.length}</p>
              <p className={tc.textMuted}>Already Ordered</p>
            </div>
            <div className={`${tc.cardBgAlt} border ${tc.border} rounded-xl p-4 text-center`}>
              <p className="text-3xl font-bold">{Object.keys(byTeam).length}</p>
              <p className={tc.textMuted}>Teams</p>
            </div>
            <div className={`${tc.cardBgAlt} border ${tc.border} rounded-xl p-4 text-center`}>
              <p className={`text-3xl font-bold ${missingSize > 0 ? 'text-red-500' : tc.text}`}>{missingSize}</p>
              <p className={tc.textMuted}>Missing Size</p>
            </div>
          </div>

          {/* Size Breakdown */}
          <div className={`${tc.cardBgAlt} border ${tc.border} rounded-xl p-4`}>
            <h3 className={`font-semibold ${tc.text} mb-3`}>Order Summary by Size</h3>
            <div className="flex flex-wrap gap-3">
              {Object.entries(sizeSummary).sort().map(([size, count]) => (
                <div key={size} className={`px-4 py-2 rounded-lg ${isDark ? 'bg-slate-700' : 'bg-slate-200'}`}>
                  <span className={`font-bold ${size.includes('‚ö†Ô∏è') ? 'text-red-500' : tc.text}`}>{size}</span>
                  <span className={`ml-2 ${tc.textMuted}`}>√ó{count}</span>
                </div>
              ))}
            </div>
          </div>

          {/* Bulk Actions */}
          {toOrder.length > 0 && (
            <div className="flex items-center justify-between flex-wrap gap-3">
              <label className="flex items-center gap-2 cursor-pointer">
                <input
                  type="checkbox"
                  checked={selected.size === toOrder.length}
                  onChange={selectAll}
                  className="w-5 h-5 rounded"
                />
                <span className={tc.textSecondary}>Select All ({toOrder.length})</span>
              </label>
              {selected.size > 0 && (
                <button
                  onClick={() => {
                    const items = toOrder
                      .filter(p => selected.has(p.id))
                      .map(p => ({ playerId: p.player?.id, teamId: p.team_id, jerseyNumber: p.jersey_number }))
                    onMarkOrdered(items)
                    setSelected(new Set())
                  }}
                  className="px-4 py-2 rounded-xl font-semibold text-white bg-emerald-500 hover:bg-emerald-600 transition"
                >
                  ‚úÖ Mark {selected.size} as Ordered
                </button>
              )}
            </div>
          )}

          {/* By Team */}
          {Object.entries(byTeam).sort().map(([teamName, teamData]) => (
            <div key={teamName} className={`${tc.cardBgAlt} border ${tc.border} rounded-xl overflow-hidden`}>
              <div className="p-4 flex items-center gap-3" style={{ backgroundColor: `${teamData.color}20` }}>
                <div className="w-4 h-4 rounded-full" style={{ backgroundColor: teamData.color }} />
                <h3 className={`font-semibold ${tc.text}`}>{teamName}</h3>
                <span className={`px-2 py-0.5 rounded-full text-xs font-bold ${isDark ? 'bg-slate-700' : 'bg-white'}`}>
                  {teamData.players.length} jerseys
                </span>
              </div>
              <div className="p-4 space-y-2">
                {teamData.players.map(p => (
                  <div key={p.id} className="flex items-center gap-3">
                    <input
                      type="checkbox"
                      checked={selected.has(p.id)}
                      onChange={() => toggleSelect(p.id)}
                      className="w-4 h-4 rounded"
                    />
                    <div
                      className="w-9 h-9 rounded-lg flex items-center justify-center font-bold text-white text-sm"
                      style={{ backgroundColor: teamData.color }}
                    >
                      {p.jersey_number}
                    </div>
                    <span className={tc.text}>{p.player?.first_name} {p.player?.last_name}</span>
                    <span className={`text-sm ${!p.player?.uniform_size_jersey ? 'text-red-500' : tc.textMuted}`}>
                      {p.player?.uniform_size_jersey || '‚ö†Ô∏è No size'}
                    </span>
                  </div>
                ))}
              </div>
            </div>
          ))}

          {toOrder.length === 0 && (
            <div className="text-center py-12">
              <span className="text-5xl">üéâ</span>
              <h3 className={`text-lg font-semibold ${tc.text} mt-4`}>All Jerseys Ordered!</h3>
              <p className={tc.textMuted}>Nothing left to order for this season.</p>
            </div>
          )}
        </div>

        <div className={`p-4 border-t ${tc.border} flex gap-3 sticky bottom-0 ${tc.cardBg}`}>
          <button onClick={onClose} className={`flex-1 py-3 rounded-xl ${tc.cardBgAlt} ${tc.text} ${tc.hoverBg} transition`}>
            Close
          </button>
          {toOrder.length > 0 && (
            <button
              onClick={onExport}
              className="flex-1 py-3 rounded-xl font-semibold text-white bg-[var(--accent-primary)] hover:brightness-110 transition flex items-center justify-center gap-2"
            >
              üì• Download Order Spreadsheet
            </button>
          )}
        </div>
      </div>
    </div>
  )
}

// ============================================
// ORDER HISTORY MODAL
// ============================================
function OrderHistoryModal({ orderedPlayers, teams, seasonName, onClose, tc, isDark }) {
  // Group by ordered date
  const byDate = {}
  orderedPlayers.forEach(p => {
    const date = p.jersey_ordered_at || p.assignment?.jersey_ordered_at
    const dateKey = date ? new Date(date).toLocaleDateString() : 'Unknown Date'
    if (!byDate[dateKey]) byDate[dateKey] = []
    byDate[dateKey].push(p)
  })

  // Sort dates newest first
  const sortedDates = Object.keys(byDate).sort((a, b) => {
    if (a === 'Unknown Date') return 1
    if (b === 'Unknown Date') return -1
    return new Date(b) - new Date(a)
  })

  return (
    <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50" onClick={onClose}>
      <div className={`${tc.cardBg} border ${tc.border} rounded-2xl w-full max-w-2xl max-h-[85vh] overflow-hidden flex flex-col`} onClick={e => e.stopPropagation()}>
        {/* Header */}
        <div className={`p-6 border-b ${tc.border}`}>
          <div className="flex items-center justify-between">
            <div>
              <h2 className={`text-xl font-bold ${tc.text}`}>Jersey Order History</h2>
              <p className={tc.textMuted}>{seasonName} ‚Ä¢ {orderedPlayers.length} ordered</p>
            </div>
            <button onClick={onClose} className={`${tc.textMuted} hover:${tc.text} text-2xl`}>√ó</button>
          </div>
        </div>

        {/* Content */}
        <div className="flex-1 overflow-y-auto p-6 space-y-6">
          {orderedPlayers.length === 0 ? (
            <div className="text-center py-12">
              <Package className="w-16 h-16 mx-auto mb-4 text-slate-400" />
              <h3 className={`text-lg font-semibold ${tc.text}`}>No Orders Yet</h3>
              <p className={tc.textMuted}>Once jerseys are marked as ordered, they'll appear here.</p>
            </div>
          ) : (
            sortedDates.map(dateKey => (
              <div key={dateKey}>
                <div className="flex items-center gap-3 mb-3">
                  <Clock className="w-4 h-4 text-slate-400" />
                  <h3 className={`font-semibold ${tc.text}`}>{dateKey}</h3>
                  <span className={`px-2 py-0.5 rounded-full text-xs font-medium ${isDark ? 'bg-slate-700' : 'bg-slate-200'}`}>
                    {byDate[dateKey].length} jerseys
                  </span>
                </div>
                <div className={`${tc.cardBgAlt} border ${tc.border} rounded-xl overflow-hidden`}>
                  <table className="w-full">
                    <thead>
                      <tr className={`text-left text-sm ${tc.textMuted} border-b ${tc.border}`}>
                        <th className="p-3">#</th>
                        <th className="p-3">Player</th>
                        <th className="p-3">Team</th>
                        <th className="p-3">Size</th>
                      </tr>
                    </thead>
                    <tbody>
                      {byDate[dateKey].map(p => (
                        <tr key={p.id} className={`border-b ${tc.border} last:border-b-0`}>
                          <td className="p-3">
                            <span 
                              className="inline-flex items-center justify-center w-8 h-8 rounded-lg font-bold text-white text-sm"
                              style={{ backgroundColor: p.team?.color || '#888' }}
                            >
                              {p.jersey_number}
                            </span>
                          </td>
                          <td className={`p-3 ${tc.text}`}>
                            {p.player?.first_name} {p.player?.last_name}
                          </td>
                          <td className={`p-3 ${tc.textMuted}`}>
                            <span className="flex items-center gap-2">
                              <span className="w-2 h-2 rounded-full" style={{ backgroundColor: p.team?.color || '#888' }} />
                              {p.team?.name}
                            </span>
                          </td>
                          <td className={`p-3 ${tc.textMuted}`}>
                            {p.player?.uniform_size_jersey || '‚Äî'}
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            ))
          )}
        </div>

        {/* Footer */}
        <div className={`p-4 border-t ${tc.border}`}>
          <button 
            onClick={onClose}
            className={`w-full py-3 rounded-xl ${tc.cardBgAlt} ${tc.text} ${tc.hoverBg} transition`}
          >
            Close
          </button>
        </div>
      </div>
    </div>
  )
}


// ============================================
// ATTENDANCE & RSVP PAGE
// ============================================
function AttendancePage({ showToast }) {
  const { organization, user } = useAuth()
  const { selectedSeason } = useSeason()
  const [teams, setTeams] = useState([])
  const [selectedTeam, setSelectedTeam] = useState('all')
  const [events, setEvents] = useState([])
  const [loading, setLoading] = useState(true)
  const [selectedEvent, setSelectedEvent] = useState(null)
  const [rsvps, setRsvps] = useState([])
  const [volunteers, setVolunteers] = useState([])
  const [teamPlayers, setTeamPlayers] = useState([])
  const [viewMode, setViewMode] = useState('upcoming') // 'upcoming', 'past', 'all'
  const [loadingDetail, setLoadingDetail] = useState(false)
  const [selectedPlayerForCard, setSelectedPlayerForCard] = useState(null)
  const [availableParents, setAvailableParents] = useState([])
  const [volunteerAssignModal, setVolunteerAssignModal] = useState(null) // { role: 'line_judge', position: 'primary' }

  useEffect(() => {
    if (selectedSeason?.id) {
      loadTeams()
      loadEvents()
    }
  }, [selectedSeason?.id, selectedTeam, viewMode])

  async function loadTeams() {
    const { data } = await supabase
      .from('teams')
      .select('id, name, color')
      .eq('season_id', selectedSeason.id)
      .order('name')
    setTeams(data || [])
  }

  async function loadEvents() {
    setLoading(true)
    try {
      let query = supabase
        .from('schedule_events')
        .select('*, teams!schedule_events_team_id_fkey(id, name, color)')
        .eq('season_id', selectedSeason.id)
        .order('event_date', { ascending: viewMode !== 'past' })
        .order('event_time', { ascending: true })

      if (selectedTeam !== 'all') {
        query = query.eq('team_id', selectedTeam)
      }

      const today = new Date().toISOString().split('T')[0]
      if (viewMode === 'upcoming') {
        query = query.gte('event_date', today)
      } else if (viewMode === 'past') {
        query = query.lt('event_date', today)
      }

      const { data, error } = await query.limit(50)
      if (error) throw error

      // Load RSVP counts for each event
      const eventsWithCounts = await Promise.all((data || []).map(async (event) => {
        const { data: rsvpData } = await supabase
          .from('event_rsvps')
          .select('status')
          .eq('event_id', event.id)

        const counts = { yes: 0, no: 0, maybe: 0 }
        rsvpData?.forEach(r => {
          if (counts[r.status] !== undefined) counts[r.status]++
        })

        // For games, also check volunteers
        let volunteerInfo = null
        if (event.event_type === 'game') {
          const { data: volData } = await supabase
            .from('event_volunteers')
            .select('role, position')
            .eq('event_id', event.id)

          volunteerInfo = {
            line_judge: volData?.find(v => v.role === 'line_judge' && v.position === 'primary'),
            scorekeeper: volData?.find(v => v.role === 'scorekeeper' && v.position === 'primary')
          }
        }

        return { ...event, rsvp_counts: counts, volunteer_info: volunteerInfo }
      }))

      setEvents(eventsWithCounts)
    } catch (err) {
      console.error('Error loading events:', err)
      showToast('Error loading events', 'error')
    }
    setLoading(false)
  }

  async function loadEventDetails(event) {
    setLoadingDetail(true)
    setSelectedEvent(event)

    try {
      // Load RSVPs with player info
      const { data: rsvpData } = await supabase
        .from('event_rsvps')
        .select('*, players(id, first_name, last_name, jersey_number)')
        .eq('event_id', event.id)
      setRsvps(rsvpData || [])

      // Load volunteers with profile info
      const { data: volData } = await supabase
        .from('event_volunteers')
        .select('*, profiles(id, first_name, last_name)')
        .eq('event_id', event.id)
        .order('role')
        .order('position')
      setVolunteers(volData || [])

      // Load team players for RSVP tracking
      if (event.team_id) {
        const { data: playersData } = await supabase
          .from('team_players')
          .select('*, players(id, first_name, last_name, jersey_number)')
          .eq('team_id', event.team_id)
        setTeamPlayers(playersData || [])
      }

      // Load available parents for volunteer assignment
      const { data: parentsData } = await supabase
        .from('profiles')
        .select('id, first_name, last_name, full_name, email')
        .order('first_name')
      setAvailableParents(parentsData || [])
    } catch (err) {
      console.error('Error loading event details:', err)
    }
    setLoadingDetail(false)
  }

  async function updateRsvp(playerId, status) {
    if (!selectedEvent) return

    try {
      const existingRsvp = rsvps.find(r => r.player_id === playerId)

      if (existingRsvp) {
        await supabase
          .from('event_rsvps')
          .update({ status, updated_at: new Date().toISOString() })
          .eq('id', existingRsvp.id)
      } else {
        await supabase
          .from('event_rsvps')
          .insert({
            event_id: selectedEvent.id,
            player_id: playerId,
            status,
            responded_by: user?.id
          })
      }

      showToast('RSVP updated', 'success')
      loadEventDetails(selectedEvent)
      loadEvents()
    } catch (err) {
      showToast('Error updating RSVP', 'error')
    }
  }

  async function assignVolunteer(role, position, profileId) {
    if (!selectedEvent) return

    try {
      // Check if slot is taken
      const existing = volunteers.find(v => v.role === role && v.position === position)
      if (existing) {
        showToast('This slot is already filled', 'error')
        return
      }

      await supabase
        .from('event_volunteers')
        .insert({
          event_id: selectedEvent.id,
          profile_id: profileId,
          role,
          position
        })

      showToast('Volunteer assigned!', 'success')
      loadEventDetails(selectedEvent)
      loadEvents()
    } catch (err) {
      showToast('Error assigning volunteer', 'error')
    }
  }

  async function removeVolunteer(volunteerId) {
    if (!confirm('Remove this volunteer?')) return

    try {
      await supabase.from('event_volunteers').delete().eq('id', volunteerId)
      showToast('Volunteer removed', 'success')
      loadEventDetails(selectedEvent)
      loadEvents()
    } catch (err) {
      showToast('Error removing volunteer', 'error')
    }
  }

  const formatDate = (dateStr) => {
    const date = new Date(dateStr + 'T00:00:00')
    return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })
  }

  const formatTime = (timeStr) => {
    if (!timeStr) return ''
    const [hours, minutes] = timeStr.split(':')
    const h = parseInt(hours)
    const ampm = h >= 12 ? 'PM' : 'AM'
    const hour12 = h % 12 || 12
    return `${hour12}:${minutes} ${ampm}`
  }

  const eventTypeColors = {
    game: { bg: 'bg-red-500/20', text: 'text-red-400', label: 'Game' },
    practice: { bg: 'bg-cyan-500/20', text: 'text-cyan-400', label: 'Practice' },
    event: { bg: 'bg-purple-500/20', text: 'text-purple-400', label: 'Event' },
    tournament: { bg: 'bg-orange-500/20', text: 'text-orange-400', label: 'Tournament' }
  }

  // Stats
  const stats = {
    totalEvents: events.length,
    games: events.filter(e => e.event_type === 'game').length,
    practices: events.filter(e => e.event_type === 'practice').length,
    needsVolunteers: events.filter(e => e.event_type === 'game' && (!e.volunteer_info?.line_judge || !e.volunteer_info?.scorekeeper)).length
  }

  if (!selectedSeason) {
    return (
      <div className="p-8 text-center">
        <Check className="w-16 h-16 text-emerald-500 mb-4" />
        <h2 className="text-xl font-semibold text-white mb-2">No Season Selected</h2>
        <p className="text-slate-400">Please select a season to manage attendance</p>
      </div>
    )
  }

  return (
    <div className="p-8 max-w-7xl mx-auto">
      {/* Header */}
      <div className="flex items-center justify-between mb-6">
        <div>
          <h1 className="text-3xl font-bold text-white">Attendance & RSVP</h1>
          <p className="text-slate-400 mt-1">Track RSVPs and manage volunteers ‚Ä¢ {selectedSeason.name}</p>
        </div>
      </div>

      {/* Stats */}
      <div className="grid grid-cols-4 gap-4 mb-6">
        <div className="bg-slate-800 border border-slate-700 rounded-xl p-4 text-center">
          <div className="text-2xl font-bold text-white">{stats.totalEvents}</div>
          <div className="text-xs text-slate-400">Total Events</div>
        </div>
        <div className="bg-slate-800 border border-slate-700 rounded-xl p-4 text-center">
          <div className="text-2xl font-bold text-red-400">{stats.games}</div>
          <div className="text-xs text-slate-400">Games</div>
        </div>
        <div className="bg-slate-800 border border-slate-700 rounded-xl p-4 text-center">
          <div className="text-2xl font-bold text-cyan-400">{stats.practices}</div>
          <div className="text-xs text-slate-400">Practices</div>
        </div>
        <div className="bg-slate-800 border border-slate-700 rounded-xl p-4 text-center">
          <div className="text-2xl font-bold text-[var(--accent-primary)]">{stats.needsVolunteers}</div>
          <div className="text-xs text-slate-400">Need Volunteers</div>
        </div>
      </div>

      {/* Filters */}
      <div className="flex gap-4 mb-6">
        <select
          value={selectedTeam}
          onChange={e => setSelectedTeam(e.target.value)}
          className="bg-slate-800 border border-slate-700 rounded-xl px-4 py-2 text-white"
        >
          <option value="all">All Teams</option>
          {teams.map(team => (
            <option key={team.id} value={team.id}>{team.name}</option>
          ))}
        </select>

        <div className="flex bg-slate-800 rounded-xl p-1">
          {['upcoming', 'past', 'all'].map(mode => (
            <button
              key={mode}
              onClick={() => setViewMode(mode)}
              className={`px-4 py-2 rounded-lg text-sm font-medium transition ${
                viewMode === mode ? 'bg-[var(--accent-primary)] text-white' : 'text-slate-400 hover:text-white'
              }`}
            >
              {mode.charAt(0).toUpperCase() + mode.slice(1)}
            </button>
          ))}
        </div>
      </div>

      <div className="flex gap-6">
        {/* Events List */}
        <div className="flex-1">
          <h2 className="text-lg font-semibold text-white mb-4">Events</h2>
          
          {loading ? (
            <div className="text-center py-12 text-slate-400">Loading...</div>
          ) : events.length === 0 ? (
            <div className="bg-slate-800 border border-slate-700 rounded-2xl p-12 text-center">
              <Calendar className="w-16 h-16 mb-4" />
              <h3 className="text-xl font-semibold text-white mb-2">No Events Found</h3>
              <p className="text-slate-400">No {viewMode} events match your filters</p>
            </div>
          ) : (
            <div className="space-y-2">
              {events.map(event => {
                const typeConfig = eventTypeColors[event.event_type] || eventTypeColors.event
                const isSelected = selectedEvent?.id === event.id
                const needsVol = event.event_type === 'game' && (!event.volunteer_info?.line_judge || !event.volunteer_info?.scorekeeper)

                return (
                  <button
                    key={event.id}
                    onClick={() => loadEventDetails(event)}
                    className={`w-full text-left bg-slate-800 border rounded-xl p-4 transition ${
                      isSelected ? 'border-[var(--accent-primary)]' : 'border-slate-700 hover:border-slate-600'
                    }`}
                  >
                    <div className="flex items-start justify-between">
                      <div className="flex-1">
                        <div className="flex items-center gap-2 mb-1">
                          <span className={`px-2 py-0.5 rounded text-xs font-medium ${typeConfig.bg} ${typeConfig.text}`}>
                            {typeConfig.label}
                          </span>
                          {event.teams && (
                            <span 
                              className="px-2 py-0.5 rounded text-xs font-medium"
                              style={{ backgroundColor: `${event.teams.color}20`, color: event.teams.color }}
                            >
                              {event.teams.name}
                            </span>
                          )}
                          {needsVol && (
                            <span className="px-2 py-0.5 rounded text-xs font-medium bg-[var(--accent-primary)]/20 text-[var(--accent-primary)]">
                              ‚ö†Ô∏è Needs Volunteers
                            </span>
                          )}
                        </div>
                        <div className="text-white font-semibold">{event.title}</div>
                        <div className="text-sm text-slate-400">
                          {formatDate(event.event_date)} ‚Ä¢ {formatTime(event.event_time)}
                          {event.venue_name && ` ‚Ä¢ ${event.venue_name}`}
                        </div>
                      </div>
                      
                      {/* RSVP Summary */}
                      <div className="flex items-center gap-3 text-sm">
                        <span className="text-emerald-400">{event.rsvp_counts?.yes || 0} ‚úì</span>
                        <span className="text-red-400">{event.rsvp_counts?.no || 0} ‚úó</span>
                        <span className="text-[var(--accent-primary)]">{event.rsvp_counts?.maybe || 0} ?</span>
                      </div>
                    </div>
                  </button>
                )
              })}
            </div>
          )}
        </div>

        {/* Event Details Panel */}
        <div className="w-96">
          {selectedEvent ? (
            <div className="bg-slate-800 border border-slate-700 rounded-2xl sticky top-8">
              <div className="p-4 border-b border-slate-700">
                <div className="flex items-center justify-between">
                  <h2 className="text-lg font-semibold text-white">{selectedEvent.title}</h2>
                  <button onClick={() => setSelectedEvent(null)} className="text-slate-400 hover:text-white"><X className="w-4 h-4" /></button>
                </div>
                <p className="text-sm text-slate-400">{formatDate(selectedEvent.event_date)} ‚Ä¢ {formatTime(selectedEvent.event_time)}</p>
              </div>

              {loadingDetail ? (
                <div className="p-8 text-center text-slate-400">Loading...</div>
              ) : (
                <div className="p-4 max-h-[calc(100vh-300px)] overflow-y-auto">
                  {/* RSVP Section */}
                  <div className="mb-6">
                    <h3 className="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-3">RSVPs</h3>
                    
                    {/* RSVP Summary */}
                    <div className="flex gap-2 mb-4">
                      <div className="flex-1 bg-emerald-500/10 rounded-lg p-3 text-center">
                        <div className="text-xl font-bold text-emerald-400">{rsvps.filter(r => r.status === 'yes').length}</div>
                        <div className="text-xs text-emerald-400">Going</div>
                      </div>
                      <div className="flex-1 bg-red-500/10 rounded-lg p-3 text-center">
                        <div className="text-xl font-bold text-red-400">{rsvps.filter(r => r.status === 'no').length}</div>
                        <div className="text-xs text-red-400">Can't Go</div>
                      </div>
                      <div className="flex-1 bg-[var(--accent-primary)]/10 rounded-lg p-3 text-center">
                        <div className="text-xl font-bold text-[var(--accent-primary)]">{rsvps.filter(r => r.status === 'maybe').length}</div>
                        <div className="text-xs text-[var(--accent-primary)]">Maybe</div>
                      </div>
                    </div>

                    {/* Player List */}
                    <div className="space-y-2">
                      {teamPlayers.map(tp => {
                        const player = tp.players
                        if (!player) return null
                        const rsvp = rsvps.find(r => r.player_id === player.id)
                        const status = rsvp?.status

                        return (
                          <div key={tp.id} className="flex items-center justify-between bg-slate-900 rounded-lg p-2">
                            <div className="flex items-center gap-2">
                              {tp.jersey_number && (
                                <span className="w-6 h-6 rounded bg-[var(--accent-primary)]/20 text-[var(--accent-primary)] text-xs font-bold flex items-center justify-center">
                                  {tp.jersey_number}
                                </span>
                              )}
                              <ClickablePlayerName 
                                player={player}
                                onPlayerSelect={setSelectedPlayerForCard}
                                className="text-white text-sm"
                              />
                            </div>
                            <div className="flex gap-1">
                              {['yes', 'no', 'maybe'].map(s => (
                                <button
                                  key={s}
                                  onClick={() => updateRsvp(player.id, s)}
                                  className={`w-7 h-7 rounded-lg text-xs font-bold transition ${
                                    status === s
                                      ? s === 'yes' ? 'bg-emerald-500 text-white' 
                                        : s === 'no' ? 'bg-red-500 text-white' 
                                        : 'bg-yellow-500 text-black'
                                      : 'bg-slate-700 text-slate-500 hover:text-white'
                                  }`}
                                >
                                  {s === 'yes' ? '‚úì' : s === 'no' ? '‚úó' : '?'}
                                </button>
                              ))}
                            </div>
                          </div>
                        )
                      })}

                      {teamPlayers.length === 0 && (
                        <p className="text-center text-slate-500 text-sm py-4">No players on this team</p>
                      )}
                    </div>
                  </div>

                  {/* Volunteers Section (Games Only) */}
                  {selectedEvent.event_type === 'game' && (
                    <div>
                      <h3 className="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-3">Volunteers</h3>
                      
                      {/* Line Judge */}
                      <div className="bg-slate-900 rounded-xl p-3 mb-3">
                        <div className="flex items-center gap-2 mb-2">
                          <span>üö©</span>
                          <span className="text-white font-medium">Line Judge</span>
                        </div>
                        {['primary', 'backup_1', 'backup_2'].map(position => {
                          const vol = volunteers.find(v => v.role === 'line_judge' && v.position === position)
                          const isAssigning = volunteerAssignModal?.role === 'line_judge' && volunteerAssignModal?.position === position
                          return (
                            <div key={position} className="flex items-center justify-between py-1.5 border-t border-[#1a1a1a]">
                              <span className="text-xs text-slate-500 w-20">
                                {position === 'primary' ? 'Primary' : position === 'backup_1' ? 'Backup 1' : 'Backup 2'}
                              </span>
                              {vol ? (
                                <div className="flex items-center gap-2">
                                  <span className="text-white text-sm">
                                    {vol.profiles?.first_name} {vol.profiles?.last_name?.[0]}.
                                  </span>
                                  <button
                                    onClick={() => removeVolunteer(vol.id)}
                                    className="text-red-400 hover:text-red-300 text-xs"
                                  >
                                    ‚úï
                                  </button>
                                </div>
                              ) : isAssigning ? (
                                <div className="flex items-center gap-1">
                                  <select
                                    autoFocus
                                    onChange={(e) => {
                                      if (e.target.value) {
                                        assignVolunteer('line_judge', position, e.target.value)
                                      }
                                      setVolunteerAssignModal(null)
                                    }}
                                    onBlur={() => setVolunteerAssignModal(null)}
                                    className="bg-slate-700 border border-slate-700 rounded px-2 py-1 text-white text-xs max-w-[140px]"
                                  >
                                    <option value="">Select parent...</option>
                                    {availableParents
                                      .filter(p => !volunteers.some(v => v.profile_id === p.id))
                                      .map(parent => (
                                        <option key={parent.id} value={parent.id}>
                                          {parent.first_name || parent.full_name?.split(' ')[0]} {parent.last_name?.[0] || parent.full_name?.split(' ')[1]?.[0]}.
                                        </option>
                                      ))
                                    }
                                  </select>
                                  <button
                                    onClick={() => setVolunteerAssignModal(null)}
                                    className="text-slate-500 hover:text-white text-xs"
                                  >
                                    ‚úï
                                  </button>
                                </div>
                              ) : (
                                <button
                                  onClick={() => setVolunteerAssignModal({ role: 'line_judge', position })}
                                  className={`text-sm hover:underline ${position === 'primary' ? 'text-[var(--accent-primary)]' : 'text-slate-500 hover:text-[var(--accent-primary)]'}`}
                                >
                                  {position === 'primary' ? '+ Assign' : '+ Add'}
                                </button>
                              )}
                            </div>
                          )
                        })}
                      </div>

                      {/* Scorekeeper */}
                      <div className="bg-slate-900 rounded-xl p-3">
                        <div className="flex items-center gap-2 mb-2">
                          <ClipboardList className="w-5 h-5" />
                          <span className="text-white font-medium">Scorekeeper</span>
                        </div>
                        {['primary', 'backup_1', 'backup_2'].map(position => {
                          const vol = volunteers.find(v => v.role === 'scorekeeper' && v.position === position)
                          const isAssigning = volunteerAssignModal?.role === 'scorekeeper' && volunteerAssignModal?.position === position
                          return (
                            <div key={position} className="flex items-center justify-between py-1.5 border-t border-[#1a1a1a]">
                              <span className="text-xs text-slate-500 w-20">
                                {position === 'primary' ? 'Primary' : position === 'backup_1' ? 'Backup 1' : 'Backup 2'}
                              </span>
                              {vol ? (
                                <div className="flex items-center gap-2">
                                  <span className="text-white text-sm">
                                    {vol.profiles?.first_name} {vol.profiles?.last_name?.[0]}.
                                  </span>
                                  <button
                                    onClick={() => removeVolunteer(vol.id)}
                                    className="text-red-400 hover:text-red-300 text-xs"
                                  >
                                    ‚úï
                                  </button>
                                </div>
                              ) : isAssigning ? (
                                <div className="flex items-center gap-1">
                                  <select
                                    autoFocus
                                    onChange={(e) => {
                                      if (e.target.value) {
                                        assignVolunteer('scorekeeper', position, e.target.value)
                                      }
                                      setVolunteerAssignModal(null)
                                    }}
                                    onBlur={() => setVolunteerAssignModal(null)}
                                    className="bg-slate-700 border border-slate-700 rounded px-2 py-1 text-white text-xs max-w-[140px]"
                                  >
                                    <option value="">Select parent...</option>
                                    {availableParents
                                      .filter(p => !volunteers.some(v => v.profile_id === p.id))
                                      .map(parent => (
                                        <option key={parent.id} value={parent.id}>
                                          {parent.first_name || parent.full_name?.split(' ')[0]} {parent.last_name?.[0] || parent.full_name?.split(' ')[1]?.[0]}.
                                        </option>
                                      ))
                                    }
                                  </select>
                                  <button
                                    onClick={() => setVolunteerAssignModal(null)}
                                    className="text-slate-500 hover:text-white text-xs"
                                  >
                                    ‚úï
                                  </button>
                                </div>
                              ) : (
                                <button
                                  onClick={() => setVolunteerAssignModal({ role: 'scorekeeper', position })}
                                  className={`text-sm hover:underline ${position === 'primary' ? 'text-[var(--accent-primary)]' : 'text-slate-500 hover:text-[var(--accent-primary)]'}`}
                                >
                                  {position === 'primary' ? '+ Assign' : '+ Add'}
                                </button>
                              )}
                            </div>
                          )
                        })}
                      </div>
                    </div>
                  )}
                </div>
              )}
            </div>
          ) : (
            <div className="bg-slate-800 border border-slate-700 rounded-2xl p-8 text-center">
              <div className="text-4xl mb-3">üëà</div>
              <p className="text-slate-400">Select an event to view details</p>
            </div>
          )}
        </div>
      </div>

      {/* Player Card Modal */}
      {selectedPlayerForCard && (
        <PlayerCardExpanded
          player={selectedPlayerForCard}
          visible={!!selectedPlayerForCard}
          onClose={() => setSelectedPlayerForCard(null)}
          context="attendance"
        />
      )}
    </div>
  )
}

// ============================================
// TEAM WALL PAGE - Team Hub for Players/Parents/Coaches
// ============================================
function TeamWallPage({ teamId, showToast, onBack }) {
  const { profile, isAdmin } = useAuth()
  const tc = useThemeClasses()
  const { isDark } = useTheme()
  
  // Core data
  const [team, setTeam] = useState(null)
  const [roster, setRoster] = useState([])
  const [coaches, setCoaches] = useState([])
  const [upcomingEvents, setUpcomingEvents] = useState([])
  const [loading, setLoading] = useState(true)
  
  // Posts/Feed
  const [posts, setPosts] = useState([])
  const [documents, setDocuments] = useState([])
  const [activeTab, setActiveTab] = useState('feed')
  
  // Modals
  const [showNewPostModal, setShowNewPostModal] = useState(false)
  const [showUploadDocModal, setShowUploadDocModal] = useState(false)
  const [selectedPlayer, setSelectedPlayer] = useState(null)
  const [selectedCoach, setSelectedCoach] = useState(null)
  const [expandedPost, setExpandedPost] = useState(null)
  const [selectedEvent, setSelectedEvent] = useState(null)
  
  // User permissions - use isAdmin from auth context
  const isCoachOrAdmin = isAdmin || profile?.role === 'coach'

  // Debug: Log permission info
  useEffect(() => {
    console.log('Permission check:', { isAdmin, profileRole: profile?.role, isCoachOrAdmin })
  }, [isAdmin, profile, isCoachOrAdmin])

  useEffect(() => {
    if (teamId) loadTeamData()
  }, [teamId])

  async function loadTeamData() {
    setLoading(true)
    try {
      // Load team details
      const { data: teamData } = await supabase
        .from('teams')
        .select('*, seasons(name, status)')
        .eq('id', teamId)
        .single()
      setTeam(teamData)

      // Load roster
      const { data: rosterData } = await supabase
        .from('team_players')
        .select('*, players(id, first_name, last_name, jersey_number, position, photo_url, grade)')
        .eq('team_id', teamId)
      setRoster(rosterData?.map(tp => tp.players).filter(Boolean) || [])

      // Load coaches - two-step query for reliability
      const { data: teamCoachLinks, error: linkError } = await supabase
        .from('team_coaches')
        .select('coach_id, role')
        .eq('team_id', teamId)
      
      console.log('Team coach links:', teamCoachLinks, 'Error:', linkError)
      
      if (teamCoachLinks && teamCoachLinks.length > 0) {
        const coachIds = teamCoachLinks.map(tc => tc.coach_id)
        const { data: coachDetails, error: coachError } = await supabase
          .from('coaches')
          .select('*')
          .in('id', coachIds)
        
        console.log('Coach details:', coachDetails, 'Error:', coachError)
        
        // Merge role info with coach details
        const mappedCoaches = (coachDetails || []).map(coach => {
          const link = teamCoachLinks.find(tc => tc.coach_id === coach.id)
          return {
            ...coach,
            assignment_role: link?.role || 'coach'
          }
        })
        console.log('Final coaches:', mappedCoaches)
        setCoaches(mappedCoaches)
      } else {
        setCoaches([])
      }

      // Load upcoming events (next 5)
      const today = new Date().toISOString().split('T')[0]
      console.log('Loading events for team:', teamId, 'from date:', today)
      const { data: eventsData, error: eventsError } = await supabase
        .from('schedule_events')
        .select('*')
        .eq('team_id', teamId)
        .gte('event_date', today)
        .order('event_date', { ascending: true })
        .order('event_time', { ascending: true })
        .limit(5)
      console.log('Events loaded:', eventsData, 'Error:', eventsError)
      setUpcomingEvents(eventsData || [])

      // Load posts
      const { data: postsData } = await supabase
        .from('team_posts')
        .select('*, profiles(id, full_name, avatar_url)')
        .eq('team_id', teamId)
        .eq('is_published', true)
        .order('is_pinned', { ascending: false })
        .order('created_at', { ascending: false })
        .limit(20)
      setPosts(postsData || [])

      // Load documents
      const { data: docsData } = await supabase
        .from('team_documents')
        .select('*, profiles:uploaded_by(full_name)')
        .eq('team_id', teamId)
        .eq('is_archived', false)
        .order('created_at', { ascending: false })
      setDocuments(docsData || [])

    } catch (err) {
      console.error('Error loading team data:', err)
    }
    setLoading(false)
  }

  async function createPost(postData) {
    try {
      const { error } = await supabase.from('team_posts').insert({
        team_id: teamId,
        author_id: profile.id,
        ...postData
      })
      if (error) throw error
      showToast('Post created!', 'success')
      setShowNewPostModal(false)
      loadTeamData()
    } catch (err) {
      showToast('Error: ' + err.message, 'error')
    }
  }

  async function toggleReaction(postId, reactionType = 'like') {
    try {
      // Check if user already reacted
      const { data: existing } = await supabase
        .from('team_post_reactions')
        .select('id')
        .eq('post_id', postId)
        .eq('user_id', profile.id)
        .single()

      if (existing) {
        // Remove reaction
        await supabase.from('team_post_reactions').delete().eq('id', existing.id)
      } else {
        // Add reaction
        await supabase.from('team_post_reactions').insert({
          post_id: postId,
          user_id: profile.id,
          reaction_type: reactionType
        })
      }
      loadTeamData()
    } catch (err) {
      console.error('Reaction error:', err)
    }
  }

  async function addComment(postId, content) {
    try {
      await supabase.from('team_post_comments').insert({
        post_id: postId,
        author_id: profile.id,
        content
      })
      loadTeamData()
    } catch (err) {
      showToast('Error adding comment', 'error')
    }
  }

  async function deletePost(postId) {
    if (!confirm('Delete this post?')) return
    try {
      await supabase.from('team_posts').delete().eq('id', postId)
      showToast('Post deleted', 'success')
      loadTeamData()
    } catch (err) {
      showToast('Error deleting post', 'error')
    }
  }

  async function uploadDocument(docData) {
    try {
      await supabase.from('team_documents').insert({
        team_id: teamId,
        uploaded_by: profile.id,
        ...docData
      })
      showToast('Document uploaded!', 'success')
      setShowUploadDocModal(false)
      loadTeamData()
    } catch (err) {
      showToast('Error: ' + err.message, 'error')
    }
  }

  if (loading) {
    return (
      <div className="flex items-center justify-center h-96">
        <div className="text-center">
          <div className="w-12 h-12 border-4 border-[var(--accent-primary)] border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
          <p className={tc.textSecondary}>Loading team...</p>
        </div>
      </div>
    )
  }

  if (!team) {
    return (
      <div className="text-center py-20">
        <span className="text-6xl"><VolleyballIcon className="w-16 h-16" /></span>
        <h2 className={`text-xl font-bold ${tc.text} mt-4`}>Team not found</h2>
        <button onClick={onBack} className="mt-4 text-[var(--accent-primary)] hover:underline">‚Üê Go back</button>
      </div>
    )
  }

  const teamColor = team.color || '#EAB308'

  return (
    <div className="min-h-screen relative">
      {/* Watermark Background */}
      {team.logo_url && (
        <div 
          className="absolute inset-0 opacity-5 bg-no-repeat bg-center pointer-events-none"
          style={{ 
            backgroundImage: `url(${team.logo_url})`,
            backgroundSize: '60%',
          }}
        />
      )}
      
      {/* Content */}
      <div className="relative z-10 space-y-6">
        {/* Back Button */}
        {onBack && (
          <button onClick={onBack} className={`${tc.textSecondary} hover:${tc.text} flex items-center gap-2`}>
            ‚Üê Back to Teams
          </button>
        )}

        {/* Team Header Card */}
        <div 
          className="rounded-2xl p-6 relative overflow-hidden"
          style={{ 
            background: `linear-gradient(135deg, ${teamColor}20 0%, ${teamColor}05 100%)`,
            borderLeft: `4px solid ${teamColor}`
          }}
        >
          <div className="flex items-start justify-between">
            <div className="flex items-center gap-5">
              {/* Team Logo/Avatar */}
              {team.logo_url ? (
                <img src={team.logo_url} alt="" className="w-20 h-20 rounded-xl object-cover" style={{ border: `3px solid ${teamColor}` }} />
              ) : (
                <div 
                  className="w-20 h-20 rounded-xl flex items-center justify-center"
                  style={{ background: `${teamColor}30`, border: `3px solid ${teamColor}` }}
                >
                  <VolleyballIcon className="w-10 h-10" style={{ color: teamColor }} />
                </div>
              )}
              
              <div>
                <h1 className={`text-3xl font-bold ${tc.text}`} style={{ color: teamColor }}>
                  {team.name}
                </h1>
                {team.motto && <p className={`${tc.textSecondary} italic mt-1`}>"{team.motto}"</p>}
                <div className="flex items-center gap-4 mt-2">
                  <span className={`${tc.textSecondary} text-sm flex items-center gap-1`}>
                    <Calendar className="w-4 h-4" /> {team.seasons?.name || 'Current Season'}
                  </span>
                  <span className={`${tc.textSecondary} text-sm flex items-center gap-1`}>
                    <Users className="w-4 h-4" /> {roster.length} Players
                  </span>
                  <span className={`${tc.textSecondary} text-sm flex items-center gap-1`}>
                    <UserCog className="w-4 h-4" /> {coaches.length} Coaches
                  </span>
                </div>
              </div>
            </div>

            {/* Quick Actions */}
            <div className="flex gap-2">
              <button
                onClick={() => {
                  const url = `${window.location.origin}${window.location.pathname}#/team/${teamId}`
                  navigator.clipboard.writeText(url)
                  showToast('Link copied! Share with parents.', 'success')
                }}
                className={`px-3 py-2 rounded-xl text-sm ${tc.cardBgAlt} ${tc.textSecondary} hover:${tc.text} transition`}
                title="Copy shareable link"
              >
                üîó Copy Link
              </button>
              {isCoachOrAdmin && (
                <button
                  onClick={() => setShowNewPostModal(true)}
                  className="px-4 py-2 rounded-xl font-semibold text-sm flex items-center gap-2"
                  style={{ background: teamColor, color: '#000' }}
                >
                  <Edit className="w-4 h-4" /> New Post
                </button>
              )}
            </div>
          </div>
        </div>

        {/* Upcoming Events Banner - Always show */}
        <div className={`${tc.cardBg} rounded-2xl p-5 border ${tc.border}`}>
          <div className="flex items-center justify-between mb-4">
            <h2 className={`font-bold ${tc.text} flex items-center gap-2`}>
              üìÜ Upcoming Events
            </h2>
            {upcomingEvents.length > 0 && (
              <span className={`text-xs ${tc.textMuted}`}>{upcomingEvents.length} upcoming</span>
            )}
          </div>
          
          {upcomingEvents.length > 0 ? (
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              {upcomingEvents.slice(0, 3).map(event => (
                <EventMiniCard 
                  key={event.id} 
                  event={event} 
                  teamColor={teamColor}
                  onClick={() => setSelectedEvent(event)}
                />
              ))}
            </div>
          ) : (
            <div className="text-center py-6">
              <Calendar className="w-10 h-10" />
              <p className={`${tc.textSecondary} mt-2`}>No upcoming events scheduled</p>
              <p className={`${tc.textMuted} text-sm mt-1`}>Events will appear here when scheduled for this team</p>
            </div>
          )}
        </div>

        {/* Tab Navigation */}
        <div className={`flex gap-1 p-1 rounded-xl ${tc.cardBg} border ${tc.border} w-fit`}>
          {[
            { id: 'feed', label: 'Feed', count: posts.length },
            { id: 'roster', label: 'Roster', count: roster.length },
            { id: 'coaches', label: 'Coach Coaches', count: coaches.length },
            { id: 'documents', label: 'üìÅ Documents', count: documents.length },
          ].map(tab => (
            <button
              key={tab.id}
              onClick={() => setActiveTab(tab.id)}
              className={`px-4 py-2 rounded-lg text-sm font-medium transition ${
                activeTab === tab.id 
                  ? 'text-black' 
                  : `${tc.textSecondary} hover:${tc.text}`
              }`}
              style={activeTab === tab.id ? { background: teamColor } : {}}
            >
              {tab.label} {tab.count > 0 && `(${tab.count})`}
            </button>
          ))}
        </div>

        {/* Tab Content */}
        <div className="pb-8">
          {/* Feed Tab */}
          {activeTab === 'feed' && (
            <div className="space-y-4">
              {posts.length === 0 ? (
                <div className={`${tc.cardBg} rounded-2xl p-12 text-center border ${tc.border}`}>
                  <Megaphone className="w-12 h-12 mx-auto text-slate-400" />
                  <h3 className={`text-lg font-medium ${tc.text} mt-4`}>No posts yet</h3>
                  <p className={`${tc.textSecondary} mt-2`}>
                    {isCoachOrAdmin ? "Create the first post to share with the team!" : "Check back soon for team updates!"}
                  </p>
                  {isCoachOrAdmin && (
                    <button
                      onClick={() => setShowNewPostModal(true)}
                      className="mt-4 px-6 py-2 rounded-xl font-semibold"
                      style={{ background: teamColor, color: '#000' }}
                    >
                      Create First Post
                    </button>
                  )}
                </div>
              ) : (
                posts.map(post => (
                  <PostCard 
                    key={post.id} 
                    post={post} 
                    teamColor={teamColor}
                    onReact={() => toggleReaction(post.id)}
                    onComment={(content) => addComment(post.id, content)}
                    onDelete={isCoachOrAdmin ? () => deletePost(post.id) : null}
                    onExpand={() => setExpandedPost(post)}
                    currentUserId={profile?.id}
                  />
                ))
              )}
            </div>
          )}

          {/* Roster Tab */}
          {activeTab === 'roster' && (
            <div className={`${tc.cardBg} rounded-2xl p-6 border ${tc.border}`}>
              {roster.length === 0 ? (
                <div className="text-center py-12">
                  <Users className="w-12 h-12" />
                  <h3 className={`text-lg font-medium ${tc.text} mt-4`}>No players on roster</h3>
                </div>
              ) : (
                <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                  {roster.map(player => (
                    <div
                      key={player.id}
                      onClick={() => setSelectedPlayer(player)}
                      className="cursor-pointer group"
                    >
                      <div 
                        className="rounded-xl p-4 text-center transition group-hover:scale-105"
                        style={{ background: `${teamColor}15`, border: `2px solid ${teamColor}30` }}
                      >
                        {player.photo_url ? (
                          <img src={player.photo_url} alt="" className="w-16 h-16 rounded-full mx-auto object-cover border-2" style={{ borderColor: teamColor }} />
                        ) : (
                          <div className="w-16 h-16 rounded-full mx-auto flex items-center justify-center text-2xl" style={{ background: `${teamColor}30` }}>
                            {player.jersey_number || '-'}
                          </div>
                        )}
                        <p className={`font-medium ${tc.text} mt-2 text-sm`}>{player.first_name} {player.last_name?.[0]}.</p>
                        <div className="flex items-center justify-center gap-2 mt-1">
                          {player.jersey_number && (
                            <span className="text-xs font-bold px-2 py-0.5 rounded" style={{ background: teamColor, color: '#000' }}>
                              #{player.jersey_number}
                            </span>
                          )}
                          {player.position && (
                            <span className={`text-xs ${tc.textMuted}`}>{player.position}</span>
                          )}
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}

          {/* Coaches Tab */}
          {activeTab === 'coaches' && (
            <div className={`${tc.cardBg} rounded-2xl p-6 border ${tc.border}`}>
              {coaches.length === 0 ? (
                <div className="text-center py-12">
                  <span className="text-5xl">Coach</span>
                  <h3 className={`text-lg font-medium ${tc.text} mt-4`}>No coaches assigned</h3>
                </div>
              ) : (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {coaches.map(coach => (
                    <div
                      key={coach.id}
                      onClick={() => setSelectedCoach(coach)}
                      className="cursor-pointer"
                    >
                      <div 
                        className={`rounded-xl p-4 flex items-center gap-4 transition hover:scale-[1.02]`}
                        style={{ background: isDark ? '#0a0a0a' : '#f3f4f6' }}
                      >
                        {coach.photo_url ? (
                          <img src={coach.photo_url} alt="" className="w-16 h-16 rounded-full object-cover border-2 border-blue-500" />
                        ) : (
                          <div className="w-16 h-16 rounded-full bg-blue-500/20 flex items-center justify-center">
                            <UserCog className="w-8 h-8 text-blue-400" />
                          </div>
                        )}
                        <div className="flex-1">
                          <p className={`font-semibold ${tc.text}`}>{coach.first_name} {coach.last_name}</p>
                          <p className="text-blue-400 text-sm">{coach.assignment_role === 'head' ? 'Head Coach' : coach.assignment_role || 'Coach'}</p>
                          <div className="flex gap-3 mt-2">
                            {coach.email && (
                              <a href={`mailto:${coach.email}`} onClick={e => e.stopPropagation()} className="text-xs text-[var(--accent-primary)] hover:underline">Email</a>
                            )}
                            {coach.phone && (
                              <a href={`tel:${coach.phone}`} onClick={e => e.stopPropagation()} className="text-xs text-[var(--accent-primary)] hover:underline">Call</a>
                            )}
                          </div>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}

          {/* Documents Tab */}
          {activeTab === 'documents' && (
            <div className={`${tc.cardBg} rounded-2xl p-6 border ${tc.border}`}>
              <div className="flex items-center justify-between mb-4">
                <h3 className={`font-semibold ${tc.text}`}>Team Documents</h3>
                {isCoachOrAdmin && (
                  <button
                    onClick={() => setShowUploadDocModal(true)}
                    className="px-3 py-1.5 rounded-lg text-sm font-medium"
                    style={{ background: teamColor, color: '#000' }}
                  >
                    üì§ Upload
                  </button>
                )}
              </div>
              
              {documents.length === 0 ? (
                <div className="text-center py-12">
                  <span className="text-5xl">üìÅ</span>
                  <h3 className={`text-lg font-medium ${tc.text} mt-4`}>No documents yet</h3>
                  <p className={`${tc.textSecondary} mt-2`}>Team documents will appear here</p>
                </div>
              ) : (
                <div className="space-y-2">
                  {documents.map(doc => (
                    <a
                      key={doc.id}
                      href={doc.file_url}
                      target="_blank"
                      rel="noopener noreferrer"
                      className={`flex items-center justify-between p-3 rounded-xl transition ${tc.hoverBg}`}
                      style={{ background: isDark ? '#0a0a0a' : '#f3f4f6' }}
                    >
                      <div className="flex items-center gap-3">
                        <span className="text-2xl">
                          {doc.file_type === 'pdf' ? 'üìï' : doc.file_type === 'image' ? 'üñºÔ∏è' : 'üìÑ'}
                        </span>
                        <div>
                          <p className={`font-medium ${tc.text}`}>{doc.name}</p>
                          {doc.description && <p className={`text-xs ${tc.textMuted}`}>{doc.description}</p>}
                        </div>
                      </div>
                      <div className={`text-xs ${tc.textMuted}`}>
                        {doc.category && <span className="mr-2 px-2 py-0.5 rounded bg-gray-500/20">{doc.category}</span>}
                        {new Date(doc.created_at).toLocaleDateString()}
                      </div>
                    </a>
                  ))}
                </div>
              )}
            </div>
          )}
        </div>
      </div>

      {/* Modals */}
      {showNewPostModal && (
        <NewPostModal
          teamColor={teamColor}
          onClose={() => setShowNewPostModal(false)}
          onSubmit={createPost}
        />
      )}

      {showUploadDocModal && (
        <UploadDocumentModal
          onClose={() => setShowUploadDocModal(false)}
          onSubmit={uploadDocument}
        />
      )}

      {selectedPlayer && (
        <PlayerCardExpanded
          player={selectedPlayer}
          visible={!!selectedPlayer}
          onClose={() => setSelectedPlayer(null)}
          context="roster"
        />
      )}

      {selectedCoach && (
        <CoachDetailModal
          coach={selectedCoach}
          onClose={() => setSelectedCoach(null)}
        />
      )}

      {selectedEvent && (
        <TeamWallEventModal
          event={selectedEvent}
          teamColor={teamColor}
          onClose={() => setSelectedEvent(null)}
        />
      )}
    </div>
  )
}

// Simple Event Detail Modal for Team Wall (read-only, parent-friendly)
function TeamWallEventModal({ event, teamColor, onClose }) {
  const tc = useThemeClasses()
  const { isDark } = useTheme()
  
  const eventDate = new Date(event.event_date)
  const formattedDate = eventDate.toLocaleDateString('en-US', { 
    weekday: 'long', 
    month: 'long', 
    day: 'numeric',
    year: 'numeric'
  })
  
  const typeLabels = {
    practice: { label: 'Practice', icon: 'volleyball', color: '#22C55E' },
    game: { label: 'Game', icon: 'trophy', color: '#F59E0B' },
    tournament: { label: 'Tournament', icon: 'target', color: '#8B5CF6' },
    meeting: { label: 'Team Meeting', icon: 'clipboard', color: '#3B82F6' },
    other: { label: 'Event', icon: 'üìå', color: '#6B7280' }
  }
  
  const eventType = typeLabels[event.event_type] || typeLabels.other

  return (
    <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50" onClick={onClose}>
      <div 
        className={`${tc.cardBg} border ${tc.border} rounded-2xl w-full max-w-md overflow-hidden`}
        onClick={e => e.stopPropagation()}
      >
        {/* Header */}
        <div 
          className="p-5 relative overflow-hidden"
          style={{ background: `linear-gradient(135deg, ${teamColor}30 0%, ${teamColor}10 100%)` }}
        >
          <div className="flex items-start justify-between">
            <div className="flex items-center gap-3">
              <div 
                className="w-14 h-14 rounded-xl flex items-center justify-center text-2xl"
                style={{ background: `${eventType.color}20` }}
              >
                {eventType.icon}
              </div>
              <div>
                <span 
                  className="px-2 py-0.5 rounded-full text-xs font-semibold"
                  style={{ background: eventType.color, color: '#fff' }}
                >
                  {eventType.label}
                </span>
                <h2 className={`text-xl font-bold ${tc.text} mt-1`}>
                  {event.title || eventType.label}
                </h2>
              </div>
            </div>
            <button onClick={onClose} className={`${tc.textSecondary} hover:${tc.text} text-2xl`}>√ó</button>
          </div>
        </div>

        {/* Content */}
        <div className="p-5 space-y-4">
          {/* Date & Time */}
          <div className="flex items-start gap-3">
            <Calendar className="w-6 h-6" />
            <div>
              <p className={`font-medium ${tc.text}`}>{formattedDate}</p>
              {event.event_time && (
                <p className={tc.textSecondary}>
                  {formatTime12(event.event_time)}
                  {event.end_time && ` - ${formatTime12(event.end_time)}`}
                </p>
              )}
            </div>
          </div>

          {/* Location */}
          {(event.venue_name || event.venue_address) && (
            <div className="flex items-start gap-3">
              <span className="text-xl">üìç</span>
              <div>
                {event.venue_name && <p className={`font-medium ${tc.text}`}>{event.venue_name}</p>}
                {event.venue_address && (
                  <a 
                    href={`https://maps.google.com/?q=${encodeURIComponent(event.venue_address)}`}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="text-[var(--accent-primary)] hover:underline text-sm"
                  >
                    {event.venue_address} ‚Üí
                  </a>
                )}
              </div>
            </div>
          )}

          {/* Opponent (for games) */}
          {event.event_type === 'game' && event.opponent_name && (
            <div className="flex items-start gap-3">
              <span className="text-xl">‚öîÔ∏è</span>
              <div>
                <p className={tc.textSecondary}>Opponent</p>
                <p className={`font-medium ${tc.text}`}>{event.opponent_name}</p>
              </div>
            </div>
          )}

          {/* Home/Away */}
          {event.location_type && (
            <div className="flex items-start gap-3">
              <span className="text-xl">{event.location_type === 'home' ? 'üè†' : 'üöó'}</span>
              <div>
                <p className={`font-medium ${tc.text}`}>
                  {event.location_type === 'home' ? 'Home Game' : 'Away Game'}
                </p>
              </div>
            </div>
          )}

          {/* Description */}
          {event.description && (
            <div className="flex items-start gap-3">
              <span className="text-xl">üìù</span>
              <div>
                <p className={tc.textSecondary}>Notes</p>
                <p className={`${tc.text} text-sm whitespace-pre-wrap`}>{event.description}</p>
              </div>
            </div>
          )}
        </div>

        {/* Footer */}
        <div className={`p-4 border-t ${tc.border} flex justify-between items-center`}>
          <div className={`text-xs ${tc.textMuted}`}>
            {event.event_type === 'game' && 'üèÜ Game Day!'}
            {event.event_type === 'practice' && 'üí™ Let\'s work hard!'}
            {event.event_type === 'tournament' && 'üéØ Tournament time!'}
          </div>
          <button
            onClick={onClose}
            className="px-6 py-2 rounded-xl font-semibold"
            style={{ background: teamColor, color: '#000' }}
          >
            Got it!
          </button>
        </div>
      </div>
    </div>
  )
}

// Mini Event Card for Team Wall
function EventMiniCard({ event, teamColor, onClick }) {
  const tc = useThemeClasses()
  const { isDark } = useTheme()
  
  const eventDate = new Date(event.event_date)
  const dayName = eventDate.toLocaleDateString('en-US', { weekday: 'short' })
  const monthDay = eventDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
  
  const typeIcons = {
    practice: 'practice',
    game: 'üèÜ',
    tournament: 'üéØ',
    meeting: 'üìã',
    other: 'üìå'
  }

  return (
    <div 
      className="rounded-xl p-4 transition hover:scale-[1.02] cursor-pointer"
      style={{ background: isDark ? '#0a0a0a' : '#f3f4f6' }}
      onClick={onClick}
    >
      <div className="flex items-start gap-3">
        <div 
          className="w-12 h-12 rounded-lg flex flex-col items-center justify-center text-xs font-bold"
          style={{ background: `${teamColor}20`, color: teamColor }}
        >
          <span>{dayName}</span>
          <span className="text-sm">{eventDate.getDate()}</span>
        </div>
        <div className="flex-1 min-w-0">
          <p className={`font-medium ${tc.text} text-sm truncate`}>
            {typeIcons[event.event_type] || 'üìå'} {event.title || event.event_type}
          </p>
          <p className={`text-xs ${tc.textMuted} mt-0.5`}>
            {event.event_time && formatTime12(event.event_time)}
            {event.venue_name && ` ‚Ä¢ ${event.venue_name}`}
          </p>
          {event.event_type === 'game' && event.opponent_name && (
            <p className="text-xs text-orange-400 mt-1">vs {event.opponent_name}</p>
          )}
        </div>
      </div>
    </div>
  )
}

// Post Card Component
function PostCard({ post, teamColor, onReact, onComment, onDelete, onExpand, currentUserId }) {
  const tc = useThemeClasses()
  const { isDark } = useTheme()
  const [showCommentInput, setShowCommentInput] = useState(false)
  const [commentText, setCommentText] = useState('')
  const [userReacted, setUserReacted] = useState(false)

  const PostTypeIcon = ({ type }) => {
    switch(type) {
      case 'announcement': return <Megaphone className="w-4 h-4 inline" />
      case 'photo': return <Camera className="w-4 h-4 inline" />
      case 'milestone': return <Trophy className="w-4 h-4 inline" />
      case 'game_recap': return <BarChart3 className="w-4 h-4 inline" />
      case 'shoutout': return <Star className="w-4 h-4 inline" />
      default: return <Megaphone className="w-4 h-4 inline" />
    }
  }

  const timeAgo = (date) => {
    const seconds = Math.floor((new Date() - new Date(date)) / 1000)
    if (seconds < 60) return 'Just now'
    const minutes = Math.floor(seconds / 60)
    if (minutes < 60) return `${minutes}m ago`
    const hours = Math.floor(minutes / 60)
    if (hours < 24) return `${hours}h ago`
    const days = Math.floor(hours / 24)
    if (days < 7) return `${days}d ago`
    return new Date(date).toLocaleDateString()
  }

  const handleComment = () => {
    if (commentText.trim()) {
      onComment(commentText)
      setCommentText('')
      setShowCommentInput(false)
    }
  }

  return (
    <div className={`${tc.cardBg} rounded-2xl border ${tc.border} overflow-hidden`}>
      {/* Post Header */}
      <div className="p-4 flex items-start justify-between">
        <div className="flex items-center gap-3">
          {post.profiles?.avatar_url ? (
            <img src={post.profiles.avatar_url} alt="" className="w-10 h-10 rounded-full object-cover" />
          ) : (
            <div className="w-10 h-10 rounded-full flex items-center justify-center text-lg" style={{ background: `${teamColor}30` }}>
              {post.profiles?.full_name?.[0] || '?'}
            </div>
          )}
          <div>
            <p className={`font-medium ${tc.text}`}>{post.profiles?.full_name || 'Team Admin'}</p>
            <p className={`text-xs ${tc.textMuted} flex items-center gap-1`}>
              <PostTypeIcon type={post.post_type} /> {timeAgo(post.created_at)}
              {post.is_pinned && <span className="ml-2 text-[var(--accent-primary)] flex items-center gap-1"><Flag className="w-3 h-3" />Pinned</span>}
            </p>
          </div>
        </div>
        {onDelete && post.author_id === currentUserId && (
          <button onClick={onDelete} className="text-slate-500 hover:text-red-400 text-sm"><Trash2 className="w-4 h-4" /></button>
        )}
      </div>

      {/* Post Content */}
      <div className="px-4 pb-3">
        {post.title && <h3 className={`font-semibold ${tc.text} text-lg mb-2`}>{post.title}</h3>}
        {post.content && <p className={`${tc.textSecondary} whitespace-pre-wrap`}>{post.content}</p>}
      </div>

      {/* Media Grid */}
      {post.media_urls && post.media_urls.length > 0 && (
        <div className={`px-4 pb-3 grid gap-2 ${post.media_urls.length === 1 ? 'grid-cols-1' : 'grid-cols-2'}`}>
          {post.media_urls.slice(0, 4).map((url, idx) => (
            <div key={idx} className="relative">
              <img 
                src={url} 
                alt="" 
                className="w-full h-48 object-cover rounded-lg cursor-pointer hover:opacity-90"
                onClick={onExpand}
              />
              {idx === 3 && post.media_urls.length > 4 && (
                <div className="absolute inset-0 bg-black/60 rounded-lg flex items-center justify-center text-white font-bold text-xl">
                  +{post.media_urls.length - 4}
                </div>
              )}
            </div>
          ))}
        </div>
      )}

      {/* Engagement Bar */}
      <div className={`px-4 py-3 border-t ${tc.border} flex items-center justify-between`}>
        <div className="flex items-center gap-4">
          <button 
            onClick={onReact}
            className={`flex items-center gap-1.5 px-3 py-1.5 rounded-lg transition ${
              userReacted ? 'bg-red-500/20 text-red-400' : `${tc.hoverBg} ${tc.textSecondary}`
            }`}
          >
            ‚ù§Ô∏è <span className="text-sm">{post.reaction_count || 0}</span>
          </button>
          <button 
            onClick={() => setShowCommentInput(!showCommentInput)}
            className={`flex items-center gap-1.5 px-3 py-1.5 rounded-lg transition ${tc.hoverBg} ${tc.textSecondary}`}
          >
            üí¨ <span className="text-sm">{post.comment_count || 0}</span>
          </button>
        </div>
        <button className={`${tc.textMuted} text-sm hover:${tc.text}`}>
          üì§ Share
        </button>
      </div>

      {/* Comment Input */}
      {showCommentInput && (
        <div className={`px-4 pb-4 border-t ${tc.border}`}>
          <div className="flex gap-2 mt-3">
            <input
              type="text"
              value={commentText}
              onChange={e => setCommentText(e.target.value)}
              placeholder="Write a comment..."
              className={`flex-1 px-4 py-2 rounded-xl ${tc.inputBg} border ${tc.border} ${tc.text} text-sm`}
              onKeyDown={e => e.key === 'Enter' && handleComment()}
            />
            <button
              onClick={handleComment}
              disabled={!commentText.trim()}
              className="px-4 py-2 rounded-xl font-medium text-sm disabled:opacity-50"
              style={{ background: teamColor, color: '#000' }}
            >
              Post
            </button>
          </div>
        </div>
      )}
    </div>
  )
}

// New Post Modal
function NewPostModal({ teamColor, onClose, onSubmit }) {
  const tc = useThemeClasses()
  const [form, setForm] = useState({
    post_type: 'announcement',
    title: '',
    content: '',
    media_urls: [],
    is_pinned: false
  })

  const postTypes = [
    { value: 'announcement', label: 'Announcement' },
    { value: 'photo', label: 'üì∏ Photos' },
    { value: 'milestone', label: 'üèÜ Milestone' },
    { value: 'game_recap', label: 'üìä Game Recap' },
    { value: 'shoutout', label: 'Shoutout' },
  ]

  return (
    <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50" onClick={onClose}>
      <div 
        className={`${tc.cardBg} border ${tc.border} rounded-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto`}
        onClick={e => e.stopPropagation()}
      >
        <div className={`p-5 border-b ${tc.border} flex items-center justify-between`}>
          <h2 className={`text-xl font-bold ${tc.text}`}>Create Post</h2>
          <button onClick={onClose} className={`${tc.textSecondary} hover:${tc.text} text-2xl`}>√ó</button>
        </div>

        <div className="p-5 space-y-4">
          {/* Post Type */}
          <div className="flex flex-wrap gap-2">
            {postTypes.map(type => (
              <button
                key={type.value}
                onClick={() => setForm({ ...form, post_type: type.value })}
                className={`px-3 py-1.5 rounded-lg text-sm font-medium transition ${
                  form.post_type === type.value 
                    ? 'text-black' 
                    : `${tc.cardBgAlt} ${tc.textSecondary}`
                }`}
                style={form.post_type === type.value ? { background: teamColor } : {}}
              >
                {type.label}
              </button>
            ))}
          </div>

          {/* Title */}
          <input
            type="text"
            value={form.title}
            onChange={e => setForm({ ...form, title: e.target.value })}
            placeholder="Post title (optional)"
            className={`w-full px-4 py-3 rounded-xl ${tc.cardBgAlt} border ${tc.border} ${tc.text}`}
          />

          {/* Content */}
          <textarea
            value={form.content}
            onChange={e => setForm({ ...form, content: e.target.value })}
            placeholder="What's happening with the team?"
            rows={4}
            className={`w-full px-4 py-3 rounded-xl ${tc.cardBgAlt} border ${tc.border} ${tc.text} resize-none`}
          />

          {/* Pin Option */}
          <label className="flex items-center gap-2 cursor-pointer">
            <input
              type="checkbox"
              checked={form.is_pinned}
              onChange={e => setForm({ ...form, is_pinned: e.target.checked })}
              className="w-4 h-4 rounded"
            />
            <span className={tc.textSecondary}>üìå Pin to top of feed</span>
          </label>
        </div>

        <div className={`p-5 border-t ${tc.border} flex justify-end gap-3`}>
          <button onClick={onClose} className={`px-6 py-2 rounded-xl ${tc.cardBgAlt} ${tc.text}`}>
            Cancel
          </button>
          <button
            onClick={() => onSubmit(form)}
            disabled={!form.content.trim()}
            className="px-6 py-2 rounded-xl font-semibold disabled:opacity-50"
            style={{ background: teamColor, color: '#000' }}
          >
            Post
          </button>
        </div>
      </div>
    </div>
  )
}

// Upload Document Modal
function UploadDocumentModal({ onClose, onSubmit }) {
  const tc = useThemeClasses()
  const [form, setForm] = useState({
    name: '',
    description: '',
    file_url: '',
    file_type: 'pdf',
    category: 'general'
  })

  const categories = ['general', 'schedule', 'rules', 'tournament', 'training']

  return (
    <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50" onClick={onClose}>
      <div 
        className={`${tc.cardBg} border ${tc.border} rounded-2xl w-full max-w-md`}
        onClick={e => e.stopPropagation()}
      >
        <div className={`p-5 border-b ${tc.border} flex items-center justify-between`}>
          <h2 className={`text-xl font-bold ${tc.text}`}>Upload Document</h2>
          <button onClick={onClose} className={`${tc.textSecondary} hover:${tc.text} text-2xl`}>√ó</button>
        </div>

        <div className="p-5 space-y-4">
          <input
            type="text"
            value={form.name}
            onChange={e => setForm({ ...form, name: e.target.value })}
            placeholder="Document name *"
            className={`w-full px-4 py-3 rounded-xl ${tc.cardBgAlt} border ${tc.border} ${tc.text}`}
          />

          <input
            type="text"
            value={form.description}
            onChange={e => setForm({ ...form, description: e.target.value })}
            placeholder="Description (optional)"
            className={`w-full px-4 py-3 rounded-xl ${tc.cardBgAlt} border ${tc.border} ${tc.text}`}
          />

          <input
            type="url"
            value={form.file_url}
            onChange={e => setForm({ ...form, file_url: e.target.value })}
            placeholder="File URL (Google Drive, Dropbox, etc.) *"
            className={`w-full px-4 py-3 rounded-xl ${tc.cardBgAlt} border ${tc.border} ${tc.text}`}
          />

          <select
            value={form.category}
            onChange={e => setForm({ ...form, category: e.target.value })}
            className={`w-full px-4 py-3 rounded-xl ${tc.cardBgAlt} border ${tc.border} ${tc.text}`}
          >
            {categories.map(cat => (
              <option key={cat} value={cat}>{cat.charAt(0).toUpperCase() + cat.slice(1)}</option>
            ))}
          </select>
        </div>

        <div className={`p-5 border-t ${tc.border} flex justify-end gap-3`}>
          <button onClick={onClose} className={`px-6 py-2 rounded-xl ${tc.cardBgAlt} ${tc.text}`}>
            Cancel
          </button>
          <button
            onClick={() => onSubmit(form)}
            disabled={!form.name.trim() || !form.file_url.trim()}
            className="px-6 py-2 rounded-xl font-semibold bg-[var(--accent-primary)] text-white disabled:opacity-50"
          >
            Upload
          </button>
        </div>
      </div>
    </div>
  )
}

// ============================================
// SEASONS PAGE
// ============================================
function SeasonsPage({ showToast }) {
  const journey = useJourney()
  const { organization } = useAuth()
  const { refreshSeasons } = useSeason()
  const { selectedSport, sports } = useSport()
  const [seasons, setSeasons] = useState([])
  const [loading, setLoading] = useState(true)
  const [showModal, setShowModal] = useState(false)
  const [editingSeason, setEditingSeason] = useState(null)
  const [modalTab, setModalTab] = useState('basic') // 'basic', 'registration', 'fees'
  const [showShareModal, setShowShareModal] = useState(false)
  const [shareSeason, setShareSeason] = useState(null)
  const [form, setForm] = useState({ 
    name: '', status: 'upcoming', start_date: '', end_date: '', 
    fee_registration: 150, fee_uniform: 35, fee_monthly: 50, fee_per_family: 0, months_in_season: 3, 
    sibling_discount_type: 'none', sibling_discount_amount: 0, sibling_discount_apply_to: 'additional',
    sport_id: null, registration_opens: '', registration_closes: '',
    early_bird_deadline: '', early_bird_discount: 25, late_registration_deadline: '',
    late_registration_fee: 25, capacity: null, waitlist_enabled: true, waitlist_capacity: 20,
    description: ''
  })

  useEffect(() => { if (organization?.id) loadSeasons() }, [organization?.id])

  async function loadSeasons() {
    setLoading(true)
    const { data } = await supabase.from('seasons').select('*, sports(id, name, icon)').eq('organization_id', organization.id).order('created_at', { ascending: false })
    setSeasons(data || [])
    setLoading(false)
  }

  function openNew() {
    setEditingSeason(null)
    // Don't pre-select sport - let user explicitly choose
    setForm({ 
      name: '', 
      status: 'upcoming', 
      start_date: '', 
      end_date: '', 
      fee_registration: 150, 
      fee_uniform: 35, 
      fee_monthly: 50, 
      fee_per_family: 0,
      months_in_season: 3, 
      sibling_discount_type: 'none',
      sibling_discount_amount: 0,
      sibling_discount_apply_to: 'additional',
      sport_id: null,
      // Registration Settings
      registration_opens: '',
      registration_closes: '',
      early_bird_deadline: '',
      early_bird_discount: 25,
      late_registration_deadline: '',
      late_registration_fee: 25,
      capacity: null,
      waitlist_enabled: true,
      waitlist_capacity: 20,
      description: '',
    })
    setShowModal(true)
  }

  function openEdit(season) {
    setEditingSeason(season)
    setForm({ 
      name: season.name, 
      status: season.status, 
      start_date: season.start_date || '', 
      end_date: season.end_date || '', 
      fee_registration: season.fee_registration || 150, 
      fee_uniform: season.fee_uniform || 35, 
      fee_monthly: season.fee_monthly || 50, 
      fee_per_family: season.fee_per_family || 0,
      months_in_season: season.months_in_season || 3, 
      sibling_discount_type: season.sibling_discount_type || 'none',
      sibling_discount_amount: season.sibling_discount_amount || 0,
      sibling_discount_apply_to: season.sibling_discount_apply_to || 'additional',
      sport_id: season.sport_id || null,
      // Registration Settings
      registration_opens: season.registration_opens || '',
      registration_closes: season.registration_closes || '',
      early_bird_deadline: season.early_bird_deadline || '',
      early_bird_discount: season.early_bird_discount || 25,
      late_registration_deadline: season.late_registration_deadline || '',
      late_registration_fee: season.late_registration_fee || 25,
      capacity: season.capacity || null,
      waitlist_enabled: season.waitlist_enabled ?? true,
      waitlist_capacity: season.waitlist_capacity || 20,
      description: season.description || '',
    })
    setShowModal(true)
  }

  async function handleSave() {
    const data = { organization_id: organization.id, ...form }
    if (editingSeason) {
      await supabase.from('seasons').update(data).eq('id', editingSeason.id)
      showToast('Season updated!', 'success')
      setShowModal(false)
      loadSeasons()
      refreshSeasons()
    } else {
      // Insert and get the new season ID
      const { data: newSeason, error } = await supabase
        .from('seasons')
        .insert(data)
        .select()
        .single()
      
      if (error) {
        showToast('Error creating season', 'error')
        return
      }
      
      showToast('Season created!', 'success')
      journey?.completeStep('create_season')
      setShowModal(false)
      loadSeasons()
      // Auto-select the newly created season
      refreshSeasons(newSeason.id)
    }
  }

  async function handleDelete(season) {
    if (!confirm(`Delete "${season.name}"?`)) return
    await supabase.from('seasons').delete().eq('id', season.id)
    showToast('Season deleted', 'success')
    loadSeasons()
    refreshSeasons()
  }

  async function handleClone(season) {
    const newName = prompt('Name for the new season:', `${season.name} (Copy)`)
    if (!newName) return

    const cloneData = {
      organization_id: organization.id,
      name: newName,
      status: 'upcoming',
      sport_id: season.sport_id,
      start_date: null, // Clear dates for new season
      end_date: null,
      fee_registration: season.fee_registration,
      fee_uniform: season.fee_uniform,
      fee_monthly: season.fee_monthly,
      months_in_season: season.months_in_season,
      registration_opens: null,
      registration_closes: null,
      early_bird_deadline: null,
      early_bird_discount: season.early_bird_discount,
      late_registration_deadline: null,
      late_registration_fee: season.late_registration_fee,
      capacity: season.capacity,
      waitlist_enabled: season.waitlist_enabled,
      waitlist_capacity: season.waitlist_capacity,
      description: season.description,
    }

    const { data: newSeason, error } = await supabase
      .from('seasons')
      .insert(cloneData)
      .select()
      .single()

    if (error) {
      showToast('Error cloning season', 'error')
      return
    }

    showToast(`"${newName}" created from "${season.name}"!`, 'success')
    loadSeasons()
    // Open edit modal for new season to set dates
    openEdit(newSeason)
  }

  const totalFee = (parseFloat(form.fee_registration) || 0) + (parseFloat(form.fee_uniform) || 0) + ((parseFloat(form.fee_monthly) || 0) * (parseInt(form.months_in_season) || 0))

  return (
    <div className="space-y-6">
      <div className="flex items-start justify-between">
        <div>
          <h1 className="text-3xl font-bold text-white">Seasons</h1>
          <p className="text-slate-400 mt-1">Manage league seasons</p>
        </div>
        <button onClick={openNew} className="bg-[var(--accent-primary)] text-white font-semibold px-6 py-3 rounded-xl">‚ûï New Season</button>
      </div>

      {loading ? <div className="text-center py-12 text-slate-400">Loading...</div> :
        seasons.length === 0 ? (
          <div className="bg-slate-800 border border-slate-700 rounded-2xl p-12 text-center">
            <Calendar className="w-16 h-16" />
            <h3 className="text-lg font-medium text-white mt-4">No seasons yet</h3>
            <button onClick={openNew} className="mt-4 bg-[var(--accent-primary)] text-white font-semibold px-6 py-2 rounded-xl">Create Season</button>
          </div>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {seasons.map(season => {
              const isRegOpen = season.status === 'active' || 
                (season.registration_opens && new Date(season.registration_opens) <= new Date() && 
                 (!season.registration_closes || new Date(season.registration_closes) >= new Date()))
              // Use configured registration URL or default to GitHub Pages
              const registrationBaseUrl = organization.settings?.registration_url || `https://sgtxtorque.github.io/volleyball-registration`
              const regLink = `${registrationBaseUrl}/?org=${organization.slug}&season=${season.id}`
              
              return (
                <div key={season.id} className="bg-slate-800 border border-slate-700 rounded-2xl p-6">
                  <div className="flex items-start justify-between mb-4">
                    <div>
                      <div className="flex items-center gap-2">
                        {season.sports?.icon && <span className="text-xl">{season.sports.icon}</span>}
                        <h3 className="text-lg font-semibold text-white">{season.name}</h3>
                      </div>
                      <div className="flex flex-wrap items-center gap-2 mt-1">
                        <span className={`text-xs px-2 py-1 rounded-full ${season.status === 'active' ? 'bg-emerald-500/20 text-emerald-400' : season.status === 'upcoming' ? 'bg-[var(--accent-primary)]/20 text-[var(--accent-primary)]' : 'bg-gray-500/20 text-slate-400'}`}>
                          {season.status}
                        </span>
                        {isRegOpen && (
                          <span className="text-xs px-2 py-1 rounded-full bg-blue-500/20 text-blue-400">
                            üìã Registration Open
                          </span>
                        )}
                      </div>
                    </div>
                    <div className="flex gap-1">
                      <button onClick={() => handleClone(season)} className="p-2 rounded-lg hover:bg-slate-700 text-slate-400" title="Clone Season"><Copy className="w-4 h-4" /></button>
                      <button onClick={() => openEdit(season)} className="p-2 rounded-lg hover:bg-slate-700 text-slate-400" title="Edit"><Edit className="w-4 h-4" /></button>
                      <button onClick={() => handleDelete(season)} className="p-2 rounded-lg hover:bg-red-500/10 text-slate-400 hover:text-red-400" title="Delete"><Trash2 className="w-4 h-4" /></button>
                    </div>
                  </div>
                  <div className="space-y-2 text-sm">
                    {season.start_date && (
                      <p className="text-slate-400 flex items-center gap-1"><Calendar className="w-4 h-4" /> {new Date(season.start_date).toLocaleDateString()} - {season.end_date ? new Date(season.end_date).toLocaleDateString() : 'TBD'}</p>
                    )}
                    <p className="text-slate-400 flex items-center gap-1"><DollarSign className="w-4 h-4" /> ${season.fee_registration || 0} registration</p>
                    {season.capacity && (
                      <p className="text-slate-400">Capacity: {season.capacity} players</p>
                    )}
                  </div>
                  {/* Quick Actions */}
                  <div className="mt-4 pt-4 border-t border-slate-700 flex gap-2">
                    <button 
                      onClick={() => {
                        setShareSeason(season)
                        setShowShareModal(true)
                      }}
                      className="flex-1 px-3 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-white text-xs font-medium"
                    >
                      Share
                    </button>
                    <button 
                      onClick={() => window.open(regLink, '_blank')}
                      className="flex-1 px-3 py-2 rounded-lg bg-[var(--accent-primary)] hover:brightness-110 text-white text-xs font-medium"
                    >
                      üëÅÔ∏è Preview
                    </button>
                  </div>
                </div>
              )
            })}
          </div>
        )}

      {showModal && (
        <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50">
          <div className="bg-slate-800 border border-slate-700 rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
            <div className="p-6 border-b border-slate-700 flex items-center justify-between">
              <h2 className="text-xl font-semibold text-white">{editingSeason ? 'Edit Season' : 'Create Season'}</h2>
              <button onClick={() => { setShowModal(false); setModalTab('basic'); }} className="text-slate-400 hover:text-white text-2xl">√ó</button>
            </div>
            
            {/* Tabs */}
            <div className="flex border-b border-slate-700">
              {[
                { id: 'basic', label: 'üìã Basic Info' },
                { id: 'registration', label: 'üìÖ Registration' },
                { id: 'fees', label: 'üí∞ Fees & Pricing' },
              ].map(tab => (
                <button
                  key={tab.id}
                  onClick={() => setModalTab(tab.id)}
                  className={`flex-1 px-4 py-3 text-sm font-medium transition ${
                    modalTab === tab.id
                      ? 'text-[var(--accent-primary)] border-b-2 border-[var(--accent-primary)] bg-slate-900/50'
                      : 'text-slate-400 hover:text-white'
                  }`}
                >
                  {tab.label}
                </button>
              ))}
            </div>

            <div className="p-6 overflow-y-auto flex-1 space-y-4">
              {/* Basic Info Tab */}
              {modalTab === 'basic' && (
                <>
                  {/* Sport Selection */}
                  {sports && sports.length > 0 && (
                    <div>
                      <label className="block text-sm text-slate-400 mb-2">Sport <span className="text-red-400">*</span></label>
                      <div className="grid grid-cols-2 sm:grid-cols-3 gap-2 mb-2">
                        {sports.map(sport => (
                          <button
                            key={sport.id}
                            type="button"
                            onClick={() => setForm({...form, sport_id: sport.id})}
                            className={`p-3 rounded-xl border-2 text-left transition-all ${
                              form.sport_id === sport.id
                                ? 'border-[var(--accent-primary)] bg-[var(--accent-primary)]/10'
                                : 'border-slate-700 hover:border-slate-600'
                            }`}
                          >
                            <span className="text-xl">{sport.icon}</span>
                            <p className={`text-sm font-medium mt-1 ${form.sport_id === sport.id ? 'text-white' : 'text-slate-400'}`}>
                              {sport.name}
                            </p>
                          </button>
                        ))}
                      </div>
                    </div>
                  )}
                  
                  <div>
                    <label className="block text-sm text-slate-400 mb-2">Season Name <span className="text-red-400">*</span></label>
                    <input type="text" value={form.name} onChange={e => setForm({...form, name: e.target.value})} placeholder="Spring 2026"
                      className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white" />
                  </div>
                  
                  <div>
                    <label className="block text-sm text-slate-400 mb-2">Description</label>
                    <textarea 
                      value={form.description} 
                      onChange={e => setForm({...form, description: e.target.value})} 
                      placeholder="Brief description shown on registration page..."
                      rows={2}
                      className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white resize-none" 
                    />
                  </div>
                  
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm text-slate-400 mb-2">Season Starts</label>
                      <input type="date" value={form.start_date} onChange={e => setForm({...form, start_date: e.target.value})}
                        className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white" />
                    </div>
                    <div>
                      <label className="block text-sm text-slate-400 mb-2">Season Ends</label>
                      <input type="date" value={form.end_date} onChange={e => setForm({...form, end_date: e.target.value})}
                        className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white" />
                    </div>
                  </div>
                  
                  <div>
                    <label className="block text-sm text-slate-400 mb-2">Status</label>
                    <select value={form.status} onChange={e => setForm({...form, status: e.target.value})}
                      className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white">
                      <option value="upcoming">Upcoming</option>
                      <option value="active">Active (Registration Open)</option>
                      <option value="completed">Completed</option>
                    </select>
                  </div>
                </>
              )}

              {/* Registration Tab */}
              {modalTab === 'registration' && (
                <>
                  <div className="bg-slate-900/50 rounded-xl p-4 mb-4">
                    <p className="text-sm text-slate-300">
                      üìÖ Set when families can register. Leave dates blank to use season status instead.
                    </p>
                  </div>
                  
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm text-slate-400 mb-2">Registration Opens</label>
                      <input 
                        type="date" 
                        value={form.registration_opens} 
                        onChange={e => setForm({...form, registration_opens: e.target.value})}
                        className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white" 
                      />
                    </div>
                    <div>
                      <label className="block text-sm text-slate-400 mb-2">Registration Closes</label>
                      <input 
                        type="date" 
                        value={form.registration_closes} 
                        onChange={e => setForm({...form, registration_closes: e.target.value})}
                        className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white" 
                      />
                    </div>
                  </div>
                  
                  <div className="border-t border-slate-700 pt-4 mt-4">
                    <h4 className="text-white font-medium mb-3">üéØ Early Bird & Late Registration</h4>
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm text-slate-400 mb-2">Early Bird Deadline</label>
                        <input 
                          type="date" 
                          value={form.early_bird_deadline} 
                          onChange={e => setForm({...form, early_bird_deadline: e.target.value})}
                          className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white" 
                        />
                      </div>
                      <div>
                        <label className="block text-sm text-slate-400 mb-2">Early Bird Discount ($)</label>
                        <input 
                          type="number" 
                          value={form.early_bird_discount} 
                          onChange={e => setForm({...form, early_bird_discount: parseInt(e.target.value) || 0})}
                          className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white" 
                        />
                      </div>
                    </div>
                    <div className="grid grid-cols-2 gap-4 mt-3">
                      <div>
                        <label className="block text-sm text-slate-400 mb-2">Late Registration Starts</label>
                        <input 
                          type="date" 
                          value={form.late_registration_deadline} 
                          onChange={e => setForm({...form, late_registration_deadline: e.target.value})}
                          className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white" 
                        />
                      </div>
                      <div>
                        <label className="block text-sm text-slate-400 mb-2">Late Fee ($)</label>
                        <input 
                          type="number" 
                          value={form.late_registration_fee} 
                          onChange={e => setForm({...form, late_registration_fee: parseInt(e.target.value) || 0})}
                          className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white" 
                        />
                      </div>
                    </div>
                  </div>
                  
                  <div className="border-t border-slate-700 pt-4 mt-4">
                    <h4 className="text-white font-medium mb-3">Capacity</h4>
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm text-slate-400 mb-2">Max Players</label>
                        <input 
                          type="number" 
                          value={form.capacity || ''} 
                          onChange={e => setForm({...form, capacity: e.target.value ? parseInt(e.target.value) : null})}
                          placeholder="Unlimited"
                          className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white" 
                        />
                        <p className="text-xs text-slate-500 mt-1">Leave blank for unlimited</p>
                      </div>
                      <div>
                        <label className="block text-sm text-slate-400 mb-2">Waitlist Size</label>
                        <input 
                          type="number" 
                          value={form.waitlist_capacity} 
                          onChange={e => setForm({...form, waitlist_capacity: parseInt(e.target.value) || 0})}
                          className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white" 
                        />
                      </div>
                    </div>
                    <label className="flex items-center gap-3 mt-3 cursor-pointer">
                      <input 
                        type="checkbox" 
                        checked={form.waitlist_enabled} 
                        onChange={e => setForm({...form, waitlist_enabled: e.target.checked})}
                        className="w-5 h-5 rounded border-slate-700"
                      />
                      <span className="text-slate-300">Enable waitlist when full</span>
                    </label>
                  </div>
                </>
              )}

              {/* Fees Tab */}
              {modalTab === 'fees' && (
                <>
                  <div className="bg-slate-900/50 rounded-xl p-4 mb-4">
                    <p className="text-sm text-slate-300">
                      üí∞ Set the fees for this season. Per-player fees are charged for each child. Per-family fees are charged once per family per season.
                    </p>
                  </div>
                  
                  {/* Per-Player Fees */}
                  <h4 className="text-sm font-semibold text-slate-400 uppercase tracking-wide mb-3">Per-Player Fees</h4>
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm text-slate-400 mb-2">Registration Fee ($)</label>
                      <input 
                        type="number" 
                        value={form.fee_registration} 
                        onChange={e => setForm({...form, fee_registration: e.target.value})}
                        className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white text-lg" 
                      />
                    </div>
                    <div>
                      <label className="block text-sm text-slate-400 mb-2">Uniform Fee ($)</label>
                      <input 
                        type="number" 
                        value={form.fee_uniform} 
                        onChange={e => setForm({...form, fee_uniform: e.target.value})}
                        className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white text-lg" 
                      />
                    </div>
                  </div>
                  
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm text-slate-400 mb-2">Monthly Fee ($)</label>
                      <input 
                        type="number" 
                        value={form.fee_monthly} 
                        onChange={e => setForm({...form, fee_monthly: e.target.value})}
                        className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white text-lg" 
                      />
                    </div>
                    <div>
                      <label className="block text-sm text-slate-400 mb-2">Number of Months</label>
                      <input 
                        type="number" 
                        value={form.months_in_season} 
                        onChange={e => setForm({...form, months_in_season: e.target.value})}
                        className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white text-lg" 
                      />
                    </div>
                  </div>
                  
                  {/* Per-Family Fee */}
                  <h4 className="text-sm font-semibold text-slate-400 uppercase tracking-wide mb-3 mt-6">Per-Family Fee</h4>
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm text-slate-400 mb-2">Family Registration Fee ($)</label>
                      <input 
                        type="number" 
                        value={form.fee_per_family} 
                        onChange={e => setForm({...form, fee_per_family: e.target.value})}
                        placeholder="0"
                        className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white text-lg" 
                      />
                      <p className="text-xs text-slate-500 mt-1">Charged once per family, regardless of # of kids</p>
                    </div>
                  </div>
                  
                  {/* Sibling Discount */}
                  <h4 className="text-sm font-semibold text-slate-400 uppercase tracking-wide mb-3 mt-6">Sibling Discount</h4>
                  <div className="bg-slate-900/50 rounded-xl p-4 mb-4">
                    <p className="text-sm text-slate-300">
                      Family: Automatically discount fees when multiple kids from the same family register.
                    </p>
                  </div>
                  <div className="grid grid-cols-3 gap-4">
                    <div>
                      <label className="block text-sm text-slate-400 mb-2">Discount Type</label>
                      <select 
                        value={form.sibling_discount_type} 
                        onChange={e => setForm({...form, sibling_discount_type: e.target.value})}
                        className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white"
                      >
                        <option value="none">No Discount</option>
                        <option value="flat">Flat Amount ($)</option>
                        <option value="percent">Percentage (%)</option>
                      </select>
                    </div>
                    {form.sibling_discount_type !== 'none' && (
                      <>
                        <div>
                          <label className="block text-sm text-slate-400 mb-2">
                            {form.sibling_discount_type === 'flat' ? 'Discount Amount ($)' : 'Discount Percent (%)'}
                          </label>
                          <input 
                            type="number" 
                            value={form.sibling_discount_amount} 
                            onChange={e => setForm({...form, sibling_discount_amount: e.target.value})}
                            placeholder={form.sibling_discount_type === 'flat' ? '25' : '10'}
                            className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white" 
                          />
                        </div>
                        <div>
                          <label className="block text-sm text-slate-400 mb-2">Apply To</label>
                          <select 
                            value={form.sibling_discount_apply_to} 
                            onChange={e => setForm({...form, sibling_discount_apply_to: e.target.value})}
                            className="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white"
                          >
                            <option value="additional">2nd Child & Beyond</option>
                            <option value="all">All Children</option>
                          </select>
                        </div>
                      </>
                    )}
                  </div>
                  {form.sibling_discount_type !== 'none' && parseFloat(form.sibling_discount_amount) > 0 && (
                    <p className="text-xs text-emerald-400 mt-2">
                      ‚úì {form.sibling_discount_apply_to === 'additional' ? '2nd child and beyond' : 'All children'} will receive{' '}
                      {form.sibling_discount_type === 'flat' 
                        ? `$${form.sibling_discount_amount} off` 
                        : `${form.sibling_discount_amount}% off`
                      } registration and monthly fees
                    </p>
                  )}
                  
                  {/* Fee Summary */}
                  <div className="bg-slate-900 rounded-xl p-5 mt-6">
                    <h4 className="text-slate-400 text-sm mb-3">Fee Summary (Per Player)</h4>
                    <div className="space-y-2 text-sm">
                      <div className="flex justify-between">
                        <span className="text-slate-400">Registration</span>
                        <span className="text-white">${parseFloat(form.fee_registration) || 0}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-slate-400">Uniform</span>
                        <span className="text-white">${parseFloat(form.fee_uniform) || 0}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-slate-400">Monthly √ó {form.months_in_season || 0}</span>
                        <span className="text-white">${(parseFloat(form.fee_monthly) || 0) * (parseInt(form.months_in_season) || 0)}</span>
                      </div>
                      {parseFloat(form.fee_per_family) > 0 && (
                        <div className="flex justify-between text-blue-400">
                          <span>+ Family Fee (once per family)</span>
                          <span>${parseFloat(form.fee_per_family) || 0}</span>
                        </div>
                      )}
                      {form.early_bird_discount > 0 && (
                        <div className="flex justify-between text-emerald-400">
                          <span>Early Bird Discount</span>
                          <span>-${form.early_bird_discount}</span>
                        </div>
                      )}
                      <div className="border-t border-slate-700 pt-2 mt-2 flex justify-between">
                        <span className="text-white font-medium">Total Per Player (Regular)</span>
                        <span className="text-2xl font-bold text-[var(--accent-primary)]">${totalFee.toFixed(0)}</span>
                      </div>
                      {form.early_bird_discount > 0 && (
                        <div className="flex justify-between">
                          <span className="text-emerald-400 font-medium">Total Per Player (Early Bird)</span>
                          <span className="text-xl font-bold text-emerald-400">${(totalFee - (form.early_bird_discount || 0)).toFixed(0)}</span>
                        </div>
                      )}
                    </div>
                    {/* Example calculation with sibling discount */}
                    <div className="mt-4 pt-4 border-t border-slate-700/50 space-y-2">
                      <p className="text-xs text-slate-500">
                        üí° <strong>Example - 1 Child:</strong>{' '}
                        <span className="text-white">
                          ${((totalFee - (form.early_bird_discount > 0 ? form.early_bird_discount : 0)) + (parseFloat(form.fee_per_family) || 0)).toFixed(0)}
                        </span>
                      </p>
                      <p className="text-xs text-slate-500">
                        üí° <strong>Example - 2 Children:</strong>{' '}
                        {(() => {
                          const basePerPlayer = totalFee - (form.early_bird_discount > 0 ? form.early_bird_discount : 0)
                          const familyFee = parseFloat(form.fee_per_family) || 0
                          let child1 = basePerPlayer
                          let child2 = basePerPlayer
                          
                          if (form.sibling_discount_type !== 'none' && parseFloat(form.sibling_discount_amount) > 0) {
                            const discountAmount = parseFloat(form.sibling_discount_amount)
                            if (form.sibling_discount_apply_to === 'all') {
                              // Both get discount
                              if (form.sibling_discount_type === 'flat') {
                                child1 = Math.max(0, child1 - discountAmount)
                                child2 = Math.max(0, child2 - discountAmount)
                              } else {
                                child1 = child1 * (1 - discountAmount / 100)
                                child2 = child2 * (1 - discountAmount / 100)
                              }
                            } else {
                              // Only 2nd gets discount
                              if (form.sibling_discount_type === 'flat') {
                                child2 = Math.max(0, child2 - discountAmount)
                              } else {
                                child2 = child2 * (1 - discountAmount / 100)
                              }
                            }
                          }
                          const total = child1 + child2 + familyFee
                          const savings = (basePerPlayer * 2 + familyFee) - total
                          return (
                            <>
                              <span className="text-white">${total.toFixed(0)}</span>
                              {savings > 0 && (
                                <span className="text-emerald-400 ml-2">(saves ${savings.toFixed(0)})</span>
                              )}
                            </>
                          )
                        })()}
                      </p>
                    </div>
                  </div>
                </>
              )}
            </div>
            
            <div className="p-6 border-t border-slate-700 flex justify-between">
              <button onClick={() => { setShowModal(false); setModalTab('basic'); }} className="px-6 py-2 rounded-xl border border-slate-700 text-white">
                Cancel
              </button>
              <div className="flex gap-3">
                {modalTab !== 'basic' && (
                  <button 
                    onClick={() => setModalTab(modalTab === 'fees' ? 'registration' : 'basic')}
                    className="px-6 py-2 rounded-xl border border-slate-700 text-white"
                  >
                    ‚Üê Back
                  </button>
                )}
                {modalTab !== 'fees' ? (
                  <button 
                    onClick={() => setModalTab(modalTab === 'basic' ? 'registration' : 'fees')}
                    className="px-6 py-2 rounded-xl bg-[var(--accent-primary)] text-white font-semibold"
                  >
                    Next ‚Üí
                  </button>
                ) : (
                  <button 
                    onClick={handleSave} 
                    disabled={!form.name || (sports && sports.length > 0 && !form.sport_id)} 
                    className="px-6 py-2 rounded-xl bg-[var(--accent-primary)] text-white font-semibold disabled:opacity-50"
                  >
                    {editingSeason ? 'üíæ Save Changes' : '‚ú® Create Season'}
                  </button>
                )}
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Share Hub Modal */}
      {showShareModal && shareSeason && (
        <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50">
          <div className="bg-slate-800 border border-slate-700 rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
            <div className="p-6 border-b border-slate-700 flex items-center justify-between">
              <div>
                <h2 className="text-xl font-semibold text-white">Share Registration</h2>
                <p className="text-sm text-slate-400 mt-1">{shareSeason.name}</p>
              </div>
              <button onClick={() => setShowShareModal(false)} className="text-slate-400 hover:text-white text-2xl">√ó</button>
            </div>
            
            <div className="p-6 overflow-y-auto flex-1 space-y-6">
              {/* Registration Link */}
              {(() => {
                const registrationBaseUrl = organization.settings?.registration_url || `https://sgtxtorque.github.io/volleyball-registration`
                const shareLink = `${registrationBaseUrl}/?org=${organization.slug}&season=${shareSeason.id}`
                const totalFee = (parseFloat(shareSeason.fee_registration) || 0) + (parseFloat(shareSeason.fee_uniform) || 0) + ((parseFloat(shareSeason.fee_monthly) || 0) * (parseInt(shareSeason.months_in_season) || 0))
                
                return (
                  <>
                    {/* Direct Link */}
                    <div>
                      <label className="block text-sm font-medium text-white mb-2">üìã Registration Link</label>
                      <div className="flex gap-2">
                        <input 
                          type="text" 
                          value={shareLink} 
                          readOnly 
                          className="flex-1 bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white text-sm"
                        />
                        <button 
                          onClick={() => {
                            navigator.clipboard.writeText(shareLink)
                            showToast('Link copied!', 'success')
                          }}
                          className="px-4 py-2 rounded-xl bg-[var(--accent-primary)] text-white font-medium hover:brightness-110"
                        >
                          Copy
                        </button>
                      </div>
                    </div>

                    {/* QR Code */}
                    <div>
                      <label className="block text-sm font-medium text-white mb-2">üì± QR Code</label>
                      <div className="flex gap-4 items-start">
                        <div className="bg-white p-4 rounded-xl">
                          <img 
                            src={`https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(shareLink)}`}
                            alt="QR Code"
                            className="w-36 h-36"
                          />
                        </div>
                        <div className="flex-1 space-y-2">
                          <p className="text-sm text-slate-400">Scan to register! Perfect for flyers, posters, and social media.</p>
                          <button 
                            onClick={() => {
                              const link = document.createElement('a')
                              link.href = `https://api.qrserver.com/v1/create-qr-code/?size=400x400&data=${encodeURIComponent(shareLink)}`
                              link.download = `${organization.name}-${shareSeason.name}-QR.png`
                              link.click()
                            }}
                            className="px-4 py-2 rounded-lg bg-slate-700 text-white text-sm hover:bg-slate-600"
                          >
                            ‚¨áÔ∏è Download QR Code
                          </button>
                        </div>
                      </div>
                    </div>

                    {/* Quick Share Buttons */}
                    <div>
                      <label className="block text-sm font-medium text-white mb-2">üöÄ Quick Share</label>
                      <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                        <button 
                          onClick={() => {
                            const text = `Register for ${organization.name} ${shareSeason.name}! ${shareLink}`
                            navigator.clipboard.writeText(text)
                            showToast('Text copied!', 'success')
                          }}
                          className="px-4 py-3 rounded-xl bg-slate-700 hover:bg-slate-600 text-white text-sm font-medium flex items-center justify-center gap-2"
                        >
                          üí¨ Text
                        </button>
                        <button 
                          onClick={() => {
                            const text = encodeURIComponent(`Register for ${organization.name} ${shareSeason.name}!`)
                            window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareLink)}&quote=${text}`, '_blank', 'width=600,height=400')
                          }}
                          className="px-4 py-3 rounded-xl bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium flex items-center justify-center gap-2"
                        >
                          üìò Facebook
                        </button>
                        <button 
                          onClick={() => {
                            const subject = encodeURIComponent(`Registration Open: ${organization.name} ${shareSeason.name}`)
                            const body = encodeURIComponent(`Hi!\n\nRegistration is now open for ${shareSeason.name}.\n\nRegister here: ${shareLink}\n\nFee: $${totalFee}\n\nSee you on the court!`)
                            window.location.href = `mailto:?subject=${subject}&body=${body}`
                          }}
                          className="px-4 py-3 rounded-xl bg-slate-700 hover:bg-slate-600 text-white text-sm font-medium flex items-center justify-center gap-2"
                        >
                          ‚úâÔ∏è Email
                        </button>
                        <button 
                          onClick={() => window.open(shareLink, '_blank')}
                          className="px-4 py-3 rounded-xl bg-slate-700 hover:bg-slate-600 text-white text-sm font-medium flex items-center justify-center gap-2"
                        >
                          üëÅÔ∏è Preview
                        </button>
                      </div>
                    </div>

                    {/* Email Template */}
                    <div>
                      <label className="block text-sm font-medium text-white mb-2">Email Template</label>
                      <div className="bg-slate-900 rounded-xl p-4 border border-slate-700">
                        <div className="text-sm text-slate-300 whitespace-pre-wrap font-mono">
{`Subject: Registration Open - ${shareSeason.name}

Hi [Parent Name]!

Registration is now open for ${organization.name} ${shareSeason.name}!

üìÖ Season: ${shareSeason.start_date ? new Date(shareSeason.start_date).toLocaleDateString() : 'TBD'} - ${shareSeason.end_date ? new Date(shareSeason.end_date).toLocaleDateString() : 'TBD'}
üí∞ Fee: $${totalFee}
${shareSeason.early_bird_deadline ? `üéâ Early Bird Deadline: ${new Date(shareSeason.early_bird_deadline).toLocaleDateString()} (Save $${shareSeason.early_bird_discount || 0}!)` : ''}

Register now: ${shareLink}

Questions? Reply to this email.

See you on the court!
${organization.name}`}
                        </div>
                        <button 
                          onClick={() => {
                            const template = `Subject: Registration Open - ${shareSeason.name}\n\nHi [Parent Name]!\n\nRegistration is now open for ${organization.name} ${shareSeason.name}!\n\nüìÖ Season: ${shareSeason.start_date ? new Date(shareSeason.start_date).toLocaleDateString() : 'TBD'} - ${shareSeason.end_date ? new Date(shareSeason.end_date).toLocaleDateString() : 'TBD'}\nüí∞ Fee: $${totalFee}\n${shareSeason.early_bird_deadline ? `üéâ Early Bird Deadline: ${new Date(shareSeason.early_bird_deadline).toLocaleDateString()} (Save $${shareSeason.early_bird_discount || 0}!)` : ''}\n\nRegister now: ${shareLink}\n\nQuestions? Reply to this email.\n\nSee you on the court!\n${organization.name}`
                            navigator.clipboard.writeText(template)
                            showToast('Email template copied!', 'success')
                          }}
                          className="mt-3 px-4 py-2 rounded-lg bg-slate-700 text-white text-sm hover:bg-slate-600"
                        >
                          üìã Copy Email Template
                        </button>
                      </div>
                    </div>

                    {/* Social Media Post */}
                    <div>
                      <label className="block text-sm font-medium text-white mb-2">üì± Social Media Post</label>
                      <div className="bg-slate-900 rounded-xl p-4 border border-slate-700">
                        <div className="text-sm text-slate-300">
{`üèê Registration is OPEN!

${shareSeason.name} is here! Join ${organization.name} for an amazing season.

‚úÖ All skill levels welcome
‚úÖ Expert coaching
‚úÖ Fun team environment

Register now üëá
${shareLink}

${shareSeason.early_bird_deadline ? `‚è∞ Early bird pricing ends ${new Date(shareSeason.early_bird_deadline).toLocaleDateString()}!` : ''}

#youth${shareSeason.sports?.name || 'sports'} #${organization.name.replace(/\s+/g, '')} #registration`}
                        </div>
                        <button 
                          onClick={() => {
                            const post = `üèê Registration is OPEN! üèê\n\n${shareSeason.name} is here! Join ${organization.name} for an amazing season.\n\n‚úÖ All skill levels welcome\n‚úÖ Expert coaching\n‚úÖ Fun team environment\n\nRegister now üëá\n${shareLink}\n\n${shareSeason.early_bird_deadline ? `‚è∞ Early bird pricing ends ${new Date(shareSeason.early_bird_deadline).toLocaleDateString()}!` : ''}\n\n#youth${shareSeason.sports?.name || 'sports'} #${organization.name.replace(/\s+/g, '')} #registration`
                            navigator.clipboard.writeText(post)
                            showToast('Social post copied!', 'success')
                          }}
                          className="mt-3 px-4 py-2 rounded-lg bg-slate-700 text-white text-sm hover:bg-slate-600"
                        >
                          üìã Copy Social Post
                        </button>
                      </div>
                    </div>

                    {/* Flyer Info */}
                    <div className="bg-gradient-to-r from-[var(--accent-primary)]/10 to-transparent rounded-xl p-4 border border-[var(--accent-primary)]/30">
                      <div className="flex items-start gap-3">
                        <span className="text-2xl">üí°</span>
                        <div>
                          <p className="font-medium text-white">Pro Tip: Print a Flyer!</p>
                          <p className="text-sm text-slate-400 mt-1">Download the QR code and add it to a flyer. Parents can scan with their phone to register instantly!</p>
                        </div>
                      </div>
                    </div>
                  </>
                )
              })()}
            </div>
            
            <div className="p-6 border-t border-slate-700 flex justify-end">
              <button 
                onClick={() => setShowShareModal(false)} 
                className="px-6 py-2 rounded-xl bg-[var(--accent-primary)] text-white font-semibold"
              >
                Done
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  )
}

// ============================================
// WAIVERS PAGE
// ============================================
function WaiversPage({ showToast }) {
  const { organization, setOrganization } = useAuth()
  const [waivers, setWaivers] = useState({ liability: '', photo: '', conduct: '' })
  const [selectedWaiver, setSelectedWaiver] = useState('liability')
  const [saving, setSaving] = useState(false)

  useEffect(() => {
    if (organization?.settings?.waivers) setWaivers(organization.settings.waivers)
  }, [organization])

  async function handleSave() {
    setSaving(true)
    const newSettings = { ...organization.settings, waivers }
    await supabase.from('organizations').update({ settings: newSettings }).eq('id', organization.id)
    setOrganization({ ...organization, settings: newSettings })
    showToast('Waivers saved!', 'success')
    setSaving(false)
  }

  const waiverTypes = [
    { id: 'liability', label: 'Liability Waiver', icon: '‚ö†Ô∏è' },
    { id: 'photo', label: 'Photo/Video Release', icon: 'üì∑' },
    { id: 'conduct', label: 'Code of Conduct', icon: 'clipboard' },
  ]

  return (
    <div className="space-y-6">
      <div className="flex items-start justify-between">
        <div>
          <h1 className="text-3xl font-bold text-white">Waiver Management</h1>
          <p className="text-slate-400 mt-1">Edit waivers shown during registration</p>
        </div>
        <button onClick={handleSave} disabled={saving} className="bg-[var(--accent-primary)] text-white font-semibold px-6 py-3 rounded-xl disabled:opacity-50">
          {saving ? 'Saving...' : 'üíæ Save'}
        </button>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
        <div className="space-y-2">
          {waiverTypes.map(w => (
            <button key={w.id} onClick={() => setSelectedWaiver(w.id)}
              className={`w-full text-left p-4 rounded-xl border transition ${selectedWaiver === w.id ? 'bg-[var(--accent-primary)]/10 border-[var(--accent-primary)]/50' : 'bg-slate-800 border-slate-700'}`}>
              <span className="text-xl mr-2">{w.icon}</span>
              <span className={selectedWaiver === w.id ? 'text-white' : 'text-slate-400'}>{w.label}</span>
            </button>
          ))}
        </div>
        <div className="lg:col-span-3 bg-slate-800 border border-slate-700 rounded-2xl p-6">
          <h3 className="text-lg font-semibold text-white mb-4">{waiverTypes.find(w => w.id === selectedWaiver)?.label}</h3>
          <textarea value={waivers[selectedWaiver] || ''} onChange={e => setWaivers({...waivers, [selectedWaiver]: e.target.value})}
            className="w-full min-h-[300px] bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white resize-y"
            placeholder="Enter waiver text..." />
        </div>
      </div>
    </div>
  )
}

// ============================================
// CHATS PAGE - Team chats, DMs, messaging
// ============================================
function ChatsPage({ showToast, activeView, roleContext }) {
  const { organization, profile, user } = useAuth()
  const { selectedSeason } = useSeason()
  const tc = useThemeClasses()
  const { isDark } = useTheme()
  
  const [loading, setLoading] = useState(true)
  const [channels, setChannels] = useState([])
  const [teams, setTeams] = useState([])
  const [selectedChannel, setSelectedChannel] = useState(null)
  const [showNewChatModal, setShowNewChatModal] = useState(false)
  const [searchQuery, setSearchQuery] = useState('')
  const [filterType, setFilterType] = useState('all') // all, team, dm
  
  useEffect(() => {
    if (selectedSeason?.id) loadChats()
  }, [selectedSeason?.id])
  
  async function loadChats() {
    setLoading(true)
    try {
      // Load teams for this season
      const { data: teamsData } = await supabase
        .from('teams')
        .select('*')
        .eq('season_id', selectedSeason.id)
        .order('name')
      setTeams(teamsData || [])
      
      // Load chat channels
      const { data: channelsData } = await supabase
        .from('chat_channels')
        .select(`
          *,
          teams (id, name, color),
          channel_members (id, user_id, display_name, member_role, last_read_at),
          chat_messages (id, content, message_type, created_at, sender_id, profiles:sender_id (full_name))
        `)
        .eq('season_id', selectedSeason.id)
        .eq('is_archived', false)
        .order('updated_at', { ascending: false })
      
      // Process channels with last message and unread count
      const processedChannels = (channelsData || []).map(ch => {
        const lastMessage = ch.chat_messages?.sort((a, b) => 
          new Date(b.created_at) - new Date(a.created_at)
        )[0]
        
        const myMembership = ch.channel_members?.find(m => m.user_id === user?.id)
        const unreadCount = myMembership?.last_read_at 
          ? ch.chat_messages?.filter(m => new Date(m.created_at) > new Date(myMembership.last_read_at)).length || 0
          : ch.chat_messages?.length || 0
        
        return {
          ...ch,
          last_message: lastMessage,
          unread_count: unreadCount,
          my_membership: myMembership
        }
      })
      
      setChannels(processedChannels)
    } catch (err) {
      console.error('Error loading chats:', err)
      showToast?.('Error loading chats', 'error')
    }
    setLoading(false)
  }
  
  async function createTeamChat(teamId) {
    const team = teams.find(t => t.id === teamId)
    if (!team) return
    
    // Check if chat already exists
    const existing = channels.find(c => c.team_id === teamId && c.channel_type === 'team_chat')
    if (existing) {
      setSelectedChannel(existing)
      return
    }
    
    // Create new team chat
    const { data: newChannel, error } = await supabase
      .from('chat_channels')
      .insert({
        season_id: selectedSeason.id,
        team_id: teamId,
        name: `${team.name} Chat`,
        channel_type: 'team_chat',
        created_by: user?.id
      })
      .select()
      .single()
    
    if (error) {
      showToast?.('Error creating chat', 'error')
      return
    }
    
    // Add creator as member
    await supabase.from('channel_members').insert({
      channel_id: newChannel.id,
      user_id: user?.id,
      display_name: profile?.full_name || 'Admin',
      member_role: 'admin',
      can_post: true,
      can_moderate: true
    })
    
    showToast?.('Team chat created!', 'success')
    loadChats()
    setSelectedChannel(newChannel)
  }
  
  // Filter channels
  const filteredChannels = channels.filter(ch => {
    const matchesSearch = !searchQuery || 
      ch.name?.toLowerCase().includes(searchQuery.toLowerCase()) ||
      ch.teams?.name?.toLowerCase().includes(searchQuery.toLowerCase())
    
    const matchesType = filterType === 'all' || 
      (filterType === 'team' && ch.channel_type === 'team_chat') ||
      (filterType === 'dm' && (ch.channel_type === 'dm' || ch.channel_type === 'group_dm'))
    
    return matchesSearch && matchesType
  })
  
  // Group by type
  const teamChats = filteredChannels.filter(c => c.channel_type === 'team_chat' || c.channel_type === 'player_chat')
  const directMessages = filteredChannels.filter(c => c.channel_type === 'dm' || c.channel_type === 'group_dm')
  const announcements = filteredChannels.filter(c => c.channel_type === 'league_announcement')
  
  const getChannelIcon = (type) => {
    switch(type) {
      case 'team_chat': return <Users className="w-6 h-6" />
      case 'player_chat': return <VolleyballIcon className="w-6 h-6" />
      case 'dm': return <MessageCircle className="w-6 h-6" />
      case 'group_dm': return <Users className="w-6 h-6" />
      case 'league_announcement': return <Megaphone className="w-6 h-6" />
      default: return <MessageCircle className="w-6 h-6" />
    }
  }
  
  const formatLastMessageTime = (date) => {
    if (!date) return ''
    const d = new Date(date)
    const now = new Date()
    const diff = now - d
    
    if (diff < 60000) return 'Just now'
    if (diff < 3600000) return `${Math.floor(diff / 60000)}m`
    if (diff < 86400000) return `${Math.floor(diff / 3600000)}h`
    if (diff < 604800000) return d.toLocaleDateString('en-US', { weekday: 'short' })
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className={`text-3xl font-bold ${tc.text}`}>üí¨ Chats</h1>
          <p className={tc.textMuted}>Team conversations and direct messages</p>
        </div>
        <div className="flex gap-3">
          <button
            onClick={() => setShowNewChatModal(true)}
            className="px-4 py-2 rounded-xl bg-[var(--accent-primary)] text-white font-semibold hover:brightness-110 transition"
          >
            + New Chat
          </button>
        </div>
      </div>
      
      {/* Filters */}
      <div className={`${tc.cardBg} border ${tc.border} rounded-2xl p-4`}>
        <div className="flex flex-wrap gap-4 items-center">
          <div className="flex-1 min-w-[200px]">
            <input
              type="text"
              placeholder="Search chats..."
              value={searchQuery}
              onChange={e => setSearchQuery(e.target.value)}
              className={`w-full px-4 py-2 rounded-xl ${tc.input}`}
            />
          </div>
          <div className="flex gap-2">
            {['all', 'team', 'dm'].map(type => (
              <button
                key={type}
                onClick={() => setFilterType(type)}
                className={`px-4 py-2 rounded-xl font-medium transition ${
                  filterType === type
                    ? 'bg-[var(--accent-primary)] text-white'
                    : `${tc.cardBgAlt} ${tc.text} ${tc.hoverBg}`
                }`}
              >
                {type === 'all' ? 'All' : type === 'team' ? 'Teams' : 'DMs'}
              </button>
            ))}
          </div>
        </div>
      </div>
      
      {loading ? (
        <div className="text-center py-12">
          <div className="animate-spin w-8 h-8 border-4 border-[var(--accent-primary)] border-t-transparent rounded-full mx-auto" />
          <p className={`${tc.textMuted} mt-4`}>Loading chats...</p>
        </div>
      ) : (
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Chat List */}
          <div className={`lg:col-span-1 ${tc.cardBg} border ${tc.border} rounded-2xl overflow-hidden`}>
            <div className={`p-4 border-b ${tc.border}`}>
              <h3 className={`font-semibold ${tc.text}`}>Conversations ({filteredChannels.length})</h3>
            </div>
            <div className="max-h-[600px] overflow-y-auto">
              {/* Team Chats */}
              {teamChats.length > 0 && (
                <div>
                  <div className={`px-4 py-2 ${tc.cardBgAlt}`}>
                    <span className={`text-xs font-semibold uppercase ${tc.textMuted}`}>Team Chats</span>
                  </div>
                  {teamChats.map(channel => (
                    <div
                      key={channel.id}
                      onClick={() => setSelectedChannel(channel)}
                      className={`flex items-center gap-3 p-4 cursor-pointer transition ${
                        selectedChannel?.id === channel.id 
                          ? 'bg-[var(--accent-primary)]/10' 
                          : tc.hoverBg
                      } border-b ${tc.border}`}
                    >
                      <div 
                        className="w-12 h-12 rounded-xl flex items-center justify-center text-xl"
                        style={{ backgroundColor: (channel.teams?.color || '#6366F1') + '30' }}
                      >
                        {getChannelIcon(channel.channel_type)}
                      </div>
                      <div className="flex-1 min-w-0">
                        <div className="flex items-center justify-between">
                          <span className={`font-semibold ${tc.text} truncate`}>{channel.name}</span>
                          {channel.unread_count > 0 && (
                            <span className="px-2 py-0.5 rounded-full text-xs font-bold bg-[var(--accent-primary)] text-white">
                              {channel.unread_count}
                            </span>
                          )}
                        </div>
                        <p className={`text-sm ${tc.textMuted} truncate`}>
                          {channel.last_message?.content || 'No messages yet'}
                        </p>
                        <span className={`text-xs ${tc.textMuted}`}>
                          {formatLastMessageTime(channel.last_message?.created_at)}
                        </span>
                      </div>
                    </div>
                  ))}
                </div>
              )}
              
              {/* Direct Messages */}
              {directMessages.length > 0 && (
                <div>
                  <div className={`px-4 py-2 ${tc.cardBgAlt}`}>
                    <span className={`text-xs font-semibold uppercase ${tc.textMuted}`}>Direct Messages</span>
                  </div>
                  {directMessages.map(channel => (
                    <div
                      key={channel.id}
                      onClick={() => setSelectedChannel(channel)}
                      className={`flex items-center gap-3 p-4 cursor-pointer transition ${
                        selectedChannel?.id === channel.id 
                          ? 'bg-[var(--accent-primary)]/10' 
                          : tc.hoverBg
                      } border-b ${tc.border}`}
                    >
                      <div className="w-12 h-12 rounded-xl bg-slate-500/20 flex items-center justify-center text-xl">
                        üí¨
                      </div>
                      <div className="flex-1 min-w-0">
                        <div className="flex items-center justify-between">
                          <span className={`font-semibold ${tc.text} truncate`}>{channel.name}</span>
                          {channel.unread_count > 0 && (
                            <span className="px-2 py-0.5 rounded-full text-xs font-bold bg-[var(--accent-primary)] text-white">
                              {channel.unread_count}
                            </span>
                          )}
                        </div>
                        <p className={`text-sm ${tc.textMuted} truncate`}>
                          {channel.last_message?.content || 'No messages yet'}
                        </p>
                      </div>
                    </div>
                  ))}
                </div>
              )}
              
              {filteredChannels.length === 0 && (
                <div className="text-center py-12">
                  <span className="text-4xl">üí¨</span>
                  <p className={`${tc.textMuted} mt-4`}>No chats found</p>
                  <button
                    onClick={() => setShowNewChatModal(true)}
                    className="mt-4 px-4 py-2 rounded-xl bg-[var(--accent-primary)]/20 text-[var(--accent-primary)] font-medium"
                  >
                    Start a conversation
                  </button>
                </div>
              )}
            </div>
          </div>
          
          {/* Chat Detail */}
          <div className={`lg:col-span-2 ${tc.cardBg} border ${tc.border} rounded-2xl overflow-hidden`}>
            {selectedChannel ? (
              <ChatDetailPanel 
                channel={selectedChannel} 
                onClose={() => setSelectedChannel(null)}
                onRefresh={loadChats}
                showToast={showToast}
              />
            ) : (
              <div className="h-[600px] flex flex-col items-center justify-center">
                <span className="text-6xl mb-4">üí¨</span>
                <p className={`text-xl font-semibold ${tc.text}`}>Select a conversation</p>
                <p className={tc.textMuted}>Choose a chat from the list or start a new one</p>
              </div>
            )}
          </div>
        </div>
      )}
      
      {/* New Chat Modal */}
      {showNewChatModal && (
        <NewChatModal
          teams={teams}
          onClose={() => setShowNewChatModal(false)}
          onCreateTeamChat={createTeamChat}
          showToast={showToast}
        />
      )}
    </div>
  )
}

// ============================================
// CHAT DETAIL PANEL - Messages view with real-time
// ============================================
function ChatDetailPanel({ channel, onClose, onRefresh, showToast }) {
  const { profile, user } = useAuth()
  const tc = useThemeClasses()
  const { isDark } = useTheme()
  
  const [messages, setMessages] = useState([])
  const [newMessage, setNewMessage] = useState('')
  const [loading, setLoading] = useState(true)
  const [sending, setSending] = useState(false)
  const messagesEndRef = useRef(null)
  
  useEffect(() => {
    if (channel?.id) {
      loadMessages()
      markAsRead()
      
      // Subscribe to real-time updates
      const subscription = supabase
        .channel(`chat:${channel.id}`)
        .on('postgres_changes', {
          event: 'INSERT',
          schema: 'public',
          table: 'chat_messages',
          filter: `channel_id=eq.${channel.id}`
        }, (payload) => {
          setMessages(prev => [...prev, payload.new])
          scrollToBottom()
        })
        .subscribe()
      
      return () => {
        subscription.unsubscribe()
      }
    }
  }, [channel?.id])
  
  async function loadMessages() {
    setLoading(true)
    const { data } = await supabase
      .from('chat_messages')
      .select(`
        *,
        profiles:sender_id (id, full_name, account_type)
      `)
      .eq('channel_id', channel.id)
      .eq('is_deleted', false)
      .order('created_at', { ascending: true })
      .limit(100)
    
    setMessages(data || [])
    setLoading(false)
    scrollToBottom()
  }
  
  async function markAsRead() {
    await supabase
      .from('channel_members')
      .update({ last_read_at: new Date().toISOString() })
      .eq('channel_id', channel.id)
      .eq('user_id', user?.id)
  }
  
  function scrollToBottom() {
    setTimeout(() => {
      messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' })
    }, 100)
  }
  
  async function sendMessage(e) {
    e.preventDefault()
    if (!newMessage.trim() || sending) return
    
    setSending(true)
    const { error } = await supabase.from('chat_messages').insert({
      channel_id: channel.id,
      sender_id: user?.id,
      content: newMessage.trim(),
      message_type: 'text'
    })
    
    if (error) {
      showToast?.('Error sending message', 'error')
    } else {
      setNewMessage('')
    }
    setSending(false)
  }
  
  async function deleteMessage(messageId) {
    if (!confirm('Delete this message?')) return
    
    await supabase
      .from('chat_messages')
      .update({ is_deleted: true, deleted_at: new Date().toISOString(), deleted_by: user?.id })
      .eq('id', messageId)
    
    setMessages(prev => prev.filter(m => m.id !== messageId))
    showToast?.('Message deleted', 'success')
  }
  
  const formatMessageTime = (date) => {
    const d = new Date(date)
    return d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })
  }
  
  const formatMessageDate = (date) => {
    const d = new Date(date)
    const today = new Date()
    const yesterday = new Date(today)
    yesterday.setDate(yesterday.getDate() - 1)
    
    if (d.toDateString() === today.toDateString()) return 'Today'
    if (d.toDateString() === yesterday.toDateString()) return 'Yesterday'
    return d.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' })
  }
  
  // Group messages by date
  const messagesByDate = messages.reduce((groups, msg) => {
    const date = new Date(msg.created_at).toDateString()
    if (!groups[date]) groups[date] = []
    groups[date].push(msg)
    return groups
  }, {})

  return (
    <div className="flex flex-col h-[600px]">
      {/* Header */}
      <div className={`p-4 border-b ${tc.border} flex items-center justify-between`}>
        <div className="flex items-center gap-3">
          <div 
            className="w-10 h-10 rounded-xl flex items-center justify-center text-lg"
            style={{ backgroundColor: (channel.teams?.color || '#6366F1') + '30' }}
          >
            {channel.channel_type === 'team_chat' ? 'Team' : 'DM'}
          </div>
          <div>
            <h3 className={`font-semibold ${tc.text}`}>{channel.name}</h3>
            <p className={`text-xs ${tc.textMuted}`}>
              {channel.channel_type === 'team_chat' ? 'Team Chat' : 'Direct Message'}
            </p>
          </div>
        </div>
        <button onClick={onClose} className={`p-2 rounded-lg ${tc.hoverBg} ${tc.textMuted}`}>
          ‚úï
        </button>
      </div>
      
      {/* Messages */}
      <div className="flex-1 overflow-y-auto p-4 space-y-4">
        {loading ? (
          <div className="text-center py-8">
            <div className="animate-spin w-6 h-6 border-2 border-[var(--accent-primary)] border-t-transparent rounded-full mx-auto" />
          </div>
        ) : messages.length === 0 ? (
          <div className="text-center py-8">
            <span className="text-4xl">üí¨</span>
            <p className={`${tc.textMuted} mt-2`}>No messages yet. Start the conversation!</p>
          </div>
        ) : (
          Object.entries(messagesByDate).map(([date, msgs]) => (
            <div key={date}>
              {/* Date separator */}
              <div className="flex items-center gap-4 my-4">
                <div className={`flex-1 h-px ${tc.border}`} />
                <span className={`text-xs ${tc.textMuted} font-medium`}>{formatMessageDate(date)}</span>
                <div className={`flex-1 h-px ${tc.border}`} />
              </div>
              
              {/* Messages for this date */}
              {msgs.map((msg, idx) => {
                const isOwn = msg.sender_id === user?.id
                const showAvatar = idx === 0 || msgs[idx - 1]?.sender_id !== msg.sender_id
                
                return (
                  <div key={msg.id} className={`flex ${isOwn ? 'justify-end' : 'justify-start'} mb-2`}>
                    <div className={`max-w-[70%] ${isOwn ? 'items-end' : 'items-start'}`}>
                      {showAvatar && !isOwn && (
                        <span className={`text-xs ${tc.textMuted} ml-2 mb-1 block`}>
                          {msg.profiles?.full_name || 'Unknown'}
                        </span>
                      )}
                      <div 
                        className={`group relative px-4 py-2 rounded-2xl ${
                          isOwn 
                            ? 'bg-[var(--accent-primary)] text-white rounded-br-md' 
                            : `${tc.cardBgAlt} ${tc.text} rounded-bl-md`
                        }`}
                      >
                        <p className="text-sm whitespace-pre-wrap">{msg.content}</p>
                        <span className={`text-[10px] ${isOwn ? 'text-white/70' : tc.textMuted} block mt-1`}>
                          {formatMessageTime(msg.created_at)}
                        </span>
                        
                        {/* Delete button */}
                        {isOwn && (
                          <button
                            onClick={() => deleteMessage(msg.id)}
                            className="absolute -left-8 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 p-1 rounded hover:bg-red-500/20 text-red-500 transition-opacity"
                          >
                            üóëÔ∏è
                          </button>
                        )}
                      </div>
                    </div>
                  </div>
                )
              })}
            </div>
          ))
        )}
        <div ref={messagesEndRef} />
      </div>
      
      {/* Input */}
      <form onSubmit={sendMessage} className={`p-4 border-t ${tc.border}`}>
        <div className="flex gap-2">
          <input
            type="text"
            value={newMessage}
            onChange={e => setNewMessage(e.target.value)}
            placeholder="Type a message..."
            className={`flex-1 px-4 py-3 rounded-xl ${tc.input}`}
          />
          <button
            type="submit"
            disabled={!newMessage.trim() || sending}
            className="px-6 py-3 rounded-xl bg-[var(--accent-primary)] text-white font-semibold disabled:opacity-50 hover:brightness-110 transition"
          >
            {sending ? '...' : '‚Üí'}
          </button>
        </div>
      </form>
    </div>
  )
}

// ============================================
// NEW CHAT MODAL
// ============================================
function NewChatModal({ teams, onClose, onCreateTeamChat, showToast }) {
  const { profile, user } = useAuth()
  const { selectedSeason } = useSeason()
  const tc = useThemeClasses()
  
  const [activeTab, setActiveTab] = useState('team') // team, dm
  const [searchQuery, setSearchQuery] = useState('')
  const [searchResults, setSearchResults] = useState([])
  const [searching, setSearching] = useState(false)
  
  async function searchUsers(query) {
    if (query.length < 2) {
      setSearchResults([])
      return
    }
    
    setSearching(true)
    const { data } = await supabase
      .from('profiles')
      .select('id, full_name, email, account_type')
      .or(`full_name.ilike.%${query}%,email.ilike.%${query}%`)
      .in('account_type', ['parent', 'coach', 'admin'])
      .neq('id', user?.id)
      .limit(20)
    
    setSearchResults(data || [])
    setSearching(false)
  }
  
  async function startDM(targetUser) {
    // Check if DM already exists between these users
    const { data: existing } = await supabase
      .from('chat_channels')
      .select(`
        id,
        channel_members!inner (user_id)
      `)
      .eq('channel_type', 'dm')
      .eq('season_id', selectedSeason?.id)
    
    // Look for a DM with both users
    const existingDM = existing?.find(ch => {
      const memberIds = ch.channel_members.map(m => m.user_id)
      return memberIds.includes(user?.id) && memberIds.includes(targetUser.id) && memberIds.length === 2
    })
    
    if (existingDM) {
      showToast?.('Chat already exists', 'info')
      onClose()
      return
    }
    
    // Create new DM
    const { data: newChannel, error } = await supabase
      .from('chat_channels')
      .insert({
        season_id: selectedSeason?.id,
        name: `${profile?.full_name} & ${targetUser.full_name}`,
        channel_type: 'dm',
        created_by: user?.id
      })
      .select()
      .single()
    
    if (error) {
      showToast?.('Error creating chat', 'error')
      return
    }
    
    // Add both users as members
    await supabase.from('channel_members').insert([
      {
        channel_id: newChannel.id,
        user_id: user?.id,
        display_name: profile?.full_name || 'User',
        member_role: profile?.account_type || 'parent',
        can_post: true
      },
      {
        channel_id: newChannel.id,
        user_id: targetUser.id,
        display_name: targetUser.full_name,
        member_role: targetUser.account_type || 'parent',
        can_post: true
      }
    ])
    
    showToast?.('Chat created!', 'success')
    onClose()
  }

  return (
    <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
      <div className={`${tc.cardBg} rounded-2xl w-full max-w-lg max-h-[80vh] overflow-hidden`}>
        {/* Header */}
        <div className={`p-4 border-b ${tc.border} flex items-center justify-between`}>
          <h2 className={`text-xl font-bold ${tc.text}`}>New Conversation</h2>
          <button onClick={onClose} className={`p-2 rounded-lg ${tc.hoverBg}`}><X className="w-4 h-4" /></button>
        </div>
        
        {/* Tabs */}
        <div className={`flex border-b ${tc.border}`}>
          <button
            onClick={() => setActiveTab('team')}
            className={`flex-1 py-3 font-medium transition ${
              activeTab === 'team' 
                ? 'border-b-2 border-[var(--accent-primary)] text-[var(--accent-primary)]'
                : tc.textMuted
            }`}
          >
            üë• Team Chat
          </button>
          <button
            onClick={() => setActiveTab('dm')}
            className={`flex-1 py-3 font-medium transition ${
              activeTab === 'dm' 
                ? 'border-b-2 border-[var(--accent-primary)] text-[var(--accent-primary)]'
                : tc.textMuted
            }`}
          >
            üí¨ Direct Message
          </button>
        </div>
        
        {/* Content */}
        <div className="p-4 max-h-[400px] overflow-y-auto">
          {activeTab === 'team' ? (
            <div className="space-y-2">
              <p className={`text-sm ${tc.textMuted} mb-4`}>Select a team to create or open their chat:</p>
              {teams.map(team => (
                <button
                  key={team.id}
                  onClick={() => { onCreateTeamChat(team.id); onClose() }}
                  className={`w-full flex items-center gap-3 p-3 rounded-xl ${tc.cardBgAlt} ${tc.hoverBg} transition text-left`}
                >
                  <div 
                    className="w-10 h-10 rounded-lg flex items-center justify-center text-white font-bold"
                    style={{ backgroundColor: team.color || '#6366F1' }}
                  >
                    {team.name?.charAt(0)}
                  </div>
                  <span className={`font-medium ${tc.text}`}>{team.name}</span>
                </button>
              ))}
              {teams.length === 0 && (
                <p className={`text-center py-8 ${tc.textMuted}`}>No teams in this season</p>
              )}
            </div>
          ) : (
            <div className="space-y-4">
              <input
                type="text"
                placeholder="Search by name or email..."
                value={searchQuery}
                onChange={e => { setSearchQuery(e.target.value); searchUsers(e.target.value) }}
                className={`w-full px-4 py-3 rounded-xl ${tc.input}`}
              />
              
              {searching && (
                <p className={`text-center ${tc.textMuted}`}>Searching...</p>
              )}
              
              <div className="space-y-2">
                {searchResults.map(u => (
                  <button
                    key={u.id}
                    onClick={() => startDM(u)}
                    className={`w-full flex items-center gap-3 p-3 rounded-xl ${tc.cardBgAlt} ${tc.hoverBg} transition text-left`}
                  >
                    <div className="w-10 h-10 rounded-full bg-slate-500/20 flex items-center justify-center font-bold">
                      {u.full_name?.charAt(0) || '?'}
                    </div>
                    <div>
                      <p className={`font-medium ${tc.text}`}>{u.full_name}</p>
                      <p className={`text-xs ${tc.textMuted}`}>{u.account_type}</p>
                    </div>
                  </button>
                ))}
                
                {searchQuery.length >= 2 && searchResults.length === 0 && !searching && (
                  <p className={`text-center py-4 ${tc.textMuted}`}>No users found</p>
                )}
                
                {searchQuery.length < 2 && (
                  <p className={`text-center py-4 ${tc.textMuted}`}>Type at least 2 characters to search</p>
                )}
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  )
}

// ============================================
// BLASTS PAGE - Announcements with read receipts
// ============================================
function BlastsPage({ showToast, activeView, roleContext }) {
  const { organization, profile, user } = useAuth()
  const { selectedSeason } = useSeason()
  const tc = useThemeClasses()
  const { isDark } = useTheme()
  
  const [loading, setLoading] = useState(true)
  const [blasts, setBlasts] = useState([])
  const [teams, setTeams] = useState([])
  const [showComposeModal, setShowComposeModal] = useState(false)
  const [selectedBlast, setSelectedBlast] = useState(null)
  const [filterType, setFilterType] = useState('all')
  
  useEffect(() => {
    if (selectedSeason?.id) loadBlasts()
  }, [selectedSeason?.id])
  
  async function loadBlasts() {
    setLoading(true)
    try {
      // Load teams
      const { data: teamsData } = await supabase
        .from('teams')
        .select('*')
        .eq('season_id', selectedSeason.id)
      setTeams(teamsData || [])
      
      // Load blasts/announcements
      const { data: blastsData } = await supabase
        .from('messages')
        .select(`
          *,
          profiles:sender_id (full_name),
          teams:target_team_id (name, color),
          message_recipients (id, acknowledged, acknowledged_at, recipient_name)
        `)
        .eq('season_id', selectedSeason.id)
        .order('created_at', { ascending: false })
      
      // Calculate stats for each blast
      const blastsWithStats = (blastsData || []).map(blast => {
        const total = blast.message_recipients?.length || 0
        const acknowledged = blast.message_recipients?.filter(r => r.acknowledged).length || 0
        return {
          ...blast,
          total_recipients: total,
          acknowledged_count: acknowledged,
          read_percentage: total > 0 ? Math.round((acknowledged / total) * 100) : 0
        }
      })
      
      setBlasts(blastsWithStats)
    } catch (err) {
      console.error('Error loading blasts:', err)
      showToast?.('Error loading announcements', 'error')
    }
    setLoading(false)
  }
  
  const filteredBlasts = blasts.filter(b => {
    if (filterType === 'all') return true
    if (filterType === 'urgent') return b.priority === 'urgent'
    if (filterType === 'pending') return b.read_percentage < 100
    return b.message_type === filterType
  })
  
  const getTypeIcon = (type) => {
    switch(type) {
      case 'payment_reminder': return <DollarSign className="w-6 h-6" />
      case 'schedule_change': return <Calendar className="w-6 h-6" />
      case 'deadline': return <Clock className="w-6 h-6" />
      case 'announcement': return <Megaphone className="w-6 h-6" />
      default: return <Megaphone className="w-6 h-6" />
    }
  }
  
  const getTypeColor = (type) => {
    switch(type) {
      case 'payment_reminder': return 'bg-emerald-500/20 text-emerald-500'
      case 'schedule_change': return 'bg-blue-500/20 text-blue-500'
      case 'deadline': return 'bg-red-500/20 text-red-500'
      default: return 'bg-purple-500/20 text-purple-500'
    }
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className={`text-3xl font-bold ${tc.text}`}>Announcements</h1>
          <p className={tc.textMuted}>Send messages to teams, parents, and track read receipts</p>
        </div>
        <button
          onClick={() => setShowComposeModal(true)}
          className="px-4 py-2 rounded-xl bg-[var(--accent-primary)] text-white font-semibold hover:brightness-110 transition"
        >
          + New Announcement
        </button>
      </div>
      
      {/* Stats Cards */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div className={`${tc.cardBg} border ${tc.border} rounded-2xl p-4`}>
          <p className={`text-sm ${tc.textMuted}`}>Total Sent</p>
          <p className={`text-3xl font-bold ${tc.text}`}>{blasts.length}</p>
        </div>
        <div className={`${tc.cardBg} border ${tc.border} rounded-2xl p-4`}>
          <p className={`text-sm ${tc.textMuted}`}>Avg. Read Rate</p>
          <p className={`text-3xl font-bold text-emerald-500`}>
            {blasts.length > 0 
              ? Math.round(blasts.reduce((sum, b) => sum + b.read_percentage, 0) / blasts.length)
              : 0}%
          </p>
        </div>
        <div className={`${tc.cardBg} border ${tc.border} rounded-2xl p-4`}>
          <p className={`text-sm ${tc.textMuted}`}>Pending Reads</p>
          <p className={`text-3xl font-bold text-amber-500`}>
            {blasts.filter(b => b.read_percentage < 100).length}
          </p>
        </div>
        <div className={`${tc.cardBg} border ${tc.border} rounded-2xl p-4`}>
          <p className={`text-sm ${tc.textMuted}`}>Urgent</p>
          <p className={`text-3xl font-bold text-red-500`}>
            {blasts.filter(b => b.priority === 'urgent').length}
          </p>
        </div>
      </div>
      
      {/* Filter Tabs */}
      <div className={`${tc.cardBg} border ${tc.border} rounded-2xl p-4`}>
        <div className="flex flex-wrap gap-2">
          {[
            { id: 'all', label: 'All', icon: 'clipboard' },
            { id: 'urgent', label: 'Urgent', icon: 'üö®' },
            { id: 'pending', label: 'Pending Reads', icon: 'üëÄ' },
            { id: 'payment_reminder', label: 'Payment', icon: 'dollar' },
            { id: 'schedule_change', label: 'Schedule', icon: 'calendar' },
            { id: 'announcement', label: 'General', icon: 'megaphone' },
          ].map(filter => (
            <button
              key={filter.id}
              onClick={() => setFilterType(filter.id)}
              className={`px-4 py-2 rounded-xl font-medium transition ${
                filterType === filter.id
                  ? 'bg-[var(--accent-primary)] text-white'
                  : `${tc.cardBgAlt} ${tc.text} ${tc.hoverBg}`
              }`}
            >
              {filter.icon} {filter.label}
            </button>
          ))}
        </div>
      </div>
      
      {/* Blasts List */}
      {loading ? (
        <div className="text-center py-12">
          <div className="animate-spin w-8 h-8 border-4 border-[var(--accent-primary)] border-t-transparent rounded-full mx-auto" />
          <p className={`${tc.textMuted} mt-4`}>Loading announcements...</p>
        </div>
      ) : filteredBlasts.length === 0 ? (
        <div className={`${tc.cardBg} border ${tc.border} rounded-2xl p-12 text-center`}>
          <Megaphone className="w-16 h-16" />
          <p className={`text-xl font-semibold ${tc.text} mt-4`}>No announcements yet</p>
          <p className={tc.textMuted}>Send your first announcement to parents and teams</p>
          <button
            onClick={() => setShowComposeModal(true)}
            className="mt-4 px-6 py-3 rounded-xl bg-[var(--accent-primary)] text-white font-semibold"
          >
            Create Announcement
          </button>
        </div>
      ) : (
        <div className="space-y-4">
          {filteredBlasts.map(blast => (
            <div 
              key={blast.id}
              onClick={() => setSelectedBlast(blast)}
              className={`${tc.cardBg} border ${tc.border} rounded-2xl p-4 cursor-pointer hover:border-[var(--accent-primary)]/50 transition`}
            >
              <div className="flex items-start gap-4">
                <div className={`w-12 h-12 rounded-xl flex items-center justify-center text-2xl ${getTypeColor(blast.message_type)}`}>
                  {getTypeIcon(blast.message_type)}
                </div>
                <div className="flex-1 min-w-0">
                  <div className="flex items-center gap-2 mb-1">
                    <h3 className={`font-semibold ${tc.text}`}>{blast.title}</h3>
                    {blast.priority === 'urgent' && (
                      <span className="px-2 py-0.5 rounded-full text-xs font-bold bg-red-500 text-white">URGENT</span>
                    )}
                    <span className={`px-2 py-0.5 rounded-full text-xs ${getTypeColor(blast.message_type)}`}>
                      {blast.message_type?.replace('_', ' ')}
                    </span>
                  </div>
                  <p className={`${tc.textSecondary} text-sm line-clamp-2`}>{blast.body}</p>
                  <div className="flex items-center gap-4 mt-2 text-xs">
                    <span className={tc.textMuted}>
                      {new Date(blast.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' })}
                    </span>
                    <span className={tc.textMuted}>by {blast.profiles?.full_name}</span>
                    {blast.teams && (
                      <span className="px-2 py-0.5 rounded-full text-xs" style={{ backgroundColor: (blast.teams.color || '#6366F1') + '30', color: blast.teams.color || '#6366F1' }}>
                        {blast.teams.name}
                      </span>
                    )}
                  </div>
                </div>
                
                {/* Read Progress */}
                <div className="text-right min-w-[100px]">
                  <div className={`text-2xl font-bold ${blast.read_percentage === 100 ? 'text-emerald-500' : 'text-amber-500'}`}>
                    {blast.read_percentage}%
                  </div>
                  <p className={`text-xs ${tc.textMuted}`}>
                    {blast.acknowledged_count}/{blast.total_recipients} read
                  </p>
                  <div className="w-full h-2 rounded-full bg-slate-700 mt-2 overflow-hidden">
                    <div 
                      className={`h-full rounded-full transition-all ${blast.read_percentage === 100 ? 'bg-emerald-500' : 'bg-amber-500'}`}
                      style={{ width: `${blast.read_percentage}%` }}
                    />
                  </div>
                </div>
              </div>
            </div>
          ))}
        </div>
      )}
      
      {/* Compose Modal */}
      {showComposeModal && (
        <ComposeBlastModal
          teams={teams}
          onClose={() => setShowComposeModal(false)}
          onSent={() => { loadBlasts(); setShowComposeModal(false) }}
          showToast={showToast}
        />
      )}
      
      {/* Blast Detail Modal */}
      {selectedBlast && (
        <BlastDetailModal
          blast={selectedBlast}
          onClose={() => setSelectedBlast(null)}
          showToast={showToast}
        />
      )}
    </div>
  )
}

// ============================================
// COMPOSE BLAST MODAL
// ============================================
function ComposeBlastModal({ teams, onClose, onSent, showToast }) {
  const { profile, user, organization } = useAuth()
  const { selectedSeason } = useSeason()
  const tc = useThemeClasses()
  
  const [form, setForm] = useState({
    title: '',
    body: '',
    message_type: 'announcement',
    priority: 'normal',
    target_type: 'everyone', // everyone, all_parents, all_coaches, team, team_parents, team_coaches
    target_team_id: ''
  })
  const [sending, setSending] = useState(false)
  const [recipientPreview, setRecipientPreview] = useState({ count: 0, breakdown: '' })
  
  useEffect(() => {
    calculateRecipients()
  }, [form.target_type, form.target_team_id])
  
  async function calculateRecipients() {
    let count = 0
    let breakdown = ''
    
    try {
      if (form.target_type === 'everyone' || form.target_type === 'all_parents') {
        // Count parents (via players with parent accounts)
        const { count: parentCount } = await supabase
          .from('players')
          .select('parent_account_id', { count: 'exact' })
          .eq('season_id', selectedSeason?.id)
          .not('parent_account_id', 'is', null)
        
        count += parentCount || 0
        breakdown = `${parentCount || 0} parents`
      }
      
      if (form.target_type === 'everyone' || form.target_type === 'all_coaches') {
        // Count coaches
        const { count: coachCount } = await supabase
          .from('coaches')
          .select('id', { count: 'exact' })
          .eq('organization_id', organization?.id)
          .eq('status', 'active')
        
        if (form.target_type === 'everyone') {
          count += coachCount || 0
          breakdown += `, ${coachCount || 0} coaches`
        } else {
          count = coachCount || 0
          breakdown = `${coachCount || 0} coaches`
        }
      }
      
      if (form.target_type === 'team' || form.target_type === 'team_parents') {
        if (form.target_team_id) {
          const { data: teamPlayers } = await supabase
            .from('team_players')
            .select('players(parent_account_id)')
            .eq('team_id', form.target_team_id)
          
          const uniqueParents = new Set(teamPlayers?.map(tp => tp.players?.parent_account_id).filter(Boolean))
          count = uniqueParents.size
          breakdown = `${count} parents from team`
        }
      }
      
      if (form.target_type === 'team_coaches') {
        if (form.target_team_id) {
          const { count: coachCount } = await supabase
            .from('team_coaches')
            .select('id', { count: 'exact' })
            .eq('team_id', form.target_team_id)
          
          count = coachCount || 0
          breakdown = `${count} coaches from team`
        }
      }
    } catch (err) {
      console.error('Error calculating recipients:', err)
    }
    
    setRecipientPreview({ count, breakdown })
  }
  
  async function handleSend() {
    if (!form.title.trim() || !form.body.trim()) {
      showToast?.('Please fill in title and message', 'error')
      return
    }
    
    if (recipientPreview.count === 0) {
      showToast?.('No recipients selected', 'error')
      return
    }
    
    setSending(true)
    try {
      // Create the message/blast
      const { data: newBlast, error } = await supabase
        .from('messages')
        .insert({
          season_id: selectedSeason?.id,
          sender_id: user?.id,
          title: form.title,
          body: form.body,
          message_type: form.message_type,
          priority: form.priority,
          target_type: form.target_type,
          target_team_id: form.target_team_id || null,
          requires_acknowledgment: true,
          total_recipients: recipientPreview.count,
          acknowledged_count: 0
        })
        .select()
        .single()
      
      if (error) throw error
      
      // Collect all recipients based on target type
      const recipients = []
      
      // Get parents
      if (['everyone', 'all_parents', 'team', 'team_parents'].includes(form.target_type)) {
        let playersQuery = supabase
          .from('players')
          .select('id, first_name, last_name, parent_account_id, parent_email, parent_phone, parent_name')
          .eq('season_id', selectedSeason?.id)
          .not('parent_account_id', 'is', null)
        
        if (form.target_type === 'team' || form.target_type === 'team_parents') {
          const { data: teamPlayers } = await supabase
            .from('team_players')
            .select('player_id')
            .eq('team_id', form.target_team_id)
          
          const playerIds = teamPlayers?.map(tp => tp.player_id) || []
          if (playerIds.length > 0) {
            playersQuery = playersQuery.in('id', playerIds)
          }
        }
        
        const { data: players } = await playersQuery
        
        // Dedupe by parent account
        const seenParents = new Set()
        players?.forEach(p => {
          if (p.parent_account_id && !seenParents.has(p.parent_account_id)) {
            seenParents.add(p.parent_account_id)
            recipients.push({
              message_id: newBlast.id,
              player_id: p.id,
              profile_id: p.parent_account_id,
              recipient_name: p.parent_name || `${p.first_name}'s Parent`,
              recipient_email: p.parent_email,
              recipient_phone: p.parent_phone,
              recipient_type: 'parent',
              acknowledged: false
            })
          }
        })
      }
      
      // Get coaches
      if (['everyone', 'all_coaches', 'team_coaches'].includes(form.target_type)) {
        let coachesQuery = supabase
          .from('coaches')
          .select('id, first_name, last_name, email, phone, user_id')
          .eq('organization_id', organization?.id)
          .eq('status', 'active')
        
        if (form.target_type === 'team_coaches' && form.target_team_id) {
          const { data: teamCoaches } = await supabase
            .from('team_coaches')
            .select('coach_id')
            .eq('team_id', form.target_team_id)
          
          const coachIds = teamCoaches?.map(tc => tc.coach_id) || []
          if (coachIds.length > 0) {
            coachesQuery = coachesQuery.in('id', coachIds)
          }
        }
        
        const { data: coaches } = await coachesQuery
        
        coaches?.forEach(c => {
          recipients.push({
            message_id: newBlast.id,
            profile_id: c.user_id,
            recipient_name: `Coach ${c.first_name} ${c.last_name}`,
            recipient_email: c.email,
            recipient_phone: c.phone,
            recipient_type: 'coach',
            acknowledged: false
          })
        })
      }
      
      // Insert all recipients
      if (recipients.length > 0) {
        await supabase.from('message_recipients').insert(recipients)
      }
      
      showToast?.(`Announcement sent to ${recipients.length} recipients!`, 'success')
      onSent()
    } catch (err) {
      console.error('Error sending blast:', err)
      showToast?.('Error sending announcement', 'error')
    }
    setSending(false)
  }

  const targetOptions = [
    { id: 'everyone', label: 'üåê Everyone', desc: 'All parents and coaches' },
    { id: 'all_parents', label: 'Parent All Parents', desc: 'Every parent in the season' },
    { id: 'all_coaches', label: 'Coach All Coaches', desc: 'Every coach in the organization' },
    { id: 'team', label: 'Team Parents', desc: 'Parents from specific team' },
    { id: 'team_coaches', label: 'Team Coaches', desc: 'Coaches from specific team' },
  ]

  return (
    <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
      <div className={`${tc.cardBg} rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col`}>
        {/* Header */}
        <div className={`p-4 border-b ${tc.border} flex items-center justify-between`}>
          <h2 className={`text-xl font-bold ${tc.text}`}>New Announcement</h2>
          <button onClick={onClose} className={`p-2 rounded-lg ${tc.hoverBg}`}><X className="w-4 h-4" /></button>
        </div>
        
        {/* Form */}
        <div className="flex-1 overflow-y-auto p-6 space-y-4">
          {/* Title */}
          <div>
            <label className={`block text-sm ${tc.textMuted} mb-2`}>Title *</label>
            <input
              type="text"
              value={form.title}
              onChange={e => setForm({...form, title: e.target.value})}
              placeholder="e.g., Practice Canceled Tomorrow"
              className={`w-full px-4 py-3 rounded-xl ${tc.input}`}
            />
          </div>
          
          {/* Message */}
          <div>
            <label className={`block text-sm ${tc.textMuted} mb-2`}>Message *</label>
            <textarea
              value={form.body}
              onChange={e => setForm({...form, body: e.target.value})}
              placeholder="Your message..."
              rows={5}
              className={`w-full px-4 py-3 rounded-xl ${tc.input} resize-none`}
            />
          </div>
          
          {/* Type & Priority */}
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className={`block text-sm ${tc.textMuted} mb-2`}>Type</label>
              <select
                value={form.message_type}
                onChange={e => setForm({...form, message_type: e.target.value})}
                className={`w-full px-4 py-3 rounded-xl ${tc.input}`}
              >
                <option value="announcement">General Announcement</option>
                <option value="payment_reminder">üí∞ Payment Reminder</option>
                <option value="schedule_change">üóìÔ∏è Schedule Change</option>
                <option value="deadline">‚è∞ Deadline Reminder</option>
              </select>
            </div>
            <div>
              <label className={`block text-sm ${tc.textMuted} mb-2`}>Priority</label>
              <select
                value={form.priority}
                onChange={e => setForm({...form, priority: e.target.value})}
                className={`w-full px-4 py-3 rounded-xl ${tc.input}`}
              >
                <option value="normal">Normal</option>
                <option value="urgent">üö® Urgent</option>
              </select>
            </div>
          </div>
          
          {/* Target Audience */}
          <div>
            <label className={`block text-sm ${tc.textMuted} mb-2`}>Send To *</label>
            <div className="grid grid-cols-2 gap-2">
              {targetOptions.map(opt => (
                <button
                  key={opt.id}
                  onClick={() => setForm({...form, target_type: opt.id, target_team_id: ''})}
                  className={`p-3 rounded-xl text-left transition ${
                    form.target_type === opt.id
                      ? 'bg-[var(--accent-primary)] text-white'
                      : `${tc.cardBgAlt} ${tc.text} ${tc.hoverBg}`
                  }`}
                >
                  <p className="font-medium">{opt.label}</p>
                  <p className={`text-xs ${form.target_type === opt.id ? 'text-white/70' : tc.textMuted}`}>{opt.desc}</p>
                </button>
              ))}
            </div>
            
            {/* Team selector for team-specific targets */}
            {(form.target_type === 'team' || form.target_type === 'team_coaches') && (
              <div className="mt-3">
                <select
                  value={form.target_team_id}
                  onChange={e => setForm({...form, target_team_id: e.target.value})}
                  className={`w-full px-4 py-3 rounded-xl ${tc.input}`}
                >
                  <option value="">Select a team...</option>
                  {teams.map(t => (
                    <option key={t.id} value={t.id}>{t.name}</option>
                  ))}
                </select>
              </div>
            )}
          </div>
          
          {/* Recipient Preview */}
          <div className={`${tc.cardBgAlt} rounded-xl p-4`}>
            <div className="flex items-center justify-between">
              <div>
                <span className={tc.textMuted}>Recipients</span>
                <p className={`text-xs ${tc.textMuted}`}>{recipientPreview.breakdown}</p>
              </div>
              <span className={`text-3xl font-bold ${recipientPreview.count > 0 ? 'text-emerald-500' : 'text-red-500'}`}>
                {recipientPreview.count}
              </span>
            </div>
          </div>
        </div>
        
        {/* Footer */}
        <div className={`p-4 border-t ${tc.border} flex justify-end gap-3`}>
          <button
            onClick={onClose}
            className={`px-6 py-2 rounded-xl ${tc.cardBgAlt} ${tc.text} font-medium`}
          >
            Cancel
          </button>
          <button
            onClick={handleSend}
            disabled={sending || !form.title.trim() || !form.body.trim() || recipientPreview.count === 0}
            className="px-6 py-2 rounded-xl bg-[var(--accent-primary)] text-white font-semibold disabled:opacity-50"
          >
            {sending ? 'Sending...' : `Send to ${recipientPreview.count} Recipients`}
          </button>
        </div>
      </div>
    </div>
  )
}

// ============================================
// BLAST DETAIL MODAL - View recipients & read status
// ============================================
function BlastDetailModal({ blast, onClose, showToast }) {
  const tc = useThemeClasses()
  const [filterStatus, setFilterStatus] = useState('all')
  
  const recipients = blast.message_recipients || []
  const filteredRecipients = recipients.filter(r => {
    if (filterStatus === 'all') return true
    if (filterStatus === 'read') return r.acknowledged
    return !r.acknowledged
  })

  return (
    <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
      <div className={`${tc.cardBg} rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col`}>
        {/* Header */}
        <div className={`p-4 border-b ${tc.border}`}>
          <div className="flex items-center justify-between mb-2">
            <h2 className={`text-xl font-bold ${tc.text}`}>{blast.title}</h2>
            <button onClick={onClose} className={`p-2 rounded-lg ${tc.hoverBg}`}><X className="w-4 h-4" /></button>
          </div>
          <p className={`${tc.textSecondary} text-sm`}>{blast.body}</p>
          <div className="flex items-center gap-4 mt-3 text-xs">
            <span className={tc.textMuted}>
              Sent {new Date(blast.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' })}
            </span>
            <span className={tc.textMuted}>by {blast.profiles?.full_name}</span>
          </div>
        </div>
        
        {/* Stats */}
        <div className={`p-4 border-b ${tc.border} flex gap-4`}>
          <div className="flex-1 text-center">
            <p className="text-3xl font-bold text-emerald-500">{blast.acknowledged_count}</p>
            <p className={`text-xs ${tc.textMuted}`}>Read</p>
          </div>
          <div className="flex-1 text-center">
            <p className="text-3xl font-bold text-amber-500">{blast.total_recipients - blast.acknowledged_count}</p>
            <p className={`text-xs ${tc.textMuted}`}>Unread</p>
          </div>
          <div className="flex-1 text-center">
            <p className={`text-3xl font-bold ${blast.read_percentage === 100 ? 'text-emerald-500' : tc.text}`}>
              {blast.read_percentage}%
            </p>
            <p className={`text-xs ${tc.textMuted}`}>Rate</p>
          </div>
        </div>
        
        {/* Filter */}
        <div className={`p-4 border-b ${tc.border} flex gap-2`}>
          {['all', 'read', 'unread'].map(status => (
            <button
              key={status}
              onClick={() => setFilterStatus(status)}
              className={`px-4 py-2 rounded-xl font-medium transition ${
                filterStatus === status
                  ? 'bg-[var(--accent-primary)] text-white'
                  : `${tc.cardBgAlt} ${tc.text}`
              }`}
            >
              {status === 'all' ? `All (${recipients.length})` : 
               status === 'read' ? `Read (${recipients.filter(r => r.acknowledged).length})` :
               `Unread (${recipients.filter(r => !r.acknowledged).length})`}
            </button>
          ))}
        </div>
        
        {/* Recipients List */}
        <div className="flex-1 overflow-y-auto">
          {filteredRecipients.length === 0 ? (
            <div className="text-center py-8">
              <p className={tc.textMuted}>No recipients in this filter</p>
            </div>
          ) : (
            <div className="divide-y divide-slate-700">
              {filteredRecipients.map(r => (
                <div key={r.id} className="flex items-center justify-between p-4">
                  <div className="flex items-center gap-3">
                    <div className={`w-10 h-10 rounded-full flex items-center justify-center ${
                      r.acknowledged ? 'bg-emerald-500/20 text-emerald-500' : 'bg-slate-500/20 text-slate-400'
                    }`}>
                      {r.acknowledged ? '‚úì' : '‚óã'}
                    </div>
                    <div>
                      <p className={`font-medium ${tc.text}`}>{r.recipient_name}</p>
                      <p className={`text-xs ${tc.textMuted}`}>{r.recipient_email}</p>
                    </div>
                  </div>
                  {r.acknowledged && (
                    <span className={`text-xs ${tc.textMuted}`}>
                      Read {new Date(r.acknowledged_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' })}
                    </span>
                  )}
                </div>
              ))}
            </div>
          )}
        </div>
        
        {/* Footer */}
        <div className={`p-4 border-t ${tc.border} flex justify-end`}>
          <button
            onClick={onClose}
            className="px-6 py-2 rounded-xl bg-[var(--accent-primary)] text-white font-semibold"
          >
            Close
          </button>
        </div>
      </div>
    </div>
  )
}

// ============================================
// REPORTS & ANALYTICS PAGE V2
// Top header nav, column customization, presets
// ============================================
function ReportsPage({ showToast }) {
  const tc = useThemeClasses()
  const { isDark, accent } = useTheme()
  const { selectedSeason: globalSeason } = useSeason()
  const { selectedSport: globalSport } = useSport()
  const { organization, user, profile } = useAuth()
  
  // Independent season/sport selection for reports
  const [seasons, setSeasons] = useState([])
  const [sports, setSports] = useState([])
  const [selectedSeasonId, setSelectedSeasonId] = useState(null)
  const [selectedSportId, setSelectedSportId] = useState('all')
  
  // Report state
  const [activeCategory, setActiveCategory] = useState('people')
  const [activeReport, setActiveReport] = useState('players')
  const [loading, setLoading] = useState(false)
  const [data, setData] = useState([])
  const [stats, setStats] = useState({})
  
  // Filter state
  const [filters, setFilters] = useState({
    team: 'all',
    status: 'all',
    dateFrom: '',
    dateTo: '',
    search: ''
  })
  const [showFilters, setShowFilters] = useState(false)
  
  // Sort state
  const [sortField, setSortField] = useState('')
  const [sortDir, setSortDir] = useState('asc')
  
  // Column customization
  const [showColumnPicker, setShowColumnPicker] = useState(false)
  const [visibleColumns, setVisibleColumns] = useState({})
  const [columnOrder, setColumnOrder] = useState([])
  
  // Saved presets
  const [savedPresets, setSavedPresets] = useState([])
  const [showPresetModal, setShowPresetModal] = useState(false)
  const [presetName, setPresetName] = useState('')
  
  // Export state
  const [showExportMenu, setShowExportMenu] = useState(false)
  const [exporting, setExporting] = useState(false)
  
  // Available teams for filter
  const [teams, setTeams] = useState([])
  
  // Category dropdown states
  const [openDropdown, setOpenDropdown] = useState(null)
  
  // Report categories and types
  const reportCategories = {
    people: {
      label: 'People',
      icon: 'users',
      reports: [
        { id: 'players', label: 'Player Roster', icon: 'users', description: 'All players with contact info' },
        { id: 'teams', label: 'Team Composition', icon: 'volleyball', description: 'Teams with roster counts' },
        { id: 'coaches', label: 'Coach Directory', icon: 'user-cog', description: 'All coaches and assignments' },
        { id: 'emergency', label: 'Emergency Contacts', icon: 'üö®', description: 'Emergency contact list' },
        { id: 'jerseys', label: 'Jersey Assignment', icon: 'shirt', description: 'Jersey numbers and sizes' },
      ]
    },
    financial: {
      label: 'Financial',
      icon: 'dollar',
      reports: [
        { id: 'payments', label: 'Payment Summary', icon: 'dollar', description: 'Payment status by player' },
        { id: 'financial', label: 'Financial Overview', icon: 'bar-chart', description: 'Revenue and collections' },
        { id: 'outstanding', label: 'Outstanding Balances', icon: '‚ö†Ô∏è', description: 'Unpaid balances' },
      ]
    },
    operations: {
      label: 'Operations',
      icon: 'calendar',
      reports: [
        { id: 'attendance', label: 'Attendance Report', icon: 'check-square', description: 'RSVP and attendance rates' },
        { id: 'registrations', label: 'Registration Report', icon: 'clipboard', description: 'Registration pipeline' },
        { id: 'volunteers', label: 'Volunteer Report', icon: 'üôã', description: 'Volunteer participation' },
      ]
    },
  }
  
  // Load seasons and sports on mount
  useEffect(() => {
    loadSeasonsAndSports()
    loadSavedPresets()
  }, [organization?.id])
  
  // Set default season from global context
  useEffect(() => {
    if (globalSeason?.id && !selectedSeasonId) {
      setSelectedSeasonId(globalSeason.id)
    }
  }, [globalSeason?.id])
  
  // Set default sport from global context  
  useEffect(() => {
    if (globalSport?.id && selectedSportId === 'all') {
      setSelectedSportId(globalSport.id)
    }
  }, [globalSport?.id])
  
  // Load teams when season changes
  useEffect(() => {
    if (selectedSeasonId) {
      loadTeams()
    }
  }, [selectedSeasonId])
  
  // Load report data when relevant state changes
  useEffect(() => {
    if (selectedSeasonId) {
      loadReportData()
    }
  }, [selectedSeasonId, selectedSportId, activeReport, filters])
  
  // Initialize visible columns when report changes
  useEffect(() => {
    const cols = getAvailableColumns()
    const defaultVisible = {}
    const order = []
    cols.forEach(col => {
      defaultVisible[col.id] = col.defaultVisible !== false
      order.push(col.id)
    })
    setVisibleColumns(defaultVisible)
    setColumnOrder(order)
  }, [activeReport])
  
  async function loadSeasonsAndSports() {
    if (!organization?.id) return
    
    // Load all seasons (not just active)
    const { data: seasonData } = await supabase
      .from('seasons')
      .select('id, name, status, start_date, sport_id')
      .eq('organization_id', organization.id)
      .order('start_date', { ascending: false })
    
    setSeasons(seasonData || [])
    
    // Load sports
    const { data: sportData } = await supabase
      .from('sports')
      .select('id, name, icon')
      .eq('organization_id', organization.id)
      .order('name')
    
    setSports(sportData || [])
  }
  
  async function loadTeams() {
    const { data } = await supabase
      .from('teams')
      .select('id, name, color')
      .eq('season_id', selectedSeasonId)
      .order('name')
    setTeams(data || [])
  }
  
  function loadSavedPresets() {
    const saved = localStorage.getItem(`vb_report_presets_${organization?.id}`)
    if (saved) {
      setSavedPresets(JSON.parse(saved))
    }
  }
  
  function savePreset() {
    if (!presetName.trim()) return
    
    const preset = {
      id: Date.now(),
      name: presetName,
      category: activeCategory,
      report: activeReport,
      visibleColumns: { ...visibleColumns },
      columnOrder: [...columnOrder],
      filters: { ...filters },
      createdAt: new Date().toISOString()
    }
    
    const updated = [...savedPresets, preset]
    setSavedPresets(updated)
    localStorage.setItem(`vb_report_presets_${organization?.id}`, JSON.stringify(updated))
    
    setPresetName('')
    setShowPresetModal(false)
    showToast('Report preset saved!', 'success')
  }
  
  function loadPreset(preset) {
    setActiveCategory(preset.category)
    setActiveReport(preset.report)
    setVisibleColumns(preset.visibleColumns)
    setColumnOrder(preset.columnOrder)
    setFilters(preset.filters)
    showToast(`Loaded preset: ${preset.name}`, 'success')
  }
  
  function deletePreset(presetId) {
    const updated = savedPresets.filter(p => p.id !== presetId)
    setSavedPresets(updated)
    localStorage.setItem(`vb_report_presets_${organization?.id}`, JSON.stringify(updated))
    showToast('Preset deleted', 'success')
  }
  
  async function loadReportData() {
    setLoading(true)
    
    try {
      switch (activeReport) {
        case 'players':
          await loadPlayersReport()
          break
        case 'teams':
          await loadTeamsReport()
          break
        case 'payments':
          await loadPaymentsReport()
          break
        case 'outstanding':
          await loadOutstandingReport()
          break
        case 'attendance':
          await loadAttendanceReport()
          break
        case 'registrations':
          await loadRegistrationsReport()
          break
        case 'financial':
          await loadFinancialReport()
          break
        case 'jerseys':
          await loadJerseysReport()
          break
        case 'coaches':
          await loadCoachesReport()
          break
        case 'emergency':
          await loadEmergencyReport()
          break
        case 'volunteers':
          await loadVolunteersReport()
          break
      }
    } catch (err) {
      console.error('Error loading report:', err)
      showToast('Error loading report', 'error')
    }
    
    setLoading(false)
  }
  
  // Get selected season object
  const getSelectedSeason = () => seasons.find(s => s.id === selectedSeasonId)
  
  // ========== REPORT LOADERS ==========
  
  async function loadPlayersReport() {
    // Query ALL players for selected season, no joins that might filter
    const { data, error } = await supabase
      .from('players')
      .select(`
        id, first_name, last_name, email, phone, grade, position,
        jersey_number, uniform_size_jersey, status, photo_url,
        parent_name, parent_email, parent_phone, parent_phone_secondary,
        date_of_birth, school, medical_notes, allergies,
        created_at, updated_at
      `)
      .eq('season_id', selectedSeasonId)
      .order('last_name')
    
    if (error) {
      console.error('Players query error:', error)
      setData([])
      return
    }
    
    // Get team assignments separately
    const { data: teamAssignments } = await supabase
      .from('team_players')
      .select('player_id, teams (id, name, color)')
      .in('player_id', (data || []).map(p => p.id))
    
    // Create lookup map
    const teamMap = {}
    ;(teamAssignments || []).forEach(ta => {
      if (!teamMap[ta.player_id]) teamMap[ta.player_id] = []
      if (ta.teams) teamMap[ta.player_id].push(ta.teams)
    })
    
    // Transform data
    const transformed = (data || []).map(p => ({
      ...p,
      full_name: `${p.first_name} ${p.last_name}`,
      team_name: teamMap[p.id]?.[0]?.name || 'Unassigned',
      team_color: teamMap[p.id]?.[0]?.color || '#666',
      teams_list: teamMap[p.id]?.map(t => t.name).join(', ') || 'Unassigned',
      age: p.date_of_birth ? Math.floor((new Date() - new Date(p.date_of_birth)) / (365.25 * 24 * 60 * 60 * 1000)) : null
    }))
    
    // Apply filters
    let filtered = transformed
    if (filters.team !== 'all') {
      filtered = filtered.filter(p => teamMap[p.id]?.some(t => t.id === filters.team))
    }
    if (filters.status !== 'all') {
      filtered = filtered.filter(p => p.status === filters.status)
    }
    if (filters.search) {
      const search = filters.search.toLowerCase()
      filtered = filtered.filter(p => 
        p.full_name.toLowerCase().includes(search) ||
        p.parent_name?.toLowerCase().includes(search) ||
        p.parent_email?.toLowerCase().includes(search)
      )
    }
    
    setData(filtered)
    
    // Calculate stats
    setStats({
      total: filtered.length,
      active: filtered.filter(p => p.status === 'active').length,
      unassigned: filtered.filter(p => p.team_name === 'Unassigned').length,
      missingContact: filtered.filter(p => !p.parent_email && !p.parent_phone).length,
      labels: ['Total Players', 'Active', 'Unassigned', 'Missing Contact']
    })
  }
  
  async function loadTeamsReport() {
    const { data, error } = await supabase
      .from('teams')
      .select(`
        id, name, color, age_group, team_type, skill_level, gender,
        max_roster_size, min_roster_size, roster_open, created_at, description
      `)
      .eq('season_id', selectedSeasonId)
      .order('name')
    
    if (error) {
      console.error('Teams query error:', error)
      setData([])
      return
    }
    
    // Get player counts
    const { data: playerCounts } = await supabase
      .from('team_players')
      .select('team_id')
      .in('team_id', (data || []).map(t => t.id))
    
    // Get coach assignments
    const { data: coachAssignments } = await supabase
      .from('coach_assignments')
      .select('team_id, coaches (first_name, last_name, role)')
      .in('team_id', (data || []).map(t => t.id))
    
    // Count players per team
    const countMap = {}
    ;(playerCounts || []).forEach(pc => {
      countMap[pc.team_id] = (countMap[pc.team_id] || 0) + 1
    })
    
    // Map coaches to teams
    const coachMap = {}
    ;(coachAssignments || []).forEach(ca => {
      if (!coachMap[ca.team_id]) coachMap[ca.team_id] = []
      if (ca.coaches) coachMap[ca.team_id].push(ca.coaches)
    })
    
    const transformed = (data || []).map(t => ({
      ...t,
      player_count: countMap[t.id] || 0,
      coach_count: coachMap[t.id]?.length || 0,
      head_coach: coachMap[t.id]?.find(c => c.role === 'head_coach')?.first_name || 
                  coachMap[t.id]?.[0]?.first_name || '-',
      coaches_list: coachMap[t.id]?.map(c => `${c.first_name} ${c.last_name}`).join(', ') || 'None',
      roster_status: (countMap[t.id] || 0) >= (t.min_roster_size || 6) ? 'Ready' : 'Need Players',
      roster_fill: t.max_roster_size ? Math.round(((countMap[t.id] || 0) / t.max_roster_size) * 100) : 0
    }))
    
    setData(transformed)
    
    const total = transformed.length
    const ready = transformed.filter(t => t.roster_status === 'Ready').length
    const needPlayers = transformed.filter(t => t.roster_status === 'Need Players').length
    const totalPlayers = transformed.reduce((sum, t) => sum + t.player_count, 0)
    
    setStats({
      total,
      ready,
      needPlayers,
      totalPlayers,
      labels: ['Total Teams', 'Ready', 'Need Players', 'Total Players']
    })
  }
  
  async function loadPaymentsReport() {
    // Get all players for season
    const { data: players } = await supabase
      .from('players')
      .select('id, first_name, last_name, parent_name, parent_email')
      .eq('season_id', selectedSeasonId)
      .order('last_name')
    
    // Get all payments
    const { data: payments } = await supabase
      .from('payments')
      .select('id, player_id, amount, paid, paid_at, payment_method, description')
      .eq('season_id', selectedSeasonId)
    
    // Group payments by player
    const paymentMap = {}
    ;(payments || []).forEach(p => {
      if (!paymentMap[p.player_id]) paymentMap[p.player_id] = []
      paymentMap[p.player_id].push(p)
    })
    
    const transformed = (players || []).map(p => {
      const playerPayments = paymentMap[p.id] || []
      const totalDue = playerPayments.reduce((sum, pay) => sum + (pay.amount || 0), 0)
      const totalPaid = playerPayments.filter(pay => pay.paid).reduce((sum, pay) => sum + (pay.amount || 0), 0)
      const balance = totalDue - totalPaid
      
      return {
        ...p,
        full_name: `${p.first_name} ${p.last_name}`,
        total_due: totalDue,
        total_paid: totalPaid,
        balance: balance,
        payment_status: totalDue === 0 ? 'No Fees' : balance === 0 ? 'Paid' : balance < totalDue ? 'Partial' : 'Unpaid',
        payment_count: playerPayments.length,
        last_payment: playerPayments.filter(pay => pay.paid).sort((a, b) => 
          new Date(b.paid_at) - new Date(a.paid_at)
        )[0]?.paid_at || null
      }
    })
    
    // Apply filters
    let filtered = transformed
    if (filters.status === 'paid') {
      filtered = filtered.filter(p => p.payment_status === 'Paid')
    } else if (filters.status === 'unpaid') {
      filtered = filtered.filter(p => p.payment_status === 'Unpaid')
    } else if (filters.status === 'partial') {
      filtered = filtered.filter(p => p.payment_status === 'Partial')
    }
    if (filters.search) {
      const search = filters.search.toLowerCase()
      filtered = filtered.filter(p => p.full_name.toLowerCase().includes(search))
    }
    
    setData(filtered)
    
    const totalRevenue = transformed.reduce((sum, p) => sum + p.total_due, 0)
    const collected = transformed.reduce((sum, p) => sum + p.total_paid, 0)
    const outstanding = totalRevenue - collected
    const collectionRate = totalRevenue > 0 ? Math.round((collected / totalRevenue) * 100) : 0
    
    setStats({
      totalRevenue,
      collected,
      outstanding,
      collectionRate,
      labels: ['Total Due', 'Collected', 'Outstanding', 'Collection Rate']
    })
  }
  
  async function loadOutstandingReport() {
    // Get players with unpaid balances
    const { data: players } = await supabase
      .from('players')
      .select('id, first_name, last_name, parent_name, parent_email, parent_phone')
      .eq('season_id', selectedSeasonId)
    
    const { data: payments } = await supabase
      .from('payments')
      .select('id, player_id, amount, paid, description, created_at')
      .eq('season_id', selectedSeasonId)
    
    const paymentMap = {}
    ;(payments || []).forEach(p => {
      if (!paymentMap[p.player_id]) paymentMap[p.player_id] = []
      paymentMap[p.player_id].push(p)
    })
    
    const transformed = (players || []).map(p => {
      const playerPayments = paymentMap[p.id] || []
      const totalDue = playerPayments.reduce((sum, pay) => sum + (pay.amount || 0), 0)
      const totalPaid = playerPayments.filter(pay => pay.paid).reduce((sum, pay) => sum + (pay.amount || 0), 0)
      const balance = totalDue - totalPaid
      const unpaidItems = playerPayments.filter(pay => !pay.paid)
      
      return {
        ...p,
        full_name: `${p.first_name} ${p.last_name}`,
        total_due: totalDue,
        total_paid: totalPaid,
        balance: balance,
        unpaid_items: unpaidItems.map(u => u.description).join(', ') || '-',
        days_outstanding: unpaidItems.length > 0 ? 
          Math.floor((new Date() - new Date(Math.min(...unpaidItems.map(u => new Date(u.created_at))))) / (1000 * 60 * 60 * 24)) : 0
      }
    }).filter(p => p.balance > 0)
    
    setData(transformed.sort((a, b) => b.balance - a.balance))
    
    const totalOutstanding = transformed.reduce((sum, p) => sum + p.balance, 0)
    const playerCount = transformed.length
    const avgBalance = playerCount > 0 ? Math.round(totalOutstanding / playerCount) : 0
    const over30Days = transformed.filter(p => p.days_outstanding > 30).length
    
    setStats({
      totalOutstanding,
      playerCount,
      avgBalance,
      over30Days,
      labels: ['Total Outstanding', 'Players with Balance', 'Avg Balance', 'Over 30 Days']
    })
  }
  
  async function loadAttendanceReport() {
    // Get all players
    const { data: players } = await supabase
      .from('players')
      .select('id, first_name, last_name')
      .eq('season_id', selectedSeasonId)
    
    // Get events
    const { data: events } = await supabase
      .from('events')
      .select('id, title, event_type, start_time')
      .eq('season_id', selectedSeasonId)
      .in('event_type', ['practice', 'game'])
      .order('start_time', { ascending: false })
      .limit(50)
    
    // Get RSVPs
    const { data: rsvps } = await supabase
      .from('rsvps')
      .select('id, player_id, event_id, status')
      .in('event_id', (events || []).map(e => e.id))
    
    // Group RSVPs by player
    const rsvpMap = {}
    ;(rsvps || []).forEach(r => {
      if (!rsvpMap[r.player_id]) rsvpMap[r.player_id] = []
      rsvpMap[r.player_id].push(r)
    })
    
    const eventCount = events?.length || 0
    
    const playerAttendance = (players || []).map(player => {
      const playerRsvps = rsvpMap[player.id] || []
      const attending = playerRsvps.filter(r => r.status === 'attending').length
      const notAttending = playerRsvps.filter(r => r.status === 'not_attending').length
      const noResponse = eventCount - attending - notAttending
      const rate = eventCount > 0 ? Math.round((attending / eventCount) * 100) : 0
      
      return {
        ...player,
        full_name: `${player.first_name} ${player.last_name}`,
        events_total: eventCount,
        attending,
        not_attending: notAttending,
        no_response: noResponse,
        attendance_rate: rate
      }
    })
    
    setData(playerAttendance.sort((a, b) => b.attendance_rate - a.attendance_rate))
    
    const avgRate = playerAttendance.length > 0 
      ? Math.round(playerAttendance.reduce((sum, p) => sum + p.attendance_rate, 0) / playerAttendance.length)
      : 0
    const perfect = playerAttendance.filter(p => p.attendance_rate === 100).length
    const low = playerAttendance.filter(p => p.attendance_rate < 50).length
    
    setStats({
      totalEvents: eventCount,
      avgRate,
      perfect,
      low,
      labels: ['Events Tracked', 'Avg Attendance', 'Perfect Attendance', 'Below 50%']
    })
  }
  
  async function loadRegistrationsReport() {
    // Get ALL players, including those without registration records
    const { data: players } = await supabase
      .from('players')
      .select(`
        id, first_name, last_name, parent_name, parent_email, parent_phone,
        status, created_at
      `)
      .eq('season_id', selectedSeasonId)
      .order('created_at', { ascending: false })
    
    // Get registration records separately
    const { data: registrations } = await supabase
      .from('registrations')
      .select('id, player_id, status, submitted_at, approved_at, denied_at, deny_reason')
      .in('player_id', (players || []).map(p => p.id))
    
    // Map registrations to players
    const regMap = {}
    ;(registrations || []).forEach(r => {
      regMap[r.player_id] = r
    })
    
    const transformed = (players || []).map(p => {
      const reg = regMap[p.id]
      return {
        ...p,
        full_name: `${p.first_name} ${p.last_name}`,
        reg_status: reg?.status || p.status || 'manual',
        registration_type: reg ? 'Online' : 'Manual Entry',
        submitted_at: reg?.submitted_at || p.created_at,
        approved_at: reg?.approved_at,
        denied_at: reg?.denied_at,
        deny_reason: reg?.deny_reason
      }
    })
    
    let filtered = transformed
    if (filters.status !== 'all') {
      filtered = filtered.filter(p => p.reg_status === filters.status)
    }
    if (filters.search) {
      const search = filters.search.toLowerCase()
      filtered = filtered.filter(p => 
        p.full_name.toLowerCase().includes(search) ||
        p.parent_name?.toLowerCase().includes(search)
      )
    }
    
    setData(filtered)
    
    const total = transformed.length
    const pending = transformed.filter(p => ['pending', 'submitted'].includes(p.reg_status)).length
    const approved = transformed.filter(p => ['approved', 'active'].includes(p.reg_status)).length
    const manual = transformed.filter(p => p.registration_type === 'Manual Entry').length
    
    setStats({
      total,
      pending,
      approved,
      manual,
      labels: ['Total', 'Pending', 'Approved', 'Manual Entry']
    })
  }
  
  async function loadFinancialReport() {
    const { data: payments } = await supabase
      .from('payments')
      .select(`
        id, amount, paid, paid_at, payment_method, description, created_at,
        players (first_name, last_name)
      `)
      .eq('season_id', selectedSeasonId)
      .order('created_at', { ascending: false })
    
    const transformed = (payments || []).map(p => ({
      ...p,
      player_name: p.players ? `${p.players.first_name} ${p.players.last_name}` : 'Unknown',
      status: p.paid ? 'Paid' : 'Pending'
    }))
    
    // Apply filters
    let filtered = transformed
    if (filters.dateFrom) {
      filtered = filtered.filter(p => new Date(p.created_at) >= new Date(filters.dateFrom))
    }
    if (filters.dateTo) {
      filtered = filtered.filter(p => new Date(p.created_at) <= new Date(filters.dateTo))
    }
    if (filters.status === 'paid') {
      filtered = filtered.filter(p => p.paid)
    } else if (filters.status === 'unpaid') {
      filtered = filtered.filter(p => !p.paid)
    }
    
    setData(filtered)
    
    const totalExpected = transformed.reduce((sum, p) => sum + (p.amount || 0), 0)
    const collected = transformed.filter(p => p.paid).reduce((sum, p) => sum + (p.amount || 0), 0)
    const pending = totalExpected - collected
    
    setStats({
      totalExpected,
      collected,
      pending,
      transactionCount: transformed.length,
      labels: ['Expected Revenue', 'Collected', 'Pending', 'Transactions']
    })
  }
  
  async function loadJerseysReport() {
    const { data: players } = await supabase
      .from('players')
      .select('id, first_name, last_name, jersey_number, uniform_size_jersey')
      .eq('season_id', selectedSeasonId)
      .order('jersey_number', { nullsFirst: false })
    
    // Get team assignments
    const { data: teamAssignments } = await supabase
      .from('team_players')
      .select('player_id, teams (id, name, color)')
      .in('player_id', (players || []).map(p => p.id))
    
    const teamMap = {}
    ;(teamAssignments || []).forEach(ta => {
      if (ta.teams) teamMap[ta.player_id] = ta.teams
    })
    
    const transformed = (players || []).map(p => ({
      ...p,
      full_name: `${p.first_name} ${p.last_name}`,
      team_name: teamMap[p.id]?.name || 'Unassigned',
      team_color: teamMap[p.id]?.color || '#666',
      has_jersey: !!p.jersey_number,
      has_size: !!p.uniform_size_jersey
    }))
    
    let filtered = transformed
    if (filters.team !== 'all') {
      filtered = filtered.filter(p => teamMap[p.id]?.id === filters.team)
    }
    
    setData(filtered)
    
    const total = filtered.length
    const assigned = filtered.filter(p => p.has_jersey).length
    const missingNumber = filtered.filter(p => !p.has_jersey).length
    const missingSize = filtered.filter(p => !p.has_size).length
    
    setStats({
      total,
      assigned,
      missingNumber,
      missingSize,
      labels: ['Total Players', 'Jersey Assigned', 'Missing Number', 'Missing Size']
    })
  }
  
  async function loadCoachesReport() {
    const { data } = await supabase
      .from('coaches')
      .select('id, first_name, last_name, email, phone, role, background_check_status, background_check_date, certifications')
      .eq('organization_id', organization?.id)
      .order('last_name')
    
    // Get team assignments
    const { data: assignments } = await supabase
      .from('coach_assignments')
      .select('coach_id, teams (id, name, season_id)')
      .in('coach_id', (data || []).map(c => c.id))
    
    const assignMap = {}
    ;(assignments || []).forEach(a => {
      if (!assignMap[a.coach_id]) assignMap[a.coach_id] = []
      if (a.teams) assignMap[a.coach_id].push(a.teams)
    })
    
    const transformed = (data || []).map(c => {
      const coachTeams = assignMap[c.id] || []
      const seasonTeams = coachTeams.filter(t => t.season_id === selectedSeasonId)
      
      return {
        ...c,
        full_name: `${c.first_name} ${c.last_name}`,
        team_count: seasonTeams.length,
        teams_list: seasonTeams.map(t => t.name).join(', ') || 'None',
        all_teams_list: coachTeams.map(t => t.name).join(', ') || 'None',
        bg_check_status: c.background_check_status || 'Not Submitted'
      }
    })
    
    setData(transformed)
    
    const total = transformed.length
    const headCoaches = transformed.filter(c => c.role === 'head_coach').length
    const assistants = transformed.filter(c => c.role === 'assistant').length
    const bgCleared = transformed.filter(c => c.background_check_status === 'cleared').length
    
    setStats({
      total,
      headCoaches,
      assistants,
      bgCleared,
      labels: ['Total Coaches', 'Head Coaches', 'Assistants', 'BG Cleared']
    })
  }
  
  async function loadEmergencyReport() {
    const { data: players } = await supabase
      .from('players')
      .select(`
        id, first_name, last_name,
        emergency_contact_name, emergency_contact_phone, emergency_contact_relationship,
        parent_name, parent_phone, parent_email,
        medical_notes, allergies
      `)
      .eq('season_id', selectedSeasonId)
      .order('last_name')
    
    // Get team assignments
    const { data: teamAssignments } = await supabase
      .from('team_players')
      .select('player_id, teams (name)')
      .in('player_id', (players || []).map(p => p.id))
    
    const teamMap = {}
    ;(teamAssignments || []).forEach(ta => {
      if (ta.teams) teamMap[ta.player_id] = ta.teams.name
    })
    
    const transformed = (players || []).map(p => ({
      ...p,
      full_name: `${p.first_name} ${p.last_name}`,
      team_name: teamMap[p.id] || 'Unassigned',
      has_emergency: !!p.emergency_contact_name && !!p.emergency_contact_phone,
      has_medical: !!p.medical_notes || !!p.allergies
    }))
    
    setData(transformed)
    
    const total = transformed.length
    const complete = transformed.filter(p => p.has_emergency).length
    const missing = transformed.filter(p => !p.has_emergency).length
    const hasMedical = transformed.filter(p => p.has_medical).length
    
    setStats({
      total,
      complete,
      missing,
      hasMedical,
      labels: ['Total Players', 'Complete Info', 'Missing Emergency', 'Has Medical Notes']
    })
  }
  
  async function loadVolunteersReport() {
    const { data: events } = await supabase
      .from('events')
      .select(`
        id, title, start_time,
        event_volunteers (
          id, role, status,
          profiles (id, full_name, email)
        )
      `)
      .eq('season_id', selectedSeasonId)
      .order('start_time', { ascending: false })
      .limit(100)
    
    // Aggregate by volunteer
    const volunteerMap = {}
    ;(events || []).forEach(event => {
      (event.event_volunteers || []).forEach(v => {
        if (!v.profiles) return
        const id = v.profiles.id
        if (!volunteerMap[id]) {
          volunteerMap[id] = {
            id,
            full_name: v.profiles.full_name,
            email: v.profiles.email,
            total_signups: 0,
            roles: {}
          }
        }
        volunteerMap[id].total_signups++
        const role = v.role || 'General'
        volunteerMap[id].roles[role] = (volunteerMap[id].roles[role] || 0) + 1
      })
    })
    
    const transformed = Object.values(volunteerMap).map(v => ({
      ...v,
      top_role: Object.entries(v.roles).sort((a, b) => b[1] - a[1])[0]?.[0] || '-',
      roles_list: Object.entries(v.roles).map(([r, c]) => `${r}: ${c}`).join(', ')
    }))
    
    setData(transformed.sort((a, b) => b.total_signups - a.total_signups))
    
    const totalVolunteers = transformed.length
    const totalSignups = transformed.reduce((sum, v) => sum + v.total_signups, 0)
    const topVolunteer = transformed[0]?.full_name || '-'
    const eventsWithVols = (events || []).filter(e => e.event_volunteers?.length > 0).length
    
    setStats({
      totalVolunteers,
      totalSignups,
      topVolunteer,
      eventsWithVols,
      labels: ['Total Volunteers', 'Total Signups', 'Top Volunteer', 'Events Covered']
    })
  }
  
  // ========== COLUMN DEFINITIONS ==========
  
  const getAvailableColumns = () => {
    switch (activeReport) {
      case 'players':
        return [
          { id: 'full_name', label: 'Player Name', sortable: true, defaultVisible: true },
          { id: 'team_name', label: 'Team', sortable: true, defaultVisible: true },
          { id: 'grade', label: 'Grade', sortable: true, defaultVisible: true },
          { id: 'position', label: 'Position', sortable: true, defaultVisible: true },
          { id: 'jersey_number', label: 'Jersey #', sortable: true, defaultVisible: true },
          { id: 'parent_name', label: 'Parent Name', sortable: true, defaultVisible: true },
          { id: 'parent_email', label: 'Parent Email', sortable: false, defaultVisible: true },
          { id: 'parent_phone', label: 'Parent Phone', sortable: false, defaultVisible: true },
          { id: 'parent_phone_secondary', label: 'Secondary Phone', sortable: false, defaultVisible: false },
          { id: 'email', label: 'Player Email', sortable: false, defaultVisible: false },
          { id: 'phone', label: 'Player Phone', sortable: false, defaultVisible: false },
          { id: 'status', label: 'Status', sortable: true, defaultVisible: true },
          { id: 'age', label: 'Age', sortable: true, defaultVisible: false },
          { id: 'date_of_birth', label: 'DOB', sortable: true, defaultVisible: false, format: 'date' },
          { id: 'school', label: 'School', sortable: true, defaultVisible: false },
          { id: 'uniform_size_jersey', label: 'Jersey Size', sortable: true, defaultVisible: false },
          { id: 'created_at', label: 'Added', sortable: true, defaultVisible: false, format: 'date' },
        ]
      case 'teams':
        return [
          { id: 'name', label: 'Team Name', sortable: true, defaultVisible: true },
          { id: 'age_group', label: 'Age Group', sortable: true, defaultVisible: true },
          { id: 'team_type', label: 'Type', sortable: true, defaultVisible: true },
          { id: 'gender', label: 'Gender', sortable: true, defaultVisible: false },
          { id: 'skill_level', label: 'Skill Level', sortable: true, defaultVisible: false },
          { id: 'player_count', label: 'Players', sortable: true, defaultVisible: true },
          { id: 'max_roster_size', label: 'Max Size', sortable: true, defaultVisible: true },
          { id: 'roster_fill', label: 'Fill %', sortable: true, defaultVisible: false, format: 'percent' },
          { id: 'head_coach', label: 'Head Coach', sortable: true, defaultVisible: true },
          { id: 'coaches_list', label: 'All Coaches', sortable: false, defaultVisible: false },
          { id: 'roster_status', label: 'Status', sortable: true, defaultVisible: true },
          { id: 'description', label: 'Description', sortable: false, defaultVisible: false },
        ]
      case 'payments':
        return [
          { id: 'full_name', label: 'Player', sortable: true, defaultVisible: true },
          { id: 'parent_name', label: 'Parent', sortable: true, defaultVisible: true },
          { id: 'parent_email', label: 'Email', sortable: false, defaultVisible: false },
          { id: 'total_due', label: 'Total Due', sortable: true, defaultVisible: true, format: 'currency' },
          { id: 'total_paid', label: 'Paid', sortable: true, defaultVisible: true, format: 'currency' },
          { id: 'balance', label: 'Balance', sortable: true, defaultVisible: true, format: 'currency' },
          { id: 'payment_status', label: 'Status', sortable: true, defaultVisible: true },
          { id: 'payment_count', label: '# Payments', sortable: true, defaultVisible: false },
          { id: 'last_payment', label: 'Last Payment', sortable: true, defaultVisible: true, format: 'date' },
        ]
      case 'outstanding':
        return [
          { id: 'full_name', label: 'Player', sortable: true, defaultVisible: true },
          { id: 'parent_name', label: 'Parent', sortable: true, defaultVisible: true },
          { id: 'parent_email', label: 'Email', sortable: false, defaultVisible: true },
          { id: 'parent_phone', label: 'Phone', sortable: false, defaultVisible: true },
          { id: 'balance', label: 'Balance Due', sortable: true, defaultVisible: true, format: 'currency' },
          { id: 'unpaid_items', label: 'Unpaid Items', sortable: false, defaultVisible: true },
          { id: 'days_outstanding', label: 'Days Outstanding', sortable: true, defaultVisible: true },
        ]
      case 'attendance':
        return [
          { id: 'full_name', label: 'Player', sortable: true, defaultVisible: true },
          { id: 'events_total', label: 'Events', sortable: true, defaultVisible: true },
          { id: 'attending', label: 'Attending', sortable: true, defaultVisible: true },
          { id: 'not_attending', label: 'Not Attending', sortable: true, defaultVisible: true },
          { id: 'no_response', label: 'No Response', sortable: true, defaultVisible: true },
          { id: 'attendance_rate', label: 'Rate', sortable: true, defaultVisible: true, format: 'percent' },
        ]
      case 'registrations':
        return [
          { id: 'full_name', label: 'Player', sortable: true, defaultVisible: true },
          { id: 'parent_name', label: 'Parent', sortable: true, defaultVisible: true },
          { id: 'parent_email', label: 'Email', sortable: false, defaultVisible: true },
          { id: 'parent_phone', label: 'Phone', sortable: false, defaultVisible: false },
          { id: 'registration_type', label: 'Type', sortable: true, defaultVisible: true },
          { id: 'reg_status', label: 'Status', sortable: true, defaultVisible: true },
          { id: 'submitted_at', label: 'Submitted', sortable: true, defaultVisible: true, format: 'date' },
          { id: 'approved_at', label: 'Approved', sortable: true, defaultVisible: false, format: 'date' },
        ]
      case 'financial':
        return [
          { id: 'player_name', label: 'Player', sortable: true, defaultVisible: true },
          { id: 'description', label: 'Description', sortable: true, defaultVisible: true },
          { id: 'amount', label: 'Amount', sortable: true, defaultVisible: true, format: 'currency' },
          { id: 'status', label: 'Status', sortable: true, defaultVisible: true },
          { id: 'payment_method', label: 'Method', sortable: true, defaultVisible: true },
          { id: 'paid_at', label: 'Paid Date', sortable: true, defaultVisible: true, format: 'date' },
          { id: 'created_at', label: 'Created', sortable: true, defaultVisible: false, format: 'date' },
        ]
      case 'jerseys':
        return [
          { id: 'jersey_number', label: 'Jersey #', sortable: true, defaultVisible: true },
          { id: 'full_name', label: 'Player', sortable: true, defaultVisible: true },
          { id: 'team_name', label: 'Team', sortable: true, defaultVisible: true },
          { id: 'uniform_size_jersey', label: 'Size', sortable: true, defaultVisible: true },
        ]
      case 'coaches':
        return [
          { id: 'full_name', label: 'Coach', sortable: true, defaultVisible: true },
          { id: 'role', label: 'Role', sortable: true, defaultVisible: true },
          { id: 'email', label: 'Email', sortable: false, defaultVisible: true },
          { id: 'phone', label: 'Phone', sortable: false, defaultVisible: true },
          { id: 'teams_list', label: 'Teams (This Season)', sortable: false, defaultVisible: true },
          { id: 'all_teams_list', label: 'All Teams', sortable: false, defaultVisible: false },
          { id: 'bg_check_status', label: 'BG Check', sortable: true, defaultVisible: true },
          { id: 'background_check_date', label: 'BG Check Date', sortable: true, defaultVisible: false, format: 'date' },
        ]
      case 'emergency':
        return [
          { id: 'full_name', label: 'Player', sortable: true, defaultVisible: true },
          { id: 'team_name', label: 'Team', sortable: true, defaultVisible: true },
          { id: 'parent_name', label: 'Parent', sortable: true, defaultVisible: true },
          { id: 'parent_phone', label: 'Parent Phone', sortable: false, defaultVisible: true },
          { id: 'emergency_contact_name', label: 'Emergency Contact', sortable: true, defaultVisible: true },
          { id: 'emergency_contact_phone', label: 'Emergency Phone', sortable: false, defaultVisible: true },
          { id: 'emergency_contact_relationship', label: 'Relationship', sortable: true, defaultVisible: true },
          { id: 'medical_notes', label: 'Medical Notes', sortable: false, defaultVisible: false },
          { id: 'allergies', label: 'Allergies', sortable: false, defaultVisible: false },
        ]
      case 'volunteers':
        return [
          { id: 'full_name', label: 'Volunteer', sortable: true, defaultVisible: true },
          { id: 'email', label: 'Email', sortable: false, defaultVisible: true },
          { id: 'total_signups', label: 'Total Signups', sortable: true, defaultVisible: true },
          { id: 'top_role', label: 'Top Role', sortable: true, defaultVisible: true },
          { id: 'roles_list', label: 'All Roles', sortable: false, defaultVisible: false },
        ]
      default:
        return []
    }
  }
  
  // Get visible columns in order
  const getVisibleColumnsOrdered = () => {
    const available = getAvailableColumns()
    return columnOrder
      .filter(colId => visibleColumns[colId])
      .map(colId => available.find(c => c.id === colId))
      .filter(Boolean)
  }
  
  // ========== SORTING ==========
  
  const sortedData = [...data].sort((a, b) => {
    if (!sortField) return 0
    const aVal = a[sortField]
    const bVal = b[sortField]
    if (aVal === bVal) return 0
    if (aVal === null || aVal === undefined) return 1
    if (bVal === null || bVal === undefined) return -1
    const comparison = aVal < bVal ? -1 : 1
    return sortDir === 'asc' ? comparison : -comparison
  })
  
  const handleSort = (field) => {
    if (sortField === field) {
      setSortDir(sortDir === 'asc' ? 'desc' : 'asc')
    } else {
      setSortField(field)
      setSortDir('asc')
    }
  }
  
  // ========== FORMATTERS ==========
  
  const formatValue = (value, format) => {
    if (value === null || value === undefined) return '-'
    switch (format) {
      case 'currency':
        return `$${Number(value).toLocaleString('en-US', { minimumFractionDigits: 2 })}`
      case 'percent':
        return `${value}%`
      case 'date':
        return value ? new Date(value).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : '-'
      default:
        return value
    }
  }
  
  // ========== EXPORT FUNCTIONS ==========
  
  const getCurrentReport = () => {
    for (const cat of Object.values(reportCategories)) {
      const found = cat.reports.find(r => r.id === activeReport)
      if (found) return found
    }
    return null
  }
  
  const getBrandedHeader = () => {
    const season = getSelectedSeason()
    return {
      orgName: organization?.name || 'Organization',
      seasonName: season?.name || 'All Seasons',
      reportTitle: getCurrentReport()?.label || 'Report',
      generatedBy: profile?.full_name || user?.email || 'Admin',
      generatedAt: new Date().toLocaleString(),
      logoUrl: organization?.logo_url
    }
  }
  
  async function exportCSV() {
    setExporting(true)
    const columns = getVisibleColumnsOrdered()
    const header = getBrandedHeader()
    
    let csv = `"${header.orgName}"\n`
    csv += `"${header.seasonName} - ${header.reportTitle}"\n`
    csv += `"Generated by: ${header.generatedBy}"\n`
    csv += `"Date: ${header.generatedAt}"\n`
    csv += `"Records: ${sortedData.length}"\n`
    csv += `\n`
    
    csv += columns.map(c => `"${c.label}"`).join(',') + '\n'
    
    sortedData.forEach(row => {
      csv += columns.map(c => {
        let val = row[c.id]
        if (c.format) val = formatValue(val, c.format)
        if (val === null || val === undefined) val = ''
        val = String(val).replace(/"/g, '""')
        return `"${val}"`
      }).join(',') + '\n'
    })
    
    const blob = new Blob([csv], { type: 'text/csv' })
    const url = URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
    a.download = `${header.orgName.replace(/\s+/g, '_')}_${activeReport}_${new Date().toISOString().split('T')[0]}.csv`
    a.click()
    URL.revokeObjectURL(url)
    
    showToast('Report exported to CSV', 'success')
    setExporting(false)
    setShowExportMenu(false)
  }
  
  async function exportPDF() {
    setExporting(true)
    const header = getBrandedHeader()
    const columns = getVisibleColumnsOrdered()
    
    const printContent = `
      <!DOCTYPE html>
      <html>
      <head>
        <title>${header.reportTitle} - ${header.orgName}</title>
        <style>
          * { box-sizing: border-box; margin: 0; padding: 0; }
          body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 40px; color: #1a1a1a; }
          .header { border-bottom: 3px solid ${accent?.primary || '#f97316'}; padding-bottom: 20px; margin-bottom: 30px; }
          .header h1 { font-size: 28px; color: #1a1a1a; margin-bottom: 5px; }
          .header h2 { font-size: 18px; color: #666; font-weight: normal; }
          .meta { display: flex; gap: 30px; margin-top: 15px; font-size: 12px; color: #888; }
          .stats { display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; }
          .stat { background: #f8f9fa; padding: 15px 20px; border-radius: 8px; min-width: 120px; }
          .stat-value { font-size: 24px; font-weight: bold; color: #1a1a1a; }
          .stat-label { font-size: 11px; color: #666; text-transform: uppercase; margin-top: 4px; }
          table { width: 100%; border-collapse: collapse; font-size: 10px; }
          th { background: #f8f9fa; padding: 8px 6px; text-align: left; font-weight: 600; border-bottom: 2px solid #e5e7eb; white-space: nowrap; }
          td { padding: 6px; border-bottom: 1px solid #e5e7eb; }
          tr:nth-child(even) { background: #fafafa; }
          .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #e5e7eb; font-size: 10px; color: #888; text-align: center; }
          @media print { body { padding: 20px; } }
        </style>
      </head>
      <body>
        <div class="header">
          <h1>${header.orgName}</h1>
          <h2>${header.seasonName} - ${header.reportTitle}</h2>
          <div class="meta">
            <span>Generated by: ${header.generatedBy}</span>
            <span>Date: ${header.generatedAt}</span>
            <span>Records: ${sortedData.length}</span>
          </div>
        </div>
        
        <div class="stats">
          ${stats.labels ? stats.labels.map((label, i) => {
            const keys = Object.keys(stats).filter(k => k !== 'labels')
            const value = stats[keys[i]]
            const isMonetary = ['totalRevenue', 'collected', 'outstanding', 'totalExpected', 'totalOutstanding', 'avgBalance'].includes(keys[i])
            const displayValue = isMonetary ? '$' + Number(value).toLocaleString() : 
                                keys[i].includes('Rate') ? value + '%' : value
            return `<div class="stat"><div class="stat-value">${displayValue}</div><div class="stat-label">${label}</div></div>`
          }).join('') : ''}
        </div>
        
        <table>
          <thead>
            <tr>${columns.map(c => `<th>${c.label}</th>`).join('')}</tr>
          </thead>
          <tbody>
            ${sortedData.map(row => `
              <tr>${columns.map(c => `<td>${formatValue(row[c.id], c.format)}</td>`).join('')}</tr>
            `).join('')}
          </tbody>
        </table>
        
        <div class="footer">
          ${header.orgName} ‚Ä¢ Generated via VolleyBrain Admin Portal ‚Ä¢ ${header.generatedAt}
        </div>
      </body>
      </html>
    `
    
    const printWindow = window.open('', '_blank')
    printWindow.document.write(printContent)
    printWindow.document.close()
    setTimeout(() => printWindow.print(), 250)
    
    showToast('PDF export opened', 'success')
    setExporting(false)
    setShowExportMenu(false)
  }
  
  function printReport() { exportPDF() }
  
  async function emailReport() {
    setExporting(true)
    const header = getBrandedHeader()
    
    const subject = encodeURIComponent(`${header.reportTitle} - ${header.orgName}`)
    const body = encodeURIComponent(
      `${header.reportTitle}\n${header.orgName} - ${header.seasonName}\n\n` +
      `Generated: ${header.generatedAt}\nTotal Records: ${sortedData.length}\n\n` +
      `For the full report, please use the CSV or PDF export in VolleyBrain.`
    )
    
    window.location.href = `mailto:?subject=${subject}&body=${body}`
    showToast('Email client opened', 'success')
    setExporting(false)
    setShowExportMenu(false)
  }
  
  // ========== FILTER OPTIONS ==========
  
  const getStatusOptions = () => {
    switch (activeReport) {
      case 'players':
        return [
          { value: 'all', label: 'All Status' },
          { value: 'active', label: 'Active' },
          { value: 'inactive', label: 'Inactive' },
          { value: 'waitlist', label: 'Waitlist' },
        ]
      case 'payments':
      case 'outstanding':
        return [
          { value: 'all', label: 'All Status' },
          { value: 'paid', label: 'Paid' },
          { value: 'unpaid', label: 'Unpaid' },
          { value: 'partial', label: 'Partial' },
        ]
      case 'registrations':
        return [
          { value: 'all', label: 'All Status' },
          { value: 'pending', label: 'Pending' },
          { value: 'submitted', label: 'Submitted' },
          { value: 'approved', label: 'Approved' },
          { value: 'active', label: 'Active' },
          { value: 'manual', label: 'Manual' },
        ]
      case 'financial':
        return [
          { value: 'all', label: 'All Status' },
          { value: 'paid', label: 'Paid' },
          { value: 'unpaid', label: 'Pending' },
        ]
      default:
        return []
    }
  }
  
  // ========== RENDER ==========
  
  const currentReport = getCurrentReport()
  const columns = getVisibleColumnsOrdered()
  const allColumns = getAvailableColumns()
  const statusOptions = getStatusOptions()
  const selectedSeason = getSelectedSeason()
  
  return (
    <div className="flex flex-col h-[calc(100vh-100px)]">
      {/* Top Header Bar */}
      <div className={`${tc.cardBg} border-b ${tc.border} px-6 py-4`}>
        <div className="flex items-center justify-between mb-4">
          <div>
            <h1 className={`text-2xl font-bold ${tc.text}`}>Reports & Analytics</h1>
            <p className={`text-sm ${tc.textMuted}`}>Generate, customize, and export reports</p>
          </div>
          
          {/* Season & Sport Selectors */}
          <div className="flex items-center gap-4">
            {/* Sport Selector */}
            {sports.length > 0 && (
              <div>
                <label className={`block text-xs ${tc.textMuted} mb-1`}>Sport</label>
                <select
                  value={selectedSportId}
                  onChange={e => setSelectedSportId(e.target.value)}
                  className={`${tc.input} rounded-lg px-3 py-2 text-sm min-w-[140px]`}
                >
                  <option value="all">All Sports</option>
                  {sports.map(s => (
                    <option key={s.id} value={s.id}>{s.icon} {s.name}</option>
                  ))}
                </select>
              </div>
            )}
            
            {/* Season Selector */}
            <div>
              <label className={`block text-xs ${tc.textMuted} mb-1`}>Season</label>
              <select
                value={selectedSeasonId || ''}
                onChange={e => setSelectedSeasonId(e.target.value)}
                className={`${tc.input} rounded-lg px-3 py-2 text-sm min-w-[180px]`}
              >
                <option value="">Select Season</option>
                {seasons.map(s => (
                  <option key={s.id} value={s.id}>
                    {s.name} {s.status === 'active' ? '‚óè' : s.status === 'upcoming' ? '‚óã' : '‚óå'}
                  </option>
                ))}
              </select>
            </div>
          </div>
        </div>
        
        {/* Category Tabs with Dropdowns */}
        <div className="flex items-center gap-2">
          {Object.entries(reportCategories).map(([catId, cat]) => (
            <div key={catId} className="relative">
              <button
                onClick={() => setOpenDropdown(openDropdown === catId ? null : catId)}
                className={`px-4 py-2 rounded-xl font-medium transition flex items-center gap-2 ${
                  activeCategory === catId
                    ? 'bg-[var(--accent-primary)] text-white'
                    : `${tc.cardBgAlt} ${tc.text} ${tc.hoverBg}`
                }`}
              >
                <span>{cat.icon}</span>
                <span>{cat.label}</span>
                <span className="text-xs ml-1">‚ñº</span>
              </button>
              
              {openDropdown === catId && (
                <>
                  <div className="fixed inset-0 z-40" onClick={() => setOpenDropdown(null)} />
                  <div className={`absolute left-0 top-full mt-2 w-64 ${tc.cardBg} border ${tc.border} rounded-xl shadow-xl z-50 overflow-hidden`}>
                    {cat.reports.map(report => (
                      <button
                        key={report.id}
                        onClick={() => {
                          setActiveCategory(catId)
                          setActiveReport(report.id)
                          setOpenDropdown(null)
                          setFilters({ team: 'all', status: 'all', dateFrom: '', dateTo: '', search: '' })
                          setSortField('')
                        }}
                        className={`w-full text-left px-4 py-3 ${tc.hoverBg} transition flex items-center gap-3 ${
                          activeReport === report.id ? 'bg-[var(--accent-primary)]/10' : ''
                        }`}
                      >
                        <span className="text-xl">{report.icon}</span>
                        <div>
                          <p className={`font-medium ${tc.text}`}>{report.label}</p>
                          <p className={`text-xs ${tc.textMuted}`}>{report.description}</p>
                        </div>
                        {activeReport === report.id && (
                          <span className="ml-auto text-[var(--accent-primary)]">‚úì</span>
                        )}
                      </button>
                    ))}
                  </div>
                </>
              )}
            </div>
          ))}
          
          {/* Saved Presets Dropdown */}
          <div className="relative ml-auto">
            <button
              onClick={() => setOpenDropdown(openDropdown === 'presets' ? null : 'presets')}
              className={`px-4 py-2 rounded-xl font-medium transition flex items-center gap-2 ${tc.cardBgAlt} ${tc.text} ${tc.hoverBg}`}
            >
              <Star className="w-4 h-4 text-yellow-400" />
              <span>Saved</span>
              {savedPresets.length > 0 && (
                <span className="px-1.5 py-0.5 bg-[var(--accent-primary)] text-white text-xs rounded-full">
                  {savedPresets.length}
                </span>
              )}
            </button>
            
            {openDropdown === 'presets' && (
              <>
                <div className="fixed inset-0 z-40" onClick={() => setOpenDropdown(null)} />
                <div className={`absolute right-0 top-full mt-2 w-72 ${tc.cardBg} border ${tc.border} rounded-xl shadow-xl z-50 overflow-hidden`}>
                  <div className={`px-4 py-3 border-b ${tc.border}`}>
                    <p className={`font-semibold ${tc.text}`}>Saved Report Presets</p>
                  </div>
                  {savedPresets.length === 0 ? (
                    <div className={`px-4 py-6 text-center ${tc.textMuted}`}>
                      <p>No saved presets yet</p>
                      <p className="text-xs mt-1">Save your current view as a preset</p>
                    </div>
                  ) : (
                    <div className="max-h-64 overflow-y-auto">
                      {savedPresets.map(preset => (
                        <div key={preset.id} className={`px-4 py-3 ${tc.hoverBg} flex items-center justify-between`}>
                          <button
                            onClick={() => { loadPreset(preset); setOpenDropdown(null) }}
                            className="flex-1 text-left"
                          >
                            <p className={`font-medium ${tc.text}`}>{preset.name}</p>
                            <p className={`text-xs ${tc.textMuted}`}>
                              {reportCategories[preset.category]?.reports.find(r => r.id === preset.report)?.label}
                            </p>
                          </button>
                          <button
                            onClick={() => deletePreset(preset.id)}
                            className={`p-1 rounded ${tc.hoverBg} text-red-400 hover:text-red-500`}
                          >
                            üóëÔ∏è
                          </button>
                        </div>
                      ))}
                    </div>
                  )}
                  <div className={`px-4 py-3 border-t ${tc.border}`}>
                    <button
                      onClick={() => { setShowPresetModal(true); setOpenDropdown(null) }}
                      className="w-full px-4 py-2 rounded-lg bg-[var(--accent-primary)] text-white font-medium text-sm"
                    >
                      + Save Current View
                    </button>
                  </div>
                </div>
              </>
            )}
          </div>
        </div>
      </div>
      
      {/* Main Content */}
      <div className="flex-1 flex flex-col overflow-hidden p-6">
        {!selectedSeasonId ? (
          <div className="flex-1 flex items-center justify-center">
            <div className="text-center">
              <span className="text-6xl">üìÖ</span>
              <p className={`${tc.text} font-medium mt-4 text-lg`}>Select a Season</p>
              <p className={`${tc.textMuted} mt-2`}>Choose a season from the dropdown above to view reports</p>
            </div>
          </div>
        ) : (
          <>
            {/* Report Header */}
            <div className="flex items-start justify-between mb-4">
              <div>
                <h2 className={`text-xl font-bold ${tc.text} flex items-center gap-2`}>
                  <span className="text-2xl">{currentReport?.icon}</span>
                  {currentReport?.label}
                </h2>
                <p className={`${tc.textMuted} text-sm`}>
                  {currentReport?.description} ‚Ä¢ {selectedSeason?.name}
                </p>
              </div>
              
              <div className="flex items-center gap-2">
                {/* Column Picker */}
                <button
                  onClick={() => setShowColumnPicker(!showColumnPicker)}
                  className={`px-3 py-2 rounded-lg ${tc.cardBgAlt} ${tc.text} ${tc.hoverBg} text-sm font-medium flex items-center gap-2`}
                >
                  ‚öôÔ∏è Columns
                </button>
                
                {/* Filter Toggle */}
                <button
                  onClick={() => setShowFilters(!showFilters)}
                  className={`px-3 py-2 rounded-lg ${tc.cardBgAlt} ${tc.text} ${tc.hoverBg} text-sm font-medium flex items-center gap-2`}
                >
                  üîç Filters
                  {(filters.team !== 'all' || filters.status !== 'all' || filters.search) && (
                    <span className="w-2 h-2 rounded-full bg-[var(--accent-primary)]" />
                  )}
                </button>
                
                {/* Export */}
                <div className="relative">
                  <button
                    onClick={() => setShowExportMenu(!showExportMenu)}
                    disabled={loading || data.length === 0}
                    className="px-4 py-2 rounded-lg bg-[var(--accent-primary)] text-white font-medium text-sm flex items-center gap-2 disabled:opacity-50"
                  >
                    üì§ Export ‚ñº
                  </button>
                  
                  {showExportMenu && (
                    <>
                      <div className="fixed inset-0 z-40" onClick={() => setShowExportMenu(false)} />
                      <div className={`absolute right-0 top-full mt-2 w-48 ${tc.cardBg} border ${tc.border} rounded-xl shadow-xl z-50 overflow-hidden`}>
                        {[
                          { id: 'csv', label: 'Download CSV', icon: 'bar-chart', action: exportCSV },
                          { id: 'pdf', label: 'Download PDF', icon: 'file-text', action: exportPDF },
                          { id: 'print', label: 'Print', icon: 'üñ®Ô∏è', action: printReport },
                          { id: 'email', label: 'Email', icon: 'üìß', action: emailReport },
                        ].map(opt => (
                          <button
                            key={opt.id}
                            onClick={opt.action}
                            disabled={exporting}
                            className={`w-full text-left px-4 py-2.5 ${tc.hoverBg} ${tc.text} flex items-center gap-2 text-sm`}
                          >
                            <span>{opt.icon}</span>
                            <span>{opt.label}</span>
                          </button>
                        ))}
                      </div>
                    </>
                  )}
                </div>
              </div>
            </div>
            
            {/* Stats Bar */}
            {stats.labels && (
              <div className="grid grid-cols-4 gap-4 mb-4">
                {stats.labels.map((label, i) => {
                  const keys = Object.keys(stats).filter(k => k !== 'labels')
                  const value = stats[keys[i]]
                  const isMonetary = ['totalRevenue', 'collected', 'outstanding', 'totalExpected', 'totalOutstanding', 'avgBalance'].includes(keys[i])
                  
                  return (
                    <div key={label} className={`${tc.cardBg} border ${tc.border} rounded-xl p-4`}>
                      <p className={`text-2xl font-bold ${tc.text}`}>
                        {isMonetary ? `$${Number(value).toLocaleString()}` : 
                         keys[i].includes('Rate') ? `${value}%` : 
                         value}
                      </p>
                      <p className={`text-xs ${tc.textMuted} uppercase tracking-wider mt-1`}>{label}</p>
                    </div>
                  )
                })}
              </div>
            )}
            
            {/* Column Picker Panel */}
            {showColumnPicker && (
              <div className={`${tc.cardBg} border ${tc.border} rounded-xl p-4 mb-4`}>
                <div className="flex items-center justify-between mb-3">
                  <p className={`font-semibold ${tc.text}`}>Customize Columns</p>
                  <button
                    onClick={() => {
                      const defaultVisible = {}
                      allColumns.forEach(col => { defaultVisible[col.id] = col.defaultVisible !== false })
                      setVisibleColumns(defaultVisible)
                    }}
                    className={`text-sm ${tc.textMuted} hover:text-[var(--accent-primary)]`}
                  >
                    Reset to Default
                  </button>
                </div>
                <div className="flex flex-wrap gap-2">
                  {allColumns.map(col => (
                    <label
                      key={col.id}
                      className={`flex items-center gap-2 px-3 py-2 rounded-lg cursor-pointer transition ${
                        visibleColumns[col.id] 
                          ? 'bg-[var(--accent-primary)]/20 text-[var(--accent-primary)]' 
                          : `${tc.cardBgAlt} ${tc.textMuted}`
                      }`}
                    >
                      <input
                        type="checkbox"
                        checked={visibleColumns[col.id] || false}
                        onChange={e => setVisibleColumns({ ...visibleColumns, [col.id]: e.target.checked })}
                        className="sr-only"
                      />
                      <span className="text-sm">{visibleColumns[col.id] ? '‚úì' : '‚óã'}</span>
                      <span className="text-sm font-medium">{col.label}</span>
                    </label>
                  ))}
                </div>
              </div>
            )}
            
            {/* Filters Panel */}
            {showFilters && (
              <div className={`${tc.cardBg} border ${tc.border} rounded-xl p-4 mb-4`}>
                <div className="flex flex-wrap gap-4">
                  <div className="flex-1 min-w-[200px]">
                    <label className={`block text-xs ${tc.textMuted} mb-1`}>Search</label>
                    <input
                      type="text"
                      value={filters.search}
                      onChange={e => setFilters({ ...filters, search: e.target.value })}
                      placeholder="Search..."
                      className={`w-full ${tc.input} rounded-lg px-3 py-2 text-sm`}
                    />
                  </div>
                  
                  {['players', 'jerseys'].includes(activeReport) && teams.length > 0 && (
                    <div className="min-w-[160px]">
                      <label className={`block text-xs ${tc.textMuted} mb-1`}>Team</label>
                      <select
                        value={filters.team}
                        onChange={e => setFilters({ ...filters, team: e.target.value })}
                        className={`w-full ${tc.input} rounded-lg px-3 py-2 text-sm`}
                      >
                        <option value="all">All Teams</option>
                        {teams.map(t => (
                          <option key={t.id} value={t.id}>{t.name}</option>
                        ))}
                      </select>
                    </div>
                  )}
                  
                  {statusOptions.length > 0 && (
                    <div className="min-w-[140px]">
                      <label className={`block text-xs ${tc.textMuted} mb-1`}>Status</label>
                      <select
                        value={filters.status}
                        onChange={e => setFilters({ ...filters, status: e.target.value })}
                        className={`w-full ${tc.input} rounded-lg px-3 py-2 text-sm`}
                      >
                        {statusOptions.map(s => (
                          <option key={s.value} value={s.value}>{s.label}</option>
                        ))}
                      </select>
                    </div>
                  )}
                  
                  {activeReport === 'financial' && (
                    <>
                      <div className="min-w-[140px]">
                        <label className={`block text-xs ${tc.textMuted} mb-1`}>From Date</label>
                        <input
                          type="date"
                          value={filters.dateFrom}
                          onChange={e => setFilters({ ...filters, dateFrom: e.target.value })}
                          className={`w-full ${tc.input} rounded-lg px-3 py-2 text-sm`}
                        />
                      </div>
                      <div className="min-w-[140px]">
                        <label className={`block text-xs ${tc.textMuted} mb-1`}>To Date</label>
                        <input
                          type="date"
                          value={filters.dateTo}
                          onChange={e => setFilters({ ...filters, dateTo: e.target.value })}
                          className={`w-full ${tc.input} rounded-lg px-3 py-2 text-sm`}
                        />
                      </div>
                    </>
                  )}
                  
                  <div className="flex items-end">
                    <button
                      onClick={() => setFilters({ team: 'all', status: 'all', dateFrom: '', dateTo: '', search: '' })}
                      className={`px-4 py-2 rounded-lg ${tc.hoverBg} ${tc.textMuted} text-sm`}
                    >
                      Clear
                    </button>
                  </div>
                </div>
              </div>
            )}
            
            {/* Data Table */}
            <div className={`flex-1 ${tc.cardBg} border ${tc.border} rounded-xl overflow-hidden flex flex-col min-h-0`}>
              {loading ? (
                <div className="flex-1 flex items-center justify-center">
                  <div className="text-center">
                    <div className="w-8 h-8 border-2 border-[var(--accent-primary)] border-t-transparent rounded-full animate-spin mx-auto" />
                    <p className={`${tc.textMuted} mt-3`}>Loading report...</p>
                  </div>
                </div>
              ) : data.length === 0 ? (
                <div className="flex-1 flex items-center justify-center">
                  <div className="text-center">
                    <span className="text-5xl">üì≠</span>
                    <p className={`${tc.text} font-medium mt-4`}>No data found</p>
                    <p className={`${tc.textMuted} text-sm mt-1`}>Try adjusting your filters or selecting a different season</p>
                  </div>
                </div>
              ) : (
                <>
                  {/* Table */}
                  <div className="flex-1 overflow-auto">
                    <table className="w-full">
                      <thead className={`${tc.cardBgAlt} sticky top-0`}>
                        <tr>
                          {columns.map(col => (
                            <th
                              key={col.id}
                              onClick={() => col.sortable && handleSort(col.id)}
                              className={`px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider ${tc.textMuted} ${
                                col.sortable ? 'cursor-pointer hover:bg-black/5' : ''
                              } whitespace-nowrap`}
                            >
                              {col.label}
                              {col.sortable && sortField === col.id && (
                                <span className="ml-1">{sortDir === 'asc' ? '‚Üë' : '‚Üì'}</span>
                              )}
                            </th>
                          ))}
                        </tr>
                      </thead>
                      <tbody>
                        {sortedData.map((row, i) => (
                          <tr key={row.id || i} className={`border-b ${tc.border} ${tc.hoverBg} transition`}>
                            {columns.map(col => (
                              <td key={col.id} className={`px-4 py-3 text-sm ${tc.text}`}>
                                {col.id === 'team_name' && row.team_color ? (
                                  <span className="flex items-center gap-2">
                                    <span className="w-3 h-3 rounded-full flex-shrink-0" style={{ backgroundColor: row.team_color }} />
                                    {row[col.id]}
                                  </span>
                                ) : ['payment_status', 'status', 'reg_status', 'roster_status', 'bg_check_status'].includes(col.id) ? (
                                  <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                                    ['Paid', 'active', 'approved', 'Ready', 'cleared', 'Active'].includes(row[col.id]) 
                                      ? 'bg-emerald-500/20 text-emerald-500' 
                                      : ['Unpaid', 'denied', 'Need Players', 'failed'].includes(row[col.id])
                                      ? 'bg-red-500/20 text-red-500'
                                      : 'bg-amber-500/20 text-amber-500'
                                  }`}>
                                    {row[col.id]}
                                  </span>
                                ) : col.id === 'attendance_rate' || col.id === 'roster_fill' ? (
                                  <div className="flex items-center gap-2">
                                    <div className={`w-16 h-2 rounded-full ${isDark ? 'bg-slate-700' : 'bg-slate-200'} overflow-hidden`}>
                                      <div 
                                        className={`h-full rounded-full ${
                                          row[col.id] >= 80 ? 'bg-emerald-500' : row[col.id] >= 50 ? 'bg-amber-500' : 'bg-red-500'
                                        }`}
                                        style={{ width: `${Math.min(row[col.id], 100)}%` }}
                                      />
                                    </div>
                                    <span>{row[col.id]}%</span>
                                  </div>
                                ) : (
                                  formatValue(row[col.id], col.format)
                                )}
                              </td>
                            ))}
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                  
                  {/* Table Footer */}
                  <div className={`px-4 py-3 border-t ${tc.border} ${tc.cardBgAlt} flex items-center justify-between flex-shrink-0`}>
                    <p className={`text-sm ${tc.textMuted}`}>
                      Showing {sortedData.length} records ‚Ä¢ {columns.length} columns
                    </p>
                    <p className={`text-xs ${tc.textMuted}`}>
                      {organization?.name} ‚Ä¢ {selectedSeason?.name}
                    </p>
                  </div>
                </>
              )}
            </div>
          </>
        )}
      </div>
      
      {/* Save Preset Modal */}
      {showPresetModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
          <div className={`${tc.cardBg} rounded-2xl p-6 w-full max-w-md`}>
            <h3 className={`text-lg font-bold ${tc.text} mb-4`}>Save Report Preset</h3>
            <p className={`text-sm ${tc.textMuted} mb-4`}>
              Save your current view (report type, visible columns, filters) as a preset for quick access later.
            </p>
            <input
              type="text"
              value={presetName}
              onChange={e => setPresetName(e.target.value)}
              placeholder="Preset name (e.g., 'Contact List for Coaches')"
              className={`w-full ${tc.input} rounded-lg px-4 py-3 mb-4`}
              autoFocus
            />
            <div className="flex justify-end gap-3">
              <button
                onClick={() => { setShowPresetModal(false); setPresetName('') }}
                className={`px-4 py-2 rounded-lg ${tc.cardBgAlt} ${tc.text}`}
              >
                Cancel
              </button>
              <button
                onClick={savePreset}
                disabled={!presetName.trim()}
                className="px-4 py-2 rounded-lg bg-[var(--accent-primary)] text-white font-medium disabled:opacity-50"
              >
                Save Preset
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  )
}

// ============================================
// PAYMENT SETUP PAGE
// ============================================
function PaymentSetupPage({ showToast }) {
  const { organization, setOrganization } = useAuth()
  const [settings, setSettings] = useState({ venmoHandle: '', zelleEmail: '', cashappHandle: '', acceptManualPayments: true })
  const [saving, setSaving] = useState(false)

  useEffect(() => {
    if (organization?.settings?.payments) setSettings({ ...settings, ...organization.settings.payments })
  }, [organization])

  async function handleSave() {
    setSaving(true)
    const newSettings = { ...organization.settings, payments: settings }
    await supabase.from('organizations').update({ settings: newSettings }).eq('id', organization.id)
    setOrganization({ ...organization, settings: newSettings })
    showToast('Payment settings saved!', 'success')
    setSaving(false)
  }

  return (
    <div className="space-y-6 max-w-3xl">
      <div className="flex items-start justify-between">
        <div>
          <h1 className="text-3xl font-bold text-white">Payment Setup</h1>
          <p className="text-slate-400 mt-1">Configure payment methods</p>
        </div>
        <button onClick={handleSave} disabled={saving} className="bg-[var(--accent-primary)] text-white font-semibold px-6 py-3 rounded-xl disabled:opacity-50">
          {saving ? 'Saving...' : 'üíæ Save'}
        </button>
      </div>

      <div className="bg-slate-800 border border-slate-700 rounded-2xl p-6 space-y-4">
        <h2 className="text-lg font-semibold text-white">Manual Payment Methods</h2>
        {[
          { key: 'venmoHandle', label: 'Venmo', placeholder: '@YourVenmo', color: '#3D95CE' },
          { key: 'zelleEmail', label: 'Zelle', placeholder: 'email@example.com', color: '#6D1ED4' },
          { key: 'cashappHandle', label: 'Cash App', placeholder: '$YourCashApp', color: '#00D632' },
        ].map(p => (
          <div key={p.key} className="p-4 bg-slate-900 rounded-xl">
            <div className="flex items-center gap-2 mb-2">
              <div className="w-8 h-8 rounded-lg flex items-center justify-center text-sm font-bold" style={{ backgroundColor: p.color + '30', color: p.color }}>
                {p.label[0]}
              </div>
              <span className="text-white font-medium">{p.label}</span>
            </div>
            <input type="text" value={settings[p.key]} onChange={e => setSettings({...settings, [p.key]: e.target.value})} placeholder={p.placeholder}
              className="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-white" />
          </div>
        ))}
      </div>

      <div className="bg-slate-800 border border-slate-700 rounded-2xl p-6">
        <label className="flex items-center justify-between cursor-pointer">
          <div>
            <p className="font-medium text-white">Accept Manual Payments</p>
            <p className="text-sm text-slate-400">Show these options during registration</p>
          </div>
          <input type="checkbox" checked={settings.acceptManualPayments} onChange={e => setSettings({...settings, acceptManualPayments: e.target.checked})}
            className="w-6 h-6 rounded" />
        </label>
      </div>
    </div>
  )
}

// ============================================
// ORGANIZATION PAGE
// ============================================
// ============================================
// ORGANIZATION SETUP HUB
// Comprehensive setup wizard for new organizations
// ============================================

function OrganizationPage({ showToast }) {
  const { organization, setOrganization } = useAuth()
  const tc = useThemeClasses()
  const { accent } = useTheme()
  const journey = useJourney()
  
  // Track which sections are expanded
  const [expandedSection, setExpandedSection] = useState(null)
  const [saving, setSaving] = useState(false)
  const [setupData, setSetupData] = useState(null)
  const [loading, setLoading] = useState(true)
  const [waivers, setWaivers] = useState([])
  const [venues, setVenues] = useState([])
  const [adminUsers, setAdminUsers] = useState([])

  // Load all setup data on mount
  useEffect(() => {
    if (organization?.id) loadSetupData()
  }, [organization?.id])

  async function loadSetupData() {
    setLoading(true)
    try {
      // Load waivers
      const { data: waiverData } = await supabase
        .from('waivers')
        .select('*')
        .eq('organization_id', organization.id)
      setWaivers(waiverData || [])

      // Load venues
      const { data: venueData } = await supabase
        .from('venues')
        .select('*')
        .eq('organization_id', organization.id)
      setVenues(venueData || [])

      // Load admin users
      const { data: userData } = await supabase
        .from('user_roles')
        .select('*, profiles(id, full_name, email)')
        .eq('organization_id', organization.id)
        .in('role', ['league_admin', 'admin', 'assistant_admin', 'registrar', 'treasurer'])
      setAdminUsers(userData || [])

      // Build setup data from organization settings
      const settings = organization.settings || {}
      setSetupData({
        // Identity
        name: organization.name || '',
        shortName: settings.short_name || '',
        tagline: settings.tagline || '',
        logoUrl: organization.logo_url || '',
        primaryColor: settings.primary_color || accent.primary,
        secondaryColor: settings.secondary_color || '',
        orgType: settings.org_type || 'club',
        foundedYear: settings.founded_year || '',
        mission: settings.mission || '',
        
        // Contact
        contactName: settings.contact_name || '',
        contactTitle: settings.contact_title || '',
        email: organization.contact_email || '',
        secondaryEmail: settings.secondary_email || '',
        phone: settings.phone || '',
        secondaryPhone: settings.secondary_phone || '',
        address: settings.address || '',
        city: settings.city || '',
        state: settings.state || '',
        zip: settings.zip || '',
        timezone: settings.timezone || 'America/Chicago',
        officeHours: settings.office_hours || '',
        
        // Online Presence
        website: settings.website || '',
        facebook: settings.facebook || '',
        instagram: settings.instagram || '',
        twitter: settings.twitter || '',
        registrationSlug: organization.slug || '',
        
        // Sports & Programs
        enabledSports: settings.enabled_sports || ['volleyball'],
        programTypes: settings.program_types || ['league'],
        ageSystem: settings.age_system || 'grade', // 'grade' or 'age'
        ageCutoffDate: settings.age_cutoff_date || '08-01', // MM-DD
        skillLevels: settings.skill_levels || ['recreational', 'competitive'],
        genderOptions: settings.gender_options || ['girls', 'boys', 'coed'],
        
        // Legal
        legalName: settings.legal_name || '',
        entityType: settings.entity_type || '',
        ein: settings.ein || '',
        insuranceProvider: settings.insurance_provider || '',
        insurancePolicyNumber: settings.insurance_policy_number || '',
        insuranceExpiration: settings.insurance_expiration || '',
        
        // Payment Settings
        paymentMethods: settings.payment_methods || {},
        allowPaymentPlans: settings.allow_payment_plans || false,
        paymentPlanInstallments: settings.payment_plan_installments || 3,
        lateFeeAmount: settings.late_fee_amount || 15,
        gracePeriodDays: settings.grace_period_days || 7,
        
        // Fee Defaults
        defaultRegistrationFee: settings.default_registration_fee || 150,
        defaultUniformFee: settings.default_uniform_fee || 45,
        defaultMonthlyFee: settings.default_monthly_fee || 50,
        earlyBirdDiscount: settings.early_bird_discount || 25,
        siblingDiscount: settings.sibling_discount || 10,
        multiSportDiscount: settings.multi_sport_discount || 15,
        
        // Registration Settings
        autoApproveRegistrations: settings.auto_approve_registrations ?? false,
        requirePaymentToComplete: settings.require_payment_to_complete ?? false,
        allowWaitlist: settings.allow_waitlist ?? true,
        maxPlayersPerRegistration: settings.max_players_per_registration || 5,
        
        // Registration Form Fields
        registrationFields: settings.registration_fields || {
          player: {
            first_name: { visible: true, required: true, label: 'First Name' },
            last_name: { visible: true, required: true, label: 'Last Name' },
            dob: { visible: true, required: true, label: 'Date of Birth' },
            gender: { visible: true, required: true, label: 'Gender' },
            grade: { visible: true, required: true, label: 'Grade' },
            school: { visible: true, required: false, label: 'School' },
            jersey_size: { visible: true, required: true, label: 'Jersey Size' },
            shorts_size: { visible: true, required: false, label: 'Shorts Size' },
            jersey_pref_1: { visible: true, required: false, label: 'Jersey Preference 1' },
            jersey_pref_2: { visible: true, required: false, label: 'Jersey Preference 2' },
            jersey_pref_3: { visible: true, required: false, label: 'Jersey Preference 3' },
            position_preference: { visible: false, required: false, label: 'Position Preference' },
            years_experience: { visible: false, required: false, label: 'Years of Experience' },
            previous_team: { visible: false, required: false, label: 'Previous Team/Club' },
            photo: { visible: false, required: false, label: 'Player Photo' },
          },
          parent: {
            parent1_name: { visible: true, required: true, label: 'Parent/Guardian 1 Name' },
            parent1_email: { visible: true, required: true, label: 'Parent/Guardian 1 Email' },
            parent1_phone: { visible: true, required: true, label: 'Parent/Guardian 1 Phone' },
            parent1_relation: { visible: false, required: false, label: 'Relationship to Player' },
            parent2_name: { visible: true, required: false, label: 'Parent/Guardian 2 Name' },
            parent2_email: { visible: true, required: false, label: 'Parent/Guardian 2 Email' },
            parent2_phone: { visible: true, required: false, label: 'Parent/Guardian 2 Phone' },
            address: { visible: true, required: false, label: 'Home Address' },
            city: { visible: true, required: false, label: 'City' },
            state: { visible: true, required: false, label: 'State' },
            zip: { visible: true, required: false, label: 'ZIP Code' },
          },
          emergency: {
            name: { visible: true, required: true, label: 'Emergency Contact Name' },
            phone: { visible: true, required: true, label: 'Emergency Contact Phone' },
            relation: { visible: true, required: true, label: 'Relationship' },
            authorized_pickup: { visible: true, required: false, label: 'Authorized for Pickup' },
          },
          medical: {
            allergies: { visible: true, required: false, label: 'Allergies' },
            medical_conditions: { visible: true, required: false, label: 'Medical Conditions' },
            medications: { visible: true, required: false, label: 'Current Medications' },
            insurance_provider: { visible: false, required: false, label: 'Insurance Provider' },
            insurance_policy: { visible: false, required: false, label: 'Policy Number' },
            physician_name: { visible: false, required: false, label: 'Physician Name' },
            physician_phone: { visible: false, required: false, label: 'Physician Phone' },
          },
        },
        customQuestions: settings.custom_questions || [],
        selectedWaivers: settings.selected_waivers || [],
        
        // Jersey Settings
        jerseyVendor: settings.jersey_vendor || '',
        jerseyLeadTime: settings.jersey_lead_time || 3,
        jerseyNumberStart: settings.jersey_number_start || 1,
        jerseyNumberEnd: settings.jersey_number_end || 99,
        restrictedNumbers: settings.restricted_numbers || [],
        
        // Notification Settings
        gameReminderHours: settings.game_reminder_hours || 24,
        practiceReminderHours: settings.practice_reminder_hours || 24,
        paymentReminderDays: settings.payment_reminder_days || 7,
        
        // Coach Requirements
        requireBackgroundCheck: settings.require_background_check ?? true,
        requireSafeSport: settings.require_safesport ?? false,
        requireCPR: settings.require_cpr ?? false,
        coachMinAge: settings.coach_min_age || 18,
        
        // Volunteer Settings
        requireVolunteerHours: settings.require_volunteer_hours ?? false,
        volunteerHoursRequired: settings.volunteer_hours_required || 4,
        volunteerBuyoutAmount: settings.volunteer_buyout_amount || 100,
      })
    } catch (err) {
      console.error('Error loading setup data:', err)
    }
    setLoading(false)
  }

  // Save a section's data
  async function saveSection(sectionKey, data) {
    setSaving(true)
    try {
      const currentSettings = organization.settings || {}
      let updatePayload = {}

      // Handle different section saves
      switch (sectionKey) {
        case 'identity':
          updatePayload = {
            name: data.name,
            logo_url: data.logoUrl,
            settings: {
              ...currentSettings,
              short_name: data.shortName,
              tagline: data.tagline,
              primary_color: data.primaryColor,
              secondary_color: data.secondaryColor,
              org_type: data.orgType,
              founded_year: data.foundedYear,
              mission: data.mission,
            }
          }
          break
        case 'contact':
          updatePayload = {
            contact_email: data.email,
            settings: {
              ...currentSettings,
              contact_name: data.contactName,
              contact_title: data.contactTitle,
              secondary_email: data.secondaryEmail,
              phone: data.phone,
              secondary_phone: data.secondaryPhone,
              address: data.address,
              city: data.city,
              state: data.state,
              zip: data.zip,
              timezone: data.timezone,
              office_hours: data.officeHours,
            }
          }
          break
        case 'online':
          updatePayload = {
            settings: {
              ...currentSettings,
              website: data.website,
              facebook: data.facebook,
              instagram: data.instagram,
              twitter: data.twitter,
            }
          }
          break
        case 'sports':
          updatePayload = {
            settings: {
              ...currentSettings,
              enabled_sports: data.enabledSports,
              program_types: data.programTypes,
              age_system: data.ageSystem,
              age_cutoff_date: data.ageCutoffDate,
              skill_levels: data.skillLevels,
              gender_options: data.genderOptions,
            }
          }
          break
        case 'legal':
          updatePayload = {
            settings: {
              ...currentSettings,
              legal_name: data.legalName,
              entity_type: data.entityType,
              ein: data.ein,
              insurance_provider: data.insuranceProvider,
              insurance_policy_number: data.insurancePolicyNumber,
              insurance_expiration: data.insuranceExpiration,
            }
          }
          break
        case 'payments':
          updatePayload = {
            settings: {
              ...currentSettings,
              payment_methods: data.paymentMethods,
              allow_payment_plans: data.allowPaymentPlans,
              payment_plan_installments: data.paymentPlanInstallments,
              late_fee_amount: data.lateFeeAmount,
              grace_period_days: data.gracePeriodDays,
            }
          }
          break
        case 'fees':
          updatePayload = {
            settings: {
              ...currentSettings,
              default_registration_fee: data.defaultRegistrationFee,
              default_uniform_fee: data.defaultUniformFee,
              default_monthly_fee: data.defaultMonthlyFee,
              early_bird_discount: data.earlyBirdDiscount,
              sibling_discount: data.siblingDiscount,
              multi_sport_discount: data.multiSportDiscount,
            }
          }
          break
        case 'registration':
          updatePayload = {
            settings: {
              ...currentSettings,
              auto_approve_registrations: data.autoApproveRegistrations,
              require_payment_to_complete: data.requirePaymentToComplete,
              allow_waitlist: data.allowWaitlist,
              max_players_per_registration: data.maxPlayersPerRegistration,
            }
          }
          break
        case 'registrationForm':
          updatePayload = {
            settings: {
              ...currentSettings,
              registration_fields: data.registrationFields,
              custom_questions: data.customQuestions,
              selected_waivers: data.selectedWaivers,
            }
          }
          break
        case 'jerseys':
          updatePayload = {
            settings: {
              ...currentSettings,
              jersey_vendor: data.jerseyVendor,
              jersey_lead_time: data.jerseyLeadTime,
              jersey_number_start: data.jerseyNumberStart,
              jersey_number_end: data.jerseyNumberEnd,
              restricted_numbers: data.restrictedNumbers,
            }
          }
          break
        case 'notifications':
          updatePayload = {
            settings: {
              ...currentSettings,
              email_notifications_enabled: data.emailNotificationsEnabled ?? true,
              email_on_registration: data.emailOnRegistration ?? true,
              email_on_approval: data.emailOnApproval ?? true,
              email_on_waitlist: data.emailOnWaitlist ?? true,
              email_on_team_assignment: data.emailOnTeamAssignment ?? true,
              email_on_payment_due: data.emailOnPaymentDue ?? true,
              game_reminder_hours: data.gameReminderHours,
              practice_reminder_hours: data.practiceReminderHours,
              payment_reminder_days: data.paymentReminderDays,
            }
          }
          break
        case 'coaches':
          updatePayload = {
            settings: {
              ...currentSettings,
              require_background_check: data.requireBackgroundCheck,
              require_safesport: data.requireSafeSport,
              require_cpr: data.requireCPR,
              coach_min_age: data.coachMinAge,
            }
          }
          break
        case 'volunteers':
          updatePayload = {
            settings: {
              ...currentSettings,
              require_volunteer_hours: data.requireVolunteerHours,
              volunteer_hours_required: data.volunteerHoursRequired,
              volunteer_buyout_amount: data.volunteerBuyoutAmount,
            }
          }
          break
        default:
          updatePayload = { settings: { ...currentSettings, ...data } }
      }

      await supabase.from('organizations').update(updatePayload).eq('id', organization.id)
      
      // Update local state
      setOrganization({ ...organization, ...updatePayload, settings: { ...currentSettings, ...updatePayload.settings } })
      setSetupData(prev => ({ ...prev, ...data }))
      
      showToast('Saved!', 'success')
    } catch (err) {
      console.error('Save error:', err)
      showToast('Error saving', 'error')
    }
    setSaving(false)
  }

  // Calculate section completion status
  function getSectionStatus(sectionKey) {
    if (!setupData) return { status: 'loading', progress: 0, total: 1 }
    
    const checks = {
      identity: [
        setupData.name,
        setupData.shortName,
        setupData.logoUrl,
        setupData.primaryColor,
      ],
      contact: [
        setupData.contactName,
        setupData.email,
        setupData.phone,
        setupData.city,
        setupData.state,
      ],
      sports: [
        (setupData.enabledSports || []).length > 0,
      ],
      online: [
        setupData.website || setupData.facebook || setupData.instagram,
      ],
      legal: [
        setupData.legalName || setupData.name,
        waivers.length >= 3,
      ],
      payments: [
        Object.values(setupData.paymentMethods || {}).some(m => m?.enabled),
      ],
      fees: [
        setupData.defaultRegistrationFee > 0,
      ],
      facilities: [
        venues.length > 0,
      ],
      staff: [
        adminUsers.length > 0,
      ],
      coaches: [
        true, // Settings are optional
      ],
      registration: [
        true, // Has defaults
      ],
      registrationForm: [
        (setupData.registrationFields?.player?.first_name?.visible),
        (setupData.registrationFields?.parent?.parent1_name?.visible),
      ],
      jerseys: [
        true, // Has defaults
      ],
      notifications: [
        true, // Has defaults
      ],
      volunteers: [
        true, // Optional
      ],
    }

    const sectionChecks = checks[sectionKey] || []
    const completed = sectionChecks.filter(Boolean).length
    const total = sectionChecks.length

    if (completed === 0) return { status: 'not_started', progress: 0, total }
    if (completed < total) return { status: 'partial', progress: completed, total }
    return { status: 'complete', progress: completed, total }
  }

  // Section definitions with metadata
  const sections = [
    {
      key: 'identity',
      title: 'Identity & Branding',
      icon: 'üé®',
      estTime: '3-5 min',
      description: 'Organization name, logo, and brand colors',
      required: true,
      category: 'foundation',
    },
    {
      key: 'contact',
      title: 'Contact Information',
      icon: 'üìû',
      estTime: '2-3 min',
      description: 'Email, phone, and address details',
      required: true,
      category: 'foundation',
    },
    {
      key: 'sports',
      title: 'Sports & Programs',
      icon: 'volleyball',
      estTime: '2-3 min',
      description: 'Configure which sports and program types you offer',
      required: true,
      category: 'foundation',
    },
    {
      key: 'online',
      title: 'Online Presence',
      icon: 'üåê',
      estTime: '1-2 min',
      description: 'Website and social media links',
      required: false,
      category: 'foundation',
    },
    {
      key: 'legal',
      title: 'Legal & Waivers',
      icon: '‚öñÔ∏è',
      estTime: '10-15 min',
      description: 'Waivers, insurance, and compliance',
      required: true,
      category: 'foundation',
    },
    {
      key: 'payments',
      title: 'Payment Methods',
      icon: 'credit-card',
      estTime: '3-5 min',
      description: 'Configure how you accept payments',
      required: true,
      category: 'operational',
    },
    {
      key: 'fees',
      title: 'Fee Structure',
      icon: 'dollar',
      estTime: '3-5 min',
      description: 'Default fees and discounts',
      required: true,
      category: 'operational',
    },
    {
      key: 'facilities',
      title: 'Facilities & Venues',
      icon: 'üìç',
      estTime: '5-10 min',
      description: 'Where you practice and play',
      required: true,
      category: 'operational',
    },
    {
      key: 'staff',
      title: 'Staff & Permissions',
      icon: 'users',
      estTime: '5-10 min',
      description: 'Admin users and their roles',
      required: false,
      category: 'operational',
    },
    {
      key: 'coaches',
      title: 'Coach Requirements',
      icon: 'user-cog',
      estTime: '2-3 min',
      description: 'Background checks and certifications',
      required: false,
      category: 'operational',
    },
    {
      key: 'registration',
      title: 'Registration Settings',
      icon: 'settings',
      estTime: '2-3 min',
      description: 'Auto-approve, waitlist, and payment settings',
      required: false,
      category: 'configuration',
    },
    {
      key: 'registrationForm',
      title: 'Registration Form Builder',
      icon: 'clipboard',
      estTime: '10-15 min',
      description: 'Customize what info you collect from families',
      required: true,
      category: 'configuration',
    },
    {
      key: 'jerseys',
      title: 'Jersey Configuration',
      icon: 'shirt',
      estTime: '2-3 min',
      description: 'Uniform and number settings',
      required: false,
      category: 'configuration',
    },
    {
      key: 'notifications',
      title: 'Notification Settings',
      icon: 'üîî',
      estTime: '2-3 min',
      description: 'Reminder timing defaults',
      required: false,
      category: 'configuration',
    },
    {
      key: 'volunteers',
      title: 'Volunteer Requirements',
      icon: 'ü§ù',
      estTime: '2-3 min',
      description: 'Volunteer hours and buyout',
      required: false,
      category: 'configuration',
    },
  ]

  // Calculate overall progress
  const overallProgress = sections.reduce((acc, section) => {
    const status = getSectionStatus(section.key)
    if (status.status === 'complete') return acc + 1
    if (status.status === 'partial') return acc + 0.5
    return acc
  }, 0)
  const overallPercent = Math.round((overallProgress / sections.length) * 100)

  // Group sections by category
  const foundationSections = sections.filter(s => s.category === 'foundation')
  const operationalSections = sections.filter(s => s.category === 'operational')
  const configSections = sections.filter(s => s.category === 'configuration')

  if (loading) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="flex flex-col items-center gap-3">
          <div className="w-8 h-8 border-2 border-t-transparent rounded-full animate-spin" style={{ borderColor: accent.primary, borderTopColor: 'transparent' }}></div>
          <span className={tc.textSecondary}>Loading organization setup...</span>
        </div>
      </div>
    )
  }

  return (
    <div className="space-y-6 max-w-4xl">
      {/* Header */}
      <div>
        <h1 className={`text-3xl font-bold ${tc.text}`}>Organization Setup</h1>
        <p className={`${tc.textMuted} mt-1`}>Configure your organization before creating seasons and opening registration</p>
      </div>

      {/* Overall Progress Card */}
      <div className={`p-6 rounded-2xl border ${tc.card}`}>
        <div className="flex items-center justify-between mb-4">
          <div className="flex items-center gap-3">
            <div className="w-12 h-12 rounded-xl flex items-center justify-center text-2xl" style={{ backgroundColor: accent.primary + '20' }}>
              üè¢
            </div>
            <div>
              <h2 className={`text-lg font-semibold ${tc.text}`}>{organization?.name || 'Your Organization'}</h2>
              <p className={tc.textMuted}>Setup Progress</p>
            </div>
          </div>
          <div className="text-right">
            <p className="text-3xl font-bold" style={{ color: accent.primary }}>{overallPercent}%</p>
            <p className={`text-sm ${tc.textMuted}`}>{Math.round(overallProgress)} of {sections.length} sections</p>
          </div>
        </div>
        <div className={`h-3 rounded-full ${tc.cardBgAlt}`}>
          <div 
            className="h-full rounded-full transition-all duration-500" 
            style={{ width: `${overallPercent}%`, backgroundColor: accent.primary }}
          />
        </div>
        {overallPercent < 100 && (
          <p className={`text-sm ${tc.textMuted} mt-3`}>
            üí° Complete the <span className="font-medium" style={{ color: accent.primary }}>Foundation</span> sections first to unlock registration
          </p>
        )}
      </div>

      {/* Foundation Sections */}
      <div className="space-y-3">
        <div className="flex items-center gap-2 px-1">
          <span className="text-lg">üèóÔ∏è</span>
          <h3 className={`font-semibold ${tc.text}`}>Foundation</h3>
          <span className={`text-xs px-2 py-0.5 rounded-full ${tc.cardBgAlt} ${tc.textMuted}`}>Required before registration</span>
        </div>
        {foundationSections.map(section => (
          <SetupSectionCard 
            key={section.key}
            section={section}
            status={getSectionStatus(section.key)}
            expanded={expandedSection === section.key}
            onToggle={() => setExpandedSection(expandedSection === section.key ? null : section.key)}
            setupData={setupData}
            setSetupData={setSetupData}
            onSave={(data) => saveSection(section.key, data)}
            saving={saving}
            showToast={showToast}
            organization={organization}
            waivers={waivers}
            setWaivers={setWaivers}
            venues={venues}
            setVenues={setVenues}
            tc={tc}
            accent={accent}
          />
        ))}
      </div>

      {/* Operational Sections */}
      <div className="space-y-3">
        <div className="flex items-center gap-2 px-1">
          <span className="text-lg">‚ö°</span>
          <h3 className={`font-semibold ${tc.text}`}>Operational</h3>
          <span className={`text-xs px-2 py-0.5 rounded-full ${tc.cardBgAlt} ${tc.textMuted}`}>Required for day-to-day</span>
        </div>
        {operationalSections.map(section => (
          <SetupSectionCard 
            key={section.key}
            section={section}
            status={getSectionStatus(section.key)}
            expanded={expandedSection === section.key}
            onToggle={() => setExpandedSection(expandedSection === section.key ? null : section.key)}
            setupData={setupData}
            setSetupData={setSetupData}
            onSave={(data) => saveSection(section.key, data)}
            saving={saving}
            showToast={showToast}
            organization={organization}
            waivers={waivers}
            setWaivers={setWaivers}
            venues={venues}
            setVenues={setVenues}
            adminUsers={adminUsers}
            tc={tc}
            accent={accent}
          />
        ))}
      </div>

      {/* Configuration Sections */}
      <div className="space-y-3">
        <div className="flex items-center gap-2 px-1">
          <Settings className="w-5 h-5 text-slate-400" />
          <h3 className={`font-semibold ${tc.text}`}>Configuration</h3>
          <span className={`text-xs px-2 py-0.5 rounded-full ${tc.cardBgAlt} ${tc.textMuted}`}>Optional customization</span>
        </div>
        {configSections.map(section => (
          <SetupSectionCard 
            key={section.key}
            section={section}
            status={getSectionStatus(section.key)}
            expanded={expandedSection === section.key}
            onToggle={() => setExpandedSection(expandedSection === section.key ? null : section.key)}
            setupData={setupData}
            setSetupData={setSetupData}
            onSave={(data) => saveSection(section.key, data)}
            saving={saving}
            showToast={showToast}
            organization={organization}
            tc={tc}
            accent={accent}
          />
        ))}
      </div>
    </div>
  )
}

// ============================================
// SETUP SECTION CARD COMPONENT
// ============================================

function SetupSectionCard({ 
  section, 
  status, 
  expanded, 
  onToggle, 
  setupData, 
  setSetupData, 
  onSave, 
  saving,
  showToast,
  organization,
  waivers,
  setWaivers,
  venues,
  setVenues,
  adminUsers,
  tc, 
  accent 
}) {
  const statusConfig = {
    complete: { icon: 'check-square', color: 'text-emerald-500', bg: 'bg-emerald-500/10', label: 'Complete' },
    partial: { icon: '‚ö†Ô∏è', color: 'text-amber-500', bg: 'bg-amber-500/10', label: 'In Progress' },
    not_started: { icon: '‚¨ú', color: tc.textMuted, bg: tc.cardBgAlt, label: 'Not Started' },
    loading: { icon: '‚è≥', color: tc.textMuted, bg: tc.cardBgAlt, label: 'Loading' },
  }

  const config = statusConfig[status.status]

  return (
    <div className={`rounded-2xl border overflow-hidden transition-all ${tc.card} ${expanded ? 'ring-2' : ''}`} style={{ ringColor: expanded ? accent.primary : 'transparent' }}>
      {/* Section Header - Always visible */}
      <div 
        className={`p-4 cursor-pointer transition-colors ${tc.hoverBg}`}
        onClick={onToggle}
      >
        <div className="flex items-center gap-4">
          {/* Icon */}
          <div className={`w-12 h-12 rounded-xl flex items-center justify-center text-xl ${config.bg}`}>
            {section.icon}
          </div>

          {/* Title & Description */}
          <div className="flex-1 min-w-0">
            <div className="flex items-center gap-2">
              <h3 className={`font-semibold ${tc.text}`}>{section.title}</h3>
              {section.required && (
                <span className="text-xs px-1.5 py-0.5 rounded bg-red-500/20 text-red-400">Required</span>
              )}
            </div>
            <p className={`text-sm ${tc.textMuted} truncate`}>{section.description}</p>
          </div>

          {/* Est Time */}
          <div className={`text-right hidden sm:block`}>
            <p className={`text-xs ${tc.textMuted}`}>Est. time</p>
            <p className={`text-sm font-medium ${tc.textSecondary}`}>{section.estTime}</p>
          </div>

          {/* Status Badge */}
          <div className={`flex items-center gap-2 px-3 py-1.5 rounded-lg ${config.bg}`}>
            <span>{config.icon}</span>
            <span className={`text-sm font-medium ${config.color}`}>{config.label}</span>
          </div>

          {/* Expand Arrow */}
          <span className={`text-lg ${tc.textMuted} transition-transform ${expanded ? 'rotate-180' : ''}`}>
            ‚ñº
          </span>
        </div>
      </div>

      {/* Expanded Content */}
      {expanded && (
        <div className={`border-t ${tc.border} p-6`}>
          <SetupSectionContent 
            sectionKey={section.key}
            setupData={setupData}
            setSetupData={setSetupData}
            onSave={onSave}
            saving={saving}
            showToast={showToast}
            organization={organization}
            waivers={waivers}
            setWaivers={setWaivers}
            venues={venues}
            setVenues={setVenues}
            adminUsers={adminUsers}
            tc={tc}
            accent={accent}
          />
        </div>
      )}
    </div>
  )
}

// ============================================
// SETUP SECTION CONTENT - Renders each section's form
// ============================================

function SetupSectionContent({ 
  sectionKey, 
  setupData, 
  setSetupData, 
  onSave, 
  saving,
  showToast,
  organization,
  waivers,
  setWaivers,
  venues,
  setVenues,
  adminUsers,
  tc, 
  accent 
}) {
  // Local form state for this section
  const [localData, setLocalData] = useState({})
  const [hasChanges, setHasChanges] = useState(false)

  // Initialize local data when section opens
  useEffect(() => {
    if (setupData) {
      setLocalData({ ...setupData })
      setHasChanges(false)
    }
  }, [sectionKey, setupData])

  const updateField = (key, value) => {
    setLocalData(prev => ({ ...prev, [key]: value }))
    setHasChanges(true)
  }

  const handleSave = () => {
    onSave(localData)
    setHasChanges(false)
  }

  // Input component helper
  const Input = ({ label, field, type = 'text', placeholder = '', required = false, helpText = '' }) => (
    <div>
      <label className={`block text-sm font-medium ${tc.textSecondary} mb-1.5`}>
        {label} {required && <span className="text-red-400">*</span>}
      </label>
      <input
        type={type}
        value={localData[field] || ''}
        onChange={(e) => updateField(field, e.target.value)}
        placeholder={placeholder}
        className={`w-full px-4 py-2.5 rounded-xl border ${tc.input} focus:ring-2 focus:ring-offset-0 transition`}
        style={{ focusRing: accent.primary }}
      />
      {helpText && <p className={`text-xs ${tc.textMuted} mt-1`}>{helpText}</p>}
    </div>
  )

  const Toggle = ({ label, field, helpText = '' }) => (
    <div className="flex items-center justify-between py-2">
      <div>
        <p className={`font-medium ${tc.text}`}>{label}</p>
        {helpText && <p className={`text-sm ${tc.textMuted}`}>{helpText}</p>}
      </div>
      <button
        onClick={() => updateField(field, !localData[field])}
        className={`w-12 h-6 rounded-full transition-colors ${localData[field] ? '' : 'bg-slate-600'}`}
        style={{ backgroundColor: localData[field] ? accent.primary : undefined }}
      >
        <div className={`w-5 h-5 rounded-full bg-white shadow transition-transform ${localData[field] ? 'translate-x-6' : 'translate-x-0.5'}`} />
      </button>
    </div>
  )

  const Select = ({ label, field, options, required = false }) => (
    <div>
      <label className={`block text-sm font-medium ${tc.textSecondary} mb-1.5`}>
        {label} {required && <span className="text-red-400">*</span>}
      </label>
      <select
        value={localData[field] || ''}
        onChange={(e) => updateField(field, e.target.value)}
        className={`w-full px-4 py-2.5 rounded-xl border ${tc.input}`}
      >
        <option value="">Select...</option>
        {options.map(opt => (
          <option key={opt.value} value={opt.value}>{opt.label}</option>
        ))}
      </select>
    </div>
  )

  const NumberInput = ({ label, field, min = 0, max = 9999, prefix = '', suffix = '' }) => (
    <div>
      <label className={`block text-sm font-medium ${tc.textSecondary} mb-1.5`}>{label}</label>
      <div className="relative">
        {prefix && <span className={`absolute left-4 top-1/2 -translate-y-1/2 ${tc.textMuted}`}>{prefix}</span>}
        <input
          type="number"
          value={localData[field] || ''}
          onChange={(e) => updateField(field, parseFloat(e.target.value) || 0)}
          min={min}
          max={max}
          className={`w-full px-4 py-2.5 rounded-xl border ${tc.input} ${prefix ? 'pl-8' : ''} ${suffix ? 'pr-12' : ''}`}
        />
        {suffix && <span className={`absolute right-4 top-1/2 -translate-y-1/2 ${tc.textMuted}`}>{suffix}</span>}
      </div>
    </div>
  )

  // Render content based on section
  const renderContent = () => {
    switch (sectionKey) {
      case 'identity':
        return (
          <div className="space-y-6">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <Input label="Organization Name" field="name" placeholder="Black Hornets Volleyball Club" required />
              <Input label="Short Name / Abbreviation" field="shortName" placeholder="BHVC" helpText="Used on jerseys and reports" />
            </div>
            <Input label="Tagline / Slogan" field="tagline" placeholder="Building Champions On & Off the Court" />
            <Input label="Logo URL" field="logoUrl" placeholder="https://..." helpText="Paste a link to your logo image" />
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className={`block text-sm font-medium ${tc.textSecondary} mb-1.5`}>Primary Brand Color</label>
                <div className="flex gap-2">
                  <input
                    type="color"
                    value={localData.primaryColor || '#F97316'}
                    onChange={(e) => updateField('primaryColor', e.target.value)}
                    className="w-12 h-10 rounded-lg cursor-pointer border-0"
                  />
                  <input
                    type="text"
                    value={localData.primaryColor || ''}
                    onChange={(e) => updateField('primaryColor', e.target.value)}
                    placeholder="#F97316"
                    className={`flex-1 px-4 py-2 rounded-xl border ${tc.input}`}
                  />
                </div>
              </div>
              <div>
                <label className={`block text-sm font-medium ${tc.textSecondary} mb-1.5`}>Secondary Color</label>
                <div className="flex gap-2">
                  <input
                    type="color"
                    value={localData.secondaryColor || '#1E293B'}
                    onChange={(e) => updateField('secondaryColor', e.target.value)}
                    className="w-12 h-10 rounded-lg cursor-pointer border-0"
                  />
                  <input
                    type="text"
                    value={localData.secondaryColor || ''}
                    onChange={(e) => updateField('secondaryColor', e.target.value)}
                    placeholder="#1E293B"
                    className={`flex-1 px-4 py-2 rounded-xl border ${tc.input}`}
                  />
                </div>
              </div>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <Select 
                label="Organization Type" 
                field="orgType" 
                options={[
                  { value: 'club', label: 'Club / League' },
                  { value: 'recreation', label: 'Recreation Department' },
                  { value: 'school', label: 'School / District' },
                  { value: 'travel', label: 'Travel / Competitive' },
                  { value: 'camp', label: 'Camp / Clinic' },
                  { value: 'other', label: 'Other' },
                ]}
              />
              <Input label="Founded Year" field="foundedYear" type="number" placeholder="2015" />
            </div>
            <div>
              <label className={`block text-sm font-medium ${tc.textSecondary} mb-1.5`}>Mission Statement</label>
              <textarea
                value={localData.mission || ''}
                onChange={(e) => updateField('mission', e.target.value)}
                placeholder="Our mission is to provide youth athletes with..."
                rows={3}
                className={`w-full px-4 py-2.5 rounded-xl border ${tc.input} resize-none`}
              />
            </div>
          </div>
        )

      case 'contact':
        return (
          <div className="space-y-6">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <Input label="Primary Contact Name" field="contactName" placeholder="John Smith" required />
              <Input label="Title" field="contactTitle" placeholder="League Director" />
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <Input label="Primary Email" field="email" type="email" placeholder="info@blackhornets.com" required />
              <Input label="Secondary Email" field="secondaryEmail" type="email" placeholder="backup@blackhornets.com" />
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <Input label="Primary Phone" field="phone" type="tel" placeholder="(555) 123-4567" required />
              <Input label="Secondary Phone" field="secondaryPhone" type="tel" placeholder="(555) 987-6543" />
            </div>
            <Input label="Street Address" field="address" placeholder="123 Main Street" />
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div className="col-span-2">
                <Input label="City" field="city" placeholder="Dallas" required />
              </div>
              <Select 
                label="State" 
                field="state" 
                required
                options={[
                  { value: 'TX', label: 'Texas' },
                  { value: 'CA', label: 'California' },
                  { value: 'FL', label: 'Florida' },
                  { value: 'NY', label: 'New York' },
                  // Add more states as needed
                ]}
              />
              <Input label="ZIP" field="zip" placeholder="75001" />
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <Select 
                label="Time Zone" 
                field="timezone"
                options={[
                  { value: 'America/New_York', label: 'Eastern Time' },
                  { value: 'America/Chicago', label: 'Central Time' },
                  { value: 'America/Denver', label: 'Mountain Time' },
                  { value: 'America/Los_Angeles', label: 'Pacific Time' },
                ]}
              />
              <Input label="Office Hours" field="officeHours" placeholder="Mon-Fri 9am-5pm" />
            </div>
          </div>
        )

      case 'online':
        return (
          <div className="space-y-6">
            <Input label="Website URL" field="website" placeholder="https://www.blackhornets.com" />
            <Input label="Facebook Page" field="facebook" placeholder="https://facebook.com/blackhornetsVB" />
            <Input label="Instagram Handle" field="instagram" placeholder="@blackhornetsVB" helpText="Just the handle, no URL needed" />
            <Input label="Twitter / X Handle" field="twitter" placeholder="@blackhornetsVB" />
            <div className={`p-4 rounded-xl ${tc.cardBgAlt}`}>
              <p className={`text-sm font-medium ${tc.text} mb-1`}>üìé Your Registration Link</p>
              <p className={`text-sm ${tc.textMuted} mb-2`}>Share this link for parents to register:</p>
              <div className="flex gap-2">
                <code className={`flex-1 px-3 py-2 rounded-lg text-sm ${tc.input}`}>
                  volleybrain.com/register/{organization?.slug || 'your-org'}
                </code>
                <button 
                  onClick={() => {
                    navigator.clipboard.writeText(`https://volleybrain.com/register/${organization?.slug}`)
                    showToast('Link copied!', 'success')
                  }}
                  className="px-4 py-2 rounded-lg text-white font-medium"
                  style={{ backgroundColor: accent.primary }}
                >
                  Copy
                </button>
              </div>
            </div>
          </div>
        )

      case 'sports':
        const allSports = [
          { id: 'volleyball', name: 'Volleyball', icon: 'volleyball' },
          { id: 'basketball', name: 'Basketball', icon: 'üèÄ' },
          { id: 'soccer', name: 'Soccer', icon: '‚öΩ' },
          { id: 'baseball', name: 'Baseball', icon: '‚öæ' },
          { id: 'softball', name: 'Softball', icon: 'ü•é' },
          { id: 'football', name: 'Flag Football', icon: 'üèà' },
          { id: 'swimming', name: 'Swimming', icon: 'üèä' },
          { id: 'track', name: 'Track & Field', icon: 'üèÉ' },
          { id: 'tennis', name: 'Tennis', icon: 'üéæ' },
          { id: 'golf', name: 'Golf', icon: '‚õ≥' },
          { id: 'cheer', name: 'Cheerleading', icon: 'üì£' },
          { id: 'gymnastics', name: 'Gymnastics', icon: 'ü§∏' },
        ]
        const allPrograms = [
          { id: 'league', name: 'Leagues / Seasons', icon: 'trophy', desc: 'Multi-week competitive or recreational programs' },
          { id: 'camp', name: 'Camps', icon: 'üèïÔ∏è', desc: 'Short-term intensive programs (usually 1 week)' },
          { id: 'clinic', name: 'Clinics', icon: 'clipboard', desc: 'Skills-focused training sessions' },
          { id: 'tournament', name: 'Tournaments', icon: 'ü•á', desc: 'Competition events' },
          { id: 'tryout', name: 'Tryouts', icon: 'target', desc: 'Player evaluation sessions' },
          { id: 'training', name: 'Private Training', icon: 'üèãÔ∏è', desc: 'Individual or small group sessions' },
        ]
        const allSkillLevels = [
          { id: 'recreational', name: 'Recreational', desc: 'Fun and learning focused' },
          { id: 'intermediate', name: 'Intermediate', desc: 'Some experience required' },
          { id: 'competitive', name: 'Competitive', desc: 'Experienced players, tryouts' },
          { id: 'elite', name: 'Elite / Travel', desc: 'Tournament-level teams' },
        ]
        const allGenders = [
          { id: 'girls', name: 'Girls' },
          { id: 'boys', name: 'Boys' },
          { id: 'coed', name: 'Coed' },
        ]

        const toggleArrayItem = (field, item) => {
          const current = localData[field] || []
          const updated = current.includes(item) 
            ? current.filter(i => i !== item)
            : [...current, item]
          updateField(field, updated)
        }

        return (
          <div className="space-y-6">
            {/* Sports Selection */}
            <div>
              <label className={`block text-sm font-medium ${tc.textSecondary} mb-3`}>
                Which sports does your organization offer? <span className="text-red-400">*</span>
              </label>
              <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                {allSports.map(sport => {
                  const isEnabled = (localData.enabledSports || []).includes(sport.id)
                  return (
                    <button
                      key={sport.id}
                      onClick={() => toggleArrayItem('enabledSports', sport.id)}
                      className={`p-3 rounded-xl border-2 transition-all text-left ${
                        isEnabled 
                          ? 'border-[var(--accent-primary)] bg-[var(--accent-primary)]/10' 
                          : `${tc.border} ${tc.hoverBg}`
                      }`}
                    >
                      <span className="text-2xl">{sport.icon}</span>
                      <p className={`text-sm font-medium mt-1 ${isEnabled ? tc.text : tc.textMuted}`}>{sport.name}</p>
                    </button>
                  )
                })}
              </div>
            </div>

            {/* Program Types */}
            <div>
              <label className={`block text-sm font-medium ${tc.textSecondary} mb-3`}>
                What types of programs do you offer?
              </label>
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                {allPrograms.map(program => {
                  const isEnabled = (localData.programTypes || []).includes(program.id)
                  return (
                    <button
                      key={program.id}
                      onClick={() => toggleArrayItem('programTypes', program.id)}
                      className={`p-4 rounded-xl border-2 transition-all text-left ${
                        isEnabled 
                          ? 'border-[var(--accent-primary)] bg-[var(--accent-primary)]/10' 
                          : `${tc.border} ${tc.hoverBg}`
                      }`}
                    >
                      <div className="flex items-center gap-3">
                        <span className="text-xl">{program.icon}</span>
                        <div>
                          <p className={`font-medium ${isEnabled ? tc.text : tc.textMuted}`}>{program.name}</p>
                          <p className={`text-xs ${tc.textMuted}`}>{program.desc}</p>
                        </div>
                      </div>
                    </button>
                  )
                })}
              </div>
            </div>

            {/* Age System */}
            <div className={`p-4 rounded-xl border ${tc.border}`}>
              <label className={`block text-sm font-medium ${tc.textSecondary} mb-3`}>
                How do you organize age divisions?
              </label>
              <div className="grid grid-cols-2 gap-4">
                <button
                  onClick={() => updateField('ageSystem', 'grade')}
                  className={`p-4 rounded-xl border-2 text-left transition-all ${
                    localData.ageSystem === 'grade'
                      ? 'border-[var(--accent-primary)] bg-[var(--accent-primary)]/10'
                      : `${tc.border}`
                  }`}
                >
                  <p className={`font-medium ${tc.text}`}>üìö Grade-Based</p>
                  <p className={`text-sm ${tc.textMuted} mt-1`}>3rd-4th, 5th-6th, etc.</p>
                </button>
                <button
                  onClick={() => updateField('ageSystem', 'age')}
                  className={`p-4 rounded-xl border-2 text-left transition-all ${
                    localData.ageSystem === 'age'
                      ? 'border-[var(--accent-primary)] bg-[var(--accent-primary)]/10'
                      : `${tc.border}`
                  }`}
                >
                  <p className={`font-medium ${tc.text}`}>üéÇ Age-Based</p>
                  <p className={`text-sm ${tc.textMuted} mt-1`}>10U, 12U, 14U, etc.</p>
                </button>
              </div>
              {localData.ageSystem === 'age' && (
                <div className="mt-4">
                  <label className={`block text-sm ${tc.textMuted} mb-2`}>Age cutoff date (MM-DD)</label>
                  <input
                    type="text"
                    value={localData.ageCutoffDate || '08-01'}
                    onChange={(e) => updateField('ageCutoffDate', e.target.value)}
                    placeholder="08-01"
                    className={`w-32 px-3 py-2 rounded-lg border ${tc.input}`}
                  />
                  <p className={`text-xs ${tc.textMuted} mt-1`}>Player's age on this date determines their division</p>
                </div>
              )}
            </div>

            {/* Skill Levels */}
            <div>
              <label className={`block text-sm font-medium ${tc.textSecondary} mb-3`}>
                What skill levels do you offer?
              </label>
              <div className="flex flex-wrap gap-2">
                {allSkillLevels.map(level => {
                  const isEnabled = (localData.skillLevels || []).includes(level.id)
                  return (
                    <button
                      key={level.id}
                      onClick={() => toggleArrayItem('skillLevels', level.id)}
                      className={`px-4 py-2 rounded-full border-2 transition-all ${
                        isEnabled 
                          ? 'border-[var(--accent-primary)] bg-[var(--accent-primary)]/10 text-[var(--accent-primary)]' 
                          : `${tc.border} ${tc.textMuted}`
                      }`}
                    >
                      {level.name}
                    </button>
                  )
                })}
              </div>
            </div>

            {/* Gender Options */}
            <div>
              <label className={`block text-sm font-medium ${tc.textSecondary} mb-3`}>
                What gender divisions do you offer?
              </label>
              <div className="flex gap-3">
                {allGenders.map(gender => {
                  const isEnabled = (localData.genderOptions || []).includes(gender.id)
                  return (
                    <button
                      key={gender.id}
                      onClick={() => toggleArrayItem('genderOptions', gender.id)}
                      className={`px-6 py-3 rounded-xl border-2 transition-all ${
                        isEnabled 
                          ? 'border-[var(--accent-primary)] bg-[var(--accent-primary)]/10 text-[var(--accent-primary)] font-medium' 
                          : `${tc.border} ${tc.textMuted}`
                      }`}
                    >
                      {gender.name}
                    </button>
                  )
                })}
              </div>
            </div>
          </div>
        )

      case 'legal':
        return (
          <div className="space-y-6">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <Input label="Legal Entity Name" field="legalName" placeholder="Black Hornets Volleyball LLC" helpText="If different from org name" />
              <Select 
                label="Entity Type" 
                field="entityType"
                options={[
                  { value: 'llc', label: 'LLC' },
                  { value: '501c3', label: '501(c)(3) Nonprofit' },
                  { value: '501c4', label: '501(c)(4) Nonprofit' },
                  { value: 'sole_prop', label: 'Sole Proprietorship' },
                  { value: 'corp', label: 'Corporation' },
                  { value: 'other', label: 'Other / Unincorporated' },
                ]}
              />
            </div>
            <Input label="EIN / Tax ID" field="ein" placeholder="XX-XXXXXXX" helpText="For tax purposes and payment processing" />
            
            <div className={`p-4 rounded-xl border ${tc.border} ${tc.cardBgAlt}`}>
              <div className="flex items-center justify-between mb-3">
                <div>
                  <p className={`font-medium ${tc.text}`}>üìã Waivers</p>
                  <p className={`text-sm ${tc.textMuted}`}>{waivers?.length || 0} waivers configured</p>
                </div>
                <button 
                  className="px-4 py-2 rounded-lg text-white font-medium text-sm"
                  style={{ backgroundColor: accent.primary }}
                  onClick={() => showToast('Opening waiver manager...', 'info')}
                >
                  Manage Waivers ‚Üí
                </button>
              </div>
              <div className="space-y-2">
                {['Liability Waiver', 'Photo/Media Release', 'Medical Authorization', 'Code of Conduct', 'Concussion Protocol'].map(waiver => {
                  const exists = waivers?.some(w => w.name?.toLowerCase().includes(waiver.toLowerCase().split(' ')[0]))
                  return (
                    <div key={waiver} className="flex items-center gap-2">
                      <span>{exists ? '‚úÖ' : '‚¨ú'}</span>
                      <span className={`text-sm ${exists ? tc.text : tc.textMuted}`}>{waiver}</span>
                      {!exists && <span className="text-xs text-amber-500">(Recommended)</span>}
                    </div>
                  )
                })}
              </div>
            </div>

            <div className={`p-4 rounded-xl border ${tc.border}`}>
              <p className={`font-medium ${tc.text} mb-3`}>Insurance</p>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <Input label="Insurance Provider" field="insuranceProvider" placeholder="State Farm, USAV, etc." />
                <Input label="Policy Number" field="insurancePolicyNumber" placeholder="POL-123456" />
              </div>
              <div className="mt-4">
                <Input label="Expiration Date" field="insuranceExpiration" type="date" />
              </div>
            </div>
          </div>
        )

      case 'payments':
        return (
          <div className="space-y-6">
            <p className={`text-sm ${tc.textMuted}`}>Configure how you accept payments from families. Enable at least one method.</p>
            
            {[
              { key: 'venmo', label: 'Venmo', icon: 'üíú', placeholder: '@YourVenmoHandle' },
              { key: 'zelle', label: 'Zelle', icon: 'üíö', placeholder: 'email@example.com or phone' },
              { key: 'cashapp', label: 'Cash App', icon: 'üíµ', placeholder: '$YourCashTag' },
              { key: 'paypal', label: 'PayPal', icon: 'üíô', placeholder: 'email@example.com' },
              { key: 'check', label: 'Check', icon: 'üìù', placeholder: 'Payable to: Your Org Name' },
              { key: 'cash', label: 'Cash', icon: 'dollar', placeholder: 'In-person only' },
            ].map(method => {
              const methodData = localData.paymentMethods?.[method.key] || {}
              return (
                <div key={method.key} className={`p-4 rounded-xl border ${tc.border}`}>
                  <div className="flex items-center justify-between mb-3">
                    <div className="flex items-center gap-3">
                      <span className="text-xl">{method.icon}</span>
                      <span className={`font-medium ${tc.text}`}>{method.label}</span>
                    </div>
                    <button
                      onClick={() => {
                        const newMethods = { ...localData.paymentMethods }
                        newMethods[method.key] = { ...methodData, enabled: !methodData.enabled }
                        updateField('paymentMethods', newMethods)
                      }}
                      className={`w-12 h-6 rounded-full transition-colors ${methodData.enabled ? '' : 'bg-slate-600'}`}
                      style={{ backgroundColor: methodData.enabled ? accent.primary : undefined }}
                    >
                      <div className={`w-5 h-5 rounded-full bg-white shadow transition-transform ${methodData.enabled ? 'translate-x-6' : 'translate-x-0.5'}`} />
                    </button>
                  </div>
                  {methodData.enabled && (
                    <div className="space-y-3">
                      <input
                        type="text"
                        value={methodData.account || ''}
                        onChange={(e) => {
                          const newMethods = { ...localData.paymentMethods }
                          newMethods[method.key] = { ...methodData, account: e.target.value }
                          updateField('paymentMethods', newMethods)
                        }}
                        placeholder={method.placeholder}
                        className={`w-full px-4 py-2 rounded-lg border ${tc.input}`}
                      />
                      <textarea
                        value={methodData.instructions || ''}
                        onChange={(e) => {
                          const newMethods = { ...localData.paymentMethods }
                          newMethods[method.key] = { ...methodData, instructions: e.target.value }
                          updateField('paymentMethods', newMethods)
                        }}
                        placeholder="Payment instructions (e.g., 'Include player name in memo')"
                        rows={2}
                        className={`w-full px-4 py-2 rounded-lg border ${tc.input} text-sm resize-none`}
                      />
                    </div>
                  )}
                </div>
              )
            })}

            <div className={`p-4 rounded-xl border ${tc.border}`}>
              <p className={`font-medium ${tc.text} mb-4`}>‚öôÔ∏è Payment Settings</p>
              <div className="space-y-4">
                <Toggle 
                  label="Allow Payment Plans" 
                  field="allowPaymentPlans"
                  helpText="Let families split payments into installments"
                />
                {localData.allowPaymentPlans && (
                  <div className="pl-4 border-l-2 border-slate-600 space-y-4">
                    <NumberInput label="Number of Installments" field="paymentPlanInstallments" min={2} max={6} />
                  </div>
                )}
                <div className="grid grid-cols-2 gap-4">
                  <NumberInput label="Late Fee Amount" field="lateFeeAmount" prefix="$" />
                  <NumberInput label="Grace Period" field="gracePeriodDays" suffix="days" />
                </div>
              </div>
            </div>
          </div>
        )

      case 'fees':
        return (
          <div className="space-y-6">
            <p className={`text-sm ${tc.textMuted}`}>Set default fees for new seasons. These can be overridden per season.</p>
            
            <div className={`p-4 rounded-xl border ${tc.border}`}>
              <p className={`font-medium ${tc.text} mb-4`}>üíµ Default Fees</p>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <NumberInput label="Registration Fee" field="defaultRegistrationFee" prefix="$" />
                <NumberInput label="Uniform Fee" field="defaultUniformFee" prefix="$" />
                <NumberInput label="Monthly Fee" field="defaultMonthlyFee" prefix="$" />
              </div>
            </div>

            <div className={`p-4 rounded-xl border ${tc.border}`}>
              <p className={`font-medium ${tc.text} mb-4`}>üéÅ Discounts</p>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <NumberInput label="Early Bird Discount" field="earlyBirdDiscount" prefix="$" />
                <NumberInput label="Sibling Discount" field="siblingDiscount" suffix="%" />
                <NumberInput label="Multi-Sport Discount" field="multiSportDiscount" suffix="%" />
              </div>
            </div>

            <div className={`p-4 rounded-xl ${tc.cardBgAlt}`}>
              <p className={`text-sm ${tc.text}`}>
                üí° <strong>Example:</strong> With these defaults, a family with 2 kids registering early would pay:
              </p>
              <p className={`text-lg font-semibold mt-2`} style={{ color: accent.primary }}>
                ${((localData.defaultRegistrationFee || 150) * 2) - (localData.earlyBirdDiscount || 25) - ((localData.defaultRegistrationFee || 150) * (localData.siblingDiscount || 10) / 100)} 
                <span className={`text-sm font-normal ${tc.textMuted}`}> (instead of ${(localData.defaultRegistrationFee || 150) * 2})</span>
              </p>
            </div>
          </div>
        )

      case 'facilities':
        return (
          <div className="space-y-6">
            <div className="flex items-center justify-between">
              <p className={`text-sm ${tc.textMuted}`}>Add your practice and game locations.</p>
              <button 
                className="px-4 py-2 rounded-lg text-white font-medium text-sm"
                style={{ backgroundColor: accent.primary }}
                onClick={() => showToast('Venue manager coming soon!', 'info')}
              >
                ‚ûï Add Venue
              </button>
            </div>

            {venues?.length > 0 ? (
              <div className="space-y-3">
                {venues.map(venue => (
                  <div key={venue.id} className={`p-4 rounded-xl border ${tc.border}`}>
                    <div className="flex items-start justify-between">
                      <div>
                        <p className={`font-medium ${tc.text}`}>{venue.name}</p>
                        <p className={`text-sm ${tc.textMuted}`}>{venue.address}</p>
                      </div>
                      <span className="text-xs px-2 py-1 rounded-full bg-emerald-500/20 text-emerald-400">
                        {venue.is_home ? 'Home' : 'Away'}
                      </span>
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <div className={`p-8 rounded-xl border-2 border-dashed ${tc.border} text-center`}>
                <span className="text-4xl">üìç</span>
                <p className={`${tc.text} font-medium mt-3`}>No venues added yet</p>
                <p className={`text-sm ${tc.textMuted} mt-1`}>Add at least one venue for your schedule</p>
              </div>
            )}
          </div>
        )

      case 'staff':
        return (
          <div className="space-y-6">
            <div className="flex items-center justify-between">
              <p className={`text-sm ${tc.textMuted}`}>Manage who has admin access to your organization.</p>
              <button 
                className="px-4 py-2 rounded-lg text-white font-medium text-sm"
                style={{ backgroundColor: accent.primary }}
                onClick={() => showToast('Invite admin coming soon!', 'info')}
              >
                ‚ûï Invite Admin
              </button>
            </div>

            <div className="space-y-3">
              {adminUsers?.map(user => (
                <div key={user.id} className={`p-4 rounded-xl border ${tc.border} flex items-center justify-between`}>
                  <div className="flex items-center gap-3">
                    <div className="w-10 h-10 rounded-full bg-slate-600 flex items-center justify-center text-white font-medium">
                      {user.profiles?.full_name?.charAt(0) || '?'}
                    </div>
                    <div>
                      <p className={`font-medium ${tc.text}`}>{user.profiles?.full_name || 'Unknown'}</p>
                      <p className={`text-sm ${tc.textMuted}`}>{user.profiles?.email}</p>
                    </div>
                  </div>
                  <span className="text-xs px-2 py-1 rounded-full bg-purple-500/20 text-purple-400 capitalize">
                    {user.role?.replace('_', ' ')}
                  </span>
                </div>
              ))}
            </div>

            {adminUsers?.length <= 1 && (
              <div className={`p-4 rounded-xl bg-amber-500/10 border border-amber-500/30`}>
                <p className="text-sm text-amber-400">
                  ‚ö†Ô∏è <strong>Tip:</strong> Consider adding a backup admin in case you're unavailable.
                </p>
              </div>
            )}
          </div>
        )

      case 'coaches':
        return (
          <div className="space-y-6">
            <p className={`text-sm ${tc.textMuted}`}>Set requirements for coaches before they can be assigned to teams.</p>
            
            <div className={`space-y-1 divide-y ${tc.border}`}>
              <Toggle label="Require Background Check" field="requireBackgroundCheck" helpText="Must complete before coaching" />
              <Toggle label="Require SafeSport Certification" field="requireSafeSport" helpText="USAV/USA Sports requirement" />
              <Toggle label="Require CPR/First Aid" field="requireCPR" helpText="Current certification" />
            </div>

            <NumberInput label="Minimum Coach Age" field="coachMinAge" suffix="years" />
          </div>
        )

      case 'registration':
        return (
          <div className="space-y-6">
            <p className={`text-sm ${tc.textMuted}`}>Control how the registration process works.</p>
            
            <div className={`space-y-1 divide-y ${tc.border}`}>
              <Toggle label="Auto-Approve Registrations" field="autoApproveRegistrations" helpText="Skip manual review step" />
              <Toggle label="Require Payment to Complete" field="requirePaymentToComplete" helpText="Must pay before registration is confirmed" />
              <Toggle label="Allow Waitlist" field="allowWaitlist" helpText="When teams/seasons are full" />
            </div>

            <NumberInput label="Max Players per Registration" field="maxPlayersPerRegistration" helpText="Siblings in one form" />
          </div>
        )

      case 'registrationForm':
        // Field toggle component
        const FieldToggle = ({ category, fieldKey, field }) => {
          const fields = localData.registrationFields || {}
          const categoryFields = fields[category] || {}
          const fieldData = categoryFields[fieldKey] || field
          
          const toggleVisible = () => {
            const updated = {
              ...localData.registrationFields,
              [category]: {
                ...categoryFields,
                [fieldKey]: { ...fieldData, visible: !fieldData.visible }
              }
            }
            updateField('registrationFields', updated)
          }
          
          const toggleRequired = () => {
            const updated = {
              ...localData.registrationFields,
              [category]: {
                ...categoryFields,
                [fieldKey]: { ...fieldData, required: !fieldData.required }
              }
            }
            updateField('registrationFields', updated)
          }
          
          return (
            <div className={`flex items-center justify-between py-3 ${fieldData.visible ? '' : 'opacity-50'}`}>
              <div className="flex items-center gap-3">
                <button
                  onClick={toggleVisible}
                  className={`w-5 h-5 rounded border-2 flex items-center justify-center transition ${
                    fieldData.visible 
                      ? 'bg-[var(--accent-primary)] border-[var(--accent-primary)] text-white' 
                      : `${tc.border} ${tc.cardBgAlt}`
                  }`}
                >
                  {fieldData.visible && <span className="text-xs">‚úì</span>}
                </button>
                <span className={`${fieldData.visible ? tc.text : tc.textMuted}`}>{fieldData.label || fieldKey}</span>
              </div>
              {fieldData.visible && (
                <button
                  onClick={toggleRequired}
                  className={`text-xs px-2 py-1 rounded-full transition ${
                    fieldData.required 
                      ? 'bg-red-500/20 text-red-400' 
                      : `${tc.cardBgAlt} ${tc.textMuted}`
                  }`}
                >
                  {fieldData.required ? 'Required' : 'Optional'}
                </button>
              )}
            </div>
          )
        }
        
        // Custom question component
        const CustomQuestionItem = ({ question, index, onUpdate, onDelete }) => (
          <div className={`p-4 rounded-xl border ${tc.border} space-y-3`}>
            <div className="flex items-start justify-between">
              <input
                type="text"
                value={question.label}
                onChange={(e) => onUpdate(index, { ...question, label: e.target.value })}
                placeholder="Question text"
                className={`flex-1 px-3 py-2 rounded-lg border ${tc.input} text-sm`}
              />
              <button
                onClick={() => onDelete(index)}
                className="ml-2 p-2 text-red-400 hover:bg-red-500/10 rounded-lg"
              >
                üóëÔ∏è
              </button>
            </div>
            <div className="flex gap-3">
              <select
                value={question.type}
                onChange={(e) => onUpdate(index, { ...question, type: e.target.value })}
                className={`px-3 py-2 rounded-lg border ${tc.input} text-sm`}
              >
                <option value="text">Text</option>
                <option value="textarea">Long Text</option>
                <option value="dropdown">Dropdown</option>
                <option value="yesno">Yes/No</option>
                <option value="checkbox">Checkbox</option>
              </select>
              <label className="flex items-center gap-2 text-sm">
                <input
                  type="checkbox"
                  checked={question.required}
                  onChange={(e) => onUpdate(index, { ...question, required: e.target.checked })}
                  className="w-4 h-4"
                />
                <span className={tc.textMuted}>Required</span>
              </label>
            </div>
            {question.type === 'dropdown' && (
              <input
                type="text"
                value={question.options?.join(', ') || ''}
                onChange={(e) => onUpdate(index, { ...question, options: e.target.value.split(',').map(o => o.trim()) })}
                placeholder="Options (comma separated): Option 1, Option 2, Option 3"
                className={`w-full px-3 py-2 rounded-lg border ${tc.input} text-sm`}
              />
            )}
          </div>
        )
        
        const addCustomQuestion = () => {
          const questions = localData.customQuestions || []
          const newQuestion = {
            id: `q_${Date.now()}`,
            label: '',
            type: 'text',
            required: false,
            options: []
          }
          updateField('customQuestions', [...questions, newQuestion])
        }
        
        const updateCustomQuestion = (index, question) => {
          const questions = [...(localData.customQuestions || [])]
          questions[index] = question
          updateField('customQuestions', questions)
        }
        
        const deleteCustomQuestion = (index) => {
          const questions = [...(localData.customQuestions || [])]
          questions.splice(index, 1)
          updateField('customQuestions', questions)
        }

        const fields = localData.registrationFields || {}
        
        return (
          <div className="space-y-6">
            <div className={`p-4 rounded-xl ${tc.cardBgAlt}`}>
              <p className={`text-sm ${tc.textMuted}`}>
                üìã Customize what information you collect during registration. Toggle fields on/off and mark them as required or optional.
              </p>
            </div>

            {/* Player Information */}
            <div className={`p-5 rounded-xl border ${tc.border}`}>
              <div className="flex items-center gap-2 mb-4">
                <User className="w-6 h-6" />
                <h3 className={`font-semibold ${tc.text}`}>Player Information</h3>
              </div>
              <div className={`divide-y ${tc.border}`}>
                {Object.entries(fields.player || {}).map(([key, field]) => (
                  <FieldToggle key={key} category="player" fieldKey={key} field={field} />
                ))}
              </div>
            </div>

            {/* Parent/Guardian Information */}
            <div className={`p-5 rounded-xl border ${tc.border}`}>
              <div className="flex items-center gap-2 mb-4">
                <Users className="w-5 h-5" />
                <h3 className={`font-semibold ${tc.text}`}>Parent/Guardian Information</h3>
              </div>
              <div className={`divide-y ${tc.border}`}>
                {Object.entries(fields.parent || {}).map(([key, field]) => (
                  <FieldToggle key={key} category="parent" fieldKey={key} field={field} />
                ))}
              </div>
            </div>

            {/* Emergency Contact */}
            <div className={`p-5 rounded-xl border ${tc.border}`}>
              <div className="flex items-center gap-2 mb-4">
                <AlertTriangle className="w-6 h-6" />
                <h3 className={`font-semibold ${tc.text}`}>Emergency Contact</h3>
              </div>
              <div className={`divide-y ${tc.border}`}>
                {Object.entries(fields.emergency || {}).map(([key, field]) => (
                  <FieldToggle key={key} category="emergency" fieldKey={key} field={field} />
                ))}
              </div>
            </div>

            {/* Medical Information */}
            <div className={`p-5 rounded-xl border ${tc.border}`}>
              <div className="flex items-center gap-2 mb-4">
                <Activity className="w-6 h-6" />
                <h3 className={`font-semibold ${tc.text}`}>Medical Information</h3>
              </div>
              <div className={`divide-y ${tc.border}`}>
                {Object.entries(fields.medical || {}).map(([key, field]) => (
                  <FieldToggle key={key} category="medical" fieldKey={key} field={field} />
                ))}
              </div>
            </div>

            {/* Custom Questions */}
            <div className={`p-5 rounded-xl border ${tc.border}`}>
              <div className="flex items-center justify-between mb-4">
                <div className="flex items-center gap-2">
                  <span className="text-xl">‚ùì</span>
                  <h3 className={`font-semibold ${tc.text}`}>Custom Questions</h3>
                </div>
                <button
                  onClick={addCustomQuestion}
                  className="px-3 py-1.5 rounded-lg text-sm font-medium"
                  style={{ backgroundColor: accent.primary, color: 'white' }}
                >
                  ‚ûï Add Question
                </button>
              </div>
              
              {(localData.customQuestions || []).length === 0 ? (
                <p className={`text-sm ${tc.textMuted} text-center py-4`}>
                  No custom questions yet. Add questions like "How did you hear about us?" or "Interested in volunteering?"
                </p>
              ) : (
                <div className="space-y-3">
                  {(localData.customQuestions || []).map((q, i) => (
                    <CustomQuestionItem 
                      key={q.id} 
                      question={q} 
                      index={i}
                      onUpdate={updateCustomQuestion}
                      onDelete={deleteCustomQuestion}
                    />
                  ))}
                </div>
              )}
            </div>

            {/* Waivers Selection */}
            <div className={`p-5 rounded-xl border ${tc.border}`}>
              <div className="flex items-center gap-2 mb-4">
                <span className="text-xl">üìú</span>
                <h3 className={`font-semibold ${tc.text}`}>Waivers to Include</h3>
              </div>
              <p className={`text-sm ${tc.textMuted} mb-4`}>
                Select which waivers families must sign during registration. Configure waivers in the Legal & Waivers section.
              </p>
              {waivers && waivers.length > 0 ? (
                <div className="space-y-2">
                  {waivers.map(waiver => {
                    const isSelected = (localData.selectedWaivers || []).includes(waiver.id)
                    return (
                      <button
                        key={waiver.id}
                        onClick={() => {
                          const current = localData.selectedWaivers || []
                          const updated = isSelected 
                            ? current.filter(id => id !== waiver.id)
                            : [...current, waiver.id]
                          updateField('selectedWaivers', updated)
                        }}
                        className={`w-full p-3 rounded-xl border-2 text-left transition ${
                          isSelected 
                            ? 'border-[var(--accent-primary)] bg-[var(--accent-primary)]/10' 
                            : `${tc.border} hover:border-slate-500`
                        }`}
                      >
                        <div className="flex items-center gap-3">
                          <span className={`w-5 h-5 rounded border-2 flex items-center justify-center ${
                            isSelected ? 'bg-[var(--accent-primary)] border-[var(--accent-primary)] text-white' : tc.border
                          }`}>
                            {isSelected && <span className="text-xs">‚úì</span>}
                          </span>
                          <span className={isSelected ? tc.text : tc.textMuted}>{waiver.name}</span>
                        </div>
                      </button>
                    )
                  })}
                </div>
              ) : (
                <div className={`text-center py-6 ${tc.cardBgAlt} rounded-xl`}>
                  <p className={tc.textMuted}>No waivers configured yet.</p>
                  <p className={`text-sm ${tc.textMuted} mt-1`}>Go to Legal & Waivers to add waivers.</p>
                </div>
              )}
            </div>

            {/* Preview Summary */}
            <div className={`p-5 rounded-xl ${tc.cardBgAlt}`}>
              <div className="flex items-center gap-2 mb-3">
                <span className="text-xl">üëÅÔ∏è</span>
                <h3 className={`font-semibold ${tc.text}`}>Form Preview Summary</h3>
              </div>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                <div>
                  <p className="text-2xl font-bold" style={{ color: accent.primary }}>
                    {Object.values(fields.player || {}).filter(f => f.visible).length}
                  </p>
                  <p className={`text-xs ${tc.textMuted}`}>Player Fields</p>
                </div>
                <div>
                  <p className="text-2xl font-bold" style={{ color: accent.primary }}>
                    {Object.values(fields.parent || {}).filter(f => f.visible).length}
                  </p>
                  <p className={`text-xs ${tc.textMuted}`}>Parent Fields</p>
                </div>
                <div>
                  <p className="text-2xl font-bold" style={{ color: accent.primary }}>
                    {(localData.customQuestions || []).length}
                  </p>
                  <p className={`text-xs ${tc.textMuted}`}>Custom Questions</p>
                </div>
                <div>
                  <p className="text-2xl font-bold" style={{ color: accent.primary }}>
                    {(localData.selectedWaivers || []).length}
                  </p>
                  <p className={`text-xs ${tc.textMuted}`}>Waivers</p>
                </div>
              </div>
            </div>
          </div>
        )

      case 'jerseys':
        return (
          <div className="space-y-6">
            <p className={`text-sm ${tc.textMuted}`}>Configure jersey/uniform settings.</p>
            
            <Input label="Jersey Vendor" field="jerseyVendor" placeholder="Company name" />
            <NumberInput label="Order Lead Time" field="jerseyLeadTime" suffix="weeks" helpText="How long before season to order" />
            
            <div className="grid grid-cols-2 gap-4">
              <NumberInput label="Number Range Start" field="jerseyNumberStart" min={0} max={99} />
              <NumberInput label="Number Range End" field="jerseyNumberEnd" min={1} max={99} />
            </div>
          </div>
        )

      case 'notifications':
        return (
          <div className="space-y-6">
            <p className={`text-sm ${tc.textMuted}`}>Configure reminders and email notifications.</p>
            
            {/* Email Notifications Section */}
            <div className={`p-4 rounded-xl ${tc.cardAlt} border ${tc.border}`}>
              <h4 className={`font-semibold ${tc.text} mb-4 flex items-center gap-2`}>
                <span>üìß</span> Email Notifications
              </h4>
              
              <Toggle 
                label="Enable Email Notifications" 
                field="emailNotificationsEnabled" 
                helpText="Send automated emails for registration events"
              />
              
              {localData.emailNotificationsEnabled && (
                <div className="pl-4 border-l-2 border-slate-600 space-y-4 mt-4">
                  <Toggle label="Registration Confirmation" field="emailOnRegistration" helpText="Email when registration is submitted" />
                  <Toggle label="Approval Notification" field="emailOnApproval" helpText="Email when registration is approved" />
                  <Toggle label="Waitlist Updates" field="emailOnWaitlist" helpText="Email when waitlist spot opens" />
                  <Toggle label="Team Assignment" field="emailOnTeamAssignment" helpText="Email when player is assigned to team" />
                  <Toggle label="Payment Reminders" field="emailOnPaymentDue" helpText="Email for outstanding balances" />
                </div>
              )}
            </div>
            
            {/* Reminder Timing Section */}
            <div className={`p-4 rounded-xl ${tc.cardAlt} border ${tc.border}`}>
              <h4 className={`font-semibold ${tc.text} mb-4 flex items-center gap-2`}>
                <span>‚è∞</span> Reminder Timing
              </h4>
              <div className="space-y-4">
                <NumberInput label="Game Reminder" field="gameReminderHours" suffix="hours before" />
                <NumberInput label="Practice Reminder" field="practiceReminderHours" suffix="hours before" />
                <NumberInput label="Payment Reminder" field="paymentReminderDays" suffix="days before due" />
              </div>
            </div>
            
            {/* Email Preview Link */}
            {localData.emailNotificationsEnabled && (
              <div className={`p-4 rounded-xl bg-blue-500/10 border border-blue-500/30`}>
                <p className="text-blue-400 text-sm flex items-center gap-2">
                  <span>üí°</span>
                  <span>Emails are queued in your database and sent via Supabase Edge Functions. <a href="https://supabase.com/docs/guides/functions" target="_blank" rel="noopener noreferrer" className="underline">Learn more ‚Üí</a></span>
                </p>
              </div>
            )}
          </div>
        )

      case 'volunteers':
        return (
          <div className="space-y-6">
            <p className={`text-sm ${tc.textMuted}`}>Configure volunteer requirements for families.</p>
            
            <Toggle label="Require Volunteer Hours" field="requireVolunteerHours" helpText="Families must volunteer or pay buyout" />
            
            {localData.requireVolunteerHours && (
              <div className="pl-4 border-l-2 border-slate-600 space-y-4">
                <NumberInput label="Hours Required per Family" field="volunteerHoursRequired" suffix="hours" />
                <NumberInput label="Buyout Amount" field="volunteerBuyoutAmount" prefix="$" helpText="Pay this instead of volunteering" />
              </div>
            )}
          </div>
        )

      default:
        return <p className={tc.textMuted}>Section content coming soon...</p>
    }
  }

  return (
    <div className="space-y-6">
      {renderContent()}
      
      {/* Save Button */}
      <div className="flex items-center justify-between pt-4 border-t border-slate-700">
        <p className={`text-sm ${hasChanges ? 'text-amber-400' : tc.textMuted}`}>
          {hasChanges ? '‚ö†Ô∏è You have unsaved changes' : '‚úì All changes saved'}
        </p>
        <button
          onClick={handleSave}
          disabled={!hasChanges || saving}
          className={`px-6 py-2.5 rounded-xl font-semibold transition ${hasChanges ? 'text-white' : 'opacity-50 cursor-not-allowed'}`}
          style={{ backgroundColor: hasChanges ? accent.primary : 'gray' }}
        >
          {saving ? 'Saving...' : 'Save Changes'}
        </button>
      </div>
    </div>
  )
}

// ============================================
// MAIN APP
// ============================================

// ============================================
// VOLLEYBRAIN JOURNEY SYSTEM
// ============================================
// A persistent onboarding/progress tracking system with:
// - Role-based checklists
// - Visual timeline/journey view
// - Badges and achievements
// - Progress persistence in database
// ============================================

// ============================================
// JOURNEY CONFIGURATION
// ============================================

const JOURNEY_BADGES = {
  // Organization badges
  founder: { id: 'founder', icon: 'üåü', name: 'Founder', description: 'Created your organization' },
  season_pro: { id: 'season_pro', icon: 'calendar', name: 'Season Pro', description: 'Created your first season' },
  team_builder: { id: 'team_builder', icon: 'users', name: 'Team Builder', description: 'Added your first team' },
  roster_ready: { id: 'roster_ready', icon: 'clipboard', name: 'Roster Ready', description: 'Registered 5+ players' },
  full_roster: { id: 'full_roster', icon: 'volleyball', name: 'Full House', description: 'Registered 10+ players' },
  scheduler: { id: 'scheduler', icon: 'calendar', name: 'Scheduler', description: 'Created your first event' },
  game_day: { id: 'game_day', icon: 'trophy', name: 'Game Day', description: 'Completed your first game' },
  coach_connector: { id: 'coach_connector', icon: 'target', name: 'Coach Connector', description: 'Added a coach to your team' },
  payment_pro: { id: 'payment_pro', icon: 'credit-card', name: 'Payment Pro', description: 'Collected your first payment' },
  
  // Coach badges
  lineup_master: { id: 'lineup_master', icon: 'bar-chart', name: 'Lineup Master', description: 'Created your first lineup' },
  practice_planner: { id: 'practice_planner', icon: 'üìù', name: 'Practice Planner', description: 'Planned your first practice' },
  game_prepper: { id: 'game_prepper', icon: 'üéÆ', name: 'Game Prepper', description: 'Completed game prep' },
  stat_tracker: { id: 'stat_tracker', icon: 'trending-up', name: 'Stat Tracker', description: 'Recorded player stats' },
  
  // Parent badges
  registered: { id: 'registered', icon: 'check-square', name: 'Registered', description: 'Registered your player' },
  paperwork_done: { id: 'paperwork_done', icon: 'file-text', name: 'Paperwork Pro', description: 'Completed all forms' },
  first_rsvp: { id: 'first_rsvp', icon: 'üëç', name: 'Engaged', description: 'RSVP\'d to your first event' },
  team_player: { id: 'team_player', icon: 'ü§ù', name: 'Team Player', description: 'Volunteered for an event' },
  
  // Milestone badges
  week_one: { id: 'week_one', icon: 'calendar', name: 'Week One', description: 'Completed first week' },
  midseason: { id: 'midseason', icon: 'star', name: 'Midseason Star', description: 'Reached midseason' },
  season_complete: { id: 'season_complete', icon: 'üèÖ', name: 'Season Complete', description: 'Finished the season' },
}

// Journey steps by role
const JOURNEY_STEPS = {
  org_director: [
    { id: 'create_org', title: 'Create Organization', description: 'Set up your club', icon: 'building', badge: 'founder' },
    { id: 'create_season', title: 'Create Season', description: 'Define your season dates and fees', icon: 'calendar', badge: 'season_pro' },
    { id: 'add_teams', title: 'Add Teams', description: 'Create teams for your organization', icon: 'users', badge: 'team_builder' },
    { id: 'add_coaches', title: 'Add Coaches', description: 'Assign coaches to teams', icon: 'target', badge: 'coach_connector' },
    { id: 'register_players', title: 'Register Players', description: 'Add players to your roster', icon: 'volleyball', badge: 'roster_ready' },
    { id: 'create_schedule', title: 'Create Schedule', description: 'Add practices and games', icon: 'calendar', badge: 'scheduler' },
    { id: 'first_game', title: 'First Game', description: 'Complete your first game', icon: 'trophy', badge: 'game_day' },
  ],
  team_manager: [
    { id: 'join_create_team', title: 'Set Up Team', description: 'Create or join a team', icon: 'users', badge: 'team_builder' },
    { id: 'add_roster', title: 'Build Roster', description: 'Add players to your team', icon: 'clipboard', badge: 'roster_ready' },
    { id: 'assign_coach', title: 'Add Coach', description: 'Assign a coach (or yourself)', icon: 'target', badge: 'coach_connector' },
    { id: 'create_schedule', title: 'Create Schedule', description: 'Add practices and games', icon: 'calendar', badge: 'scheduler' },
    { id: 'first_practice', title: 'First Practice', description: 'Complete your first practice', icon: 'volleyball', badge: 'practice_planner' },
    { id: 'first_game', title: 'First Game', description: 'Complete your first game', icon: 'trophy', badge: 'game_day' },
  ],
  coach: [
    { id: 'complete_profile', title: 'Complete Profile', description: 'Add your coaching info', icon: 'user', badge: null },
    { id: 'view_roster', title: 'Meet Your Team', description: 'Review your player roster', icon: 'clipboard', badge: null },
    { id: 'create_lineup', title: 'Create Lineup', description: 'Set up your game lineup', icon: 'bar-chart', badge: 'lineup_master' },
    { id: 'plan_practice', title: 'Plan Practice', description: 'Create a practice plan', icon: 'üìù', badge: 'practice_planner' },
    { id: 'game_prep', title: 'Game Prep', description: 'Prepare for your first game', icon: 'üéÆ', badge: 'game_prepper' },
    { id: 'track_stats', title: 'Track Stats', description: 'Record player statistics', icon: 'trending-up', badge: 'stat_tracker' },
  ],
  parent: [
    { id: 'register_player', title: 'Register Player', description: 'Register your child', icon: 'check-square', badge: 'registered' },
    { id: 'complete_forms', title: 'Complete Forms', description: 'Submit required paperwork', icon: 'file-text', badge: 'paperwork_done' },
    { id: 'view_schedule', title: 'View Schedule', description: 'Check the team calendar', icon: 'calendar', badge: null },
    { id: 'first_rsvp', title: 'RSVP to Event', description: 'Respond to an event', icon: 'üëç', badge: 'first_rsvp' },
    { id: 'volunteer', title: 'Volunteer', description: 'Sign up to help', icon: 'ü§ù', badge: 'team_player' },
  ],
  player: [
    { id: 'complete_profile', title: 'Complete Profile', description: 'Add your player info', icon: 'user', badge: null },
    { id: 'view_team', title: 'Meet Your Team', description: 'See your teammates', icon: 'users', badge: null },
    { id: 'view_schedule', title: 'View Schedule', description: 'Check upcoming events', icon: 'calendar', badge: null },
    { id: 'first_practice', title: 'First Practice', description: 'Attend your first practice', icon: 'volleyball', badge: null },
    { id: 'first_game', title: 'First Game', description: 'Play your first game', icon: 'trophy', badge: 'game_day' },
  ],
}

// ============================================
// JOURNEY CONTEXT - For app-wide state
// ============================================

const JourneyContext = createContext(null)
function useJourney() { return useContext(JourneyContext) }

function JourneyProvider({ children }) {
  const { user, profile, organization } = useAuth()
  const [journeyData, setJourneyData] = useState({
    completedSteps: [],
    earnedBadges: [],
    currentRole: 'org_director',
    dismissedUntil: null,
    celebrationQueue: [],
  })
  const [loading, setLoading] = useState(true)

  // Load journey data from profile
  useEffect(() => {
    if (profile?.id) {
      loadJourneyData()
    }
  }, [profile?.id])

  async function loadJourneyData() {
    try {
      const data = profile?.onboarding_data || {}
      setJourneyData({
        completedSteps: data.completed_steps || [],
        earnedBadges: data.earned_badges || [],
        currentRole: data.role || 'org_director',
        dismissedUntil: data.journey_dismissed_until || null,
        celebrationQueue: [],
      })
    } catch (err) {
      console.error('Error loading journey:', err)
    }
    setLoading(false)
  }

  async function completeStep(stepId) {
    const steps = JOURNEY_STEPS[journeyData.currentRole] || []
    const step = steps.find(s => s.id === stepId)
    
    if (!step || journeyData.completedSteps.includes(stepId)) return

    const newCompletedSteps = [...journeyData.completedSteps, stepId]
    const newBadges = [...journeyData.earnedBadges]
    const celebrations = []

    // Award badge if step has one
    if (step.badge && !newBadges.includes(step.badge)) {
      newBadges.push(step.badge)
      celebrations.push({ type: 'badge', badge: JOURNEY_BADGES[step.badge] })
    }

    // Check for milestone badges
    const completionPercent = (newCompletedSteps.length / steps.length) * 100
    if (completionPercent >= 100 && !newBadges.includes('season_complete')) {
      newBadges.push('season_complete')
      celebrations.push({ type: 'badge', badge: JOURNEY_BADGES.season_complete })
    }

    const newData = {
      ...journeyData,
      completedSteps: newCompletedSteps,
      earnedBadges: newBadges,
      celebrationQueue: celebrations,
    }

    setJourneyData(newData)

    // Persist to database
    try {
      await supabase.from('profiles').update({
        onboarding_data: {
          ...profile?.onboarding_data,
          completed_steps: newCompletedSteps,
          earned_badges: newBadges,
          role: journeyData.currentRole,
        }
      }).eq('id', user.id)
    } catch (err) {
      console.error('Error saving journey progress:', err)
    }
  }

  function dismissJourney(duration = 'session') {
    const dismissedUntil = duration === 'forever' 
      ? 'forever' 
      : new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString() // 24 hours
    
    setJourneyData(prev => ({ ...prev, dismissedUntil }))
  }

  function clearCelebration() {
    setJourneyData(prev => ({
      ...prev,
      celebrationQueue: prev.celebrationQueue.slice(1)
    }))
  }

  const steps = JOURNEY_STEPS[journeyData.currentRole] || []
  const completedCount = journeyData.completedSteps.length
  const totalSteps = steps.length
  const progressPercent = totalSteps > 0 ? (completedCount / totalSteps) * 100 : 0
  const currentStepIndex = journeyData.completedSteps.length
  const currentStep = steps[currentStepIndex]
  const isComplete = completedCount >= totalSteps
  const isDismissed = journeyData.dismissedUntil === 'forever' || 
    (journeyData.dismissedUntil && new Date(journeyData.dismissedUntil) > new Date())

  return (
    <JourneyContext.Provider value={{
      journeyData,
      steps,
      completedSteps: journeyData.completedSteps,
      earnedBadges: journeyData.earnedBadges,
      completedCount,
      totalSteps,
      progressPercent,
      currentStep,
      currentStepIndex,
      isComplete,
      isDismissed,
      loading,
      completeStep,
      dismissJourney,
      clearCelebration,
      JOURNEY_BADGES,
    }}>
      {children}
    </JourneyContext.Provider>
  )
}

// ============================================
// JOURNEY TIMELINE COMPONENT
// ============================================

function JourneyTimeline({ onNavigate, expanded = false }) {
  const journey = useJourney()
  const tc = useThemeClasses()
  const { accent } = useTheme()
  const [isExpanded, setIsExpanded] = useState(expanded)

  if (!journey || journey.loading || journey.isDismissed) return null

  const { steps, completedSteps, progressPercent, currentStepIndex, isComplete, earnedBadges } = journey

  return (
    <div className={`rounded-2xl border overflow-hidden ${tc.card}`}>
      {/* Header - Always visible */}
      <div 
        className="p-4 cursor-pointer flex items-center justify-between"
        onClick={() => setIsExpanded(!isExpanded)}
      >
        <div className="flex items-center gap-3">
          <div 
            className="w-10 h-10 rounded-xl flex items-center justify-center text-lg"
            style={{ backgroundColor: accent.primary + '20' }}
          >
            üéØ
          </div>
          <div>
            <h3 className={`font-semibold ${tc.text}`}>Your Journey</h3>
            <p className={`text-sm ${tc.textMuted}`}>
              {isComplete ? 'All steps complete! üéâ' : `${journey.completedCount}/${journey.totalSteps} steps complete`}
            </p>
          </div>
        </div>
        <div className="flex items-center gap-3">
          {/* Mini progress */}
          <div className="w-24 h-2 rounded-full bg-slate-200 dark:bg-slate-700">
            <div 
              className="h-full rounded-full transition-all" 
              style={{ width: `${progressPercent}%`, backgroundColor: accent.primary }}
            />
          </div>
          <span className={`text-lg ${isExpanded ? 'rotate-180' : ''} transition-transform`}>‚ñº</span>
        </div>
      </div>

      {/* Expanded Content */}
      {isExpanded && (
        <div className="px-4 pb-4 space-y-4">
          {/* Visual Timeline */}
          <div className="relative py-4">
            {/* Timeline line */}
            <div className="absolute top-1/2 left-6 right-6 h-1 bg-slate-200 dark:bg-slate-700 -translate-y-1/2 rounded-full" />
            <div 
              className="absolute top-1/2 left-6 h-1 -translate-y-1/2 rounded-full transition-all duration-500"
              style={{ 
                width: `calc(${Math.min(progressPercent, 100)}% - 24px)`, 
                backgroundColor: accent.primary 
              }}
            />
            
            {/* Step nodes */}
            <div className="relative flex justify-between">
              {steps.map((step, index) => {
                const isCompleted = completedSteps.includes(step.id)
                const isCurrent = index === currentStepIndex
                const isFuture = index > currentStepIndex

                return (
                  <div key={step.id} className="flex flex-col items-center" style={{ width: `${100 / steps.length}%` }}>
                    {/* Node */}
                    <div 
                      className={`w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold border-4 transition-all ${
                        isCompleted 
                          ? 'text-white border-white dark:border-slate-800' 
                          : isCurrent 
                            ? 'border-white dark:border-slate-800 animate-pulse'
                            : 'bg-slate-200 dark:bg-slate-700 text-slate-400 border-slate-200 dark:border-slate-700'
                      }`}
                      style={{ 
                        backgroundColor: isCompleted || isCurrent ? accent.primary : undefined,
                        color: isCompleted || isCurrent ? '#fff' : undefined
                      }}
                    >
                      {isCompleted ? '‚úì' : step.icon}
                    </div>
                    {/* Label */}
                    <span className={`text-xs mt-2 text-center ${isCompleted || isCurrent ? tc.text : tc.textMuted}`}>
                      {step.title.split(' ').slice(0, 2).join(' ')}
                    </span>
                  </div>
                )
              })}
            </div>
          </div>

          {/* Current Step Card */}
          {!isComplete && journey.currentStep && (
            <div 
              className="p-4 rounded-xl border-2 border-dashed"
              style={{ borderColor: accent.primary + '50', backgroundColor: accent.primary + '05' }}
            >
              <div className="flex items-center gap-3">
                <span className="text-2xl">{journey.currentStep.icon}</span>
                <div className="flex-1">
                  <p className={`font-semibold ${tc.text}`}>Next: {journey.currentStep.title}</p>
                  <p className={`text-sm ${tc.textMuted}`}>{journey.currentStep.description}</p>
                </div>
                <button
                  onClick={() => {
                    // Navigate based on step
                      const navMap = {
  create_org: 'setup',
  create_season: 'setup',
  add_teams: 'teams',
  join_create_team: 'teams',
  add_roster: 'teams',
  add_coaches: 'coaches',
  assign_coach: 'coaches',
  register_players: 'registrations',
  create_schedule: 'schedule',
  first_practice: 'schedule',
  first_game: 'schedule',
  view_roster: 'teams',
  create_lineup: 'gameprep',
  plan_practice: 'schedule',
  game_prep: 'gameprep',
}
                    if (navMap[journey.currentStep.id]) {
                      onNavigate(navMap[journey.currentStep.id])
                    }
                  }}
                  className="px-4 py-2 rounded-lg text-white text-sm font-medium"
                  style={{ backgroundColor: accent.primary }}
                >
                  Start ‚Üí
                </button>
              </div>
            </div>
          )}

          {/* Earned Badges */}
          {earnedBadges.length > 0 && (
            <div>
              <p className={`text-sm font-medium ${tc.textMuted} mb-2`}>Badges Earned ({earnedBadges.length})</p>
              <div className="flex flex-wrap gap-2">
                {earnedBadges.map(badgeId => {
                  const badge = JOURNEY_BADGES[badgeId]
                  if (!badge) return null
                  return (
                    <div 
                      key={badgeId}
                      className={`px-3 py-1.5 rounded-full flex items-center gap-2 ${tc.cardBgAlt}`}
                      title={badge.description}
                    >
                      <span>{badge.icon}</span>
                      <span className={`text-sm font-medium ${tc.text}`}>{badge.name}</span>
                    </div>
                  )
                })}
              </div>
            </div>
          )}

          {/* Dismiss options */}
          <div className="flex items-center justify-between pt-2 border-t border-slate-200 dark:border-slate-700">
            <button 
              onClick={() => journey.dismissJourney('day')}
              className={`text-sm ${tc.textMuted} hover:underline`}
            >
              Hide for today
            </button>
            <button 
              onClick={() => journey.dismissJourney('forever')}
              className={`text-sm ${tc.textMuted} hover:underline`}
            >
              Don't show again
            </button>
          </div>
        </div>
      )}
    </div>
  )
}

// ============================================
// MINI JOURNEY WIDGET (For Sidebar)
// ============================================

function JourneyWidget({ onNavigate }) {
  const journey = useJourney()
  const tc = useThemeClasses()
  const { accent } = useTheme()
  const [showFull, setShowFull] = useState(false)

  if (!journey || journey.loading || journey.isDismissed || journey.isComplete) return null

  return (
    <>
      {/* Sidebar Mini Widget */}
      <div 
        onClick={() => setShowFull(true)}
        className={`mx-3 mb-4 p-3 rounded-xl cursor-pointer transition-all hover:shadow-md ${tc.card}`}
      >
        <div className="flex items-center gap-2 mb-2">
          <span className="text-lg">üéØ</span>
          <span className={`text-sm font-semibold ${tc.text}`}>Setup Progress</span>
        </div>
        <div className="h-2 rounded-full bg-slate-200 dark:bg-slate-700">
          <div 
            className="h-full rounded-full transition-all" 
            style={{ width: `${journey.progressPercent}%`, backgroundColor: accent.primary }}
          />
        </div>
        <p className={`text-xs ${tc.textMuted} mt-1`}>
          {journey.completedCount}/{journey.totalSteps} ‚Ä¢ {journey.currentStep?.title}
        </p>
      </div>

      {/* Full Journey Modal */}
      {showFull && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50">
          <div className={`w-full max-w-2xl max-h-[80vh] overflow-auto rounded-2xl ${tc.pageBg}`}>
            <div className="sticky top-0 flex items-center justify-between p-4 border-b border-slate-200 dark:border-slate-700 bg-inherit">
              <h2 className={`text-xl font-bold ${tc.text}`}>Your VolleyBrain Journey</h2>
              <button 
                onClick={() => setShowFull(false)}
                className={`p-2 rounded-lg ${tc.hoverBg}`}
              >
                ‚úï
              </button>
            </div>
            <div className="p-4">
              <JourneyTimeline onNavigate={(page) => { setShowFull(false); onNavigate(page); }} expanded={true} />
            </div>
          </div>
        </div>
      )}
    </>
  )
}

// ============================================
// BADGE CELEBRATION MODAL
// ============================================

function BadgeCelebration({ badge, onClose }) {
  const tc = useThemeClasses()
  const { accent } = useTheme()

  if (!badge) return null

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60">
      <div 
        className={`text-center p-8 rounded-3xl max-w-sm ${tc.pageBg}`}
        style={{ animation: 'bounceIn 0.5s ease-out' }}
      >
        {/* Confetti effect placeholder */}
        <div className="text-6xl mb-4 animate-bounce">{badge.icon}</div>
        <h2 className={`text-2xl font-bold ${tc.text} mb-2`}>Badge Earned!</h2>
        <p className="text-xl font-semibold mb-1" style={{ color: accent.primary }}>{badge.name}</p>
        <p className={`${tc.textMuted} mb-6`}>{badge.description}</p>
        <button
          onClick={onClose}
          className="px-6 py-3 rounded-xl text-white font-semibold"
          style={{ backgroundColor: accent.primary }}
        >
          Awesome! üéâ
        </button>
      </div>
    </div>
  )
}

// ============================================
// JOURNEY CELEBRATION WRAPPER
// ============================================

function JourneyCelebrations() {
  const journey = useJourney()
  
  if (!journey || journey.journeyData.celebrationQueue.length === 0) return null
  
  const celebration = journey.journeyData.celebrationQueue[0]
  
  if (celebration.type === 'badge') {
    return <BadgeCelebration badge={celebration.badge} onClose={journey.clearCelebration} />
  }
  
  return null
}

// ============================================
// BADGE SHOWCASE (For Profile Page)
// ============================================

function BadgeShowcase() {
  const journey = useJourney()
  const tc = useThemeClasses()
  const { accent } = useTheme()

  if (!journey) return null

  const allBadges = Object.values(JOURNEY_BADGES)
  const earned = journey.earnedBadges

  return (
    <div className={`p-6 rounded-2xl border ${tc.card}`}>
      <h3 className={`text-lg font-bold ${tc.text} mb-4`}>
        üèÜ Badges ({earned.length}/{allBadges.length})
      </h3>
      <div className="grid grid-cols-4 sm:grid-cols-6 gap-3">
        {allBadges.map(badge => {
          const isEarned = earned.includes(badge.id)
          return (
            <div 
              key={badge.id}
              className={`aspect-square rounded-xl flex flex-col items-center justify-center p-2 transition-all ${
                isEarned 
                  ? 'bg-gradient-to-br from-yellow-100 to-yellow-200 dark:from-yellow-900/30 dark:to-yellow-800/30' 
                  : 'bg-slate-100 dark:bg-slate-800 opacity-40'
              }`}
              title={`${badge.name}: ${badge.description}`}
            >
              <span className={`text-2xl ${isEarned ? '' : 'grayscale'}`}>{badge.icon}</span>
              <span className={`text-xs mt-1 text-center font-medium ${isEarned ? tc.text : tc.textMuted}`}>
                {badge.name}
              </span>
            </div>
          )
        })}
      </div>
    </div>
  )
}

// ============================================
// PUBLIC REGISTRATION PAGE (No Auth Required)
// ============================================
function PublicRegistrationPage({ orgIdOrSlug, seasonId }) {
  const { colors } = useTheme()
  const [form, setForm] = useState({
    first_name: '',
    last_name: '',
    birth_date: '',
    grade: '',
    gender: '',
    school: '',
    parent_name: '',
    parent_email: '',
    parent_phone: '',
    emergency_contact: '',
    emergency_phone: '',
    medical_notes: '',
    waiver_liability: false,
    waiver_photo: false,
    waiver_conduct: false,
    waiver_signed_by: '',
    prefilled_from_player_id: null
  })
  
  const [season, setSeason] = useState(null)
  const [organization, setOrganization] = useState(null)
  const [loading, setLoading] = useState(true)
  const [submitting, setSubmitting] = useState(false)
  const [submitted, setSubmitted] = useState(false)
  const [error, setError] = useState(null)
  const [prefillNotice, setPrefillNotice] = useState(null)

  // Load season and org info
  useEffect(() => {
    loadSeasonData()
    applyPrefillData()
  }, [orgIdOrSlug, seasonId])

  function applyPrefillData() {
    const prefillData = getRegistrationPrefillData()
    if (!prefillData) return
    
    const updates = {}
    
    if (prefillData.prefillType === 'reregister') {
      Object.keys(prefillData).forEach(key => {
        if (prefillData[key] && key !== 'prefillType' && key !== 'source_player_id') {
          updates[key] = prefillData[key]
        }
      })
      setPrefillNotice({
        type: 'reregister',
        playerName: prefillData.first_name,
        message: `Welcome back! We've pre-filled ${prefillData.first_name}'s information.`
      })
    } else if (prefillData.prefillType === 'sibling') {
      if (prefillData.parent_name) updates.parent_name = prefillData.parent_name
      if (prefillData.parent_email) updates.parent_email = prefillData.parent_email
      if (prefillData.parent_phone) updates.parent_phone = prefillData.parent_phone
      setPrefillNotice({
        type: 'sibling',
        message: `Adding a sibling? We've pre-filled your contact information.`
      })
    }
    
    if (prefillData.source_player_id) {
      updates.prefilled_from_player_id = prefillData.source_player_id
    }
    
    if (Object.keys(updates).length > 0) {
      setForm(prev => ({ ...prev, ...updates }))
    }
  }

  async function loadSeasonData() {
    try {
      // Try to find org by ID or slug
      let orgQuery = supabase.from('organizations').select('*')
      
      // Check if it's a UUID or slug
      const isUUID = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(orgIdOrSlug)
      if (isUUID) {
        orgQuery = orgQuery.eq('id', orgIdOrSlug)
      } else {
        orgQuery = orgQuery.eq('slug', orgIdOrSlug)
      }
      
      const { data: orgData } = await orgQuery.single()
      
      if (orgData) {
        setOrganization(orgData)
        
        // Load season
        const { data: seasonData } = await supabase
          .from('seasons')
          .select('*, sports(name, icon)')
          .eq('id', seasonId)
          .eq('organization_id', orgData.id)
          .single()
        
        if (seasonData) {
          setSeason(seasonData)
        } else {
          setError('Season not found')
        }
      } else {
        setError('Organization not found')
      }
    } catch (err) {
      console.error('Error loading data:', err)
      setError('Could not load registration information')
    }
    setLoading(false)
  }

  async function handleSubmit(e) {
    e.preventDefault()
    setSubmitting(true)
    setError(null)

    try {
      if (!form.first_name || !form.last_name || !form.parent_email) {
        throw new Error('Please fill in all required fields')
      }

      // Create player record
      const { data: player, error: playerError } = await supabase
        .from('players')
        .insert({
          first_name: form.first_name,
          last_name: form.last_name,
          birth_date: form.birth_date || null,
          grade: form.grade || null,
          gender: form.gender || null,
          school: form.school || null,
          parent_name: form.parent_name,
          parent_email: form.parent_email,
          parent_phone: form.parent_phone || null,
          emergency_contact: form.emergency_contact || null,
          emergency_phone: form.emergency_phone || null,
          medical_notes: form.medical_notes || null,
          waiver_liability: form.waiver_liability,
          waiver_photo: form.waiver_photo,
          waiver_conduct: form.waiver_conduct,
          waiver_signed_by: form.waiver_signed_by || null,
          waiver_signed_date: (form.waiver_liability || form.waiver_photo || form.waiver_conduct) 
            ? new Date().toISOString() 
            : null,
          prefilled_from_player_id: form.prefilled_from_player_id,
          season_id: seasonId,
          status: 'active'
        })
        .select()
        .single()

      if (playerError) throw playerError

      // Create registration record
      const { error: regError } = await supabase
        .from('registrations')
        .insert({
          player_id: player.id,
          season_id: seasonId,
          status: 'pending',
          registration_type: form.prefilled_from_player_id ? 're-registration' : 'new'
        })

      if (regError) throw regError

      setSubmitted(true)
    } catch (err) {
      console.error('Registration error:', err)
      setError(err.message || 'Registration failed. Please try again.')
    }
    setSubmitting(false)
  }

  // Calculate fees for display
  const totalFee = season ? (
    (parseFloat(season.fee_registration) || 0) + 
    (parseFloat(season.fee_uniform) || 0) + 
    ((parseFloat(season.fee_monthly) || 0) * (parseInt(season.months_in_season) || 0))
  ) : 0

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center" style={{ backgroundColor: colors.bg }}>
        <div className="w-10 h-10 border-3 rounded-full animate-spin" style={{ borderColor: colors.border, borderTopColor: '#EAB308' }} />
      </div>
    )
  }

  if (submitted) {
    return (
      <div className="min-h-screen flex items-center justify-center p-6" style={{ backgroundColor: colors.bg }}>
        <div className="rounded-2xl p-8 max-w-md text-center" style={{ backgroundColor: colors.card, border: `1px solid ${colors.border}` }}>
          <span className="text-6xl">üéâ</span>
          <h1 className="text-2xl font-bold mt-4" style={{ color: colors.text }}>Registration Submitted!</h1>
          <p className="mt-2" style={{ color: colors.textSecondary }}>
            Thank you for registering {form.first_name} for {season?.name}!
          </p>
          <p className="text-sm mt-4" style={{ color: colors.textMuted }}>
            You'll receive a confirmation email at {form.parent_email} once your registration is reviewed.
          </p>
          {totalFee > 0 && (
            <div className="mt-4 p-4 rounded-xl" style={{ backgroundColor: colors.cardAlt }}>
              <p style={{ color: colors.textSecondary }}>Estimated fees</p>
              <p className="text-2xl font-bold" style={{ color: '#EAB308' }}>${totalFee.toFixed(2)}</p>
              <p className="text-xs mt-1" style={{ color: colors.textMuted }}>Payment details will be sent after approval</p>
            </div>
          )}
          <button
            onClick={() => window.location.href = '/'}
            className="mt-6 px-6 py-3 font-semibold rounded-xl transition hover:brightness-110"
            style={{ backgroundColor: '#EAB308', color: '#000' }}
          >
            Done
          </button>
        </div>
      </div>
    )
  }

  if (error && !season) {
    return (
      <div className="min-h-screen flex items-center justify-center p-6" style={{ backgroundColor: colors.bg }}>
        <div className="rounded-2xl p-8 max-w-md text-center" style={{ backgroundColor: colors.card, border: `1px solid ${colors.border}` }}>
          <span className="text-6xl">üòï</span>
          <h1 className="text-2xl font-bold mt-4" style={{ color: colors.text }}>Registration Not Found</h1>
          <p className="mt-2" style={{ color: colors.textSecondary }}>{error}</p>
          <button
            onClick={() => window.location.href = '/'}
            className="mt-6 px-6 py-3 font-semibold rounded-xl"
            style={{ backgroundColor: colors.cardAlt, color: colors.text }}
          >
            Go Home
          </button>
        </div>
      </div>
    )
  }

  return (
    <div className="min-h-screen py-8 px-4" style={{ backgroundColor: colors.bg }}>
      <div className="max-w-2xl mx-auto">
        {/* Header */}
        <div className="text-center mb-8">
          {organization?.logo_url && (
            <img src={organization.logo_url} alt={organization.name} className="w-20 h-20 mx-auto rounded-xl mb-4 object-cover" />
          )}
          <h1 className="text-3xl font-bold" style={{ color: colors.text }}>{organization?.name || 'Registration'}</h1>
          <p className="mt-2" style={{ color: colors.textSecondary }}>
            {season?.sports?.icon} {season?.name}
          </p>
          {season?.start_date && (
            <p className="text-sm mt-1" style={{ color: colors.textMuted }}>
              Starts {new Date(season.start_date).toLocaleDateString()}
            </p>
          )}
        </div>

        {/* Fee Preview */}
        {totalFee > 0 && (
          <div className="mb-6 p-4 rounded-xl text-center" style={{ backgroundColor: colors.card, border: `1px solid ${colors.border}` }}>
            <p className="text-sm" style={{ color: colors.textSecondary }}>Registration Fee</p>
            <p className="text-3xl font-bold" style={{ color: '#EAB308' }}>${totalFee.toFixed(2)}</p>
            <p className="text-xs mt-1" style={{ color: colors.textMuted }}>Due after registration is approved</p>
          </div>
        )}

        {/* Pre-fill Notice */}
        {prefillNotice && (
          <div className="mb-6 p-4 rounded-xl" style={{ 
            backgroundColor: prefillNotice.type === 'reregister' ? 'rgba(16, 185, 129, 0.1)' : 'rgba(59, 130, 246, 0.1)',
            border: `1px solid ${prefillNotice.type === 'reregister' ? 'rgba(16, 185, 129, 0.3)' : 'rgba(59, 130, 246, 0.3)'}`
          }}>
            <p style={{ color: prefillNotice.type === 'reregister' ? '#10B981' : '#3B82F6' }}>
              ‚ú® {prefillNotice.message}
            </p>
          </div>
        )}

        {/* Error */}
        {error && (
          <div className="mb-6 p-4 rounded-xl" style={{ backgroundColor: 'rgba(239, 68, 68, 0.1)', border: '1px solid rgba(239, 68, 68, 0.3)' }}>
            <p style={{ color: '#EF4444' }}>‚ö†Ô∏è {error}</p>
          </div>
        )}

        {/* Form */}
        <form onSubmit={handleSubmit} className="rounded-2xl p-6 space-y-6" style={{ backgroundColor: colors.card, border: `1px solid ${colors.border}` }}>
          {/* Player Information */}
          <div>
            <h2 className="text-lg font-semibold mb-4" style={{ color: colors.text }}>Player Information</h2>
            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-sm mb-2" style={{ color: colors.textSecondary }}>First Name *</label>
                <input
                  type="text"
                  value={form.first_name}
                  onChange={e => setForm({...form, first_name: e.target.value})}
                  required
                  className="w-full rounded-xl px-4 py-3"
                  style={{ backgroundColor: colors.cardAlt, border: `1px solid ${colors.border}`, color: colors.text }}
                />
              </div>
              <div>
                <label className="block text-sm mb-2" style={{ color: colors.textSecondary }}>Last Name *</label>
                <input
                  type="text"
                  value={form.last_name}
                  onChange={e => setForm({...form, last_name: e.target.value})}
                  required
                  className="w-full rounded-xl px-4 py-3"
                  style={{ backgroundColor: colors.cardAlt, border: `1px solid ${colors.border}`, color: colors.text }}
                />
              </div>
              <div>
                <label className="block text-sm mb-2" style={{ color: colors.textSecondary }}>Date of Birth</label>
                <input
                  type="date"
                  value={form.birth_date}
                  onChange={e => setForm({...form, birth_date: e.target.value})}
                  className="w-full rounded-xl px-4 py-3"
                  style={{ backgroundColor: colors.cardAlt, border: `1px solid ${colors.border}`, color: colors.text }}
                />
              </div>
              <div>
                <label className="block text-sm mb-2" style={{ color: colors.textSecondary }}>Grade</label>
                <select
                  value={form.grade}
                  onChange={e => setForm({...form, grade: e.target.value})}
                  className="w-full rounded-xl px-4 py-3"
                  style={{ backgroundColor: colors.cardAlt, border: `1px solid ${colors.border}`, color: colors.text }}
                >
                  <option value="">Select grade</option>
                  {['K', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'].map(g => (
                    <option key={g} value={g}>{g === 'K' ? 'Kindergarten' : `Grade ${g}`}</option>
                  ))}
                </select>
              </div>
              <div>
                <label className="block text-sm mb-2" style={{ color: colors.textSecondary }}>Gender</label>
                <select
                  value={form.gender}
                  onChange={e => setForm({...form, gender: e.target.value})}
                  className="w-full rounded-xl px-4 py-3"
                  style={{ backgroundColor: colors.cardAlt, border: `1px solid ${colors.border}`, color: colors.text }}
                >
                  <option value="">Select gender</option>
                  <option value="Male">Male</option>
                  <option value="Female">Female</option>
                </select>
              </div>
              <div>
                <label className="block text-sm mb-2" style={{ color: colors.textSecondary }}>School</label>
                <input
                  type="text"
                  value={form.school}
                  onChange={e => setForm({...form, school: e.target.value})}
                  className="w-full rounded-xl px-4 py-3"
                  style={{ backgroundColor: colors.cardAlt, border: `1px solid ${colors.border}`, color: colors.text }}
                />
              </div>
            </div>
          </div>

          {/* Parent/Guardian Information */}
          <div>
            <h2 className="text-lg font-semibold mb-4" style={{ color: colors.text }}>Parent/Guardian Information</h2>
            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-sm mb-2" style={{ color: colors.textSecondary }}>Parent Name *</label>
                <input
                  type="text"
                  value={form.parent_name}
                  onChange={e => setForm({...form, parent_name: e.target.value})}
                  required
                  className="w-full rounded-xl px-4 py-3"
                  style={{ backgroundColor: colors.cardAlt, border: `1px solid ${colors.border}`, color: colors.text }}
                />
              </div>
              <div>
                <label className="block text-sm mb-2" style={{ color: colors.textSecondary }}>Parent Phone</label>
                <input
                  type="tel"
                  value={form.parent_phone}
                  onChange={e => setForm({...form, parent_phone: e.target.value})}
                  className="w-full rounded-xl px-4 py-3"
                  style={{ backgroundColor: colors.cardAlt, border: `1px solid ${colors.border}`, color: colors.text }}
                />
              </div>
              <div className="col-span-2">
                <label className="block text-sm mb-2" style={{ color: colors.textSecondary }}>Parent Email *</label>
                <input
                  type="email"
                  value={form.parent_email}
                  onChange={e => setForm({...form, parent_email: e.target.value})}
                  required
                  className="w-full rounded-xl px-4 py-3"
                  style={{ backgroundColor: colors.cardAlt, border: `1px solid ${colors.border}`, color: colors.text }}
                />
              </div>
            </div>
          </div>

          {/* Emergency Contact */}
          <div>
            <h2 className="text-lg font-semibold mb-4" style={{ color: colors.text }}>Emergency Contact</h2>
            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-sm mb-2" style={{ color: colors.textSecondary }}>Emergency Contact Name</label>
                <input
                  type="text"
                  value={form.emergency_contact}
                  onChange={e => setForm({...form, emergency_contact: e.target.value})}
                  className="w-full rounded-xl px-4 py-3"
                  style={{ backgroundColor: colors.cardAlt, border: `1px solid ${colors.border}`, color: colors.text }}
                />
              </div>
              <div>
                <label className="block text-sm mb-2" style={{ color: colors.textSecondary }}>Emergency Phone</label>
                <input
                  type="tel"
                  value={form.emergency_phone}
                  onChange={e => setForm({...form, emergency_phone: e.target.value})}
                  className="w-full rounded-xl px-4 py-3"
                  style={{ backgroundColor: colors.cardAlt, border: `1px solid ${colors.border}`, color: colors.text }}
                />
              </div>
            </div>
            <div className="mt-4">
              <label className="block text-sm mb-2" style={{ color: colors.textSecondary }}>Medical Notes / Allergies</label>
              <textarea
                value={form.medical_notes}
                onChange={e => setForm({...form, medical_notes: e.target.value})}
                rows={3}
                placeholder="Any medical conditions, allergies, or special needs..."
                className="w-full rounded-xl px-4 py-3"
                style={{ backgroundColor: colors.cardAlt, border: `1px solid ${colors.border}`, color: colors.text }}
              />
            </div>
          </div>

          {/* Waivers */}
          <div>
            <h2 className="text-lg font-semibold mb-4" style={{ color: colors.text }}>Waivers & Agreements</h2>
            <div className="space-y-3">
              <label className="flex items-start gap-3 p-4 rounded-xl cursor-pointer transition hover:opacity-80" style={{ backgroundColor: colors.cardAlt }}>
                <input
                  type="checkbox"
                  checked={form.waiver_liability}
                  onChange={e => setForm({...form, waiver_liability: e.target.checked})}
                  className="mt-1"
                />
                <div>
                  <p className="font-medium" style={{ color: colors.text }}>Liability Waiver</p>
                  <p className="text-sm" style={{ color: colors.textSecondary }}>I understand and accept the risks associated with participation.</p>
                </div>
              </label>
              <label className="flex items-start gap-3 p-4 rounded-xl cursor-pointer transition hover:opacity-80" style={{ backgroundColor: colors.cardAlt }}>
                <input
                  type="checkbox"
                  checked={form.waiver_photo}
                  onChange={e => setForm({...form, waiver_photo: e.target.checked})}
                  className="mt-1"
                />
                <div>
                  <p className="font-medium" style={{ color: colors.text }}>Photo Release</p>
                  <p className="text-sm" style={{ color: colors.textSecondary }}>I consent to photos/videos being taken and used for promotional purposes.</p>
                </div>
              </label>
              <label className="flex items-start gap-3 p-4 rounded-xl cursor-pointer transition hover:opacity-80" style={{ backgroundColor: colors.cardAlt }}>
                <input
                  type="checkbox"
                  checked={form.waiver_conduct}
                  onChange={e => setForm({...form, waiver_conduct: e.target.checked})}
                  className="mt-1"
                />
                <div>
                  <p className="font-medium" style={{ color: colors.text }}>Code of Conduct</p>
                  <p className="text-sm" style={{ color: colors.textSecondary }}>I agree to follow the organization's code of conduct and sportsmanship guidelines.</p>
                </div>
              </label>
            </div>
            {(form.waiver_liability || form.waiver_photo || form.waiver_conduct) && (
              <div className="mt-4">
                <label className="block text-sm mb-2" style={{ color: colors.textSecondary }}>Parent/Guardian Signature (type full name)</label>
                <input
                  type="text"
                  value={form.waiver_signed_by}
                  onChange={e => setForm({...form, waiver_signed_by: e.target.value})}
                  placeholder="Type your full name to sign"
                  className="w-full rounded-xl px-4 py-3"
                  style={{ backgroundColor: colors.cardAlt, border: `1px solid ${colors.border}`, color: colors.text }}
                />
              </div>
            )}
          </div>

          {/* Submit */}
          <button
            type="submit"
            disabled={submitting}
            className="w-full py-4 font-bold rounded-xl transition hover:brightness-110 disabled:opacity-50"
            style={{ backgroundColor: '#EAB308', color: '#000' }}
          >
            {submitting ? 'Submitting...' : 'Submit Registration'}
          </button>
        </form>

        {/* Footer */}
        <p className="text-center mt-6 text-sm" style={{ color: colors.textMuted }}>
          Powered by VolleyBrain
        </p>
      </div>
    </div>
  )
}

export default function App() {
  return (
    <ThemeProvider>
      <AuthProvider>
        <JourneyProvider>
          <AppContent />
        </JourneyProvider>
      </AuthProvider>
    </ThemeProvider>
  )
}

function AppContent() {
  const { user, isAdmin, loading, needsOnboarding, completeOnboarding } = useAuth()
  const { isDark, colors } = useTheme()

  // Check for public registration route FIRST (before auth check)
  // This allows unauthenticated users to register
  const [isPublicRoute, setIsPublicRoute] = useState(false)
  const [publicRouteData, setPublicRouteData] = useState(null)

  useEffect(() => {
    const path = window.location.pathname
    // Match /register/{orgId}/{seasonId} or /register/{orgSlug}/{seasonId}
    const registerMatch = path.match(/^\/register\/([^\/]+)\/([^\/]+)\/?$/)
    if (registerMatch) {
      setIsPublicRoute(true)
      setPublicRouteData({
        type: 'registration',
        orgIdOrSlug: registerMatch[1],
        seasonId: registerMatch[2]
      })
    }
  }, [])

  // Show public registration form (no auth required)
  if (isPublicRoute && publicRouteData?.type === 'registration') {
    return (
      <ThemeProvider>
        <PublicRegistrationPage 
          orgIdOrSlug={publicRouteData.orgIdOrSlug}
          seasonId={publicRouteData.seasonId}
        />
      </ThemeProvider>
    )
  }

  if (loading) {
    return (
      <div className="min-h-screen flex flex-col items-center justify-center" style={{ backgroundColor: colors.bg }}>
        <div className="w-10 h-10 border-3 rounded-full animate-spin" style={{ borderColor: colors.border, borderTopColor: '#EAB308' }} />
        <p className="mt-4" style={{ color: colors.textSecondary }}>Loading...</p>
        <style>{`.animate-spin { animation: spin 1s linear infinite; } @keyframes spin { to { transform: rotate(360deg); } }`}</style>
      </div>
    )
  }

  if (!user) return <LoginPage />
  
  // NEW: Show setup wizard for users who haven't completed onboarding
  if (needsOnboarding) {
    return <SetupWizard onComplete={completeOnboarding} />
  }
  
  if (!isAdmin) return (
    <div className="min-h-screen flex items-center justify-center" style={{ backgroundColor: colors.bg }}>
      <div className="text-center">
        <span className="text-5xl">üîí</span>
        <h2 className="text-xl font-bold mt-4" style={{ color: colors.text }}>Access Denied</h2>
        <p className="mt-2" style={{ color: colors.textSecondary }}>Admin access required</p>
      </div>
    </div>
  )

  return <MainApp />
}
